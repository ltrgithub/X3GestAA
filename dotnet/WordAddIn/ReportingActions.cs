using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using Microsoft.Office.Interop.Word;
using System.Windows.Forms;

namespace WordAddIn
{
    public class ReportingActions
    {
        public const string rpt_build_tpl   = "rpt_build_tpl";
        public const string rpt_is_tpl      = "rpt_is_tpl";
        public const string rpt_fill_tpl    = "rpt_fill_tpl";

        public BrowserDialog browserDialog = null;

        public ReportingActions(BrowserDialog browserDialog)
        {
            this.browserDialog = browserDialog;
        }

        public static Boolean isReportingDocument(Document doc)
        {
            SyracuseOfficeCustomData customData = SyracuseOfficeCustomData.getFromDocument(doc);
            if (customData != null)
            {
                String mode = customData.getCreateMode();
                if (rpt_build_tpl.Equals(mode) || rpt_fill_tpl.Equals(mode))
                {
                    return true;
                }
            }
            return false;
        }

        public void ActiveDocumentChanged(Document doc)
        {
            SyracuseOfficeCustomData customData = SyracuseOfficeCustomData.getFromDocument(doc);
            if (customData != null) // Document generated by X3 and supplied with additional data
            {
                String mode = customData.getCreateMode();
                if (rpt_build_tpl.Equals(mode))
                {
                    if (customData.isForceRefresh())
                    {
                        CreateWordReportTemplate(doc, customData);
                    }
                }
                else if (rpt_fill_tpl.Equals(mode))
                {
                    if (customData.isForceRefresh())
                    {
                        PopulateWordReportTemplate(doc, customData);
                    }
                }
            }
        }
        public void RefreshTemplatePane(Document doc, SyracuseTemplatePane templatePane)
        {
            SyracuseOfficeCustomData customData = SyracuseOfficeCustomData.getFromDocument(doc);
            if (customData == null)
            {
                templatePane.clear();
                return;
            }
            if (!"rpt_is_tpl".Equals(customData.getCreateMode()))
            {
                templatePane.clear();
                return;
            }
            templatePane.showFields(customData.getLayoutData());
        }        

        public void CreateWordReportTemplate(Document doc, SyracuseOfficeCustomData customData)
        {
            browserDialog.loadPage("/msoffice/lib/word/ui/main.html?url=%3Frepresentation%3Dwordhome.%24dashboard", customData);
        }

        public void PopulateWordReportTemplate(Document doc, SyracuseOfficeCustomData customData)
        {
            customData.setForceRefresh(false);
            customData.writeDictionaryToDocument();
            browserDialog.loadPage("/msoffice/lib/word/ui/main.html?url=%3Frepresentation%3Dwordhome.%24dashboard", customData);
        }

        public void CreateWordReportPreview()
        {
            if (Globals.WordAddIn.Application.Documents.Count <= 0)
                return;

            Document doc = Globals.WordAddIn.Application.ActiveDocument;
            SyracuseOfficeCustomData customData = SyracuseOfficeCustomData.getFromDocument(doc);
            if (customData == null)
            {
                return;
            }
            String mode = customData.getCreateMode();
            if (!rpt_is_tpl.Equals(mode))
            {
                return;
            }

            if (!browserDialog.connectToServer(customData))
                return;

            String layout = customData.getLayoutData();
            doc.Range().Copy();
            doc = Globals.WordAddIn.Application.Documents.Add();
            doc.Range().Paste();

            ReportingUtils.fillTemplate(doc, customData.getLayoutData(), browserDialog);
        }
    }
}
