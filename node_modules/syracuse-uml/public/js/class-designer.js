"use strict";
(function(exports) {
	exports.create = function(config) {
		config = config || {};
		config.div = $(config.div || '#uml-designer');
		var dirty = false;
		var setDirty = function() {
			if (!dirty) config.setDirty();
			dirty = true;
		};

		function initClassComponent(parent, data) {
			var $form = $('<div>').addClass('uml-form');
			$('<input>').attr('type', 'text').attr('data-prop-name', 'name').addClass('uml-field uml-title') //
			.val(data.name).change(setDirty).appendTo($form);

			function addListWidget(name) {
				$('<hr class="uml-sep"/>').appendTo($form);
				var $div = $('<div>').attr('data-prop-name', name).appendTo($form);
				var expanded = !! data[name + 'Expanded'];

				function addLine(text) {
					var $lineDiv = $('<div>').addClass('uml-line');
					$('<input>').attr('type', 'text').attr('data-prop-name', 'line').addClass('uml-field') //
					.val(text).change(setDirty).appendTo($lineDiv);
					$('<div>').addClass('uml-line-remove').click(function() {
						setDirty();
						expanded = true;
						$lineDiv.remove();
						fixExpand();
						// repaint because bottom connections move
						plumbInstance.repaintEverything();
					}).appendTo($lineDiv);
					$lineDiv.insertBefore($add);
				}

				function fixExpand() {
					var $lines = $div.find('.uml-line');
					$lines.show();
					var max = 3;
					$expand.toggleClass('uml-line-expanded', expanded);
					if ($lines.length < max) $expand.hide();
					else {
						$expand.show();
						if (expanded) {
							$expand.text('<<< less');
						} else {
							$expand.text('>>> more');
							$lines.each(function(i, elt) {
								if (i >= max) $(elt).hide();
							});
						}
					}
				}
				var $add = $('<div>').addClass('uml-line-add').click(function() {
					setDirty();
					expanded = true;
					addLine('');
					fixExpand();
					// repaint because bottom connections move
					plumbInstance.repaintEverything();
				}).appendTo($div);
				if (data[name]) data[name].forEach(addLine);
				var $expand = $('<span>').attr('data-expanded-name', name).addClass('uml-line-expand').click(function() {
					expanded = !expanded;
					fixExpand();
					// repaint because bottom connections move
					plumbInstance.repaintEverything();
				}).appendTo($div);
				fixExpand();
			}
			addListWidget('attributes');
			addListWidget('methods');
			$form.appendTo(parent);
		}

		function getListValue(div) {
			var values = [];
			div.find('[data-prop-name="line"]').each(function(i, input) {
				values.push($(input).val());
			});
			return values;
		}

		var $designer = config.div.addClass('uml-designer');
		var $messageDiv = $('<pre>').addClass('uml-message').appendTo($('<div>').appendTo($designer));
		var $actionsDiv = $('<div>').addClass('uml-actions').appendTo($designer);
		var $container = $('<div>').attr('id', 'uml-container').addClass('uml-container').appendTo($designer);

		var $workbench = $('<div>').attr('id', 'uml-workbench').addClass('uml-workbench').appendTo($container);

		function message(msg) {
			$designer.find('.uml-message').css({
				color: 'green'
			}).text(msg);
		}

		function error(msg) {
			return alert(msg); // for now
			$designer.find('.uml-message').css({
				color: 'red'
			}).text(msg);
		}

		function serialize(code, title) {
			var graph = {
				code: code,
				title: title,
				classes: [],
				connections: [],
			};
			$workbench.find('.uml-component-outer').each(function(i, elt) {
				var comp = $(elt);
				var pos = comp.position();
				var result = {
					id: comp.attr('data-comp-id'),
					top: pos.top,
					left: pos.left,
					name: "" + comp.find('[data-prop-name="name"]').val(),
					attributes: getListValue(comp.find('[data-prop-name="attributes"]')),
					attributesExpanded: comp.find('[data-expanded-name="attributes"]').hasClass('uml-line-expanded'),
					methods: getListValue(comp.find('[data-prop-name="methods"]')),
					methodsExpanded: comp.find('[data-expanded-name="methods"]').hasClass('uml-line-expanded'),
				};
				graph.classes.push(result);
			});
			plumbInstance.select().each(function(connection) {
				var conn = {
					source: $(connection.source).attr('data-comp-id'),
					target: $(connection.target).attr('data-comp-id'),
					type: connection.details.type,
				};
				conn.multiplicities = connection.details.multiplicities;
				conn.roles = connection.details.roles;
				conn.association = connection.details.association;
				graph.connections.push(conn);
			});
			return graph;
		}

		function save() {
			try {
				//maybe find another solution to manage the position issues when the workbench is scrolled.
				$workbench.scrollLeft(0);
				$workbench.scrollTop(0);
				return serialize();
			} catch (ex) {
				error("getValue failed: " + ex.stack || ex.toString());
			}
		}

		function clear() {
			plumbInstance.detachEveryConnection();
			$workbench.empty();
		}

		// transform JSON into a graphic chart

		function deserialize(graph) {
			clear();
			dirty = true;
			var comps = [];
			graph.classes.forEach(function(clas) {
				comps[clas.id] = addComponent(clas);
			});

			setTimeout(function() {
				plumbInstance.doWhileSuspended(function() {
					graph.connections.forEach(function(connection) {
						var conn = plumbInstance.connect({
							source: comps[connection.source],
							target: comps[connection.target],
							type: connection.type,
						});
						setOverlays(conn, connection);
					});
				});
				dirty = false;
			});
			jsPlumb.fire("jsPlumbDemoLoaded", plumbInstance);
		}

		function load(graph) {
			try {
				deserialize(graph);
			} catch (ex) {
				error("Load failed: " + ex.stack || ex.toString());
			}
		}

		function createClassComponent() {
			setDirty();
			var source = addComponent({
				connectivities: ["source"],
				top: $workbench.offset().top,
				left: $workbench.offset().left,
			});
		}

		function connectionStyle(arrowFoldback, arrowFill) {
			var overlays = [];
			if (arrowFoldback > 0) {
				var paintStyle = {
					strokeStyle: "#9a9b9c",
				};
				if (arrowFill) paintStyle.fillStyle = arrowFill;
				overlays.push(["Arrow", {
					length: 16,
					width: 16,
					location: 1,
					foldback: arrowFoldback,
					paintStyle: paintStyle,
				}]);
			}
			if (arrowFoldback !== 1) { // not generalization
				overlays = overlays.concat([
					["Label", {
						id: "association-name",
						location: 0.5,
						cssClass: "uml-overlay-label"
					}],
					["Label", {
						id: "source-role",
						location: 0.2,
						cssClass: "uml-overlay-label"
					}],
					["Label", {
						id: "target-role",
						location: 0.8,
						cssClass: "uml-overlay-label"
					}],
					["Label", {
						id: "source-multiplicity",
						location: 0.2,
						cssClass: "uml-overlay-multiplicity"
					}],
					["Label", {
						id: "target-multiplicity",
						location: 0.8,
						cssClass: "uml-overlay-multiplicity"
					}],
				]);
			}
			return {
				paintStyle: {
					strokeStyle: "#9a9b9c",
					lineWidth: 4
				},
				hoverPaintStyle: {
					strokeStyle: "#4d4f53",
				},
				overlays: overlays,
			};
		}

		var connectionStyles = {
			generalization: connectionStyle(1, "white"),
			association: connectionStyle(0),
			aggregation: connectionStyle(2, "white"),
			composition: connectionStyle(2),
		};

		var plumbInstance = window.plumbInstance = jsPlumb.getInstance({
			Connector: [
				["Flowchart"], {}
			],
			Container: '#uml-workbench',
		});

		plumbInstance.registerConnectionTypes(connectionStyles);

		var lastId = 0;

		function addComponent(opts) {
			var id = ++lastId;
			var $compo = $('<div>').addClass('uml-component-outer').attr('data-comp-id', id).appendTo($workbench);
			var $compoInner = $('<div>').addClass('uml-component').appendTo($compo).click(setDirty);

			var $compoRemove = $('<div>').addClass('uml-remove') //
			.appendTo($compoInner).click(function(elt) {
				setDirty();
				plumbInstance.detachAllConnections($compo);
				plumbInstance.removeAllEndpoints($compo);
				$compo.remove();
			});

			$('<div>').addClass('uml-source').appendTo($compoInner);

			initClassComponent($compoInner, opts);

			$compo.css({
				position: 'absolute',
				top: opts.top,
				left: opts.left
			});
			plumbInstance.draggable($compo);

			plumbInstance.makeSource($compo, {
				filter: ".uml-source",
				anchor: "Continuous",
				endpoint: "Blank",
			});

			plumbInstance.makeTarget($compo, {
				dropOptions: {
					hoverClass: "uml-target-hover"
				},
				anchor: "Continuous",
				endpoint: "Blank",
				allowLoopback: true
			});

			plumbInstance.repaint($compo);

			return $compo;
		}

		function createDialog(getCfg, ok) {
			var $dialog = $('<div>').addClass('uml-dialog').appendTo($container).hide();
			var $outer = $('<div>').addClass('uml-dialog-outer').appendTo($dialog);
			var $inner = $('<div>').addClass('uml-dialog-inner').appendTo($outer);
			var cfg = getCfg();
			cfg.contents.appendTo($inner);
			$dialog.click(function(ev) {
				$dialog.hide();
				callback = null;
			});
			$outer.click(function(ev) {
				ev.stopPropagation();
			});

			var callback;

			function open(ev, data, cb) {
				callback = cb;
				var r = $container[0].getBoundingClientRect();
				$dialog.css({
					'z-index': $designer.zIndex() + 100,
					position: 'absolute',
					top: $container[0].offsetTop,
					left: $container[0].offsetLeft,
					width: r.width,
					height: r.height,
					'background-color': 'transparent',
				});
				$outer.css({
					position: 'absolute',
					top: ev.clientY - r.top - 30,
					left: ev.clientX - r.left - 30,
					'background-color': 'white',
					opacity: 1,
				});
				cfg.fill(data);
				$dialog.show();
			}

			function close(result) {
				$dialog.hide();
				callback(result);
			}
			return {
				open: open,
				close: close,
			};
		}


		var $relationDialog = createDialog(function() {
			var $div = $('<div>').addClass('uml-dialog-relation');

			function fixForm() {
				var type = $('#uml-relation-type').val();
				$('.uml-multiplicity-div')[type !== 'generalization' ? 'show' : 'hide']();
				$('.uml-association-div')[type !== 'generalization' ? 'show' : 'hide']();
			}

			function addTypeSelect() {
				var $d = $('<div>').appendTo($div);
				$('<label>').addClass('uml-dialog-label').text("relation type").appendTo($d);
				var $select = $('<select id="uml-relation-type">').addClass('uml-dialog-field').change(fixForm).appendTo($d);
				['generalization', 'association', 'aggregation', 'composition'].forEach(function(type) {
					$('<option>').attr('value', type).text(type).appendTo($select);
				});
			}

			function addMultiplicitySelect(id, label) {
				var $d = $('<div>').addClass('uml-multiplicity-div').appendTo($div);
				$('<label>').addClass('uml-dialog-label').text(label).appendTo($d);
				var $select = $('<select>').attr('id', id).addClass('uml-dialog-field').appendTo($d);
				['0..1', '0..*', '1', '1..*'].forEach(function(mult) {
					$('<option>').attr('value', mult).text(mult).appendTo($select);
				});
			}

			function addAssociationField() {
				var $d = $('<div>').addClass('uml-association-div').appendTo($div);
				$('<label>').addClass('uml-dialog-label').text('association name').appendTo($d);
				$('<input id="uml-association-name" type="text">').addClass('uml-dialog-field').appendTo($d);
				$('<br>').appendTo($d);
				$('<label>').addClass('uml-dialog-label').text('source name').appendTo($d);
				$('<input id="uml-source-role" type="text">').addClass('uml-dialog-field').appendTo($d);
				$('<br>').appendTo($d);
				$('<label>').addClass('uml-dialog-label').text('target name').appendTo($d);
				$('<input id="uml-target-role" type="text">').addClass('uml-dialog-field').appendTo($d);
			}

			function addButtons() {
				var $d = $('<div>').appendTo($div);
				$('<hr>').appendTo($d);
				$('<span>').text('OK').addClass('uml-dialog-ok').click(function() {
					$relationDialog.close({
						action: 'submit',
						type: $('#uml-relation-type').val(),
						multiplicities: [$('#uml-source-multiplicity').val(), $('#uml-target-multiplicity').val()],
						roles: [$('#uml-source-role').val(), $('#uml-target-role').val()],
						association: $('#uml-association-name').val(),
					});
				}).appendTo($d);
				$('<hr>').appendTo($d);
				$('<span>').text('delete').addClass('uml-dialog-delete').click(function() {
					$relationDialog.close({
						action: 'delete',
					});
				}).appendTo($d);
			}
			addTypeSelect();
			addMultiplicitySelect('uml-source-multiplicity', 'source multiplicity');
			addMultiplicitySelect('uml-target-multiplicity', 'target multiplicity');
			addAssociationField();
			addButtons();

			function fill(data) {
				$('#uml-relation-type').val(data.type);
				$('#uml-source-multiplicity').val(data.multiplicities[0]);
				$('#uml-target-multiplicity').val(data.multiplicities[1]);
				$('#uml-source-role').val(data.roles[0]);
				$('#uml-target-role').val(data.roles[1]);
				$('#association-name').val(data.association);
				fixForm();
			}

			return {
				contents: $div,
				fill: fill,
			};
		});

		function setOverlays(connection, details) {
			function setOverlay(name, val) {
				var overlay = connection.getOverlay(name);
				if (overlay) overlay.setLabel(val || '');
			}
			connection.details = details;
			connection.setType(details.type);
			setOverlay('source-multiplicity', details.multiplicities[0]);
			setOverlay('target-multiplicity', details.multiplicities[1]);
			setOverlay('source-role', details.roles[0]);
			setOverlay('target-role', details.roles[1]);
			setOverlay('association-name', details.association);
		}

		plumbInstance.bind("connection", function(connection) {
			setDirty();
			setOverlays(connection.connection, {
				type: 'composition',
				multiplicities: ['', ''],
				roles: ['', ''],
				association: '',
			});
		});
		plumbInstance.bind("click", function(connection, ev) {
			$relationDialog.open(ev, connection.details, function(result) {
				if (result.action === 'submit') {
					setOverlays(connection, result);
				} else if (result.action === 'delete') {
					plumbInstance.detach(connection);
				} else {
					throw new Error('bad action: ' + result.action);
				}
			});
		});

		function addButton(title, fn) {
			$('<div>').addClass('uml-button').text(title).click(function() {
				fn();
			}).appendTo($actionsDiv);
		}

		addButton('Add Class', createClassComponent);

		jsPlumb.fire("jsPlumbDemoLoaded", plumbInstance);

		return {
			getValue: save,
			setValue: load,
		};
	};
})(typeof exports !== "undefined" ? exports : registerModule('uml-designer/lib/designer'));