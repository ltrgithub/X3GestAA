"use strict";

var config = require("../config");
var fsp = require('path');
var fs = require('streamline-fs');
var ez = require('ez-streams');
var port = config.port || 8125;

ez.devices.http.server(function(request, response, _) {
	try {
		var root = /^\/data\//.test(request.url) ? config.dataRoot : config.staticRoot;
		switch (request.method) {
			case 'GET':
				if (request.url === '/') {
					response.writeHead(307, {
						location: '/html/demo.html'
					});
					return response.write(_);
				}
				var path = fsp.join(root, request.url);
				if (fs.exists(path, _)) {
					response.writeHead(200, {});
					ez.devices.file.binary.reader(path).pipe(_, response.writer);
				} else {
					response.writeHead(404);
					response.write(_);
				}
				break;
			case 'PUT':
				var path = fsp.join(root, request.url);
				request.reader.pipe(_, ez.devices.file.binary.writer(path));
				response.writeHead(200);
				response.write(_);
				break;
			default:
				throw new Error("bad method: " + request.method);
		}
	} catch (ex) {
		console.error(ex.stack);
		response.writeHead(500);
		response.write(_, ex.message);
		response.write(_);
	}
}).listen(_, port);
console.log("server ready. Connect to http://localhost:" + port);