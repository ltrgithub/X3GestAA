"use strict";

var helpers = require('syracuse-core/lib/helpers');
var sys = require("util");
var checkUser = require('syracuse-auth/lib/checkUser');
var authHelper = require('syracuse-auth/lib/helpers');

var tracer; // = console.log;

exports.authenticate = function(_, request, response, session) {
	// REVIEW: why do we test request.connection.authorized in dispatcher and 
	// request.client.authorized here??
	if (!request.client.authorized) throw authHelper.unauthorized();
	var login = ((request.connection.getPeerCertificate() || {}).subject || {}).CN;
	if (!login) throw authHelper.unauthorized();
	var user = checkUser.fromCertificate(_, request.session, login);

	tracer && tracer("User authenticated via certficate: " + login);
	session.authData = {
		user: login,
	};
	return true;
};