"use strict";

var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer("session.trace");
var config = require('config');
var syracuse;
var mock = require('syracuse-load/lib/mock');
var config = require('config');
var checkUser = require('syracuse-auth/lib/checkUser');
var authHelper = require('syracuse-auth/lib/helpers');
var changePasswordError = require('syracuse-auth/lib/changePassword').changePasswordError;

function unauthorized() {
	return authHelper.unauthorized('Nanny realm=' + config.session.realm);
}

exports.authenticate = function(_, request, response, session) {
	var credentials = /^nanny\s([\w\+\/]+\=*)/i.exec(request.headers.authorization);
	if (!(credentials && credentials[1])) throw unauthorized();
	var usr = new Buffer(credentials[1], "base64");
	// use UTF8 for new login screen
	usr = usr.toString("utf8");

	if (!usr) throw unauthorized();


	if (syracuse.server instanceof mock.MockStreamServer && (request.fromNanny || request._request.fromNanny)) {
		console.log("Nanny authentication");


		session.authData = {
			user: usr
		};
		return true;
	}
	return false;
};