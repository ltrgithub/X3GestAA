'use strict';

var config = require("../../../nodelocal").config;
if (!config.sage_id) {
	console.log("Sage ID not loaded: config missing");
	return;
}

var configOpts = {
	baseUrl: config.sage_id.baseUrl,
	pfx: require('fs').readFileSync(config.sage_id.pfxFile),
	passphrase: config.sage_id.passphrase,
	callbackProtocol: config.hosting.https ? "https://" : "http://",
};

var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer('session.trace');
var mongodb = require('streamline-mongodb');
var sessionManager = require('syracuse-session/lib/sessionManager').sessionManager;
var checkUser = require('syracuse-auth/lib/checkUser');
var urlHelper = require('url');
var authHelper = require('syracuse-auth/lib/helpers');

// Temp for debugging
tracer = tracer || console.log;

function getOptions(request) {
	return {
		httpClient: require('syracuse-httpclient/lib/httpClient').httpRequest,
		baseUrl: configOpts.baseUrl,
		pfx: configOpts.pfx,
		passphrase: configOpts.passphrase,
		callbackBase: configOpts.callbackProtocol + request.headers.host + "/auth/sage-id/",
		failureUri: configOpts.callbackProtocol + request.headers.host + "/auth/sage-id/failure",
		cancelAllowed: true,
		sessionLengthMinutes: configOpts.sessionLengthMinutes || 60,
		signOnAfterSuccess: true,
		activateAfterSuccess: true,
	};
}

// Determine which action is necessary for session based on last activity time and timeout
// Execute respected sage-id method to extend or end session
function extendSession(request, response, session, data, _) {
	if (data.notificationType === 'ExpiryDue') {
		var expirationDate = data.expireDate;
		var lastActivity = session.lastAccess;
		var newExpirationDate = new Date(lastActivity.getTime() + 1800000);
		if (newExpirationDate > expirationDate) return true;

		// Mark session as expiration due
		// If any activity is done, session must be extended
		session.expireDue = true;
	}

	return false;
};

function redirect(_, response, url) {
	response.writeHead(307, {
		location: url,
	});
	response.end();
}

function logout(_, request, response, session) {
	var options = getOptions(request);
	options.sessionEnd = false;
	options.sessionId = "";
	if (!session)
		session = request.session;
	if (require('sage-id').create(options).logout(request, response, session, _)) {
		// logout successful
		request.session.authData = null;
	}
}

function renew(_, request, response) {
	var session = request.session;
	// sanity check
	if (!session || !session.authData || !session.authData.auth) throw new Error("internal error: renew outside of auth context");
	// if we don't need to renew, auth is ok so return true.
	if (!session.expireDue) return true;

	var options = baseOptions();
	var authData = require('sage-id').create(options).sessionExtend(request, response, session, _);
	if (!authData || !authData.auth) throw authHelper.unauthenticated();
	else
		validateUser(_, request, response, session, authData);
	return session.authData.auth;
}

function validateUser(_, request, response, session, authData) {
	var user = checkUser.fromLoginPage(_, request, 'sage-id', authData.email, null);

	authData.logout = logout;
	authData.renew = renew;
	session.authData = {
		user: request.session.getData('userLogin'),
		password: authData.accessToken,
		logout: logout,
		renew: renew,
		auth: true
	};
	session.getUserProfile(_);
}

// Update session with new sessionId provided by Sage ID
// This is required as when the session is extended it will need to be able to find
// session to update accessToken
function updateSessionWithID(request, response, session, cookie, authData, _) {
	var sessions = sessionManager.getTenantSessions();
	delete sessions[cookie];
	session.id = authData.sessionId;
	sessions[authData.sessionId] = session;
};

exports.dispatch = function(_, request, response) {
	var session = request.session;

	// intercept /auth/sage-id/failure URL
	if (/^\/auth\/sage-id\/failure/.test(request.url)) {
		session.loginError = "Sage ID operation cancelled!";
		authHelper.redirect(_, request, response, "/auth/login/page");
		return false;
	}

	var sageIdAuth = require("sage-id").create(getOptions(request));
	var authData = sageIdAuth.dispatch(request, response, session, _);
	if (!authData) return; // sage-id redirected user to the Sage ID site.
	if (authData.auth) {
		// Validate user and save variables
		validateUser(_, request, response, session, authData);
		updateSessionWithID(request, response, session, session.id, authData, _);
		//checkForAuthenticatedUser(request, response, session, _);
		authHelper.redirect(_, request, response, session.authTargetUrl || '/', true);
	} else if (authData.sessionNotify) {
		session = sessionManager.sessionById(authData.sessionId);
		var extend = extendSession(request, response, session, authData, _);
		if (extend) {
			authData = sageIdAuth.sessionExtend(request, response, session, _);
			validateUser(_, request, response, session, authData);
		}

		if (authData.notificationType == "Ended" && session) {
			require("sage-id").deleteSessionNotification(_, authData.sessionId);
			session.authData = null;
		}
	}
};

function checkForAuthenticatedUser(request, response, session, _) {
	var listOfSessions = sessionManager.getTenantSessions();
	var sessions = Object.keys(listOfSessions).map(function(k) {
		return listOfSessions[k];
	});
	for (var i = 0; i < sessions.length; i++) {
		var searchSession = sessions[i];
		if (searchSession.EndSignOnAttemptResponse || searchSession.EndRegistrationAttemptResponse) {
			var searchIdentity = searchSession.EndSignOnAttemptResponse.IdentityId || searchSession.EndRegistrationAttemptResponse.IdentityId;
			var searchSessionId = searchSession.EndSignOnAttemptResponse.SessionId || searchSession.EndRegistrationAttemptResponse.SessionId;
			var currentIdentity = session.EndSignOnAttemptResponse.IdentityId || session.EndRegistrationAttemptResponse.IdentityId;
			var currentSessionId = session.EndSignOnAttemptResponse.SessionId || session.EndRegistrationAttemptResponse.SessionId;
			if (searchIdentity === currentIdentity && searchSessionId != currentSessionId) {
				session.loginError = "User already logged in";
				return sessionManager.logout(_, request, response, session);
			}
		}
	};
}

// Export extendSession function for unit test
exports.extendSession = function(request, response, session, data, _) {
	if (data.notificationType === 'ExpiryDue') {
		var expirationDate = data.expireDate;
		var lastActivity = session.lastAccess;
		var newExpirationDate = new Date(lastActivity.getTime() + 1800000);
		if (newExpirationDate > expirationDate) return true;

		// Mark session as expiration due
		// If any activity is done, session must be extended
		session.expireDue = true;
	}

	return false;
};