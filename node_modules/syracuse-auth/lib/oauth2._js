"use strict";

var nodelocal = require("config");
var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer("session.trace");
var url = require("url");
var querystring = require("querystring");
var checkUser = require('syracuse-auth/lib/checkUser');
var authHelper = require('syracuse-auth/lib/helpers');
var adminHelpers = require('syracuse-collaboration/lib/helpers');
var httpClient = require('syracuse-httpclient/lib/httpClient');
var mongodb = require('streamline-mongodb');
var mongoConfig = nodelocal.mongoNotify || {};
var jsxml = require('jsxml');
var CryptoJS = require("crypto-js");

//tracer = console.log;

function create(config, redirectUri) {
	return new function() {
		var self = this;

		/// first step of authentication: redirect to OAuth2 server
		this.loginStart = function(_, request, response, session) {
			var params = {};
			params.redirect_uri = redirectUri;
			params.response_type = 'code';
			params.scope = config.scope;
			params.state = request.url;
			params.client_id = config.clientId;
			var redirectUrl = config.baseSite + config.authorizePath + '?' + querystring.stringify(params);
			response.writeHead(303, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		function getAccessToken(_, code, params) {
			params.client_id = config.clientId,
			params.client_secret = config.clientSecret,
			params[params.grant_type === 'refresh_token' ? 'refresh_token' : 'code'] = code;
			var result = httpClient.httpRequest(_, {
				method: 'POST',
				url: config.baseSite + config.accessTokenPath,
				headers: {
					'content-type': 'application/x-www-form-urlencoded',
				}
			}).end(querystring.stringify(params)).response(_).checkStatus(200).readAll(_);
			// response should be JSON according to http://tools.ietf.org/html/draft-ietf-oauth-v2-07
			// but some sites return urlencoded
			result = result[0] === '{' ? JSON.parse(result) : querystring.parse(result);
			return result;
		}

		/// second step of authentication: obtain access token and user name
		this.loginCallback = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryData = querystring.parse(parsed.query);
			if (queryData.error) throw authHelper.error(403, queryData.error);
			if (!queryData.code) throw authHelper.error(403, "internal error: authorization code missing");
			var params = {};
			params.redirect_uri = redirectUri;
			// params['state'] = queryData.state;
			params.grant_type = 'authorization_code';

			tracer && tracer("Before getting access token");
			// get access token 
			var tokens = getAccessToken(_, queryData.code, params);
			// get user name
			tracer && tracer("Result of access token ", tokens);
			var json = getUserInfo(_, tokens.access_token, config.dataRequestURL);
			tracer && tracer("Result of user name ", json);
			var userField = config.userField || "user";
			var login = userField.split('.').reduce(function(obj, field) {
				var m = /^(\w+)\[(\d+)\]$/.exec(field);
				return m ? obj[m[1]][m[2]] : obj[field];
			}, json);
			var user = checkUser.fromLoginPage(_, request, 'oauth2', login, null, null, config.name);

			request.session.authData = {
				login: user,
				password: tokens.access_token
			};
			authHelper.redirect(_, request, response, request.session.authTargetUrl || '/', true);
		};

		this.sageIdStart = function(_, request, response) {
			var params = {};
			params.response_type = 'code';
			params.scope = config.scope;
			params.client_id = config.client_id;
			params.redirect_uri =  redirectUri;
			params.state = request.session.id;

			insertSessionNotification(_, request.headers.host, request.session.id);

			var resp = httpClient.httpRequest(_, {
				method: 'GET',
				url: config.baseUrl + '/OAuthService/WebStartAuthorisationAttempt?' + querystring.stringify(params),
			}).end().response(_).checkStatus(302);

			var redirectUrl = '';
			if (resp.headers.location)
				redirectUrl = resp.headers.location;
			else
				throw new Error('Invalid OAuth start request');

			response.writeHead(302, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		this.sageIdRedirect = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryString = parsed.search;
			var queryData = querystring.parse(parsed.query);
			var sessionId = decodeURIComponent(queryData.state);

			var db = initializeMongoDB();
			var filter = {
				_id: '' + sessionId
			};
			// Find customer host by sessionId extract from Sage ID notification
			var doc = db.open(_).collection('OAuth_Redirects', _).find(filter, _).toArray(_)[0];
			var host = doc.host;

			deleteSessionNotification(_, sessionId);

			var redirectUrl = (nodelocal.hosting.https ? "https://" : "http://") + host + config.redirectPath + queryString;
			response.writeHead(303, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		this.sageIdCallback = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryData = querystring.parse(parsed.query);
			var code = decodeURIComponent(queryData.code);
			var sessionId = decodeURIComponent(queryData.state);

			var params = {};
			params.grant_type = 'authorization_code';
			params.code = code;
			params.redirect_uri = redirectUri;

			var json = getSageIdToken(_, params);
			console.log('\n', "JSON: ", json, '\n');
			console.log("ACCESS_TOKEN: ", json.access_token, '\n')
			var decryptedXML = decryptToken(config.key, config.iv, json.access_token);
			console.log("XML: ", decryptedXML, '\n')
			var decryptedJSON = jsxml.parse(decryptedXML);
			var email = decryptedJSON["AuthenticationToken"]["Subject"]["UserPrincipal"]["EmailAddress"];

			var user = checkUser.fromLoginPage(_, request, 'sage-id', email, null);
			request.session.authData = {
				login: user,
				password: json.access_token
			};
			authHelper.redirect(_, request, response, request.session.authTargetUrl || '/', true);
		};

		function getSageIdToken(_, params) {
			var client_secret = config.client_id + ':' + config.secret_key;
			var base64Key = new Buffer(client_secret).toString('base64');

			var clientOptions = {
				method: 'POST',
				url: config.baseUrl + '/OAuthService/WebGetAccessToken',
				headers: {
					'Authorization': 'Basic ' + base64Key,
					'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
				}
			};


			var result = httpClient.httpRequest(_, clientOptions).end(querystring.stringify(params)).response(_).readAll(_);
			var json = JSON.parse(result);
			var accessToken = decodeURIComponent(json.access_token);
			return json;
		}
	};
};

exports.getServerList = function(_) {
	if (!authHelper.isAllowed("oauth2")) return [];
	var db = adminHelpers.AdminHelper.getCollaborationOrm(_);
	// fetch OAuth2 server data
	return db.fetchInstances(_, db.model.getEntity(_, "oauth2"), {
		sdataWhere: ""
	}).filter_(_, function(_, oauth2) {
		return oauth2.active(_);
	}).map_(_, function(_, oauth2) {
		var name = oauth2.name(_);
		return {
			href: "/auth/oauth2/" + name + '/loginStart',
			title: oauth2.displayName(_) || name,
		};
	});
};

function loginStart(_, request, response) {
	return request.oauth2.loginStart(_, request, response);
}

function loginCallback(_, request, response) {
	return request.oauth2.loginCallback(_, request, response);
}

function sageIdStart(_, request, response) {
	return request.oauth2.sageIdStart(_, request, response);
}

function sageIdRedirect(_, request, response) {
	return request.oauth2.sageIdRedirect(_, request, response);
}

function sageIdCallback(_, request, response) {
	return request.oauth2.sageIdCallback(_, request, response);
}

function getUserInfo(_, accessToken, dataRequestURL) {
	var parsed = url.parse(dataRequestURL);

	var resp = httpClient.httpRequest(_, {
		method: 'GET',
		url: dataRequestURL,
		headers: {
			authorization: 'Bearer ' + accessToken,
			host: parsed.host,
			'content-length': 0,
		},
	}).end().response(_);
	var result = resp.readAll(_);
	if (!result || result[0] !== '{') throw authHelper.error(resp.statusCode, "getUserInfo request failed: " + resp.statusCode);
	result = JSON.parse(result);
	if (result.error && result.error.message) throw authHelper.error(resp.statusCode, result.error.message);
	return result;
}

exports.getUserInfo = getUserInfo;

var dispatcher = authHelper.dispatcher(4, {
	loginStart: loginStart,
	loginCallback: loginCallback,
	sageIdStart: sageIdStart,
	sageIdRedirect: sageIdRedirect,
	sageIdCallback: sageIdCallback
});

exports.dispatch = function(_, request, response) {
	var m = /\/[^\/]*\/[^\/]*\/([^\/]*)\//.exec(request.url);
	if (!m || !m[1]) throw authHelper.error(404, "internal error: bad url: " + request.url);
	var name = m[1];
	if (name !== 'sageid') {
		var db = adminHelpers.AdminHelper.getCollaborationOrm(_);
		var server = db.fetchInstances(_, db.model.getEntity(_, "oauth2"), {
			jsonWhere: {
				name: name,
			}
		})[0];
		if (!server) throw authHelper.error(404, "internal error: oauth2 server not found: " + name);
		if (!server.active(_)) throw authHelper.error(403, "internal error: oauth2 server not active: " + name);
		var redirectUri = ("authorized" in request.connection ? "https://" : "http://") + request.headers.host + server.redirectPath(_);
		request.oauth2 = create(server._data, redirectUri);
	} else {
		var sageIdOAuth = (nodelocal.sage_id && nodelocal.sage_id.oauth) ? nodelocal.sage_id.oauth : {};
		request.oauth2 = create(sageIdOAuth, sageIdOAuth.redirectUrl);
	}
	return dispatcher(_, request, response);
};

function insertSessionNotification(_, host, sessionId) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	db.open(_).collection('OAuth_Redirects', _).update({ _id: sessionId, host: host }, { _id: sessionId, host: host }, { upsert: true }, _);
	db.close(_);
}

function deleteSessionNotification(_, sessionId) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	db.open(_).collection('OAuth_Redirects', _).remove({ _id: sessionId}, null, _);
	db.close(_);
}

function initializeMongoDB(mongoHost, mongoPort, mongoDatabase) {
	var server = new mongodb.Server(mongoHost || 'localhost', mongoPort || 27017, {});
	var db = new mongodb.Db(mongoDatabase || 'syracuse', server, {
		w: 1 // majority
	});
	return db;
}

function decryptToken(key, iv, encryptedToken) {
	var keyHex = CryptoJS.enc.Hex.parse(CryptoJS.enc.Base64.parse(key).toString());
	var ivHex = CryptoJS.enc.Hex.parse(CryptoJS.enc.Base64.parse(iv).toString());

	var options = {
	    mode: CryptoJS.mode.CBC, 
	    padding: CryptoJS.pad.Pkcs7,
	    iv: ivHex
	};

	var base64String = encryptedToken.toString();
	var decodedStr = CryptoJS.enc.Base64.parse(base64String);
	var decrypted = CryptoJS.AES.decrypt( {
	    ciphertext: decodedStr
	}, keyHex, options);

	var decryptedStr = decrypted.toString(CryptoJS.enc.Utf8);
	return decryptedStr;
}

exports.decryptToken = decryptToken;