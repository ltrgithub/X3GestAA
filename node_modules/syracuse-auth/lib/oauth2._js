"use strict";

var nodelocal = require("config");
var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer("session.trace");
var url = require("url");
var querystring = require("querystring");
var checkUser = require('syracuse-auth/lib/checkUser');
var authHelper = require('syracuse-auth/lib/helpers');
var adminHelpers = require('syracuse-collaboration/lib/helpers');
var httpClient = require('syracuse-httpclient/lib/httpClient');
var mongodb = require('mongodb');
var mongoConfig = nodelocal.mongoNotify || {};
var jsxml = require('js-xml');
var crypto = require('crypto');

//tracer = console.log;

function create(config, redirectUri) {
	return new function() {
		var self = this;

		/// first step of authentication: redirect to OAuth2 server
		this.loginStart = function(_, request, response, session) {
			var params = {};
			params.redirect_uri = redirectUri;
			params.response_type = 'code';
			params.scope = config.scope;
			params.state = request.url;
			params.client_id = config.clientId;
			var redirectUrl = config.baseSite + config.authorizePath + '?' + querystring.stringify(params);
			response.writeHead(303, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		function getAccessToken(_, code, params) {
			params.client_id = config.clientId,
			params.client_secret = config.clientSecret,
			params[params.grant_type === 'refresh_token' ? 'refresh_token' : 'code'] = code;
			var result = httpClient.httpRequest(_, {
				method: 'POST',
				url: config.baseSite + config.accessTokenPath,
				headers: {
					'content-type': 'application/x-www-form-urlencoded',
				}
			}).end(querystring.stringify(params)).response(_).checkStatus(200).readAll(_);
			// response should be JSON according to http://tools.ietf.org/html/draft-ietf-oauth-v2-07
			// but some sites return urlencoded
			result = result[0] === '{' ? JSON.parse(result) : querystring.parse(result);
			return result;
		}

		/// second step of authentication: obtain access token and user name
		this.loginCallback = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryData = querystring.parse(parsed.query);
			if (queryData.error) throw authHelper.error(403, queryData.error);
			if (!queryData.code) throw authHelper.error(403, "internal error: authorization code missing");
			var params = {};
			params.redirect_uri = redirectUri;
			// params['state'] = queryData.state;
			params.grant_type = 'authorization_code';

			tracer && tracer("Before getting access token");
			// get access token 
			var tokens = getAccessToken(_, queryData.code, params);
			// get user name
			tracer && tracer("Result of access token ", tokens);
			var json = getUserInfo(_, tokens.access_token, config.dataRequestURL);
			tracer && tracer("Result of user name ", json);
			var userField = config.userField || "user";
			var login = userField.split('.').reduce(function(obj, field) {
				var m = /^(\w+)\[(\d+)\]$/.exec(field);
				return m ? obj[m[1]][m[2]] : obj[field];
			}, json);
			var user = checkUser.fromLoginPage(_, request, 'oauth2', login, null, null, config.name);

			request.session.authData = {
				login: user,
				password: tokens.access_token
			};
			authHelper.redirect(_, request, response, request.session.authTargetUrl || '/', true);
		};

		this.sageIdStart = function(_, request, response) {
			var params = {};
			params.response_type = 'code';
			params.scope = config.scope;
			params.client_id = config.client_id;
			params.redirect_uri = redirectUri;
			params.state = request.session.id;

			insertSessionNotification(_, request.headers.host, request.session.id);

			var resp = httpClient.httpRequest(_, {
				method: 'GET',
				url: config.baseUrl + '/OAuthService/WebStartAuthorisationAttempt?' + querystring.stringify(params),
			}).end().response(_).checkStatus(302);

			var redirectUrl = '';
			if (resp.headers.location)
				redirectUrl = resp.headers.location;
			else
				throw authHelper.error(404, 'Invalid OAuth start request');

			response.writeHead(302, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		this.sageIdRedirect = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryString = parsed.search;
			var queryData = querystring.parse(parsed.query);
			var sessionId = decodeURIComponent(queryData.state);

			var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
			var filter = {
				_id: '' + sessionId
			};

			var doc = db.open(_).collection('OAuth_Redirects', _).find(filter, _).toArray(_)[0];
			var host = doc.host;

			deleteSessionNotification(_, sessionId);

			var redirectUrl = (nodelocal.hosting.https ? "https://" : "http://") + host + config.redirectPath + queryString;
			response.writeHead(303, {
				"content-type": "text/html",
				location: redirectUrl
			});
			response.end('<html>Use <a href="' + redirectUrl + '">Login</a> if redirect does not work automatically</html>');
			return false;
		};

		this.sageIdCallback = function(_, request, response) {
			var parsed = url.parse(request.url);
			var queryData = querystring.parse(parsed.query);
			var code = decodeURIComponent(queryData.code);
			var sessionId = decodeURIComponent(queryData.state);

			var params = {};
			params.grant_type = 'authorization_code';
			params.code = code;
			params.redirect_uri = redirectUri;

			var json = getSageIdToken(_, params);
			var tokenData = {};
			tokenData.access_token = json.access_token;
			tokenData.refresh_token = json.refresh_token;
			var expiresTime = json.expires_in * 1000;
			tokenData.expirationDate = new Date(new Date().getTime() + expiresTime);
			tokenData.retrievalUrl = (nodelocal.hosting.https ? "https://" : "http://") + request.headers.host + config.retrieveTokenPath + '/' + request.session.id;
			storeAccessToken(_, request.session.id, tokenData);

			var decryptedXML = decryptToken(config.key, config.iv, json.access_token);
			var decryptedJSON = jsxml.parse(decryptedXML);
			var email = decryptedJSON["AuthenticationToken"]["Subject"]["UserPrincipal"]["EmailAddress"];

			var user = checkUser.fromLoginPage(_, request, 'sage-id', email, null);
			request.session.authData = {
				login: user,
				password: json.access_token
			};
			authHelper.genPage(_, response, __dirname + "/../html/token.html", {
				sageIdTokenId: ''
			});
		};

		function getSageIdToken(_, params) {
			var client_secret = config.client_id + ':' + config.secret_key;
			var base64Key = new Buffer(client_secret).toString('base64');

			var clientOptions = {
				method: 'POST',
				url: config.baseUrl + '/OAuthService/WebGetAccessToken',
				headers: {
					'Authorization': 'Basic ' + base64Key,
					'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
				}
			};


			var result = httpClient.httpRequest(_, clientOptions).end(querystring.stringify(params)).response(_).readAll(_);
			var json = JSON.parse(result);
			return json;
		};

		this.sageIdDownloadToken = function(_, request, response) {
			var parsedUrl = request.url.substring(request.url.indexOf('sageid'), request.url.length).split(/[\/\?]/);
			var id = request.session.id;
			if (parsedUrl[2])
				id = parsedUrl[2];

			var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
			var tokenData = db.open(_).collection('Tokens', _).find({
				_id: id
			}).toArray(_)[0];
			db.close(_);
			response.writeHead(200, {
				'content-type': 'application/json',
				'content-disposition': 'attachment; filename=accessToken.json'
			});
			response.end(JSON.stringify(tokenData, null, 2));
		};

		this.sageIdTokenRetrieval = function(_, request, response) {
			var parsedUrl = request.url.substring(request.url.indexOf('sageid'), request.url.length).split(/[\/\?]/);
			if (!parsedUrl[2])
				throw authHelper.error(404, "Invalid token id");
			var id = parsedUrl[2];
			// Find access token
			var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
			var token = db.open(_).collection('Tokens', _).find({
				_id: id
			}).toArray(_)[0];
			if (!token)
				throw authHelper.error(404, "Invalid access token");
			// Validate access token
			var accessToken = sageIdTokenValidation(_, request, response, token.tokenData.access_token);
			// Return access token
			response.writeHead(200, {
				'content-type': 'application/json',
			});
			response.end(JSON.stringify(accessToken, null, 2));
			//authHelper.genPage(_, response, __dirname + "/../html/token.html", {sageIdTokenId: id});
		};

		this.sageIdTokenRefresh = function(_, request, response, refreshToken) {
			var params = {};
			params.grant_type = 'refresh_token';
			params.refresh_token = refreshToken;

			var json = getSageIdToken(_, params);
			return json;
		};
	};
};

exports.getServerList = function(_) {
	if (!authHelper.isAllowed("oauth2")) return [];
	var db = adminHelpers.AdminHelper.getCollaborationOrm(_);
	// fetch OAuth2 server data
	return db.fetchInstances(_, db.model.getEntity(_, "oauth2"), {
		sdataWhere: ""
	}).filter_(_, function(_, oauth2) {
		return oauth2.active(_);
	}).map_(_, function(_, oauth2) {
		var name = oauth2.name(_);
		var href = "/auth/oauth2/" + name + '/loginStart';
		if (name === 'sageid')
			href = "/auth/oauth2/" + name + '/sageIdStart';
		return {
			href: href,
			title: oauth2.displayName(_) || name,
		};
	});
};

function loginStart(_, request, response) {
	return request.oauth2.loginStart(_, request, response);
}

function loginCallback(_, request, response) {
	return request.oauth2.loginCallback(_, request, response);
}

function sageIdStart(_, request, response) {
	return request.oauth2.sageIdStart(_, request, response);
}

function sageIdRedirect(_, request, response) {
	return request.oauth2.sageIdRedirect(_, request, response);
}

function sageIdCallback(_, request, response) {
	return request.oauth2.sageIdCallback(_, request, response);
}

function sageIdDownloadToken(_, request, response) {
	return request.oauth2.sageIdDownloadToken(_, request, response);
}

function sageIdTokenRetrieval(_, request, response) {
	return request.oauth2.sageIdTokenRetrieval(_, request, response);
}

function getUserInfo(_, accessToken, dataRequestURL) {
	var parsed = url.parse(dataRequestURL);

	var resp = httpClient.httpRequest(_, {
		method: 'GET',
		url: dataRequestURL,
		headers: {
			authorization: 'Bearer ' + accessToken,
			host: parsed.host,
			'content-length': 0,
		},
	}).end().response(_);
	var result = resp.readAll(_);
	if (!result || result[0] !== '{') throw authHelper.error(resp.statusCode, "getUserInfo request failed: " + resp.statusCode);
	result = JSON.parse(result);
	if (result.error && result.error.message) throw authHelper.error(resp.statusCode, result.error.message);
	return result;
}

exports.getUserInfo = getUserInfo;

var dispatcher = authHelper.dispatcher(4, {
	loginStart: loginStart,
	loginCallback: loginCallback,
	sageIdStart: sageIdStart,
	sageIdRedirect: sageIdRedirect,
	sageIdCallback: sageIdCallback,
	sageIdDownloadToken: sageIdDownloadToken,
	sageIdTokenRetrieval: sageIdTokenRetrieval
});

exports.dispatch = function(_, request, response) {
	var m = /\/[^\/]*\/[^\/]*\/([^\/]*)\//.exec(request.url);
	if (!m || !m[1]) throw authHelper.error(404, "internal error: bad url: " + request.url);
	var name = m[1];
	if (name !== 'sageid') {
		var db = adminHelpers.AdminHelper.getCollaborationOrm(_);
		var server = db.fetchInstances(_, db.model.getEntity(_, "oauth2"), {
			jsonWhere: {
				name: name,
			}
		})[0];
		if (!server) throw authHelper.error(404, "internal error: oauth2 server not found: " + name);
		if (!server.active(_)) throw authHelper.error(403, "internal error: oauth2 server not active: " + name);
		var redirectUri = ("authorized" in request.connection ? "https://" : "http://") + request.headers.host + server.redirectPath(_);
		request.oauth2 = create(server._data, redirectUri);
	} else {
		var sageIdOAuth = (nodelocal.sage_id && nodelocal.sage_id.oauth) ? nodelocal.sage_id.oauth : {};
		request.oauth2 = create(sageIdOAuth, sageIdOAuth.redirectUrl);
	}
	return dispatcher(_, request, response);
};

function storeAccessToken(_, sessionId, data) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	db.open(_).collection('Tokens', _).update({
		_id: sessionId
	}, {
		_id: sessionId,
		tokenData: data
	}, {
		upsert: true
	}, _);
	db.close(_);
}

function insertSessionNotification(_, host, sessionId) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	db.open(_).collection('OAuth_Redirects', _).update({
		_id: sessionId,
		host: host
	}, {
		_id: sessionId,
		host: host
	}, {
		upsert: true
	}, _);
	db.close(_);
}

function deleteSessionNotification(_, sessionId) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	db.open(_).collection('OAuth_Redirects', _).remove({
		_id: sessionId
	}, null, _);
	db.close(_);
}

function initializeMongoDB(mongoHost, mongoPort, mongoDatabase) {
	var server = new mongodb.Server(mongoHost || 'localhost', mongoPort || 27017, {});
	var db = new mongodb.Db(mongoDatabase || 'syracuse', server, {
		w: 1 // majority
	});
	return db;
}

function decryptToken(key, iv, encryptedToken) {
	var keyBuf = new Buffer(key, 'base64');
	var ivBuf = new Buffer(iv, 'base64');
	var tokenBuf = new Buffer(encryptedToken, 'base64');

	var decipher = crypto.createDecipheriv('aes-256-cbc', keyBuf, ivBuf);
	var decryptString = decipher.update(tokenBuf, 'base64', 'utf8');
	decryptString += decipher.final('utf8');

	return decryptString.toString();
}

exports.decryptToken = decryptToken;

exports.sageIdTokenValidation = sageIdTokenValidation;

function sageIdTokenValidation(_, request, response, accessToken) {
	var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
	var filter = {
		"tokenData.access_token": accessToken
	};
	var token = db.open(_).collection('Tokens', _).find(filter).toArray(_)[0];
	if (!token)
		throw authHelper.error(404, "Invalid access token");

	var valid = validateToken(token.tokenData);
	if (valid)
		return accessToken;
	else {
		// Refresh token
		var refreshToken = token.tokenData.refresh_token;
		var sageIdOAuth = (nodelocal.sage_id && nodelocal.sage_id.oauth) ? nodelocal.sage_id.oauth : {};
		var json = create(sageIdOAuth, sageIdOAuth.redirectUrl).sageIdTokenRefresh(_, request, response, refreshToken);
		// Create update parameters
		var newTokenData = {};
		newTokenData.access_token = json.access_token;
		newTokenData.refresh_token = json.refresh_token;
		var expiresTime = json.expires_in * 1000;
		newTokenData.expirationDate = new Date(new Date().getTime() + expiresTime);
		// Update database with new token data
		var db = initializeMongoDB(mongoConfig.host, mongoConfig.port, mongoConfig.database);
		db.open(_).collection('Tokens', _).update({
			"tokenData.refresh_token": refreshToken
		}, {
			tokenData: newTokenData
		}, {
			upsert: true
		}, _);
		db.close(_);
		return newTokenData.access_token;
	}
};

function validateToken(tokenData) {
	var valid = true;
	var currentDate = new Date();
	var expirationDate = new Date(tokenData.expirationDate);
	if (currentDate > expirationDate)
		valid = false;
	return valid;
};