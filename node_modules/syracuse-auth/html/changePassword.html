<!DOCTYPE html>
<html>
	<meta http-equiv="X-UA-Compatible" content="IE=9">
	<head>
		<title>Sage</title>
		<meta content="text/html; charset=UTF-8" http-equiv="content-type">
		<meta http-equiv="X-UA-Compatible" content="IE=9">
		<link rel="stylesheet" type="text/css" href="/syracuse-auth/html/login.css">
		<link href="/syracuse-auth/html/changePassword.css" rel="stylesheet"/>
		<script src="/syracuse-auth/html/deps/md5.min.js"></script>
		<script>
function submit() {
  var login = document.formular.login.value;
  var realm = document.formular.realm.value;
  var pwd = document.formular.password.value;
  if (pwd !== document.formular.passwordAgain.value) {
	alert("{{different}}");
	return;
  }
  if (("" + pwd).length === 0) {
	alert("{{empty}}");
	return;
  }
  document.formular.passwordAgain.value = document.formular.password.value = "";
  // convert to UTF8
  var s = login + ":" + realm + ":" + pwd;
  var i = s.length;
  while (--i >= 0) {
	var c = s.charCodeAt(i);
	if (c > 127) 
	{
	  if (c < 2047) s = s.substr(0, i)+String.fromCharCode(192|(c>>6), 128|(c & 0x3F))+s.substr(i+1);
	  else s = s.substr(0, i)+String.fromCharCode(224|(c>>12), 128|((c>>6)&0x3F), 128|(c & 0x3F))+s.substr(i+1);
	}
  }
  var data = {
	login: login,
	realm: realm,
	passwordHash: "U"+md5(s)
  }
  var request = new XMLHttpRequest();
  request.open("POST", "/auth/changePassword/submit", true);
  request.setRequestHeader("content-type", "application/json");
  request.setRequestHeader("accept", "application/json");

	request.onreadystatechange = function(aEvt) {
	if (request.readyState == 4) {
	  try {
		json = JSON.parse(request.responseText);
		window.location.href = json.$diagnoses[0].$links.$redirect.$url;
	  } catch (ex) {
		document.getElementById('s-error-message').textContent = ex.message || request.statusText;
		document.getElementById('password').focus();
	  }
	}
  };
  request.send(JSON.stringify(data));
}

		</script>
	</head>
	<body>
		<div class="container">
			<div class="s-text-containt">
				<div class="s-text">
					<div class="s-newpwd-title" style="" data-s-box="4" title="Change password">
						{{changePasswdHeader}}
					</div>							
					<div id="s-newpwd-panel">
						<form id="formular" name="formular" action="javascript:submit()" method="POST">
							<label id="s-newpwd-description">
								{{explanation}}
							</label>
							<label id="s-error-message" class="z-error"></label>	
							<div class="z-field">
								<input name="password" autocomplete="off" placeholder="{{newPwd}}" type="password">							
							</div>
							<div class="z-field">
								<input name="passwordAgain" autocomplete="off" placeholder="{{newPwdAgain}}" type="password">							
							</div>
							<div class="z-action" >
								
								<input id="s-newpwd-btn" type="submit" value="{{chgPasswd}}">
							</div>
							<div class="z-field">
								<input name="login" type="hidden" value="{{login}}" autocomplete="off">
							</div>
							<div class="z-field">
								<input name="salt" type="hidden" value="{{salt}}" autocomplete="off">
							</div>
							<div class="z-field">
								<input name="realm" type="hidden" value="{{realm}}" autocomplete="off">
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</body>
</html>
