﻿<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=10">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=10">
	<title>Sage {{productName}}</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="/syracuse-auth/html/login.css">
	<link rel="stylesheet" type="text/css" href="/syracuse-auth/html/productname.css">

	<script type="text/javascript">
		var idx = window.location.href.indexOf("?");
		var params = "";
		if( idx !== -1 ){
			params = window.location.href.substring(idx);
		}
		if( {{js$hasCookie}} ){
			// get query string parameter
			redirect("/auth/forgetMe/page"+params);
		}
		var requestInProgress =false;
		function init() {
		    var i = -1;
			var oauth2s = {{js$oauth2s}};
			if (oauth2s.length > 0) {
				var div = document.getElementById("ext-0");
				var parent = div.parentNode;
				oauth2s.forEach(function(oauth2) {
					if (++i > 0) {
						div = div.cloneNode(true);
						div.id = "oauth2-" + i;
						parent.appendChild(div);
					}
					div.firstElementChild.href = oauth2.href;
					div.firstElementChild.textContent = oauth2.title;
				});
			} else {
				var div = document.getElementById("oauth2-0");
				div.style.display = 'none';
			}

			var saml2s = {{js$saml2s}};
			if (saml2s.length > 0) {
			    var div = document.getElementById("ext-0");
			    var parent = div.parentNode;
			    saml2s.forEach(function(saml2) {
			        if (++i > 0) {
			            div = div.cloneNode(true);
			            div.id = "saml2-" + i;
			            parent.appendChild(div);
			        }
			        div.firstElementChild.href = saml2.href;
			        div.firstElementChild.textContent = saml2.title;
			    });
			} else {
				var div = document.getElementById("saml2-0");
				div.style.display = 'none';
			}

			document.getElementById('username').focus();
		}
		window.addEventListener ? window.addEventListener('load', init, false) : window.attachEvent('onload', init);

		function authToken(type, username, password) {
			// convert to UTF8 (only works for characters with code points up to 65535)
			var s = username + ":" + password;
            var i = s.length;
			while (--i >= 0) {
				var c = s.charCodeAt(i);
                if (c > 127) 
                {
                  if (c < 2047) s = s.substr(0, i)+String.fromCharCode(192|(c>>6), 128|(c & 0x3F))+s.substr(i+1);
                  else s = s.substr(0, i)+String.fromCharCode(224|(c>>12), 128|((c>>6)&0x3F), 128|(c & 0x3F))+s.substr(i+1);
                }
			}
			// !!! btoa not supported on IE??
			switch (type) {
				case 'basic':
					return 'Basic ' + window.btoa(s);
				case 'sageerpx3':
					return 'sageerpx3 ' + window.btoa(s);
				default:
					return null;
			}
		}

		function authenticate(type) {
			if (!requestInProgress) {
				requestInProgress = true;
				if (type === undefined) {
					type = ['basic', 'digest', 'ldap'].filter(function (t) {
						return document.getElementById('go-' + t).style.display !== "none";
					})[0];
				}
				var username = document.getElementById('username').value;
				var password = document.getElementById('password').value;
				var keepConnected = document.getElementById('keepConnected').checked;

				var auth = authToken(type, username, password);
				if (!auth) return alert("unsupported authentication method: " + auth);

				var request = new XMLHttpRequest();
				request.open("POST", "/auth/login/submit", true);
				request.setRequestHeader("authorization", auth);
				request.setRequestHeader("accept", "application/json");
				request.setRequestHeader("content-type", "application/json");
				request.onreadystatechange = function (aEvt) {
					if (request.readyState == 4) {
						try {
							json = JSON.parse(request.responseText);
							window.location.href = json.$diagnoses[0].$links.$redirect.$url;
							requestInProgress = false;

						} catch (ex) {
							document.getElementById('error-msg').textContent = ex.message || request.statusText;
							document.getElementById('password').value = "";
							document.getElementById('username').focus();
						}
					}
				};
				request.send(JSON.stringify({keepConnected: keepConnected}));
			}
		}
		function redirect(url) {
			window.location = url;
		}
	</script>
</head>

<body>
	<div class="container">
		<div class="s-text-containt">
			<div class="s-text">
				<div class="s-product">
					<span class="s-m-brand">Sage</span>
					<span class="s-m-product">{{productName}}</span>
				</div>
				<div class="z-error">
					<div id="error-msg">{{errorMessage}}</div>
				</div>
				<form id="loginForm">
				<div class="s-visibility-{{passwordVisibility}}">
					<div class="z-field">
						<input id="username"  autocomplete="on" placeholder="{{loginLabel}}" type="text">
					</div>
					<div class="z-field">
						<input id="password"  autocomplete="on" placeholder="{{passwordLabel}}" type="password">
					</div>
					<div class="z-field" id="check">
						<input id="keepConnected"  autocomplete="on" type="checkbox" class="z-input-check"> {{keepConnectedLabel}}
					</div>
					<div class="z-action s-visibility-{{basicVisibility}}">
						<a id="go-basic" href="javascript:authenticate('basic')">{{dbGo}}</a>
					</div>
					<div class="z-action s-visibility-{{digestVisibility}}">
						<a id="go-digest"href="javascript:authenticate('digest')">{{dbGo}}</a>
					</div>
					<div class="z-action s-visibility-{{ldapVisibility}}">
						<a id="go-ldap" href="javascript:authenticate('ldap')">{{ldapGo}}</a>
					</div>
    				<input onclick="javascript:authenticate(); return false;" type="submit" class="submit"></input><!-- to capture enter key -->
    			</div>
				</form>
			</div>
			<div class="s-text s-visibility-{{extVisibility}}" >
				<div class="s-product-other">{{extTitle}}</div>
				<div id="ext-0" class="z-action" >
					<a href=""></a>
				</div>
			</div>
			<div class="s-text s-visibility-{{sage-idVisibility}}" >
				<div class="s-product-other" >{{sageIdTitle}}</div>
				<div class="z-action" >
					<a href="javascript:redirect('/auth/sage-id/signOnStart')">{{sageIdSignOn}}</a>
				</div>
				<div class="z-action" >
					<a href="javascript:redirect('/auth/sage-id/registerExistStart')">{{sageIdRegisterExist}}</a>
				</div>
				<div class="z-action">
					<a href="javascript:redirect('/auth/sage-id/registerStart')">{{sageIdRegister}}</a>
				</div>
			</div>
		</div>
	</div>
</body>
</html>