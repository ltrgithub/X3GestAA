<!DOCTYPE html>
<html><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=10">
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=10">
	<title>Sage ERP X3</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="/syracuse-auth/html/login.css">
	<script type="text/javascript">
		var idx = window.location.href.indexOf("?");
		var params = "";
		if( idx !== -1 ){
			params = window.location.href.substring(idx);
		}
		if( !{{js$hasCookie}} ){
			redirect("/auth/login/page"+params);
		}


		function init() {
			var oauth2s = {{js$oauth2s}};
			if (oauth2s.length > 0) {
				var div = document.getElementById("oauth2-0");
				var parent = div.parentNode;
				oauth2s.forEach(function(oauth2, i) {
					if (i > 0) {
						div = div.clone(true);
						div.id = "oauth2-" + i;
						parent.appendChild(div);
					}
					div.firstElementChild.href = oauth2.href;
					div.firstElementChild.textContent = oauth2.title;
				});
			}
			// prefil user name and password
			document.getElementById('username').value = "{{js$login}}";
			document.getElementById('password').style.visibility = "hidden"; // doesn't matter we use the login cookie
			document.getElementById('check').style.visibility = 'hidden'; // hidden by default.
			// change label of sign button
			document.getElementById('go-basic').innerHTML = "{{enterLabel}}";
			document.getElementById('go-digest').innerHTML = "{{enterLabel}}";
			document.getElementById('go-ldap').innerHTML = "{{enterLabel}}";

		}

		function askResign(){
			if( document.getElementById('check').style.visibility === "hidden" ) {
				document.getElementById('username').value = "";
				document.getElementById('password').value = ""; // doesn't matter we use the login cookie
				document.getElementById('check').style.visibility = 'visible'; // hidden by default.
				document.getElementById('password').style.visibility = "visible"; // doesn't matter we use the login cookie

				// change label of sign button
				document.getElementById('go-basic').innerHTML = "{{dbGo}}";
				document.getElementById('go-digest').innerHTML = "{{dbGo}}";
				document.getElementById('go-ldap').innerHTML = "{{ldapGo}}";
			}
		}
		window.addEventListener ? window.addEventListener('load', init, false) : window.attachEvent('onload', init);

		function authToken(type, username, password) {
			// convert to UTF8 (only works for characters with code points up to 65535)
			var s = username + ":" + password;
            var i = s.length;
			while (--i >= 0) {
				var c = s.charCodeAt(i);
                if (c > 127) 
                {
                  if (c < 2047) s = s.substr(0, i)+String.fromCharCode(192|(c>>6), 128|(c & 0x3F))+s.substr(i+1);
                  else s = s.substr(0, i)+String.fromCharCode(224|(c>>12), 128|((c>>6)&0x3F), 128|(c & 0x3F))+s.substr(i+1);
                }
			}
			// !!! btoa not supported on IE??
			switch (type) {
				case 'basic':
					return 'Basic ' + window.btoa(s);
				case 'sageerpx3':
					return 'sageerpx3 ' + window.btoa(s);
				default:
					return null;
			}
		}

		function forgetme() {
			var request = new XMLHttpRequest();
			request.open("POST", "/auth/forgetMe/submit", true);
			request.setRequestHeader("accept", "application/json");
			request.setRequestHeader("content-type", "application/json");
			request.onreadystatechange = function(aEvt) {
				if (request.readyState == 4) {
					try {
						json = JSON.parse(request.responseText);
						window.location.href = json.$diagnoses[0].$links.$redirect.$url;
					} catch (ex) {
						document.getElementById('error-msg').textContent = ex.message || request.statusText;

					}
				}
			};
			request.send(JSON.stringify({forgetme : true}));
		}
		function authenticateAndForget(type) {
			if( document.getElementById('check').style.visibility==="hidden") {
				// keepConnected check is hidden. we just ask for relog
				redirect(params ? params.substring(8) :'/');
			}else{// keepConnected is displayed so we asked for relogin and forget me

				if (type === undefined) {
					type = ['basic', 'digest', 'ldap'].filter(function (t) {
						return document.getElementById('go-' + t).style.display !== "none";
					})[0];
				}
				var username = document.getElementById('username').value;
				var password = document.getElementById('password').value;
				var keepConnected = document.getElementById('keepConnected').checked;

				var auth = authToken(type, username, password);
				if (!auth) return alert("unsupported authentication method: " + auth);

				var request = new XMLHttpRequest();
				request.open("POST", "/auth/login/submit", true);
				request.setRequestHeader("authorization", auth);
				request.setRequestHeader("accept", "application/json");
				request.setRequestHeader("content-type", "application/json");
				request.onreadystatechange = function (aEvt) {
					if (request.readyState == 4) {
						try {
							json = JSON.parse(request.responseText);
							window.location.href = json.$diagnoses[0].$links.$redirect.$url;
						} catch (ex) {
							document.getElementById('error-msg').textContent = ex.message || request.statusText;
							document.getElementById('password').value = "";
							document.getElementById('username').focus();
						}
					}
				};
				request.send(JSON.stringify({keepConnected: keepConnected, forgetme: true}));
			}
		}

		function redirect(url) {
			window.location = url;
		}
	</script>
</head>

<body>
	<div class="container">
		<div class="s-text-containt">
			<div class="s-text">
				<div class="s-product">
				<span class="s-m-brand">Sage</span>
				<span class="s-m-product">ERP X3</span>
                </div>
				<div class="z-error">
					<div id="error-msg">{{errorMessage}}</div>
				</div>
				<form id="loginForm">
				<div class="s-visibility-{{passwordVisibility}}">
					<div class="z-field">
						{{loggedAtLabel}} {{js$login}}
					</div>
					<div class="z-action">
						<a href="javascript:forgetme()">{{forgetMeLabel}}</a>
					</div>
					<hr>
					<div class="s-visibility-{{passwordVisibility}}">
						<div class="z-field">
							<input id="username"  autocomplete="on" onclick="javascript:askResign()" onkeypress="javascript:askResign()" placeholder="{{loginLabel}}" type="text">
						</div>
						<div class="z-field">
							<input id="password"  autocomplete="on" onclick="" placeholder="{{passwordLabel}}" type="password">
						</div>
						<div class="z-field" id="check" style="visbility:hidden">
							<input id="keepConnected"  autocomplete="on" type="checkbox" class="z-input-check">{{keepConnectedLabel}}
						</div>
						<div class="z-action s-visibility-{{basicVisibility}}">
							<a id="go-basic" href="javascript:authenticateAndForget('basic')">{{enterLabel}}</a>
						</div>
						<div class="z-action s-visibility-{{digestVisibility}}">
							<a id="go-digest"href="javascript:authenticateAndForget('digest')">{{enterLabel}}</a>
						</div>
						<div class="z-action s-visibility-{{ldapVisibility}}">
							<a id="go-ldap" href="javascript:authenticateAndForget('ldap')">{{enterLabel}}</a>
						</div>
						<input style="display:none;" onclick="javascript:authenticateAndForget(); return false;" type="submit"><!-- to capture enter key -->
					</div>
					<input style=" display:none;" onclick="javascript:redirect(params ? params.substring(8) : '/'); return false;" type="submit"><!-- enter key - reenter -->

				</div>
				</form>
			</div>

		</div>
	</div>
</body>
</html>