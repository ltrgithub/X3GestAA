"use strict";
var nodemailer = require('nodemailer');
var mustache = require('mustache');
var ez = require('ez-streams');
/// !doc
/// ## Writer mailer device
/// 
/// `var ezm = require("ez-mailer")`  
/// 
/// * `writer = ezm.writer(options)`  
///   creates a mailer device to which you can write mails. 
exports.writer = function(options) {
	var transport = nodemailer.createTransport(options);
	return ez.devices.generic.writer(function(_, message) {
		if (message === undefined) return;
		var msg = Object.create(message);
		
		if (message.attachments) msg.attachments = message.attachments.map(function(att) {
			if (typeof att.read !== "function") return att;
			// ez-streams reader
			var headers = att.headers;
			return {
				content: att.nodify(),
				contentType: headers && headers.contentType,
				encoding: headers && headers.encoding,
				filename: headers && headers.filename,
			};
		});
		return transport.sendMail(msg, ~_);
	});
};

/// * `writer = ezm.formatter(options)`  
///   returns a mustache mapper that applies a template to a mail message
exports.messageFormatter = function(options) {
	var fields = ['from', 'to', 'cc', 'bcc', 'replyTo', 'inReplyTo', 'reference', 'subject', 'html'];
	return function(_, message) {
		var result = fields.reduce(function(r, k) {
			if (options[k]) r[k] = mustache.render(options[k], message.view);
			return r;
		}, {});
		result.attachments = message.attachments || options.attachments;
		return result;
	};
};