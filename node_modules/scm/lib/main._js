var program = require('commander');
var path = require('path');

var config = require('config');
var patchGenerator = require('./patchGenerator');

program
	.version("0.1.0", '-v, --version')
	.option('-h, --displaySyncdHead', 'display last sync\'d head')
	.option('-H, --displayGitHead', 'display git current head')
	.option('-s, --synchronize', 'incremental synchronization')
	.option('-S, --fullSynchronize', 'force full synchronization (not incremental)')
	.option('-t, --test', 'test')
	.option('-w, --startWebServer', 'Start Web server')
	.parse(process.argv);

var t0 = Date.now();
if (program.displaySyncdHead) {
	var pg = patchGenerator.newGenerator(_, config.scm);
	console.log("Last sync'd sha1 = " + pg.getLastSyncdSha1(_));
} else if (program.synchronize) {
	var pg = patchGenerator.newGenerator(_, config.scm);
	pg.synchronize(_);
} else if (program.fullSynchronize) {
	var pg = patchGenerator.newGenerator(_, config.scm);
	pg.synchronize(_, {
		full: true
	});
} else if (program.displayGitHead) {
	var pg = patchGenerator.newGenerator(_, config.scm);
	console.log("Git head = " + pg.getGitHead(_).sha1);
} else if (program.test) {
	try {
		var pg = patchGenerator.newGenerator(_, config.scm);
		//		pg.generatePatches(_, ["meta/SUPERV/TABLES/AOBJTXT.json","meta/SUPERV/TABLES/AOBJTXT.ARCH.json"]);
		pg.generatePatches(_, ["D:/sources/Syracuse/node_modules/scm/test/server/resources/refJsonFiles/SCREENS/PTH1.json"], {
			activityCodes: ['ARCH']
		});
		/*		
		pg.resolveConflitcs(_, require("etna-etl/lib/entities/tables").entity,
			"C:\\user2\\test-metadata\\meta\\SUPERV\\TABLES\\ABANK.json", {
				skipMatching: true,
				skipSpecials: true,
				langage: "ENG",
			});
*/
	} catch (err) {
		console.log("ERROR " + err.message);
		console.log("ERROR " + err.stack);
	}
} else if (program.startWebServer) {
	require('./web/webserver');
	return;
} else
	program.help();

console.log("execution completed in " + Math.round((Date.now() - t0) / 1000) + " seconds");

// Temp hack to leave to time to ez-stream to flush the generated files. Should be removed ASAP
setTimeout(~_, 2000);
process.exit(0);
