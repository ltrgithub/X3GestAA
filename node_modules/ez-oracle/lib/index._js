"use strict";

var generic = require('ez-streams').devices.generic;

/// !doc
/// ## ez-streams wrapper for oracle
/// 
/// `var ezoracle = require('ez-oracle');`
/// 
module.exports = {
	/// * `reader = ezoracle.reader(cursor)`  
	reader: function(connection, sql, args, columnDefs) {
		// console.log(">>>>> " + sql);
		var rd = connection.reader(sql, args);
		return generic.reader(function(_) {
			var row = rd && rd.nextRow(~_);
			return row == null ? (rd = undefined) : row;
		});
	},


	/// * `writer = ezoracle.writer(statement)`  
	writer: function(connection, sql) {
		//console.log(">>>> SQL = " + sql);
		var statement = connection.prepare(sql);
		return generic.writer(function(_, row) {
			if (row === undefined) {
			//console.log(">>>>>>> END");
				statement = null; 
				return;
			} else if (statement) {
				var values = [];
				Object.keys(row).forEach(function(key)
				{
					values.push(row[key]);
				});
				//console.log("########### " + JSON.stringify(values));
				statement.execute(values, ~_);
			}
		});
	},
};