"use strict";
var config = require('config');
var ez = require('ez-streams');
var htmlTransforms = require('html-escape/lib/transforms');

var allowedTypes = config.upload && config.upload.allowedTypes;
if (!allowedTypes) {
	if (config.hosting && config.hosting.multiTenant) throw new Error("config.upload.allowedTypes not configured");
	else allowedTypes = /./;
}
if (!Array.isArray(allowedTypes)) allowedTypes = [allowedTypes];

exports.allowContentType = function(contentType) {
	return allowedTypes.some(function(re) {
		return re.test(contentType);
	});
}

function MediaTypeError(contentType) {
	Error.call(this);
	console.error("upload rejected: contentType=" + contentType);
	this.message = "unauthorized media type";
	this.$httpStatus = 415;
}

var mmm = require('mmmagic');
var magic = new mmm.Magic(mmm.MAGIC_MIME_TYPE);

exports.sanitizeReader = function(_, reader, contentType) {
	if (!exports.allowContentType(contentType)) throw new MediaTypeError(contentType);
	reader.setEncoding(null);
	reader = reader.peekable();
	var buf = reader.peek(_);
	var detected = magic.detect(buf, _);
	if (!exports.allowContentType(detected)) throw new MediaTypeError(detected);
	if (/html/i.test(contentType) || /html/i.test(detected)) {
		reader = reader.map(function(_, buf) {
			return buf.toString('binary');
		}).transform(htmlTransforms.escaper({
			preserve: true,
		}));
	}
	return reader;
}