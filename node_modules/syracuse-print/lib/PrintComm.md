
# PrintComm module

DO NOT USE THIS MODULE DIRECTLY !!!  
This documentation is only provided to understand the protocol layer !  

To interface with print server, please refer to [PrintClient module API](https://github.com/Sage-ERP-X3/Syracuse/blob/master/node_modules/syracuse-x3/lib/print/client/PrintClient.md "PrintClient module API").

---
#properties

Several nodes need to serialize/unserialize some properties.  
A property mustn't be greater than 250 characters and can be splitted by 4GL language like follow :  

	- Key/Value
    key1=\u0001value.........until 250 characters\n
    key1=\u0002complement\n
    key2=value2
    - or just Key
    key1\n
    key2\n


There two kind of properties: propeties1 and propeties2.  

##properties1  
Each property block contains:  
- **1-byte** : fixed: 0x00.  
- **4-bytes** : (Integer) corresponding to the property length.  

Each global properties must finish with :  
- **5-bytes** : fixed: 0x00, 0x00, 0x00, 0x00, 0x00  

##properties2  
Each property block contains:  
- **1-byte** : fixed: 0x00.  
- **4-bytes** : (Integer) corresponding to the property length.  

Each global properties must finish with :  
- **5-bytes** : fixed: 0x00, 0x00, 0x00, 0x00, 0x00  

## Connection / Disconnection

This chapter describes connection and disconnection sequences with Safe X3 print server component.

### Connection

Opening classic TCP/IP socket on 'server:port' with print server.  

---

1. **First step** : open session.  
  - Request 1 :  
     - **2-bytes** : fixed to identify connection type.  
  - Reply 1 :  
     - **4-bytes** : corresponding to the connection ID gave by the print server.  

---

1. **Second step** : Serialization of node ND_SLF (standard Adonix node) to communicate the client's type to the print server.  
  - Request 2 :  
        - **1-byte** : fixed: 0x00.  
        - **2-bytes** : for nodeId length equals to 2: 0x00, 0x02.  
        - **2-bytes** : for nodeId: 0x12, 0x0C.  
        - **N-bytes** : Serialization of [properties1](##properties1 "properties1") array with version informations (client technoVers).  
  - Reply 2 :  
        - **N-bytes** : Deserialization of [properties1](##properties1 "properties1") array with version informations (server technoVers).  

---
###Disconnection

Disconnection is effected for sending the sequence described below, without ack from the server.

---
- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-bytes** : for nodeId: 0x12, 0x63.  

---

##Reports interactions

The implementation of the operations of submission / followed progress / delete a print request server publishing results at 4 knots specific protocol presented below.  


###Node OUVIMP
Submitting a print request.  

---

- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-byte** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-byte** : for nodeId: 0x12, 0x01.  
 - Array of strings with print settings, encoded in utf8, structured in the form of N packets as follows:  
     - **1-byte** Length of the packet to be followed.  
     - **N-bytes** Corresponding to the packet to be followed.
     - **1-byte** After the last packet.  
     - **4-bytes** to zero corresponding to the end of reading the node
- Reply :  
 - **2-bytes** : The sequence number of the saved job by the print server (short coded in portable format standard). Beware the sequence number is valued at 0 if an error occur in the recording job.  

---

###Node DELETEREPORT
Forced stop a print request. No acknowledgment of the server after the sending of the request.  

---
- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-bytes** : for nodeId: 0x12, 0x7F.  
 - **1-byte** : corresponding to the lenght of the next Short: 0x02.
 - **2-bytes** : corresponding to the sequence number of the request to remove (short standard format). The sequence number corresponds to the value returned by the node NDOUVIMP.
 - **1-byte** : fixed: 0x00. 
- Reply :  
 - this node does not return a response.

---

###Node GETSTATEREPORT
Recovery of the current state of a request.  

---
- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-bytes** : for nodeId: 0x12, 0x7B.  
 - **1-byte** : corresponding to the length of the UTF-8 buffer containing the identifier of the job as alpha.  
 - **1-byte** : UTF-8 buffer containing the identifier of the job as alpha.  
-Reply :  
 - **2-bytes** : status code (Short standard format).  
 - **N-bytes** : UTF8 buffer corresponding to the error message or information associated with the status code, structured in the form of N packets as follows :  
     - **4-bytes** Length of the packet to be followed (Long Standard format).  
     - **N-bytes** Corresponding to the packet to be followed.  
     - **4-bytes** to zero corresponding to the end of reading the node  

---

###Node GETRESULTREPORT
Recovery of the result of a request.  

---
- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-bytes** : for nodeId: 0x12, 0x7C.  
 - **1-byte** : corresponding to the length of the UTF-8 buffer containing the identifier of the job as alpha.  
 - **1-byte** : UTF-8 buffer containing the identifier of the job as alpha.  
-Reply :  
 - **4-bytes** : overall size of the bitstream corresponding to the result of publishing (Long standard format).  
 - **N-bytes** : UTF8 buffer corresponding to the error message or information associated with the status code, structured in the form of N packets as follows :  
     - **4-bytes** Length of the packet to be followed (Long Standard format).  
     - **N-bytes** Corresponding to the packet to be followed.  
     - **4-bytes** to zero corresponding to the end of reading the node  

---

##Printer Descriptions
The implementation of the operations of selection / configuration of printers on a server publishing results at 5 knots specific protocol presented below.  
###Node ND_LIM
Retrieving the list of printers attached to a print server.  

---
- Request :  
 - **1-byte** : fixed: 0x00. 
 - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
 - **2-bytes** : for nodeId: 0x12, 0x0A.  
 - **N-bytes** : Serialization of [properties1](##properties1 "properties1") array.  
- Reply :  
 - **N-byte** : deserialization of [properties1](##properties1 "properties1") array containing the number of printers (first element) and the names of printers (subsequent occurrences).

---

###Node GET_ALLPRINTERS
Retrieving the list of printers and their standard properties.  

---

1. Marshalling :  

  - Request :  
     - **1-byte** : fixed: 0x00. 
     - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
     - **2-bytes** : for nodeId: 0x42, 0x01.  
  - Reply :  
      - **N-bytes** : structured in the form of N packets as follows:  
         - **4-byte** : length of response buffer to follow.  
         - **N-bytes** : corresponding bytes in buffer binary response.
      - **4-bytes** to zero corresponding after the last buffer response.  
    
---

2. Structuring binary buffer :  
We have this buffer generate for each printer send back from print server N times this buffer if N is the number of printers :  
  - 4-bytes : length of printer name (n1)  
  - n1-bytes : printer name  
  - 4-bytes : length of printer port (n2)  
  - n2-bytes : printer port  
  - 4-bytes : length of driver name (n3)  
  - n3-bytes : driver name  
  - 4-bytes : length of comment (n4)  
  - n4-bytes : comment  
  - 4-bytes : length of location (n5)  
  - n5-bytes : location  
  - 4-bytes : length of devmod (n6)  
  - n6-bytes : devmod  
  - 1-bytes : boolean identify capabilities : collate  
  - 1-bytes : boolean identify capabilities : copies  
  - 1-bytes : boolean identify capabilities : orientation  
  - 1-bytes : boolean identify capabilities : duplex  

---

###Node MORE_PRINTER
Recovery advanced settings for a particular printer.  

---

1. Marshalling :  

  - Request :  
     - **1-byte** : fixed: 0x00. 
     - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
     - **2-bytes** : for nodeId: 0x42, 0x03.  
     - **4-bytes** : Request buffer length to follow (length coded in portable format standard). The request buffer contains the identifier of the printer whose settings you want to retrieve (UCS-2 LE).  
     - **N-byte** : Buffer request.  
  - Reply :  
     - **4-bytes** : Binary buffer length to follow.  
     - **N-bytes** : corresponding to buffer response.  
    
---

2. Structuring binary buffer :  
We have this buffer generate for each printer send back from print server N times this buffer if N is the number of printers :  
  - Buffer request :  
    - **4-bytes** : buffer size (Int BE).    
    - **N-bytes** : buffer (printerName+"\n"+driver+"\n"+portName).  
  - Buffer response : 
    - **4-bytes** : full buffer size  
    - **8-bytes** : lenght of all papersize + id / 2 (64 + 4 * nb element). As the papersize and length is encoded in ucs2 it's in reality have this length 128+8* nb elem but it's not send devided by 2 by the server.  
    - **N * 8-bytes** : list of Id of papersize encoded in UCS2.  
    - **N * 128-bytes : list of value of papersize encoded in UCS2.  
    - **8-bytes** : lenght of all trays + id / 2 (24 + 4 * nb element). As the trays and length is encoded in ucs2 it's in reality have this length 48+8* nb elem but it's not send devided by 2 by the server.  
    - **N * 8-bytes** : list of Id of trays encoded in UCS2.  
    - **N * 48-bytes** : list of value of trays encoded in UCS2.  

---

###Node EXTRA_PRINTER
Recovery of additional options for a given printer, including the size (width / height) of a paper code.  

---

1. Marshalling :  

  - Request :  
     - **1-byte** : fixed: 0x00. 
     - **2-bytes** : (Short) for nodeId length equals to 2: 0x00, 0x02.  
     - **2-bytes** : for nodeId: 0x42, 0x04.  
     - **4-bytes** : Request buffer length to follow (length coded in portable format standard). The request buffer contains the identifier of the printer for which you want to recover the additional options, with the list of identifying options to retrieve (UCS-2 LE).  
     - **N-byte** : Buffer request.  
  - Reply :  
     - **4-bytes** : Binary buffer length to follow.  
     - **N-bytes** : corresponding to buffer response.  
    
---

2. Structuring binary buffer :  
We have this buffer generate for each printer send back from print server N times this buffer if N is the number of printers :  
  - Buffer request :  
    - **4-bytes** : buffer size (Int BE).  
    - **N-bytes** : buffer (printerName+"\n"+driver+"\n"+portName).  
    - **4-bytes** : corresponding to the Id of papersize.  
  - Buffer response : 
    - **4-bytes** : full buffer size  
    - **8-bytes** : corresponding to width and height of the paper.    

---

###Node PRIORITYREPORT (Not yet implemented)
Change priority of a job. At first it is not necessary to implement this node serialization on the server  node.js, because this functionality is built into the supervisor via PSIMP function (which should also be available in full Syracuse, as well as the function PSADX).  

---

###Node DISPLAYREPORT (Not yet implemented)
Dump the list of jobs stacked in the print server. 

---

Serialization of node ND_GFD (standard Adonix node) to ask 'SrvImpDispJobs' informations to the print server.  
  - Request :  
        - **1-byte** : fixed: 0x00.  
        - **2-bytes** : for nodeId length equals to 2: 0x00, 0x02.  
        - **2-bytes** : for nodeId: 0x12, 0x0B.  
        - **N-bytes** : Serialization of [properties1](##properties1 "properties1") array ['SrvImpDispJobs'].  
  - Reply :  
        - **N-bytes** : Deserialization of [properties1](##properties1 "properties1") array with jobs informations.  

---

