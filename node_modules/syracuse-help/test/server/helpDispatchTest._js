"use strict";
/* jshint -W079 */

/* global QUnit: false, ok: false, asyncTest: false, test: false, strictEqual: false, same: false, start: false, stop: false */

var baseUrl = "http://localhost:3004";
var port = 3004;
var helpers = require('syracuse-core/lib/helpers');
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var mongodb = require('streamline-mongodb');
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var streams = require('streamline/lib/streams/streams');
var forEachKey = helpers.object.forEachKey;

var tracer = console.log;
var application, contract, dataset;
//var tracer = null;

//force basic auth
config.session = config.session || {};
config.session.auth = "basic";
//no integration server
config.integrationServer = null;

adminTestFixtures.modifyCollaborationEndpoint("mongodb_admin_test");

var testData = require('syracuse-sdata/test/fixtures/testDB');
var testEndPoint = testData.endpoint;

testEndPoint.datasets = {
	test: {
		driver: "mongodb",
		database: "test",
		hostname: "localhost",
		port: 27017
	}
};

config.sdata.endpoints.push(testEndPoint);

var cookie;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(testEndPoint.datasets.test.hostname, testEndPoint.datasets.test.port, {});
	var db = adminTestFixtures.newMongoDb(testEndPoint.datasets.test.database, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	tracer("dropping admin db");
	server = new mongodb.Server(testEndPoint.datasets.test.hostname, testEndPoint.datasets.test.port, {});
	db = adminTestFixtures.newMongoDb("mongodb_admin_test", server, {});
	db = db.open(_);
	db.dropDatabase(_);
	ok(true, "mongodb initialized");

	start();
});

//start syracuse server
asyncTest("initialize syracuse test server", 1, function(_) {
	require('syracuse-main/lib/syracuse').startServers(_, port);
	ok(true, "server initialized");
	start();
});

function getCookie(_, otherBaseUrl, login, pass) {
	var response = new streams.httpRequest({
		url: otherBaseUrl != null ? otherBaseUrl + "/syracuse-main/html/main.html" : baseUrl + "/syracuse-main/html/main.html",
		user: login || "guest",
		password: pass || "guest"
	}).end().response(_);
	response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	return response.headers["set-cookie"];
}

function send(_, cookie, method, url, data, statusCode, step) {
	url = url.indexOf("http") === 0 ? url : baseUrl + "/sdata/qunit/sdataTest/test/" + url;
	var response = streams.httpRequest({
		method: method,
		url: url,
		headers: {
			"content-type": "application/json",
			cookie: cookie,
			accept: "application/json"
		}
	});

	if (data) {
		response = response.end(JSON.stringify(data)).response(_);
	} else {
		response = response.end().response(_);
	}

	if (statusCode && step) strictEqual(response.statusCode, statusCode, step + " OK");

	var content = response.readAll(_);
	var resp;
	try {
		resp = JSON.parse(content);
	} catch (e) {
		//tracer("Error while parsing: " + content);
	}
	if (response.statusCode !== (statusCode || 200)) {
		tracer("POST Request URL: " + url + "\nData: " + JSON.stringify(data, null, 2));
		tracer("Bad response: " + JSON.stringify(resp, null, 2));
	}
	return resp;
}


var appUuid = {}, endpointUuid = {};

function addApplication(_, cookie, url, application, contract) {

	var appBody;

	if (!appUuid[application]) {

		appBody = send(_, cookie, "get", url + "applications?sdataWhere=(application eq '" + application + "' and contract eq '" + contract + "')", null, 200, "Retrieve applications list");
		if (appBody.$resources && appBody.$resources[0] && appBody.$resources[0].$uuid) {
			appUuid[application] = appBody.$resources[0].$uuid;
		} else {
			// Create Application
			appBody = send(_, cookie, "post", url + "applications", {
				description: "SOAP Unit tests application for " + application.toUpperCase(),
				protocol: application !== "x3" ? "syracuse" : "x3",
				application: application,
				contract: contract
			}, 201, "Create application '" + application + "' for contract '" + contract + "'");
			//tracer("appBody="+JSON.stringify(appBody,null,2));
			appUuid[application] = appBody.$uuid;
		}
	}
}

function addEndpoint(_, cookie, url, application, contract, dataset) {

	var endpointBody;

	if (!endpointUuid[application]) {

		endpointBody = send(_, cookie, "get", url + "endPoints?sdataWhere=(application eq '" + application + "' and contract eq '" + contract + "' and dataset eq '" + dataset + "')", null, 200, "Retrieve endPoints list");
		if (endpointBody.$resources && endpointBody.$resources[0] && endpointBody.$resources[0].$uuid) {
			endpointUuid[application] = endpointBody.$resources[0].$uuid;
			ok(true, "Endpoint already exists");
		} else {
			var endPointData = {
				description: "SOAP Unit tests endpoint for " + application.toUpperCase(),
				application: application,
				contract: contract,
				dataset: dataset,
				enableSearch: false,
				databaseDriver: "mongodb",
				databaseHost: "localhost",
				databasePort: 27017,
				applicationRef: {
					$uuid: appUuid[application]
				}
			};

			// Create Endpoint
			endpointBody = send(_, cookie, "post", url + "endPoints", endPointData, 201, "Create endpoint for application '" + application + "', contract '" + contract + "' and dataset '" + dataset + "'");

			endpointUuid[application] = endpointBody.$uuid;
			ok(true, "Set Endpoint");
		}
	} else {
		ok(true, "Endpoint already set");
	}
}

function addProxyConf(_, cookie, url, name) {
	// Create Proxy configuration
	var confBody = send(_, cookie, "post", url + "proxyConfigurations", {
		name: name,
		host: "proxysage",
		port: 8080,
		auth: "ntlm",
		user: "tchambar",
		password: "Sage-2009",
		domain: "SAGEFR"
	}, 201, "Create proxy configuration '" + name + "'");
	var body = send(_, cookie, "get", url + "settings", null, 200, "Retrieve global settings list");
	var settingUuid = body.$resources[0].$uuid;
	send(_, cookie, "put", url + "settings('" + settingUuid + "')?representation=setting.$edit", {
		proxy: true,
		proxyConf: {
			$uuid: confBody.$uuid
		},
		$actions: {
			$save: {
				$isRequested: true
			}
		}
	}, 200, "Update globals settings with proxy configuration");
}

application = "qunit";
contract = "sdataTest";
dataset = "test";

asyncTest("strings", function(_) {
	try {
		var url = baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/";
		cookie = getCookie(_, baseUrl);
		addApplication(_, cookie, url, application, contract);
		addEndpoint(_, cookie, url, application, contract, dataset);
		addProxyConf(_, cookie, url, "proxyTest");


	} catch (e) {
		console.error(e.stack);
	}
	start();
});

asyncTest("GET French index.htm", function(_) {
	cookie = getCookie(_, baseUrl);
	send(_, cookie, "get", baseUrl + "/help/fr_FR/index.htm?format=text/html", null, 200, "Get online help main page");
	send(_, cookie, "get", baseUrl + "/help/fr_FR/ADXHelp_main.css", null, 200, "Get online help main CSS");
	send(_, cookie, "get", baseUrl + "/help/fr_FR/UNKNOW.htm", null, 500, "Get bad page");



	start();
});

test("stop  tests", 0, function() {
	doStop = true;
	start();
});