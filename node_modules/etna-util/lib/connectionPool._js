"use strict";

exports.create = function(db, trace) {
	if (db.driver !== "oracle") throw new Error("unsupported db driver: " + db.driver);

	var connections = [];

	return {
		withConnection: function(_, body) {
			var cnx = connections.pop();
			if (!cnx) {
				trace && trace("connecting ...");
				cnx = require(db.driver).connect(db, ~_);
				cnx.setPrefetchRowCount(1000);
			}
			try {
				return body(_, cnx);
			} finally {
				connections.push(cnx);
			}
		}
	};
};
