"use strict";

exports.create = function(db, trace) {
	var connections = [];
	var driver = require('etna-supervisor/lib/drivers/' + db.driver);

	return {
		withConnection: function(_, body) {
			var cnx = connections.pop();
			if (!cnx) {
				trace && trace("connecting ...");
				cnx = driver.connect(_, db);
			}
			try {
				return body(_, cnx);
			} finally {
				connections.push(cnx);
			}
		}
	};
};
