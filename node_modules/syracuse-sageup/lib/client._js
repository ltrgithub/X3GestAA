"use strict";

var util = require('util');
var jsxml = require('jsxml');
var httpClient = require('syracuse-httpclient/lib/httpClient');

exports.create = function(_, options) {

	options = options != null ? options : {};

	var debug = options.debug != null ? options.debug : false;
	var format = options.format != null ? options.format : 'xml';
	var auth = options.auth;
	var params = options.params;

	function log(prefix, value, type) {
		if (debug) {
			try {

				console.log("------------------------");
				if (type == 'xml') {
					console.log("- " + prefix + " = " + value);
				} else if (type == 'json') {
					console.log("- " + prefix + " = " + JSON.stringify(value, null, 2));
				} else {
					console.log("- " + prefix + " = " + util.inspect(value));
				}
			} catch (e) {
				console.log("An error has occured while logging:\n" + e.stack);
			}
		}
	}

	function genUrl(url) {
		function genParams() {
			var x = '';
			if (params != null) {
				if (url.indexOf('?') != -1) {
					x += '&';
				} else {
					x += '?';
				}
				x += Object.keys(params).map(function(val, id) {
					var res = '';
					if (id != 0) {
						res += '&';
					}
					res += val + '=' + params[val];
					return res;
				}).join('');
			}
			return x;
		}

		if (url.indexOf('http') != 0) {
			var protocol = options.protocol != null ? options.protocol + "://" : "http://";
			var host;
			if (options.host != null) {
				host = options.host;
			} else {
				throw new Error("request error: no host specified");
			}
			url = protocol + host + url + genParams();
		} else {
			url = url + genParams();
		}

		return url;
	}

	function execHttpRequest(_, method, url, data) {

		function genEntry(payload) {
			return '<?xml version="1.0" encoding="utf-8"?><entry xmlns:sdata="http://schemas.sage.com/sdata/2008/1">' + payload + '</entry>';
		}

		var opt = {
			method: method,
			url: genUrl(url),
			headers: {
				'Authorization': auth,
				'content-type': "application/atom+xml;type=entry"
			}
		};

		var request = httpClient.httpRequest(_, opt);
		if (data != null && (method === 'POST' || method === 'PUT')) {
			request.write(_, genEntry(data));
		}

		var resp = request.end().response(_);
		resp.setEncoding("utf8");
		var content = resp.readAll(_);

		if (format === 'json') content = jsxml.parse(content);

		try {
			log("Request method", opt.method);
			log("Request url", opt.url);
			log("Request header", opt.headers);
			log("Status Code", resp.statusCode);
			log("Header", resp.headers);
			log("Content", content, format);
		} catch (e) {
			console.log("error log=" + e.stack);
		}
		return {
			statusCode: resp.statusCode,
			header: resp.headers,
			body: content
		};
	}

	return {
		execHttpRequest: execHttpRequest
	};

};