"use strict"

var module = QUnit.module;
var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require("mongodb");
var sys = require("util");
var factory = require("syracuse-orm/lib/factory");
var parser = require('syracuse-sdata/lib/parser/parser');
//
var tracer = null;
var tracer = console.log;
//force basic auth
config.session = config.session || {};
config.session.auth = "basic";
config.session.ignoreStoreSession = true;

//add model
var endPoint = {
	contract: require("test-contract/lib/contract").contract,
	datasets: {
		mongodb_example: {
			driver: "mongodb",
			port: 27017
		}
	}
};
config.sdata.endpoints.push(endPoint);
endPoint.contract.datasets = endPoint.datasets;

var baseUrl = "http://localhost:3004"
var contractUrl = "/sdata/example/admin/mongodb_example/";
var port = 3004;
var syracuse = require('syracuse-main/lib/syracuse');
var streams = require('streamline/lib/streams/streams');
//
function _getModel() {
	return dataModel.make(endPoint.contract, "mongodb_example");
}
//
var doStop = false;
module("sdataFilterTest", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			//syracuse.server.close();
			setTimeout(function() {
				process.kill(process.pid);
			}, 100)
		}
	}
});

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endPoint.datasets["mongodb_example"].hostname, endPoint.datasets["mongodb_example"].port, {});
	var db = new mongodb.Db(endPoint.datasets["mongodb_example"].database, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	ok(true, "mongodb initialized");
	start();
});

asyncTest("sdata matches test", 18, function(_) {
	var db = dataModel.getOrm(_, _getModel(), endPoint.datasets.mongodb_example);
	// make a country
	var countryEntity = db.model.getEntity("country");
	var country = countryEntity.factory.createInstance(_, null, db);
	country.code(_, "FR");
	country.description(_, "France");
	strictEqual(country.code(_), "FR", "Country created ok");
	// simple conditions
	strictEqual(country.match(_, parser.Parser.parse("code eq 'FR'")), true, "Simple 'eq' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code eq 'US'")), false, "Simple 'eq' 2 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code ne 'FR'")), false, "Simple 'ne' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code ne 'US'")), true, "Simple 'ne' 2 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code lt 'FR'")), false, "Simple 'lt' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code le 'FR'")), true, "Simple 'le' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code lt 'FZ'")), true, "Simple 'lt' 2 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code gt 'FR'")), false, "Simple 'gt' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code ge 'FR'")), true, "Simple 'ge' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code gt 'FA'")), true, "Simple 'gt' 2 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code like 'F%'")), true, "Simple 'like' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code like '%F'")), false, "Simple 'like' 2 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code like '%F%'")), true, "Simple 'like' 3 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code like '%U%'")), false, "Simple 'like' 4 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code between 'FA' and 'FZ'")), true, "Simple 'between' 1 Ok");
	strictEqual(country.match(_, parser.Parser.parse("code between 'AA' and 'AZ'")), false, "Simple 'between' 2 Ok");
	// deep navigate conditions
	var addressEntity = db.model.getEntity("address");
	var address = addressEntity.factory.createInstance(_, null, db);
	address.country(_, country);
	var userEntity = db.model.getEntity("user");
	var user = userEntity.factory.createInstance(_, null, db);
	user.address(_, address);
	strictEqual(user.match(_, parser.Parser.parse("address.country.code eq 'FR'")), true, "Deep 'eq' 1 Ok");
	//
	start();
});

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
