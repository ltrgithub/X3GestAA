"use strict";

var httpHelper = require('syracuse-sdata/lib/httpHelper');
var sdata = require('syracuse-sdata/lib/sdataDispatch');

function fixRequest(request) {
	// convert url to a mobile1 URL.
	//request.url = '/mobile1/' + request.url.substring('/api1/'.length);
	request.$stateless = true;
	request.session.apiPrefix = 'api1';
	// X3 sends a 200 response with no data if we don't set the accept header, even on bad URLs!
	request.headers.accept = request.headers.accept || 'application/json';
}

exports.dispatcher = function(options) {
	options = options || {};

	var sdataDispatch = sdata.dispatcher(options);
	return function(_, request, response) {
		fixRequest(request);
		try {
			return sdataDispatch(_, request, response);
		} catch (ex) {
			console.error(ex.stack);
		}
	}
}