"use strict";
// JavaScript Document

function Monitor() {
  var startTick = new Date();
  var tick = startTick;
  console.log("start monitoring:"+tick);
  return function(_step) {
    var newTick =new Date(); 
    console.log(_step+':'+(newTick-tick)+':'+(newTick-startTick));
    tick = newTick;
  }
}
var monitor = new Monitor();

var path = require("path");
var fs   = require('fs');
var path    = require("path");
var config  = require(path.resolve("nodelocal.js")).config || {};
var tracer  = (config.jedi && config.jedi.debug)?config.jedi.debug:null;

monitor("require ez");
var ez   = require('ez-streams');

function swift(_,_root) {

  this.import = function(_,fileIn,fileOut)  {
    var src       = ez.devices.file.text.reader(fileIn);
    var dst       = ez.devices.file.text.writer(fileOut);

    var swiftBlocks = require(__dirname + "/swiftBlocks.json");
    var groups   = require(__dirname + "/mt940.json");
    var relbank  = require(__dirname + "/x3relbank.json");
    
    src.transform(ez.transforms.jedi.parser(swiftBlocks)) //
    .transform(ez.transforms.jedi.parser()) //
    //.transform(ez.transforms.jedi.group(groups)) //
    .transform(ez.transforms.json.formatter()) //
    .pipe(_, dst);
  }
}



var fileName = "FR00015077";

var path="./node_modules/ez-bank/test/fixtures/mt940/";
var fileIn  = path + fileName + ".txt";
var fileOut = path + fileName + ".json";

monitor("new swift");
var quicken = new swift(_,path);  
monitor("import before");
quicken.import(_,fileIn,fileOut);
monitor("import after");

