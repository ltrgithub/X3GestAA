"use strict";
// JavaScript Document
    /*var variants = {
     "$name":"PAYMUL",
     "$type":"application/x-variant",
     "$after":"'",
     "$select":"^(\\w*)+",
     "$variants":{
        "default":{
           "$type":"application/json",
           "$properties":{
              "data":{
                 "$type":"application/x-string"
              }
           }
        }
      }
    }*/

function Monitor() {
  var startTick = new Date();
  var tick = startTick;
  console.log("start monitoring:"+tick);
  return function(_step) {
    var newTick =new Date(); 
    console.log(_step+':'+(newTick-tick)+':'+(newTick-startTick));
    tick = newTick;
  }
}
var monitor = new Monitor();

var path = require("path");
var fs   = require('fs');

monitor("require ez");
var ez   = require('ez-streams');

function PAYMUL(_) {
  var transforms = [];
  transforms.push(ez.transforms.jedi.parser(require(__dirname + "/edi96a.json")));
  transforms.push(ez.transforms.jedi.group(require(__dirname + "/paymul.json")));
  transforms.push(ez.transforms.json.formatter());

  this.import = function(_,src,dst)  {
    var data = src;
      transforms.forEach_(_,function(_,transform) {
        data = data.transform(transform);
      });
      data.pipe(_, dst);
  }
}


var path="./node_modules/ez-bank/test/fixtures/paymul/";
var fileIn  = path + "tfs8908.txt";
var fileOut = path + "tfs8908.json";

monitor("new PAYMUL");
var engine = new PAYMUL(_);  
monitor("import before");
engine.import(_,ez.devices.file.text.reader(fileIn),ez.devices.file.text.writer(fileOut));
monitor("import after");

