"use strict";
// JavaScript Document

function Monitor() {
  function nanos(hr) {
    return hr[0] * 1e9 + hr[1];
  }

  var start = process.hrtime();

  return function(_step) {
      var diff = process.hrtime(start);
      console.log(_step+ " "+  (nanos(diff)/1e6) + "ms");

  }
}

var monitor = new Monitor();

var path = require("path");
var fs   = require('fs');

monitor("require ez");
var ez   = require('ez-streams');

function coda(_,_root) {

  this.formatter = function() {
  	return function(_, reader, writer) {
  	  var first =true;
      writer.write(_,"<!DOCTYPE html><html><body><table>\r\n");
      
      reader.forEach(_, function(_, relbank) {
        var line;
        if(first) {
          first = false;
          line = "<tr>";
          Object.keys(relbank[Object.keys(relbank)[0]]).forEach(function(property) {
            line += "<th>"+property+"</th>"
           }); 
          line += "</tr>\r\n"; 
          writer.write(_,line);  
        }
        line = "<tr>";
        Object.keys(relbank[Object.keys(relbank)[0]]).forEach(function(property) {
          line += "<td>"+relbank[Object.keys(relbank)[0]][property]+"</td>"
         }); 
        line += "</tr>\r\n"; 
        writer.write(_,line);          
      });
      writer.write(_,"</table></body</html>\r\n"); 	
  	};
  }

  this.import = function(_,fileIn,fileOut)  {
    var src       = ez.devices.file.text.reader(fileIn);
    var dst       = ez.devices.file.text.writer(fileOut);

    var variants = require(__dirname + "/coda.json");
    var groups   = require(__dirname + "/codaGroups.json");
    var relbank  = require(__dirname + "/x3relbank.json");
    var mapX3    = require(__dirname + "/coda_2_relbank.json");
 
    src.transform(ez.transforms.jedi.parser(variants)) //
    .transform(ez.transforms.jedi.group(groups)) //
    //.map(ez.transforms.jedi.map(mapX3,relbank)) //
    .transform(ez.transforms.json.formatter()) //
    .pipe(_, dst);
    //.transform(this.formatter())
  }
}


var path="./node_modules/ez-bank/test/fixtures/coda/";
var fileIn  = path + "coda2_ing-2.txt";
var fileOut = path + "RELBANK-coda2_ing-2.json";

monitor("new coda");
var quicken = new coda(_,path);  
monitor("import before");
quicken.import(_,fileIn,fileOut);
monitor("import after");

