"use strict";
// JavaScript Document

function Monitor() {
  var startTick = new Date();
  var tick = startTick;
  console.log("start monitoring:"+tick);
  return function(_step) {
    var newTick =new Date(); 
    console.log(_step+':'+(newTick-tick)+':'+(newTick-startTick));
    tick = newTick;
  }
}
var monitor = new Monitor();

var path = require("path");
var fs   = require('fs');
var path    = require("path");
var config  = require(path.resolve("nodelocal.js")).config || {};
var tracer  = (config.jedi && config.jedi.debug)?config.jedi.debug:null;

monitor("require ez");
var ez   = require('ez-streams');

function mt940(_,_root) {

  this.import = function(_,fileIn,fileOut)  {
    var src       = ez.devices.file.text.reader(fileIn);
    var dst       = ez.devices.file.text.writer(fileOut);

    var variants = require(__dirname + "/swift.json");
    var groups   = require(__dirname + "/mt940.json");
    var relbank  = require(__dirname + "/x3relbank.json");
    //var mapX3    = require(__dirname + "/mt940_2_relbank.json");
 
    src.transform(ez.transforms.jedi.parser(variants)) //
    .transform(ez.transforms.jedi.group(groups)) //
    //.map(ez.transforms.jedi.map(mapX3,relbank)) //
    .transform(ez.transforms.json.formatter()) //
    .pipe(_, dst);
    //.transform(this.formatter())
  }
}



var fileName = "mt940";
//var fileName = "mt940-2";
//var fileName = "FR00016830";

var path="./node_modules/ez-bank/test/fixtures/mt940/";
var fileIn  = path + fileName + ".txt";
var fileOut = path + fileName + ".json";

monitor("new mt940");
var quicken = new mt940(_,path);  
monitor("import before");
quicken.import(_,fileIn,fileOut);
monitor("import after");

