"use strict";
// JavaScript Document

function Monitor() {
  var startTick = new Date();
  var tick = startTick;
  console.log("start monitoring:"+tick);
  return function(_step) {
    var newTick =new Date(); 
    console.log(_step+':'+(newTick-tick)+':'+(newTick-startTick));
    tick = newTick;
  }
}
var monitor = new Monitor();

var path = require("path");
var fs   = require('fs');

monitor("require ez");
var ez   = require('ez-streams');

function convert() {
  return function(_,reader,writer) {
    var script="";
    reader.some(_, function(_, chunk) {
      if(chunk) {
        script+=chunk;
        return false;
      }
      return true;
    });
    script = script.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"")
    .replace(/(?:\/{2}.*)/g,"")
    .replace(/(structure\s*)(\w*)(\s*)\{([^}]*)\}/g, '"$2":{\r\n\t"$type": "application/json",\r\n\t"$properties": {\r\n$4\t}\r\n},')
    .replace(/function[^}]*\}/g,"")
    .replace(/^\s*\r\n/gm,"")
    .replace(/(m_ctl\s*=\s*\w*\(\s*\w*\s*\);)/g,"")
    .replace(/field\s*=\s*(\w*)\s*as\s*\w*\s*(\()([^)]*)(\))/g,'"$1":{\r\n\t$3}')
    .replace(/\s*typ\s*=\s*VARIABLE\s*;/g,"")
    .replace(/des\s*=\s*"([^"]*)";/g, '\t"$description":"$1",')
    .replace(/esc = _EDI_ESCAPE_CHAR_;/g,'\t"$escape":"?",')
    .replace(/esc\s*=\s*\"(\?|\w*)\";/g,'\t"$escape":"$1",')
    .replace(/saf\s*=\s*EDI_WSAF;/g,"\t\"$after\":\"'\",")
    .replace(/saf\s*=\s*EDI_SAF;/g,"\t\"$after\":\"'\",")
    .replace(/saf = "(\S+)",OPTIONAL;/g, '\t"$after":["$1",null],')
    .replace(/len\s*=\s*(\d*)\s*;/g,'\t"$length":$1,')
    .replace(/def\s*=\s*\"(\w*)\"\s*;/g,'\t"$default":"$1",')
    .replace(/,\s*\}\s*;/g,'},')
    .replace(/pre\s*=\s*OPTIONAL;/g,'\t"$optional":true,')
    .replace(/struct\s*=\s*(\w*)\s*as\s*(\w*)\s*;/g , '"$1":{"$model": "$2"},')
    .replace(/(\}\s*,\s*\})/g,"}}");
    
    var edi96a = {
      $name: "PAYMUL",
      $type: "application/x-variant",
      $after: "'",
      $select: "^(\\w*)+",
      $variants : JSON.parse('{'+script.substring(0,script.length-2)+'}')
    };

    var regex = new RegExp(/\w\d{1,4}/);
    Object.keys(edi96a.$variants).forEach(function(variant) {
      console.log("variant:"+variant);  
      if(edi96a.$variants[variant].$properties) {
        Object.keys(edi96a.$variants[variant].$properties)
          .filter(function(key){return (key.substring(0,1) == '$') })
          .forEach(function(property) {
          console.log("property:"+variant+"."+property + "="+!regex.test(variant) +","+(["$escape","$after"].indexOf(property) >= 0)); 
          if(!((["$escape","$after"].indexOf(property) >= 0) && (!regex.test(variant)))) {
            console.log("keep:"+property); 
            edi96a.$variants[variant][property] = edi96a.$variants[variant].$properties[property];
          }
          delete edi96a.$variants[variant].$properties[property];
       });
      }
    });
  
    writer.write(_,JSON.stringify(edi96a,null, "\t"));
    //writer.write(_,'{'+script.substring(0,script.length-2)+'}');
  }
}
    
var src       = ez.devices.file.text.reader("./node_modules/ez-bank/misc/EDI96A.cli");
var dst       = ez.devices.file.text.writer("./node_modules/ez-bank/misc/EDI96A.json");
monitor("start");
src.transform(convert()).pipe(_, dst);
monitor("stop");

