"use strict";
var http = require('http');
var fs = require('fs');
var net = require('net');
var qs = require('querystring');

var tracer = console.error;

function createCtiServer(port, cb) {
	var connections = {};
	var server = net.createServer(function(socket) {
		socket.setNoDelay(true);
		socket.name = socket.remoteAddress + ":" + socket.remotePort;
		tracer && tracer("[>>>] CONNECT " + socket.name);
		connections[socket.name] = socket;

		socket.on('data', function(data) {
			tracer && tracer("[>>>] DATA " + data);
		});

		socket.on('close', function(hadError) {
			tracer && tracer("[>>>] CLOSE hadError=" + hadError);
		});

		socket.on('error', function(e) {
			tracer && tracer("[>>>] ERROR " + e.message);
			// cleanUpSocketContext(socket);
			socket.destroy();
		});
	}).listen(port, function(err) { //'listening' listener
		if (err) return cb && cb(err);
		tracer && tracer("Cti server bound to " + port);
	});

	return {
		connections: function() {
			return Object.keys(connections).map(function(k) {
				return connections[k];
			});
		},
		broadcast: function broadcast(data) {
			Object.keys(connections).forEach(function(k) {
				var s = connections[k];
				tracer && tracer("[<<<] write '" + data + "' to " + s.name);
				s.write(data);
			});
		}
	};
}

exports.start = function(cb, port) {
	var ctiserver = createCtiServer(8118);

	var server = http.createServer(function(req, res) {

		if (req.method == 'POST') {
			var body = '';
			req.on('data', function(data) {
				body += data;
			});
			req.on('end', function() {
				var json = qs.parse(body);
				var ctiId = json.ctiId;
				var phonenumber = json.phonenumber;
				var html = 'Sending: ' + phonenumber + ' with ' + ctiId + ' to ' + ctiserver.connections().length + ' clients.<br>' +
					'<a href="/">Try again.</a>';
				res.end(html);

				var data = {
					name: "callIn",
					data: {
						tel: phonenumber,
						ctiId: ctiId
					}
				};
				ctiserver.broadcast(JSON.stringify(data) + "\0");
			});
			res.writeHead(200, {
				'Content-Type': 'text/html'
			});
		} else {
			var html = '<form action="/" method="post">' +
				'Cti Id:' +
				'<input type="text" name="ctiId" value="12345" placeholder="..." />' +
				'<br>' +
				'Phone number:' +
				'<input type="text" name="phonenumber" value="+33450193530" placeholder="..." />' +
				'<br><br>' +
				'<button type="submit">Submit</button>' +
				'</form>';
			res.writeHead(200, {
				'Content-Type': 'text/html'
			});
			res.end(html);
		}

	});

	port = port || 8033;
	var host = 'localhost';
	server.listen(port, host);
	tracer && tracer('Listening at http://' + host + ':' + port);
};