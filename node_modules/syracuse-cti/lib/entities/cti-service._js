"use strict";
var ez = require('ez-streams');

var ctiServiceManager = require("syracuse-cti/lib/ctiServiceManager").ctiServiceManager;

module.exports = {
	$titleTemplate: "CTI service {name}",
	$valueTemplate: "{name}",
	$summaryTemplate: "CTI service {name}",
	$descriptionTemplate: "CTI service",
	$className: "CtiService",
	$canCreate: true,
	$helpPage: "Administration-reference_CTI-Service",
	$properties: {
		name: {
			$title: "CTI service name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		connector: {
			$title: "Connector",
			$isMandatory: true,
			$default: "isi-com",
			$enum: [{
					$value: "isi-com",
					$title: "ISI-COM"
				}
				// , {
				// 	$value: "asterix",
				// 	$title: "Asterix"
				// }
			],
		},
		host: {
			$title: "CTI server hostname",
			$isHidden: function(_, instance) {
				return instance.connector(_) !== "isi-com";
			}
		},
		port: {
			$title: "CTI server port",
			$type: "integer",
			$isHidden: function(_, instance) {
				return instance.connector(_) !== "isi-com";
			}
		},
		serverUrl: {
			$title: "CTI server URL",
			$isHidden: function(_, instance) {
				return instance.connector(_) !== "asterix";
			}
		},
		defaultCountryCallingCode: {
			$title: "CTI default calling code",
			$type: "integer",
			$isHidden: function(_, instance) {
				return instance.connector(_) !== "isi-com";
			}
		},
		// username: {
		// 	$title: "CTI username",
		// },
		// password: {
		// 	$title: "CTI password",
		// },
		// phoneExtention: {
		// 	$title: "Phone extension",
		// },
	},
	$relations: {},
	$functions: {
		getConnectionString: function(_) {
			if (this.connector(_) === "isi-com")
				return "socket:" + this.host(_) + ":" + this.port(_);
			if (this.connector(_) === "asterix")
				return this.serverUrl(_);
		}
	},
	$services: {
		showData: {
			$method: "GET",
			// $isMethod: true,
			$title: "Show Data",
			$execute: function(_, context, instance, parameters) {
				// console.error("showData: " + JSON.stringify(parameters));
				ctiServiceManager.showData(parameters.ctiId, parameters.tel);
				context.reply(_, 200, "ok");
			}
		},
		makeCall: {
			$method: "GET",
			// $isMethod: true,
			$title: "Make call",
			$execute: function(_, context, instance, parameters) {
				// console.error("makeCall: " + JSON.stringify(parameters));
				ctiServiceManager.makeCall(parameters.ctiId, parameters.tel);
				context.reply(_, 200, "ok");
			}
		},
	},
	$searchIndex: {
		$fields: ["name"]
	},
	$defaultOrder: [
		["name", true]
	]
};