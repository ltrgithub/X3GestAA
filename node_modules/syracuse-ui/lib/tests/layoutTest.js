"use strict";
var helpers = require("syracuse-core/lib/helpers");
var TestPage = require("syracuse-ui/lib/tests/testPage").TestPage;

function LayoutTest() {}

exports.LayoutTest = helpers.defineClass(LayoutTest, TestPage, {
	loadBox: function(initData) {
		syra_site.deltaManager.applyObjectDelta(this, this.$prototype.$properties, {
			$field$isHidden: {
				$type: "application/x-boolean",
				$title: "$isHidden",
				$isMetaData: true
			},
			$field$hideMaxClose: {
				$type: "application/x-boolean",
				$title: "hide $isMaximizable and $isCloseable",
				$isMetaData: true
			},
			$field$hideTitleCollapse: {
				$type: "application/x-boolean",
				$title: "hide $isTitleHidden and $isBoxCollapsable",
				$isMetaData: true
			},
			$field$isTitleHidden: {
				$type: "application/x-boolean",
				$title: "$isTitleHidden",
				$isMetaData: true
			},
			$field$isBoxCollapsable: {
				$type: "application/x-boolean",
				$title: "$isBoxCollapsable",
				$isMetaData: true
			},
			$field$isCloseable: {
				$type: "application/x-boolean",
				$title: "$isCloseable ",
				$isMetaData: true
			},
			$field$isMaximizable: {
				$type: "application/x-boolean",
				$title: "$isMaximizable ",
				$isMetaData: true
			}
		}, true);
		this.$prototype.$actions = this.$prototype.$properties || {};
		this.$prototype.$actions.$singlediagnose = {
			"$title": "single diagnose",
			delta: {
				"xarray": [{
					"$uuid": "record0",
					"$index": 0,
					"$properties": {
						"xstring": {
							"$diagnoses": [{
								"$severity": "error",
								"$message": "Error test  blalfoz"
							}]
						}
					}
				}]
			}
		};
		this.$item.$layout = {
			"$items": [{
				"$layoutType": "row",
				"$items": [{
					"$bind": "$field$isHidden",
					"$isEditMode": true
				}, {
					"$bind": "$field$hideMaxClose",
					"$isEditMode": true
				}, {
					"$bind": "$field$hideTitleCollapse",
					"$isEditMode": true
				}, {
					"$category": "link",
					"$bind": "$singlediagnose"
				}]
			}, {
				"$layoutType": "stack",
				"$items": [{
					"$layoutType": "row",
					"$items": [{
						"$category": "section",
						"$test": true,
						"$skin": "s-h1",
						"$title": "s-h1",
						"$layout": {
							"$layoutType": "stack",
							"$items": [{
								"$category": "section",
								"$test": true,
								"$title": "s-h2",
								"$skin": "s-h2",
								"$layout": {
									"$layoutType": "row",
									"$items": [{
										"$bind": "$field$isMaximizable",
										"$isEditMode": true
									}, {
										"$bind": "$field$isCloseable",
										"$isEditMode": true
									}]
								}
							}, {
								"$category": "section",
								"$test": true,
								"$title": "s-h2",
								"$skin": "s-h2",
								"$layout": {
									"$items": [{
										"$category": "section",
										"$test": true,
										"$title": "s-h3",
										"$skin": "s-h3",
										"$layout": {
											"$items": [{
												"$bind": "$field$isMaximizable",
												"$isEditMode": true
											}, {
												"$bind": "$field$isCloseable",
												"$isEditMode": true
											}, {
												"$bind": "$field$isTitleHidden",
												"$isEditMode": true
											}, {
												"$bind": "$field$isBoxCollapsable",
												"$isEditMode": true
											}]
										}
									}, {
										"$category": "section",
										"$test": true,
										"$title": "s-h3",
										"$skin": "s-h3",
										"$layout": {
											"$items": [{
												"$category": "section",
												"$test": true,
												"$title": "s-h4",
												"$skin": "s-h4",
												"$layout": {
													"$items": [{
														"$bind": "$field$isMaximizable",
														"$isEditMode": true
													}, {
														"$bind": "$field$isCloseable",
														"$isEditMode": true
													}, {
														"$bind": "$field$isTitleHidden",
														"$isEditMode": true
													}, {
														"$bind": "$field$isBoxCollapsable",
														"$isEditMode": true
													}]
												}
											}]
										}
									}]
								}
							}]
						}
					}, {
						"$layoutType": "tabs",
						"$items": [{
							"$category": "section",
							"$test": true,
							"$skin": "s-h1",
							"$title": "s-h1",
							"$layout": {
								"$layoutType": "tabs",
								"$items": [{
									"$category": "section",
									"$test": true,
									"$title": "s-h2",
									"$skin": "s-h2",
									"$layout": {
										"$layoutType": "tabs",
										"$items": [{
											"$category": "section",
											"$test": true,
											"$title": "s-h3",
											"$skin": "s-h3",
											"$layout": {
												"$layoutType": "tabs",
												"$items": [{
													"$category": "section",
													"$test": true,
													"$title": "s-h4",
													"$skin": "s-h4",
													"$layout": {
														"$layoutType": "row",
														"$items": [{
															"$bind": "$field$isTitleHidden",
															"$isEditMode": true
														}, {
															"$bind": "$field$isBoxCollapsable",
															"$isEditMode": true
														}]
													}
												}]
											}
										}, {
											"$category": "section",
											"$test": true,
											"$title": "s-h3",
											"$skin": "s-h3",
											"$layout": {
												"$items": [{
													"$bind": "$field$isTitleHidden",
													"$isEditMode": true
												}, {
													"$bind": "$field$isBoxCollapsable",
													"$isEditMode": true
												}]
											}
										}]
									}
								}, {
									"$category": "section",
									"$test": true,
									"$title": "s-h2",
									"$skin": "s-h2",
									"$layout": {
										"$layoutType": "row",
										"$items": [{
											"$bind": "$field$isMaximizable",
											"$isEditMode": true
										}, {
											"$bind": "$field$isCloseable",
											"$isEditMode": true
										}, {
											"$bind": "$field$isTitleHidden",
											"$isEditMode": true
										}, {
											"$bind": "$field$isBoxCollapsable",
											"$isEditMode": true
										}]
									}
								}]
							}
						}, {
							"$category": "section",
							"$test": true,
							"$skin": "s-h1",
							"$title": "s-h1",
							"$layout": {
								"$layoutType": "tabs",
								"$items": [{
									"$category": "section",
									"$test": true,
									"$title": "s-h2",
									"$skin": "s-h2",
									"$layout": {
										"$layoutType": "row",
										"$items": [{
											"$bind": "$field$isMaximizable",
											"$isEditMode": true
										}, {
											"$bind": "$field$isCloseable",
											"$isEditMode": true
										}, {
											"$bind": "$field$isTitleHidden",
											"$isEditMode": true
										}, {
											"$bind": "$field$isBoxCollapsable",
											"$isEditMode": true
										}]
									}
								}, {
									"$category": "section",
									"$test": true,
									"$title": "s-h2",
									"$skin": "s-h2",
									"$layout": {
										"$items": [{
											"$category": "section",
											"$test": true,
											"$title": "s-h3",
											"$skin": "s-h3",
											"$layout": {
												"$items": [{
													"$bind": "$field$isMaximizable",
													"$isEditMode": true
												}, {
													"$bind": "$field$isCloseable",
													"$isEditMode": true
												}, {
													"$bind": "$field$isTitleHidden",
													"$isEditMode": true
												}, {
													"$bind": "$field$isBoxCollapsable",
													"$isEditMode": true
												}]
											}
										}, {
											"$category": "section",
											"$test": true,
											"$title": "s-h3",
											"$skin": "s-h3",
											"$layout": {
												"$items": [{
													"$category": "section",
													"$test": true,
													"$title": "s-h4",
													"$skin": "s-h4",
													"$layout": {
														"$items": [{
															"$bind": "$field$isMaximizable",
															"$isEditMode": true
														}, {
															"$bind": "$field$isCloseable",
															"$isEditMode": true
														}, {
															"$bind": "$field$isTitleHidden",
															"$isEditMode": true
														}, {
															"$bind": "$field$isBoxCollapsable",
															"$isEditMode": true
														}]
													}
												}]
											}
										}]
									}
								}]
							}
						}]
					}]
				}]
			}, {
				"$layoutType": "row",
				"$items": [{
					"$category": "block",
					"$test": true,
					"$skin": "s-ldp-h2",
					"$title": "s-ldp-h2",
					"$layout": {
						"$layoutType": "row",
						"$items": [{
							"$bind": "$field$isMaximizable",
							"$isEditMode": true
						}, {
							"$bind": "$field$isCloseable",
							"$isEditMode": true
						}]
					}
				}]
			}]
		};
		TestPage.prototype.loadBox.call(this, initData);
		this.applyChange({
			$field$isBoxCollapsable: true,
			$field$isCloseable: true,
			$field$isMaximizable: true
		});
	},
	notifyDataChange: function(field, value) {
		var self = this;
		if (field.$item.$bind.indexOf("$field") == 0) {
			var metaData = {};
			metaData[field.$item.$bind] = value;
			this.applyChange(metaData);
		}
	},
	notifyActionChange: function(menuItem, target, value) {
		if (value.$singlediagnose) {
			var metaData = {};
			var $binds = Object.keys(this.$prototype.$properties);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				metaData[$binds[ii]] = {
					"$diagnoses": [{
						"$severity": "error",
						"$message": "Error test  blalfoz"
					}]
				};
			}
			this.applyChange({
				$properties: metaData
			});
			return false;
		}
		TestPage.prototype.notifyActionChange.call(this, menuItem, target, value);
	},
	applyChange: function(newData) {
		if (newData) {
			var self = this;
			var $keys = Object.keys(newData);
			for (var ii = 0, jj = $keys.length; ii < jj; ii++) {
				var $key = $keys[ii];
				if ($key.indexOf("$field") == 0) {
					var $bind = $key.replace("$field", "");
					var metaData = {};
					metaData[$bind] = newData[$key];
					switch ($bind) {
						case "$hideTitleCollapse":
							["$field$isBoxCollapsable", "$field$isTitleHidden"].map(function($bind) {
								var bounds = self.boundFields[$bind];
								for (var ii = 0, jj = bounds.length; ii < jj; ii++) {
									bounds[ii].applyDesignMetaData({
										$isHidden: newData[$key]
									}, true);
								}
							});
							break;
						case "$hideMaxClose":
							["$field$isMaximizable", "$field$isCloseable"].map(function($bind) {
								var bounds = self.boundFields[$bind];
								for (var ii = 0, jj = bounds.length; ii < jj; ii++) {
									bounds[ii].applyDesignMetaData({
										$isHidden: newData[$key]
									}, true);
								}
							});
							break;
						default:
							Object.keys(self.idMap).forEach(function(id) {
								var box = self.idMap[id];
								if (box.$item.$test) {
									box.applyDesignMetaData(metaData, true);
								}
							});
							break;
					}

				}
			}
		}
		TestPage.prototype.applyChange.call(this, newData);
	}
});