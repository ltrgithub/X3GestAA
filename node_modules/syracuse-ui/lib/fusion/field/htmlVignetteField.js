"use strict";
var helpers = require('syracuse-core/lib/helpers');
var JSXml = require('jsxml/lib/jsxml');
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var VignetteField = require('syracuse-ui/lib/page/landing/vignette/field/htmlVignetteField');


function HTMLField() {}
exports.HTMLVignetteField = helpers.defineClass(HTMLField, VignetteField.HTMLVignetteField, {
	setFocus: function() {
		return true;
	},
	isDirty: function(value, record, metaData, $bind) {
		return false;
	}
});


function DHTMLField() {}
exports.DHTMLVignetteField = helpers.defineClass(DHTMLField, HTMLField, {
	setDataBind: function(value, record, meta) {
		var jsonX, urlParams;
		try {
			if ((jsonX = JSXml.parse(value))) {
				// At time we just support first url
				if ((urlParams = jsonX.DESC && jsonX.DESC.URL)) {
					urlParams = Array.isArray(urlParams) ? urlParams[0] : urlParams;
					VignetteField.HTMLVignetteField.prototype.setDataBind.call(this, this._getFullUrl(urlParams.ADR, urlParams.TAD), record, meta);
				}
			}
		} catch (e) {}
	},
	_getFullUrl: function buildUrl(url, type) {
		var fusionSess, $fusionController;
		switch (type) {
			case "ABS":
				return url;
			case "PUB":
			case "DOS":
				$fusionController = syraUtil.getFusionController(this),
				fusionSess = $fusionController ? $fusionController.getSession() : null;
				return fusionSess ? fusionSess.getAppServerHttpQuery(type == "PUB", url, {
					"url": true
				}) : "about:blank";
			case "LOC":
				return "";
			default:
				return url;
		}
	}
});