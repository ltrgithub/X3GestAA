"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DesktopList = require("syracuse-ui/lib/field/array/list").DesktopList;
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util');
var jQuery = $;
//-----------------------------------------------
// GridSyra
//-----------------------------------------------
function ListGrid(){
    // Last selected Id returned by X3
    this._mySelSyraId = null;
}

exports.ListGrid = helpers.defineClass(ListGrid, DesktopList, {
    createBuilder: function(){
        this.$item.$isQuickDesignerEnabled = false;
        this.$item.$isMenuRecordHidden = true
        DesktopList.prototype.createBuilder.call(this);
    },
    resize: function(height){
        if (this.$$container) 
            this.$$container.height(height);
    },
    drawBox: function(){
        DesktopList.prototype.drawBox.call(this);
        if (this.getPage().fusionBar) {
            this.getPage().fusionBar.addLeftList(this);
        }
    },
    applyMetaData: function(metaData){
        if (!metaData) 
            return;
        var stts = metaData.stt, self = this;
        if (stts) {
            // stts [[x3id,x3Idx,gui],[x3id,x3Idx,gui]]
            var records = [];
            this._mySelSyraId = null;
            jQuery.each(stts, function(i, stt){
                if (stt.length > 2) {
                    var syraId = parseInt(stt[1], 10) - 1, gui = sapUtil.Fusion.getState(stt[2]);
                    if (gui.$isSelected != null) {
                        self._store.selector.select(syraId, gui.$isSelected)
                        if (gui.$isSelected) {
                            self._mySelSyraId = syraId + "";
                        }
                    }
                }
            })
        }
    },
    _isMulti: function(){
        return this.$item.$selectMode != "row";
    },
    beforeTrigger: function(evt, options){
        if (!options || !evt || !options.data) 
            return false;
        if (evt == "wdgt.list.selline") {
            if (sapUtil.fixtureMode(this)) {
                // We let Syra widget manage the event
                if (options.data.doEvent) 
                    options.data.doEvent();
                return false;
            }
            else 
                if (!this._isMulti()) {
                    // unselect current selected line to informe user that action has been taken into account
                    var selLine = (parseInt(options.data.line, 10) - 1) + "";
                    // check selLine to not unselect a line already selected
                    if (this._mySelSyraId != null && selLine != this._mySelSyraId && this.dataset[this._mySelSyraId]) {
                        this._store.selector.select(this._mySelSyraId, false);
                    }
                    // Continue process - SendX3Action - Selection will be done by X3 reply
                    return true;
                }
        }
        return true;
    },
    getQuickSelValues: function(){
        return this._store.filterCapability.filterRecord.fusionGetInputValues();
    },
    getIst: function(nl){
        return sapUtil.Fusion.makeIst(this.getPage().$fusionPageMeta.winModel.getWinId(), this.$item.$bind, nl === true && this._mySelSyraId != null ? parseInt(this._mySelSyraId, 10) : null);
    }
});
