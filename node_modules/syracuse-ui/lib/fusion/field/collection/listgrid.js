"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DesktopHgridBuilder = require('syracuse-ui/lib/desktop/field/collection/builder/hgridBuilder').Builder;
var FusionDesktopList = require("syracuse-ui/lib/fusion/field/collection/grid").Grid;
var FusionGridBuilder = require("syracuse-ui/lib/fusion/field/collection/gridBuilder").Builder;
var FGridRec = require("syracuse-ui/lib/fusion/field/collection/gridRecord").GridRecord;
var DesktopList = require("syracuse-ui/lib/desktop/field/collection/list").DesktopList;
var util = require('syracuse-ui/lib/fusion/tools/utilFdb');
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util');
var jQuery = $;
//-----------------------------------------------
// _hack
//-----------------------------------------------
function _hack(){
    var site = document.site;
    if (site) {
        // FDB
        site.$$body.css({
            "overflow-x": "auto",
            "overflow-y": "scroll"
        })
    }
}

function _onSelectRecord(grd, selectedRecords){
    var idx = [];
    _.each(selectedRecords, function(rec){
        idx.push({
            "$uuid": rec.dataset.$uuid,
            "$recordIndex": rec.$recordIndex
        });
    });
    util.logObj({
        len: idx.length,
        records: idx
    }, "page.onSelectRecord");
}

//-----------------------------------------------
// GridRec
//-----------------------------------------------
function GridRec(){
}

var MyGridRec = helpers.defineClass(GridRec, FGridRec, {
    onClick: function(ev, $$elmt){
        this._selectLine(ev);
    },
    _selectLine: function(ev){
        var doEvt = true, self = this, elmt = $(ev.target);
        var isMulti = self.boxParent.$item.$selectMode == "multi";
        var line = elmt.closest('.s-grid-line-fusion');
        var scroll = line.closest(".s-grid-content-fusion").children('.s-grid-scroll-fusion:first');
        var scrollSel = scroll.find("." + _LSEL);
        var clicIdx = self.$recordIndex;
        if (isMulti) {
            line.addClass(_LSEL);
        }
        else {
            scrollSel.removeClass(_LSEL);
        }
        self.getPage().externalAdapter.onListSelectLine({
            list: self.boxParent,
            line: clicIdx + 1,
            forceDoEvt: sapUtil.fixtureMode(self),
            xid: self.boxParent.$item.$bind,
            // stt [[x3id,x3Idx,gui],[x3id,x3Idx,gui]]
            doEvent: function(){
                if (sapUtil.fixtureMode(self)) {
                    var stts = null;
                    if (isMulti) {
                        if (scrollSel.length > 2) {
                            stts = [];
                            var gui = sapUtil.Fusion.getNumStatus({
                                selected: false
                            });
                            scrollSel.each(function(i, e){
                                i = parseInt(e.dataset.sRecord, 10)
                                if (i != clicIdx) {
                                    stts.push(["", i + 1, gui]);
                                }
                            })
                        }
                    }
                    else {
                        stts = [["", clicIdx + 1, sapUtil.Fusion.getNumStatus({
                            selected: true
                        })]]
                    }
                    if (stts) {
                        self.boxParent.doMeta({
                            stt: stts
                        });
                    }
                }
            }
        });
    }
});
function FBFusionDesktopList(){
    _hack();
}

var _LCSS = ".s-grid-line-fusion";
var _LSEL = "fselect";
exports.FBFusionDesktopList = helpers.defineClass(FBFusionDesktopList, FusionDesktopList, {
    createBuilder: function(){
        if (!this.$item.$X3) 
            this.$item.$X3 = {};
        this.$item.$X3.$hideLineNumber = true;
        this.BuilderClass = FBFusionGridBuilder;
        this.RecordClass = MyGridRec;
        FusionDesktopList.prototype.createBuilder.call(this);
    },
    addToFusionBar: function(){
        this.getPage().fusionBar.addLeftList(this);
    },
    resize: function(height){
        if (this.$$item) {
            this.$$item.height(height);
            var pageH = this._pager ? this._pager._$$item.outerHeight() : 0;
            var headH = this._$$header ? this._$$header.outerHeight() : 0;
            var scrollH = this._$$scroller ? this._$$scroller.outerHeight() : 0;
            var bodyH = height - pageH - headH - scrollH;
            this.builder.resize(bodyH);
        }
    },
    setDataBind: function($resources, record, metaData){
        if ($resources) {
            FusionDesktopList.prototype.setDataBind.call(this, $resources, record, null);
        }
        this.doMeta(metaData);
    },
    doMeta: function(metaData){
        if (!metaData) 
            return;
        var stts = metaData.stt;
        util.log("LGrid.doMeta");
        if (stts) {
            // stts [[x3id,x3Idx,gui],[x3id,x3Idx,gui]]
            var list = this._$$body.children('.s-grid-scroll-fusion:first')[0];
            jQuery.each(stts, function(i, stt){
                if (stt.length > 2) {
                    var x3Idx = stt[1], gui = sapUtil.Fusion.getState(stt[2]);
                    util.log("\tx3Idx[" + x3Idx + "] - Select[" + gui.$isSelected + "]");
                    if (x3Idx <= list.childNodes.length) {
                        var itm = $(list.childNodes[x3Idx - 1]);
                        if (gui.$isSelected) {
                            itm.addClass(_LSEL);
                        }
                        else {
                            itm.removeClass(_LSEL);
                        }
                    }
                }
            })
        }
    }
});
function FBFusionGridBuilder(){
}

var FBFusionGridBuilder = helpers.defineClass(FBFusionGridBuilder, FusionGridBuilder, {
    resize: function(height){
        if (height <= 0) 
            return;
        var lineH = this.size("lineHight");
        var nbLines = parseInt(height / lineH, 10);
        util.log("nbLines:" + nbLines + " - lineHight:" + lineH);
        this.changeLineCount(nbLines);
    },
    removeRows: function(){
        if (this.rowsOrder && this.rowsOrder.length > 0) 
            FusionGridBuilder.prototype.removeRows.call(this);
    },
    drawBuilder: function(){
        FusionGridBuilder.prototype.drawBuilder.call(this);
        this.list.addToFusionBar();
    }
});



//-----------------------------------------------
// GridSyra - Temporaire pour test liste gauches avec filtre et tri
//-----------------------------------------------
function FBSyraDesktopList(){

}

exports.FBSyraDesktopList = helpers.defineClass(FBSyraDesktopList, DesktopList, {
    setDataBind: function($resources, record, metaData){
        // FDB - Invertion ordre 
        DesktopList.prototype.setDataBind.call(this, $resources, record, undefined);
        if (metaData) {
            DesktopList.prototype.setDataBind.call(this, undefined, undefined, metaData);
            this.doMeta(metaData);
        }
    },
    createBuilder: function(){
        this.$item.$isQuickDesignerEnabled = false;
        this.$item.$isMenuRecordHidden = true
        this.builder = new GridSyra();
        this.builder.list = this;
        this.builder.initialize();
    },
    resize: function(height){
        util.log("FBSyraDesktopList - Resize[" + height + "]");
        if (this.$$item) 
            this.$$item.height(height);
    },
    addLeftList: function(){
        this.getPage().fusionBar.addLeftList(this);
    },
    drawBox: function(){
        DesktopList.prototype.drawBox.call(this);
        this.addLeftList();
    },
    _selectRecords: function(records, selId){
        util.log("FBSyraDesktopList - _selectRecords");
        util.logObj(records);
        var doEvt = true, self = this;
        var isMulti = self.recordSelector.$selectMode == "multi";
        var clicIdx = parseInt(selId, 10);
        if (!isMulti) {
            jQuery.each(records, function(i, r){
                r.sel = false;
            });
        }
        DesktopList.prototype._selectRecords.call(this, records, selId);
        self.getPage().externalAdapter.onListSelectLine({
            list: self,
            line: clicIdx + 1,
            forceDoEvt: sapUtil.fixtureMode(self),
            xid: self.$item.$bind,
            // stt [[x3id,x3Idx,gui],[x3id,x3Idx,gui]]
            doEvent: function(){
                util.log("\tX3 REPLY");
                if (sapUtil.fixtureMode(self)) {
                    var stts = null;
                    if (isMulti) {
                        if (records.length > 2) {
                            stts = [];
                            var gui = sapUtil.Fusion.getNumStatus({
                                selected: false
                            });
                            $.each(records, function(i, r){
                                i = parseInt(r.id, 10)
                                if (i != clicIdx) {
                                    stts.push(["", i + 1, gui]);
                                }
                            })
                        }
                    }
                    else {
                        stts = [["", clicIdx + 1, sapUtil.Fusion.getNumStatus({
                            selected: true
                        })]]
                    }
                    if (stts) {
                        self.doMeta({
                            stt: stts
                        });
                    }
                }
            }
        });
    },
    doMeta: function(metaData){
        if (!metaData) 
            return;
        var stts = metaData.stt, self = this;
        util.log("FBSyraDesktopList - doMeta");
        if (stts) {
            // stts [[x3id,x3Idx,gui],[x3id,x3Idx,gui]]
            var records = [];
            jQuery.each(stts, function(i, stt){
                if (stt.length > 2) {
                    var x3Idx = stt[1], gui = sapUtil.Fusion.getState(stt[2]);
                    util.log("\tx3Idx[" + x3Idx + "] - Select[" + gui.$isSelected + "]");
                    self._selectRecord(x3Idx - 1, gui.$isSelected)
                }
            })
        }
    }
});

function GridSyra(){
    util.log("GridSyra");
}

helpers.defineClass(GridSyra, DesktopHgridBuilder, {    /*initialize: function(){
     SBuilder.prototype.initialize.call(this);
     jQuery.extend(this.list, {
     resize: function(height){
     util.log("Resize LeftList[" + height + "]");
     if (this.$$item)
     this.$$item.height(height);
     },
     addLeftList: function(){
     this.getPage().fusionBar.addLeftList(this);
     }
     });
     },*/
    /*    drawBuilder: function(){
     SBuilder.prototype.drawBuilder.call(this);
     this.list.addLeftList();
     }*/
});

