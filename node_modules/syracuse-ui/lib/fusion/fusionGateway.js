"use strict";
var helpers = require('syracuse-core/lib/helpers');
var FusionSite = require('syracuse-ui/lib/fusion/core/client/inplace').FusionSite;
var WorkBook = require('./workBook').WorkBook;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var util = require('syracuse-ui/lib/fusion/tools/util');
var filterMaker = require('syracuse-ui/lib/fusion/core/tools/filterMaker');
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;

var _keyHook = [keys["VK_TAB"], keys["VK_ENTER"], 73];

var _messageCodes = ["3", "4", "5", "8", "9", "12", "13", "14", "16", "19", "20", "21", "23"];

function FusionGateway() {

}

exports.FusionGateway = helpers.defineClass(FusionGateway, null, {
	getMessage: function(code) {
		var mess = syra_local["fusion_" + code];
		if (mess && _messageCodes.indexOf(code) >= 0) {
			mess += "\n" + syra_local.fusion_18;
		}
		if (!mess) {
			mess = "***localized message unknown***";
		}
		return mess || _unknow;
	},
	initialize: function() {
		this.defLang = "en-US";
		this._books = [];
		this.filterMaker = filterMaker;
	},
	onWindowBeforeUnload: function(event) {
		if (this._books && this._books.length > 0) {
			return syra_local.disconnect_convergence_unload.replace("{booksNb}", this._books.length);
		}
	},
	_promptOnUserProfileChange: function(reason, cbckContinue, cbckCancel) {
		if (this._books && this._books.length) {
			var mess, options = {};
			var prefLocal = "onuserprofilechange_";
			if (reason == "logout") {
				mess = syra_local[prefLocal + reason];
				options.$title = syra_local[prefLocal + "title" + reason];
			} else {
				if (!reason || !(mess = syra_local[prefLocal + reason])) {
					mess = syra_local[prefLocal + "defaultmess"];
				}
				mess += ("\n" + syra_local[prefLocal + "mark"]);
				options.$title = syra_local[prefLocal + "title"];
			}
			mess += ("\n" + String.fromCharCode(1) + "\n" + syra_local[prefLocal + "confirm"]);
			options.$message = mess;
			options.$type = "warning";
			options.$buttons = "yesno";
			options.$isAutoClose = 40000;
			options.$default = "yes";
			options.callback = function(response, closedBy) {
				var close = closedBy == "yes" || closedBy == "auto";
				if (!close) {
					syra_site.siteFunctions.toggleTopPanel(false);
					if (cbckCancel) {
						cbckCancel();
					}
				} else {
					cbckContinue();
				}
				return true;
			};
			syra_diagnose.showBox(options);
		} else {
			cbckContinue();
		}
	},
	onUserActionUnload: function(callback, cancelCallback, reason, noPrompt) {
		var self = this;
		if (!noPrompt) {
			self._promptOnUserProfileChange(reason, function() {
				self._onUserActionUnloadEx(callback, cancelCallback);
			}, cancelCallback);
		} else {
			self._onUserActionUnloadEx(callback, cancelCallback);
		}
	},
	_onUserActionUnloadEx: function(callback, cancelCallback) {
		var self = this;

		function promptUser(diag, client, clientRef, cbck) {
			var options = {};
			options.$message = diag.message || diag.$message || syra_local.disconnect_userunload_msg;
			options.$type = "warning";
			options.$buttons = "okcancel";
			options.$isAutoClose = 25000;
			options.$default = "ok";
			options.$title = diag.$title || syra_local.disconnect_userunload_title;
			options.callback = function(response, closedBy) {
				var close = closedBy == "ok" || closedBy == "auto";
				if (!close) {
					syra_site.siteFunctions.toggleTopPanel(false);
					self.activateBook(clientRef);
					if (cancelCallback) {
						cancelCallback();
					}
				}
				setTimeout(function() {
					cbck(close);
				}, 5);
				return true;
			};
			syra_diagnose.showBox(options);
		}

		function notifyHoster(diag, client, clientRef, cbck) {
			if ((diag.severity || diag.$severity) !== "success") {
				promptUser(diag, client, clientRef, cbck);
			} else {
				callback();
			}
		}
		if (self._books && self._books.length) {
			// check if there is an ongoing dialogue between client and server
			// yes -> can't proceed. show alert message
			// no -> proceed (see below)
			self.detachAllBooks(notifyHoster, false, false, true);
		} else {
			callback();
		}
	},
	updateRequestTimer: function() {
		var self = this;

		function notifyHoster(diag, client, clientRef) {
			if ((diag.severity || diag.$severity) !== "success") {
				//debugger; // severity is supposed to be success, cause detach has been forced
			} else {
				setTimeout(function() {
					syra_site.showDiagnoses({
						$diagnoses: [{
							$severity: "info",
							$message: syra_local.disconnect_timeout_info
						}]
					});
				}, 1000);
			}
		}
		// maintain session by sending a useless request to server
		function callbackConfirm() {
			syra_controller.sendRequest(null, {
				$location: {
					$url: "/sdata/syracuse/collaboration/syracuse/sessionInfos?representation=sessionInfo.$query&count=1"
				}
			}, function(data) {});
		}
		// convergence sessions will be closed and you will head back to syracuse 
		function callbackCancel() {
			//TODO
			self.detachAllBooks(notifyHoster, true, true, false);
		}

		if (self._books && self._books.length > 0) {
			var delay = 180000; // 3 minutes
			var timeout = syra_site.userProfile.getServerSessionTimeOut && (syra_site.userProfile.getServerSessionTimeOut() - delay) || 120000; // 2 minutes default
			// if negative
			timeout = timeout <= 0 ? 120000 : timeout;

			// clear any previous ongoing timeout
			clearTimeout(self.serverTimeOutHandler);

			// run timer
			self.serverTimeOutHandler = setTimeout(function() {
				if (self.canDetachBooks()) {
					syra_diagnose.showBox({
						$message: syra_local.disconnect_timeout_msg,
						$type: "warning",
						$buttons: "yesno",
						$isAutoClose: 25000,
						$default: "no",
						$title: syra_local.disconnect_timeout_title,
						callback: function(response, closedBy) {
							var close = closedBy == "yes";
							if (!close) {
								callbackCancel();
							} else {
								callbackConfirm();
							}
							return true;
						}
					});
				} else {
					callbackConfirm();
				}
			}, timeout);

		} else {
			clearTimeout(self.serverTimeOutHandler);
		}
	},

	onKeyDow: function(event) {
		var $fusionPageMeta, doEvt, isGrid = false,
			winId, logger;
		if (!_.include(_keyHook, event.keyCode)) {
			return true;
		}
		// Are we on an active fusion sheet currently displayed
		$fusionPageMeta = this.activatedBook && this.activatedBook.selectedSheet ? syraUtil.getFusionPageMeta(this.activatedBook.selectedSheet) : null;
		winId = $fusionPageMeta && $fusionPageMeta.controller.isSapActiveWindow($fusionPageMeta.winModel.getWinId()) ? $fusionPageMeta.winModel.getWinId() : null;
		if ($fusionPageMeta && !syra_diagnose.getOpenedBox() && winId && this.activatedBook.selectedSheet.domItem && $(this.activatedBook.selectedSheet.domItem).is(":visible")) {
			if ((logger = $fusionPageMeta.controller ? $fusionPageMeta.controller.getLogger() : null)) {
				logger.trace({}, "**onGatewayEvent : [" + event.type + "] for " + $fusionPageMeta.winModel.syraModel.getTitle());
			}
			doEvt = $fusionPageMeta.winModel.onWinEvent(event, $fusionPageMeta.controller);
			if (doEvt != undefined && !doEvt) {
				event.stopPropagation();
			}
		}
		return doEvt;
	},
	openMainPage: function(openerUrlSegments) {
		openerUrlSegments.$url = syra_site.urlMaker.addHost(openerUrlSegments.$url);
		this.openBook(openerUrlSegments);
	},
	findBookById: function(id) {
		var found;
		for (var ii = 0; ii < this._books.length; ii++) {
			if (this._books[ii].id == id) {
				found = {
					book: this._books[ii],
					index: ii
				};
				break;
			}
		}
		return found;
	},
	openBook: function(openerUrlSegments) {
		/* if (this._books && this._books.length > 0) {
         this.activateBook(this._books[0]);
         var session = this._books[0].fusionSite.controller.getSession();
         syra_diagnose.showBox({
         $type: "info",
         $title: session.getlabel("text", 202, "Activity management"),
         $message: session.getlabel("text", 203, " Please, close this activity before opening another"),
         });
         return;
         }*/
		var self = this;
		var book = new WorkBook();
		this.activateBook(book);
		book.openerUrlSegments = openerUrlSegments;
		book.fusionGateway = self;
		if (syra_site.mainPage) {
			book.openeropenerUrlSegments = syra_site.mainPage.openerUrlSegments;
		}
		book.id = helpers.uuid.generate();
		self._books.push(book);
		(book.fusionSite = new FusionSite()).create(book.id, {
			instance: book,
			controller: syra_controller,
			site: syra_site
		}, null);
		book.fusionSite.connect(openerUrlSegments, function(metaData, navigate) {
			if (metaData) {
				syra_site.showDiagnoses({
					$diagnoses: metaData.$diagnoses
				});
			}
			self.closeBook(book, !navigate);
		});
	},
	showSiteFusionHeader: function(show) {
		var site = syra_site;
		var link, i, len, exoLinks = ["homeLink", "navigationLink"];
		if (!show) {
			site.siteFunctions.closeSearchFieldPopup();
		}
		site.fusionHeaderFunctionLink && site.fusionHeaderFunctionLink.showItem(show);
		site.fusionHeaderHomeLink && site.fusionHeaderHomeLink.showItem(show);

		for (i = 0, len = exoLinks.length; i < len; i++) {
			if ((link = site[exoLinks[i]]))
				link.domItem.style.display = show ? "none" : "";
		}
		site.siteFunctions.showSearcher(show);
	},
	getActivatedSheet: function() {
		return this.activatedBook && this.activatedBook.selectedSheet;
	},
	closeBook: function(book, noNavigation) {
		if (this.activatedBook == book) {
			this.activatedBook = null;
		}
		var openeropenerUrlSegments = book.openeropenerUrlSegments;
		var found = this.findBookById(book.id);
		if (found) {
			this._books.splice(found.index, 1);
		}
		book.dispose();

		this.showSiteFusionHeader(false);

		if (!noNavigation) {
			if (openeropenerUrlSegments) {
				syra_site.history.load(openeropenerUrlSegments.$url);
			} else {
				syra_menus.gotoHome();
			}
		}
	},
	activateBook: function(book) {
		if (this.activatedBook) {
			if (this.activatedBook != book) {
				this.activatedBook.onActivate(false);
				this.activatedBook = book;
				book.onActivate(true);
			}
		} else {
			this.activatedBook = book;
		}
		book.selectSheet();
	},
	canDetachBooks: function() {
		// In order to prevent Convergence client from detaching books on timeout while pending long polling
		var i, len, pendingSess = false;
		for (i = 0, len = this._books.length; i < len; i++) {
			if (this._books[i].fusionSite.isRequestPending()) {
				pendingSess = true;
				break;
			}
		}
		return !pendingSess;
	},
	detachAllBooksPanic: function() {
		var len = (this._books && this._books.length) || 0;
		if (len > 0) {
			var tabSid = [],
				nieme, masterBookCtrl, strgSid = null;
			for (var ii = 0; ii < len; ii++) {
				if ((nieme = this._books[ii]) && (nieme = nieme.fusionSite) && (nieme = nieme.sid)) {
					tabSid.push("&sid_" + ii + "=" + nieme);
				}
			}
			if (tabSid.length > 1) {
				tabSid.splice(0, 1);
				strgSid = tabSid.join("");
			}
			if ((masterBookCtrl = this._books[0].fusionSite.controller)) {
				masterBookCtrl.delSapSessExPanic(strgSid);
			}
		}
	},
	detachAllBooks: function(notifyHoster, timeout, force, noNavigateOnClose, opts) {
		var i, len, tabSid = [],
			tabClt = [],
			curr = 0,
			max = 0,
			svrtSuccess = "success",
			diagOk = util.makeDiagnosis("", svrtSuccess, null, "39");
		for (i = 0, len = this._books.length; i < len; i++) {
			tabClt[i] = {
				"cltRef": this._books[i]
			};
			if (this._books[i] && this._books[i].fusionSite && this._books[i].fusionSite.sid) {
				tabSid.push(this._books[i].fusionSite.sid);
			}
		}
		max = tabClt.length;
		if (opts && opts.panic && max > 0) {
			// Massive close on panic!
			if (tabSid.length > 1) {
				tabSid.splice(0, 1);
			} else {
				tabSid = null;
			}
			tabClt[0].cltRef.fusionSite.emergencyCltClose("detachAllBooksPanic", tabSid);
			//notifyHoster(diagOk);     //Not necessary... because panic!
			return;
		}

		function release() {
			for (i = 0; i < max; i++) {
				delete tabClt[i].cltRef;
			}
		}

		function walkDetach(diagnosis, hardDetach) {
			var currErr, forceEx = hardDetach !== null && hardDetach !== undefined ? hardDetach : force;
			if ((diagnosis.severity || diagnosis.$severity) == svrtSuccess) {
				if (curr == max) {
					release();
					notifyHoster(diagnosis);
				} else {
					tabClt[curr++].cltRef.fusionSite.disconnect(walkDetach, timeout, forceEx, noNavigateOnClose);
				}
			} else {
				currErr = curr - 1;
				notifyHoster(diagnosis, currErr, tabClt[currErr].cltRef, function(forceDetach) {
					if (forceDetach) {
						curr = currErr;
						walkDetach(diagOk, true);
					} else {
						release();
					}
				});
			}
		}
		if (max > 0) {
			walkDetach(diagOk);
		} else {
			notifyHoster(util.makeDiagnosis("", svrtSuccess, null, "0"));
		}
	},
	dispose: function() {
		delete this.activatedBook;
		this._books.forEach(function(book) {
			book.dispose();
		});
		this._books = this.filterMaker = null;
	}
});