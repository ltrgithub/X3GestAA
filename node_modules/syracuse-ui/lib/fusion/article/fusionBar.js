"use strict";
var helpers = require('syracuse-core/lib/helpers');
var BarSplitter = require("syracuse-ui/lib/page/utility/barSplitter").BarSplitter;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;

function FusionBar() {}

exports.FusionBar = helpers.defineClass(FusionBar, BarSplitter, {
	load: function(page, $fusionBar) {
		this.options = {
			resizeDirection: {
				right: true
			},
			$skins: {
				bar: "s-fusion-bar",
				openerPicker: "s-fusion-bar-opener",
				resizeBar: "s-fusion-bar-resizer"
			}
		};
		var preferences = document.site.ensurePreferences() || {};
		if (!preferences.convergenceBar) {
			preferences.convergenceBar = {
				isDocked: true,
				isCollapsed: false
			};
		};
		this.preferences = preferences.convergenceBar;

		this._barSlot = document.createElement("div");
		this._barSlot.className = "s-fusion-bar-slot";

		this._barBody = document.createElement("div");
		this._barBody.className = "s-fusion-bar-body";
		this.$fusionBar = $fusionBar;
		page.$$item.prepend(this._barSlot);
		BarSplitter.prototype.load.call(this, page, null, this._barSlot, this._barBody);
	},
	onBarBodyAdded: function() {
		var count = this.$fusionBar.$items.length;
		this.blocks = [];
		for (var ii = 0; ii < count; ii++) {
			this.blocks.push(this.createBlock(this.$fusionBar.$items[ii], ii, count));
		}
		if (!this.openedBlock && count > 0) {
			this.collapseBlock(this.blocks[0], true, null, true);
		}
	},
	onClickPicker: function(picker, event) {
		switch (picker.getAttribute("data-s-picker")) {
			case "s-bar-title":
				this.collapseBlock(this._findBlock($(event.target)), true);
				this.ensureState();
				document.site.resize();
				break;
			default:
				BarSplitter.prototype.onClickPicker.call(this, picker, event);
				break;
		}
	},
	createBlock: function($item, index, count) {
		var block = {
			boxParent: this,
			index: index,
			id: helpers.uuid.generate(),
			$item: $item
		};
		var fusionSess = (syraUtil.getFusionController(this.page)).getSession();
		$item.$XID = $item.$XID || $item.$bind;
		$item.$title = $item.$title || this.page.$prototype.$properties[$item.$bind].$title;

		var blockItem = document.createElement("section");
		blockItem.className = "s-fusion-block";
		blockItem.setAttribute("id", block.id);
		blockItem.setAttribute("data-s-block", block.index);
		block.$$item = $(blockItem);

		var title = document.createElement("a");
		title.setAttribute("data-s-picker", "s-bar-title");
		title.className = "s-fusion-bar-block-title";
		var $title = $item.$title || "";
		if ($title.length > 0 && $title[1] == "@") {
			$title = this.page.renderExpression($title);
		}
		title.textContent = $title;

		var dom = document.createElement("div");
		dom.className = "s-fusion-block-body";
		block.$$body = $(dom);

		dom = document.createElement("header");
		dom.className = "s-fusion-block-header";
		dom.appendChild(title);
		block.$$header = $(dom);

		block.$$item.append(block.$$header).append(block.$$body);
		this._barBody.appendChild(blockItem);
		return block;
	},
	collapseBlock: function(block, show, isFirstTime, onDrawBar) {
		var self = this;
		self.page.externalAdapter.onBoxToggle({
			box: block,
			open: show,
			onDrawParent: onDrawBar,
			isFirstTime: !block.islistLoaded,
			doEvent: function() {
				if (show && self.openedBlock && (self.openedBlock != block)) {
					self.collapseBlock(self.openedBlock, false);
				}
				self.openedBlock = block;
				block.$$body[0].style.display = show ? "" : "none";
				block.$$header.toggleClass("s-open", show);
				block.$$item.toggleClass("s-open", show);
				if (show) {
					if (!block.islistLoaded) {
						block.islistLoaded = true;
						block.$item.$isTitleHidden = true;
						if (self.page.$prototype.$properties[block.$item.$bind].$type == "application/x-array") {
							block.$item.$isNavigationList = true;
						}
						block.leftList = self.page.loadNewItem(block.$$body.empty()[0], block.$item);
					}
					self.onWindowResize();
				} else {
					block.$$item[0].style.height = "";
				}
			}
		});
	},
	_findBlock: function($$target) {
		var index = parseInt($$target.closest("[data-s-block]").attr("data-s-block"), 10);
		return this.blocks[index];
	},
	_onResizeBody: function() {
		if (this.openedBlock) {
			var blockHeight = 0;
			for (var ii = 0, jj = this.blocks.length; ii < jj; ii++) {
				var block = this.blocks[ii];
				if (block != this.openedBlock) {
					blockHeight += block.$$item.outerHeight(true);
				}
			}
			blockHeight = this._barBody.clientHeight - blockHeight;
			this.openedBlock.$$item[0].style.height = blockHeight + "px";
			this.openedBlock.$$body.height(this.openedBlock.$$item.height() - this.openedBlock.$$header.outerHeight(true));
			if (this.openedBlock.leftList) {
				this.openedBlock.leftList.resize(this.openedBlock.$$body.height());
			}
		}
	},
	getArticle: function() {
		return this.page.getArticle();
	},
	dispose: function() {
		if (this.blocks) {
			for (var ii = 0, jj = this.blocks.length; ii < jj; ii++) {
				delete this.blocks[ii].leftList;
			}
			delete this.blocks;
		}
		this.$fusionBar = null;
		BarSplitter.prototype.dispose.call(this);
	}
});