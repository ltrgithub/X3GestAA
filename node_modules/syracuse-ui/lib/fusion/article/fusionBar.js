"use strict";
var helpers = require('syracuse-core/lib/helpers');
var SideBar = require("syracuse-ui/lib/page/aside/sideBar").SideBar;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;

function FusionBar() {}

exports.FusionBar = helpers.defineClass(FusionBar, SideBar, {
	load: function(page, $fusionBar) {
		this.minWidth = 300;
		this.userPreferenceKey = "convergenceBar";
		this.options = {
			resizeDirection: "left",
			$skin: "s-fusion-bar"
		};
		if (syra_site.isTabletDevice) {
			this.options.isAutoModeDisabled = true;
			this.options.$viewMode = "float";
		}

		this.slot = document.createElement("div");
		this.slot.className = "s-fusion-bar-slot";
		this.body = document.createElement("div");
		this.body.className = "s-fusion-bar-body";
		this.$fusionBar = $fusionBar;
		page.domItem.insertBefore(this.slot, page.domItem.firstChild);
		SideBar.prototype.load.call(this, page);
		var count = this.$fusionBar.$items.length;
		this.blocks = [];
		for (var ii = 0; ii < count; ii++) {
			this.blocks.push(this.createBlock(this.$fusionBar.$items[ii], ii, count));
		}
		if (!this.openedBlock && count > 0) {
			this.collapseBlock(this.blocks[0], true, true);
		}
	},

	createBlock: function($item, index, count) {
		var block = {
			boxParent: this,
			index: index,
			id: helpers.uuid.generate(),
			$item: $item
		};
		var fusionSess = (syraUtil.getFusionController(this.page)).getSession();
		$item.$XID = $item.$XID || $item.$bind;
		$item.$title = $item.$title || this.page.$prototype.$properties[$item.$bind].$title;

		block.domItem = document.createElement("section");
		block.domItem.className = "s-fusion-block";
		block.domItem.id = block.id;

		var $title = $item.$title || "";
		if ($title.length > 0 && $title[1] == "@") {
			$title = syra_expression.render(this.page, $title);
		}

		block.header = document.createElement("header");
		block.header.className = "s-fusion-block-header";
		var btn = syra_menus.button.add({
			parent: this,
			slot: block.header,
			text: $title,
			css: "s-fusion-bar-block-title",
			btnclick: function(event, btn) {
				var bar = this.parent;
				for (var ii = 0, jj = bar.blocks.length; ii < jj; ii++) {
					if (bar.blocks[ii].title == btn) {
						bar.collapseBlock(bar.blocks[ii], true);
						break;
					}
				}
			}
		});
		block.title = btn.link;
		block.title.setAttribute("href", "#");
		block.body = document.createElement("div");
		block.body.className = "s-fusion-block-body";


		block.domItem.appendChild(block.header);
		block.domItem.appendChild(block.body);
		this.body.appendChild(block.domItem);
		return block;
	},
	collapseBlock: function(block, show, onDrawBar) {
		var self = this;
		self.page.externalAdapter.onBoxToggle({
			box: block,
			open: show,
			onDrawParent: onDrawBar,
			isFirstTime: !block.leftList,
			doEvent: function() {
				if (show && self.openedBlock && (self.openedBlock != block)) {
					self.collapseBlock(self.openedBlock, false);
				}
				self.openedBlock = block;
				syra_site.dom.hide(block.body, !show);
				syra_site.dom.toggleClass(block.header, "s-open", show);
				syra_site.dom.toggleClass(block.domItem, "s-open", show);
				if (show) {
					if (!block.leftList) {
						block.$item.$isTitleHidden = true;
						if (self.page.$prototype.$properties[block.$item.$bind].$type == "application/x-array") {
							block.$item.$isNavigationList = true;
						}
						syra_site.dom.empty(block.body);
						block.leftList = self.page.loadNewItem(block.body, block.$item);
						block.title.syraKeyTarget = block.leftList.id;
					} else {
						if (block.leftList) {
							block.leftList.disableDisplayValidation = false;
							block.leftList.filler.validateDisplay(block.leftList);
						}
					}
					self.resizeOnExpand = true;
					self.resizeBar();
					if (!onDrawBar) {
						block.leftList && block.leftList.resizeArticle(true);
					}
				} else {
					if (block.leftList) {
						block.leftList.disableDisplayValidation = true;
					}
					block.domItem.style.height = "";
				}
			}
		});
	},
	resizeBar: function() {
		if (SideBar.prototype.resizeBar.call(this) || this.resizeOnExpand) {
			if (this.curCollapsedState) {
				this.resizeOnExpand = true;
			} else {
				this.resizeOnExpand = false;
				if (this.openedBlock) {
					var blockHeight = 0;
					for (var ii = 0, jj = this.blocks.length; ii < jj; ii++) {
						var block = this.blocks[ii];
						if (block != this.openedBlock) {
							if (!block.height) {
								block.height = block.domItem.getBoundingClientRect().height;
							}
							blockHeight += block.height;
						}
					}
					this.openedBlock.domItem.style.height = (this.body.clientHeight - blockHeight) + "px";
					this.openedBlock.body.style.height = (this.openedBlock.domItem.clientHeight - this.openedBlock.header.getBoundingClientRect().height) + "px";
				}
			}
		}
	},
	setFocusBar: function(select, bindList) {
		var block, ii = 0,
			jj = this.blocks ? this.blocks.length : 0,
			ret = false;
		for (ii = 0; ii < jj; ii++) {
			block = this.blocks[ii];
			if (block.$item && block.$item.$bind === bindList) {
				break;
			}
		}
		if (ii < jj) {
			ret = true;
			block.title.focus();
		}
		return ret;
	},
	dispose: function() {
		if (this.blocks) {
			for (var ii = 0, jj = this.blocks.length; ii < jj; ii++) {
				delete this.blocks[ii].leftList;
			}
			delete this.blocks;
		}
		this.$fusionBar = null;
		SideBar.prototype.dispose.call(this);
	}
});