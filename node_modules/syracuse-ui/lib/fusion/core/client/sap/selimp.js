"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Printer selection/configuration management
 */
 
 
var helpers = require('syracuse-core/lib/helpers');


function PrinterAccess(){
}

exports.PrinterAccess = helpers.defineClass(PrinterAccess, null, {
    initialize: function(params, callBack, sapController, winId){
    	// At time, just simple acknowledge
    	var printerSelected = params && params.$rcd && params.$rcd.length > 0 ? params.$rcd[0] : null;
    	var replyOK = {"selected": printerSelected}, replyCancel = {}, replyOpts = {"printerName": printerSelected.name};
    	//callBack("PRINTER_SEL_CANCEL", replyCancel);
    	//callBack("PRINTER_SEL_OPTS", replyOpts);
    	callBack("PRINTER_SEL_OK", replyOK);
        //this.stackWindow(sapController, winId, null, params, callBack);
    },

    stackWindow: function(sapController, winId, data, params, ack){
    	var loadParams = {"id": winId, "name": "selimpr1", "mainPage": false};
        function _onWinOpenErr(dgns, errCtx) {
            callBack("PRINTER_SEL_CANCEL", {});
        }
    	sapController._siteController.loadRepresentation(loadParams, null, 
                function (page){
                    // Apply reply
		            sapController._wndwsStack.stack(winId, params, page);
		            sapController._wndwsStack.postBuildInit(winId);
		            params.$mvt = [[1, 1, params.$rcd.length]];
		            for (var i= 0; i<  params.$rcd.length; i++){
		            	params.$rcd[i].$uuid = i;
		            }
		            sapController._wndwsStack.applyChange(winId, {"entities": {"printers": params}}, null, true);
		            // focus
                },
                function (error){
                    var err = util.isOurAjaxErrEx(error), diagnoses, diagnosis;
                    diagnosis = util.makeDiagnosis(self._session.getlabel("error", "10", "Unexpected error retrieving window description on web server : ") + " '" + winId.name + "'.\n" + self._session.getlabel("error", "26", "The expected function could not be opened. Please, contact your system administrator if the issue persists."), 3, null, "10", util.cltFusionNice, null, null);
                    if (err && (diagnoses = [util.makeDiagnosesFromOurAjaxErrEx(err)])){
                        if (diagnoses[0].$diagnoses) {
                             diagnoses[0].$stackTrace = diagnoses[0].$diagnoses[0].message || diagnoses[0].$diagnoses[0].$message || "";
                             delete diagnoses[0].$diagnoses;
                        }
                    }
                    else {
                        diagnoses = util.getDiagnosesFromAjax(error, self._session);
                    }
                    if(diagnoses)  {
                        diagnoses.splice(0, 0, diagnosis);
                    }
                    else {
                        diagnoses = diagnosis;
                    }
                    _onWinOpenErr(diagnoses, error);
                },
                function (representation){
                    // Extend prototype with dynamic model and layout
                },
                "20130712174532", _onWinOpenErr);
    }
});
