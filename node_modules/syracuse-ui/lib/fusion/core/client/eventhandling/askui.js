"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Fusion "Askui" windows event handling classes
 */
var Askui = require('../sap/askui');
var util = require('syracuse-ui/lib/fusion/tools/util');

var _evtProcAskui = {};
exports.AskuiEventHandling = _evtProcAskui;

/* "Askui dialogs" events handling class for "Askui" et cie controls */
_evtProcAskui.sap = function() {
	this.eventListeners = function() {
		return [["sap.extdlg.loaded", onDlgLoaded, false, false], ["sap.extdlg.activate", onDlgActivate, false, false], ["sap.extdlg.abort", onAbort, false, false], ["wdgt.link.click", onClick, true, true], ["wdgt.win.close", onClose, true, true], ["wdgt.file.upload", onFileUpload, true, true], ["wdgt.file.uploadSucceeded", onFileUploadSucceeded, true, true], ["wdgt.file.uploadDone", onFileUploadDone, true, true], ["wdgt.file.uploadRemove", onFileUploadRemove, true, true]];
	};

	function _updateLinksStatus(page, links) {
		var i, len = links.length,
			updateItem = {
				"$links": {}
			};
		for (i = 0; i < len; i++) {
			updateItem.$links[links[i].$bind] = {
				"$isDisabled": links[i].$isDisabled
			};
		}
		page.applyChange(updateItem);
	}

	function _isOurUploadFld(self, field) {
		return field && field === self._ctx.upLoadStatus.field;
	}

	function _initUploadDlg(self, dialog, dialogName) {
		/*Askui RETOUR = ""  With   "UIAsk=" + chr$(1) + "upLoadFile",
         & "UIUrl=" + chr$(1) + "/sdata/x3/erp/SUPERV/$service/upload?fileName='{$myfileName}'",
         & "UIMaxLength=" + chr$(1) + "222222222",
         & "UIContentType=" + chr$(1) + "application/octet-stream",
         & "UIFileName=" + chr$(1) + "$myfileName"*/
		var boundFields, uploadFldBind, uploadFlName, statementParams;
		self._ctx.upLoadStatus = {};
		if ((boundFields = syra_fusion.syraUtil.getBoundFldsFromPage(dialog)) && (statementParams = self._ctx.statementParams)) {
			// Init data and meta (i.e. filters...)
			uploadFldBind = self.askuiController.getFieldName(dialogName, "upLoadFld");
			uploadFlName = self.askuiController.getFieldName(dialogName, "upLoadflName");
			_updateLinksStatus(self._ctx.currDlg, [{
				"$bind": "$ok",
				"$isDisabled": true
			}, {
				"$bind": "$cancel",
				"$isDisabled": false
			}]);
			self._ctx.upLoadStatus.field = boundFields[uploadFldBind][0];
			// Parse URL to retrieve File Name... if one has been defined: 
			self._ctx.upLoadStatus.$fileName = uploadFlName;
			if (statementParams.UIFileName && statementParams.UIUrl.indexOf(statementParams.UIFileName) >= 0) {
				statementParams.UIUrl = statementParams.UIUrl.replace(statementParams.UIFileName, uploadFlName);
			}
			self._ctx.upLoadStatus.field.setValue({
				"$url": statementParams.UIUrl,
				"$type": "binary"
			}, {
				"$contentType": statementParams.UIContentType
			}, {});
			self._ctx.upLoadStatus.field.input.click();
		}
	}

	function onFileUpload(event, data) {
		var processed = undefined,
			messErr, maxSize, sizeOk = true,
			dataChange = {}, files;
		if (_isOurUploadFld(this, event.target) && event.data && (files = event.data.files) && files.length > 0) {
			syra_fusion.syraUtil.showDiagnoses(null, this._ctx.currDlg);
			// maxSize = parseInt(this._ctx.statementParams.UIMaxLength, 10);
			maxSize = 1024 * 1024 * 1024; // 1Go
			if (this._ctx.statementParams.UIMaxLength && files[0].size > maxSize) {
				messErr = this.sapController.getMessLabel("72", "error", "File size is greater than maximun size allowed") + " (" + maxSize + " octets).";
				syra_fusion.syraUtil.showDiagnoses([util.makeDiagnosis(messErr, "error")], this._ctx.currDlg);
				sizeOk = false;
				processed = true;
			}
			if (sizeOk) {
				if (this._ctx.upLoadStatus.$fileName) {
					dataChange[this._ctx.upLoadStatus.$fileName] = files[0].name;
					this._ctx.currDlg.applyChange(dataChange);
					this._ctx.statusData = files[0].name;
				}
				this._ctx.statementPending = true;
				_updateLinksStatus(this._ctx.currDlg, [{
					"$bind": "$ok",
					"$isDisabled": true
				}, {
					"$bind": "$cancel",
					"$isDisabled": true
				}]);
			}
		} else {
			processed = true;
		}
		return processed;
	}

	function onFileUploadSucceeded(event) {
		var processed = undefined,
			docField, self;
		if (_isOurUploadFld(this, (docField = event.target))) {
			this._ctx.upLoadStatus.succeeded = true;
			this._ctx.statementPending = false;
			_updateLinksStatus(this._ctx.currDlg, [{
				"$bind": "$ok",
				"$isDisabled": false
			}, {
				"$bind": "$cancel",
				"$isDisabled": false
			}]);
			docField.hideSelectButton(true);
			self = this;
			setTimeout(function() {
				if (docField) {
					docField.setLegend((self._ctx.statusData ? (self._ctx.statusData + " : ") : "") + syra_local.fdocUploaded);
				}
				// Should close automaticaly our "upload" dialog?? => call "onClose()."
			}, 1700);

		}
		return processed;
	}

	function onFileUploadRemove(event) {
		var processed = undefined,
			docField = event.target,
			self = this;
		if (_isOurUploadFld(this, docField)) {
			syra_fusion.syraUtil.showDiagnoses(null, this._ctx.currDlg);
			docField.hideSelectButton(false);
			docField.setLegend(syra_local.fdocDropSelectFile);
			syra_http["delete"]({
				url: syra_expression.parse(docField.articleParent, docField.$dataUrl),
				noDisplayErr: true,
				headers: {
					"x-file-name": self._ctx.statusData
				},
				success: function(data, response) {
					docField.setValue(null);
					docField.articleParent.applyChange(data, response);
					_updateLinksStatus(self._ctx.currDlg, [{
						"$bind": "$ok",
						"$isDisabled": true
					}]);
				},
				error: function(error) {
					var data = (error.data && typeof error.data !== "object") ? JSON.parse(error.data) : (error.data || null);
					if (data && data.$diagnoses) {
						docField.articleParent.applyChange(data);
					}
				}
			});
			processed = true;
		}
		return processed;
	}

	function onFileUploadDone(event) {
		var processed = undefined;
		if (_isOurUploadFld(this, event.target)) {
			this._ctx.statementPending = false;
			_updateLinksStatus(this._ctx.currDlg, [{
				"$bind": "$cancel",
				"$isDisabled": false
			}]);
		}
		return processed;
	}

	function _closeDlg(self) {
		self.askuiController.closeDialog();
		_releaseCtx.call(self);
	}

	function onDlgLoaded(event, dialogId, dialogName, askStatement, callbackAct) {
		var isUploadDlg = dialogName == "upload",
			page = event.target;
		_release.call(this);
		this._ctx = {
			"currDlg": page,
			"statement": askStatement,
			"statementParams": event.data,
			"callback": callbackAct
		};
		if (isUploadDlg) {
			_initUploadDlg(this, page, dialogName);
		}
	}

	function onDlgActivate(event, dialogId) {

	}

	function onClick(event) {
		var data = null,
			processed = undefined,
			linkId = null,
			ret = {
				"closeLink": false
			}, status = Askui.returnStatus.cancel,
			self = this;
		if (event.target && (linkId = (event.target.$sourceBind || event.target.$bind))) {
			switch (linkId) {
				case "$ok":
					status = Askui.returnStatus.success;
					data = this._ctx.statusData;
				case "$cancel":
				default:
					ret.closeLink = true;
					break;
			}
			if (ret.closeLink && !this._ctx.statementPending) {
				setTimeout(function() {
					self._ctx.callback(status, data);
					_closeDlg(self);
				}, 10);
				processed = true;
			}
		}
		return processed;
	}

	function onClose(event) {
		if (!event.target) {
			event.target = {};
		}
		event.target.$bind = "$cancel";
		return onClick.call(this, event);
	}

	function onAbort(event) {
		var processed = undefined;
		_release.call(this);
		return processed;
	}

	function _releaseCtx() {
		if (this._ctx) {
			delete this._ctx.currDlg;
			delete this._ctx.callback;
			delete this._ctx.statementParams;
			if (this._ctx.upLoadStatus) {
				delete this._ctx.upLoadStatus.field;
			}
		}
	}

	function _release() {
		_releaseCtx.call(this);
		if (this._ctx) {
			delete this._ctx;
		}
	}
};