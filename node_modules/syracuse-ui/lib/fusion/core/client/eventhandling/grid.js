"use strict";
/*
 * @fileoverview Fusion Grid event handling classes
 */
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var evtTools = require('../eventhandling/common').CommonEventHandlingTools;
var requestActions = require('../sap/srvactions');
var util = require('syracuse-ui/lib/fusion/tools/util');
var svcFmt = require('syracuse-ui/lib/fusion/core/tools/format').svcFormatter;
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;
var popupCardBuilder = require('syracuse-ui/lib/field/array/gridBuilder/card/popupCardBuilder');
var _evtProcGrid = {};
exports.GridEventHandling = _evtProcGrid;

/* "Server page input" event handling class for "Grid" widget */
_evtProcGrid.sap = function() {
	this.eventListeners = function() {
		return [["wdgt.cell.click", clickCellTab, true, true], ["wdgt.cell.mousedown", clickCellTab, true, true], ["wdgt.cell.change", changeCellTab, true, true], ["wdgt.grid.selline", selectLine, true, true], ["wdgt.record.action", actionLine, true, true], ["wdgt.array.action", actionArray, true, true], ["wdgt.cell.picker", clickPicker, true, true], ["wdgt.array.picker", clickArrayPicker, true, true], ["wdgt.record.picker", clickRecordPicker, true, true], ["wdgt.cell.calendarclosed", onDatePickerClose, true, true], ["wdgt.cell.escape", applyEscape, true, true], ["wdgt.cell.applyShortCut", applyShortCut, true, true], ["wdgt.cell.keydown", keyDownCellTab, true, true], ["wdgt.cell.keyup", keyUpCellTab, true, true], ["wdgt.grid.sortLocal", sortLocal, true, true], ["wdgt.grid.searchLocal", searchLocal, true, true]];
	};

	function sortLocal(event) {
		var fieldInfo = _getFieldInfo(event),
			ist;
		if (!event.target) {
			return undefined;
		}
		var sap = this.sapController;
		if (fieldInfo.firstFocus || fieldInfo.currIst.edit) {
			ist = sapUtil.makeIst(fieldInfo.fieldIst.win, fieldInfo.fieldIst.xid, 1);
			event.result = {
				"$act": requestActions.getSrvAction("SRV_COMMANDGRID"),
				"params": {
					"target": ist
				},
				"post": {
					"callback": event.data.doEvent,
					"args": [sapUtil.isEmptyGridDataRecord]
				}
			};
			return true;
		}
		return false;
	}

	function searchLocal(event) {
		var fieldInfo = _getFieldInfo(event),
			ist;
		if (!event.target) {
			return undefined;
		}
		if (event.data.found) {
			var sap = this.sapController;
			ist = sapUtil.makeIst(fieldInfo.fieldIst.win, event.data.found.$bind, event.data.found.$serverIndex + 1);
			event.result = {
				"$act": requestActions.getSrvAction("SRV_COMMANDGRID"),
				"params": {
					"target": ist
				}
				/*,
                 "post": {
                 "callback": event.data.doEvent
                 }*/
			};
		}
		return true;
	}

	function _getNlFromMagneto(list, current, isSorted, next, last) {
		var nl = current,
			currRcdIdx, recordIdx;
		if (!isSorted) {
			if (next !== null) {
				nl = next ? current + 1 : Math.max(1, current - 1);
			} else
			if (last !== null) {
				nl = last ? list.clientDataset.length : 1;
			}
			recordIdx = nl - 1;
		} else {
			if (next !== null) {
				currRcdIdx = popupCardBuilder.getRecord(list).getRecordIndex();
				recordIdx = next ? currRcdIdx + 1 : Math.max(0, currRcdIdx - 1);
			} else
			if (last !== null) {
				recordIdx = last ? list.clientDataset.length - 1 : 0;
			}
			nl = list.clientDataset[recordIdx].$serverIndex + 1;
		}
		if (sapUtil.isEmptyGridDataRecord(list, {
			uuid: list.clientDataset[recordIdx].$uuid
		})) {
			recordIdx--;
			nl = list.clientDataset[Math.max(recordIdx, 0)].$serverIndex + 1;
		}
		return {
			"nl": nl,
			"recordIdx": recordIdx
		};
	}

	function actionLine(event) {
		var processed = undefined,
			next, last, rcdLinks = {}, fieldInfo = _getFieldInfo(event),
			acts = {}, srvActEx, srvAct, srvActNum, indexes, grid = fieldInfo.array;
		var crudActs = {
			"$delete": {
				"a": "SRV_DELETELINEGRID",
				"s": "SUP_LINE_DELETE"
			},
			"$create": {
				"a": "SRV_INSERTLINEGRID",
				"s": "SUP_LINE_INSERT"
			}
		};
		var srcBind = event.target.$sourceBind || event.target.$item.$bind,
			discard = false;
		if (event.target) {
			var $bind = event.target.$sourceBind || event.target.$bind;
			grid.selectRecords();
			switch (srcBind) {
				case "$delete":
				case "$create":
					// Have to check action status... cause it could be triggered by shorcut
					if (evtTools.getGridRecordLinks(grid, grid.$capability, grid.$item.$bind, fieldInfo, this.sapController, rcdLinks) && rcdLinks[srcBind] && !rcdLinks[srcBind].$isHidden) {
						srvActEx = crudActs[srcBind].s;
						srvAct = crudActs[srcBind].a;
					} else {
						discard = true;
					}
					processed = true;
					break;
				case "$tunnel":
					srvActNum = requestActions.getSrvAction("SRV_TUNNEL");
					processed = true;
					break;
				case "$first":
				case "$previous":
				case "$next":
				case "$last":
					srvAct = "SRV_COMMANDGRID";
					next = $bind == "$next" ? true : ($bind == "$previous" ? false : null);
					last = $bind == "$last" ? true : ($bind == "$first" ? false : null);
					indexes = _getNlFromMagneto(grid, fieldInfo.fieldIst.nl, fieldInfo.isSortedArray, next, last);
					fieldInfo.fieldIst.nl = indexes.nl;
					processed = true;
					break;
				case "$recordCard":
					processed = false;
					break;
				default:
					srvActNum = event.target.$act;
					processed = true;
					break;
			}
			if (srvActNum) {
				acts.srvAct = srvActNum;
			} else {
				if ((fieldInfo.firstFocus || fieldInfo.changeLine || fieldInfo.isEdit) && srvActEx) { // focus not already on this table or line change or same ligne but edit field
					acts.srvAct = requestActions.getSrvActionEX(srvActEx);
				} else {
					acts.srvAct = requestActions.getSrvAction(srvAct);
				}
			}
			if (!discard) {
				event.result = {
					"$act": acts.srvAct,
					post: acts.post,
					params: {
						"target": fieldInfo.fieldIst
					}
				};

			}
		}
		return processed;
	}

	function actionArray(event) {
		var processed = undefined;
		if (event.target) {
			switch (event.target.$sourceBind || event.target.$bind) {
				case "$delete":
					processed = deleteMultiLInes.call(this, event);
					break;
				case "$copy":
					processed = copySelectedLines.call(this, event);
					break;
				case "$paste":
					processed = pasteLines.call(this, event);
					break;
				case "$cut":
					processed = cutSelectedLines.call(this, event);
					break;
				case "$tabularExport":
					//TODO export excel
					processed = _exportExcel(event);
					break;
			}
		}
		return processed;
	}

	function _exportExcel(event) {
		var fieldInfo = _getFieldInfo(event);
		if (fieldInfo.firstFocus || fieldInfo.isEdit) { // focus not already on this table or line change or same ligne but edit field
			fieldInfo.fieldIst.nl = 1;
			event.result = {
				"$act": requestActions.getSrvActionEX("SUP_EXPXLSGRID"),
				"params": {
					"target": fieldInfo.fieldIst
				}
			};
		} else {
			event.result = {
				"$act": requestActions.getSrvAction("SRV_EXPXLSGRID"),
				"params": {
					"target": fieldInfo.blockIst
				}
			};
		}
		return true;
	}

	function deleteMultiLInes(event) {
		var process, start, count;
		if (event.target) {
			var fieldInfo = _getFieldInfo(event);
			var recordsSelected = (fieldInfo.array.selector && fieldInfo.array.selector.getSelectedList());
			if (recordsSelected.length > 0) {
				start = recordsSelected[0].$serverIndex;
				count = recordsSelected.length;
			} else {
				start = 0;
				count = Math.max(fieldInfo.array.dataset.length, 1);
			}
			process = deleteLines.call(this, event, start, count);
		}
		return process;
	}

	function deleteLines(event, start, count) {
		//SUP_LINES_DELETE //SRV_DELETELINESGRID
		if (event.target) {
			var fieldInfo = _getFieldInfo(event);
			fieldInfo.fieldIst.nl = start + 1;
			if (!event.data) {
				event.data = {};
			}
			event.data.line = start + count;
			if (fieldInfo.firstFocus || fieldInfo.changeLine || fieldInfo.isEdit) { // focus not already on this table or line change or same ligne but edit field
				event.result = {
					"$act": requestActions.getSrvActionEX("SUP_LINES_DELETE"),
					"params": {
						"target": fieldInfo.fieldIst,
						"sudo": [null, [start + 1, count]]
					}
				};
			} else {
				event.result = {
					"$act": requestActions.getSrvAction("SRV_DELETELINESGRID"),
					"params": {
						"target": fieldInfo.fieldIst,
						"std": [start + 1, count]
					}
				};
			}
		}
		return true;
	}

	function doLinesCopied(grid) {
		grid.x3LinesCopied = true;
		if (grid.selector)
			grid.selector.unSelectAll();
	}

	function copySelectedLines(event) {
		var process, start, count;
		if (event.target) {
			var fieldInfo = _getFieldInfo(event);
			var recordsSelected = (fieldInfo.array.selector && fieldInfo.array.selector.getSelectedList());
			if (recordsSelected.length > 0) {
				start = recordsSelected[0].$serverIndex;
				count = recordsSelected.length;
				fieldInfo.fieldIst.nl = start + 1;
				if (!event.data) {
					event.data = {};
				}
				event.result = {
					"$act": requestActions.getSrvAction("SRV_COPYLINEGRID"),
					"params": {
						"target": fieldInfo.fieldIst,
						"std": [start + 1, count]
					}
				};
				process = true;
				event.result.post = {
					"callback": doLinesCopied,
					"args": [fieldInfo.array]
				};
			}
		}
		return process;
	}

	function pasteLines(event) {
		var process, start, count, fieldContext = this.sapController.getCurrInst();
		if (event.target) {
			var fieldInfo = _getFieldInfo(event);
			if (fieldContext && fieldContext.nl) {
				fieldInfo.fieldIst.nl = fieldContext.nl;
			}
			event.result = {
				"$act": requestActions.getSrvAction("SRV_PASTELINEGRID"),
				"params": {
					"target": fieldInfo.fieldIst
				}
			};
			process = true;
		}
		return process;
	}

	function cutSelectedLines(event) {
		var process, start, count;
		if (event.target) {
			var fieldInfo = _getFieldInfo(event);
			var recordsSelected = (fieldInfo.array.selector && fieldInfo.array.selector.getSelectedList());
			if (recordsSelected.length > 0) {
				start = recordsSelected[0].$serverIndex;
				count = recordsSelected.length;
				fieldInfo.fieldIst.nl = start + 1;
				if (!event.data) {
					event.data = {};
				}
				event.result = {
					"$act": requestActions.getSrvAction("SRV_CUTLINEGRID"),
					"params": {
						"target": fieldInfo.fieldIst,
						"std": [start + 1, count]
					}
				};
				process = true;
				event.result.post = {
					"callback": doLinesCopied,
					"args": [fieldInfo.array]
				};
			}
		}
		return process;
	}

	function selectLine(event) {
		var processed = undefined,
			fieldInfo = _getFieldInfo(event),
			acts = {};
		if (event.data.uuid != undefined) {
			if (sapUtil.isEmptyGridDataRecord(event.target, {
				uuid: event.data.uuid
			})) {
				return true;
			}
		}
		if (event.target) {
			var indexList = event.target.getSelectedRecordIndexes();
			if (indexList.length > 0) {
				if (event.data.nativeEvt.shiftKey && !fieldInfo.isSortedArray) {
					fieldInfo.array.selectRecords(indexList[0].start, fieldInfo.nl - 1);
				} else {
					fieldInfo.array.selectRecords();
				}
			}
			if ((fieldInfo.changeLine || fieldInfo.firstFocus || fieldInfo.isEdit) && (!event.data.nativeEvt.shiftKey || indexList.length == 0)) { // focus not already on this table or check and change line
				acts.srvAct = requestActions.getSrvAction("SRV_COMMANDGRID"); // ask for focus
				acts.send = true;
				if (fieldInfo.fieldIst.nl === 0) {
					fieldInfo.fieldIst.nl = 1;
				}
			}
			if (acts.send) {
				event.result = {
					"$act": acts.srvAct
				};
				event.result.params = {
					"target": fieldInfo.fieldIst
				};
				event.result.post = acts.post;
			}
		}
		return false;
	}

	function clickPicker(event) {
		var process = undefined,
			pickerType, fieldInfo = _getFieldInfo(event);
		if (fieldInfo.readOnlyByModel) {
			return true;
		}
		if (event.data) {
			if (pickerType = event.data.pickerType) {
				switch (pickerType) {
					case "menus":
						process = clickCell.call(this, event, fieldInfo);
						process = menuCtxPickerClick.call(this, event, process, fieldInfo);
						break;
					case "$tunnel":
					case "$lookup":
						process = clickCell.call(this, event, fieldInfo);
						process = innerPickerClick.call(this, event, process, fieldInfo, pickerType);
						break;
					case "date":
						process = clickCell.call(this, event, fieldInfo);
						process = datePickerClick.call(this, event, process, fieldInfo);
						break;
					case "cancelEdit":
						var ist = sapUtil.makeIst(fieldInfo.fieldIst.win, fieldInfo.fieldIst.xid, fieldInfo.nl);
						if (fieldInfo.isEdit) {
							event.result = {
								"$act": requestActions.getSrvActionEX("SUP_LIST_ABANDON"),
								"params": {
									"target": ist
								}
							};
						} else {
							event.result = {
								"$act": requestActions.getSrvAction("SRV_CHAMP_SUIVANT"),
								"params": {
									"target": ist
								}
							};
						}
						process = true;
						break;
					case "help":
						process = evtTools.onFieldHelp(event, fieldInfo);
						break;
					default:
						process = clickCell.call(this, event, fieldInfo);
						break;
				}
			}
		}
		return process;
	}

	function clickArrayPicker(event) {
		var fieldInfo = _getFieldInfo(event),
			ist;
		var menusPopup = event.target && event.target.menusPopup;
		if (!menusPopup) {
			if (fieldInfo.firstFocus || fieldInfo.isEdit) {
				ist = sapUtil.makeIst(fieldInfo.fieldIst.win, fieldInfo.fieldIst.xid, fieldInfo.firstFocus ? 1 : fieldInfo.currIst.nl);
				event.result = {
					"$act": requestActions.getSrvAction("SRV_COMMANDGRID"),
					"params": {
						"target": ist
					},
					"post": {
						"exposeReply": true,
						"callback": evtTools.openFieldCtx,
						"args": [this, event, event.target, fieldInfo]
					}
				};
				return true;
			} else {
				var self = this;
				setTimeout(function() {
					evtTools.openFieldCtx({}, self, event, event.target, fieldInfo);
				}, 10);
				return true;
			}
		}
		if (menusPopup && event.data.doEvent) {
			event.data.doEvent();
			delete event.data.doEvent;
		}
	}

	function clickRecordPicker(event) {
		var process = undefined,
			pickerType, fieldInfo = _getFieldInfo(event);
		if (fieldInfo.xid == "$itemsPerPage")
			return false;
		if (pickerType = event.data.pickerType) {
			switch (pickerType) {
				case "menus":
					if ((fieldInfo.firstFocus || fieldInfo.changeLine || fieldInfo.isEdit)) {
						process = setFoucusLine.call(this, event, fieldInfo);
					}
					process = menuCtxPickerClick.call(this, event, process, fieldInfo, true);
					break;
				case "closeCard":
					if (sapUtil.cmpIstBlock(fieldInfo.currIst, fieldInfo.fieldIst)) {
						fieldInfo.fieldIst = fieldInfo.currIst;
						process = setFoucusLine.call(this, event, fieldInfo, fieldInfo.isEdit);
					}
					if (process === undefined) {
						process = false;
					}
					break;
				case "openCard":
					/*if (sapUtil.cmpIstBlock(fieldInfo.currIst, fieldInfo.fieldIst)) {
                 fieldInfo.fieldIst = fieldInfo.currIst;
                 process = setFoucusLine.call(this, event, fieldInfo, fieldInfo.isEdit);
                 }
                 if (process === undefined) process = false;*/
					process = false;
					break;
				default:
					if ((fieldInfo.firstFocus || fieldInfo.changeLine || fieldInfo.isEdit)) {
						process = setFoucusLine.call(this, event, fieldInfo);
					}
					break;
			}
		}
		return process;
	}

	function menuCtxPickerClick(event, process, fieldInfo, record) {
		var menusPopup = event.target && event.target.menusPopup,
			exclude = undefined,
			target = false,
			links = event.target && event.target.$menus;
		if (links) {
			if (links.$tunnel) {
				exclude = {};
				exclude[new String(requestActions.getSrvAction("SRV_TUNNEL"))] = true;
			}
			if (links.$lookup) {
				exclude = exclude || {};
				exclude[new String(requestActions.getSrvAction("SRV_BOITE_SELECTION"))] = true;
			}
		}
		if (fieldInfo && !menusPopup) {
			if (process && event.result && event.result.$act) {
				switch (event.result.$act) {
					case requestActions.getSrvAction("SRV_COMMANDGRID"):
						if (record) {
							event.result.$act = requestActions.getSrvActionEX("SUP_CELL_FOCUS_CTX");
						} else {
							event.result.$act = requestActions.getSrvActionEX("SUP_CELL_FOCUS_EDIT_CTX");
						}
						target = true;
						break;
					case requestActions.getSrvAction("SRV_GETFOCUSCELL"):
						event.result.$act = requestActions.getSrvActionEX("SUP_CELL_EDIT_CTX");
						target = false;
						break;
					case requestActions.getSrvActionEX("SUP_CELL_EDIT"):
						event.result.$act = requestActions.getSrvActionEX("SUP_CELL_FOCUS_EDIT_CTX");
						target = true;
						break;
					default:
						break;
				}
			} else {
				target = true;
				if (!record && !fieldInfo.isEdit) {
					event.result = {
						"$act": requestActions.getSrvActionEX("SUP_CELL_EDIT_CTX")
					};
				} else {
					event.result = {
						"$act": requestActions.getSrvAction("SRV_OPEN_CTXMENU")
					};
				}
				if (target) {
					event.result.params = {
						"target": fieldInfo.fieldIst
					};
				}
			}
			if (event.data.doEvent) {
				event.result.post = {
					"exposeReply": true,
					"callback": evtTools.openFieldCtx,
					"args": [this, event, event.target, fieldInfo, exclude]
				};
			}
			process = true;
		} else {
			if (menusPopup && event.data.doEvent) {
				event.data.doEvent();
				delete event.data.doEvent;
			}
		}
		return process;
	}

	function innerPickerClick(event, process, fieldInfo, pickerType) {
		var act = (pickerType == "$tunnel" ? "DRILL" : "SELECT");
		if (process) {
			switch (event.result.$act) {
				case requestActions.getSrvAction("SRV_COMMANDGRID"):
					event.result.$act = requestActions.getSrvActionEX("SUP_CELL_FOCUS_" + act);
					break;
				case requestActions.getSrvAction("SRV_GETFOCUSCELL"):
					event.result.$act = requestActions.getSrvActionEX("SUP_CELL_EDIT_" + act);
					break;
				case requestActions.getSrvActionEX("SUP_CELL_EDIT"):
					event.result.$act = requestActions.getSrvActionEX("SUP_CELL_FOCUS_EDIT_" + act);
					break;
			}
			event.result.post = null;
		} else {
			event.result = {
				"$act": (pickerType == "$tunnel" ? requestActions.getSrvAction("SRV_TUNNEL") : requestActions.getSrvActionEX("SUP_CURRENTFIELD_SELECT"))
			};
			event.result.params = {
				"target": fieldInfo.fieldIst
			};
			event.result.post = null;
			process = true;
		}
		return process;
	}

	function datePickerClick(event, process, fieldInfo) {
		if (process && !syraUtil.getPopupDateFromField(event.target)) {
			event.result.post = {
				"callback": function(evtHandlingObj, initialEvent, callerField) {
					var fieldContext = evtHandlingObj.sapController.getCurrInst();
					evtTools.openDatePicker(true, fieldContext.raw ? svcFmt.formReply(fieldContext.raw, fieldContext.fmt) : null, evtHandlingObj, initialEvent, callerField, fieldInfo);
				},
				"args": [this, event, event.target, fieldInfo]
			};
		} else
		if (!syraUtil.getPopupDateFromField(event.target)) {
			var fieldContext = this.sapController.getCurrInst();
			var currValue = syraUtil.getFusionPageMeta(event.target).winModel.getDataInputValue(syraUtil.getMetaFromObject(event.target).$bind, event.target.articleParent.$serverIndex + 1);
			if (currValue && currValue.v) {
				event.result = {
					"$act": requestActions.svcFormat
				};
				event.result.params = svcFmt.buildRqst(svcFmt.fmtSvc.toRaw, currValue.v, fieldContext.fmt, syraUtil.getFieldType(event.target), fieldContext);
				event.result.post = {
					"callback": evtTools.openDatePicker,
					"args": [this, event, event.target, fieldInfo]
				};
				process = true;
			} else {
				var self = this;
				setTimeout(function() {
					evtTools.openDatePicker(true, null, self, event, event.target, fieldInfo);
				}, 10);
				process = true;
			}
		}
		return process;
	}

	function changeCellTab(event) {
		var processed = undefined,
			fieldInfo = _getFieldInfo(event);
		if (fieldInfo.isCheck) {
			return clickCell.call(this, event, fieldInfo);
		}
	}

	function clickCellTab(event) {
		var processed = undefined,
			fieldInfo = _getFieldInfo(event);
		if (isNaN(fieldInfo.nl))
			return false;
		if (!evtTools.discardFieldEvent(event.type, fieldInfo)) {
			return clickCell.call(this, event, fieldInfo);
		}
	}

	function applyEscape(opt) {
		var processed = undefined,
			fieldInfo = _getFieldInfo(opt),
			data, acts;
		if (fieldInfo.isEdit) {
			data = fieldInfo.winModel.getDataStoreValue(fieldInfo.$fieldMeta.$bind, fieldInfo.nl, false, true);
			fieldInfo.winModel.setDataStoreValue(fieldInfo.$fieldMeta.$bind, fieldInfo.nl, data, {
				"noStoreCommmit": true,
				"formatted": true
			});
			acts = requestActions.getSrvAction("SRV_ABANDONLINE");
			processed = true;
			opt.result = {
				"$act": acts
			};
			opt.result.params = {
				"target": fieldInfo.fieldIst
			};
		}
		return processed;
	}

	function applyTab(opt) {
		var fieldInfo = _getFieldInfo(opt),
			fieldIst = fieldInfo.fieldIst,
			acts, target, processed = undefined;
		if (opt.data.shortcuts.esc) {
			if (fieldInfo.isEdit) {
				acts = requestActions.getSrvActionEX("SUP_LIST_ABANDON");
			} else {
				acts = requestActions.getSrvAction("SRV_CHAMP_SUIVANT");
			}
			target = true;
			processed = true;
		} else {
			if (!fieldInfo.isEdit /*&& !fieldInfo.target.$isReadOnly*/ ) {
				if (!opt.data.shortcuts.shift) {
					acts = requestActions.getSrvActionEX("SUP_CELL_EDIT_TAB");
				} else {
					acts = requestActions.getSrvAction("SRV_CHAMP_PRECEDENT");
				}
				target = true;
				processed = true;
			} else {
				acts = requestActions.getSrvAction(opt.data.shortcuts.shift ? "SRV_CHAMP_PRECEDENT" : "SRV_CHAMP_SUIVANT");
				target = true;
				processed = true;
			}
		}
		opt.result = {
			"$act": acts
		};
		if (target) {
			opt.result.params = {
				"target": fieldIst
			};
		}
		return processed;
	}

	function applyEnter(opt) {
		var fieldInfo = _getFieldInfo(opt),
			fieldIst = fieldInfo.fieldIst,
			acts, target, processed = undefined;
		if (fieldInfo.isCombo && opt.target.builder && opt.target.builder.popupPicker) {
			return false;
		}
		if (fieldInfo.isEdit) {
			acts = requestActions.getSrvAction("SRV_COMMANDGRID");
			target = true;
			processed = true;
		} else {
			var list = (fieldInfo.target) ? fieldInfo.target.articleParent : null;
			if (popupCardBuilder.isOpened(list)) {
				//TODO : Best way to close popup dialog ??
				popupCardBuilder.togglePopup();
				return false;
			} else {
				acts = requestActions.getSrvAction("SRV_VALIDE_ECRAN");
				processed = true;
			}
		}
		opt.result = {
			"$act": acts
		};
		if (target) {
			opt.result.params = {
				"target": fieldIst
			};
		}
		return processed;
	}

	function applyShortCut(opt) {
		var processed = undefined,
			fieldInfo = _getFieldInfo(opt),
			doEvt, data, acts, fieldIst = fieldInfo.fieldIst,
			target = false;
		var record = fieldInfo.target.articleParent,
			recordIndex = Math.max(fieldInfo.array.filler.getClientDataSetIndex(fieldInfo.array, record.$serverIndex), 0),
			serverIndex = -1;
		var array = fieldInfo.array;
		if (opt.data.shortcuts.down || opt.data.shortcuts.up) {
			if (popupCardBuilder.isOpened(array))
				return false;
			if (opt.data.shortcuts.down) {
				recordIndex = (recordIndex < fieldInfo.array.clientDataset.length - 1) ? recordIndex + 1 : recordIndex;
			} else {
				recordIndex = (recordIndex > 0) ? recordIndex - 1 : recordIndex;
			}
			serverIndex = fieldInfo.array.clientDataset[recordIndex].$serverIndex;
			fieldIst = sapUtil.makeIst(fieldInfo.fieldIst.win, fieldInfo.xid, parseInt(serverIndex, 10) + 1);
			if (!fieldInfo.isEdit) {
				acts = requestActions.getSrvAction("SRV_COMMANDGRID");
				target = true;
				processed = true;
			} else {
				if (fieldInfo.type != syraUtil.dataTypes.choiceType && (fieldInfo.type != syraUtil.dataTypes.dateType || !fieldInfo.popupPicker)) {
					acts = requestActions.getSrvAction("SRV_GETFOCUSCELL");
					target = true;
					processed = true;
				} else {
					return false;
				}
			}
		} else
		if (opt.data.shortcuts["delete"] || opt.data.shortcuts.insert) {
			if (fieldInfo.isEdit)
				return opt.data.shortcuts.insert || !opt.data.shortcuts.shift;
			return false;
		} else
		if (opt.data.shortcuts.left || opt.data.shortcuts.right) {
			if (fieldInfo.isEdit) {
				return false;
			} else {
				fieldIst.xid = record.list.builder[opt.data.shortcuts.right ? "getNextVisibleField" : "getPreviousVisibleField"](fieldIst.xid);
				acts = requestActions.getSrvAction("SRV_COMMANDGRID");
				target = true;
				processed = true;
			}
		} else
		if (opt.data.shortcuts.enter) {
			return applyEnter(opt);
		} else
		if (opt.data.shortcuts.tab) {
			return applyTab(opt);
		} else
		if (opt.data.shortcuts.i) {
			return evtTools.applyKeyI(opt);
		} else
		if (opt.data.shortcuts.d) {
			return evtTools.applyKeyD(opt);
		}
		if (acts) {
			opt.result = {
				"$act": acts
			};
			if (target) {
				opt.result.params = {
					"target": fieldIst
				};
			}
			return processed;
		}
		return false;
	}

	function keyUpCellTab(event) {
		return false;
	}

	function keyDownCellTab(event) {
		return false;
	}

	function getLocalActionLine(fieldInfo, action) {
		var cap = fieldInfo.array && fieldInfo.array.$capability;
		if (!cap || !cap[(action == 'SRV_DELETELINEGRID') ? "delete" : "insert"])
			return null;
		var bind = fieldInfo.$fieldMeta.$bind,
			collName = bind ? sapUtil.getBlockInst(bind) : null;
		if (fieldInfo.winModel.getEntityMetaByCriteria(collName, "_fullyDisabled", collName, -1))
			return null; //grid disable
		if (fieldInfo.winModel.isCollFull(collName))
			return null; // gird full
		if (fieldInfo.array.dataset.length === fieldInfo.nl)
			return null; //Last line
		var acts = requestActions.getSrvAction(action);
		var status = this.sapController.isActionEnabled(fieldInfo.winModel.getWinId(), acts);
		if (status !== null && !status)
			return null;
		return acts;
	}

	function clickCell(event, fieldInfo) {
		// "target":... "type":... "data": {"nativeEvt:..."}
		//_listUtility.selectRecords(fieldInfo.array,fieldInfo.nl-1)
		var processed = undefined,
			acts;
		if (event.target) {
			switch (fieldInfo.type) {
				case syraUtil.dataTypes.booleanType:
					acts = clickCellBoolean.call(this, fieldInfo, fieldInfo.fieldIst);
					break;
				case syraUtil.dataTypes.iconType:
					acts = clickCellIcon.call(this, fieldInfo);
					break;
				case syraUtil.dataTypes.dateType:
					acts = clickCellDefault.call(this, fieldInfo);
					break;
				default:
					acts = clickCellDefault.call(this, fieldInfo);
					if (fieldInfo.data.doEvent) {
						if (acts.send) {
							acts.post = {
								"callback": fieldInfo.data.doEvent,
								"args": []
							};
						}
					}
					break;
			}
			if (acts.send) {
				event.result = {
					"$act": acts.srvAct
				};
				event.result.params = {
					"target": fieldInfo.fieldIst
				}
				event.result.post = acts.post
				processed = true;
			}
		}
		return processed;
	}

	function setFoucusLine(event, fieldInfo, edit) {
		var processed = undefined,
			acts = {
				"send": false,
				"srvAct": null,
				"post": null
			};
		if (event.target) {
			if (edit) {
				acts.srvAct = requestActions.getSrvAction("SRV_GETFOCUSCELL"); // ask for edit
			} else {
				acts.srvAct = requestActions.getSrvAction("SRV_COMMANDGRID"); // ask for focus
			}
			acts.send = true;
			if (event.data.pickerType == "closeCard" && event.data.doEvent) {
				event.data.doEvent();
				delete event.data.doEvent;
			}
			if (fieldInfo.data.doEvent) {
				if (acts.send) {
					acts.post = {
						"callback": fieldInfo.data.doEvent,
						"args": []
					};
				}
			}
		}
		if (acts.send) {
			event.result = {
				"$act": acts.srvAct
			};
			event.result.params = {
				"target": fieldInfo.fieldIst
			}
			event.result.post = acts.post
			processed = true;
		}
		return processed;
	}

	function clickCellDefault(fieldInfo) {
		var acts = {
			"send": false,
			"srvAct": null,
			"post": null
		};
		if (!fieldInfo.hasFocus) { // focus change
			if (fieldInfo.$field.$isReadOnly) {
				acts.srvAct = requestActions.getSrvAction("SRV_COMMANDGRID"); // ask for focus
				acts.send = true;
			} else {
				if (!fieldInfo.firstFocus) { // focus already on this table
					if (fieldInfo.changeLine) {
						acts.srvAct = requestActions.getSrvActionEX("SUP_CELL_EDIT"); //774 SRV_COMMANDGRID + SRV_GETFOCUSCELL
						acts.send = true;
					} else {
						acts.srvAct = requestActions.getSrvAction("SRV_GETFOCUSCELL"); // ask for editing
						acts.send = true;
					}
				} else {
					// focus not on this table
					acts.srvAct = requestActions.getSrvActionEX("SUP_CELL_EDIT"); //774 SRV_COMMANDGRID + SRV_GETFOCUSCELL
					acts.send = true;
				}
			}
		} else {
			if (!fieldInfo.isEdit && !fieldInfo.target.$isReadOnly) { // focus already on this table but fiend not edit mode
				acts.srvAct = requestActions.getSrvAction("SRV_GETFOCUSCELL"); // ask for editing
				acts.send = true;
			}
		}
		return acts;
	}

	function clickCellBoolean(fieldInfo, newIst) {
		var acts = clickCellDefault.call(this, fieldInfo);
		if (!acts.srvAct) {
			if (!fieldInfo.target.$isReadOnly) { // focus on this field
				acts.srvAct = requestActions.getSrvAction("SRV_GETFOCUSCELL"); // SRV_GETFOCUSCELL + SRV_GETFOCUSCELL
				acts.send = true;
			}
		}
		if (!fieldInfo.hasFocus || !fieldInfo.isEdit) { //Only if field does not have already focus or command mode
			var newVal = (fieldInfo.target.currentValue == sapUtil.check.off ? sapUtil.check.on : sapUtil.check.off);
			var actionNext = (acts.srvAct == requestActions.getSrvActionEX("SUP_CELL_EDIT") || (!fieldInfo.firstFocus && !fieldInfo.currIst.edit)) ? requestActions.getSrvAction("SRV_COMMANDGRID") : requestActions.getSrvAction("SRV_GETFOCUSCELL")
			acts.post = {
				"exposeReply": true,
				"callback": evtTools.toggleFieldAfterClick,
				"onErrCallBack": evtTools.restoreFieldAfterClick,
				"args": [this, fieldInfo.target, newIst, newVal, true, actionNext, fieldInfo.target.currentValue, true]
			};
		}
		return acts;
	}

	function clickCellIcon(fieldInfo) {
		var acts = {
			"send": false,
			"srvAct": null,
			"post": null
		};
		if (!fieldInfo.firstFocus) { // focus already on this table
			acts.srvAct = requestActions.getSrvActionEX("SUP_CELL_ICOCLICKFOCUS"); // 776 SRV_GETFOCUSCELL + SRV_KIB
			acts.send = true;
		} else {
			// focus not on this table
			acts.srvAct = requestActions.getSrvActionEX("SUP_CELL_ICOCLICK"); //775 SRV_COMMANDGRID + SRV_GETFOCUSCELL + SRV_KIB
			acts.send = true;
		}
		return acts;
	}

	function onDatePickerClose(event) {
		var processed = undefined,
			fieldInfo;
		if (event.target && (fieldInfo = _getFieldInfo(event)) && fieldInfo.hasFocus) {
			event.result = {
				"$act": requestActions.svcFormat
			};
			event.result.params = svcFmt.buildRqst(svcFmt.fmtSvc.rawToEdit, event.data.internalValue, fieldInfo.currIst.fmt, fieldInfo.type, fieldInfo.currIst);
			event.result.post = {
				"callback": function(succeeded, reply, evtHandlingObj, initialEvent) {
					if (fieldInfo.hasFocus) {
						syraUtil.getFusionPageMeta(initialEvent.target).winModel.setCurrCtxPopup(null);
						initialEvent.data.doStatements({
							"value": svcFmt.getReplyResult(reply)
						});
						delete initialEvent.doStatements;
					}
				},
				"args": [this, event, event.target, fieldInfo]
			};
			processed = true;
		}
		return processed;
	}

	function _getFieldInfo(event) {
		var nl = _getNoLine(event),
			fieldInfo = evtTools.getFieldInfo(syraUtil.getXElement(event.target), nl),
			$fusionPageMeta = syraUtil.getFusionPageMeta(event.target);
		fieldInfo.data = event.data;
		fieldInfo.nl = nl
		fieldInfo.xid = syraUtil.getMetaFromObject(syraUtil.getXElement(event.target)).$bind;
		if (fieldInfo.xid.length == 2) {
			fieldInfo.xid += "1";
			fieldInfo.fieldIst.xid = fieldInfo.xid
		}
		fieldInfo.blockIst = sapUtil.makeIst(fieldInfo.fieldIst.win, sapUtil.getBlockInst(fieldInfo.xid), fieldInfo.nl);
		fieldInfo.currIst = syraUtil.getFusionController(event.target)._sapController.getCurrInst();
		fieldInfo.hasFocus = sapUtil.cmpIst(fieldInfo.currIst, fieldInfo.fieldIst);
		fieldInfo.target = event.target;
		fieldInfo.firstFocus = !sapUtil.cmpIstBlock(fieldInfo.currIst, fieldInfo.fieldIst);
		fieldInfo.changeLine = (!fieldInfo.firstFocus && fieldInfo.currIst.nl != fieldInfo.nl);
		fieldInfo.isEdit = (!fieldInfo.firstFocus && !fieldInfo.changeLine && fieldInfo.currIst.edit);
		fieldInfo.array = syraUtil.getXElementGrid(event.target);
		fieldInfo.isSortedArray = (fieldInfo.array && fieldInfo.array._$orderBy) ? true : false
		fieldInfo.isCardViewField = !fieldInfo.$fieldMeta.$inplace;
		fieldInfo.isCardView = (fieldInfo.target.articleParent && fieldInfo.target.articleParent.popupCard != undefined);
		return fieldInfo;
	}

	function _getNoLine(event) {
		if (event.data) {
			if (event.data.line)
				return event.data.line;
			if (event.data.uuid)
				return event.target.recordsMap[event.data.uuid].$serverIndex + 1
		}
		if (event.target.arrayLevel == "record") {
			return event.target.$serverIndex + 1
		}
		if (event.target.$uuid) {
			return event.target.recordsMap[event.target.$uuid].$serverIndex + 1
		}
		return event.target.articleParent.$serverIndex + 1
	}
};