"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Fusion Grid event handling classes
 */


var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var requestActions = require('../sap/srvactions');

var _evtProcGrid = {};
exports.GridEventHandling = _evtProcGrid;

/* "Server page input" event handling class for "Grid" widget */
_evtProcGrid.sap = function () {
	this.eventListeners = function () {
		return [["wdgt.grid.clickline", focusLine, true, true],
				["wdgt.grid.clickcell", focusCell, true, true]
		];
	};

	function focusLine(event) {
		var processed = undefined, currIst, $fusionPageMeta, newIst, srvAct, focus;
        if (event.target && ($fusionPageMeta = syraUtil.getFusionPageMeta(event.target))) {
 			currIst = this.sapController.getCurrInst();
 			newIst = sapUtil.makeIst($fusionPageMeta.winModel.getWinId(), event.data.xid, event.data.line);
 			focus = sapUtil.cmpIst(currIst, newIst);
			console.log(" focusLine currIst:" + JSON.stringify(currIst) + " newIst:"+JSON.stringify(newIst));
 			if(!focus || currIst.nl != event.data.line) {
 				newIst.nl = event.data.line;
	 			srvAct = requestActions.getSrvAction("SRV_COMMANDGRID");
	            event.result = {"$act": srvAct};
	            event.result.params = {"target": newIst};
	            processed = true;
	        }				
        }
        return processed;
	}
	function focusCell(event) {
		var processed = undefined, currIst, $fusionPageMeta, newIst, srvAct, focus,send=false;
        if (event.target && ($fusionPageMeta = syraUtil.getFusionPageMeta(event.target))) {
 			currIst = this.sapController.getCurrInst();
 			newIst = sapUtil.makeIst($fusionPageMeta.winModel.getWinId(), event.data.xid, event.data.line);
 			focus = sapUtil.cmpIst(currIst, newIst);
			console.log(" focusCell currIst:" + JSON.stringify(currIst) + " newIst:"+JSON.stringify(newIst));
			if(event.target.boxParent.builder._hasFocus()){
				if(!event.target.boxParent.builder._isTableEditing() || !focus){
					srvAct = requestActions.getSrvAction("SRV_GETFOCUSCELL");
					send=true;
				}
			}else{
				//TODO super action SRV_COMMANDGRID+SRV_GETFOCUSCELL
				srvAct = requestActions.getSrvAction("SRV_COMMANDGRID");
				send=true;
			}
			if(send){
				newIst.nl = event.data.line;
				event.result = {"$act": srvAct};
				event.result.params = {"target": newIst};
				processed = true;	
			}
        }
        return processed;
	}
};
