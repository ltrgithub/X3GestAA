"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Fusion Window event handling classes
 */


var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var requestActions = require('../sap/srvactions');
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;

var _evtProcWindow = {};
exports.WindowEventHandling = _evtProcWindow;

/* "Server page input" event handling class for "Window" */
_evtProcWindow.sap = function () {
	this.eventListeners = function () {
		return [["wdgt.win.keydown", onKeyDown, true, true],
				["wdgt.win.click", onClick, true, true],
				["wdgt.win.dblclick", onDblClick, true, true]
		];
	};

	function onKeyDown(event) {
		var processed = undefined;
        if (event.target) {
			if (event.data.nativeEvt.keyCode == keys["VK_TAB"]) {
	            event.result = {"$act": requestActions.getSrvAction(event.data.nativeEvt.shiftKey ? "SRV_CHAMP_PRECEDENT" : "SRV_CHAMP_SUIVANT")};
	            processed = true;
	        }
        }
        return processed;
	}

	function onDblClick(event) {
		var processed = true;
        return processed;
	}

	function onClick(event) {
		var processed = undefined, $$field, $field, id, readlId, fieldIst, currIst, $$cont;
		if (event.target && ($$field = $(event.data.nativeEvt.target))) {
			id = $$field.attr("id")
			if(id && (readlId = id.lastIndexOf("-input"))) {
				$field = event.target.syraModel.idMap[id.substring(0, readlId)];
				if ($field && $field.$item && $field.$item.$bind && ((event.target.getProto())[$field.$item.$bind])){
		 			fieldIst = sapUtil.makeIst(event.target.getWinId(), $field.$item.$bind);
		 			currIst = this.sapController.getCurrInst();
					if(!sapUtil.cmpIst(currIst, fieldIst)) {
						event.target.setFocus(currIst.xid, (currIst.nl || 0), (currIst.edit === null || currIst.edit === undefined ? true : currIst.edit));
						event.result = {"$act": requestActions.getSrvAction("SRV_GETFOCUS")};
						event.result.params = {"target": fieldIst};
						processed = true; 				
					}
					else {
						processed = true;
					}
				}
			}			
			else if(($$cont = $$field.closest(".s-page-data")) && $$cont.length > 0){
				currIst = this.sapController.getCurrInst();
				event.target.setFocus(currIst.xid, (currIst.nl || 0), (currIst.edit === null ? true : currIst.edit));
			}
		}
        return processed;
	}
};
