"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Fusion Window event handling classes
 */


var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var requestActions = require('../sap/srvactions');
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;

var _evtProcWindow = {};
exports.WindowEventHandling = _evtProcWindow;

/* "Server page input" event handling class for "Window" */
_evtProcWindow.sap = function () {
	this.eventListeners = function () {
		return [["wdgt.win.keydown", onKeyDown, true, true],
				["wdgt.win.click", onClick, true, true],
				["wdgt.win.dblclick", onDblClick, true, true]
		];
	};

	function onKeyDown(event) {
		var processed = undefined, $$field = $(event.data.nativeEvt.target), $$cont;
        if (event.target) {
	        switch (event.data.nativeEvt.keyCode) {
	            case keys["VK_TAB"] :
	            	if (!($$cont = $$field.closest("." + syraUtil.pageSectionK.bar)) || $$cont.length == 0 || event.data.nativeEvt.target.tagName.toLowerCase() != "input") {
	            		// TODO : le if ci-dessus permet de gérer les input dans liste gauche... mais pas bon pour autant... à reprendre!
			            event.result = {"$act": requestActions.getSrvAction(event.data.nativeEvt.shiftKey ? "SRV_CHAMP_PRECEDENT" : "SRV_CHAMP_SUIVANT")};
			            processed = true;            		
	            	}
	                break;
	        }
        }
        return processed;
	}

	function onDblClick(event) {
		var processed = true;
        return processed;
	}

	function onClick(event) {
		var processed = undefined, $$field, $field, id, readlId, fieldIst, currIst, $$cont, $$grid, self = this;
		if (event.target && ($$field = $(event.data.nativeEvt.target))) {
			id = $$field.attr("id");
			if(id && (readlId = id.lastIndexOf("-input"))) {
				$field = event.target.syraModel.idMap[id.substring(0, readlId)];
				if ($field && $field.$item && $field.$item.$bind && ((event.target.getProto())[$field.$item.$bind])){
					// We are on one of ours list blok fields
		 			fieldIst = sapUtil.makeIst(event.target.getWinId(), $field.$item.$bind);
		 			currIst = this.sapController.getCurrInst();
					if(!sapUtil.cmpIst(currIst, fieldIst)) {
						event.result = {"$act": requestActions.getSrvAction("SRV_GETFOCUS")};
						event.result.params = {"target": fieldIst};
						processed = true; 				
					}
					else {
						processed = true;
					}
				}
				else{
					// Let it be!
				}
			}			
			else if((($$cont = $$field.closest("." + syraUtil.pageSectionK.body)) && $$cont.length > 0) || _.find(syraUtil.pageSectionK, function(cssK) {return $$field.hasClass(cssK);})){
				// So, check if it's a grid or one of these children...
				if($$cont && ($$grid = $$field.closest("." + syraUtil.gridFusionK.cont)) && $$grid.length > 0 && (id = $$grid.attr("id"))) {
					$field = event.target.syraModel.idMap[id];
					if ($field && $field.$item && $field.$item.$bind && ((event.target.getProto())[$field.$item.$bind])){
						setTimeout(function(){$field.onClick(self.sapController, event.data.nativeEvt);}, 0);
						return true;
						// TODO : à reprendre!
						//processed = $field.onClick(this.sapController, event.data.nativeEvt);
					}
				}
				else {
					currIst = this.sapController.getCurrInst();
					event.target.setFocus(currIst.xid, (currIst.nl || 0), (currIst.edit === null ? true : currIst.edit));
					processed = true;
				}
			}
		}
        return processed;
	}
};
