"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Common tools for Fusion event handling
 */
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var svcFmt = require('syracuse-ui/lib/fusion/core/tools/format').svcFormatter;

exports.CommonEventHandlingTools = {
    openDatePicker: function(succeeded, result, evtHandlingObj, initialEvent, field, callerFieldInfo){
        var session;
        if (evtHandlingObj.sapController.hasFocus(callerFieldInfo.fieldIst) && !syraUtil.getPopupDateFromField(field)) {
            if (succeeded) {
                initialEvent.data.doEvent(result ? {
                    "internalValue": parseInt(svcFmt.getReplyResult(result), 10)
                } : null);
                callerFieldInfo.winModel.setCurrCtxPopup(field);
            }
            else {
                session = (evtHandlingObj.sapController.getSiteController()).getSession();
                callerFieldInfo.winModel._showFieldError(field, [session.getlabel("error", "22", "Date entered is invalid; calendar can not be opened")]);
            }
        }
        delete initialEvent.data.doEvent;
    },
    getFieldInfo: function(field,nl){
        var fieldInfo = {
            "readOnlyByModel": false,
            "isRadio": false,
            "isCheck": false,
            "isCombo": false,
            "isIco": false,
			"isDate" : false
        };
        if (field && (fieldInfo.$fusionPageMeta = syraUtil.getFusionPageMeta(field)) && (fieldInfo.$fieldMeta = syraUtil.getMetaFromObject(field)) && ((fieldInfo.$fusionPageMeta.winModel.getProto())[fieldInfo.$fieldMeta.$bind] || field.arrayLevel==="cell")) {
            fieldInfo.fieldIst = sapUtil.makeIst(fieldInfo.$fusionPageMeta.winModel.getWinId(), fieldInfo.$fieldMeta.$bind,nl||0);
            fieldInfo.readOnlyByModel = syraUtil.isFieldModelReadOnly(fieldInfo.$fusionPageMeta.winModel.getProto(), null, fieldInfo.$fieldMeta.$bind);
            fieldInfo.winModel = fieldInfo.$fusionPageMeta.winModel;
            fieldInfo.type = syraUtil.getFieldType(field);
            if ((fieldInfo.$field = field.$field)) {
                fieldInfo.isCheck = fieldInfo.$field.$type == syraUtil.dataTypes.booleanType ? true : false;
                if (!fieldInfo.isCheck && fieldInfo.$field.$type == syraUtil.dataTypes.choiceType) {
                    fieldInfo.isRadio = fieldInfo.$field.$format == syraUtil.wdgtTypes.radio ? true : false;
                    fieldInfo.isCombo = !fieldInfo.isRadio;
                }
                else {
                    fieldInfo.isIco = fieldInfo.$field.$type == syraUtil.dataTypes.iconType ? true : false;
                }
            }
        }
        return fieldInfo.$field ? fieldInfo : null;
    }
}
