"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
/**
 * @fileoverview Fusion "Tabs" event handling classes
 */
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var requestActions = require('../sap/srvactions');

var _evtProcTabs = {};
exports.TabsEventHandling = _evtProcTabs;

/* "Server page input" event handling class for "Tabs" widget */
_evtProcTabs.sap = function() {
	this.eventListeners = function() {
		return [
			["wdgt.tabs.toggle", beforeToggle, true, true], ["wdgt.tabs.toggled", afterToggle], ["wdgt.tabs.click", onClick, true, true]];
	};

	function beforeToggle(event, tabXid) {
		var processed = undefined,
			tabIst, $fusionPageMeta, self = this,
			callback, internalToggle = (event.data.nativeEvenData && event.data.nativeEvenData.internal) ? true : false;
		if (event.target && event.data.open && tabXid && ($fusionPageMeta = syra_fusion.syraUtil.getFusionPageMeta(event.target))) {
			tabIst = sapUtil.makeIst($fusionPageMeta.winModel.getWinId(), sapUtil.specialScrnId.gfolder, 0);
			if (!this.sapController.hasFocus(tabIst) && !internalToggle) {
				event.result = {
					"$act": requestActions.getSrvAction("SRV_GETFOCUS")
				};
				event.result.params = {
					"target": tabIst
				};
				event.result.post = {
					"callback": function() {
						event.data.doEvent();
						afterToggle.call(self, event, tabXid, $fusionPageMeta);
						delete event.data.doEvent;
					},
					"args": []
				};
				processed = true;
			} else if (internalToggle) {
				event.data.doEvent();
				delete event.data.doEvent;
				afterToggle.call(this, event, tabXid, $fusionPageMeta, true);
				event.data.nativeEvenData.ok = true;
				if ((callback = event.data.nativeEvenData.callback)) {
					callback();
				}
				processed = true;
			}
		}
		return processed;
	}

	function afterToggle(event, tabXid, fusionPageMeta, noFocus) {
		// Apply change on tab containers
		var $fusionPageMeta = fusionPageMeta || syra_fusion.syraUtil.getFusionPageMeta(event.target);
		if (event.data.open && event.data.isFirstTime && $fusionPageMeta && tabXid) {
			$fusionPageMeta.winModel.setContainerPending(tabXid);
		}
		// Set current tab Idx
		this.sapController.setCurrTab(tabXid, event.data.tabIdx);
		if ($fusionPageMeta && !noFocus) {
			syra_fusion.syraUtil.setTabFocus(event.target);
		}
		return undefined;
	}

	function onClick(event, tabXid) {
		var processed = undefined,
			tabIst, $fusionPageMeta;
		if (event.target && tabXid && ($fusionPageMeta = syra_fusion.syraUtil.getFusionPageMeta(event.target))) {
			tabIst = sapUtil.makeIst($fusionPageMeta.winModel.getWinId(), sapUtil.specialScrnId.gfolder, 0);
			if (!this.sapController.hasFocus(tabIst)) {
				event.result = {
					"$act": requestActions.getSrvAction("SRV_GETFOCUS")
				};
				event.result.params = {
					"target": tabIst
				};
				processed = true;
			}
		}
		return processed;
	}
};