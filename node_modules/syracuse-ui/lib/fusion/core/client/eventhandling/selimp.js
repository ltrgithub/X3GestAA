"use strict";

/*
 Copyright (c)2012 Sage.
 http://wwww.sage.com
 */
 /**
 * @fileoverview Fusion "Selimp et cie" windows event handling classes
 */

var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var requestActions = require('../sap/srvactions');

var _evtProcSelimp = {};
exports.SelimpEventHandling = _evtProcSelimp;

/* "Server page input" events handling class for "Selimp et cie" controls */
_evtProcSelimp.sap = function() {
	this.eventListeners = function() {
		return [
			["wdgt.link.click", onClick, true, true],
			["wdgt.win.close", onClose, true, true],
			["wdgt.record.picker", onClickRcdPicker, true, true],
			["wdgt.record.action", onActRcd, true, true],
			["wdgt.grid.selline", onSelRcd, true, true],
			["wdgt.cell.click", onClickCell, true, true]
		];
	};

	function _isEvtFromExtendDialog(printerController) {
		return printerController.dialogStack.length === 2;
	}

	function _getSelectedPrinter(gridObj, ctx, record, justName) {
		var rcdDataset = record || (gridObj ? (ctx && ctx.uuid ? gridObj.recordsMap[ctx.uuid].dataset : (gridObj.getArticle()).dataset) : null);
		return rcdDataset ? (justName ? rcdDataset.name : rcdDataset) : (justName ? "" : null);
	}

	function _getActionRqst(printerController, linkId, data, rqst) {
		var ret = {"closeLink": true}, extdDiag = _isEvtFromExtendDialog(printerController), act = null, rqstData;
		rqst.params = {"notModified": true, "selpr": {}};
		rqstData = rqst.params.selpr;
		switch (linkId) {
			case "$save":
				if(extdDiag) {
					act = "PRINTER_OPTS_OK";
					rqstData.todo = "...";
				}
				else {
					act = "PRINTER_SEL_OK";
					rqstData.selected = {"name" :_getSelectedPrinter(null, null, data, true)};
				}
				break;
			case "$properties":
				act = "PRINTER_SEL_OPTS";
				rqstData.printerName = _getSelectedPrinter(null, null, data, true);
				ret.closeLink = false;
				break;
			default:
				act = extdDiag ? "PRINTER_OPTS_CANCEL" : "PRINTER_SEL_CANCEL";
				break;
		}
		if(act) {
			rqst.$act = requestActions.getProxyAction(act);
		}
		else {
			ret = null;
		}
		return ret;
	}

	function onActRcd(event) {
		var processed = undefined, prtSelected, ret, linkId;
		if ((linkId = event.target.$bind) && linkId !== "$recordCard") {
			if((prtSelected = _getSelectedPrinter(event.target, event.data))) {
				event.result = {};
				ret = _getActionRqst(this.printerController, linkId, prtSelected, event.result);
				processed = ret ? true : processed;
			}
		}
		return processed;
	}

	function onSelRcd(event) {
		var processed = undefined;
		this._currPrinterRcd = _getSelectedPrinter(event.target, event.data);
		return processed;
	}

	function onClickCell(event) {
		var processed = undefined;
		this._currPrinterRcd = _getSelectedPrinter(event.target);
		return processed;
	}

	function onClickRcdPicker(event) {
		var processed = undefined;
		this._currPrinterRcd = event.target ? event.target.dataset : null;
		return processed;
	}

	function onClick(event) {
		var processed = undefined, linkId = null, ret, dialogMeta, selectedPrtRcd = null;
		if (event.target && (linkId = event.target.$bind)) {
			if(this._currPrinterRcd !== null && this._currPrinterRcd !== undefined) {
				selectedPrtRcd = this._currPrinterRcd;
			}
			else {
				selectedPrtRcd = this.printerController.dialogStack[0].context.defaultPrinterRcd;
			}
			event.result = {};
			if((ret = _getActionRqst(this.printerController, linkId, selectedPrtRcd, event.result))) {
				if(ret.closeLink) {
					delete this._currPrinterRcd;
					dialogMeta = this.printerController.unstackDialog();
					this.sapController.stubWinClose([dialogMeta.id], null, {});
				}
				processed = true;
			}
		}
		return processed;
	}

	function onClose(event) {
		if(!event.target) {
			event.target = {};
		}
		event.target.$bind = "$cancel";
		return onClick.call(this, event);
	}
};