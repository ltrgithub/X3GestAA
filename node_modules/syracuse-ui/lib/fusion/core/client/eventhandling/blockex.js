"use strict";
var evtTools = require('../eventhandling/common').CommonEventHandlingTools;
var requestActions = require('../sap/srvactions');
var util = require('syracuse-ui/lib/fusion/tools/util');

/**
 * @fileoverview Fusion "Graphical block" event handling classes
 */
var _evtProcBlockEx = {};
exports.BlockExEventHandling = _evtProcBlockEx;

/* "Server page input" events handling class for "Graphical block" controls*/
_evtProcBlockEx.sap = function() {
	this.eventListeners = function() {
		return [
			["wdgt.graph.picker", onClickPicker, true, true], ["wdgt.xblock.rpc", onCallSP, true, true]];

	};

	function _setSerieMenuCtx(reply, evtHandlingObj, initialEvent, target, targeInfo, rcdUuid, forceEmpty) {
		var ctxEx = [],
			ctx = evtHandlingObj.sapController.getTargetCtxMenuFromReply(reply);
		if (!forceEmpty && ctx && ctx.length > 0) {
			_.each(ctx, function(item, idx) {
				this.push({
					"$title": item[2],
					"linkId": item[0]
				});
			}, ctxEx);
		}
		initialEvent.data.doEvent(null, ctxEx);
		delete initialEvent.data.doEvent;
	}

	function _onErrSerieMenuCtx(ctrlFailed, reply, evtHandlingObj, initialEvent, target, targeInfo, rcdUuid, forceEmpty) {
		initialEvent.data.doEvent();
	}

	function onCallSP(event) {
		var ackCallRqst, processed = undefined;
		var fieldInfo = evtTools.getFieldInfo(event.target);
		var targetIst = fieldInfo ? _ensureIstFormFieldInfo(fieldInfo) : _ensureIstFromTarget(event.target);
		if (event.target && event.data && targetIst) {
			if (this.sapController.buildAckCallRqst(event, targetIst, event.data.call, event.data.callFunc)) {
				processed = true;
			} else {
				event.data.doEvent = event.data.call && event.data.call.callback || event.data.doEvent;
			}
		} else {
			// Let it be... improve!
		}
		return processed;
	}

	function _ensureIstFormFieldInfo(fieldinfo) {
		if (fieldinfo.type == syra_fusion.syraUtil.dataTypes.collectionType && fieldinfo.fieldIst && syra_fusion.sapUtil.isBlockInst(fieldinfo.fieldIst.xid)) {
			return syra_fusion.sapUtil.makeIst(fieldinfo.fieldIst.win, fieldinfo.fieldIst.xid + "2", fieldinfo.fieldIst.nl ? fieldinfo.fieldIst.nl : 1);
		}
		return fieldinfo.fieldIst;
	}

	function _ensureIstFromTarget(target) {
		var xid, winId, ist = null,
			objMeta = target ? syra_fusion.syraUtil.getMetaFromObject(target) : null;
		if (objMeta) {
			xid = objMeta[syra_fusion.sapUtil.metaNameMap.xid];
			winId = syra_fusion.syraUtil.getFusionPageMeta(target);
			if (xid && winId && (winId = winId.winModel) && (winId = winId.getWinId())) {
				// Try to retrieve instance  for special entities... to complete if necessary
				if (syra_fusion.sapUtil.isTabScreen(xid)) {
					ist = syra_fusion.sapUtil.makeIst(winId, syra_fusion.sapUtil.specialScrnId.gfolder, null, true);
				}
			}
		}
		return ist;
	}

	function onClickPicker(event) {
		var processed = undefined,
			hasFocus, fieldInfo, isArrayOnEdit = null,
			act, collName, forceEmptyCtx = false;
		if (event.target && event.target.attachedField && (fieldInfo = evtTools.getFieldInfo(event.target.attachedField, null))) {
			hasFocus = this.sapController.hasFocus(fieldInfo.fieldIst, null, null, true, true);
			switch (event.data.pickerType) {
				case "menus":
					if (event.data.grapLevel && event.data.grapLevel == "measure") {
						if (fieldInfo.type == syra_fusion.syraUtil.dataTypes.collectionType) {
							collName = syra_fusion.sapUtil.getBlockInst(fieldInfo.$fieldMeta.$bind);
							isArrayOnEdit = (hasFocus && (isArrayOnEdit = this.sapController.getCurrInst()) ? isArrayOnEdit.edit : false);
							act = !isArrayOnEdit ? requestActions.getSrvActionEX("SUP_CELL_FOCUS_CTX") : requestActions.getSrvAction("SRV_ABANDONLINE");
							fieldInfo.fieldIst.nl = isArrayOnEdit ? 0 : (event.data.rcdUuid !== null ? fieldInfo.winModel.getCollRcdIdx(collName, event.data.rcdUuid, false) : event.data.rcdLineId);
							forceEmptyCtx = isArrayOnEdit; // TODO : improve ==> super act SRV_ABANDONLINE + SRV_COMMANDGRID + SRV_OPEN_CTXMENU
						} else {
							act = hasFocus ? requestActions.getSrvAction("SRV_OPEN_CTXMENU") : requestActions.getSrvAction("SUP_FIELD_CTX");
						}
						event.result = {
							"$act": act,
							"params": {
								"target": fieldInfo.fieldIst
							}
						};
						event.result.post = {
							"exposeReply": true,
							"callback": _setSerieMenuCtx,
							"onErrCallBack": _onErrSerieMenuCtx,
							"args": [this, event, event.target, fieldInfo, event.data.rcdUuid, forceEmptyCtx]
						};
						processed = true;
					}
					break;
				default:
					break;
			}
		} else {
			// Let it be... improve!
		}
		return processed;
	}

};