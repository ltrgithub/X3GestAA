"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Designer = require("syracuse-ui/lib/authoring/designer").Designer;

function ListDesigner() {}

exports.ListDesigner = helpers.defineClass(ListDesigner, Designer, {
	loadBox: function(designedPage) {
		this.$prototype = {
			$properties: {
				$cardPosition: {
					$type: "application/x-choice",
					$title: this.localize.lw_cardPosition,
					$value: {
						$type: "application/x-string",
						$enum: [{
							$value: "no",
							$title: this.localize.lw_cardPositionNo
						}, {
							$value: "inline",
							$title: this.localize.lw_cardPositionInline
						}, {
							$value: "top",
							$title: this.localize.lw_cardPositionTop
						}, {
							$value: "left",
							$title: this.localize.lw_cardPositionLeft
						}, {
							$value: "right",
							$title: this.localize.lw_cardPositionRight
						}, {
							$value: "bottom",
							$title: this.localize.lw_cardPositionBottom
						}]
					}
				},
				$graphPosition: {
					$type: "application/x-choice",
					$isHidden: this.awArticle.$prototype.$cube ? false : true,
					$title: this.localize.lw_graphPosition,
					$value: {
						$type: "application/x-string",

						$enum: [{
							$value: "top",
							$title: this.localize.lw_graphPositionTop
						}, {
							$value: "left",
							$title: this.localize.lw_graphPositionLeft
						}, {
							$value: "right",
							$title: this.localize.lw_graphPositionRight
						}, {
							$value: "bottom",
							$title: this.localize.lw_graphPositionBottom
						}, {
							$value: "front",
							$title: this.localize.lw_graphPositionFront
						}, {
							$value: "behind",
							$title: this.localize.lw_graphPositionBehind
						}]
					}
				}
			}
		};
		this.$item = {
			$layout: {
				$items: []
			}
		};
		Designer.prototype.loadBox.call(this);
		this._initializeDesigner();
	},
	_initializeDesigner: function() {
		var delta = {
			$format: this.awArticle.$item.$format || "grid",
			$graphPosition: this.awArticle.$item.$graphPosition || "bottom"
		};
		if (this.awArticle.$item.$cards) {
			delta.$cardPosition = this.awArticle.$item.$cards.$position || "bottom";
		} else {
			delta.$cardPosition = this.awArticle.builder.$inlineCard ? "inline" : "no";
		}
		this.applyChange(delta);
	},
	onClickPicker: function(picker) {
		if (picker.syraPickerType) {
			switch (picker.syraPickerType) {
				case "$colcount":
					this.awArticle.applyDesignMetaData({
						$cardsByRowCount: picker.$syraColCount
					}, true);
					this.templatesTool.selectColChoice(this.sectionCards, this.awArticle, picker.$syraColCount);
					this.historyTool.notifyUpdate();
					return false;

				case "$format":
					var metaData = {
						$format: picker.syraFormat
					};
					this.awArticle.applyDesignMetaData(metaData, true);
					this.historyTool.notifyUpdate();
					this.applyChange(metaData);
					return false;
			}
			return Designer.prototype.onClickPicker.call(this, picker);
		}
		return true;
	},
	drawBox: function() {
		this.layoutSlot = document.createElement("aside");
		this.layoutSlot.className = "s-listdesigner";
		this.awArticle._core.parentNode.insertBefore(this.layoutSlot, this.awArticle._core);
		this.layoutSlot.style.display = "";
		this.$$item = this.$$body = $(this.layoutSlot);
		this.settingsSlot = document.createElement("div");
		this.settingsSlot.className = "s-listdesigner-settings";
		this.layoutSlot.appendChild(this.settingsSlot);
		this.navSlot = document.createElement("div");
		this.navSlot.className = "s-listdesigner-nav";
		this.layoutSlot.appendChild(this.navSlot);
		this.awItem = this.awArticle;

		this.loadDefaultTools("s-listdesigner-history", "s-listdesigner-wc");
		this.loadTemplateTools();

		this.appendFormat();
		this.loadNewItem(this.formats.gridSlot, {
			$bind: "$cardPosition",
			$contentEditable: true,
			$isTopLabelAlignment: false,
			$isEditMode: true,
			$skin: "s-aw-field"
		});

		this.sectionCards = {
			body: this.formats.cardsSlot
		};
		this.templatesTool.addColsCountLinks(this.sectionCards, this.awItem, this.awArticle.builder.$cardsByRowCount || 1, 6);

		this.sectionGraph = {
			body: this.settingsSlot.appendChild(document.createElement("div"))
		};
		this.sectionGraph.body.style.display = this.awArticle.$prototype.$cube ? "" : "none";
		this.sectionGraph.body.className = "s-aw-list-graph-slot";

		var div = document.createElement("div");
		div.textContent = this.localize.aw_graph;
		this.sectionGraph.body.appendChild(div).className = "s-aw-list-graph-title";
		this.loadNewItem(this.sectionGraph.body, {
			$bind: "$graphPosition",
			$contentEditable: true,
			$isTopLabelAlignment: false,
			$skin: "s-aw-field",
			$isEditMode: true,
			$format: "$combo"
		});

		this.navSlot.appendChild(this.historySlot);
		//	this.navSlot.appendChild(this.workinCopySlot);

		var $fieldCube = this.awArticle.$item.$cube || this.awArticle.$prototype.$cube;
		this.fieldMeasures = [];
		if ($fieldCube && $fieldCube.$measures) {
			var $itemCube = this.awArticle.$item.$cube || {};
			var $itemMeasures = $itemCube.$measures || {};
			var delta = {};
			var binds = Object.keys($fieldCube.$measures);
			for (var ii = 0, jj = binds.length; ii < jj; ii++) {
				var bind = binds[ii];
				var $measure = $fieldCube.$measures[bind];
				var $field = {
					$type: "application/x-choice",
					$title: "",
					$value: {
						$type: "application/x-string",
						$enum: []
					}
				};
				var $choices = ["area", "areaspline", "column", "line", "scatter", "spline", "pie"];
				for (var mm = 0, kk = $choices.length; mm < kk; mm++) {
					$field.$value.$enum.push({
						$value: $choices[mm],
						$title: this.localize[$choices[mm]] || $choices[mm]
					});
				}
				$field.$title = $measure.$title ? this.awArticle.page.getLocalizeText($measure.$title) : "";
				this.$prototype.$properties["$cube" + bind] = $field;
				this.fieldMeasures.push(this.loadNewItem(this.sectionGraph.body, {
					$category: "field",
					$bind: "$cube" + bind,
					$measure: bind,
					$isTopLabelAlignment: false,
					$icon: {
						$inputMode: "icon",
						$mode: "icon",
						$path: "graphics/s-graph-"
					},
					$choiceLayout: "3",
					$isEditMode: true,
					$skin: "s-aw-field"
				}));
				delta["$cube" + bind] = ($itemMeasures[bind] ? $itemMeasures[bind].$style : null) || "area";
			}
			this.applyChange(delta);
		}
		this.awArticle.pagging.designItem(true);
		document.site.resize();
	},
	appendFormat: function() {
		this.formats = {
			grid: document.createElement("a"),
			cards: document.createElement("a"),
			gridSlot: document.createElement("div"),
			cardsSlot: document.createElement("div"),
		};
		this.formats.grid.title = this.formats.grid.textContent = this.localize.lw_gridMode;
		this.formats.cards.title = this.formats.cards.textContent = this.localize.lw_cardMode;
		this.formats.grid.className = "s-aw-list-format-grid";
		this.formats.cards.className = "s-aw-list-format-cards";
		var table = document.createElement("div");
		var row = document.createElement("div");
		row.className = "s-aw-list-formats-row";
		row.appendChild(this.formats.cards).setAttribute("data-s-picker", this.formats.cards.syraPickerType = "$format");
		row.appendChild(this.formats.grid).setAttribute("data-s-picker", this.formats.grid.syraPickerType = "$format");
		var sep = document.createElement("div");
		sep.className = "s-aw-list-formats-sep";
		row.appendChild(sep);
		this.formats.cards.syraFormat = "cards";
		this.formats.grid.syraFormat = "grid";
		this.formats.gridSlot.style.display = "none";
		this.formats.gridSlot.className = "s-aw-list-cards-slot";
		row.appendChild(this.formats.gridSlot);
		this.formats.cardsSlot.style.display = "none";
		this.formats.cardsSlot.className = "s-aw-list-cards-slot";
		row.appendChild(this.formats.cardsSlot);
		table.className = "s-aw-list-formats";
		table.appendChild(row);
		this.settingsSlot.appendChild(table);
	},
	applyChange: function(newData) {
		if (newData) {
			newData.$properties = newData.$properties || {};
			if (newData.$format) {
				var delta = newData.$properties = newData.$properties || {};
				this.formats.grid.className = "s-aw-list-format-grid";
				this.formats.cards.className = "s-aw-list-format-cards";
				if (newData.$format == "cards") {
					this.formats.cardsSlot.style.display = "";
					this.formats.gridSlot.style.display = "none";
				} else {
					this.formats.cardsSlot.style.display = "none";
					this.formats.gridSlot.style.display = "";
				}
				this.formats[newData.$format].className += " s-selected";
			}
			if (newData.$graphPosition !== undefined) {
				var show = newData.$graphPosition == "behind" ? "none" : "";
				if (this.fieldMeasures) {
					for (var ii = 0, jj = this.fieldMeasures.length; ii < jj; ii++) {
						this.fieldMeasures[ii]._domItem.style.display = show;
					}
				}
			}
		}
		Designer.prototype.applyChange.call(this, newData);
	},

	onNotifyDataChange: function(field, value) {
		var metaData = {};
		var $bind = field.$item.$bind;
		metaData[$bind] = value;
		if (this.awArticle.isList && field.$item.$measure) {
			var $cube = this.awArticle.$item.$cube || {};
			$cube.$measures = $cube.$measures || {};
			($cube.$measures[field.$item.$measure] = $cube.$measures[field.$item.$measure] || {}).$style = value;
			this.awArticle.applyDesignMetaData({
				$cube: $cube
			}, true);
		} else {
			if (metaData.$cardPosition !== undefined && !(metaData.$cardPosition == "no" || metaData.$cardPosition == "inline")) {
				if (this.awArticle.$item.$graphPosition == "front" || this.awArticle.$item.$graphPosition == "behind") {
					metaData.$graphPosition = "bottom";
				}
			}
			this.awArticle.applyDesignMetaData(metaData, true);
		}
		this.applyChange(metaData);
		this.historyTool.notifyUpdate();
		return false;
	},
	onEndHistoryChangeStep: function() {
		this._initializeDesigner();
	},
	onWindowResize: function() {},
	dispose: function() {
		if (this.awArticle && this.awArticle.pagging) {
			this.awArticle.pagging.designItem(false);
		}
		this.fieldMeasures = this.formats = null;
		document.site.removeDomChild(this.layoutSlot);
		Designer.prototype.dispose.call(this);
	}
});