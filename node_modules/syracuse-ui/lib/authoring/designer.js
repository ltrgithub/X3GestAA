"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var designLocalization = require("syracuse-ui/lib/authoring/designLocalization");
var HistoryTool = require("syracuse-ui/lib/authoring/tools/historyTool").HistoryTool;

var TemplatesTool = require("syracuse-ui/lib/authoring/tools/templatesTool").TemplatesTool;

//temporalySave

function Designer() {}

exports.Designer = helpers.defineClass(Designer, RawPage, {
	addClosePicker: function(slot) {
		var link = document.createElement("a");
		link.setAttribute("data-s-picker", link.syraPickerType = "close-designer");
		link.title = this.localize.aw_close;
		link.className = "s-aw-designer-close";
		slot.appendChild(link);
	},
	onEndHistoryChangeStep: function(itemToSelect) {},
	endArticleUpdate: function(selectedItem, isStructureUpdated) {
		this.designedArticle.page.layoutValidator.validate(this.designedArticle.page.layoutContent, true);
		if (this.historyTool) {
			this.historyTool.notifyUpdate();
		}
		this.saveArticleUpdate();
	},
	loadHistoryTool: function() {
		(this.historyTool = new HistoryTool()).load(this);
	},
	toggleUIDesign: function(item, enable, disposingDesigner) {
		if (this.uiSwitchTool) {
			this.uiSwitchTool.toggleUIDesign(item, enable, disposingDesigner);
		}
	},
	showAdvancedItem: function(item, $isAdvanced) {
		if (this.uiSwitchTool) {
			this.uiSwitchTool.toggleUIDesign(item, $isAdvanced);
		}
	},
	showHiddenItem: function(item) {
		if (this.uiSwitchTool) {
			this.uiSwitchTool.showHiddenItem(item);
		}
	},
	applyChangeToMobile: function($article) {
		if (document.site.mobileGateway) {
			document.site.mobileGateway.applyChange($article);
		}
	},
	showTargetPageDiagnoses: function(message, options) {
		this.designedArticle.showDiagnoses(message, options);
		if (document.site.mobileGateway) {
			document.site.mobileGateway.onShowTargetPageDiagnoses(message, options);
		}
	},
	_toggleDesignDialog: function(begin) {
		this.designedArticle.page.dialogWrapper.$$closeBtn[0].style.display = begin ? "none" : "";
		this.designedArticle.page.dialogWrapper.overlay.className = begin ? "s-aw-overlay" : "s-overlay";
	},

	openDesigner: function(designedArticle) {
		this.localize = designLocalization.getLocalize();
		this.designedArticle = designedArticle;
		this.designedArticle.designer = this;
		this.designedArticle.isDesigned = true;
		this.$prototype = {
			$properties: {},
			$links: {}
		};
		this.$item = {};
		this.$autoFetch = false;
		if (this.designedArticle.page == this.designedArticle) {
			(this.diagnosePage = this.designedArticle).clearUnknowFields();
			this.showTargetPageDiagnoses({
				$diagnoses: null
			});
		}
		if (this.designedArticle.page.dialogWrapper) {
			this._toggleDesignDialog(true);
		}
		if (designedArticle.$prototype && designedArticle.$prototype.$article) {
			//imortant save article for page
			designedArticle.$prototype.$article = helpers.object.clone(designedArticle.$prototype.$article, true);
		}
		this.loadBox(designedArticle);
		if (this.designedArticle.pageViewSelector) {
			this.designedArticle.pageViewSelector.disable(true);
		}
	},
	notifyDataChange: function(field, value) {
		this.saveArticleUpdate();
		var metaData = {};
		metaData[field.$item.$bind] = value;
		this.designedItem.applyDesignMetaData(metaData, true);
		this.historyTool.notifyUpdate();
		this.applyChange(metaData);
	},


	loadTemplateTools: function() {
		(this.templatesTool = new TemplatesTool()).load(this);
	},
	onClickPicker: function(picker) {
		if (picker.syraPickerType) {
			if (picker.syraPickerType == "close-designer") {
				var self = this;
				setTimeout(function() {
					self.closeDesigner();
				}, 100);
				return false;
			} else {
				if (this.historyTool && this.historyTool.onClickPicker(picker)) {
					return false;
				}
				if (this.templatesTool) {
					var templateResult = this.templatesTool.onTemplateChoiceClick(picker, this.designedItem, this.awLayout);
					if (templateResult) {
						this.endArticleUpdate(templateResult, true);
						return false;
					}
				}
				if (this.helpLink == picker) {
					return true;
				}
			}
		}
		return true;
	},
	findItem: function(domItem, findLayout, event) {
		var article;
		if (domItem.syraDesigneArticle) {
			var page = document.site.pagesMap[domItem.syraDesignePage];
			if (page) {
				article = page.findChildArticle(domItem.syraDesigneArticle);
			}
		} else {
			article = document.site.findArticle(domItem);
		}
		if (article) {
			if (findLayout || domItem.syraDesignedLayoutId) {
				while (domItem && !domItem.syraDesignedLayoutId) {
					domItem = domItem.parentNode;
				}
				if (domItem) {
					return (article.id == domItem.syraDesignedLayoutId) ? article : (article.layouts[domItem.syraDesignedLayoutId] || null);
				}
			} else {
				while (domItem && !domItem.syraDesignedItemId) {
					domItem = domItem.parentNode;
				}
				if (domItem) {
					var item = (article.id == domItem.syraDesignedItemId) ? article : (article.idMap[domItem.syraDesignedItemId] || null);
					return item || document.site.findMenu(domItem);

				}
			}
		}
		return null;
	},
	dispose: function() {
		if (this.historyTool) {
			this.historyTool.dispose();
		}
		if (this.templatesTool) {
			this.templatesTool.dispose();
		}
		if (this.designedArticle) {
			if (this.designedArticle.page.dialogWrapper) {
				this._toggleDesignDialog(false);
			}
			this.designedArticle.isDesigned = false;
			delete this.designedArticle.designer;
		}
		this.vignetteField = this.historyTool = this.templatesTool = this.designedItem = this.awLayout = this.designedArticle = this.helpLink = this.diagnosePage = null;
		RawPage.prototype.dispose.call(this);
	}
});