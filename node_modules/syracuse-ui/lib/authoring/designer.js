"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var HistoryTool = require("syracuse-ui/lib/authoring/tools/historyTool").HistoryTool;

var TemplatesTool = require("syracuse-ui/lib/authoring/tools/templatesTool").TemplatesTool;

//temporalySave

function Designer() {}

exports.Designer = helpers.defineClass(Designer, RawPage, {
	isDesignedItem: function(item) {
		if (item.page != this && item.page != this.pageStorage) {
			if (this.designedArticle == this.designedArticle.page) {
				//page designe
				return item.page == this.designedArticle;
			}
		}
	},
	addClosePicker: function(slot) {
		var link = document.createElement("a");
		link.syraOnClick = "onCloseDesignerClick";
		link.title = this.localize.aw_close;
		link.className = "s-aw-designer-close";
		slot.appendChild(link);
	},
	endArticleUpdate: function(selectedItem, isStructureUpdated) {
		this.designedArticle.page.ensurePageVisibility();
		if (this.historyTool) {
			this.historyTool.notifyUpdate();
		}
		this.saveDesign();
	},
	loadHistoryTool: function() {
		(this.historyTool = new HistoryTool()).load(this);
	},
	applyChangeToMobile: function($article) {
		if (syra_site.mobileGateway) {
			syra_site.mobileGateway.applyChange($article);
		}
	},
	showTargetPageDiagnoses: function(message, options) {
		this.designedArticle.showDiagnoses(message, options);
		if (syra_site.mobileGateway) {
			syra_site.mobileGateway.onShowTargetPageDiagnoses(message, options);
		}
	},
	_toggleDesignDialog: function(begin) {
		var dlg = this.designedArticle.page;
		dlg = dlg && dlg.dialogWrapper;
		if (dlg) {
			dlg.btn_close.style.display = begin ? "none" : "";
			dlg.overlay.className = begin ? "s-aw-overlay" : "s-overlay";
		}
	},

	openDesigner: function(designedArticle) {
		this.isSiteRegisterDisabled = true;
		this.localize = syra_site.localize;
		this.designedArticle = designedArticle;
		this.designedArticle.designer = this;
		this.designedArticle.isDesigned = true;
		this.$prototype = {
			$properties: {},
			$links: {}
		};
		this.$item = {};
		this.$autoFetch = false;
		if (this.designedArticle.page == this.designedArticle) {
			(this.diagnosePage = this.designedArticle).clearUnknowFields();
			this.showTargetPageDiagnoses({
				$diagnoses: null
			});
		}
		if (this.designedArticle.page.dialogWrapper) {
			this._toggleDesignDialog(true);
		}
		if (designedArticle.$prototype && designedArticle.$prototype.$article) {
			//imortant save article for page
			designedArticle.$prototype.$article = helpers.object.clone(designedArticle.$prototype.$article, true);
		}
		this.loadBox(designedArticle);
		if (this.designedArticle.pageViewSelector) {
			this.designedArticle.pageViewSelector.disable(true);
		}
		this.isPageLoaded = true;
		if (!this.designedArticle.page.isVignettePage) {
			this.ensurePageVisibility();
		}
	},
	notifyDataChange: function(field, value) {
		var metaData = {};
		metaData[field.$item.$bind] = value;
		this.designedItem.applyDesignMetaData(metaData, true);
		this.saveDesign();
		this.historyTool.notifyUpdate();
		this.applyChange(metaData);
	},
	loadTemplateTools: function() {
		(this.templatesTool = new TemplatesTool()).load(this);
	},
	onCloseDesignerClick: function() {
		var self = this;
		setTimeout(function() {
			self.closeDesigner();
		}, 100);
	},
	findItem: function(domItem, findLayout) {
		if (findLayout || domItem.syraDesignedLayout) {
			while (domItem && !domItem.syraDesignedLayout) {
				domItem = domItem.parentNode;
			}
			return (domItem && domItem.syraDesignedLayout) || null;
		} else {
			while (domItem && !domItem.syraDesignedItem) {
				domItem = domItem.parentNode;
			}
			if (domItem) {
				return domItem.syraDesignedItem || repository[domItem.syraItem] || null;
			}
		}
		return null;
	},
	onTemplateClick: function(picker) {
		this.templatesTool && this.templatesTool.onTemplateClick(picker);
	},
	dispose: function() {
		if (this.historyTool) {
			this.historyTool.dispose();
		}
		if (this.templatesTool) {
			this.templatesTool.dispose();
		}
		if (this.designedArticle) {
			this._toggleDesignDialog(false);
			this.designedArticle.isDesigned = false;
			delete this.designedArticle.designer;
		}
		this.vignetteField = this.historyTool = this.templatesTool = this.designedItem = this.awLayout = this.designedArticle = this.diagnosePage = null;
		RawPage.prototype.dispose.call(this);
	}
});