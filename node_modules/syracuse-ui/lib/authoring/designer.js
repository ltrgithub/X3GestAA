"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var HistoryTool = require("syracuse-ui/lib/authoring/tools/historyTool").HistoryTool;
var utility = require("syracuse-ui/lib/authoring/tools/utility");

var TemplatesTool = require("syracuse-ui/lib/authoring/tools/templatesTool").TemplatesTool;

//temporalySave

function Designer() {}

exports.Designer = helpers.defineClass(Designer, RawPage, {
	isDesignedItem: function(item) {
		if (item.page != this && item.page != this.pageStorage) {
			if (this.designedArticle == this.designedArticle.page) {
				//page designe
				return item.page == this.designedArticle;
			}
		}
	},
	addCloseButton: function() {
		return syra_menus.addIconButton(syra_local.aw_close, "s-aw-designer-close", "onCloseDesignerClick");
	},
	endArticleUpdate: function(selectedItem, isStructureUpdated) {
		this.designedArticle.page.ensurePageVisibility();
		if (this.historyTool) {
			this.historyTool.notifyUpdate();
		}
		this.saveDesign();
	},
	loadHistoryTool: function() {
		(this.historyTool = new HistoryTool()).load(this);
	},
	applyChangeToMobile: function($article) {
		if (syra_site.mobileGateway) {
			syra_site.mobileGateway.applyChange($article);
		}
	},
	showTargetPageDiagnoses: function(message, options) {
		syra_site.showDiagnoses(message, this.designedArticle, options);
		if (syra_site.mobileGateway) {
			syra_site.mobileGateway.onShowTargetPageDiagnoses(message, options);
		}
	},
	_toggleDesignDialog: function(page, begin) {
		var dlg = page && page.dialogWrapper;
		if (dlg) {
			dlg.btn_close.style.display = begin ? "none" : "";
			dlg.overlay.className = begin ? "s-aw-overlay" : "s-overlay";
			!begin && dlg.resizeDialog();
		}
	},

	openDesigner: function(designedArticle) {
		this.isSiteRegisterDisabled = true;
		this.designedArticle = designedArticle;
		this.designedArticle.designer = this;
		this.designedArticle.isDesigned = true;
		this.$prototype = {
			$properties: {},
			$links: {}
		};
		this.$item = {};
		if (this.designedArticle.page == this.designedArticle) {
			utility.clearUnknowFields(this.diagnosePage = this.designedArticle);
			this.showTargetPageDiagnoses({
				$diagnoses: null
			});
		}
		if (this.designedArticle.page.dialogWrapper) {
			this._toggleDesignDialog(this.designedArticle.page, true);
		}
		if (designedArticle.$prototype && designedArticle.$prototype.$article) {
			//imortant save article for page
			designedArticle.$prototype.$article = helpers.object.clone(designedArticle.$prototype.$article, true);
		}
		this.loadBox(designedArticle);
		this.isPageLoaded = true;
		if (!this.designedArticle.page.isVignettePage) {
			this.ensurePageVisibility();
		}
	},
	notifyDataChange: function(field, value) {
		var metaData = {};
		metaData[field.$item.$bind] = value;
		this.designedItem.applyDesignMetaData(metaData, true);
		this.saveDesign();
		this.historyTool.notifyUpdate();
		this.applyChange(metaData);
	},
	loadTemplateTools: function() {
		(this.templatesTool = new TemplatesTool()).load(this);
	},
	onCloseDesignerClick: function() {
		var self = this;
		setTimeout(function() {
			self.closeDesigner();
		}, 100);
	},
	findItem: function(domItem, findLayout) {
		if (findLayout || domItem.syraDesignedLayout) {
			while (domItem && !domItem.syraDesignedLayout) {
				domItem = domItem.parentNode;
			}
			return (domItem && domItem.syraDesignedLayout) || null;
		} else {
			while (domItem && !domItem.syraDesignedItem) {
				domItem = domItem.parentNode;
			}
			if (domItem) {
				return domItem.syraDesignedItem || syra_store.findItem(domItem) || null;
			}
		}
		return null;
	},
	onTemplateClick: function(event, btn) {
		this.templatesTool && this.templatesTool.onTemplateClick(event, btn);
	},
	dispose: function() {
		var page;
		this.historyTool && this.historyTool.dispose();
		this.templatesTool && this.templatesTool.dispose();
		if (this.designedArticle) {
			page = this.designedArticle.page;
			this.designedArticle.isDesigned = false;
			delete this.designedArticle.designer;
		}
		RawPage.prototype.dispose.call(this);
		this._toggleDesignDialog(page, false);
	}
});