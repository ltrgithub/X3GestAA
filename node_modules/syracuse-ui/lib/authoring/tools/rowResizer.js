"use strict";
var helpers = require('syracuse-core/lib/helpers');

function RowResizer() {}

exports.RowResizer = helpers.defineClass(RowResizer, null, {
	start: function(dropItem, itemTool) {
		this.designer = itemTool.designer;
		this._rowLayout = this.designer.findItem(itemTool.cellToResize.parentNode);
		this.widths = syra_site.layoutUpdater.getWidthValues(this._rowLayout);

		this._left = itemTool.cellToResize;
		this._row = this._left.parentNode;
		var rect = this._left.getBoundingClientRect();
		this.startX = rect.right;
		this._leftW = rect.width;
		this._right = this._left.nextSibling;
		this._rightW = this._right.getBoundingClientRect().width;

		this.maxWidth = this._row.getBoundingClientRect().width;
		this.markerzIndex = syra_site.dom.setZIndex();
		this._drawSteps();
		syra_site.body.style.cursor = "w-resize";
	},
	_drawSteps: function() {
		var smallW = this.maxWidth / 30,
			steps = [],
			width = 0;
		for (var ii = 0; ii < 29; ii++) {
			steps.push(width += smallW);
		}
		this.markersSlot = document.createElement("div");
		this.markersSlot.className = "s-aw-markers";
		this.markersSlot.style.zIndex = this.markerzIndex;
		syra_site.layoutSlot.appendChild(this.markersSlot);
		var height = this.markersSlot.clientHeight;
		var rect = this._row.getBoundingClientRect();
		this.markersSlot.style.top = (rect.top - height - 2) + "px";
		this.markersSlot.style.left = rect.left + "px";
		this.markersSlot.style.width = rect.width + "px";
		this.markers = [];
		var lastMarker;
		for (var ii = 0, jj = steps.length; ii < jj; ii++) {
			var marker = document.createElement("div");
			marker.className = "s-aw-marker";
			marker.style.left = steps[ii] + "px";
			marker.style.height = height + "px";
			marker.syraPageX = rect.left + steps[ii];
			marker.syraStep = steps[ii];
			if (lastMarker) {
				lastMarker.syraPageMaxX = lastMarker.syraPageX + ((marker.syraPageX - lastMarker.syraPageX) / 2);
				marker.syraPageMinX = lastMarker.syraPageMaxX - 1;
			} else {
				marker.syraPageMinX = rect.left;
			}
			lastMarker = marker;
			this.markersSlot.appendChild(marker);
			this.markers.push(marker);
		}
		lastMarker.syraPageMaxX = rect.left + rect.width;
	},
	_findStep: function(rowSeparator) {
		var right = syra_site.dom.getBoundingClientRect(rowSeparator).right;
		for (var ii = 0, jj = this.markers.length; ii < jj; ii++) {
			var step = this.markers[ii];
			if (step.syraPageMinX <= right && right < step.syraPageMaxX) {
				return step;
			}
		}
		return null;
	},
	setLeftRightWidths: function(pageX) {
		if (!this.designer.designedArticle.isLandingPage) {
			this._row.style.width = ""; //temp hack	
		}
		pageX -= this.startX;
		this._left.style.width = Math.max(this._leftW + pageX) + "px";
		this._right.style.width = this._rightW + (pageX * (-1)) + "px";
	},
	onDragMouseUp: function(target, event) {
		var widths = this._rowLayout.$layout.$widths.split(",");
		var step = this._findStep(this._left);
		this.setLeftRightWidths(step.syraPageX);
		var tot = this._row.getBoundingClientRect().width;
		var children = this._row.children;
		for (var ii = 0, jj = children.length; ii < jj; ii++) {
			var width = children[ii].getBoundingClientRect().width;
			widths[ii] = (100 * width) / tot;
		}
		this._rowLayout.$layout.$widths = widths.join(",");
		syra_site.layoutValidator.setRowWidths(this._rowLayout);
		this.designer.endArticleUpdate(this.designedItem, false);

	},
	onDragMouseMove: function(target, event) {
		var pageX;
		if (event.pageX >= this.markers[0].syraPageX && event.pageX <= this.markers[this.markers.length - 1].syraPageX) {
			pageX = event.pageX;
		} else {
			pageX = this.markers[(event.pageX < this.markers[0].syraPageX) ? 0 : this.markers.length - 1].syraPageX;
		}
		if (pageX !== undefined) {
			this.setLeftRightWidths(pageX);
		}
	},
	stop: function() {
		this.markersSlot && syra_site.dom.removeChild(this.markersSlot);
		this._row = this.markers = this._leftW = this._rightW = this._left = this._right = this.stopTimeout = this.widths = this._rowLayout = null;
	},
	dispose: function() {
		this.stop();
		this.designer = null;
	}
});