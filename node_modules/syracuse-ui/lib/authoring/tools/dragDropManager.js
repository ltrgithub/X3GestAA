"use strict";
var helpers = require('syracuse-core/lib/helpers');

function DragDropManager() {}

exports.DragDropManager = helpers.defineClass(DragDropManager, null, {
	load: function() {
		this._observers = [];
		this.bindEvents();
	},
	setDragSpot: function(dom, enable) {
		if (enable) {
			dom.syraDragSpot = true;
			dom.setAttribute("data-s-drag-spot", "1");
		} else {
			delete dom.syraDragSpot;
			dom.removeAttribute("data-s-drag-spot");
		}
	},
	addListener: function(observer) {
		this._observers.push(observer);
	},
	removeListener: function(observer) {
		var ii = this._observers.indexOf(observer);
		if (ii >= 0) {
			this._observers.splice(ii, 1);
		}
	},
	cancel: function() {
		delete this.requestedDDAuthoringItem;
	},
	start: function(observer, DragDropClass, $$boundary) {
		if (this.requestedDDAuthoringItem) {
			this.dragDropInstance = new DragDropClass();
			this.dragDropInstance.start(this.requestedDDAuthoringItem, observer, $$boundary);
			delete this.requestedDDAuthoringItem;
		}
	},
	stop: function() {
		this.cancel();
		if (this.dragDropInstance) {
			if (this.dragDropInstance.stop) {
				this.dragDropInstance.stop();
			}
			this.dragDropInstance.dispose();
			delete this.dragDropInstance;
		}
		document.site.body.style.cursor = "default";
	},
	setDragDropInstance: function(instance, ident) {
		if (instance) {
			this.dragDropInstance = instance;
		} else {
			delete this.dragDropInstance;
		}
	},
	bindEvents: function() {
		var self = this;
		$(document).bind("mouseup.syradragdrop", function(event) {
			if (self.dragDropInstance) {
				self.dragDropInstance.onDragMouseUp(this, event);
				self.stop();
			}
		});
		document.site.$$layoutSlot.delegate("[data-s-drag-spot]", "mousedown", function(event) {
			if (self.dragDropInstance) {
				self.stop();
			} else {
				for (var ii = 0, jj = self._observers.length; ii < jj; ii++) {
					var item = self._observers[ii].isDraggable(this, event);
					if (item) {
						self.requestedDDAuthoringItem = item;
						return false;
					}
				}

			}
			// return false;
		}).delegate("[data-s-drag-spot]", "mousemove", function(event) {
			for (var ii = 0, jj = self._observers.length; ii < jj; ii++) {
				var result = self._observers[ii].onDragMove(this, event);
				if (result !== true) {
					return result;
				}
			}
		}).bind("mousemove.author", function(event) {
			if (self.dragDropInstance) {
				self.dragDropInstance.onDragMouseMove(event.target, event);
				event.preventDefault();
				return false;
			}
			return true;
		});
	},
	dispose: function() {
		if (document.site.$$layoutSlot) {
			document.site.$$layoutSlot.undelegate(".author");
		}
		delete this._observers;
	}
});