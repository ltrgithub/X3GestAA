"use strict";
var helpers = require('syracuse-core/lib/helpers');
var ItemDDAgent = require("syracuse-ui/lib/authoring/tools/itemDDAgent").ItemDDAgent;
var RowResizer = require("syracuse-ui/lib/authoring/tools/rowResizer").RowResizer;

function ItemTool() {}

exports.ItemTool = helpers.defineClass(ItemTool, null, {
	load: function(designer, $stepSkin) {
		this.designer = designer;
		document.site.ddManager.togglePageObserver(this, true);
	},

	isDraggable: function(target, event) {
		if (target.syraSepType && target.syraSepType == "row") {
			return target;
		}
		var item = this.designer.findItem(target, undefined, event);
		return (item && (item.$awAddNewItem || (item != this.designer.designedArticle.page && item.page == this.designer.designedArticle.page))) ? item : null;
	},
	onDragMove: function(target, event) {
		if (document.site.ddManager.ddAgent && document.site.ddManager.ddAgent.designer != this.designer) {
			return true;
		}
		if (document.site.ddManager.dropableItem) {
			if (document.site.ddManager.dropableItem.syraSepType == "row") {
				var item = this.designer.findItem(target, undefined, event);
				if (item && !item.articleParent || (item.articleParent == this.designer.designedArticle)) {
					document.site.ddManager.start(this, RowResizer, this.designer.designedArticle.page.scrollview);
					return;
				}
				return true;
			}
		}
		if (target.className && target.className.indexOf && (target.className.indexOf("s-aw-item") >= 0 || target.className.indexOf("s-aw-add-item") >= 0)) {
			var item = this.designer.findItem(target, undefined, event);
			if (item) {
				if ((!item.articleParent || (item.articleParent == this.designer.designedArticle))) {
					if (item != this.designer.designedArticle.page) {
						if (document.site.ddManager.dropableItem) {
							document.site.ddManager.start(this, ItemDDAgent, this.designer.designedArticle.page.scrollview);
						} else {
							var className = event.target && event.target.className;
							if (className && className.indexOf &&
								(className.indexOf("s-aw-slot-sep-row") >= 0 ||
									className.indexOf("s-aw-slot-sep-stack") >= 0)) {
								item = this.designer.findItem(event.target, undefined, event);
							}
							if (document.site.ddManager.ddAgent) {
								document.site.ddManager.ddAgent.onDragMouseMove(target, event, item);
							}
						}
					}
					this.designer.uiSwitchTool.toggleOverItem(item, true);
					return false;
				}
			}
			if (document.site.ddManager.ddAgent) {
				return false;
			}
		}
		return true;
	},
	dispose: function() {
		if (this.designer) {
			document.site.ddManager.togglePageObserver(this, false);
			this.designer = null;
		}
	}
});