"use strict";

function _toggleUIDesign(designer, item, enable, disposingDesigner) {
	var site = syra_site;
	var isLightMode;
	if (designer.$viewType) {
		isLightMode = designer.$viewType == "viewTypeStructure";
		if (designer.$viewType == "viewTypePreview") {
			enable = false;
		}
	}
	if (designer.designedArticle.isRecordArticle) {
		if (item.articleParent && !((item.articleParent == designer.designedArticle.list) ||
			(item.articleParent == designer.designedArticle))) {
			return;
		}
	} else {
		if (item.articleParent && item.articleParent != designer.designedArticle.page) {
			return;
		}
	}
	if (item.$isAuthoringEnabled === false) {
		return;
	}
	item.isDesigning = enable;
	if (item.isSpaceBox) {
		if (enable) {
			if (!item.deleteBtn) {
				if (item.boxParent.$designLevel == "block") {
					item.$designLevel = "field";
				} else {
					var children = item.boxParent.layoutContent ? item.boxParent.layoutContent.getItems() : [];
					if (children.length > 0) {
						item.$designLevel = children[0].$designLevel;
					} else {
						item.$designLevel = item.boxParent.$designLevel == "section" ? "block" : "section";
					}
				}
				item.deleteBtn = syra_menus.addIconButton(syra_local.aw_deleteColumn, "s-aw-del-layout", "onDeleteLayoutClick", null, "delete");
				item.deleteBtn.syraSpaceBox = item.id;
				item.deleteBtn.syraItem = designer.id;
				item.body.appendChild(item.deleteBtn);
			}
		} else {
			if (item.deleteBtn) {
				site.dom.removeChild(item.deleteBtn);
				item.deleteBtn = null;
			}
			site.dom.toggleClass(item.layoutSlot, "s-aw-designed", false);
			site.dom.toggleClass(item.layoutSlot, "s-aw-over", false);
		}
		if (!site.isTabletDevice) {
			item.layoutSlot.syraDragSpot = enable ? item.id : null;
		}
		site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
	}
	if (item.isTabLayout) {
		if (!item.isLayout && item.isSection && !item.loaded && item.$item.$opened !== false) {
			item.renderLayoutContent();
			item.loaded = true;
		}
	}
	var domItem = item.dataSlot || item.domItem;
	if (domItem) {
		//no domitem for layout
		if (item.isSection) {
			if (isLightMode) {
				if (!item.childrenSection || item.childrenSection.length == 0) {
					if (item.layoutContent && item.layoutContent.domItem) {
						item.$isLayoutContentLightHidden = true;
						item.layoutContent.domItem.style.display = "none";
					}
				}
			} else {
				if (item.$isLayoutContentLightHidden) {
					item.layoutContent.domItem.style.display = "";
				}
			}
		}
		if (item.tabTitle) {
			if (enable) {
				item.tabTitle.syraDesignedItem = item;
			} else {
				site.dom.toggleClass(item.tabTitle, "s-aw-designed", false);
				site.dom.toggleClass(item.tabTitle, "s-aw-over", false);
				site.dom.toggleClass(item.body, "s-aw-designed", false);
				site.dom.toggleClass(item.body, "s-aw-over", false);
				delete item.tabTitle.syraDesignedItem;
			}
			site.dom.toggleClass(item.tabTitle, "s-aw-item", enable);
			site.dom.toggleClass(item.body, "s-aw-item", enable);
			if (!site.isTabletDevice) {
				item.tabTitle.syraDragSpot = enable ? item.id : null;
				item.body.syraDragSpot = enable ? item.id : null;
			}
			site.dom.toggleClass(item.tabTitle, "s-aw-light", enable && isLightMode);
			site.dom.toggleClass(item.body, "s-aw-light", enable && isLightMode);
		}
		if (enable) {
			domItem.syraDesignedItem = item;
			if (!item.isLayout) {
				item.layoutSlot.syraDesignedItem = item;
			}
		} else {
			if (domItem) {
				if (item.body) {
					site.dom.toggleClass(item.body, "s-aw-over", false);
					site.dom.toggleClass(item.body, "s-aw-designed", false);
				}
				if (item.header) {
					site.dom.toggleClass(item.header, "s-aw-over", false);
					site.dom.toggleClass(item.header, "s-aw-designed", false);
				}
				site.dom.toggleClass(item.layoutSlot, "s-aw-designed", false);
				site.dom.toggleClass(item.layoutSlot, "s-aw-over", false);
				site.dom.toggleClass(domItem, "s-aw-designed", false);
				site.dom.toggleClass(domItem, "s-aw-over", false);
				domItem.syraDesignedItem = item.layoutSlot.syraDesignedItem = null;
			}
		}
		if (item.isLayout) {
			var cssCell = null;
			if (item.$layout.$layoutType == "row") {
				cssCell = "s-aw-sep-row";
				item.domItem.syraItem = item.id;
				var children = item.domItem.children;
				site.dom.toggleClass(item.domItem, "s-aw-item", enable);
				if (!site.isTabletDevice) {
					item.domItem.syraDragSpot = enable ? item.id : null;
				}
				if (item.layoutSlot) {
					site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
					if (!site.isTabletDevice) {
						item.layoutSlot.syraDragSpot = enable ? item.id : null;
					}
				}
			} else {
				if (item.layoutParent && item.layoutParent.isRow) {
					site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
					if (!site.isTabletDevice) {
						item.layoutSlot.syraDragSpot = enable ? item.id : null;
					}
				}
			}
			if (cssCell) {
				for (ii = 0, jj = children.length - 1; ii < jj; ii++) {
					syra_site.dom.toggleClass(children[ii], cssCell, enable);
				}
			}
			if (!enable) {
				item.domItem.style.display = "";
				delete item.domItem.syraItem;
			}
		} else {
			if (item.layoutSlot) {
				site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
				item.layoutSlot.syraItem = item.id;
				if (!site.isTabletDevice) {
					item.layoutSlot.syraDragSpot = enable ? item.id : null;
				}
			}
			site.dom.toggleClass(domItem, "s-aw-item", enable);
			if (!site.isTabletDevice) {
				domItem.syraDragSpot = enable ? item.id : null;
			}
			site.dom.toggleClass(domItem, "s-aw-light", enable && isLightMode);
			if (item.page != item && !item.$item.$isPopupContent) {
				var show = enable || !(item.$isHidden || item.isItemHidden || item.isInvisible);
				item.showItem && item.showItem(show);
			}

		}
	}

	item.toggleUIDesign && item.toggleUIDesign(enable, disposingDesigner);
	if (item.isLayout) {
		if (item.items) {
			for (var ii = 0, jj = item.items.length; ii < jj; ii++) {
				_toggleUIDesign(designer, item.items[ii], enable, disposingDesigner);
			}
		}
	} else {
		if (item.layoutContent) {
			_toggleUIDesign(designer, item.layoutContent, enable, disposingDesigner);
		}
	}
}

function _toggleItemCss(item, css, show) {
	if (item.domItem) {
		if (item.tabTitle) {
			syra_site.dom.toggleClass(item.tabTitle, css, show);
			syra_site.dom.toggleClass(item.body, css, show);
		} else {
			if (item.dataSlot) {
				syra_site.dom.toggleClass(item.dataSlot, css, show); //page
			} else {
				if (item.layoutSlot) {
					syra_site.dom.toggleClass(item.layoutSlot, css, show);
				}
			}
			if (item.isLayout) {
				syra_site.dom.toggleClass(item.domItem, css, show);
			}
			if (item.header) {
				syra_site.dom.toggleClass(item.header, css, show);
			}
			if (item.body) {
				syra_site.dom.toggleClass(item.body, css, show);
			}
		}
	}
}

exports.toggleItemCss = _toggleItemCss;

exports.load = function(designer) {
	designer.onDeleteLayoutClick = function(event, btn) {
		syra_site.layoutUpdater.onDeleteLayoutClick(this, event, btn);
	};
	designer.toggleUIDesign = function(item, enable, disposingDesigner) {
		_toggleUIDesign(this, item, enable, disposingDesigner);
	};
	designer.toggleOverItem = function(item, isOver) {
		var css = "s-aw-over";
		_toggleItemCss(item, css, isOver);
		if (isOver && this._overItem != item) {
			if (this._oveItems) {
				for (var ii = 0, jj = this._oveItems.length; ii < jj; ii++) {
					_toggleItemCss(this._oveItems[ii], css, false);
				}
			}
			this._oveItems = [];
			this._overItem = item;
			while (item) {
				_toggleItemCss(item, css, true);
				this._oveItems.push(item);
				item = item.boxParent;
			}
		}
	};
};