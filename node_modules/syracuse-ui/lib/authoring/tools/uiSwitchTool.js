"use strict";
var helpers = require('syracuse-core/lib/helpers');


function _toggleBarDesign(bar, enable) {
	if (bar) {
		var isOnPreviewMode = bar.page.designer && bar.page.designer.viewsTool && bar.page.designer.viewsTool.$viewType == "viewTypePreview";
		if (enable || isOnPreviewMode) {
			if (!bar.designOverlay) {
				bar.designOverlay = document.createElement("div");
				bar.designOverlay.className = "s-aw-bar-overlay";
				syra_site.dom.setZIndex(bar.designOverlay);
				syra_site.layoutSlot.appendChild(bar.designOverlay);
			}
			bar._designing = true;
			bar.barSlot.style.display = bar.designOverlay.style.display = (isOnPreviewMode && !bar.isHidden && bar.isSlotVisible) ? "" : "none";
			bar.resizeBar();
		} else {
			if (bar.designOverlay) {
				syra_site.dom.removeChild(bar.designOverlay);
				delete bar.designOverlay;
			}
			bar._designing = false;
			if (!bar.isHidden && bar.isSlotVisible) {
				bar.barSlot.style.display = "";
			}
		}
	}
}


function UISwitchTool() {}

exports.UISwitchTool = helpers.defineClass(UISwitchTool, null, {
	load: function(designer) {
		this.designer = designer;
		this.id = designer.id + "uiswitchtool";
		syra_store.add(this);
	},
	toggleUIDesign: function(item, enable, disposingDesigner) {
		var site = syra_site;
		var isLightMode;
		if (this.designer.viewsTool) {
			isLightMode = this.designer.viewsTool.$viewType == "viewTypeStructure";
			if (this.designer.viewsTool.$viewType == "viewTypePreview") {
				enable = false;
			}

		}
		if (item == this.designer.designedArticle && item == item.page) {
			_toggleBarDesign(item.page.menuBar, enable);
			_toggleBarDesign(item.page.fusionBar, enable);
		}
		if (!enable && item.loadPageViewSelector) {
			item.loadPageViewSelector();
		}
		if (this.designer.designedArticle.isRecordArticle) {
			if (item.articleParent && !((item.articleParent == this.designer.designedArticle.list) ||
				(item.articleParent == this.designer.designedArticle))) {
				return;
			}
		} else {
			if (item.articleParent && item.articleParent != this.designer.designedArticle.page) {
				return;
			}
		}
		if (item.$isAuthoringEnabled === false) {
			return;
		}
		item.isDesigning = enable;
		if (item.isSpaceBox) {
			if (enable) {
				if (!item.deleteBtn) {
					if (item.boxParent.$designLevel == "block") {
						item.$designLevel = "field";
					} else {
						var children = item.boxParent.layoutContent ? item.boxParent.layoutContent.getItems() : [];
						if (children.length > 0) {
							item.$designLevel = children[0].$designLevel;
						} else {
							item.$designLevel = item.boxParent.$designLevel == "section" ? "block" : "section";
						}
					}
					item.deleteBtn = syra_menus.addIconButton(syra_local.aw_deleteColumn, "s-aw-del-layout", "onDeleteLayoutClick");
					item.deleteBtn.syraSpaceBox = item.id;
					item.deleteBtn.syraarticle = this.designer.id;
					item.deleteBtn.syraTool = this.id;
					item.body.appendChild(item.deleteBtn);
				}
			} else {
				if (item.deleteBtn) {
					site.dom.removeChild(item.deleteBtn);
					item.deleteBtn = null;
				}
				site.dom.toggleClass(item.layoutSlot, "s-aw-designed", false);
				site.dom.toggleClass(item.layoutSlot, "s-aw-over", false);
			}
			if (!site.isTabletDevice) {
				item.layoutSlot.syraDragSpot = enable ? item.id : null;
			}
			site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
		}
		if (item.isTabLayout) {
			if (!item.isLayout && item.isSection && !item.loaded && item.$item.$opened !== false) {
				item.renderLayoutContent();
				item.loaded = true;
			}
		}
		var domItem = item.dataSlot || item.domItem;
		if (domItem) {
			//no domitem for layout
			if (item.isSection) {
				if (isLightMode) {
					if (!item.childrenSection || item.childrenSection.length == 0) {
						if (item.layoutContent && item.layoutContent.domItem) {
							item.$isLayoutContentLightHidden = true;
							item.layoutContent.domItem.style.display = "none";
						}
					}
				} else {
					if (item.$isLayoutContentLightHidden) {
						item.layoutContent.domItem.style.display = "";
					}
				}
			}
			if (item.tabTitle) {
				if (enable) {
					item.tabTitle.syraDesignedItem = item;
				} else {
					site.dom.toggleClass(item.tabTitle, "s-aw-designed", false);
					site.dom.toggleClass(item.tabTitle, "s-aw-over", false);
					site.dom.toggleClass(item.body, "s-aw-designed", false);
					site.dom.toggleClass(item.body, "s-aw-over", false);
					delete item.tabTitle.syraDesignedItem;
				}
				site.dom.toggleClass(item.tabTitle, "s-aw-item", enable);
				site.dom.toggleClass(item.body, "s-aw-item", enable);
				if (!site.isTabletDevice) {
					item.tabTitle.syraDragSpot = enable ? item.id : null;
					item.body.syraDragSpot = enable ? item.id : null;
				}
				site.dom.toggleClass(item.tabTitle, "s-aw-light", enable && isLightMode);
				site.dom.toggleClass(item.body, "s-aw-light", enable && isLightMode);
			}
			if (enable) {
				domItem.syraDesignedItem = item;
				if (!item.isLayout) {
					item.layoutSlot.syraDesignedItem = item;
				}
			} else {
				if (domItem) {
					if (item.body) {
						site.dom.toggleClass(item.body, "s-aw-over", false);
						site.dom.toggleClass(item.body, "s-aw-designed", false);
					}
					if (item.header) {
						site.dom.toggleClass(item.header, "s-aw-over", false);
						site.dom.toggleClass(item.header, "s-aw-designed", false);
					}
					site.dom.toggleClass(item.layoutSlot, "s-aw-designed", false);
					site.dom.toggleClass(item.layoutSlot, "s-aw-over", false);
					site.dom.toggleClass(domItem, "s-aw-designed", false);
					site.dom.toggleClass(domItem, "s-aw-over", false);
					domItem.syraDesignedItem = item.layoutSlot.syraDesignedItem = null;
				}
			}
			if (item.isLayout) {
				if (item.$layout.$layoutType == "row") {
					item.domItem.syraItem = item.id;
					site.dom.toggleClass(item.domItem, "s-aw-item", enable);
					if (!site.isTabletDevice) {
						item.domItem.syraDragSpot = enable ? item.id : null;
					}
					if (item.layoutSlot) {
						site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
						if (!site.isTabletDevice) {
							item.layoutSlot.syraDragSpot = enable ? item.id : null;
						}
					}
				}
				if (!enable) {
					item.domItem.style.display = "";
					delete item.domItem.syraItem;
				}
			} else {
				if (item.layoutSlot) {
					site.dom.toggleClass(item.layoutSlot, "s-aw-item", enable);
					if (!site.isTabletDevice) {
						item.layoutSlot.syraDragSpot = enable ? item.id : null;
					}
				}
				site.dom.toggleClass(domItem, "s-aw-item", enable);
				if (!site.isTabletDevice) {
					domItem.syraDragSpot = enable ? item.id : null;
				}
				site.dom.toggleClass(domItem, "s-aw-light", enable && isLightMode);

				if (item.page != item && !item.$item.$isPopupContent) {
					var show = !(!item.isDesigning && (!(item.layoutParent && item.layoutParent.isRow) && (item.$isHidden || item.isItemHidden || item.isInvisible)));
					if (item.showItem) {
						item.showItem(show);
					}
				}
			}
		}
		if (item.rowSeparator) {
			site.dom.toggleClass(item.rowSeparator, "s-aw-slot-sep-" + item.layoutParent.$layout.$layoutType, enable);
			item.rowSeparator.syraDragSpot = item.layoutParent.isRow && enable ? item.id : null;
			if (item.isLayout) {
				item.rowSeparator.syraDesignedLayout = item;
			} else {
				item.rowSeparator.syraDesignedItem = item;
			}
		}
		if (item.toggleUIDesign) {
			item.toggleUIDesign(enable, disposingDesigner);
		}
		if (item.isLayout) {
			if (item.items) {
				for (var ii = 0, jj = item.items.length; ii < jj; ii++) {
					this.toggleUIDesign(item.items[ii], enable, disposingDesigner);
				}
			}
		} else {
			if (item.layoutContent) {
				this.toggleUIDesign(item.layoutContent, enable, disposingDesigner);
			}
		}
	},
	onDeleteLayoutClick: function(event, btn) {
		var self = this;
		if (!syra_dd.ddAgent) {
			syra_dd.cancel();
			var spaceBox = syra_store.get(btn.syraSpaceBox);
			setTimeout(function() {
				var layout = spaceBox.layoutParent;
				var layoutParent = layout.layoutParent;
				var deletedIndex;
				if (spaceBox) {
					deletedIndex = layout.items.indexOf(spaceBox);
					layout.removeItem(spaceBox, true);
				}
				if (layout.items.length > 0 && layout.isRow) {
					syra_site.layoutUpdater.deleteRowColumn(layout, deletedIndex);
				} else {
					if (layoutParent) {
						layoutParent.removeItem(layout, true);
						if (layoutParent.isRow) {
							syra_site.layoutUpdater.deleteRowColumn(layoutParent, deletedIndex);
						}
					} else {
						layoutParent = layout.boxParent.layoutParent;
						layoutParent.removeItem(layout.boxParent, true, layoutParent.isRow);
					}
				}
				self.designer.endArticleUpdate(null, true);
			}, 10);
		}
	},
	toggleOverItem: function(item, isOver) {
		var css = "s-aw-over";
		this._toggleItemCss(item, css, isOver);
		if (isOver && this._overItem != item) {
			if (this._oveItems) {
				for (var ii = 0, jj = this._oveItems.length; ii < jj; ii++) {
					this._toggleItemCss(this._oveItems[ii], css, false);
				}
			}
			this._oveItems = [];
			this._overItem = item;
			while (item) {
				this._toggleItemCss(item, css, true);
				this._oveItems.push(item);
				item = item.boxParent;
			}
		}
	},
	_toggleItemCss: function(item, css, show) {
		if (item.domItem) {
			if (item.tabTitle) {
				syra_site.dom.toggleClass(item.tabTitle, css, show);
				syra_site.dom.toggleClass(item.body, css, show);
			} else {
				if (item.dataSlot) {
					syra_site.dom.toggleClass(item.dataSlot, css, show); //page
				} else {
					if (item.layoutSlot) {
						syra_site.dom.toggleClass(item.layoutSlot, css, show);
					}
				}
				if (item.isLayout) {
					syra_site.dom.toggleClass(item.domItem, css, show);
				}
				if (item.header) {
					syra_site.dom.toggleClass(item.header, css, show);
				}
				if (item.body) {
					syra_site.dom.toggleClass(item.body, css, show);
				}
			}
		}
	},
	dispose: function() {
		syra_store.remove(this);
		this.designer = this._overItem = this._oveItems = null;
	}
});