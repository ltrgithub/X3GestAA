"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Site = require('syracuse-ui/lib/site/site').Site;
var Controller = require("./controller").Controller;
var ExcelDocument = require('msoffice/lib/excel/excelDocument').ExcelDocument;
var OfficeSiteTopPanel = require("./officeSiteTopPanel").OfficeSiteTopPanel;
var dispatcher = require('msoffice/lib/excel/dispatcher');
var OfficePage = require('syracuse-ui/lib/office/officePage').OfficePage;

function OfficeSite() {}

exports.OfficeSite = helpers.defineClass(OfficeSite, Site, {
	_onLogon: function() {
		var self = this;
		if (!self._isLocalChanging) {
			self.isUserLogonEnd = true;
			document.controller.startNavigation();
			var excelLoaded = (external && external.Application);
			excelLoaded && external.onLogon();
			// check addin version
			document.controller.sendRequest(null, {
				$location: {
					$url: "/sdata/syracuse/collaboration/syracuse/moduleVersions('officeAddin')?representation=moduleVersion.$details"
				}
			}, function(data, response) {
				if (data && data.version) {
					self._hasBetterAddinVersion = (excelLoaded && (external.GetAddinVersion() < data.version)) || !excelLoaded;
					self._hasBetterAddinVersion && self.renderUpdatePanel();
				}
			});
			self.layoutSlot.style.display = "";
			self.resize();
		}
	},
	_appendTopPanelOpener: function(layoutSlot, topPanelClass) {
		Site.prototype._appendTopPanelOpener.call(this, layoutSlot, topPanelClass);
		this._topPanelOpener.className = "s-site-top-pn-opener-link-office";
	},
	renderUpdatePanel: function() {
		var self = this;
		if (self.$$updatePanel) {
			self.$$updatePanel.show();
			return;
		}
		self.$$updatePanel = $("<div id='s-site-updatePanel'/>").prependTo(self.body);
		$("<a href='/msoffice/lib/general/addIn/SyracuseOfficeAddinsSetup.EXE'>A newer version of the addin is available. Click here to download it</a>").appendTo(self.$$updatePanel);
	},
	onMainPageChange: function($itemPage) {
		this.$$updatePanel = null;
		Site.prototype.onMainPageChange.apply(this, arguments);
		if (this._hasBetterAddinVersion)
			this.renderUpdatePanel();
		// TODO: should this be conditionnal ?
		this.mainPage.onSelectRecord = function(result) {
			if (Object.keys(result).length) {
				var first = result[Object.keys(result)[0]];
				external.onSelectRecord(JSON.stringify(first.$prototype), JSON.stringify(first.dataset));
			}
		};
		// autoload should be done by main page
		// document.site.excelDocument.autoLoad();
		return this.mainPage;
	},
	_renderHeader: function() {
		this.header = document.createElement("header");
		this.header.setAttribute("id", "s-site-header");
		this.setZIndex(this.header);

		this.headerTop = document.createElement("div");
		this.headerTop.id = "s-site-header-top";

		this.headerLogo = document.createElement("a");
		this.headerLogo.id = "s-site-header-logo";
		this.headerTop.appendChild(this.headerLogo);

		var emptyCell = document.createElement("div");
		emptyCell.id = "s-site-header-empty-cell";
		this.headerTop.appendChild(emptyCell);

		this._appendTopPanelOpener(this.headerTop, OfficeSiteTopPanel);

		this.loadNewItem(this.headerTop, {
			$bind: "$help",
			$category: "link",
			$noText: true,
			$skin: "s-site-help-link"
		});

		this.homeLink = this.loadNewItem(this.headerTop, {
			$bind: "$home",
			$category: "link",
			$noText: true,
			$skin: "s-site-home"
		});
		this.header.appendChild(this.headerTop);
		this.layoutSlot.appendChild(this.header);

		this._topPanelContainer = document.createElement("div");
		this._topPanelContainer.setAttribute("id", "s-site-top-pn");
		this.layoutSlot.appendChild(this._topPanelContainer);
	}
});

exports.load = function($item, $prototype) {
	var widgetsLibrary = require('syracuse-ui/lib/site/widgetsLibrary');
	widgetsLibrary.defaultPageCategory = OfficePage;
	widgetsLibrary.pageCategories.worksheet = require("./excelPage").ExcelPage;
	var site = new OfficeSite();
	site.excelDocument = new ExcelDocument();
	site.loadBox({
		widgetsLibrary: widgetsLibrary,
		userProfileClass: require("syracuse-ui/lib/office/userProfile").UserProfile,
		controllerClass: Controller,
		$item: $item,
		$prototype: $prototype
	});
	site.requestControllers["excel"] = require("syracuse-ui/lib/office/excel/excelRequest");
	site.$syracuseMainPageUrl = $item.$syracuseMainPageUrl;
	//
	site.agents = {
		excelDatasources: {
			saveDatasource: function(article, menu, record) {
				site.excelDocument.addDatasource(record);
			}
		}
	};
	dispatcher.on("refreshAll", function() {
		site.excelDocument.refreshAllDatasources();
	});
	//
	return site;
};