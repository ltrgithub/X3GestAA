"use strict"

var helpers = require('syracuse-core/lib/helpers');
var CommonController = require('syracuse-ui/lib/controller/controller').Controller;

function Controller(){
}

exports.Controller = helpers.defineClass(Controller, CommonController, {
    openPage: function(menuArticle, menu, record){
        if (menu.$target === "worksheet") {
            var excelDocument = document.site.excelDocument;
            // load / update datasource
            excelDocument.loadPage({
                $url: menu.$url,
                $title: (menuArticle && menuArticle.dataset && menuArticle.dataset.title) || menu.$title
            });
        }
        else {
            CommonController.prototype.openPage.apply(this, arguments);
        }
    },
    notifyChange: function(article, binding, value){
        // trap document save event
        var self = this;
        var notifyArgs = arguments;
        if ((binding === "$actions")) {
            // extract representation
            var repr = ((article && article.dataset.$url) || "").match(/\?.*representation=(.*)\./);
            repr = (repr && repr[1]) || "";
            switch (repr) {
                case "documentExcel":
                    // save the document to the working copy
                    document.site.excelDocument.publishDocument(article.parseExpression(article.$prototype.$url + "?representation={$representation}.$details"), article.dataset.description, article.parseExpression(article.get$Properties().content.$url), function(data, resp){
                        // on succes continue with save the working copy
                        CommonController.prototype.notifyChange.apply(self, notifyArgs);
                    });
                    break;
                default:
                    CommonController.prototype.notifyChange.apply(self, notifyArgs);
            }
        }
        else 
            CommonController.prototype.notifyChange.apply(self, notifyArgs);
    }
});
