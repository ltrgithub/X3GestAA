"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Site = require('syracuse-ui/lib/site/site').Site;
var Controller = require("./controller").Controller;
var ExcelDocument = require('msoffice/lib/excel/excelDocument').ExcelDocument;
var dispatcher = require('msoffice/lib/excel/dispatcher');
var OfficePage = require('syracuse-ui/lib/office/officePage').OfficePage;

function OfficeSite() {}

exports.OfficeSite = helpers.defineClass(OfficeSite, Site, {
	_lvbuildFavorites: function() {},
	updateFavorites: function() {},
	_onLogon: function() {
		var self = this;
		var excelLoaded = (external && external.Application);
		excelLoaded && external.onLogon();
		// check addin version
		document.controller.sendRequest(null, {
			$location: {
				$url: "/sdata/syracuse/collaboration/syracuse/moduleVersions('officeAddin')?representation=moduleVersion.$details"
			}
		}, function(data, response) {
			if (data && data.version) {
				if ("expectedVersion" in external) {
					external.expectedVersion(data.version);
				}
				self._hasBetterAddinVersion = (excelLoaded && (external.GetAddinVersion() < data.version)) || !excelLoaded;
				self._hasBetterAddinVersion && self.renderUpdatePanel();
			}
		});
	},
	drawBox: function() {
		var self = this;
		self.addDragDropManager();
		self._renderHeader();
		self.$$body = $("<div id='s-site-body'/>").appendTo($(self.layoutSlot));
		self.logon(function() {
			document.controller.startNavigation();
			//            self.$$userProfileHost.show();
			self.layoutSlot.style.display = "";
			self.resize();
			//
			var excelLoaded = (external && external.Application);
			//
			excelLoaded && external.onLogon();
			// check addin version
			document.controller.sendRequest(null, {
				$location: {
					$url: "/sdata/syracuse/collaboration/syracuse/moduleVersions('officeAddin')?representation=moduleVersion.$details"
				}
			}, function(data, response) {
				if (data && data.version) {
					if ("expectedVersion" in external) {
						external.expectedVersion(data.version);
					}
					self._hasBetterAddinVersion = (excelLoaded && (external.GetAddinVersion() < data.version)) || !excelLoaded;
					self._hasBetterAddinVersion && self.renderUpdatePanel();
				}
			});
			// TODO: onerror function
		});
	},
	renderUpdatePanel: function() {
		var self = this;
		if (self.$$updatePanel) {
			self.$$updatePanel.show();
			return;
		}
		self.$$updatePanel = $("<div id='s-site-updatePanel'/>").prependTo(self.$$body);
		$("<a href='/msoffice/lib/general/addIn/SyracuseOfficeAddinsSetup.EXE'>A newer version of the addin is available. Click here to download it</a>").appendTo(self.$$updatePanel);
	},
	onMainPageChange: function($itemPage) {
		this.$$updatePanel = null;
		Site.prototype.onMainPageChange.apply(this, arguments);
		if (this._hasBetterAddinVersion) this.renderUpdatePanel();
		document.site.excelDocument.autoLoad();
		return this.mainPage;
	},
	_renderHeader: function() {
		this.$$userProfileHost = $("<div id='s-user-profile'/>").appendTo($(this.layoutSlot));
	}
});

exports.load = function($item, $prototype) {
	var widgetsLibrary = require('syracuse-ui/lib/site/widgetsLibrary');
	widgetsLibrary.defaultPageCategory = OfficePage;
	widgetsLibrary.pageCategories.worksheet = require("./excelPage").ExcelPage;
	var site = new OfficeSite();
	site.excelDocument = new ExcelDocument();
	$item.$isSecurityTitleVisible = false;
	site.loadBox({
		widgetsLibrary: widgetsLibrary,
		userProfileClass: require("syracuse-ui/lib/office/userProfile").UserProfile,
		controllerClass: Controller,
		$item: $item,
		$prototype: $prototype
	});
	site.requestControllers["excel"] = require("syracuse-ui/lib/office/excel/excelRequest");
	dispatcher.on("refreshAll", function() {
		site.excelDocument.refreshAllDatasources();
	});
	dispatcher.on("saveDocument", function() {
		site.excelDocument.publishDocument();
	});
	dispatcher.on("selectionChanged", function() {
		site.excelDocument.selectionChanged();
	});
	site.$syracuseMainPageUrl = $item.$syracuseMainPageUrl;
	return site;
};