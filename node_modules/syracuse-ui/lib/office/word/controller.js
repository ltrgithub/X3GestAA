"use strict";

// This controller is only used to catch the save event of a document entry to directly
// save content from an active document inside ms word

var helpers = require('syracuse-core/lib/helpers');
var CommonController = require('syracuse-ui/lib/controller/controller').Controller;


function Controller() {}

exports.Controller = helpers.defineClass(Controller, CommonController, {
	executeMenu: function(menu, record, article, confirmed) {
		var self = this;
		var args = arguments;
		var repr;
		if (menu && menu.$url && menu.$url.indexOf("$workingCopies") > -1) {
			repr = self._getRepresentation(menu.$url);
			menu.$url += "&templateClass=" + document.site.wordInterface.getDocumentRepresentation();
			if (menu.$sourceUrl) {
				menu.$sourceUrl += "&templateClass=" + document.site.wordInterface.getDocumentRepresentation();
			}
			var locale = document.site.wordInterface.getDocumentLocale();
			if (locale) {
				menu.$url += "&templateLocale=" + locale;
				if (menu.$sourceUrl) {
					menu.$sourceUrl += "&templateLocale=" + locale;
				}
			}
			menu.$url += "&volumeCode=STD";
			if (menu.$sourceUrl) {
				menu.$sourceUrl += "&volumeCode=STD";
			}
			self._setLinkingProperties(menu);
		}
		CommonController.prototype.executeMenu.apply(self, args);
	},
	_getRepresentation: function(url) {
		var repr = url.match(/\?.*representation=(.*)\./);
		repr = (repr && repr[1]) || "";
		return repr;
	},
	_setLinkingProperties: function(menu) {
		var resUrl = document.site.wordInterface.getResourceUrl();
		if (!resUrl) return;
		resUrl += "&";
		var repr = resUrl.match(/\?.*representation=(.*?)&/);
		repr = ((repr && repr[1]) || "").split("&")[0];

		var parts = resUrl.split("/");
    	var ep = parts[4];
		var classNameKeys = (parts && parts.length && parts[parts.length - 1].split("?")[0]) || "";
		var className = classNameKeys && classNameKeys.split("(")[0];
		var keys = classNameKeys.match(/\('(.*)'\)/);
		keys = (keys && keys[1]) || "";

		menu.$url += "&representationName=" + repr;
		menu.$url += "&className=" + className;
		menu.$url += "&x3Keys=" + keys;
		menu.$url += "&officeEndpoint=" + ep;

		if (menu.$sourceUrl) {
			menu.$sourceUrl += "&representationName=" + repr;
			menu.$sourceUrl += "&className=" + className;
			menu.$sourceUrl += "&x3Keys=" + keys;
			menu.$sourceUrl += "&officeEndpoint=" + ep;
		}
	}
});