"use strict"

var helpers = require('syracuse-core/lib/helpers');
var page = require('syracuse-ui/lib/common/article/page');
var article = require('syracuse-ui/lib/common/article/article');
var base64 = require("msoffice/lib/Base64").Base64;

// Test URLS:
// http://localhost:8124/msoffice/lib/word/ui/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsdata%2Fsyracuse%2Fcollaboration%2Fsyracuse%2Fusers%3Frepresentation%3Duser.%24query%26role%3D98184048-6790-480f-b1c5-73e6268e51c8
//
function WordReportPage() {
}

exports.WordReportPage = helpers.defineClass(WordReportPage, page.Page, {
    drawBox: function() {
    	var self = this;
    	self.wordLayoutBoxes = new Array();
    	self.createLayout(self.$item, self.$prototype.$, null, self.wordLayoutBoxes, null, self.$prototype);
    },
    createWordTemplate: function(wordInterface) {
    	var self = this;
    	wordInterface.createWordTemplate(self.wordLayoutBoxes);
    },
    populateWordTemplate: function(wordInterface) {
    	var self = this;
    	wordInterface.populateWordTemplate(self.createSimpleData());
    },
    onDialogResize: function() {
    },
    applyChange: function(newData, response, requestUrl) {
    	var self = this;
    	self.pageData = newData;
    },
    dispose: function() {
    },
    createLayout: function(article, prototype, parent, boxes, level, baseProto) {
    	// walk layout and build flat list of boxes which contain properties with type information
    	var self = this;
    	
    	var layoutType;
    	var bind;
    	var layoutSubType;
    	var data;
    	var box;
    	var hidden;
    	var i;

    	function getLocalizedText(val) {
    		if (val === "{$title}")
    			return baseProto.$title || val;
    		return val && val.replace(/\{(@\w+)\}/g, function(match, p1) {
    			return (baseProto.$localization && baseProto.$localization[p1]) || match;
    		});
    	}

    	if (!level)
    		level = 1;

    	var items = article.$items || (article.$layout && article.$layout.$items);
    	
    	if (article.$bind && items) {
    		// collection
    		bind = article.$bind; // collection property
    		data = (prototype && bind) ? prototype[bind] : prototype;
    		if (!data || data.$type.indexOf("application/x-collection") < 0)
    		{
    			// Not handled yet
    			console.log("unknown type: " + (data && data.$type) + "(" + bind + ")");
    		}
    		else
    		{
	    		data = data.$item.$;
	    		box = {
	    			$title:  getLocalizedText(article.$title),
	    			$container: "table",
	    			$bind: bind
	    		};
    		}
    	} else if (article.$bind && !items) {
    		// property
    		bind = article.$bind; // property
    		hidden = article.$isHidden || false
    		data = (prototype && bind) ? prototype[bind] : prototype;
    		if (data) {
    			parent.$items = parent.$items || {};
    			parent.$items[bind] = {
    					$type: data.$type,
    					$title: data.$title || bind,
    					$bind: bind,
    					$hidden: hidden
    			};
    		}
    	} else {
    		// container
    		data = prototype;
    		box = {
    				$title:  getLocalizedText(article.$title),
    				$container: "box"
    		};
    	}
    	
    	if (box && box.$title) { // a box with a title is considered as one level of indentation of headers
    		box.$level = level;
    		level ++;
    	}

    	var childBoxes = new Array();
    	items && items.map(function(item) {
    		self.createLayout(item, data, box, childBoxes, level, baseProto);
    	});
    	if (box) {
    		if (box.$title || box.$items)
    			boxes.push(box);
    	}
    	for (i = 0; i < childBoxes.length; i++) {
    		boxes.push(childBoxes[i]);
    	}
    },
    createSimpleData: function() {
    	var self = this;
    	
    	function format(expression, res) {
    		res = res || {};
    		var value = expression && expression.replace(/\{(.*?)\}/g, function(match, p1) {
    			return res[p1] || self.pageData[p1] || self.$prototype[p1];
    		});

    		return value;
    	}
    	
    	function addProperties(proto, dataOut, dataIn) {
    		for (var property in proto)
    		{
    			var p	 = proto[property];
    			var prop = {};
    			dataOut[property] = prop;
    			
    			prop.$type = p.$type;
    			if (prop.$type === "application/x-collection") {
    				var dataArray = dataIn[property];
    				if (dataArray) {
	    				prop.$items = new Array();
	    				for (var i = 0; i < dataArray.length; i++) {
	    					var item = {};
	    					prop.$items.push(item);	
	    					addProperties(p.$item.$, item, dataArray[i]);
	    				}
    				}
				}
    			else if (prop.$type === "application/x-reference") {
    				addProperties(p.$, prop, p);
    			}
    			else
   				{
    				var result = {};
    				//result.$title = proto[property] && proto[property].$title;
    				var value = dataIn[property];
    				if (value && value.$url) {
    					result.$url = format(value.$url, dataIn);
    				} else {
    					result.$value = value;
    				}
    				prop.$value = result;
   				}
    		}
    	};

    	var dataOut = {};
    	addProperties(self.$prototype.$, dataOut, self.pageData);
    	return dataOut;
    },
    setLineCount: function(lineCount) {
    }
});

// Called from word when additional data has to be fetched (eg. images)
// ONLY WORKS IN IE. no problem here, since this is only called from IE within word!
window.readBinaryURLContentIE = function(url) {

	var xhr = new XMLHttpRequest();
	var data = {};
	xhr.open('GET', url, false);

	xhr.setRequestHeader("X-Content-Type-Override", "text/plain; charset=x-user-defined");
	xhr.onreadystatechange = function(e) {
	  if (this.readyState == 4 && this.status == 200) {
		  // this.responseText is broken in IE with binary data!
		  data.responseBody = this.responseBody;
	  }
	};
	xhr.send();
	
	// This is a c# byte array!
	return data.responseBody;
};