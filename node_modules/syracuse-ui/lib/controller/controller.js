"use strict";
var helpers = require('syracuse-core/lib/helpers');

var _requestControllers = {
    http: require("./httpController"),
    excel: require("syracuse-ui/lib/office/excel/excelRequest")
};

function Controller(){
}

exports.Controller = helpers.defineClass(Controller, null, {
    initialize: function(){
        this._articles = {};
    },
    generateUUID: function(){
        return helpers.uuid.generate();
    },
    reloadMainPage: function(){
        this.changeMainPage(document.location.href);
    },
    startNavigation: function(){
        var self = this;
        //load representation of url
        self.reloadMainPage();
        //listen history change
        window[window.history.pushState ? "onpopstate" : "onhashchange"] = function(event){
            if (self.$updateHitory) {
                self.$updateHitory = false;
            }
            else {
                //if (document.location.href.indexOf("#&ui-state=dialog") < 0)
                self.reloadMainPage();
            }
        };
    },
    changeMainPage: function(url){
        var self = this;
        if (!window.history.pushState) {
            var hash = url.indexOf("#");
            if (hash >= 0) {
                var urlPath = url.slice(0, hash);
                if (urlPath.indexOf("?") >= 0) {
                    urlPath = urlPath.slice(0, urlPath.indexOf("?"));
                }
                url = urlPath + window.unescape(url.slice(hash + 1));
            }
            else {
                if (url.indexOf("?") < 0) {
                    //add default homepage
                }
            }
            
        }
        if (self._currentUrl != url) {
            var urlParam = url.search(/\?url=/i);
            if (urlParam >= 0) {
                url = decodeURIComponent(url).slice(urlParam + ("?url=").length);
            }
            self._currentUrl = url;
            var initData = self._preLoadedData;
            self._preLoadedData = null; //!important release buffer
            var httpQuery = self.parseUrl(self._currentUrl);
            if (httpQuery.$urlParts.isFusion) {
                //Temp mettre show diagnose dans site
                document.site.showDiagnoses({
                    $diagnoses: [{
                        message: "Can't display directly a Fusion page",
                        severity: "error"
                    }]
                });
                document.site.openHomeLink();
            }
            else {
                self.loadRepresentation(null, httpQuery, function($itemPage){
                    $itemPage.initData = initData;
                    document.site.onMainPageChange($itemPage);
                });
            }
        }
    },
    parseUrl: function($url){
        //        return httpController.parseUrl($url);
        var ctrl = _requestControllers[$url.split(":")[0]] || _requestControllers.http;
        return ctrl.parseUrl($url);
    },
    loadRepresentation: function(article, httpQuery, success, onError, onBeforeOpen, sendRqtOpts){
        var self = this;
        var httpQuery, $representationUrl;
        if (typeof(httpQuery) == "string") {
            if (article) {
                httpQuery = article.parseExpression(httpQuery);
            }
            this.loadRepresentation(article, self.parseUrl(httpQuery), success, onError, onBeforeOpen, sendRqtOpts);
        }
        else {
            $representationUrl = httpQuery.$url;
            //xhr.withCredentials = true;
            self.parseUrl((article || document.site).parseExpression(httpQuery.getPageTemplateUrl(), {
                representation: httpQuery.$urlParts.params.representation,
                endpoint: httpQuery.$urlParts.endpoint,
                target: httpQuery.$urlParts.target
            })).sendRequest(sendRqtOpts, function($representation){
                self._openLoadedRepresentation($representation, success, $representationUrl, httpQuery, onError, onBeforeOpen, sendRqtOpts);
            }, onError);
        }
    },
    _openLoadedRepresentation: function($representation, success, $representationUrl, httpQuery, onError, onBeforeOpen, sendRqtOpts){
        var self = this;
        if (typeof($representation.$prototype) == "string") {
            self.parseUrl($representation.$prototype).sendRequest(sendRqtOpts, function($prototype){
                $representation.$prototype = $prototype;
                self._openLoadedRepresentation($representation, success, $representationUrl, httpQuery, onError, onBeforeOpen, sendRqtOpts);
            }, onError);
        }
        else {
            $representation.$prototype = $representation.$prototype || {};
            if (document.site.userProfile) {
                document.site.userProfile.decoratePrototype($representation.$prototype);
                if (document.site.userProfile.wrapLoadSuccess) 
                    success = document.site.userProfile.wrapLoadSuccess(success);
            }
            $representation.$prototype.$representationUrl = $representationUrl;
            if (onBeforeOpen) {
                onBeforeOpen($representation);
            }
            success({
                $urlParts: httpQuery.$urlParts,
                $representation: $representation
            });
        }
    },
    sendRequest: function(page, options, onSuccess, onError){
        var self = this;
        options = options || {};
        if (options.$location = (options.$location ||
        {
            $url: page.$prototype.$representationUrl
        })) 
            if (options.$location.$url) {
                var httpQuery = self.parseUrl(options.$location.$url);
                if (options.$location.$type) {
                    options.$acceptType = options.$location.$type;
                }
                if (options.$location.$contentType) {
                    options.$contentType = options.$location.$contentType;
                }
                httpQuery.sendRequest(options, function(data, response, requestUrl){
                    if (onSuccess) {
                        onSuccess(data, response, requestUrl);
                    }
                    else {
                        page.applyChange(data, response, requestUrl);
                    }
                    if (options.$updateHitory) {
                        var httpQuery = self.parseUrl("?url=" + encodeURIComponent(requestUrl));
                        if (window.history.pushState) {
                            window.history.replaceState("$updateHitory", httpQuery.$url, httpQuery.$url);
                        }
                        else {
                            self.$updateHitory = true;
                            window.location.hash = "#" + window.escape(httpQuery.$url);
                        }
                    }
                }, onError);
            }
        
    },
    openPage: function(menuArticle, menu, record){
        if (menu.$target == "popup") {
            menu.boxParent.openDialog({
                $dialogMode: "modeless",
                article: menuArticle,
                $url: menu.$url
            });
        }
        else {
            var self = this;
            menuArticle.formatMenuUrl(menu, record, function($url, isCanceled){
                if (!isCanceled) {
                    var httpQuery = self.parseUrl($url);
                    httpQuery.$type = menu.$type;
                    httpQuery.$target = menu.$target;
                    if (httpQuery.isSyracuseURL()) {
                        if (httpQuery.$urlParts.$facet == "$summary") {
                            menu.boxParent.openDialog({
                                $dialogMode: "modeless",
                                article: menuArticle,
                                $url: httpQuery.$url
                            });
                            return;
                        }
                        else {
                            if (menu.$type && menu.$type.indexOf("json") == -1) {
                                httpQuery.$target = "blank";
                            }
                            else {
                                if (menu.boxParent) {
                                    var page = menu.boxParent.getArticle().getPage();
                                    if (page && page.$dialogMode == "modal") {
                                        httpQuery.$target = "blank";
                                    }
                                }
                                if (!httpQuery.$urlParts.isFusion && menu.$tags != "MOB") { //MOB=temp voir Bruno utilisï¿½ dans dashboard 
                                    httpQuery.parse("?url=" + encodeURIComponent(httpQuery.$url));
                                }
                            }
                        }
                        
                    }
                    else {
                        httpQuery.$target = "blank";
                    }
                    self._openMainPage(httpQuery);
                }
            });
        }
    },
    _openMainPage: function(httpQuery){
        if (httpQuery.$target == "blank") {
            window.open(httpQuery.$url, "_blank");
        }
        else {
            if (httpQuery.$urlParts.isFusion) {
                this.fusionGateway.openMainPage(httpQuery)
            }
            else {
                if (window.history.pushState) {
                    window.history.pushState("", httpQuery.$url, httpQuery.$url);
                    this.changeMainPage(httpQuery.$url);
                }
                else {
                    window.location.hash = "#" + window.escape(httpQuery.$url);
                }
            }
        }
    },
    loadWorkingCopy: function(options){
        var self = this;
        self._postQuery(options.menu, options.record || null, null, function($location, data){
            if (options.menuArticle) {
                var httpQuery = self.parseUrl("?url=" + encodeURIComponent($location.$url = options.menuArticle.parseExpression($location.$url)));
                httpQuery.$type = options.menu.$type;
                self._preLoadedData = (options.menu.$method != "DELETE") ? data : null;
                self._openMainPage(httpQuery);
            }
            else {
                self.loadRepresentation(null, $location.$url, function($itemPage){
                    options.article.$prototype = $itemPage.$representation.$prototype;
                    document.itemFactory.initializeItem(options.article, {});
                    options.article.loadBox(data);
                    if (options.callback) {
                        options.callback($itemPage, $location, data);
                    }
                });
            }
        });
    },
    _postQuery: function(menu, record, article, callback, callbackError){
        var self = this;
        var menuArticle = article;
        if (!menuArticle && menu.getArticle) {
            menuArticle = menu.getArticle();
        }
        if (!menuArticle) {
            menuArticle = document.site; //a ameliorer
        }
        menu.$method = menu.$method || "POST";
        menuArticle.formatMenuUrl(menu, record, function($url){
            menu.$url = $url;
            self.sendRequest(menuArticle, {
                $location: menu,
                params: {
                    trackingId: self.generateUUID()
                },
                method: menu.$method,
                noDisplayErr: menu.noDisplayErr || false
            }, function(data, response){
                var $location = {
                    $url: response.headers.location,
                    type: ""
                };
                if ($location.$url) {
                    $location.$type = response.headers["content-type"];
                }
                else {
                    $location.$url = response.data.$url || menu.$url;
                    $location.$type = response.data.$type || menu.$type;
                }
                callback($location, response.data)
            }, function(err){
                if (callbackError) {
                    callbackError(err);
                }
            });
        });
        
    },
    /**** Menu management ****/
    bindMenuClick: function($$site){
        var self = this;
        $$site.delegate("a[data-s-menu]", "click", function(event){
            var $$menu = $(this);
            var menu = self.findItem($$menu);
            if (!menu) {
                throw new Error("menu not found"); // to manage by
                // diagnose
            }
            if (!menu.$isDisabled) {
                menu.click();
            }
            return false;
        });
    },
    _executeAction: function(menu, record, article){
        var self = this;
        var menuArticle = article || menu.getArticle();
        var request = {};
        var $bindAction = request[menu.$sourceBind || menu.$item.$bind] = {
            $isRequested: true
        };
        if (menu.$parameters) {
            menu.$parameters.$title = menu.getTitle ? menu.getTitle() : null;
            menuArticle.parseParameters(menu.$parameters, record, function(values, isCanceled){
                if (!isCanceled) {
                    $bindAction.$parameters = {};
                    delete values.$title;
                    Object.keys(values).forEach(function(prop){
                        $bindAction.$parameters[prop] = values[prop];
                    });
                    menuArticle.notifyChange("$actions", request);
                }
            });
        }
        else {
            menuArticle.notifyChange("$actions", request);
        }
    },
    executeMenu: function(menu, record, article, confirmed){
        var self = this;
        var menuArticle = article || menu.getArticle();
        if (!confirmed && menu.$confirm) {
            document.site.showMessage({
                $title: menu.$title || "Confirm",
                $message: menuArticle.parseExpression(menu.$confirm),
                $type: "question",
                callback: function(response){
                    if (response.$id === "yes") {
                        self.executeMenu(menu, record, article, true);
                    }
                }
            });
            return;
        }
        if (menu.$isAction) {
            self._executeAction(menu, record, menuArticle);
        }
        else {
            if (menu.$method && (menu.$method != "GET")) {
                self.loadWorkingCopy({
                    menu: menu,
                    menuArticle: menuArticle,
                    record: record,
                    article: article
                });
            }
            else {
                self.openPage(menuArticle, menu, record);
            }
        }
    },
    notifyChange: function(article, $bind, value){
        var self = this;
        var data = {};
        if (article.dataset && article.dataset.$uuid) {
            data.$uuid = article.dataset.$uuid;
        }
        if (article.onNotifyRecordChange) {
            data = article.onNotifyRecordChange(value, $bind);
        }
        else {
            data[$bind] = value;
        }
        if (data) { //data == null =>onNotifyRecordChange disable notify
            var articleParent = article.getArticleParent();
            if (articleParent) {
                articleParent.notifyChange(article.$item.$bind, data);
            }
            else {
                data.$url = article.$prototype.$representationUrl;
                if (article.$prototype.$representationUrl) {
                    data.$url = article.$prototype.$representationUrl;
                    data.$etag = article.dataset.$etag;
                    self.sendRequest(article, {
                        data: data,
                        method: "PUT",
                        $etag: data.$etag
                    });
                }
                else {
                    delete data.$url;
                    delete data.$etag;
                    article.applyChange(data);
                }
            }
        }
    },
    /**** File management ****/
    upload: function(file, url, article, requestCallback, progressCallback){
        _requestControllers.http.upload({
            file: file,
            url: article.parseExpression(url),
            //            contentType: "image"
            contentType: file.type
        }, requestCallback, progressCallback);
    },
    deleteFile: function(url, article, callback){
        var httpQuery = this.parseUrl(article.parseExpression(url));
        httpQuery.sendRequest({
            method: "DELETE"
        }, function(data, response){
            if (callback) {
                callback(data, response);
            }
            else {
                page.applyChange(data, response);
            }
        });
    },
    
    /**** Article management ****/
    registerArticle: function(article){
        this._articles[article.id] = article;
    },
    removeArticle: function(article){
        delete this._articles[article.id];
    },
    findItem: function($$item){
        var article = this._articles[$$item.attr("data-s-article")];
        return article ? article.idMap[$$item.attr("data-s-menu") || $$item.attr("data-s-item")] : null;
    },
    disposeObject: function(instance){
        var self = this;
        if (instance) {
            if (!instance.disposed) {
                if (instance.dispose) {
                    instance.dispose();
                    //ensure factory free to avoid recursive call
                    //  delete instance.sourceDispose;
                    delete instance.layoutParent;
                    delete instance.authoringNode;
                    delete instance.boxParent;
                }
                Object.keys(instance).forEach(function(prop){
                    var field = instance[prop];
                    if (field && field.dispose) {
                        //  field.sourceDispose = instance;
                        //  field.sourceDisposeProp = prop;
                        self.disposeObject(field);
                    }
                    delete instance[prop];
                });
                instance.disposed = true;
            }
            else {
                // console.log("instance already disposed");
            }
        }
    },
    dispose: function(){
        if (this.fusionGateway) {
            this.disposeObject(this.fusionGateway);
            delete this.fusionGateway;
        }
    }
});
