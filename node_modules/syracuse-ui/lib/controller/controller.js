"use strict";
var helpers = require('syracuse-core/lib/helpers');
var soapController = require("syracuse-ui/lib/soap/soapController");
var uitestController = require("syracuse-ui/lib/tests/uitestController");
var searchController = require('syracuse-ui/lib/site/search/searchController');

function Controller() {}

exports.Controller = helpers.defineClass(Controller, null, {
	deleteWorkingCopy: function(workingCopyPage) {
		if (workingCopyPage && !workingCopyPage.isFusionPage && workingCopyPage.$isEditMode) {
			var $representationUrl = workingCopyPage.$prototype ? workingCopyPage.$prototype.$representationUrl : null;
			if ($representationUrl && $representationUrl.search(/\$workingCopies/i) >= 0) {
				var httpQuery = this.parseUrl($representationUrl);
				httpQuery.sendRequest({
					method: "DELETE"
				}, function(data, response) {

				}, function(data, response) {

				});
			}
		}
	},
	changeMainPage: function($url, $itemPage, onHistoryChange) {
		var self = this;
		var designer = syra_site.mainPage && syra_site.mainPage.designer;
		if (designer && designer.onBeforeMainPageChange) {
			if (!designer.onBeforeMainPageChange(function() {
				self.changeMainPage($url, $itemPage);
			})) {
				return false;
			}
		}
		self.deleteWorkingCopy(syra_site.mainPage);

		/*if(syra_site.onErrorMainpage){
         syra_site.history.cancelChange();
         delete syra_site.onErrorMainpage;
         }*/
		self._currentUrl = $url;
		var workingCopyPreload = self._workingCopyPreload;
		self._workingCopyPreload = null; //!important release buffer
		var openerUrlSegments = syra_site.urlMaker.parse($url);
		if (openerUrlSegments.isFusion) {
			syra_site.fusionGateway.openMainPage(openerUrlSegments);
		} else {
			if (syra_site.fusionGateway && syra_site.fusionGateway.activatedBook) {
				syra_site.fusionGateway.activatedBook.onCloseAllSheets(function(allSheetsClosed) {
					if (!allSheetsClosed) {
						if (onHistoryChange) {
							syra_site.history.cancelChange();
						}
					}
				});
				return false;
			}
			if (soapController.isSoapUrl(openerUrlSegments.$url)) {
				soapController.openRequestPage(openerUrlSegments);
				return;
			}
			if (uitestController.isUiTestUrl(openerUrlSegments.$url)) {
				uitestController.openPage(openerUrlSegments);
				return;
			}
			if (searchController.isSearchUrl(openerUrlSegments.$url)) {
				$itemPage = {
					$category: "search",
					openerUrlSegments: openerUrlSegments,
					$representation: {
						$prototype: searchController.getPrototype()
					}
				};
			}
			if ($itemPage) {
				$itemPage.initData = $itemPage.initData || (workingCopyPreload && workingCopyPreload.initData);
				$itemPage.openerUrlSegments = openerUrlSegments;
				$itemPage.openerUrlSegments.fullUrl = document.location.href;
				syra_site.onMainPageChange($itemPage);
			} else {
				self.loadRepresentation({
					article: null,
					segments: openerUrlSegments,
					success: function($itemPage) {
						$itemPage.initData = $itemPage.initData || (workingCopyPreload && workingCopyPreload.initData);
						$itemPage.openerUrlSegments = openerUrlSegments;
						if (workingCopyPreload) {
							$itemPage.openerUrlSegments.workingCopyPreloadUrl = workingCopyPreload.openUrl;
							// save working copy preload url (session storage)
							self._saveWCPreloadUrl(openerUrlSegments.$url, workingCopyPreload.openUrl);
						}
						$itemPage.openerUrlSegments.fullUrl = document.location.href;
						syra_site.onMainPageChange($itemPage);
					},
					onError: function(error, httpQuery) {
						var errorPage = "show" + error.status;
						syra_site.onErrorMainpage = true;
						var $diagnoses = httpQuery.extractDiagnoses(error);
						if (!(syra_site.diagnosesPage[errorPage] && syra_site.diagnosesPage[errorPage](error, $diagnoses))) {
							syra_site.showMessage({
								$title: syra_site.localize.error_page_default,
								$message: $diagnoses.length == 1 && $diagnoses[0].$message,
								$diagnoses: $diagnoses,
								callback: function() {
									if (syra_site.lastOpenedMainPageUrlSegments) {
										syra_site.history.load(syra_site.lastOpenedMainPageUrlSegments.$url);
									} else {
										syra_site.gotoHome();
									}
								}
							});
							return false;
						}
					}
				});

			}
		}


	},
	_saveWCPreloadUrl: function(key, preloadUrl) {
		if (sessionStorage) {
			var data = {};
			data.wcpreloadUrl = preloadUrl;
			sessionStorage.setItem(key, JSON.stringify(data));
		}
	},
	parseUrl: function($url) {
		var ctrl = syra_site.requestControllers[$url.split(":")[0]] || syra_site.requestControllers.http;
		return ctrl.parseUrl($url);
	},
	//article, segments, success, onError, onBeforeOpen, sendRqtOpts
	loadRepresentation: function(options) {
		var self = this;
		if (typeof(options.segments) == "string") {
			this.loadRepresentation({
				article: options.article,
				segments: syra_site.urlMaker.parse(options.article ? syra_site.expressionMaker.parse(options.article, options.segments) : options.segments),
				success: options.success,
				onError: options.onError,
				onBeforeOpen: options.onBeforeOpen,
				sendRqtOpts: options.sendRqtOpts
			});
		} else {
			options.$representationUrl = options.segments.$url;
			//xhr.withCredentials = true;
			self.parseUrl(syra_site.urlMaker.buildPageCollaborationUrl(options.article || syra_site, options.segments)).sendRequest(options.sendRqtOpts, function($representation, response, $url) {
				$representation.$pageCollaborationUrl = $url;
				self._loadRepresentationContent($representation, options);
			}, options.onError);
		}
	},
	_loadRepresentationContent: function($representation, options, userPreferenceLoading) {
		var self = this;
		$representation.$prototype = $representation.$prototype || {};
		if (typeof($representation.$prototype) == "string") {
			self.parseUrl($representation.$prototype).sendRequest(options.sendRqtOpts, function($prototype) {
				$representation.$prototype = $prototype;
				self._loadRepresentationContent($representation, options);
			}, options.onError);
			return;
		}
		if ($representation.$prototype.$article && typeof($representation.$prototype.$article) == "string") {
			self.parseUrl($representation.$prototype.$article).sendRequest(options.sendRqtOpts, function($article) {
				$representation.$prototype.$article = $article;
				self._loadRepresentationContent($representation, options);
			}, options.onError);
			return;
		}
		if (!userPreferenceLoading) {
			var $userPreferencesLink = $representation.$links && $representation.$links.$userPreferences;
			if ($userPreferencesLink) {
				if (!(options.segments && options.segments.representationRoot == "userProfile")) {
					self.parseUrl($userPreferencesLink.$url).sendRequest(options.sendRqtOpts, function(userPreferences) {
						$representation.userPreferences = userPreferences;
						self._loadRepresentationContent($representation, options, true);
					}, options.onError);
					return;
				}
			}
		}
		if ($representation.$article && typeof($representation.$article) == "string") {
			self.parseUrl($representation.$article).sendRequest(options.sendRqtOpts, function($article) {
				$representation.$article = $article;
				self._loadRepresentationContent($representation, options);
			}, options.onError);
			return;
		}
		syra_site.userProfile && syra_site.userProfile.setSecurityToRepresentation($representation);
		$representation.$prototype.$representationUrl = options.$representationUrl;
		if (options.onBeforeOpen) {
			options.onBeforeOpen($representation);
		}
		options.success({
			openerUrlSegments: options.segments,
			$representation: $representation
		});
		syra_site.checkMainPageBookmarkStatus();
	},
	sendRequest: function(page, options, onSuccess, onError) {
		var self = this;
		options = options || {};
		options.page = page;
		options.$location = options.$location || {
			$url: page.getDataUrl()
		};
		if (options.$location.$url) {
			var httpQuery = self.parseUrl(options.$location.$url);
			if (options.$location.$type) {
				options.$acceptType = options.$location.$type;
			}
			if (options.$location.$contentType) {
				options.$contentType = options.$location.$contentType;
			}
			httpQuery.sendRequest(options, function(data, response, requestUrl) {
				if (!page || !page.disposed) {
					if (onSuccess) {
						onSuccess(data, response, requestUrl);
					} else {
						page.startChange();
						page.applyChange(data, response, requestUrl);
						page.endChange();
					}
					if (options.$updateHitory) {
						syra_site.history.update(page, requestUrl);
					}
				}
			}, onError);
		}
	},
	openPage: function(menuArticle, menu, record) {
		var self = this;
		switch (menu.$target) {
			case "worksheet":
				syra_site.excelDocument.loadPage({
					$url: menu.$url,
					$title: (menuArticle && menuArticle.dataset && menuArticle.dataset.title) || menu.$title
				});
				break;
			case "popup":
				syra_site.dialogManager.openPage(menu.boxParent, {
					article: menuArticle,
					$url: menu.$url,
					isModal: false
				});
				break;
			default:
				syra_site.urlMaker.formatMenuUrl(menuArticle, menu, record, function($url, isCanceled) {
					if (!isCanceled) {
						if (menu.$invocationMode === "async" && menuArticle.dataset && menuArticle.dataset.$trackngId) {
							syra_site.registerJobSyra($url, undefined, menu.$title, menuArticle.dataset.$trackngId);
							return;
						}
						var isRepresentationUrl = true;
						var segments = syra_site.urlMaker.parse($url, true);
						var target = menu.$target;
						if (segments.isSyracuse) {
							if (segments.uri.search(/mobile\.html/i) > 0) {
								syra_site.history.load($url, "blank", null, false);
								return;
							}
							if (segments.$facet == "$summary") {
								syra_site.dialogManager.openPage(menu.boxParent, {
									article: menuArticle,
									$url: $url,
									isModal: false
								});
								return;
							} else {
								if (menu.$type && menu.$type.indexOf("json") == -1) {
									target = "blank";
								} else {
									var htmIndex = segments.uri.search(/\.html/i);
									if (htmIndex > 0) {
										//test for excelconfig.html
										if ((segments.uri.length - 5) == htmIndex) {
											var curUrlSegments = syra_site.urlMaker.parse(document.location.href);
											if (curUrlSegments.uri.indexOf(segments.uri) < 0) {
												isRepresentationUrl = false;
												target = "blank";
											}
										}
									}
									if (isRepresentationUrl) {
										if (menu.boxParent) {
											if (menu.page && menu.page.dialogWrapper && menu.page.dialogWrapper.isModal) {
												target = "blank";
											}
										}
									}
								}
							}
						} else {
							target = "blank";
						}
						if (target != "blank" && target != "main" && menuArticle.page && menuArticle.page.$pageCategory == "vignette") {
							// in case of search vignette page (fk)
							if (menuArticle.page.vignetteField.page && menuArticle.page.vignetteField.page.$pageCategory == "search") {
								syra_site.history.load($url, target);
							} else {
								menuArticle.page.vignetteField.renderLayoutContent($url);
							}
						} else {
							if (isRepresentationUrl && menu && menu.isRepresentationUrl && !menu.isRepresentationUrl()) {
								isRepresentationUrl = false;
							}
							syra_site.history.load($url, target, null, isRepresentationUrl);
						}
					}
				});
				break;
		}
	},

	loadWorkingCopy: function(options) {
		var self = this;
		self.postQuery(options.menu, options.record || null, null, function($location, data) {
			if (options.menuArticle) {
				var segments = syra_site.urlMaker.parse($location.$url = syra_site.expressionMaker.parse(options.menuArticle, $location.$url, data));
				self._workingCopyPreload = {
					initData: (options.menu.$method != "DELETE") ? data : null,
					openUrl: options.menu.$url
				};
				syra_site.history.load(segments.$url, segments.target);
			} else {
				self.loadRepresentation({
					article: null,
					segments: $location.$url,
					success: function($itemPage) {
						options.article.$prototype = $itemPage.$representation.$prototype;
						options.article.page.initializeNewItem(options.article, {});
						options.article.loadBox(data);
						if (options.callback) {
							options.callback($itemPage, $location, data);
						}
					}
				});
			}

		});
	},
	postQuery: function(menu, record, article, callback, callbackError) {
		var self = this;
		var menuArticle = article;
		if (!menuArticle && menu.getArticle) {
			menuArticle = menu.getArticle();
		}
		if (!menuArticle) {
			menuArticle = syra_site; //a ameliorer
		}
		menu.$method = menu.$method || "POST";
		syra_site.urlMaker.formatMenuUrl(menuArticle, menu, record, function($url) {
			menu.$url = $url;
			self.sendRequest(menuArticle, {
				$location: menu,
				params: {
					trackingId: helpers.uuid.generate()
				},
				headers: menu.httpHeaders,
				method: menu.$method,
				data: menu.sendData,
				noDisplayErr: menu.noDisplayErr || false
			}, function(data, response) {
				var $location = {
					$url: response.headers.location,
					type: ""
				};
				if ($location.$url) {
					$location.$type = response.headers["content-type"];
				} else {
					$location.$url = response.data.$url || menu.$url;
					$location.$type = response.data.$type || menu.$type;
				}
				callback($location, response.data);
			}, function(err) {
				if (callbackError) {
					callbackError(err);
				} else {
					syra_site.showDiagnoses({
						$diagnoses: err.data && err.data.length > 0 ? (err.data.indexOf("$diagnoses") >= 0 ? JSON.parse(err.data).$diagnoses : [{
							$message: err.data ? err.data : syra_site.localize.http_empty_error
						}]) : [{
							$message: syra_site.localize.default_err_msg
						}]
					});
				}
			});
		});

	},
	_executeAction: function(menuItem, record, article) {
		var menuArticle = article || menuItem.getArticle();
		var target = menuItem.contextField || menuArticle;
		if (target || menuArticle) {
			var request = {};

			var r = request[menuItem.$sourceBind || (menuItem.$item && menuItem.$item.$bind)] = {
				$isRequested: true
			};
			if (menuItem.$invocationMode === "async") {
				r.$trackingId = helpers.uuid.generate();
			}
			if (menuItem.$parameters) {
				syra_site.urlMaker.notifyParametersActionChange(menuArticle, menuItem, record, target, request);
			} else {
				menuArticle.page.notifyActionChange(menuItem, target, request);
			}
		}
	},
	isWorkingCopyUrl: function($url, $sourceUrl) {
		var isWorkingCopy = $url && $url.indexOf("$workingCopies") >= 0;
		if (!isWorkingCopy && $sourceUrl) {
			isWorkingCopy = $sourceUrl.indexOf("$workingCopies") >= 0;
		}
		return isWorkingCopy;
	},
	executeMenu: function(menu, record, article, confirmed) {
		if (menu.$isAction || menu.$url || menu.$sourceUrl) {
			var self = this;
			var menuArticle = article || menu.getArticle();
			if (menuArticle && menuArticle.dataset) {
				if (menu.$invocationMode === "async") {
					menuArticle.dataset.$trackngId = helpers.uuid.generate();
				} else {
					delete menuArticle.dataset.$trackngId;
				}
			}
			// temporarily, until $confirm-message protocol extension
			if (menu.$confirm && menu.$officeAddinSetup) {
				if (helpers.getCookie("SyracuseOfficeAddin") === "valid") {
					menu.$confirm = "";
				}

			}
			if (menu.$url && menu.$url.indexOf("SyracuseOfficeAddinsSetup.EXE") > 0) {
				helpers.setCookie("SyracuseOfficeAddin", "valid", null, (new Date((new Date().getYear() + 1910), new Date().getMonth(), new Date().getDate())).toUTCString());
			}
			// temporarily END

			if (!confirmed && menu.$confirm) {
				syra_site.showMessage({
					$title: syra_site.expressionMaker.parse(menuArticle, menu.$title || syra_site.localize.siteDefaultConfirmTitle),
					$message: syra_site.expressionMaker.parse(menuArticle, menu.$confirm),
					$type: "question",
					callback: function(response) {
						if (response && response.$clientId === "yes") {
							// temporarily, until $confirm-message protocol extension
							if (menu.$officeAddinSetup) {
								helpers.setCookie("SyracuseOfficeAddin", "valid", null, (new Date((new Date().getYear() + 1910), new Date().getMonth(), new Date().getDate())).toUTCString());
							}
							// temporarily END
							self.executeMenu(menu, record, article, true);
						}
					}
				});
				return;
			}
			if (menu.$isAction) {
				self._executeAction(menu, record, menuArticle);
			} else {
				if (menu.$method && (menu.$method != "GET")) {
					if (this.isWorkingCopyUrl(menu.$url, menu.$sourceUrl)) {
						self.loadWorkingCopy({
							menu: menu,
							menuArticle: menuArticle,
							record: record,
							article: article
						});
					} else {
						self.postQuery(menu, record || null, null, function($location, data) {
							switch (menu.page.$facet) {
								case "$query":
								case "$bulk":
									menu.page.fetchLastRequest(function(lastData) {
										if (lastData && data.$diagnoses) {
											lastData.$diagnoses = lastData.$diagnoses || [];
											for (var ii = data.$diagnoses.length - 1; ii >= 0; ii--) {
												lastData.$diagnoses.unshift(data.$diagnoses[ii]);
											}
										}
										var page = menu.page;
										page.startChange();
										page.applyChange(lastData);
										page.endChange();
									});
									break;
								case "$details":
									menu.page.applyChange(data);
									if (menu.$method == "DELETE") {
										menu.page.freezeDeletedPage();
									}
									var menuArticle = menu.articleParent || menu.getArticle();
									if (menu.$invocationMode && menu.$invocationMode == "async" && menuArticle.dataset && menuArticle.dataset.$trackngId) {
										syra_site.registerJobSyra($location.$url, undefined, menu.$title, menuArticle.dataset.$trackngId);
									}
									break;
								default:
									if (menu.page) {
										var page = menu.page;
										page.startChange();
										page.onExecuteMenuResponse(menu, data);
										page.endChange();
									}
									break;
							}

						});
					}
				} else {
					self.openPage(menuArticle, menu, record);
				}
			}
		}
	},
	/**** File management ****/
	upload: function(file, $url, contentType, article, requestCallback, progressCallback, errorCallback) {
		syra_site.requestControllers.http.upload({
			file: file,
			url: syra_site.expressionMaker.parse(article, $url),
			//            contentType: "image"
			contentType: contentType || file.type
		}, requestCallback, progressCallback, errorCallback);
	},
	deleteFile: function($url, article, callback, onError, options) {
		var httpQuery = this.parseUrl(syra_site.expressionMaker.parse(article, $url));
		if (!options) {
			options = {};
		}
		options.method = "DELETE";
		httpQuery.sendRequest(options, function(data, response) {
			if (callback) {
				callback(data, response);
			} else {
				page.applyChange(data, response);
			}
		}, function(data, response) {
			if (onError) {
				onError(data, response);
			} else {
				syra_site.showDiagnoses({
					$diagnoses: data && data.length > 0 ? (data.indexOf("$diagnoses") >= 0 ? JSON.parse(data).$diagnoses : [{
						$message: data ? data : syra_site.localize.http_empty_error
					}]) : [{
						$message: syra_site.localize.default_err_msg
					}]
				});
			}
		});
	},
	dispose: function() {}
});