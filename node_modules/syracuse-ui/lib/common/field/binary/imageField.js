"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/common/article/article").Article;
var BinaryField = require('./binaryField').BinaryField;

function ImageField(){

}

exports.ImageField = helpers.defineClass(ImageField, BinaryField, {
    initialize: function(){
        // split image/star in two to avoid regex catastrophy
        this.acceptFilter = "image/" + "*";
        if (this.$item.$inplace) {
            this.$item.$imageWidth = this.$item.$imageWidth || "50px";
            this.$item.$imageHeight = this.$item.$imageHeight || "50px";
        }
        else {
            if (this.$item.$imageIsAutoHeight == undefined) {
                if (this.getPage().$facet == "$query") {
                    //test pour dom autrememtn toujours mette true 
                    // BRJOU fix: 100px too big for mobile -> 50px
                    this.$item.$imageHeight = this.$item.$imageHeight || "50px";
                    this.$item.$imageWidth = this.$item.$imageWidth || "50px";
                }
                else {
                    // BRJOU fix: auto height messes things up, use 150px instead
                    this.$item.$imageHeight = this.$item.$imageHeight || "150px";
                    this.$item.$imageWidth = this.$item.$imageWidth || "150px";
                    //this.$item.$imageIsAutoHeight = true;
                }
            }
            this.$item.$imageWidth = this.$item.$imageWidth || "100%";
            this.$item.$imageHeight = this.$item.$imageHeight || "150px";
        }
        BinaryField.prototype.initialize.call(this);
    },
    _renderEditMode: function(){
        BinaryField.prototype._renderEditMode.call(this, this.$skin + "-img");
        this.$$anchor[0].style.height = this.$item.$imageHeight;
    },
    _renderDetailMode: function($skin){
        BinaryField.prototype._renderDetailMode.call(this, this.$skin + "-img");
        this.$$anchor[0].style.height = this.$item.$imageHeight;
    },
    _setFile: function(file){
        // if value != null, get data url from prototype
        var self = this;
        var value = this.currentValue;
        if (file) {
            self._file = file;
            self.imageUrl = (value && value.$url) || self.$dataUrl;
            self.imageUrl = self._saltUrl(self.getArticle().parseExpression(self.imageUrl));
            if (!self._imageArea) {
                self._imageArea = document.createElement("div");
                self._imageArea.className = self.$skin + "-img-img";
                $(self._imageArea).appendTo(self.$$anchor);
                self.$$valueSlot[0].style.display = '';
            }
            self._imageArea.style.width = self.$item.$imageWidth;
            self._imageArea.style.height = self.$item.$imageHeight;
            self.$$anchor[0].style.height = "";
            if (self.remove) {
                self.remove.style.display = "";
            }
            if (self.$item.$imageIsAutoHeight) {
                if (!self._image) {
                    self._image = document.createElement("img");
                    self._image.onload = function(){
                        self._imageArea.style.height = self._image.height + "px";
                        self._imageArea.style.backgroundImage = "url(\"" + self.imageUrl + "\")";
                    };
                }
                self._image.src = self.imageUrl;
            }
            else {
				self._imageArea.style.backgroundImage = "";
                self._imageArea.style.height = self.$item.$imageHeight;
                self._imageArea.style.backgroundImage = "url(\"" + self.imageUrl + "\")";
            }
            self.$$anchor.attr("target", "_blank").attr("href", self.imageUrl).attr("disabled", false);
        }
        else {
            delete self._imageArea;
            if (self._image) {
                delete self._image.onload;
                delete self._image;
            }
            self.$$anchor.empty().attr("href", "#").attr("disabled", true)[0].style.height = self.$item.$imageHeight;
            if (self.remove) {
                self.remove.style.display = "none";
            }
        }
    },
    onWindowResize: function(){
        //si this.$item.$isAutoSize = true ou this.applyAutoSize(true) 
    },
    getAuthoringWidget: function(){
        return new ImageFieldAuthoring();
    },
    applyDesignMetaData: function(metadata, onAuthoring){
        BinaryField.prototype.applyDesignMetaData.call(this, metadata, onAuthoring);
        if (onAuthoring) {
            if (metadata.$imageWidth !== undefined) {
                this.$item.$imageWidth = metadata.$imageWidth;
            }
            if (metadata.$imageHeight !== undefined) {
                this.$item.$imageHeight = metadata.$imageHeight;
            }
            if (metadata.$imageIsAutoHeight !== undefined) {
                this.$item.$imageIsAutoHeight = metadata.$imageIsAutoHeight;
            }
            if (this._file) {
                this._setFile(this._file);
            }
        }
    }
});

function ImageFieldAuthoring(){

}

exports.ImageFieldAuthoring = helpers.defineClass(ImageFieldAuthoring, Article, {
    onNotifyRecordChange: function(value, binding){
        var metaData = {};
        metaData[binding] = value;
        this.designedField.applyDesignMetaData(metaData, true);
        this.applyChange(metaData);
        return null; //cancel notify
    },
    applyChange: function(newData){
        Article.prototype.applyChange.call(this, newData);
    },
    loadBox: function(initData){
        this.$prototype = {
            "$": {
                $imageWidth: {
                    $type: "application/x-string",
                    $title: "Width"
                },
                $imageHeight: {
                    $type: "application/x-string",
                    $title: "Height"
                },
                $imageIsAutoHeight: {
                    $type: "application/x-boolean",
                    $title: "auto height"
                }
            }
        };
        this.$item = {
            $category: "section",
            $title: "Image Type",
            $layout: {
                $items: [{
                    $bind: "$imageWidth",
                    $isEditMode: true,
                    $labelWidth: "auto",
                    $skin: "s-author-field"
                }, {
                    $bind: "$imageIsAutoHeight",
                    $isEditMode: true,
                    $labelWidth: "auto",
                    $skin: "s-author-field"
                }, {
                    $bind: "$imageHeight",
                    $isEditMode: true,
                    $labelWidth: "auto",
                    $skin: "s-author-field"
                }]
            }
        };
        Article.prototype.loadBox.call(this, initData);
    },
    dispose: function(){
        Article.prototype.dispose.call(this);
    }
});
