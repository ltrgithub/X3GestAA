"use strict";
var helpers = require("syracuse-core/lib/helpers")
var Article = require("syracuse-ui/lib/common/article/article").Article;

function LayoutTest(){
}

exports.LayoutTest = helpers.defineClass(LayoutTest, Article, {
    loadBox: function(){
        var self = this;
        self.$prototype = {
            "$": {
                $field$isHidden: {
                    $type: "application/x-boolean",
                    $title: "$isHidden",
                    $isMetaData: true
                },
                $field$isTitleHidden: {
                    $type: "application/x-boolean",
                    $title: "$isTitleHidden",
                    $isMetaData: true
                },
                $field$isBoxCollapsable: {
                    $type: "application/x-boolean",
                    $title: "$isBoxCollapsable",
                    $isMetaData: true
                },
                $field$isMaximizable: {
                    $type: "application/x-boolean",
                    $title: "$isMaximizable ",
                    $isMetaData: true
                }
            },
            $actions: {
                $startMacro: {
                    $title: "Start"
                }
            },
        };
        self.$item = {
            $skin: "s-portlet",
            $isSeparatorsVisible: true,
            $layout: {
                $layoutType: "columns",
                $layoutSubType: "70,30",
                $items: [                /*{
                 $layoutType: "columns",
                 $layoutSubType: "33,33,33",
                 $items:
                 }
                 */
                {
                    $layoutType: "stack",
                    $items: [self._makeLevel("Page", "page"), self._makeLevel("Dashboard", "dashboard"), self._makeLevel("Portlet", "portlet")]
                }, {
                    $layoutType: "stack",
                    $items: [{
                        $category: "link",
                        $bind: "$startMacro"
                    }, {
                        $category: "section",
                        $title: "Status",
                        $layout: {
                            $items: [{
                                $category: "block",
                                $title: "Metadata",
                                $layout: {
                                    $items: [{
                                        $bind: "$field$isHidden",
                                        $isEditMode: true
                                    }, {
                                        $bind: "$field$isTitleHidden",
                                        $isEditMode: true
                                    }, {
                                        $bind: "$field$isBoxCollapsable",
                                        $isEditMode: true
                                    }, {
                                        $bind: "$field$isMaximizable",
                                        $isEditMode: true
                                    }]
                                }
                            }]
                        }
                    }]
                }]
            }
        };
        Article.prototype.loadBox.call(self);
    },
    notifyField: function($bind, value){
        this.onNotifyRecordChange(value, $bind);
    },
    
    onNotifyRecordChange: function(value, binding){
        var self = this;
        if (binding == "$actions") {
            self.notifyField("$field$isHidden", true);
            setTimeout(function(){
                self.notifyField("$field$isHidden", false);
                self.notifyField("$field$isTitleHidden", true);
                setTimeout(function(){
                    self.notifyField("$field$isTitleHidden", false);
                    self.notifyField("$field$isBoxCollapsable", true);
                    setTimeout(function(){
                        self.notifyField("$field$isBoxCollapsable", false);
                        self.notifyField("$field$isMaximizable", true);
                    }, 2000);
                }, 2000);
            }, 2000);
        }
        else {
            if (binding.indexOf("$field") == 0) {
                var $field = self.$prototype.$[binding];
                binding = binding.replace("$field", "");
                var metaData = {};
                metaData[binding] = value;
                Object.keys(self.idMap).forEach(function(id){
                    var box = self.idMap[id];
                    if (box.$item.$test) {
                        box.applyDesignMetaData(metaData, true);
                    }
                });
            }
        }
        return null; //cancel notify
    },
    _makeLevelPart: function($title, $skin, $layoutType){
        var section = {
            $category: "section",
            $test: true,
            $skin: "s-" + $skin + "-h1",
            $title: "Section " + $title,
            $layout: {
                $layoutType: $layoutType || "stack",
                $items: [{
                    $category: "block",
                    $test: true,
                    $skin: "s-" + $skin + "-h2",
                    $title: "Block " + $title,
                    $layout: {
                        $items: []
                    }
                }, {
                    $category: "block",
                    $test: true,
                    $skin: "s-" + $skin + "-h2",
                    $title: "Block " + $title,
                    $layout: {
                        $items: []
                    }
                }]
            }
        };
        if ($layoutType == "columns") {
            var oldLayout = section.$layout;
            section.$layout = {
                $layoutType: "columns",
                $layoutSubType: "50,50",
                $items: [{
                    $layoutType: "stack",
                    $items: [oldLayout.$items[0]]
                }, {
                    $layoutType: "stack",
                    $items: [oldLayout.$items[1]]
                }]
            };
        }
        return section
    },
    _makeLevel: function($title, $skin){
        return {
            $layoutType: "columns",
            $layoutSubType: "33,33,33",
            $items: [{
                $layoutType: "stack",
                $items: [this._makeLevelPart($title, $skin), this._makeLevelPart($title, $skin)]
            }, {
                $layoutType: "stack",
                $items: [this._makeLevelPart($title, $skin, "columns"), this._makeLevelPart($title, $skin, "tabs")]
            }, {
                $layoutType: "tabs",
                $items: [this._makeLevelPart($title, $skin, "tabs"), this._makeLevelPart($title, $skin)]
            }]
        };
    },
    _makeLevelTab: function($title, $items){
        return {
            $layoutType: "tabs",
            $items: [this._makeLevelPart(), this._makeLevelPart()]
        };
    }
});
