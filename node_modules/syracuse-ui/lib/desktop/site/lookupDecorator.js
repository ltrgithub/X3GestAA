"use strict";
var helpers = require('syracuse-core/lib/helpers');

function LookupDecorator(){
}

exports.LookupDecorator = helpers.defineClass(LookupDecorator, null, {
    open: function(options){
        var self = this;
        self.options = options;
        document.controller.loadRepresentation(options.article, options.$url, function($itemPage){
            $itemPage.$$container = $(document.createElement("div"));
            $itemPage.$displayTarget = "modal";
            self.lookupPage = document.itemFactory.loadPage($itemPage);
            if (self.options.onValidate) {
                self._appendOkButton();
            }
            self.lookupPage.onClose = function(){
                self.close();
                return false;
            };
            if (self.options.onSelectRecord) {
                self.lookupPage.onSelectRecord = function(selectedRecords){
                    if (self.options.onSelectRecord(selectedRecords, self.lookupPage) !== false) {
                        self.close();
                    }
                };
            }
        });
    },
    close: function(){
        this.lookupPage.$$container.remove();
        document.controller.disposeObject(this);
    },
    _appendOkButton: function(){
        var self = this;
        var btn = document.createElement("a");
        btn.className = "s-dialog-page-ok";
        self.$$okBtn = $(btn).bind("click", function(){
            if (self.options.onValidate(self.lookupPage) !== false) {
                self.close();
            }
            return false;
        }).appendTo(self.lookupPage.$$header);
    },
    dispose: function(){
        if (this.$$okBtn) {
            this.$$okBtn.unbind();
            delete this.$$okBtn;
        }
        if (this.options) {
            delete this.options.article;
            delete this.options.onValidate;
            delete this.options.onSelectRecord;
            delete this.options;
        }
    }
});
