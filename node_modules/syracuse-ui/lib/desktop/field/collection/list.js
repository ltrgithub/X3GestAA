"use strict";
var helpers = require('syracuse-core/lib/helpers');
var localize = require('syracuse-ui/lib/common/controller/localize').list;
var FilterRecord = require("./quickFilterArticle").FilterRecord;
var Pager = require("./pager").Pager;
var RawList = require("syracuse-ui/lib/common/field/collection/list").RawList;
var authoringOpener = require("./authoring/authoringOpener");

var GraphDecorator = require("./graphDecorator").GraphDecorator;

var _formatBuilders = {
    singleField: require("./builder/singleFieldListBuilder").Builder,
    reference: require("./builder/referenceListBuilder").Builder,
    grid: require("./builder/hgridBuilder").Builder,
    vgrid: require("./builder/vgridBuilder").Builder,
    cardList: require("./builder/cardListBuilder").Builder,
};


function _doSpeedTest($speedTest, $resources){
    if ($resources) {
        var $mems = [];
        for (var ii = 0; ii < self.$item.$speedTest; ii++) {
            $resources.forEach(function(record, $recordIndex){
                record.$uuid = document.controller.generateUUID();
                $mems.push(record);
            });
        }
        $resources = $mems;
        alert("start display");
    }
}


function DesktopList(){
}

exports.DesktopList = helpers.defineClass(DesktopList, RawList, {
    _initilializeList: function(){
        RawList.prototype._initilializeList.call(this);
        if (this.$prototype.$cube) {
            if ((this.$item.$graphMode = this.$item.$graphMode || "both") == "both") {
                this.$item.$graphPosition = "bottom";
            }
        }
    },
    createBuilder: function(){
        if (this.$field.$item.$type == "application/x-reference") {
            this.builder = new _formatBuilders.reference();
        }
        else {
            if (this.$field.$item.$type == "application/x-string") {
                this.builder = new _formatBuilders.singleField();
            }
            else {
                var $format = this.$item.$format || "grid";
                this.builder = new _formatBuilders[$format]();
                this.builder.$layoutOptions = this.$layoutOptions.builder[$format] || null;
            }
        }
        this.builder.list = this;
        this.builder.initialize();
        
    },
    reloadBuilder: function(){
        var self = this;
        setTimeout(function(){
            document.controller.disposeObject(self.builder);
            self.$$listSlot.empty();
            self.createBuilder();
            self.builder.drawBuilder();
        }, 20);
    },
    applyDesignMetaData: function(metadata, onAuthoring){
        if (onAuthoring) {
            if (metadata.$format !== undefined) {
                this.$item.$format = metadata.$format;
                this.reloadBuilder();
            }
            if (metadata.$isQuickFilter !== undefined) {
                this.$item.$isQuickFilter = metadata.$isQuickFilter;
                this.reloadBuilder();
            }
            if (metadata.$itemsPerPage !== undefined) {
                this.$item.$itemsPerPage = metadata.$itemsPerPage;
                this.onNotifyRecordChange(this.$item.$itemsPerPage = metadata.$itemsPerPage, "$itemsPerPage");
            }
        }
        if (this.$prototype.$cube) {
            if (!this.graphDecorator) {
                this.graphDecorator = new GraphDecorator();
            }
            this.graphDecorator.applyGraphSettings(this, metadata);
        }
        return RawList.prototype.applyDesignMetaData.call(this, metadata, onAuthoring);
    },
    getAuthoringWidget: function(){
        return new authoringOpener.WidgetAuthoring();
    },
    _appendCore: function(){
        var div = document.createElement("div");
        div.className = "s-list";
        this.$$list = $(div).appendTo(this.$$dataValue);
        
        div = document.createElement("div");
        div.className = "s-list-topbar";
        this.$$topbar = $(div).appendTo(this.$$list);
        
        div = document.createElement("div");
        div.className = "s-list-core";
        this.$$core = $(div).appendTo(this.$$list);
        
        div = document.createElement("div");
        div.className = "s-list-core-left";
        div.style.display = "none";
        this.$$coreLeft = $(div).appendTo(this.$$core);
        
        div = document.createElement("div");
        div.className = "s-list-core-right";
        this.$$listSlot = this.$$coreRight = $(div).appendTo(this.$$core);
        
        this._appendAuthoringOpener();
        
        this.appendArticleMenus();
        this.appendPager();
    },
    
    appendToCoreLeft: function($$child){
        this.$$coreLeft.append($$child)[0].style.display = "";
        return $$child;
    },
    appendQuickFilter: function(){
        if (this.$item.$isQuickFilter && this.$facet != "$details") {
            (this.quickFilterBox = new FilterRecord()).loadRecord(this);
        }
    },
    appendArticleMenus: function(){
        var div = document.createElement("div");
        div.className = "s-list-menus-cell";
        this._menus = document.itemFactory.load($(div).appendTo(this.$$topbar), {
            $id: this.id + "menus",
            $category: "links",
            $skin: this.$layoutOptions.menus
        }, this);
    },
    appendPager: function(){
        if (!this.$item.$isPagerHidden) {
            (this._pager = new Pager(this)).create(this, this.$$topbar);
        }
    },
    _appendAuthoringOpener: function(){
        if (this.$item.$isQuickDesignerEnabled !== false) {
            this.quickDesigner = new authoringOpener.QuickDesigner();
            this.quickDesigner.appendOpener(this)
        }
    },
    toggleRecordMenu: function(show, record){
        if (show && !record.menus) {
            record.menus = document.itemFactory.load(record.$$menuContainer, {
                $category: "links",
                $skin: this.builder.$layoutOptions.recordMenus,
                $moreLimit: 5
            }, record);
        }
        if (record.menus) {
            record.menus.$$item[0].style.visibility = show ? "" : "hidden";
            /*var $$item = record.menus.$$item;
             if (show) {
             if ($$item.parent().length == 0) {
             $$item.appendTo(record.menus.$$container);
             }
             }
             else {
             $$item.detach();
             }*/
        }
    },
    dispose: function(){
        delete this._menus;
        
        
        if (this.quickFilterBox) {
            this.removeItem(this.quickFilterBox);
            delete this.quickFilterBox;
        }
        RawList.prototype.dispose.call(this);
    }
});
