"use strict";
var helpers = require('syracuse-core/lib/helpers');

exports.drawDiagnose = function(field, $diagnose, severityGroup){
    var link = document.createElement("a");
    
    var label = document.createElement("label");
    label.className = "s-field-diagnose-msg-" + severityGroup.severity;
    
    if (field.isDiagnoseInPlace) {
        if (!field._diagnoseFlag) {
            field._diagnoseFlag = document.createElement("a");
            field._diagnoseFlag.className = "s-field-diagnose-flag-" + severityGroup.severity;
            field.appendToPickerBox(field._diagnoseFlag);
        }
        link.className = "s-field-diagnose-link s-field-diagnose-link-" + severityGroup.severity;
        label.innerHTML = document.site.formatHTMLMessage($diagnose.message);
        
        $(label).prepend($(link).text(field.getTitle() + ":")).appendTo(field.domDiagnose);
        
        var diagLink = document.createElement("a");
        diagLink.className = "s-diag-view-msg-link";
        diagLink.setAttribute("data-s-picker", "field-msg");
        diagLink.setAttribute("data-s-menu", field.id);
        diagLink.setAttribute("data-s-article", field.articleParent.id);
        var options = {};
        var index = field.arrayLevel && field.arrayLevel == "cell" ? ' (' + field.articleParent.dataset.$serverIndex + ')' : index; // in case of collection field
        options.$$fieldLink = $(diagLink).text((field.getTitle() || field.$field.$title) + index + " :");
        options.field = field;
        severityGroup.drawDiagnose($diagnose, options);
        drawBoxParentDiagnose(field, $diagnose);
        field.diagSeverities = field.diagSeverities || [];
        field.diagSeverities.push($diagnose.severity);
    }
    else {
        if (!severityGroup.$$group.children().children().children("a[data-s-menu='" + field.id + "']")[0]) {
            link.className = "s-diag-view-msg-link";
            link.setAttribute("data-s-picker", "field-msg");
            var options = {};
            
            // title for single record collections if not in field data
            if (!field.getTitle() && !field.$field.$title && field.arrayLevel && field.arrayLevel == "cell") {
                var parent = field.articleParent.articleParent;
                var title = parent.$field ? parent.$field.$title : title;
                options.$$fieldLink = $(link).text(title + ":");
            }
            else {
                options.$$fieldLink = $(link).text((field.getTitle() || field.$field.$title) + ":");
            }
            options.field = field;
            severityGroup.drawDiagnose($diagnose, options);
            drawBoxParentDiagnose(field, $diagnose);
            field.diagSeverities = field.diagSeverities || [];
            field.diagSeverities.push($diagnose.severity);
        }
        label.innerHTML = document.site.formatHTMLMessage($diagnose.message);
        field.domDiagnose.appendChild(label);
        link.setAttribute("data-s-menu", field.id);
    }
    link.setAttribute("data-s-article", field.articleParent.id);
    link.setAttribute("data-s-field", field.id);
};


/**********************Article diagnose (for article flaging, necessary to run field diagnose cleaning)*********/

/******** Box diagnose (for diagnose icon appending) ********/
function BoxDiagnose(titleDom, isTab){
    this.titleDom = titleDom;
    this.isTab = isTab;
    this.diagClassNameRoot = this.isTab ? "s-box-tab-" : "s-box-collapsible-";
    this.severitiesCount = {
        "error": 0,
        "fatal": 0,
        "warning": 0,
        "info": 0
    };
    this.fieldsData = [];
}

helpers.defineClass(BoxDiagnose, null, {
    addFieldData: function(fieldId, severity){
        var index;
        for (var ii = 0; ii < this.fieldsData.length; ii++) {
            index = this.fieldsData[ii].fieldId == fieldId ? ii : index;
            if (index != undefined) {
                break;
            }
        }
        var fieldData = index != undefined ? this.fieldsData[index] : {};
        fieldData.fieldId = fieldData.fieldId || fieldId;
        fieldData.severitiesCount = fieldData.severitiesCount ||
        {
            "error": 0,
            "fatal": 0,
            "warning": 0,
            "info": 0
        };
        fieldData.severitiesCount[severity]++;
        if (index != undefined) {
            this.fieldsData.splice(index);
        }
        this.fieldsData.push(fieldData);
    },
    getPrioritySeverity: function(){
        var priorityOrder = ["fatal", "error", "warning", "info"];
        var severity = "";
        for (var i = 0; i < priorityOrder.length; i++) {
            severity = this.severitiesCount[priorityOrder[i]] > 0 ? priorityOrder[i] : severity;
            if (severity) {
                return severity;
            }
        }
        return severity;
    },
    appendDiagnoseIcon: function(fieldId, severity){
        // add field data
        this.addFieldData(fieldId, severity);
        
        // following operations are only necessary for box with titleDom
        if (this.titleDom) {
            // add severity count
            this.severitiesCount[severity]++;
            var prioritySeverity = this.getPrioritySeverity();
            // two possibilites 
            //"icon already" -> change icon or not ?
            //"icon not yet" -> add it            
            // icon already appended
            if (this.$hasIcon) {
                // severity priority change ? else do nothing
                
                if (this.prioritySeverity != prioritySeverity) {
                    document.site.toggleClass(this.titleDom, this.diagClassNameRoot + this.prioritySeverity);
                    document.site.toggleClass(this.titleDom, this.diagClassNameRoot + prioritySeverity, true);
                    //this.$$titleDom.toggleClass(this.diagClassNameRoot + this.prioritySeverity).toggleClass(this.diagClassNameRoot + prioritySeverity);
                }
            }
            // icon not yet appended.
            else {
                document.site.toggleClass(this.titleDom, this.diagClassNameRoot + severity, true);
                //this.$$titleDom.addClass(this.diagClassNameRoot + severity);
                this.$hasIcon = true;
                
            }
            this.prioritySeverity = prioritySeverity;
            this.diagClassName = this.diagClassNameRoot + this.prioritySeverity;
        }
    },
    removeDiagnoseIcon: function(fieldId, severity){
        //var diagClassNameRoot = isTab ? "s-box-tab-" : "s-box-collapsible-";
        //var diagClassName = diagClassNameRoot + severity;  
        // remove field data
        if (this.fieldsData) {
            var index;
            for (var ii = 0; ii < this.fieldsData.length; ii++) {
                index = this.fieldsData[ii].fieldId == fieldId ? ii : index;
                if (index != undefined) {
                    break;
                }
            }
            // update field data
            if (index != undefined) {
                this.fieldsData[index].severitiesCount[severity]--;
            }
        }
        if (this.titleDom) {
            // decrease severity count
            this.severitiesCount[severity]--;
            
            // change icon if necessary
            // case 1 : no more priority -> remove
            // case 2 : priority
            // case 2-1 : same as old one, do nothing
            // case 2-2 : different than previous one, change
            
            var prioritySeverity = this.getPrioritySeverity();
            if (!prioritySeverity) {
                document.site.toggleClass(this.titleDom, this.diagClassNameRoot + this.prioritySeverity);
                //this.$$titleDom.toggleClass(this.diagClassNameRoot + this.prioritySeverity);
                this.$hasIcon = false;
            }
            else {
                if (this.prioritySeverity != prioritySeverity) {
                    document.site.toggleClass(this.titleDom, this.diagClassNameRoot + this.prioritySeverity);
                    document.site.toggleClass(this.titleDom, this.diagClassNameRoot + prioritySeverity, true);
                    //this.$$titleDom.toggleClass(this.diagClassNameRoot + this.prioritySeverity).toggleClass(this.diagClassNameRoot + prioritySeverity);
                }
            }
            this.prioritySeverity = prioritySeverity;
            this.diagClassName = this.diagClassNameRoot + this.prioritySeverity;
        }
    },
    dispose: function(){
        this.severitiesCount = this.titleDom = this.diagClassNameRoot = this.fieldsData = this.$hasIcon = this.prioritySeverity = this.diagClassName = null;
    }
});


exports.cleanRecordDiagnoses = function(record){
    var rr = record;
    var boxDiagnose = rr.boxDiagnose;
    if (boxDiagnose) {
    
        // get ids of fields concerned, and clean corresponding diagnose in diagnoses panel
        var ids = [];
        var fieldsData = boxDiagnose.fieldsData;
        var severities = ["fatal", "error", "warning", "info"];
        for (var ii = 0; ii < fieldsData.length; ii++) {
            var fieldId = fieldsData[ii].fieldId;
            ids.push(fieldId);
            record.page.diagnosesPanel.emptyDiagnoseByFieldId(fieldId);
        }
        
        // cleaning boxes up in the tree
        while (rr.boxParent) {
            if (boxDiagnose) {
                var fieldsData = boxDiagnose.fieldsData;
                for (var ii = 0; ii < fieldsData.length; ii++) {
                    var fieldId = fieldsData[ii].fieldId;
                    // only for the ids of the fields under the first concerned record
                    if (ids.indexOf(fieldId) != -1) {
                        for (var jj = 0; jj < severities.length; jj++) {
                            var severity = severities[jj];
                            var diagCount = fieldsData[ii].severitiesCount[severity];
                            while (diagCount > 0) {
                                boxDiagnose.removeDiagnoseIcon(fieldId, severity);
                                diagCount--;
                            }
                        }
                        
                    }
                    
                }
            }
            rr = rr.boxParent;
            boxDiagnose = rr.boxDiagnose;
        }
    }
};

function drawBoxParentDiagnose(field, $diagnose){
    var ff = field;
    while (ff.boxParent) {
        // collapsible
        //ff.boxParent.$opened
        if (ff.boxParent.$item.$isBoxCollapsable) {
            var html = document.createElement("a");
            ff.boxParent._header.appendChild(html);
            (ff.boxParent.boxDiagnose = ff.boxParent.boxDiagnose || new BoxDiagnose(html)).appendDiagnoseIcon(field.id, $diagnose.severity);
        }
        
        else 
            // tab 
            //ff.boxParent.isTabLayout
            if (ff.boxParent._tabTitle) {
                (ff.boxParent.boxDiagnose = ff.boxParent.boxDiagnose || new BoxDiagnose(ff.boxParent._tabTitle, true)).appendDiagnoseIcon(field.id, $diagnose.severity);
            }
            // other
            else {
                (ff.boxParent.boxDiagnose = ff.boxParent.boxDiagnose || new BoxDiagnose()).appendDiagnoseIcon(field.id, $diagnose.severity);
            }
        
        ff = ff.boxParent;
    }
};

function emptyBoxParentDiagnose(field){
    var ff = field;
    if (field.diagSeverities) {
        while (ff.boxParent) {
            if (ff.boxParent.boxDiagnose) {
                for (var ii = 0; ii < field.diagSeverities.length; ii++) {
                    ff.boxParent.boxDiagnose.removeDiagnoseIcon(field.id, field.diagSeverities[ii]);
                }
            }
            ff = ff.boxParent;
        }
        field.diagSeverities = null;
    }
};

exports.emptyDiagnoseSlot = function(field){
    if (field.domDiagnose) {
        document.site.emptyDom(field.domDiagnose);
        field.domDiagnose.style.visibility = "hidden";
        if (field._diagnoseFlag) {
            field.removeFromPickerBox(field._diagnoseFlag);
            delete field._diagnoseFlag;
        }
    }
    if (field.diagSeverities) {
        for (var ii = 0; ii < field.diagSeverities.length; ii++) {
            field.toggleDiagnose("s-" + field.diagSeverities[ii]);
        }
    }
    
    emptyBoxParentDiagnose(field);
};
exports.ensureDiagnoseSlot = function(field){
    if (!field.domDiagnose) {
        field.domDiagnose = document.createElement("div");
        field.domDiagnose.className = "s-field-diagnose";
        if (field.$item.$inplace && field.articleParent.ensureFieldDiagnoseSlot) {
            field.isDiagnoseInPlace = true;
            field.articleParent.ensureFieldDiagnoseSlot(field);
        }
        else {
            field._core.appendChild(field.domDiagnose);
        }
    }
    else {
        document.site.emptyDom(field.domDiagnose);
    }
};

exports.toggleDiagnose = function(field, css, show){
    if (field._input) {
        document.site.toggleClass(field._input, css, show);
    }
    document.site.toggleClass(field._dataValue, css, show);
};
