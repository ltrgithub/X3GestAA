"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DiagnoseMessagePopup = require('syracuse-ui/lib/diagnoses/diagnoseMessagePopup').DiagnoseMessagePopup;
var _field = require('syracuse-ui/lib/diagnoses/diagnoseField');

function _drawLinks(panel, diagInfo, slot, message, page) {
	message.$diagnosePanelId = panel.id;
	message.$diagnosesSlot = slot;
	syra_menus.setMenus(page || panel.page, message, slot);
	delete message.$diagnosePanelId;
	delete message.$diagnosesSlot;
}

function _addIconText(slot, text, severity) {
	slot.appendChild(syra_menus.addFontIconText(text, "s-diag-field s-diag-" + severity, severity == "info" ? severity : "diagnose"));
}

exports.onBoxItemInOut = function(box, onEnter) {
	if (box.severitiesCount) {
		if (onEnter) {
			if (!box.diagnosePopupSlot) {
				box.diagnosePopupSlot = document.createElement("div");
				box.diagnosePopupSlot.className = "s-diag-field-slot-popup";
				var severities = ["fatal", "error", "warning", "info", "success"];
				for (var ii = 0, jj = severities.length; ii < jj; ii++) {
					var severity = severities[ii];
					if (box.severitiesCount[severity]) {
						_addIconText(box.diagnosePopupSlot, box.severitiesCount[severity] + " " + syra_local["box_" + severity], severity);
					}
				}
				box.diagnosePopupDiag = syra_site.dialogManager.openPopup(box.page, {
					content: {},
					slot: box.diagnosePopupSlot,
					position: {
						my: "right top",
						at: "right bottom",
						of: $(box.btns.items.diagnoses)
					},
					onClose: function() {
						syra_site.dom.removeChild(box.diagnosePopupSlot);
						box.diagnosePopupSlot = box.diagnosePopupDiag = null;
					}
				});
			}
		} else {
			box.diagnosePopupDiag && box.diagnosePopupDiag.close();
		}
	}
};



function _showMessage(diagInfo, show) {
	diagInfo.msgItem.style.display = show ? "" : "none";
	if (show && !diagInfo.isDetailChecked) {
		diagInfo.isDetailChecked = true;
		if (diagInfo.$diagnose.$stackTrace || diagInfo.topLabel.scrollHeight > diagInfo.topLabel.clientHeight) {
			diagInfo.detailLink = syra_menus.addTextButton(syra_local.diag_stacktrace, "s-diagnose-msg-more", "onOpenDetail");
			diagInfo.msgItem.appendChild(diagInfo.detailLink);
		}
	}
}

function DiagnosesPanel() {}

exports.DiagnosesPanel = helpers.defineClass(DiagnosesPanel, null, {
	hasErrors: function(page) {
		for (var ii = this._diagnoses.length - 1; ii >= 0; ii--) {
			var diag = this._diagnoses[ii];
			if (diag.page == page) {
				switch (diag.$diagnose.$severity) {
					case "fatal":
					case "error":
					case "warning":
						return true;
				}
			}
		}
		return false;
	},
	addToPage: function(page) {
		this.page = page;
		this._diagnoses = [];
		this._diagnoseFocused = null;
		this.id = page.id + "diagnosepanel";
		syra_store.add(this);
		this.domItem = document.createElement("div");
		this.domItem.className = "s-diagnose";
		this.page.diagnoseSlot.className = "s-diagnose-page-slot";
		this.domItem.syraItem = this.id;
		this.body = document.createElement("div");
		this.body.className = "s-diagnose-msg-list";
		this.domItem.appendChild(this.body);

		this._closeBtn = syra_menus.addIconButton(syra_local.diag_close, "s-diagnose-close", "onClose");
		this._closeBtn.syraItem = this.id;
		this.isCollapsed = true;
		this.hide();
		this.page.diagnoseSlot.appendChild(this.domItem);
		this.page.diagnoseSlot.appendChild(this._closeBtn);
	},
	addTopLabel: function(diagInfo) {
		diagInfo.topLabel = document.createElement("label");
		diagInfo.topLabel.className = "s-diagnose-msg-label-hidden";
		diagInfo.topLabel.textContent = diagInfo.$diagnose.$message;

		var severity = diagInfo.$diagnose.$severity;
		var msg = diagInfo.msgItem = document.createElement("div");
		msg.className = "s-diagnose-msg s-diagnose-" + severity;
		msg.setAttribute("data-s-severity", severity);
		msg.syraOnClick = "onMessageClick";
		msg.appendChild(syra_menus.addFontIconFlag("s-diag-msg-flag s-diag-" + severity, severity == "info" ? severity : "diagnose"));

		msg.appendChild(diagInfo.topLabel);
		diagInfo.msgItem = msg;

		if (diagInfo.$diagnose.$links || diagInfo.$diagnose.$actions) {
			var slot = document.createElement("div");
			slot.className = "s-diagnose-links " + severity;
			_drawLinks(this, diagInfo, diagInfo.msgItem.appendChild(slot), diagInfo.$diagnose, diagInfo.page);
		}
		diagInfo.$diagnose.$stackTrace = diagInfo.$diagnose.$stackTrace || diagInfo.$diagnose.stackTrace;
		if (diagInfo.$diagnose.$stackTrace) {
			diagInfo.$diagnose.$stackTrace = syra_site.dom.formatHTMLText(diagInfo.$diagnose.$stackTrace, true);
			diagInfo.stackTrace = document.createElement("div");
			diagInfo.stackTrace.className = "s-diagnose-stacktrace";
			diagInfo.stackTrace.innerHTML = diagInfo.$diagnose.$stackTrace = syra_site.dom.formatHTMLText(diagInfo.$diagnose.$stackTrace, true);
			diagInfo.stackTrace.style.display = "none";
			msg.appendChild(diagInfo.stackTrace);
		}
		this.body.appendChild(msg);
	},
	_setExpandState: function() {
		var count = this._diagnoses.length;
		for (var ii = 0; ii < count; ii++) {
			_showMessage(this._diagnoses[ii], !this.isCollapsed);
		}
		if (!this._expandBtn) {
			this._expandBtn = syra_menus.addIconButton(syra_local.diag_expand, "s-diagnose-expander", "onExpand");
			this._expandBtn.style.display = "none";
			this._expandBtn.syraItem = this.id;
			this.page.diagnoseSlot.appendChild(this._expandBtn);
		}
		syra_site.dom.display(this._expandBtn, count > 1);
		if (this.isCollapsed) {
			var diagDisplay = this._diagnoseFocused || this._diagnoses[count - 1];
			if (diagDisplay) {
				_showMessage(diagDisplay, true);
			}
			this._expandBtn.textContent = (count - 1) + syra_local.diag_expand;
		}
		this._expandBtn.textContent = this.isCollapsed ? ((count - 1) + " " + syra_local.diag_expand) : syra_local.diag_collapse;
	},
	hide: function() {
		syra_site.dom.display(this._expandBtn, false);
		syra_site.dom.display(this._nextBtn, false);
		syra_site.dom.display(this._closeBtn, false);
		syra_site.dom.display(this.domItem, false);
	},
	clean: function() {
		if (this.domItem) {
			this.hide();
			if (this._menus && !this._menus.disposed) {
				this.removeItem(this._menus, true, true);
			}
			delete this._menus;
			this._diagnoseFocused = null;
			this._diagnoses = [];
			syra_site.dom.empty(this.body);
		}
	},
	getFieldDiagnoses: function(field) {
		var diags = [];
		for (var ii = 0, jj = this._diagnoses.length; ii < jj; ii++) {
			if (this._diagnoses[ii].field == field) {
				diags.push(this._diagnoses[ii]);
			}
		}
		return diags;
	},
	onFieldItemInOut: function(field, onEnter) {
		_field.onFieldItemInOut(this, field, onEnter);
	},
	onMessageClick: function(event, btn) {
		var self = this;
		var id = btn.getAttribute("data-s-diagmsg-popup");
		if (id) {
			if (self.diagPopups && self.diagPopups[id]) {
				self.diagPopups[id].close();
			}
		} else {
			var label = btn.children[0];
			if (btn.children[1] && btn.children[1].className == "s-diagnose-msg-hide") {
				var msgPopup = new DiagnoseMessagePopup();
				msgPopup.loadBox(label, btn.getAttribute("data-s-severity"));
				var diagPopup = syra_site.dialogManager.openPopup(self.page, {
					content: msgPopup,
					slot: msgPopup.domItem,
					position: {
						my: "left top",
						at: "left bottom",
						of: $(label)
					},
					onClose: function() {
						msgPopup.dispose();
						btn.removeAttribute("data-s-diagmsg-popup");
						self.diagPopups[this.id] = null;
					},
					$isAutoClose: false
				});
				diagPopup.appendCloseButton(msgPopup.header);
				btn.setAttribute("data-s-diagmsg-popup", diagPopup.id);
				self.diagPopups = self.diagPopups || {};
				self.diagPopups[diagPopup.id] = diagPopup;
			}
		}
	},
	onExpand: function() {
		this.isCollapsed = !this.isCollapsed;
		this._setExpandState();
		this.page.resizeArticle();
	},
	goToField: function(event, btn) {
		var field = syra_store.get(btn.syraFieldId);
		if (field) {
			field.focus && field.focus();
			this.onNavigationClick(event, 0, field);
		}
	},
	onClose: function() {
		this.hide();
		if (this._diagnoseFocused && !this._diagnoseFocused.field) {
			this._diagnoseFocused = null;
		}
		if (this.body) {
			syra_site.dom.empty(this.body);
			if (this._diagnoses.length > 0) {
				var ii = 0;
				while (ii < this._diagnoses.length) {
					var diag = this._diagnoses[ii];
					if (!diag.field) {
						if (diag == this._diagnoseFocused) {
							this._diagnoseFocused = null;
						}
						delete diag.msgItem;
						this._diagnoses.splice(ii, 1);
					} else {
						ii++;
					}
				}
			} else {
				this.clean();
			}
		}
		this.page.resizeArticle();
	},
	onOpenDetail: function(event, btn) {
		for (var ii = 0, jj = this._diagnoses.length; ii < jj; ii++) {
			var diagInfo = this._diagnoses[ii];
			if (diagInfo.detailLink == btn) {
				diagInfo.isExpanded = !diagInfo.isExpanded;
				diagInfo.topLabel.className = diagInfo.isExpanded ? "s-diagnose-msg-label" : "s-diagnose-msg-label-hidden";
				if (diagInfo.stackTrace) {
					diagInfo.stackTrace.style.display = diagInfo.isExpanded ? "" : "none";
				}
				break;
			}
		}
		this.page.resizeArticle();
	},
	onNavigationClick: function(event, btn, field) {
		if (this._diagnoses && this._diagnoses.length > 0) {
			var focused = this._diagnoseFocused;
			var diags = field && this.getFieldDiagnoses(field);
			if (!btn && diags && diags.length) {
				focused = diags[0];
			} else {
				var first, last, next;
				for (var ii = 0, jj = this._diagnoses.length; ii < jj; ii++) {
					var diagnose = this._diagnoses[ii];
					if (diagnose.field) {
						last = diagnose;
						if (first == undefined) {
							first = last;
						}
						if (this._diagnoseFocused && this._diagnoseFocused.field == diagnose.field) {
							next = true;
						} else {
							if (next === true) {
								next = last;
							}
						}
					}
				}
				if (this._diagnoseFocused) {
					focused = this._diagnoseFocused == last ? first : ((next === true) ? first : next);
				} else {
					focused = first;
				}
				focused.field.focus && focused.field.focus();
			}
			if (this._diagnoseFocused) {
				syra_site.dom.removeChild(this._diagnoseFocused.focuseFlag);
				delete this._diagnoseFocused.focuseFlag;
			}
			this._diagnoseFocused = focused;
			if (!this._diagnoseFocused.focuseFlag) {
				this._diagnoseFocused.focuseFlag = syra_menus.addFontIconFlag("s-diagnose-msg-focus", "right_arrow");
				this._diagnoseFocused.topLabel.parentNode.insertBefore(this._diagnoseFocused.focuseFlag, this._diagnoseFocused.topLabel);
			}
			if (this._diagnoseFocused.msgItem) {
				syra_page.scrollToItem(syra_site, this._diagnoseFocused.msgItem, this.domItem, true);
			}
			this._setExpandState();
		}
	},

	showDiagnoses: function(message, page, options) {
		if (!message || (!message.$bind && !message.field && !message.$diagnoses)) {
			this.clean();
		} else {
			if (message.field && message.field.$item.$isExpressionChild) {
				return;
			}
			if (message.$links || message.$actions) {
				if (!this._diagViewLinks) {
					this._diagViewLinks = document.createElement("div");
					this._diagViewLinks.className = "s-diagnose-links-main";
					this.domItem.appendChild(this._diagViewLinks);
				}
				_drawLinks(this, this, this._diagViewLinks, message, page);
			}
			if (message.field && (message.field.diagsSlot || message.field.mnPickers.diagnose || (message.$diagnoses === null))) {
				_field.clean(this, message.field);
			}
			if (message.$diagnoses) {
				for (var ii = 0, jj = message.$diagnoses.length; ii < jj; ii++) {
					var $diagnose = message.$diagnoses[ii];
					$diagnose.$severity = $diagnose.severity || $diagnose.$severity || "error";
					$diagnose.$message = $diagnose.message || $diagnose.$message;
					if ($diagnose.$message) {
						$diagnose.$message = syra_site.dom.formatHTMLText($diagnose.$message, true);
					}
				}
			}
			if (message.field) {
				_field.show(this, message);
			} else {
				if (message.$diagnoses && message.$diagnoses.length > 0) {
					for (var ii = 0, jj = message.$diagnoses.length; ii < jj; ii++) {
						var diagInfo = {
							page: page,
							article: page,
							$diagnose: message.$diagnoses[ii]
						};
						this.addTopLabel(diagInfo);
						this._diagnoses.push(diagInfo);
					}
				}
			}
			if (!options || !options.noViewer) {
				this.autoHide = message.autoHide;
				this.refresh();
			}
		}
	},
	refresh: function() {
		var self = this;
		if ((self.page == syra_site) || (self.page.isPageLoaded && !self.page._isDataChanging)) {
			var show, showNext;
			if (self._diagnoses.length > 0) {
				show = true;
				var count = 0;
				for (var ii = 0, jj = self._diagnoses.length; ii < jj && count <= 1; ii++) {
					if (self._diagnoses[ii].field) {
						count++;
					}
				}
				showNext = count > 1;
				if (showNext && !self._nextBtn) {
					self._nextBtn = syra_menus.addTextButton(syra_local.diag_next, "s-diagnose-nav-next", "onNavigationClick");
					self._nextBtn.title = syra_local.diag_next_tooltip;
					self._nextBtn.syraItem = self.id;
					self.page.diagnoseSlot.appendChild(self._nextBtn);
				}
				var zIndex = syra_site.dom.getTopZIndex() - 1;
				self._setExpandState();
				syra_site.dom.setZIndex(self._nextBtn, false, zIndex);
				syra_site.dom.setZIndex(self._expandBtn, false, zIndex);
				syra_site.dom.setZIndex(self._closeBtn, false, zIndex);
				syra_site.dom.setZIndex(self.domItem, false, zIndex);
			} else {
				syra_site.dom.display(self._expandBtn, false);
			}
			syra_site.dom.display(self._nextBtn, showNext);
			syra_site.dom.display(self._closeBtn, show);
			syra_site.dom.display(self.domItem, show);
			if (self.autoHide) {
				setTimeout(function() {
					self.clean();
					self.page && self.page.resizeArticle();
				}, self.autoHide || 4000);
				delete self.autoHide;
			}
		}
	},
	dispose: function() {
		syra_store.remove(this);
		syra_site.disposeObject(this);
	}
});