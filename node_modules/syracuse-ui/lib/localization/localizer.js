"use strict";
var helpers = require('syracuse-core/lib/helpers');
var TranslationPage = require('syracuse-ui/lib/localization/translationPage').TranslationPage;


function _ensureLocalizeItemId($item) {
	if (!$item.$title || $item.$title.indexOf("{@") < 0) {
		$item.$title = "{@" + helpers.uuid.generate() + "}";
	}
}

function _extractTitleKey($title) {
	return syra_site.expressionMaker.extractCode($title);
}

function _updatePageLocalization(page, $key, values) {
	var language = exports.getLanguage();
	var $localization = page.$item.$localization = page.$item.$localization || {};
	for (var ii = 0, jj = values.length; ii < jj; ii++) {
		var value = values[ii];
		if (value.$value) {
			($localization[value.$locale] = $localization[value.$locale] || {})[$key] = value.$value;
			if (value.$locale == language) {
				(page.$prototype.$localization = page.$prototype.$localization || {})[$key] = value.$value;
			}
		} else {
			if ($localization[value.$locale]) {
				delete $localization[value.$locale][$key];
				if (!Object.keys($localization[value.$locale]).length) {
					delete $localization[value.$locale];
				}
			}
		}
	}
}


function _setPageLocalizationEntry(page, $key, $value) {
	if (page && page.$item) {
		var $localization = page.$item.$localization = page.$item.$localization || {};
		var language = exports.getLanguage();
		if (language) {
			($localization[language] = $localization[language] || {})[$key] = $value;
			(page.$prototype.$localization = page.$prototype.$localization || {})[$key] = $value;
		}
	}
};

exports.getLanguage = function() {
	return syra_site.userProfile.currentLangCode;
};


exports.getDefaultTabTitle = function(boxParent, $id) {
	var defaultTitle = syra_local.defaultTabTitle;
	var tabs = boxParent.layoutContent && boxParent.layoutContent.items;
	var count = 1;
	if (tabs) {
		for (var ii = 0, jj = tabs.length; ii < jj; ii++) {
			var title = tabs[ii].getTitle() || "";
			if (title.indexOf(defaultTitle) >= 0) {
				count++;
			}
		}
	}
	var $key = "@" + ($id || helpers.uuid.generate());
	_setPageLocalizationEntry(boxParent.page, $key, defaultTitle + " " + count);
	return "{" + $key + "}";
};

exports.applyPageLocalization = function(page) {
	var $pageLocal = page.$item.$localization;
	if ($pageLocal) {
		var langs = Object.keys($pageLocal);
		if (langs.length) {
			var language = exports.getLanguage();

			var $localization;
			if (language) {
				$localization = $pageLocal[language] || $pageLocal[language.toLowerCase()];
			}
			if (!$localization) {
				$localization = $pageLocal["en-us"] || $pageLocal[langs[0]] || $pageLocal[langs[0].toLowerCase()];
			}
			if ($localization) {
				page.$prototype.$localization = page.$prototype.$localization || {};
				syra_site.deltaManager.applyObjectDelta(page, page.$prototype.$localization, $localization);
			}
			page.$prototype.$allLocalization = $pageLocal;
		}
	}
};


function _onValidateFieldValue(page, field) {
	page.validateFields();
	var $menu = page.$menus.$save;
	if ($menu.$url !== 'test') { // 'test' is $url value for $save link in test page
		var reqOpt = {
			method: $menu.$method,
			$location: {
				$url: $menu.$url
			},
			data: {
				$values: page.$values
			},
			$contentType: "application/json"
		};
		syra_controller.sendRequest(null, reqOpt, function(data, response, $url) {
			// assuming client receives data for the underneath page
			if (!(field.articleParent.onLocalizeField && !field.articleParent.onLocalizeField(field, data, response, $url))) {
				field.page.applyChange(data);
			}
			page.dialogWrapper && page.dialogWrapper.close(undefined, true);

		}, function(error) {
			var $diagnoses;
			if (error.data.indexOf("$diagnoses") != -1) {
				$diagnoses = JSON.parse(error.data).$diagnoses;
			} else {
				$diagnoses = [{
					$severity: "error",
					$message: error.data
				}];
			}
			syra_site.showDiagnoses({
				$diagnoses: $diagnoses
			}, page);
		});
		return false;
	}
	return true;
}

function _localizeFieldValue(field, $menu) {
	var value = field.getDataValue();
	if (!value || value == '') {
		syra_diagnose.showBox({
			$title: syra_local.fieldEmptyErrLocalizeTitle,
			$message: syra_local.fieldEmptyErrLocalize,
			$type: "warning",
			$buttons: "ok",
			$default: "ok"
		});
	} else {
		syra_controller.sendRequest(null, {
			method: "GET",
			$location: {
				$url: syra_site.expressionMaker.parse(field.articleParent, $menu.$url)
			}
		}, function(data, response, $url) {
			if (!data.$values) {
				syra_site.showDiagnoses({
					$diagnoses: [{
						$message: syra_local.lPageNoValues
					}]
				}, field);
				return false;
			}
			var translationPage = new TranslationPage();
			translationPage.isReadOnly = !(data.$links && data.$links.$save);
			translationPage.loadBox(data);
			if (translationPage.menuBar) {
				translationPage.menuBar.toggleBar(false);
			}
			var options = {
				page: translationPage
			};
			if (!translationPage.isReadOnly) {
				options.onValidate = function(page) {
					return _onValidateFieldValue(page, field);
				};
			}
			syra_site.dialogManager.openPage(field.page, options);
		}, function(error) {
			var $diagnoses;
			if (error.data.indexOf("$diagnoses") != -1) {
				$diagnoses = JSON.parse(error.data).$diagnoses;
			} else {
				$diagnoses = [{
					$severity: "error",
					$message: error.data
				}];
			}
			syra_site.showDiagnoses({
				$diagnoses: $diagnoses
			});
		});
	}
}

function _localizeSectionTitle(field, $menu) {
	syra_site.userProfile.getRegionalPreferences(function(preferences) {
		var $pageLocalization = field.page.designedArticle.$item.$localization || {};
		var $values = [];
		var section = field.localizedSection;
		var $titleKey = _extractTitleKey(section.$item.$title);
		for (var ii = 0, jj = preferences.length; ii < jj; ii++) {
			var value = {
				$title: preferences[ii].description,
				$locale: preferences[ii].code,
			};
			if ($pageLocalization[value.$locale]) {
				value.$value = $pageLocalization[value.$locale][$titleKey];
			}
			$values.push(value);
		}
		var translationPage = new TranslationPage();
		translationPage.loadBox({
			$values: $values
		});
		syra_site.dialogManager.openPage(field.page, {
			page: translationPage,
			onValidate: function(page) {
				page.validateFields();
				_updatePageLocalization(section.page, $titleKey, page.$values);
				section.setTitle(section.$item.$title);
				field.setDataValue(section.getTitle());
				field.page.saveDesign(); //page is designer
				return true;
			}
		});
	});
}

exports.setSectionTitleEditor = function(field, section) {
	field.localizedSection = section;
	_ensureLocalizeItemId(section.$item);
	if (section.isTitleUnlocalized) {
		field.setDataValue("");
	} else {
		field.setDataValue(section.getTitle());
	}
};

exports.onSectionTitleEditorChange = function(field, value) {
	var section = field.localizedSection;
	_setPageLocalizationEntry(section.page, _extractTitleKey(section.$item.$title), value);
	section.setTitle(section.$item.$title);
};
exports.onMenuClick = function(field, $menu) {
	if (field.localizedSection) {
		_localizeSectionTitle(field, $menu);
	} else {
		_localizeFieldValue(field, $menu);
	}
};