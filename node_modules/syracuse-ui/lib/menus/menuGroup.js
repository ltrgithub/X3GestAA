"use strict";
var helpers = require('syracuse-core/lib/helpers');
var SectionBlock = require('syracuse-ui/lib/article/sectionBlock').SectionBlock;

function MenuGroup() {}

exports.MenuGroup = helpers.defineClass(MenuGroup, SectionBlock, {
	ensureSkin: function() {
		if (this.$item.$skin == "s-mn-h2") {
			delete this.$item.$skin;
		}
		SectionBlock.prototype.ensureSkin.call(this);
	},
	getDefaultTitle: function() {
		return syra_local.box_menusTitle;
	},
	initializeSection: function($item) {
		if ($item.$skin == "s-page-menus") {
			$item.$skin = "s-mn-bar-main";
		}
		SectionBlock.prototype.initializeSection.call(this, $item);
	},
	loadBox: function() {
		this.page.registerSectionBlock(this);
		this.boxChildItems = [];
		if (this.isSectionRoot = (!this.boxParent.isMenuGroup)) {
			this.ensureLinkSettings(this.$item, this.$item.$isBoxCollapsable);
			this.menuGroupRoot = this;
		} else {
			var parent = this.boxParent;
			while (parent) {
				if (parent.menuGroupRoot) {
					this.menuGroupRoot = parent.menuGroupRoot;
					break;
				}
			}
		}
		if (this.menuGroupRoot && this.menuGroupRoot.$item.$isAuthoringEnabled === false) {
			this.$item.$isAuthoringEnabled = false;
		}
		this.isMenuGroup = true;

		this.$childMenus = {};
		this.$item.$name = this.$item.$name || this.$clientId; //used for authoring
		this.drawBox();
		this.page.userPreferences && this.page.userPreferences.applyToMenuGroup(this);
		if (this.$item.$isMenusBag) {
			this.articleParent.menusBags.push(this);
		}
		if (this.isSectionRoot) {
			this.setRootGroupCss();
			if (this.$item.$vignette && this.page.registerVignette) {
				this.page.registerVignette(this, this.$item.$vignette);
			}
		} else {
			if (this.boxParent.$item.$isPopupContent) {
				this.setRootGroupCss();
			}
		}
	},
	setRootGroupCss: function() {
		syra_site.dom.toggleClass(this.body, "s-menu-group-root", true);
		syra_site.dom.toggleClass(this.header, "s-menu-group-root", true);
		syra_site.dom.toggleClass(this.domItem, "s-menu-group-root", true);
	},
	doOpenPicker: function() {
		if (this.$item) {
			this.page.onMenuGroupClick(this);
			SectionBlock.prototype.doOpenPicker.call(this);
		}
	},
	ensureLayoutMode: function() {
		SectionBlock.prototype.ensureLayoutMode.call(this);
		if (this.domItem && this.boxParent.isMenuGroup) {
			if (this.layoutParent.$layout.$layoutType != "row") {
				this.domItem.className += " s-menu-sub";
			}
		}
	},
	ensureLinkSettings: function($item, $isCollapsable, $layoutItems) {
		var $skinLink = $item.$itemSkin || ($item.$skin || this.$skin) + "-link";
		var $items = $layoutItems || $item.$layout.$items;
		if ($items) {
			for (var ii = 0, jj = $items.length; ii < jj; ii++) {
				var $child = $items[ii];
				if ($child.$bind) {
					if (!$child.$category || $child.$category == "link") {
						$child.$category = "link";
						if (!$child.$skin) {
							$child.$skin = $skinLink;
						}
						if ($item.$itemIcon) {
							if ($child.$icon === undefined) {
								$child.$icon = $item.$itemIcon;
							} else {
								if ($child.$icon !== null) {
									if (!$child.$icon.$mode) {
										$child.$icon.$mode = $item.$itemIcon.$mode;
									}
									if (!$child.$icon.$path) {
										$child.$icon.$path = $item.$itemIcon.$path;
									}
								}
							}
						}
						if ($item.$isDescriptionVisible && $child.$isDescriptionVisible === undefined) {
							$child.$isDescriptionVisible = true;
						}
					}
				} else {
					if ($child.$layout || $child.$category == "menus") {
						$child.$skin = $child.$skin || ($item.$skin || this.$skin);
						$child.$itemSkin = $child.$itemSkin || $item.$itemSkin;
						$child.$category = $child.$category || "menus";
						if (!$child.$layout) {
							$child.$layout = {};
						}
						if (!$child.$layout.$items) {
							$child.$layout.$items = [];
						}
						if ($child.$isBoxCollapsable === undefined) {
							$child.$isBoxCollapsable = $isCollapsable;
						}
						this.ensureLinkSettings($child, $child.$isBoxCollapsable);
					} else
					if ($child.$layoutType) {
						this.ensureLinkSettings($item, $isCollapsable, $child.$items); //$item is the box parent
					}
				}
			}
		}

	},

	_registerMenuItem: function($bind, $isAction, $icon) {
		if (!this.$childMenus[$bind]) {
			this.$item.$layout.$items.push(this.$childMenus[$bind] = {
				$category: "link",
				$bind: $bind,
				$skin: this.$item.$itemSkin || (this.$skin + "-link"),
				$isAction: $isAction,
				$icon: $icon || this.$itemIcon,
				$isDescriptionVisible: this.$isDescriptionVisible
			});
		}
		return this.$childMenus[$bind];
	},
	_loadNewMenuItem: function($bind, $isAction, $icon) {
		var newItem;
		var $menu = this._registerMenuItem($bind, $isAction, $icon);
		if (this.layoutContent) {
			//no layoutContent if popup
			this.layoutContent.isItemRegisterDisable = true;
			newItem = this.layoutContent.createChildItem($menu);
			this.layoutContent.isItemRegisterDisable = false;
		} else {

			// this.ensureVisibility($bind);
		}
		return newItem;
	},
	_ensurePrivateMenus: function($menus, $menuType, $isAction) {
		var $links = $menus[$menuType];
		if ($links) {
			var ids = Object.keys($links);
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				var id = ids[ii];
				var prefixId = id;
				prefixId = this.id + "-" + prefixId;
				var $menu = $links[id];
				if ($menu === null) {
					syra_menus.removeMenu(this.articleParent, prefixId, true);
				} else {
					var menuItem = this.articleParent.menuItems[prefixId];
					if (!menuItem) {
						menuItem = this._loadNewMenuItem(prefixId, $isAction);
						this.articleParent.$menus[prefixId] = $menu;
					} else {
						menuItem = menuItem[0];
					}
					if (menuItem) {
						$menu.$isAction = $isAction;
						$menu.$menuType = $menuType;
						$menu.$bind = prefixId;
						$menu.$sourceBind = id;
						$menu.$ownerGroupId = this.id;
						menuItem.setMenu($menu, this.articleParent.dataset);
					}
				}
			}
		}
	},
	ensurePrivateMenus: function($menus) {
		this._ensurePrivateMenus($menus, "$links");
		this._ensurePrivateMenus($menus, "$actions", true);
	},
	renderLayoutContent: function() {
		if (this.$item.$isMenusBag && this.articleParent.$menus) {
			var $binds = Object.keys(this.articleParent.$menus);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var $bind = $binds[ii];
				var $menu = this.articleParent.$menus[$bind];
				if (!($menu.$ownerGroupId && $menu.$ownerGroupId != this.id)) {
					var item = this.articleParent.menuItems[$bind];
					if (!item || (item.length == 0)) {
						this._registerMenuItem($bind, $menu.$isAction);
						//push only item load is done box renderLayoutContent
					}
				}
			}
		}
		SectionBlock.prototype.renderLayoutContent.call(this);
	},
	addMenuItem: function($menu, record) {
		if (this.articleParent.onAddMenuItem ? this.articleParent.onAddMenuItem($menu, record) : true) {
			this._loadNewMenuItem($menu.$bind, $menu.$isAction, $menu.$icon);
		}
	},
	unload: function() {
		if (this.$item.$isOwner) {
			for (var ii = 0, jj = this.$item.$layout.$items.length; ii < jj; ii++) {
				syra_menus.removeMenu(this.articleParent, this.$item.$layout.$items[ii].$bind);
			}
		}
		this.articleParent.removeItem(this, true, true); //remove dom
	},
	dispose: function() {
		this.menuGroupRoot = this.contextField = this.$childMenus = null;
		SectionBlock.prototype.dispose.call(this);
	}
});