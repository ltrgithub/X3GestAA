"use strict";
var helpers = require('syracuse-core/lib/helpers');

function _showDiagnoses(menu, $delta){
    var $menu = menu.articleParent.$menus[menu.$item.$bind];
    if ($menu && $menu.$links) {
        var $binds;
        var $links = $menu.$links || {};
        if ($delta.$links) {
            $binds = Object.keys($delta.$links);
            for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
                var $bind = $binds[ii];
                var $source = $delta.$links[$bind];
                var $target = $links[$bind] = $links[$bind] || {};
                var $props = Object.keys($source);
                for (var kk = 0, mm = $props.length; kk < mm; kk++) {
                    var $prop = $props[kk];
                    $target[$prop] = $source[$prop];
                }
            }
        }
        $binds = Object.keys($links);
        for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
            var $bind = $binds[ii];
            var $link = $links[$bind];
            $link.$bind = $bind + "-" + menu.id;
            $link.$url = menu.articleParent.formatMenuUrl($link);
        }
        var options = {};
        options.menu = menu;
        document.site.showDiagnoses({
            $links: $links,
            $diagnoses: $delta.$diagnoses
        }, menu.articleParent, options);
    }
}

function _onMenuItemClick(menuItem){
    var doClick = true;
    if (document.site.authorPage) {
        doClick = document.site.authorPage.onMenuClick(menuItem);
    }
    if (doClick && menuItem.boxParent) {
        doClick = menuItem.boxParent.onMenuClick ? menuItem.boxParent.onMenuClick(menuItem) : true;
        if (doClick) {
            doClick = menuItem.articleParent.onMenuClick ? menuItem.articleParent.onMenuClick(menuItem) : true;
        }
    }
    
    if (doClick) {
        if (menuItem.onMenuClick ? menuItem.onMenuClick() : true) {
            document.controller.executeMenu(menuItem);
        }
    }
    setTimeout(function(){
        if (menuItem) {
            var parent = menuItem.boxParent;
            while (parent && !parent.disposed) {
                if (parent._popupMenus) {
                    parent._popupMenus.close();
                    break;
                }
                parent = parent.boxParent;
            }
        }
    }, 10);
}

function MenuItem(){

}

exports.MenuItem = helpers.defineClass(MenuItem, null, {
    ensureLayoutMode: function(){
        if (this.layoutParent) {
            this.layoutParent.ensureLayoutSlot(this);
        }
        /*  if (this.page.authoringPage) {
         this.page.authoringPage.toggleItemAuthoring(this, true);
         }*/
    },
    setStyle: function($style){
        if ($style === null) {
            if (this.$style) {
                document.site.toggleClass(this._label, this.$style, false);
                document.site.toggleClass(this.mn, this.$style, false);
            }
            this.$style = null;
        }
        else {
            this.$style = "s-cst-sty-" + $style;
            document.site.toggleClass(this._label, this.$style, true);
            document.site.toggleClass(this.mn, this.$style, true);
        }
    },
    loadBox: function(record){
        this.$skin = this.$item.$skin || "s-link";
        this.mn = document.createElement("a");
        this.mn.style.display = "none";
        this.mn.className = ((this.$item.$css) ? (this.$item.$css + " ") : "") + this.$skin;
        this.mn.setAttribute("data-s-menu", this.id);
        this.mn.setAttribute("data-s-article", this.articleParent.id);
        this.$$item = $(this.layoutSlot.appendChild(this.mn));
        this._label = document.createElement("div");
        this._label.className = this.$skin + "-label";
        this.$subRecordKey = this.$item.$subRecordKey;
        if (this.$item.$style) {
            this.setStyle(this.$item.$style);
        }
        this.mn.appendChild(this._label);
        if (this.$item.$isDescriptionVisible) {
            this._description = document.createElement("div");
            this._description.className = this.$item.$skinDescription || (this.$skin + "-desc");
            // this.layoutSlot.appendChild(this._description);
            this.mn.appendChild(this._description);
        }
        
        if (this.$item.$bind) {
            var bounds = this.articleParent.menuItems[this.$item.$bind];
            if (!bounds) {
                bounds = this.articleParent.menuItems[this.$item.$bind] = [];
            }
            bounds.push(this);
            var $menu = this.articleParent.$menus[this.$item.$bind];
            if ($menu) {
                this.setMenu($menu, record);
            }
        }
        else {
            if (this.$item.$link) {
                this.setMenu(this.$item.$link);
            }
        }
        this.ensureLayoutMode();
    },
    unbind: function(){
        if (this.articleParent && this.articleParent.menuItems) {
            var bounds = this.articleParent.menuItems[this.$item.$bind];
            if (bounds) {
                for (var ii = 0; ii < bounds.length; ii++) {
                    if (bounds[ii] == this) {
                        bounds.splice(ii, 1);
                        break;
                    }
                }
            }
        }
    },
    getArticle: function(){
        if (!this.articleParent) {
            this.articleParent = this.boxParent ? this.boxParent.getArticle() : null;
        }
        return this.articleParent;
    },
    getTitle: function(){
        if (this.titleText == null && this.$title) {
            this.titleText = this.$title || "";
            if (this.titleText.length > 0 && this.titleText[1] == "@") {
                this.titleText = this.boxParent._renderExpression(this.titleText);
            }
        }
        return this.titleText || "";
    },
    setTitle: function($value){
        this.$title = $value;
        delete this.titleText;
        var title = this.getTitle();
        if (this._label) {
            this._label.textContent = title;
        }
        this.mn.title = title;
    },
    setDescription: function($value){
        this.$description = $value;
        if (this._description) {
            this._description.textContent = $value;
        }
        else {
            this.mn.title = $value;
        }
    },
    setState: function(state){
        if (state.$isHidden !== undefined) {
            if (state.$isHidden !== undefined) {
                this.$isHidden = state.$isHidden;
            }
            this.mn.style.display = this.$isHidden ? "none" : "";
            if (this.layoutSlot) {
                this.layoutSlot.style.display = this.$isHidden ? "none" : "";
            }
        }
    },
    disable: function($value){
        document.site.disableItem(this.mn, this.$isDisabled = $value || false);
    },
    click: function(){
        var self = this;
        document.site.onBeforClick();
        if (!self.$isDisabled) {
            if (self.page) {
                var options = {
                    menuItem: self,
                    doEvent: function(){
                        _onMenuItemClick(self);
                    }
                };
                if (self.boxParent && self.boxParent.contextField) {
                    //boxParent is menubox of contextMenu
                    self.contextField = options.field = self.boxParent.contextField;
                }
                self.page.externalAdapter.onMenuItemClick(options);
            }
            else {
                _onMenuItemClick(self);
            }
        }
    },
    _setIconMenu: function(){
        this.$icon = this.$item.$icon || {};
        if (!this.iconValue) {
            this.iconValue = document.createElement("div");
            this.iconValue.className = this.mn.className + "-icon";
            this.mn.insertBefore(this.iconValue, this._label);
            if (this.$icon.$mode == "icon") {
                this._label.style.display = "none";
                this.mn.className += " s-icon";
            }
            else {
                this.mn.className += " s-icon-label";
                this.iconValue.className += " s-label";
            }
            this._label.className += " s-icon";
        }
        this._setIconValue();
    },
    _setIconValue: function(){
        var name = this.value || this.$icon.$value || this.$item.$bind.replace("$", "");
        if (this.$icon.$useCss) {
            this.iconValue.className += " " + this.iconValue.className + "-" + name;
        }
        else {
            var $path = document.site.$item.$iconPath + (this.$icon.$path || "");
            this.iconValue.style.backgroundImage = "url('" + $path + name + ".png')";
        }
    },
    setValue: function(newValue){
        this.value = newValue;
        if (this.iconValue) {
            this._setIconValue();
        }
    },
    setMenu: function($menu, record){
        var self = this;
        var article = this.articleParent;
        if ($menu) {
            if (this.boxParent.isMenuGroup) {
                this.boxParent.ensureVisibility(this.$item.$bind, this);
            }
            if (!this._init) {
                this.articleParent.onMenuDataFilled();
                this.mn.style.display = "";
                if (this.layoutSlot) {
                    this.layoutSlot.style.display = "";
                }
                this.setState(this.$item);
                if (!$menu.$title && this.$item.$title) {
                    $menu.$title = this.$item.$title; //use for pager (next prev) currently
                }
                if (this.$item.$value) {
                    this.value = this.$item.$value;
                }
                if (this.$item.$icon) {
                    this._setIconMenu();
                }
                else {
                    if (this.$item.$noText) {
                        this._label.style.display = "none";
                    }
                }
                this._init = true;
            }
            if ($menu.$title !== undefined) {
                this.setTitle($menu.$title);
            }
            if ($menu.$description !== undefined) {
                this.setDescription($menu.$description);
            }
            this.setState($menu);
            
            if ($menu.$isDisabled !== undefined) {
                this.disable($menu.$isDisabled);
            }
            if ($menu.$style !== undefined) {
                this.setStyle($menu.$style);
            }
            var props = Object.keys($menu);
            for (var ii = 0, jj = props.length; ii < jj; ii++) {
                var prop = props[ii];
                this[prop] = $menu[prop];
            }
            if (this.$isDisabled && $menu.$isRequested === false) {
                if (this.$item.onServerRequest ? this.$item.onServerRequest(this) : true) {
                    if ($menu.$diagnoses) {
                        _showDiagnoses(this, $menu);
                    }
                    if ($menu.$clientAgent) {
                        var agent = document.site.agents[$menu.$clientAgent.$id];
                        if (agent) {
                            agent[$menu.$clientAgent.$action](this, $menu, record);
                        }
                    }
                    if ($menu.$links && $menu.$links.$location) {
                        var $url = $menu.$links.$location.$url;
                        setTimeout(function(){
                            document.site.unload();
                            window.open($url, "_self");
                        }, 100);
                    }
                }
                $menu.$isRequested = true; //avoid procsessing action for other menu bound to $menu (create menu for sample)
            }
        }
        if (!this.$sourceUrl || ($menu && $menu.$url)) {
            this.$sourceUrl = this.$url;
            if (this.$type && (this.$type.indexOf('json') == -1) && (this.$type != "html")) {
                if (this.$sourceUrl && (this.$sourceUrl.indexOf("format=") < 0)) { // TODO: improve this hack
                    this.$sourceUrl += "&format=" +
                    this.articleParent.formatMenuUrl({
                        $url: this.$type,
                        $parameters: this.$parameters
                    }, record);
                }
            }
        }
        this.$url = this.$sourceUrl;
        if (this.$type && (this.$type.indexOf('json') == -1) && (this.$type != "html")) {
            this.mn.setAttribute("target", this.$target = "blank");
            this.mn.setAttribute("href", this.$url = this.articleParent.formatMenuUrl(this, record));
            this.value = this.$type.replace("application/", "");
            if (!this.$item.$icon) {
                this.$item.$icon = {
                    $path: "file/s-link-"
                };
            }
            this._setIconMenu();
            if (this.$title !== undefined) {
                this.setTitle(this.$title);
            }
        }
        else {
            if (this.mn) {
                if (this.$url) {
                    this.mn.setAttribute("href", "?url=" + encodeURIComponent(this.$url = this.articleParent.formatMenuUrl(this, record)));
                    if (this.$url.indexOf("http") >= 0 && this.$url.indexOf(window.location.host) < 0) {
                        this.mn.setAttribute("target", this.$target = "blank");
                    }
                }
                else {
                    this.mn.setAttribute("href", "#");
                }
            }
        }
        if (this.$target == "blank") {
            this._label.className += " s-external-link";
        }
    },
    dispose: function(){
        delete this.contextField;
        this.article = this.articleParent = this.page = this.onMenuClick = this.$item = this.layoutSlot = null;
        this.$url = this.mn = this.$$item = this._label = this.$title = null;
    }
});
