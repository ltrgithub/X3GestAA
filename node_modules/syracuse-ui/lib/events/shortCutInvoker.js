"use strict";

function _walkTabs(tab, shortcuts, focusedTab) {
	if (focusedTab && focusedTab.layoutParent == tab.layoutParent) {
		tab = focusedTab;
	}
	var items = tab.layoutParent.items;
	var max = items.length - 1;
	var ii = items.indexOf(tab);
	while (true) {
		if (shortcuts.right) {
			if (ii == max) {
				ii = 0;
			} else {
				ii++;
			}
		} else {
			if (ii == 0) {
				ii = max;
			} else {
				ii--;
			}
		}
		if (!items[ii].isInvisible) {
			tab.page.focusedTab = items[ii];
			items[ii].tabTitle.click();
			return;
		}
	}
}

function _walkPageTabs(item, shortcuts, event) {
	var section;
	var page = item.page;
	if (event.shiftKey || (page == item)) { //ESC + SHIFT + LEFT-RIGHT, or page level 
		for (var ii = 0, jj = page.childrenSection.length - 1; ii < jj; ii++) {
			section = page.childrenSection[ii];
			if (section.isTabLayout) {
				_walkTabs(section, shortcuts, page.focusedTab);
				return;
			}
		}
	}
	//tab not found at top level, walk from item level
	section = item.boxParent;
	while (section) {
		if (section.isTabLayout) {
			_walkTabs(section, shortcuts, page.focusedTab);
			return;
		}
		section = section.boxParent;
	}
	if (page.focusedTab) {
		_walkTabs(page.focusedTab, shortcuts);
	} else {
		(page != item) && _walkPageTabs(page, shortcuts, event); //test to avoid loop on page
	}
}

exports.applyEscape = function(item, shortcuts, event) {
	var isApplyed;
	if (item.isField) {
		if (item.applyEscape) {
			return item.applyEscape(shortcuts, event); //close choice, date, time selectors
		}
		if (item.popupPicker) {
			item.popupPicker.close();
			isApplyed = true;
		} else {
			isApplyed = item.onFieldInputEvent(event, shortcuts);
		}
	}!isApplyed && item.page.dialogWrapper && item.page.dialogWrapper.close();
};

exports.apply = function(item, shortcuts, event) {
	if (item.variantItem) {
		return exports.apply(item.variantItem, shortcuts, event);
	}
	var isPage = item.page == item;
	if (shortcuts.esc) {
		if (shortcuts.f1) {
			//open help on item, SHIFT open help on page
			syra_site.helpCenter.openByShortCut(item.page, (event.shiftKey || isPage) ? null : item);
			return true;
		}
		if (shortcuts.f5) {
			//refresh page data with autofetch mode
			if (isPage) {
				syra_menus.click.refreshPageData(item);
				return true;
			}
		}
		if (shortcuts.f6) {
			//showProperty of field. Currently for fusion. Syracuse to do
			syra_menus.click.showFieldProperty(item);
			return true;
		}
		if (shortcuts.f9) {
			//open fusion tunnel
			return item.isField && syra_menus.click.tunnel(item);
		}
		if (shortcuts.f11 || (shortcuts.h && !shortcuts.g)) {
			//switch left /right side bar
			var switchLeft = shortcuts.f11 || (shortcuts.h && (shortcuts.a || shortcuts.l));
			var switchRight = shortcuts.f11 || (shortcuts.h && (shortcuts.a || shortcuts.r));
			if (switchLeft || switchRight) {
				syra_site.siteFunctions.togglePageSideBar(item.page, switchLeft, switchRight);
			}
			return true;
		}
		if (shortcuts.m || shortcuts.f4) {
			//open contextual menu
			return syra_menus.click.contextualMenu(event.shiftKey ? item.articleParent : item);
		}
		if (shortcuts.insert || shortcuts.n) {
			//trigger create action
			return syra_menus.click.create(item);
		}
		if (shortcuts["delete"]) {
			//trigger delete action
			return syra_menus.click.deleteItem(item);
		}
		if (shortcuts.enter) {
			//trigger main action of page
			isPage && syra_menus.click.main(item);
			return true;
		}
		if (shortcuts.a) {
			if (isPage && event.ctrlKey) {
				item.selectTex && item.selectText();
				return true;
			}
			if (item.isList && item.selectHTMLContent) {
				item.selectHTMLContent();
				return true;
			}
		}
		if (shortcuts.p) {
			isPage && syra_menus.click.print(item);
			return true;
		}
		if (shortcuts.k) {
			isPage && syra_menus.click.next(item, event.shiftKey);
			return true;
		}
		if (shortcuts.j) {
			isPage && syra_menus.click.prev(item, event.shiftKey);
			return true;
		}
		if (shortcuts.g) {
			if (shortcuts.h) {
				syra_menus.click.home();
			}
			return true;
		}
		if (item.isField && ((!shortcuts.h && shortcuts.l) || shortcuts.f12)) {
			syra_menus.click.selector(item);
			return true;
		}
		if (shortcuts.r) {
			var lists = [];
			item.isList && lists.push(item);
			if (isPage) {
				lists = item.getLists();
			}
			if (lists.length) {
				var hasFit;
				for (var ii = 0, jj = lists.length; ii < jj; ii++) {
					if (lists[ii].columnFitter) {
						hasFit = true;
						lists[ii].columnFitter.reCalculate();
					}
				}
				return hasFit;
			}
		}
		if (item.isField && shortcuts.t) { //date=Today
			if (item.applyShortCut && item.applyShortCut(shortcuts, event)) {
				return true;
			}
		}
		if (isPage && shortcuts.f7 || ((shortcuts[":"] && event.shiftKey) || shortcuts.s || shortcuts.divide)) {
			syra_menus.click.goToSearch(item);
			return true;
		}
		if (shortcuts.left || shortcuts.right) {
			_walkPageTabs(item, shortcuts, event);
			return true;
		}
		if (shortcuts.tab) {
			if (item.isField && item.articleParent.isRecordArticle) {
				item.page.externalAdapter.onFieldClickPicker({
					field: item,
					pickerType: "cancelEdit"
				});
			}
			return true;
		}

	} else {
		if (shortcuts.enter) {
			if (isPage && item.isMessageBox) {
				item.onMenuClick({
					$bind: item.focusBtnId
				});
				event.returnValue = false;
				event.preventDefault();
				event.stopPropagation();
				return true;
			}
		}
		if (shortcuts.tab) {
			if (isPage && item.isMessageBox) {
				if (item.$itemButtons.length > 1) {
					var ii, len;
					for (ii = 0, len = item.$itemButtons.length; ii < len; ii++) {
						if (item.$itemButtons[ii].$bind == item.focusBtnId) {
							break;
						}
					}
					if (ii < len) {
						ii = event.shiftKey ? (ii == 0 ? len - 1 : ii - 1) : (ii + 1 == len ? 0 : ii + 1);
						syra_site.dom.toggleClass(item.getMenuItem(item.focusBtnId).domItem, "s-msgbox-button-default", false);
						item.focusBtnId = item.$itemButtons[ii].$bind;
						syra_site.dom.toggleClass(item.getMenuItem(item.focusBtnId).domItem, "s-msgbox-button-default", true);
						setTimeout(function() {
							item.getMenuItem(item.focusBtnId).domItem.focus();
						}, 5);
					}
				}
				event.returnValue = false;
				event.preventDefault();
				event.stopPropagation();
				return true;
			}
			if (item.isField && item.$item.$contentEditable) {
				item.onInputChange(item.input, event);
				return true;
			}
		}
		if (item.isField || item.isList) {
			if (item.applyShortCut) {
				return item.applyShortCut(shortcuts, event);
			}
			if (item.onFieldInputEvent && (shortcuts["delete"] || shortcuts.insert || shortcuts.right || shortcuts.left)) {
				return item.onFieldInputEvent(event, shortcuts);
			}
			if (item.$item.$bind === "$search" && item.applyShortCuts) {
				item.applyShortCuts(shortcuts, event);
			}
			if (shortcuts.enter) {
				if (item.$item.$contentEditable) {
					item.onInputChange(item.input, event);
					event.preventDefault();
					event.stopPropagation();
					return true;
				}
				if (item.$item.$bind === "$search" && item.articleParent.isList) {
					var list = item.articleParent;
					if (list.isList && list.searchCapability) {
						list.searchCapability.onClick(item.articleParent, "$searchNext", event);
					}
					return true;
				}
				if (item.page.isTranslationPage && item.page.appendNewRow) {
					item.page.appendNewRow(shortcuts.enter, shortcuts.tab, item);
				}
				// is ie10
				var identity = syra_site.browser.getIdentity();
				if (identity.isMSIE && item.input && item.getDataValue() !== item.currentValue) {
					if (identity.info.indexOf("10.0") != -1) {
						item.onInputChange(item.input, event);
					}
				}
			}

			if (shortcuts.down || shortcuts.up) {
				if (shortcuts.down) {
					if (syra_menus.click.selector(item, true)) {
						return true;
					}
				}
				if (!item.articleParent.popupCard && item.onFieldInputEvent) {
					return item.onFieldInputEvent(event, shortcuts);
				}
			}
		}
	}
};