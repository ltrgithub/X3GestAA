"use strict";
var helpers = require('syracuse-core/lib/helpers');
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var tabletUtil = require('./helpers');
var _menuImgs = ["first", "last", "next", "previous"];
var _escapeFields = ["application/x-string", "application/x-date", "application/x-integer", "application/x-decimal", "application/x-reference"];

function numericField() {
	var NumericField = require('syracuse-ui/lib/field/numericField').NumericField;
	// Display numeric keyboard -> Type should be number
	var render = NumericField.prototype.render;
	NumericField.prototype.render = function() {
		var res = render.call(this);
		this.input && this.input.setAttribute("type", "number");
		return res;
	};
}

// Add new events

function events(site) {
	// Bind click on Escape/Reset button
	$(site.layoutSlot).delegate("[data-m-picker]", "mousedown click", function(event) {
		var attr = $(event.target).attr('data-m-picker') || "";
		if (attr == "escapefield") {
			// Escape from a field
			var field = syra_site.findField(this);
			if (field) {
				if (event.type == "mousedown") {
					// Stop to prevent focusOut of input field
					event.stopPropagation();
					event.preventDefault();
				} else
				if (event.type == "click") {
					var s = field.diagnoseFieldSlot ? field.diagnoseFieldSlot.style : null;
					if (s) {
						// We don't want o display field's error message on click on escape button
						s.display = "none";
					}
					// Simulate escape
					field.mobileEscape(attr, true);
					if (s) {
						window.setTimeout(function() {
							// We restore old display status
							s.display = "";
						}, 200);
					}
				}
			}
		} else
		if (attr == "escapeline") {
			// Escape from a line in edit mode
			// Retrieve field
			var id = $(this).attr("data-m-id");
			var input = $(this.parentNode).find("#" + id);
			if (input.length > 0) {
				var field = syra_site.findField(input[0]);
				if (field) {
					// Simulate escape
					// Escape field before escaping line - SHould be fixed by client team
					field.mobileEscape("escapefield", false);
					window.setTimeout(function() {
						field.mobileEscape(attr, false);
					}, 100);
				}
			}
		}
	});
}

// Escape button on grid fields -> Send ESCAPE to X3

function gridEventHandling() {
	var GridEventHandling = require('syracuse-ui/lib/fusion/core/client/eventhandling/grid').GridEventHandling;
	// Hard to hack....
	var sap = new GridEventHandling.sap();
	// get event listeners by creating a new class 
	var eventListeners = new GridEventHandling.sap().eventListeners();
	// Hack listener for "wdgt.cell.keydown" event
	var keyDownCellTab = null;
	eventListeners.forEach(function(x) {
		if (x[0] == "wdgt.cell.keydown") {
			keyDownCellTab = x[1];
			// Set my function
			x[1] = function(event) {
				var keycode = event.data.nativeEvt.keyCode;
				var typeEscape = event.data.nativeEvt.typeEscape;
				// Hack VK_ESCAPE only if escape from field
				// if escapeline we call the standard method which escape the line
				if ("escapefield" == typeEscape && event.target && !sapUtil.isSpecialKey(keycode) && keycode == keys["VK_ESCAPE"]) {
					// Process field event instead of gridField -> Restore previous value
					// Escape on GridField do not restore the previous value
					event.target.page.externalAdapter.onFieldEvent(event.data.nativeOpt, true);
					// Clear diagnose
					event.data.nativeOpt.field.showErrors([]);
					return true;
				}
				// Call std listener
				return keyDownCellTab(event);
			};
		}
	});
	// create new hack class
	GridEventHandling.sap = function() {
		this.eventListeners = function() {
			// return hacked listener
			return eventListeners;
		};
	};
}

// Remove Error icon and Error message on grid field - Keep just the red border (not enough room)

function restorePickersStyle(self) {
	var a = [];
	a.push(self.boxPickers);
	a.push(self.menusBox ? self.menusBox.domItem : null);
	a.push(self.input);
	a.forEach(function(x) {
		if (x && x.style.display != "none") {
			x.style.paddingRight = self.input == x ? "5px" : "0px";
			x.style.display = "table-cell";
			x.style.position = "relative";
		}
	});
}

function field() {
	var Field = require('syracuse-ui/lib/field/field').Field;
	// Replace <label> by <div> - remove 'for' attribute
	// On a tablet the label is sensitive - click sets focus on attached field
	Field.prototype.appendTitle = function() {
		if (!(this.$item.$inplace || this.$item.$isTitleHidden)) {
			this.domTitle = document.createElement("div");
			this.domTitle.className = this._$cssTopField + "-title";
			this.domItem.appendChild(this.domTitle);
		}
	};
	// Force use table display for field pickers instead of absolute position
	// -> we need to put the pickers out of the input area
	var loadBox = Field.prototype.loadBox;
	Field.prototype.loadBox = function() {
		var self = this;
		loadBox.call(self);
		if (self.input) {
			// Add escape button at the end of icons list only in fusion page
			if (self.page.isFusionPage && !self._tabletEscapePicker && (_escapeFields.indexOf(this.$field.$type) >= 0)) {
				self._tabletEscapePicker = document.createElement("div");
				self.fieldValue.appendChild(self._tabletEscapePicker).className = self.$skin + "-escape";
				// Create my own picker with data-m-picker attribute - See events function above
				var btn = document.createElement("a");
				var css = this.$skin + "-" + "escape";
				if (this.$item.$css) {
					css = this.$item.$css + " " + css;
				}
				btn.className = css + "-picker";
				btn.setAttribute("data-m-picker", "escapefield");
				self._tabletEscapePicker.appendChild(btn);
				var s = self.domValueSlot ? self.domValueSlot.style : null;
				if (s && s.maxWidth) {
					// We add 15px to width - maxWidth = 120px - To improve
					var w = s.maxWidth.split(/\D/)[0];
					if (w.length > 0 && !isNaN(w)) {
						s.maxWidth = (parseInt(w) + 15) + "px";
					}
				}
			}
			var parent = $(self.input.parentNode);
			parent.css({
				"display": "table"
			});
			parent.children().each(function(idx, elmt) {
				var e = $(elmt);
				if (e.hasClass("s-field-context-menus") || e.hasClass("s-field-pickers")) {
					e.css({
						"position": "relative",
						"display": "table-cell",
						"padding-right": "0px",
						"padding-left": idx == 0 ? "3px" : "0px"
					});
					e.find("a").css({
						"width": "22px"
					});
				} else
				if (e.hasClass("s-field-input-ref-desc")) {
					// Description in bottom/left
					e.css({
						"position": "absolute",
						"left": "0px",
						"top": "20px"
					});
				}
			});
			// 5PX on right side for input - See also setState if paddingRight is changed
			self.input.style.paddingRight = "5px";
		}
		self.boxPickersPadding = 0;
	};
	// Restore table display style (field class resets display by setting display to empty value)
	var setState = Field.prototype.setState;
	Field.prototype.setState = function(state) {
		var self = this;
		setState.call(self, state);
		restorePickersStyle(self);
	};
	// Restore table display if lost (field class resets display by setting display to empty value)
	var setMenusBox = Field.prototype.setMenusBox;
	Field.prototype.setMenusBox = function(metaData) {
		setMenusBox.call(this, metaData);
		if (this.menusBox && this.menusBox.domItem) {
			var s = this.menusBox.domItem.style;
			if (s.display != "none") {
				s.paddingRight = "0px";
				s.display = "table-cell";
				s.position = "relative";
			}
		}
	};
	var showDiagnoses = Field.prototype.showDiagnoses;
	Field.prototype.showDiagnoses = function($diagnoses, options) {
		var self = this;
		showDiagnoses.call(self, $diagnoses, options);
		// Hide contextual menu and display escape/reset button
		if (self._tabletEscapePicker) {
			var ctxMenu = self.menusBox ? self.menusBox.domItem : null;
			if ($diagnoses.length > 0) {
				self._tabletEscapePicker.style.display = "table-cell";
				if (ctxMenu)
					ctxMenu.style.display = "none";
			} else {
				self._tabletEscapePicker.style.display = "none";
				if (ctxMenu)
					ctxMenu.style.display = "table-cell";
			}
		}
	};
	// Disable mouseenter/mouseleave process - no mouse events on a tablet
	var onItemInOut = Field.prototype.onFieldMouseEvent;
	Field.prototype.onItemInOut = function() {
		return;
	};
	// Send shiftTAB event on "escape button" click
	Field.prototype.mobileEscape = function(type, setFocus) {
		var self = this;
		if (self._tabletEscapePicker) {
			// Simulate a keydown event with escape keycode on input field
			// --> Restore previous valid value
			var e = jQuery.extend(new jQuery.Event(), {
				type: type == "escapefield" ? "keydown" : "keyup",
				target: self,
				keyCode: keys["VK_ESCAPE"],
				isSimulated: true,
				originalEvent: {},
				// We store the type of escape in e.typeEscape - See gridEventHandling
				typeEscape: type
			});
			self.page.externalAdapter.onFieldEvent({
				field: self,
				event: e,
				doEvent: function() {}
			});
			if (this.input && setFocus) {
				// Set focus on input because focus has been lost by click on picker
				$(this.input).focus();
			}
			return true;
		}
		return false;
	};
	var showItem = Field.prototype.showItem;
	Field.prototype.showItem = function(show) {
		var self = this;
		showItem.call(self, show);
		if (self.$item.$inplace && self._dataValue.style.display == "") {
			// restore table display for grid fields
			self._dataValue.style.display = "table";
		}
	};
	// Add this method
	Field.prototype.isGridCell = function() {
		return this.arrayLevel && this.arrayLevel == "cell";
	};

	// Show/Hide an escape line button in the first cell of the grid for cells in focusin/focusout
	// TODO - optimize and test for different type of grids and card view
	var onFieldInputEvent = Field.prototype.onFieldInputEvent;
	Field.prototype.onFieldInputEvent = function(event, shortcuts) {
		var self = this;
		onFieldInputEvent.call(self, event, shortcuts);
		// Only fields on which we need an escape for the line
		if (self.isGridCell() && self.$isEditMode && self.input && (event.type == "focusin" || event.type == "focusout")) {
			var list = self.articleParent;
			var line = list.domItem.find ? list.domItem : $(list.domItem);
			var cellIdx = line.find(".s-grid-row-index");
			if (cellIdx.length == 0)
				return;
			cellIdx = cellIdx[0];
			var $cellEsc = line.find(".s-field-escape-picker");
			var cellEsc = $cellEsc.length > 0 ? $cellEsc[0] : null;
			if (event.type == "focusout") {
				// Restore index cell in any cases
				if (cellEsc)
					cellEsc.style.display = "none";
				if (cellIdx)
					cellIdx.style.display = "table-cell";
			} else
			if (cellEsc != null && cellEsc.style.display == "table-cell") {
				// Escape already displayed - Just save field ID
				$cellEsc.attr("data-m-id", $(self.input).attr("id"));
			} else
			if (self._tabletEscapePicker) {
				var input = $(self.input);
				if (!input.hasClass('s-x3mode-command')) {
					if (cellEsc == null) {
						// create escape cell and attach it to the row
						$cellEsc = $('<td  class="s-grid-cell s-field-escape-picker" data-m-picker="escapeline"></td>');
						line.prepend($cellEsc);
						cellEsc = $cellEsc[0];
					}
					// Switch cell index to cell escape
					cellEsc.style.display = "table-cell";
					cellIdx.style.display = "none";
					// SAve field ID
					$cellEsc.attr("data-m-id", $(self.input).attr("id"));
				}
			}
		}
	};
}

function menuItem() {
	var MenuItem = require('syracuse-ui/lib/menus/menuItem').MenuItem;
	var MenuGroup = require('syracuse-ui/lib/menus/menuGroup').MenuGroup;
	// Hide excel and word links in right panel
	var loadBox = MenuItem.prototype.loadBox;
	MenuItem.prototype.loadBox = function() {
		var res = loadBox.call(this);
		var hidden = false;
		// syracuse
		// console.log(this.$item.$bind + "/" + (this.$type && typeof this.$type));
		if (this.$item.$bind && typeof this.$item.$bind === "string" &&
			(this.$item.$bind.indexOf("$word") === 0 ||
				this.$item.$bind.indexOf("$excel") === 0 ||
				this.$item.$bind.indexOf("$pptslide") === 0)) {
			hidden = true;
		}
		// cvg by type
		else
		if (this.$type && typeof this.$type === "string" &&
			(this.$type.indexOf("application/syracuse-excel-worksheet") >= 0 ||
				this.$type.indexOf("application/syracuse-word-report") >= 0 ||
				this.$type.indexOf("application/syracuse-word-mailmerge") >= 0 ||
				this.$type.indexOf("application/syracuse-ppt-slide") >= 0)) {
			hidden = true;
		}
		// cvg by special name
		else
		if (this.$item.$bind && typeof this.$item.$bind === "string" &&
			(this.$item.$bind.indexOf("cvgOffice") === 0)) {
			hidden = true;
		}

		if (hidden === true) {
			this.$isHidden = true;
			this.showItem(!this.$isHidden);
		}
		return res;
	};

	/*
     Hide utilities menu
     */
	function isMenuGroupHidden($item) {
		var ids = ["318", // SUBMENU_DIAGNOS_CMN
			"40003", // Global export
			"18000" //Export
		];
		return ($item && $item.$clientId && ids.indexOf($item.$clientId) >= 0) ? true : false;
	}
	var menuGroupLoadBox = MenuGroup.prototype.loadBox;
	var menuGroupShowItem = MenuGroup.prototype.showItem;
	MenuGroup.prototype.loadBox = function() {
		var res = menuGroupLoadBox.call(this);
		if (isMenuGroupHidden(this.$item)) {
			if (this.domItem) {
				this.$isHidden = true;
				this.showItem(false);
			}
		}
		return res;
	};
	MenuGroup.prototype.showItem = function(show) {
		if (isMenuGroupHidden(this.$item)) {
			show = false;
		}
		var res = menuGroupShowItem.call(this, show);
		return res;
	};
	// 
	var setIconValue = MenuItem.prototype._setIconValue;
	MenuItem.prototype._setIconValue = function() {
		var name = this.$iconValue || this.value || this.$icon.$value || this.$item.$bind.replace("$", "");
		if (_menuImgs.indexOf(name) >= 0) {
			var $path = "/syracuse-ui/themes/tablet/sage/images/" + (this.$icon.$path || "");
			this.iconValue.style.backgroundImage = "url('" + $path + name + ".png')";
		} else {
			setIconValue.call(this);
		}
	};
}

function commonEventHandlingTools() {
	var CommonEventHandlingTools = require('syracuse-ui/lib/fusion/core/client/eventhandling/common').CommonEventHandlingTools;
	CommonEventHandlingTools._checkCtxMenuEntry = function(men) {
		if (men && men.id && men.id === "$tabularExport")
			return false;
		return true;
	};
}

function removeFlash() {
	var flashWidget = require('syracuse-ui/lib/field/chart/flashWidget');
	flashWidget.FlashWidget.prototype.drawBox = function() {
		var $cnt = $("<div class=\"s-h1-body s-cst-sty-not-sup\">" + syra_local.table_not_sup + "</div>");
		$(this.layoutSlot).append($cnt);
	};
	flashWidget.FlashWidget.prototype.resizeChart = function() {};
	flashWidget.FlashWidget.prototype.setDataBind = function(dataRecordSet, parentDataRecord, metaData) {};
	flashWidget.FlashWidget.prototype.applyDesignMetaData = function(metadata, designing) {};
	flashWidget.FlashWidget.prototype.dispose = function() {};

	flashWidget.CubeChart.prototype.drawBox = function() {
		var $cnt = $("<div class=\"s-h1-body s-cst-sty-not-sup\">" + syra_local.table_not_sup + "</div>");
		$(this.layoutSlot).append($cnt);
	};
	flashWidget.CubeChart.prototype.resizeChart = function() {};
	flashWidget.CubeChart.prototype.setDataBind = function(dataRecordSet, parentDataRecord, metaData) {};
	flashWidget.CubeChart.prototype.applyDesignMetaData = function(metadata, designing) {};
	flashWidget.CubeChart.prototype.dispose = function() {};
}

function adjustHighcharts() {
	var highCharts = require('syracuse-ui/lib/field/chart/highCharts');
	highCharts.TabularChart.prototype._printSupported = function() {
		return false;
	};
	highCharts.TabularChart.prototype._exportSupported = function() {
		return false;
	};
}

exports.initAfterLoad = function(site) {
	numericField();
	field();
	menuItem();
	commonEventHandlingTools();
	removeFlash();
	adjustHighcharts();
	gridEventHandling();
	events(site);

};