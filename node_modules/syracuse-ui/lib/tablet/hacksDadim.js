"use strict";
var helpers = require('syracuse-core/lib/helpers');
// !! Put the required in the functions by class instead of header because required could be buggy
var util = require('syracuse-ui/lib/fusion/core/client/sap/util');
var keys = require('syracuse-ui/lib/fusion/tools/constant').keybordKey;
var tabletUtil = require('./helpers');
var sapUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Fusion;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;

function WorkBook() {

	var sdataHost = (window.location.protocol.toLowerCase() === "file:") ? "" : (window.location.protocol + "//" + window.location.host);



	var WorkBook = require('syracuse-ui/lib/fusion/workBook').WorkBook;
	var _onFieldEvent = WorkBook.prototype.onFieldEvent;

	WorkBook.prototype.onFieldEvent = function(options, redirect) {


		var inputs = this.selectedSheet.fieldsOrder;





		if (options && options.event && options.event.type === "focusin" //
			&& options.event.relatedTarget //
			&& options.event.relatedTarget.id != "s-site-body" //
			&& !options.field.context //
			&& !$(options.event.relatedTarget).is(".s-fusion-bar-block-title")) {
			var controller = this.fusionSite.controller._hosterController;
			var srcField = controller.findField(options.event.relatedTarget);





			if (!redirect && srcField && srcField.arrayLevel && sapUtil.isListScreen(syraUtil.getMetaFromObject(srcField).$bind)) {
				tabletUtil.logOnServer("LEFT LIST");


				var e = jQuery.extend(new jQuery.Event(), {
					type: "keydown",
					target: options.event.relatedTarget,
					keyCode: keys["VK_TAB"],
					isSimulated: true,
					shiftKey: (backward) ? true : false,
					originalEvent: {},

				});
				options.field = srcField;
				options.event = e;
			} else {

				var targetId = (options.field.$item && options.field.$item.$bind) || "";
				//tabletUtil.logOnServer("focusin becomes tabulation from "  + options.event.relatedTarget.value + " -- " + options.event.relatedTarget.id);
				var ctrler = this.fusionSite.controller._sapController;
				var curentFusionField = ctrler.getCurrInst();
				tabletUtil.logOnServer("curentFusionField " + curentFusionField.xid);
				var curDomElmt = ctrler.getBoundField(curentFusionField);

				//tabletUtil.logOnServer("curentFusionField "+curentFusionField.xid) ;
				var srcId = curentFusionField.xid;


				if (srcField)
					srcField.context = 0;

				//tabletUtil.logOnServer( "srcId: " + srcId + " numid: "+inputs[srcId]);
				//tabletUtil.logOnServer( "targetId: "+ targetId+ " numid: "+inputs[targetId]);

				var targetnl = (options.field.arrayLevel == "cell") ? options.field.getArticle().$serverIndex + 1 : null;

				//tabletUtil.logOnServer( "targetnl: "+ targetnl);
				//tabletUtil.logOnServer( "curentFusionField.nl: "+ curentFusionField.nl);


				var backwardLine = (targetnl != null && curentFusionField.nl !== null && curentFusionField.nl > targetnl);
				var sameLine = (!targetnl || !curentFusionField.nl || targetnl != null && curentFusionField.nl !== null && curentFusionField.nl == targetnl);
				//tabletUtil.logOnServer("backwardLine: "+backwardLine);
				var backward = (backwardLine || (sameLine && inputs[srcId] > inputs[targetId]));

				var e = jQuery.extend(new jQuery.Event(), {
					type: "keydown",
					target: curDomElmt.$$item.get(0),
					keyCode: keys["VK_TAB"],
					isSimulated: true,
					shiftKey: (backward) ? true : false,
					originalEvent: {},

				});

				options.event = e;
				options.field = curDomElmt;
				//tabletUtil.logOnServer( " field id=" + options.field.id);
				//tabletUtil.logOnServer("backward  " + backward);
			}
		} else {
			if (options && options.event && options.event.type === "mousedown")
				options.field.context = 1;
			if (options && options.event && options.event.type === "focusin")
				options.field.context = 0;
		}
		return _onFieldEvent.call(this, options, redirect);

	};
}


exports.init = function() {
	WorkBook();
};