"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Field = require('syracuse-ui/lib/field/field').Field;
var locale = require('syracuse-core/lib/locale');

function TextPlainField() {}

exports.TextPlainField = helpers.defineClass(TextPlainField, Field, {
	initialize: function() {
		this.$item.$rows = this.$item.$rows || 5;
		this.$lazyUrl = this.$field.$url && this.articleParent.parseExpression(this.$field.$url);
		this.$contentType = this.$field.$type === 'application/x-document' && this.$field.$contentType || this.$field.$type;
	},

	getLazyUrl: function(value) {
		return this.articleParent.parseExpression(value && value.$url || this.$field.$url);
	},

	setDataValue: function(value) {
		var self = this;
		this.$lazyUrl = this.getLazyUrl(value);
		if (this.$lazyUrl && value && typeof(value) === 'object') {
			self.$contentType = value.$contentType || (this.$field.$type === 'application/x-document' && this.$field.$contentType || this.$field.$type);
			document.controller.sendRequest(null, {
				$location: {
					$url: self.$lazyUrl,
					$contentType: self.$contentType,
					$type: self.$contentType
				}
			}, function(data, response) {
				if (typeof(data) === 'string') {
					Field.prototype.setDataValue.call(self, data);
				} else {
					self.showErrors([locale.format(self.localize.fieldBadDataType, "string", typeof(data))]);
				}
			}, function(error) {
				self.showErrors([error.message]);
			});
		} else {
			Field.prototype.setDataValue.call(self, value);
		}
	},
	notifyFieldChange: function(newValue, validated) {
		var self = this;
		this.$lazyUrl = this.getLazyUrl();
		if (this.$lazyUrl) {
			document.controller.sendRequest(null, {
				$location: {
					$url: self.$lazyUrl,
					$contentType: self.$contentType,
					$type: self.$contentType
				},
				data: newValue,
				method: "PUT"
			}, function(data, response, requestUrl) {});
		} else {
			Field.prototype.notifyFieldChange.call(this, newValue, validated);
		}
	}
});