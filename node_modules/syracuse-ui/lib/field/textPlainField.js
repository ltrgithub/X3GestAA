"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Field = require('syracuse-ui/lib/field/field').Field;
var locale = require('streamline-locale');

function TextPlainField() {}

exports.TextPlainField = helpers.defineClass(TextPlainField, Field, {
	initialize: function() {
		this.$item.$rows = this.$item.$rows || 5;
		this.$lazyUrl = this.$field.$url && syra_expression.parse(this.articleParent, this.$field.$url);
		this.$contentType = this.$field.$type === 'application/x-document' && this.$field.$contentType || this.$field.$type;
	},

	getLazyUrl: function(value) {
		return syra_expression.parse(this.articleParent, value && value.$url || this.$field.$url);
	},

	setDataValue: function(value) {
		var self = this;
		self.$lazyUrl = self.getLazyUrl(value);
		if (self.$lazyUrl && value && typeof(value) === 'object') {
			self.$contentType = value.$contentType || (self.$field.$type === 'application/x-document' && self.$field.$contentType || self.$field.$type);
			syra_controller.callServer(null, {
				$location: {
					$url: self.$lazyUrl,
					$contentType: self.$contentType,
					$type: self.$contentType
				}
			}, function(data, response) {
				if (typeof(data) === 'string') {
					Field.prototype.setDataValue.call(self, data);
				} else {
					self.showErrors([locale.format(syra_local.fieldBadDataType, "string", typeof(data))]);
				}
			}, function(error) {
				self.showErrors([error.message]);
			});
		} else {
			if (!self.$isEditMode) {
				value = syra_dom.textToHTML(value);
			}
			Field.prototype.setDataValue.call(self, value);
		}
	},
	notifyFieldChange: function(newValue, validated) {
		this.$lazyUrl = this.getLazyUrl();
		if (this.$lazyUrl) {
			syra_controller.callServer(null, {
				$location: {
					$url: this.$lazyUrl,
					$contentType: this.$contentType,
					$type: this.$contentType
				},
				data: newValue,
				method: "PUT"
			}, function(data, response, requestUrl) {});
			return false; //disable default notifyFieldChange
		}
		return true;
	}
});