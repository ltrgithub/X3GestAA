"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Field = require('syracuse-ui/lib/field/field').Field;

function _setDataValue(field, value) {
	field.currentValue = value;
	if (field.$isEditMode) {
		field.setInputValue(field.currentValue || "");
	} else {
		if (value) {
			field.fieldValue.syraIsDefaultLink = true;
			field.fieldValue.setAttribute("href", field._$hrefPrefix + value);
			field.fieldValue.textContent = value;
			if (!field._iconValue) {
				field._iconValue = document.createElement("div");
				field._iconValue.innerHTML = syra_menus.fontIcons[field._$iconValue];
				field._iconValue.className = "s-fonticon-btn s-icon-" + field._$iconValue;
			}!field._iconValue.parentNode && field.fieldValue.insertBefore(field._iconValue, field.fieldValue.firstChild);
		} else {
			field._iconValue && field.fieldValue.removeChild(field._iconValue);
		}
		syra_menus.ensureMenuPicker(field);
	}
	field.fieldHelper.setValueLength(field, value);
}

function _createValueContainer(field) {
	Field.prototype._createValueContainer.call(field);
	if (!field.$isEditMode) {
		field.fieldValue.className = field._$cssField + "-value-read  s-" + field._$iconValue;
	}
}


function PhoneField() {}

exports.PhoneField = helpers.defineClass(PhoneField, Field, {
	initialize: function() {
		if (!this.$isEditMode) {
			this.$valueTag = "a";
		}
		this._$hrefPrefix = "tel:";
		this._$iconValue = "phone";
		this.$inputType = "tel";
		this.$isDetailLinkDisabled = true;
	},
	_createValueContainer: function() {
		_createValueContainer(this);
	},
	setDataValue: function(value) {
		_setDataValue(this, value);
	},
	dispose: function() {
		this._iconValue = null;
		Field.prototype.dispose.call(this);
	}
});

function EmailField() {}

exports.EmailField = helpers.defineClass(EmailField, Field, {
	initialize: function() {
		if (!this.$isEditMode) {
			this.$valueTag = "a";
		}
		this._$hrefPrefix = "mailto:";
		this._$iconValue = "email";
		this.$inputType = "email";
		this.$isDetailLinkDisabled = true;
	},
	validateType: function(errors, value) {
		if (value) {
			var atpos = value.indexOf("@");
			var dotpos = value.lastIndexOf(".");
			if (atpos < 1 || dotpos < atpos + 2 || dotpos + 2 >= value.length) {
				errors.push(syra_local.fieldEmailInvalid);
			}
		}
	},
	_createValueContainer: function() {
		_createValueContainer(this);
		if (!this.$isEditMode) {
			this.fieldValue.setAttribute("rel", "nofollow");
		}
	},
	setDataValue: function(value) {
		_setDataValue(this, value);
	},
	dispose: function() {
		this._iconValue = null;
		Field.prototype.dispose.call(this);
	}
});

function UrlField() {}

exports.UrlField = helpers.defineClass(UrlField, Field, {
	initialize: function() {
		if (!this.$isEditMode) {
			this.$valueTag = "a";
		}
		this.$inputType = "url";
		this.$isDetailLinkDisabled = true;
	},
	_createValueContainer: function() {
		Field.prototype._createValueContainer.call(this);
		if (!this.$isEditMode) {
			this.fieldValue.className = this._$cssField + "-value-read s-mn-link";
		}
	},
	setDataValue: function(value) {
		this.currentValue = value;
		if (this.$isEditMode) {
			this.setInputValue(this.currentValue || "");
		} else {
			if (value) {
				this.fieldValue.setAttribute("href", value);
				this.fieldValue.textContent = value;
				!this.fieldValue.parentNode && this._dataValue.appendChild(this.fieldValue);
			} else {
				this.fieldValue.parentNode && this.fieldValue.parentNode.removeChild(this.fieldValue);
			}
			syra_menus.ensureMenuPicker(this);
		}
		this.fieldHelper.setValueLength(this, value);
	}
});