"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Field = require('syracuse-ui/lib/field/field').Field;

function ReferenceField(){
}

exports.ReferenceField = helpers.defineClass(ReferenceField, Field, {
    releaseMode: function(onDispose){
        if (!onDispose) {
            if (this.codeMenu) {
                this.articleParent.removeItem(this.codeMenu, true);
            }
            delete this.currentValue;
        }
        this.codeMenu = this._titleField = null;
        Field.prototype.releaseMode.call(this, onDispose);
    },
    _extractCode: function($expression){
        $expression = $expression + "";
        if ($expression.indexOf("{") >= 0) {
            return $expression.slice(1, $expression.length - 1);
        }
        return $expression;
    },
    _ensureValueBind: function($bind){
        var $field;
        if ($bind != this.$item.$bind) {
            var articleParent = this.articleParent;
            while (articleParent) {
                if (!(articleParent.$prototype && articleParent.$prototype.$properties && articleParent.$prototype.$properties[$bind])) {
                    articleParent = articleParent.getArticleParent();
                }
                else {
                    $field = articleParent.$prototype.$properties[$bind];
                    articleParent.bind(this, $bind);
                    break;
                }
            }
        }
        return $field;
    },
    initialize: function(){
        this.$rootLinks = this.$field.$item;
        if (this.$field.$item.$key === "{$uuid}") {
            this._hasUiid = true;
        }
        else {
            this.$refTitle = {
                $itemProp: this.$field.$item.$title ? this._extractCode(this.$field.$item.$title) : "$title"
            };
            this.$refTitle.$prop = this.$field.$item[this.$refTitle.$itemProp];
            if (this.$refTitle.$prop) {
                this.$refTitle.$prop = this._extractCode(this.$refTitle.$prop);
                this.$refTitle.$field = this._ensureValueBind(this.$refTitle.$prop);
            }
            else {
                this.$refTitle.$prop = this.$refTitle.$itemProp;
            }
            
            if (this.$field.$item.$value) {
                this.$refValue = {
                    $itemProp: this._extractCode(this.$field.$item.$value)
                };
                this.$refValue.$prop = this.$field.$item[this.$refValue.$itemProp];
                if (this.$refValue.$prop) {
                    this.$refValue.$prop = this._extractCode(this.$refValue.$prop);
                    this.$refValue.$field = this._ensureValueBind(this.$refValue.$prop);
                }
                else {
                    this.$refValue.$prop = this.$refValue.$itemProp;
                }
            }
            else {
                if (this.$field.$item.$title) {
                    //convergence reference
                    this._isTitleField = true;
                }
            }
            
            this.$refKeys = {};
            if (this.$field.$item.$key) {
                //no $key for convergence
                var $keys = this.$field.$item.$key.split("~");
                for (var ii = 0, jj = $keys.length; ii < jj; ii++) {
                    var $key = $keys[ii];
                    var $itemProp = this._extractCode($key);
                    var prop = this.$field.$item[$itemProp];
                    if (prop) {
                        prop = this._extractCode(prop);
                    }
                    else {
                        prop = $itemProp;
                    }
                    this.$refKeys[$itemProp] = prop;
                }
            }
        }
    },
    getDataType: function(){
        return this.$field.$item.$properties || this.$field.$item;
    },
    onInputChange: function(input){
        var value = input.value || "";
        if (value == "") {
            this.notifyFieldChange(null, true);
        }
        else {
            if ((this.currentValue && this.currentValue.$value != value) || !this.currentValue) {
                this.notifyFieldChange({
                    $value: value
                });
            }
        }
    },
    render: function(){
        if (this.$isEditMode) {
            var css = ((this.$item.$css) ? this.$item.$css + " " : "");
            var $skinInput = css + this.$skinInput;
            this._input = document.createElement("input");
            this._input.setAttribute("type", "text");
            this.$$input = $(this._input);
            this._input.className = $skinInput;
            
            this.fieldValue.appendChild(this._input);
            if (!this.$item.$inplace && this.$item.$isReferenceTitleVisible !== false) {
                this._refTitle = document.createElement("div");
                this._refTitle.className = $skinInput + "-ref-desc";
            }
            
            if (this.$rootLinks.$links) {
                if (this.$rootLinks.$links.$tunnel) {
                    this._appendSpecialPicker("tunnel");
                }
            }
            
            var lookupPicker = this.createPicker("lookup");
            this.$$lookupPicker = $(lookupPicker);
            this.appendToPickerBox(lookupPicker);
            if (this._refTitle) {
                if (this._isTitleField) {
                    this._titleField = this.page.loadNewItem(this._refTitle, {
                        $bind: this.$refTitle.$prop,
                        $isEditMode: false,
                        $css: this.$item.$css,
                        $skin: this.$skin + "-ref-link"
                    }, this.boxParent);
                }
                else {
                    this._refTitle.style.display = "none";
                }
                this.fieldValue.appendChild(this._refTitle);
            }
        }
        else {
            this.codeMenu = this.page.loadNewItem(this.fieldValue, {
                $isDescriptionVisible: this.$item.$isReferenceTitleVisible !== false,
                $subRecordKey: this.$item.$bind,
                $css: this.$item.$css,
                $category: "link",
                $skin: this.$skin + "-ref-link"
            }, this.boxParent);
        }
        this.setDescription(this.$item.$description || this.$field.$item.$description);
        if (this.currentValue) {
            this._renderCurrentValue();
        }
    },
    _isShowMenuPicker: function(){
        var show = this.currentValue && this.currentValue.$value && this.currentValue.$value != "";
        return (show && (this.menuPicker.isLazyLoad || this.menuPicker.$item.$layout.$items.length > 0));
    },
    
    setUUIDDataValue: function(value){
        var $field = this.$field.$item;
        if (value) {
            this.currentValue = {
                $title: value.$title || "",
                $uuid: value.$uuid || this.articleParent.parseExpression($field.$uuid, value) ||
                ""
            };
            this.currentValue.$value = value.$value ||
            this.articleParent.parseExpression($field.$value, value) ||
            "";
            this.currentValue.$key = value.$key ||
            this.articleParent.parseExpression($field.$key, value) ||
            "";
        }
    },
    notifyFieldChange: function(newValue, validated){
        if (this._hasUiid) {
            Field.prototype.notifyFieldChange.call(this, newValue, validated);
        }
        else {
            var self = this;
            self.currentValue = newValue;
            if (validated || self.validate()) {
                self.articleParent.dataset[self.$item.$bind] = self.currentValue;
                self.page.externalAdapter.onFieldNotifyChange({
                    field: self,
                    doEvent: function(){
                        if (self.articleParent.onNotifyDataChange ? self.articleParent.onNotifyDataChange(self, self.currentValue) : true) {
                            var $keys = Object.keys(self.currentValue);
                            var postValue = {};
                            var $properties = self.$field.$item.$properties;
                            var sendBag = self.page.ensureSendBag();
                            for (var ii = 0, jj = $keys.length; ii < jj; ii++) {
                                var $key = $keys[ii];
                                if ($key != "$value" && $key != "$etag") {
                                    var copy = true;
                                    switch ($key) {
                                        case "$description":
                                        case "$title":
                                            if (!self.currentValue[$key]) {
                                                copy = false;
                                            }
                                            break;
                                        case "$uuid":
                                            if (self.articleParent.$recordIndex == undefined) {
                                                copy = false;
                                            }
                                            else {
                                                copy = self.articleParent.list.$prototype.$item.$type == "application/x-reference";
                                            }
                                            break;
                                        default:
                                            var $prop = $properties[$key];
                                            if ($prop) {
                                                if (!$prop.$isReadOnly) {
                                                    var parentKey = self.$refKeys[$key] || $key;
                                                    if (self.articleParent.$prototype.$properties[parentKey]) {
                                                        self.articleParent.ensureDataSet()[parentKey] = self.currentValue[$key];
                                                        sendBag.saveDataChange(self.page, self.articleParent, parentKey, self.currentValue[$key]);
                                                        copy = false;
                                                    }
                                                }
                                                else {
                                                    copy = false;
                                                }
                                                
                                            }
                                            break;
                                    }
                                    if (copy) {
                                        postValue[$key] = self.currentValue[$key];
                                    }
                                }
                            }
                            self.page.notifyDataChange(self, postValue);
                        }
                    }
                });
            }
        }
    },
    setDataValue: function(value){
        var $field = this.$field.$item;
        if (this.currentValue && value) {
            if (this.currentValue.$uuid && this.currentValue.$uuid == value.$uuid) {
                return;
            }
        }
        if (value) {
            this.currentValue = this.currentValue || {};
            if (this._hasUiid) {
                this.setUUIDDataValue(value);
            }
            else {
                if (typeof(value) == 'object') {
                    this.currentValue.$description = value.$description || "";
                    this.currentValue.$title = value.$title || value[this.$refTitle.$itemProp];
                    if (this.currentValue.$title == null) {
                        this.currentValue.$title = this.articleParent.parseExpression("{" + this.$refTitle.$prop + "}");
                    }
                    if (this.currentValue.$title == null) {
                        this.currentValue.$title = "";
                    }
                    this.currentValue.$value = value[this.$refValue.$itemProp] || this.currentValue.$value;
                    if (this.currentValue.$value == null) {
                        this.currentValue.$value = this.articleParent.parseExpression("{" + this.$refValue.$prop + "}");
                    }
                    var $keys = Object.keys(value);
                    for (var ii = 0, jj = $keys.length; ii < jj; ii++) {
                        var $key = $keys[ii];
                        this.currentValue[$key] = value[$key];
                    }
                }
                else {
                    this.currentValue.$value = value;
                }
            }
        }
        else {
            this.currentValue = {}
        }
        this._renderCurrentValue();
    },
    _renderCurrentValue: function(){
        if (this.$isEditMode) {
            if (this._input) {
                this._input.value = this.currentValue.$value || "";
                var title = this.currentValue.$title || "";
                if (this._refTitle) {
                    if (!this._titleField) {
                        this._refTitle.textContent = title;
                        this._refTitle.style.display = title ? "" : "none";
                    }
                }
                else {
                    this._input.setAttribute("title", title);
                }
            }
        }
        else {
            if (this.codeMenu) {
                var $details;
                if (this.$rootLinks.$links) {
                    $details = this.$rootLinks.$links.$details;
                }
                if (!$details) {
                    $details = {};
                }
                $details.$title = this.currentValue.$value || "";
                $details.$description = this.currentValue.$title || "";
                this.codeMenu.setMenu($details, this.currentValue, this.currentValue);
            }
            
        }
    }
});
