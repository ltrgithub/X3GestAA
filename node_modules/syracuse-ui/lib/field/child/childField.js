"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;
var Field = require('syracuse-ui/lib/field/field').Field;
var ChildFieldRecord = require('./childFieldRecord').ChildFieldRecord;

function ChildField() {}

exports.ChildField = helpers.defineClass(ChildField, Article, {
	ensureDataSet: function() {
		return this.dataset = this.articleParent.dataset[this.$item.$bind] = this.articleParent.dataset[this.$item.$bind] || {};
	},
	drawBox: function() {
		this.$skin = this.$item.$skin || "s-child";

		this.$fieldProperties = this.$prototype.$item.$properties || {};

		if ((this.$isEditMode = this.$item.$isEditMode) === undefined) {
			this.$isEditMode = this.getArticleParent().$isEditMode;
		}

		if (!this.$item.$layout) {
			this.$item.$layout = {};
		}
		if (!this.$item.$layout.$items) {
			this.$item.$layout.$items = [];
			var $binds = Object.keys(this.$fieldProperties);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				if (!this.$fieldProperties[$binds[ii]].$isExcluded) {
					this.$item.$layout.$items.push({
						$bind: $binds[ii]
					});
				}
			}
		}
		this._domItem = document.createElement("div");
		this._domItem.className = this.$skin + "-field";
		this.$$item = $(this.layoutSlot.appendChild(this._domItem));

		this.appendTitle();

		this.fieldValue = this._core = this.domValueSlot = document.createElement("div");
		this.domValueSlot.className = this.$skin + "-core";
		this.$$dataValue = $(this._domItem.appendChild(this._dataValue = this._core));

		this.setTitle(this.$item.$title || this.$field.$title);
		this.setDescription(this.$item.$description || this.$field.$description);
		this.setState(this.$field);

		this.$item.$cards = (typeof(this.$item.$cards) === "object") ? this.$item.$cards : {
			$layout: {
				$items: this.$item.$layout.$items
			}
		};
		this.applyDesignMetaData(this.$item, false);

		this._record = new ChildFieldRecord();
		this._record.arrayLevel = "record";
		this._record.$isEditMode = this.$isEditMode;
		this._record.list = this;
		this._record.$prototype = this.$prototype.$item;
		this.page.initializeNewItem(this._record, {
			$category: "section",
			$layout: {
				$items: this.$item.$layout.$items
			}
		}, this);
		this._record.loadBox();

		this.boxParent.getArticle().bind(this, this.$item.$bind);
	},
	setHelp: function($help) {
		if ($help != undefined) {
			this.$help = $help;
			if (this.domTitle && this.getTitle().length > 0) {
				if (this.$help) {
					if (!this._helpFlag) {
						this._helpFlag = document.createElement("a");
						this._helpFlag.className = "s-field-help-flag";
						this.domTitle.appendChild(this._helpFlag);
					}
				} else {
					if (this._helpFlag) {
						document.site.removeDomChild(this._helpFlag);
						delete this._helpFlag;
					}
				}
			}
		}
	},
	toggleEditMode: function($isEditMode) {},
	setDescription: function($description) {
		Field.prototype.setDescription.call(this, $description);
	},
	hideTitle: function($isTitleHidden) {
		Field.prototype.hideTitle.call(this, $isTitleHidden);
	},
	getDefaultTitle: function() {
		return Field.prototype.getDefaultTitle.call(this);
	},
	getTitle: function() {
		return Field.prototype.getTitle.call(this);
	},
	setTitle: function($title) {
		Field.prototype.setTitle.call(this, $title);
		if (this.domTitle) {
			this.domTitle.style.display = this.getTitle().length == 0 ? "none" : "";
		}
	},
	getLocalizedTitle: function($title) {
		if ($title && $title.length > 0 && $title[1] == "@") {
			return this.boxParent.parseExpression($title);
		}
		return $title;
	},
	appendTitle: function() {
		if (!this.$item.$inplace && !this.$item.$isTitleHidden) {
			this.domTitle = document.createElement("label");
			this.domTitle.className = this.$skin + "-title";
			this._domItem.appendChild(this.domTitle);
		}
	},

	releaseMode: function(onDispose) {
		document.site.emptyDom(this._core);
		delete this.domTitle;
		delete this._mandatoryFlag;
		delete this._description;
		delete this._helpFlag;
	},
	toggleDiagnose: function(css, show) {},
	setMenus: function($menus) {
		if ($menus) {
			this._record.applyActionLinkChange({
				$links: $menus.$links,
				$actions: $menus.$actions
			});
		}
	},
	applyActionLinkChange: function(resources) {
		this._record.applyActionLinkChange(resources);
	},
	applyDesignMetaData: function(metaData, onAuthoring) {
		if (onAuthoring) {

		}
		return Field.prototype.applyDesignMetaData.call(this, metaData, onAuthoring);
	},
	drawDiagnose: function($diagnose, severityGroup) {
		var link = document.createElement("a");
		link.setAttribute("data-s-menu", this.id);
		link.className = "s-diagnose-msg-link";
		link.setAttribute("data-s-picker", "field-msg");
		//severityGroup.drawLabel($diagnose).prepend($(link).text(this.$field.$title + ":")).appendTo(severityGroup.$$group);
		var options = {};
		options.$$fieldLink = $(link).text(this.$field.$title + ":");
		options.field = this;
		severityGroup.drawDiagnose($diagnose, options);

		link = document.createElement("label");
		link.className = "s-field-diagnose-msg-" + severityGroup.$severity;
		link.innerHTML = document.site.formatHTMLMessage($diagnose.message || $diagnose.$message);
		this.domDiagnose.appendChild(link);
	},
	emptyDiagnoseSlot: function() {
		if (this.domDiagnose) {
			document.site.emptyDom(this.domDiagnose);
			this.domDiagnose.style.visibility = "hidden";
		}
	},
	ensureDiagnoseSlot: function() {
		if (!this.domDiagnose && this.$$dataValue) {
			this.domDiagnose = document.createElement("div");
			this.domDiagnose.className = "s-field-diagnose";
			this.$$dataValue.prepend(this.domDiagnose);
		} else {
			document.site.emptyDom(this.domDiagnose);
		}
	},
	setState: function(state) {
		Field.prototype.setState.call(this, state);
		if (state.$isReadOnly !== undefined || state.$isDisabled != undefined) {
			this._record.applyMetaData({
				$isReadOnly: state.$isReadOnly,
				$isDisabled: state.$isDisabled
			});
		}
	},
	showDiagnoses: function(diagnoses, options) {
		Field.prototype.showDiagnoses.call(this, diagnoses, options);
	},
	_applyMetaDataToItem: function(metaData) {
		var self = this;
		["$isReadOnly", "$isEditMode", "$isDisabled"].forEach(function($state) {
			if (metaData[$state] !== undefined) {
				metaData.$item = metaData.$item || {};
				var $properties = metaData.$item.$properties = metaData.$item.$properties || {};
				Object.keys(self.$prototype.$item.$properties).forEach(function($bind) {
					($properties[$bind] = $properties[$bind] || {})[$state] = metaData[$state];
				});
			}
		});
	},
	applyMetaData: function(metaData) {
		Field.prototype.applyMetaData.call(this, metaData);
		if (metaData.$isReadOnly !== undefined || metaData.$isEditMode !== undefined || metaData.$isDisabled !== undefined) {
			this._applyMetaDataToItem(metaData);
		}
		if (metaData.$item) {
			if (metaData.$item.$diagnoses !== undefined) {
				document.site.showDiagnoses({
					field: this,
					$diagnoses: metaData.$item.$diagnoses
				}, this.boxParent);
			}
			this._record.applyChange(metaData.$item);
		}
	},
	setDataBind: function(dataRecord, parentDataRecord, metaData) {
		this.ensureDataSet();

		if (this.page.externalAdapter.setDataBind(this, dataRecord, parentDataRecord, metaData)) {
			if (metaData) {
				this.applyMetaData(metaData);
			}
			if (dataRecord !== undefined) {
				this._record.applyChange(dataRecord);
			}
		}
	},
	getDataValue: function() {
		return this.ensureDataSet();
	},
	validate: function() {
		return this._record.validateFields();
	},
	dispose: function() {
		delete this._record;
		Article.prototype.dispose.call(this);
	}
});