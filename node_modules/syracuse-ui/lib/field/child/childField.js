"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;
var Field = require('syracuse-ui/lib/field/field').Field;
var ChildFieldRecord = require('./childFieldRecord').ChildFieldRecord;

function ChildField() {}

exports.ChildField = helpers.defineClass(ChildField, Article, {
	ensureDataSet: function() {
		return this.dataset = this.setDatasetValue(this.getDatasetValue() || {});
	},
	getDatasetValue: function() {
		return Field.prototype.getDatasetValue.call(this);
	},
	setDatasetValue: function(value) {
		return Field.prototype.setDatasetValue.call(this, value);
	},
	drawBox: function() {
		this.$skin = this.$item.$skin || "s-child";
		this.$fields = this.$prototype.$item.$properties || {};
		Field.prototype.ensureEditMode.call(this);
		if (!this.$item.$layout) {
			this.$item.$layout = {};
		}
		if (!this.$item.$layout.$items) {
			this.$item.$layout.$items = [];
			var $binds = Object.keys(this.$fields);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				if (!this.$fields[$binds[ii]].$isExcluded) {
					this.$item.$layout.$items.push({
						$bind: $binds[ii]
					});
				}
			}
		}
		this.domItem = document.createElement("div");
		this.domItem.className = this.$skin + "-field";
		this.$$item = $(this.layoutSlot.appendChild(this.domItem));

		this.appendTitle();

		this.fieldValue = this._core = this.domValueSlot = document.createElement("div");
		this.domValueSlot.className = this.$skin + "-core";
		this.domItem.appendChild(this._dataValue = this._core);

		this.setTitle(this.$item.$title || this.$field.$title);
		this.setDescription(this.$item.$description || this.$field.$description);
		this.setState(this.$field);
		this.$item.$cardItem = this.$item.$cardItem || {
			$layout: {
				$items: this.$item.$layout.$items
			}
		};
		this.applyDesignMetaData(this.$item, false);

		this._record = new(this.ChildRecordClass || ChildFieldRecord)();
		this._record.arrayLevel = "record";
		this._record.isRecordArticle = true;
		this._record.$isEditMode = this.$isEditMode;
		this._record.list = this;
		this._record.$prototype = this.$prototype.$item;
		this.page.initializeNewItem(this._record, {
			$category: "section",
			$layout: {
				$items: this.$item.$layout.$items
			}
		}, this);
		this._record.loadBox();

		this.boxParent.getArticle().bind(this, this.$item.$bind);
	},
	setHelp: function($help) {
		if ($help != undefined) {
			this.$help = $help;
			if (this.domTitle && this.getTitle().length > 0) {
				if (this.$help) {
					if (!this._helpFlag) {
						this._helpFlag = document.createElement("a");
						this._helpFlag.className = "s-field-help-flag";
						this.domTitle.appendChild(this._helpFlag);
					}
				} else {
					if (this._helpFlag) {
						document.site.removeDomChild(this._helpFlag);
						delete this._helpFlag;
					}
				}
			}
		}
	},
	setDescription: function($description) {
		Field.prototype.setDescription.call(this, $description);
	},
	hideTitle: function($isTitleHidden) {
		Field.prototype.hideTitle.call(this, $isTitleHidden);
	},
	getDefaultTitle: function() {
		return Field.prototype.getDefaultTitle.call(this);
	},
	getTitle: function() {
		return Field.prototype.getTitle.call(this);
	},
	setTitle: function($title) {
		Field.prototype.setTitle.call(this, $title);
		if (this.domTitle) {
			this.domTitle.style.display = this.getTitle().length == 0 ? "none" : "";
		}
	},
	getLocalizedTitle: function($title) {
		if ($title && $title.length > 0 && $title[1] == "@") {
			return this.boxParent.parseExpression($title);
		}
		return $title;
	},
	appendTitle: function() {
		if (!this.$item.$inplace && !this.$item.$isTitleHidden) {
			this.domTitle = document.createElement("label");
			this.domTitle.className = this.$skin + "-title";
			this.domItem.appendChild(this.domTitle);
		}
	},
	setMenus: function($menus) {
		if ($menus) {
			this._record.applyActionLinkChange({
				$links: $menus.$links,
				$actions: $menus.$actions
			});
		}
	},
	applyActionLinkChange: function(resources) {
		this._record.applyActionLinkChange(resources);
	},
	applyDesignMetaData: function(metaData, designing) {
		return Field.prototype.applyDesignMetaData.call(this, metaData, designing);
	},
	setState: function(state) {
		Field.prototype.setState.call(this, state);
		if (state.$isReadOnly !== undefined || state.$isDisabled != undefined) {
			this._record.applyMetaData({
				$isReadOnly: state.$isReadOnly,
				$isDisabled: state.$isDisabled
			});
		}
	},
	showField: function(show) {
		Field.prototype.showField.call(this, show);
	},
	showDiagnoses: function(diagnoses, options) {
		Field.prototype.showDiagnoses.call(this, diagnoses, options);
	},
	applyMetaData: function(metaData) {
		Field.prototype.applyMetaData.call(this, metaData);
		if (metaData.$isReadOnly !== undefined || metaData.$isEditMode !== undefined || metaData.$isDisabled !== undefined) {
			metaData.$item = metaData.$item || {};
			var $props = metaData.$item.$properties = metaData.$item.$properties || {};
			var $binds = Object.keys(this.$prototype.$item.$properties);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var $bind = $binds[ii];
				if (!$props[$bind]) {
					$props[$bind] = {};
				}
				if (metaData.$isReadOnly !== undefined) {
					$props[$bind].$isReadOnly = metaData.$isReadOnly;
				}
				if (metaData.$isEditMode !== undefined) {
					$props[$bind].$isEditMode = metaData.$isEditMode;
				}
				if (metaData.$isDisabled !== undefined) {
					$props[$bind].$isDisabled = metaData.$isDisabled;
				}
			}
		}
		if (metaData.$item) {
			if (metaData.$item.$diagnoses !== undefined) {
				document.site.showDiagnoses({
					field: this,
					$diagnoses: metaData.$item.$diagnoses
				}, this.boxParent);
			}
			this._record.applyChange(metaData.$item);
		}
	},
	setDataBind: function(dataRecord, parentDataRecord, metaData) {
		this.ensureDataSet();

		if (this.page.externalAdapter.setDataBind(this, dataRecord, parentDataRecord, metaData)) {
			if (metaData) {
				this.applyMetaData(metaData);
			}
			if (dataRecord !== undefined) {
				this._record.applyChange(dataRecord);
			}
		}
	},
	getDataValue: function() {
		return this.ensureDataSet();
	},
	validate: function() {
		return this._record.validateFields();
	},
	dispose: function() {
		document.site.emptyDom(this._core);
		this.domTitle = this._mandatoryFlag = this._description = this._helpFlag = null;
		this._record = this.ChildRecordClass = null;
		Article.prototype.dispose.call(this);
	}
});