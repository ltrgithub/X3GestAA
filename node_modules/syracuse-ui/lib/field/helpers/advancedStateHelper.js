"use strict";

function _ensureFieldVisibility(field) {
	if (field.variantItem) {
		_ensureFieldVisibility(field.variantItem);
	} else {
		field.showItem(!field.$isHidden && (!field.boxParent._hasAdvancedFields || field.boxParent._areAdvancedFieldsVisible));
	}
}

function _showFields(box, show) {
	box._areAdvancedFieldsVisible = show;
	if (box.isDesktopPage) {
		if (!box.isVignettePage) {
			syra_menus.setButtonTitle(box._advancedFieldsBtn, box._areAdvancedFieldsVisible ? syra_local.box_advanced_hide : syra_local.box_advanced);
			syra_site.dom.toggleClass(box._advancedFieldsBtn, "s-hide-advanced", box._areAdvancedFieldsVisible);
		}
	} else {
		if (box.vignette) {
			_showFields(box.vignette, box.vignette._areAdvancedFieldsVisible = box._areAdvancedFieldsVisible);
		}
	}
	if (box.layoutContent) {
		var children = box.layoutContent.getItems();
		for (var ii = 0, jj = children.length; ii < jj; ii++) {
			var child = children[ii];
			if (child.isSection || child.vignette) {
				_showFields(child, box._areAdvancedFieldsVisible);
			} else {
				if (child.$item.$isAdvanced) {
					_ensureFieldVisibility(child);
				}
			}
		}
	}
	if (box.isDesktopPage) {
		box.ensurePageVisibility();
	}
}

function _showButton(box, show, designing) {
	if (show && box._hasAdvancedFields) {
		return; //adance bttuons are already visible
	}
	if (box.isDesktopPage) {
		box._hasAdvancedFields = show;
		if (box.isVignettePage) {
			_showButton(box.vignetteField, show, designing);
		} else {
			var title = box._areAdvancedFieldsVisible ? syra_local.box_advanced_hide : syra_local.box_advanced;
			if (!box._advancedFieldsBtn) {
				box._advancedFieldsBtn = syra_menus.addTextButton(title, "s-page-advanced-fields-link", "onAdvancedClick");
				var afterItem = box.designerViewOpener || box.titleLabel;
				afterItem.parentNode.insertBefore(box._advancedFieldsBtn, afterItem.nextSibling);
			} else {
				syra_menus.setButtonTitle(box._advancedFieldsBtn, title);
			}
			syra_site.dom.toggleClass(box._advancedFieldsBtn, "s-hide-advanced", box._areAdvancedFieldsVisible);
			box._advancedFieldsBtn.style.display = box._hasAdvancedFields ? "" : "none";
		}
	} else {
		if (!show) {
			var items = box.layoutContent.getItems();
			for (var ii = 0, jj = items.length; ii < jj; ii++) {
				if (items[ii].$item.$isAdvanced) {
					return; //has advanced fields, can not hide box 
				}
			}
		}
		box._hasAdvancedFields = show;
		if (box.boxParent) {
			_showButton(box.boxParent, show, designing);
		}
	}
};
exports.onAdvancedClick = function(box) {
	_showFields(box, !box._areAdvancedFieldsVisible);
};
exports.setAdvancedState = function(field, $isAdvanced, designing) {
	if (field.variantItem) {
		exports.setAdvancedState(field.variantItem, $isAdvanced, designing);
	} else {
		if (designing) {
			if ($isAdvanced) {
				field.$item.$isAdvanced = true;
			} else {
				delete field.$item.$isAdvanced;
			}

		}
		_showButton(field.boxParent, $isAdvanced, designing);
		_ensureFieldVisibility(field);
	}
};
exports.toggleAllFields = function(page, show) {
	if (page._advancedFieldsBtn) {
		_showFields(page, show === undefined ? page._areAdvancedFieldsVisible : show);
	}
};