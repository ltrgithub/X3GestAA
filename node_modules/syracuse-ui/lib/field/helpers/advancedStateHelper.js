"use strict";

function _ensureFieldVisibility(field) {
	if (field.variantItem) {
		_ensureFieldVisibility(field.variantItem);
	} else {
		field.showItem(!field.$isHidden && (!field.boxParent._hasAdvancedFields || field.boxParent._areAdvancedFieldsVisible));
	}
}

function _showFields(box, show) {
	box._areAdvancedFieldsVisible = show;
	if (box.isDesktopPage) {
		if (!box.isVignettePage) {
			var title = box._areAdvancedFieldsVisible ? syra_local.box_advanced_hide : syra_local.box_advanced;
			var icon = box._areAdvancedFieldsVisible ? "hide_advanced" : "show_advanced";
			syra_menus.button.setText(box._advancedFieldsBtn, title, icon);
		}
	} else {
		if (box.vignette) {
			_showFields(box.vignette, box.vignette._areAdvancedFieldsVisible = box._areAdvancedFieldsVisible);
		}
	}
	if (box.layoutContent) {
		var children = box.layoutContent.getItems();
		for (var ii = 0, jj = children.length; ii < jj; ii++) {
			var child = children[ii];
			if (child.isSection || child.vignette) {
				_showFields(child, box._areAdvancedFieldsVisible);
			} else {
				if (child.$item.$isAdvanced) {
					_ensureFieldVisibility(child);
				}
			}
		}
	}
	if (box.isDesktopPage) {
		syra_site.ensureArticleVisibility(box);
	}
}

function _showButton(page, show, designing) {
	if (show && page._hasAdvancedFields) {
		return; //adance bttuons are already visible
	}
	if (page.isDesktopPage) {
		page._hasAdvancedFields = show;
		if (page.isVignettePage) {
			_showButton(page.vignetteField, show, designing);
		} else {
			var title = page._areAdvancedFieldsVisible ? syra_local.box_advanced_hide : syra_local.box_advanced;
			var icon = page._areAdvancedFieldsVisible ? "hide_advanced" : "show_advanced";
			if (!page._advancedFieldsBtn) {
				page._advancedFieldsBtn = syra_menus.button.add({
					parent: page,
					slot: page.header,
					text: title,
					css: "s-page-advanced-fields-link",
					fontIcon: icon,
					btnclick: function() {
						_showFields(this.parent, !this.parent._areAdvancedFieldsVisible);
					}
				});
			} else {
				syra_menus.button.setText(page._advancedFieldsBtn, title);
			}
			syra_menus.button.setText(page._advancedFieldsBtn, title, icon);
			syra_menus.button.display(page._advancedFieldsBtn, page._hasAdvancedFields);
		}
	} else {
		if (!show) {
			var items = page.layoutContent.getItems();
			for (var ii = 0, jj = items.length; ii < jj; ii++) {
				if (items[ii].$item.$isAdvanced) {
					return; //has advanced fields, can not hide page 
				}
			}
		}
		page._hasAdvancedFields = show;
		page.boxParent && _showButton(page.boxParent, show, designing);
	}
};

exports.setAdvancedState = function(field, $isAdvanced, designing) {
	if (field.variantItem) {
		exports.setAdvancedState(field.variantItem, $isAdvanced, designing);
	} else {
		if (designing) {
			if ($isAdvanced) {
				field.$item.$isAdvanced = true;
			} else {
				delete field.$item.$isAdvanced;
			}

		}
		_showButton(field.boxParent, $isAdvanced, designing);
		_ensureFieldVisibility(field);
	}
};
exports.toggleAllFields = function(page, show) {
	if (page._advancedFieldsBtn) {
		_showFields(page, show === undefined ? page._areAdvancedFieldsVisible : show);
	}
};