"use strict";
var helpers = require('syracuse-core/lib/helpers');

exports.toggleEditMode = function(field, $isEditMode) {
	if ($isEditMode === undefined) {
		$isEditMode = !field.$isEditMode;
	}
	if (field.$isEditMode != $isEditMode) {
		field.$isEditMode = field.$item.$isEditMode = $isEditMode;
		var $$newItem;
		if (field.$item.$inplace) {
			document.site.emptyDom(field.layoutSlot);
		} else {
			field.$$item.replaceWith($$newItem = $(document.createElement("div")));
		}
		field.releaseMode();
		field.loadBox($$newItem);

		field.setTitle(field.getTitle());
		field.setDescription(field.$description);
		field.setState(field);

		//field._restoreButtonValue();
	}
};

function _updateFusionStyle(field, saveKey, target, newStyle) {
	var previous = field[saveKey];
	if (previous) {
		//clean
		var domStyle = target.getAttribute("style");
		var domStyleParts = domStyle.split(";");
		for (var mm = 0, kk = domStyleParts.length; mm < kk; mm++) {
			domStyleParts[mm] = domStyleParts[mm].trim();
		}
		var previousParts = previous.split(";");
		for (var ii = 0, jj = previousParts.length; ii < jj; ii++) {
			if (previousParts[ii]) {
				var parts = previousParts[ii].split(":");
				if (parts.length > 0) {
					parts[0] = parts[0].trim();
					for (var mm = 0, kk = domStyleParts.length; mm < kk; mm++) {
						if (domStyleParts[mm].indexOf(parts[0]) == 0) {
							domStyleParts.splice(mm, 1);
							break;
						}
					}
				}
			}
		}
		target.setAttribute("style", domStyleParts.join(";"));
	}
	if (newStyle) {
		field[saveKey] = newStyle;
		target.setAttribute("style", (target.getAttribute("style") || "") + ";" + newStyle);
	} else {
		delete field[saveKey];
	}
}

exports.applyFieldStyle = function(field, metaData) {
	var target;
	var newStyle = metaData.$fieldStyle || metaData.$valueStyle;
	if (newStyle !== undefined) {
		target = field._input ? field._input : field._dataValue;
		if (field.page.$isFusionPage) {
			_updateFusionStyle(field, "$valueStyle", target, newStyle);
		} else {
			if (field.$valueStyle) {
				document.site.toggleClass(target, field.$valueStyle, false);
			}
			document.site.toggleClass(target, (field.$valueStyle = (newStyle || "").replace("cst_sty_", "s-cst-sty-")), true);
		}
	}
	newStyle = metaData.$fieldStyle || metaData.$titleStyle;
	if (field.domTitle && newStyle !== undefined) {
		if (field.page.$isFusionPage) {
			_updateFusionStyle(field, "$titleStyle", field.domTitle, newStyle);
		} else {
			if (field.$titleStyle) {
				document.site.toggleClass(field.domTitle, field.$titleStyle, false);
			}
			document.site.toggleClass(field.domTitle, (field.$titleStyle = (newStyle || "").replace("cst_sty_", "s-cst-sty-")), true);
		}
	}
};