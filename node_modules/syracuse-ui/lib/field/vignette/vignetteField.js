"use strict";
var helpers = require('syracuse-core/lib/helpers');
var SectionBlock = require("syracuse-ui/lib/article/sectionBlock").SectionBlock;
var Resizer = require("syracuse-ui/lib/scroll/resizer").Resizer;

function VignetteField() {}

exports.VignetteField = helpers.defineClass(VignetteField, SectionBlock, {
	ensureSkin: function() {
		SectionBlock.prototype.ensureSkin.call(this);
		this.$designLevel = "field";
	},
	resizeArticle: function() {
		if (this.$item.$height) {
			this.body.style.height = this.$item.$height + "px";
		}
	},
	setDataBind: function(value, record, metaData, $bind) {},
	loadBox: function() {
		this.isVignetteField = true;
		if (!this.page.isLandingPage && this.$item.$isBoxCollapsable == undefined) {
			this.$item.$isBoxCollapsable = true;
		}
		SectionBlock.prototype.loadBox.call(this);
		//$(this.domItem).resizable();
		if (this.page.userPreferences) {
			this.$userPreferences = this.page.userPreferences.getForField(this.$item.$bind);
			if (this.$userPreferences.$height) {
				this.$item.$height = this.$userPreferences.$height;
			}
		}
		this.refreshBtn = syra_menus.button.add({
			parent: this,
			slot: this.ensureButtonsSlot(),
			text: syra_local.box_refresh,
			css: this.$skin + "-btn",
			iconOnly: true,
			fontIcon: "refresh",
			btnclick: function() {
				this.parent.refresh(true);
			}
		});
		syra_maximizer.addButton({
			parent: this,
			slot: this.ensureButtonsSlot(),
			css: this.$skin + "-btn"
		});
		syra_maximizer.addButton({
			parent: this,
			slot: this.ensureButtonsSlot(),
			css: this.$skin + "-btn"
		});
		this.articleParent.bind(this, this.$item.$bind);

		this.page.resizableList.add(this);

	},
	refresh: function(onVignetteRefresh) {
		var $refresh = this.vignette && this.vignette.$menus && this.vignette.$menus.$refresh;
		var $url = $refresh && $refresh.$url;
		if ($url) {
			$url = syra_expression.parse(this.vignette, $url);
		}
		this.renderLayoutContent($url, onVignetteRefresh);
	},
	onItemInOut: function(onEnter, event) {

	},
	hideHeader: function(hide) {
		syra_dom.hide(this.domTitle, hide);
		this.header.className = hide ? "s-vignette-field-header" : (this.$skin + "-head");
	},
	toggleMenuButton: function(show) {
		if (show) {
			if (!this.menuBtn) {
				this.menuBtn = syra_menus.button.add({
					parent: this,
					slot: this.ensureButtonsSlot(),
					text: syra_local.box_menus,
					css: this.$skin + "-btn",
					iconOnly: true,
					fontIcon: "menus",
					btnclick: function() {
						syra_menus.pickers.menus.showPopup(this.parent.vignette, this);
					}
				});
			}
		} else {
			syra_menus.button.remove(this.menuBtn);
		}
	},
	renderLayoutContent: function() {
		if (this.vignette) {
			syra_dom.empty(this.body);
			this.vignette.dispose();
			this.vignette = null;
		}
	},
	addResizer: function() {
		this.resizer = new Resizer({
			item: this,
			body: this.body,
			slot: this.domItem,
			handles: ["s"],
			start: function(resizing) {
				if (this._iframe) {
					this._iframe.style.pointerEvents = "none";
				}
			},
			drag: function(resizing) {

			},
			stop: function(resizing) {
				if (this._iframe) {
					this._iframe.style.pointerEvents = "auto";
				}
				var field = this.item;
				field.$item.$height = this.$height;
				var userPreferences = field.page.userPreferences;
				if (userPreferences) {
					field.$userPreferences.$height = this.$height;
					userPreferences.saveForField(field.$item.$bind, field.$userPreferences);
					userPreferences.save();
				}
				if (field.page.designer) {
					field.page.designer.endArticleUpdate();
				} else {
					field.page.savePageDesign( !! userPreferences);
				}
			}
		});
	},
	dispose: function() {
		this.resizer && this.resizer.dispose();
		this.page && this.page.resizableList.remove(this);
		SectionBlock.prototype.dispose.call(this);
	}
});