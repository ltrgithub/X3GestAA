"use strict";
var helpers = require('syracuse-core/lib/helpers');
var VignetteField = require("syracuse-ui/lib/field/vignette/vignetteField").VignetteField;

function HTMLVignetteField() {}

exports.HTMLVignetteField = helpers.defineClass(HTMLVignetteField, VignetteField, {
	ensureDefaultTitle: function() {

	},
	setDataBind: function(value, record, metaData, $bind) {
		if (this.page.externalAdapter.setDataBind(this, value, record, metaData)) {
			if (value !== undefined) {
				this._showUrl(this.$item.$url = value);
			}
		}
	},
	applyDesignMetaData: function(metaData, designing) {
		VignetteField.prototype.applyDesignMetaData.call(this, metaData, designing);
		if (metaData.$url !== undefined) {
			this._showUrl(this.$item.$url = metaData.$url);
		}
		if (metaData.$height !== undefined) {
			if (metaData.$height) {
				this.$item.$height = metaData.$height;
			} else {
				delete this.$item.$height;
			}
			designing && this.resizeArticle();
		}
	},
	_setDefinedHeight: function() {
		if (this.$item.$height) {
			var height = (this.$item.$height + "").replace("px");
			this._iframe.style.height = Math.max(parseInt(height, 10), 100) + "px";
		}
	},
	resizeArticle: function() {
		if (syra_dom.isVisible(this.domItem)) {
			!this._iframe && this._showUrl();
			if (this._iframe) {
				if (this.isMaximized) {
					var slot = this.page.isLandingPage ? syra_site.body : this.page.layoutSlot;
					var rect = this.header.getBoundingClientRect();
					var diff = rect.height + (2 * (rect.top - slot.getBoundingClientRect().top));
					var maxHeight = slot.getBoundingClientRect().height - diff;
					this._iframe.style.height = maxHeight + "px";
				} else {
					if (this.$item.$height) {
						this._setDefinedHeight();
					} else {
						this._iframe.style.height = "";
						//dif beetween the widget and its slot => for colums allow the adjustment 
						var maxRect = this.layoutSlot.getBoundingClientRect();
						var maxHeight = $(this.layoutSlot).height();
						var smallRect = this.domItem.getBoundingClientRect();
						var marginH = maxRect.height - maxHeight;
						var diff = (maxRect.bottom - marginH) - smallRect.bottom;
						if (diff > 0) {
							this._iframe.style.height = Math.max(100, this._iframe.clientHeight + diff) + "px";
						}
						//dif beetween the slot and its parent slot 
						var layoutSlot = this.layoutParent.layoutSlot;
						if (layoutSlot) {
							var next = this.layoutSlot.nextSibling;
							if (!next || this.layoutParent.isRow) { //for stack adjust bottom but do nothing if siblings
								maxRect = layoutSlot.getBoundingClientRect();
								maxHeight = $(layoutSlot).height();
								smallRect = this.layoutSlot.getBoundingClientRect();
								marginH = maxRect.height - maxHeight;
								diff = (maxRect.bottom - marginH) - smallRect.bottom;
								if (diff > 0) {
									this._iframe.style.height = Math.max(100, this._iframe.clientHeight + diff) + "px";
								}
							}
						}


						maxRect = this.page.body.getBoundingClientRect();
						maxHeight = $(this.page.body).height();
						smallRect = this.page.layoutContent.domItem.getBoundingClientRect();
						marginH = maxRect.height - maxHeight;
						diff = (maxRect.bottom - marginH) - smallRect.bottom;
						if (diff > 0) {
							this._iframe.style.height = Math.max(100, this._iframe.clientHeight + diff) + "px";
						}
					}

				}
			}
		}
	},
	onAfterMaximize: function() {
		if (this._iframe) {
			this._iframe.style.height = "";
		}
		this.resizeArticle();
	},
	_showUrl: function($url) {
		if ($url !== undefined) {
			this.$contentUrl = $url;
		}
		if (this.$isLoaded && syra_dom.isVisible(this.domItem)) {
			if (this.$contentUrl) {
				if (!this._iframe) {
					this._iframe = document.createElement("iframe");
					this._iframe.className = "s-iframe";
					this._iframe.target = "_top";
					this.$item.$height && this._setDefinedHeight();
					var sb;
					if ((sb = this._getSecurityLevel()) !== null) {
						this._iframe.setAttribute("sandbox", sb);
					}
					this._iframe.style.width = this.$item.$width || "100%";
					syra_dom.empty(this.body);
					this.body.appendChild(this._iframe);
				}
				this._iframe.setAttribute("src", this.$contentUrl);
				this.externalBtn && syra_menus.button.remove(this.externalBtn);
				this.externalBtn = syra_menus.button.add({
					parent: this,
					text: this.titleText,
					css: "s-btn-external-default " + this.$skin + "-btn",
					iconOnly: true,
					fontIcon: "external"
				});
				this.refreshBtn.link.parentNode.insertBefore(this.externalBtn.link, this.refreshBtn.link);
				this.externalBtn.link.target = "_blank";
				this.externalBtn.link.href = this.$contentUrl;
			} else {
				syra_menus.button.remove(this.externalBtn);
				delete this.externalBtn;
				syra_dom.empty(this.body);
				this._iframe = null;
			}
		}
	},
	toggleDesignButton: function(show) {
		VignetteField.prototype.toggleDesignButton.call(this, this.page.isLandingPage ? false : show);
	},
	loadBox: function() {
		this.$isLoaded = false;
		this.$authoringType = "htmlVignetteField";
		VignetteField.prototype.loadBox.call(this);
		this.$isLoaded = true;
		this._showUrl(this.$contentUrl || (this.$field.$location && this.$field.$location.$url));
	},
	renderLayoutContent: function($url, onVignetteRefresh) {
		VignetteField.prototype.renderLayoutContent.call(this, $url, onVignetteRefresh);
		onVignetteRefresh && this._showUrl();
	},
	_getSecurityLevel: function() {
		var l1, l2, l3, l3s, i, len, sec;
		// Expected values : "low", "medium", "high"
		if (this.$field && (l1 = this.$field.$securityLevel)) {
			if (typeof l1 !== 'string') {
				// How vignette could contains several sources (especially for classic pages), at now we align security on the most restrictive source level
				l2 = l1[0];
				for (i = 1, len = l1.length; i < len; i++) {
					if ((l3 = l1[i]) && l3.charCodeAt(l3.length - 1) < l2.charCodeAt(l2.length - 1)) {
						l2 = l3;
					}
				}
				l1 = null;
			}
		}
		sec = syra_site.userProfile.dataset.security;
		l3s = sec && sec.iframe.sandbox[l1 || l2 || "medium"];
		switch ((l1 || l2)) {
			case "high":
				l3 = "";
				break;
			case "low":
				l3 = "allow-same-origin allow-forms allow-popups allow-scripts";
				break;
			default:
				// So, medium level
				l3 = "allow-forms allow-scripts";
		}
		return l3s === undefined ? l3 : l3s;
	}
});