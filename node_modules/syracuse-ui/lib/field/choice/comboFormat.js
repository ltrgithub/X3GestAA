"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');

function ComboFormat(){
    this.$defaultChoiceLayout = "1";
}

exports.ComboFormat = helpers.defineClass(ComboFormat, null, {
    setDataValue: function(value){
        this.field.currentValue = value;
        this._$selectedEnum = this._$listSelection = this.field.findEnum(value);
        var $title = this._$selectedEnum ? this._$selectedEnum.$title : "";
        if (this.field.$isEditMode) {
            this.field.$$input.val($title);
            if (this.iconValue) {
                this.setIcon(this.iconValue, value);
            }
        }
        else {
            this.field.$$fieldValue.text($title);
        }
    },
    getInputValue: function(){
        return this._$selectedEnum ? this._$selectedEnum.$value : null;
    },
    doClickPicker: function(){
        this.toggleList();
    },
    render: function(){
        var self = this;
        var $value = self.field.$field.$value;
        delete self.field.$isLayoutContentSizeDisabled;
        self.field.$enum = $value ? $value.$enum : {};
        if (self.field.$isEditMode) {
            (self.field.$$input = $("<input type='text'/>"))[0].className = self.field.$skinInput;
            self.field._appendLinksPicker();
            self.choiceBtn = self.field._appendPicker("choice");
            var div = document.createElement("div");
            div.className = self.field.$skin + "-choice-list";
            self._$$list = $(div).hide();
            self.field.$$fieldValue.append(self._$$list);
            var input = self.field.$$input[0];
            if (self.field.$item.$icon) {
                self.iconValue = self.createIcon(this.field.currentValue, self.field.$skin + "-choice-icon");
                $(self.field._boxPicker).prepend(self.iconValue);
                self.iconValue.top = "2px";
                self.iconValue.left = "2px";
                var iconHeight = parseInt(self.$icon.$height.replace("px", ""));
                self.choiceBtn.style.top = Math.ceil(iconHeight / 4) + "px";
                input.style.paddingLeft = (parseInt(self.$icon.$width.replace("px", "")) + 8) + "px";
                input.style.paddingRight = (self.field._boxPickerPaddingRight - 20) + "px";
                input.style.height = (iconHeight + 4) + "px";
                if (self.field.$item.$icon.$inputMode == "icon") {
                    input.style.width = "0px";
                    input.style.visibility = "hidden";
                    self.field._boxPicker.className += " s-icon-mode";
                }
            }
            
            self._bindEvents();
        }
    },
    _bindEvents: function(){
        var self = this;
        self._$$list.delegate("a[data-s-index]", "click", function(){
            if (!self.field.$isDisabled && !self.field.$isReadOnly) {
                self._selectItem($(this).attr("data-s-index"), true);
                self.field.$$input.val(self._$selectedEnum.$title).change();
                if (self.iconValue) {
                    self.setIcon(self.iconValue, self._$selectedEnum.$value);
                }
                self.toggleList(false);
                self.field.focus();
            }
            return false;
        });
    },
    _selectItem: function($index, select){
        if (this._choices) {
            if (this._$selectedEnum) {
                this._choices[this._$selectedEnum.$index].$$item.toggleClass("s-choice-item-selected", false);
                delete this._$selectedEnum;
            }
            if (select) {
                this._$selectedEnum = this._$listSelection = this.field.$enum[$index];
                this._choices[$index].$$item.toggleClass("s-choice-item-selected", true);
                this._$selectedEnum.$index = $index;
            }
        }
    },
    setIcon: function(domImg, $value){
        domImg.style.backgroundImage = $value ? "url('" + this.$icon.$path + $value + ".png')" : "";
        //domImg.style.backgroundImage = image ? "url('" + image + "')" : "";
    },
    createIcon: function($value, css){
        var img = document.createElement("div");
        img.className = css;
        img.style.width = this.$icon.$width;
        img.style.height = this.$icon.$height;
        this.setIcon(img, $value);
        return img;
    },
    renderLayout: function(filter){
        var localize = locale.resources(module)();
        var self = this;
        self.releaseMode();
        self._choices = [];
        self._$$list.empty();
        var isRowLayout = self.field.$item.$choiceLayout == "row";
        var curCol = 0, $$cols;
        if (!isRowLayout) {
            $$cols = [];
            self._table = document.createElement("div");
            self._table.className = "s-field-choice-cb-table";
            self._$$list[0].appendChild(self._table);
            for (var ii = 0, colCount = parseInt(self.field.$item.$choiceLayout); ii < colCount; ii++) {
                var col = document.createElement("div");
                col.className = "s-field-choice-cb-col";
                $$cols[ii] = $(self._table.appendChild(col));
            }
        }
        var $skinItem = self.field.$skin + "-choice-list-item";
        var $icon = self.field.$item.$icon;
        self.field.$enum.forEach(function($enum, index){
            var html;
            if (filter) {
                if ((new RegExp("(" + filter + ")", "ig")).test($enum.$title)) {
                    html = $enum.$title.replace(new RegExp("(" + filter + ")", "ig"), "<strong class='s-auto-complete-filter'>$1</strong>");
                }
            }
            else {
                html = $enum.$title;
            }
            if (html) {
                var link = document.createElement("a");
                link.className = $skinItem;
                link.setAttribute("data-s-index", index);
                var $$item = $(link)
                if ($icon) {
                    $$item.append(self.createIcon($enum.$value, $skinItem + "-icon"));
                    if ($icon.$mode != "icon") {
                        $$item.append(html);
                    }
                    else {
                        $$item[0].setAttribute("title", html);
                    }
                }
                else {
                    $$item.append(html);
                }
                if (self.field.currentValue == $enum.$value) {
                    link.className += " s-choice-item-selected";
                }
                if (isRowLayout) {
                    $$item[0].style.display = "inline-block";
                    self._$$list.append($$item);
                }
                else {
                    $$cols[curCol].append($$item);
                    if (++curCol == $$cols.length) {
                        curCol = 0;
                    }
                }
                self._choices.push({
                    $index: index,
                    $$item: $$item
                });
            }
        });
        if (filter && self._choices.length == 0) {
            self._$$list.text(localize.cf_choiceFieldNoMatch);
        }
        self._setMinWidth();
    },
    _setMinWidth: function(){
        (this._table ? this._table : this._$$list[0]).style.minWidth = this.field.$$input.parent().width() + "px";
    },
    selectText: function(input, start, end){
        if (input.createTextRange) {
            var selRange = input.createTextRange();
            selRange.collapse(true);
            selRange.moveStart('character', start);
            selRange.moveEnd('character', end - start);
            selRange.select();
        }
        else 
            if (input.selectionStart) {
                input.selectionStart = start;
                input.selectionEnd = end;
            }
    },
    toggleList: function(show){
        var self = this;
        if (!self._popup && show !== false) {
            self.field.$$item.attr("id", self.field.id);
            if (self._choices.length == 0) {
                self.renderLayout();
            }
            if (self._$selectedEnum) {
                self._selectItem(self._$selectedEnum.$index, true);
            }
            self.field.focus();
            self._popup = self.field.boxParent.openDialog({
                content: self.field,
                $dialogMode: "popup",
                $$dialog: self._$$list,
                position: {
                    my: "left top",
                    at: "left bottom",
                    of: self.field.$$input
                },
                onClose: function(){
                    /*if (self.onAuthoring) {
                     return false;
                     }*/
                    self._popup = null;
                }
            });
        }
        else {
            if (self._popup) {
                if (show) {
                    self._setMinWidth();
                    self._popup.resize();
                }
                else {
                    self._popup.close();
                }
            }
        }
    },
    onInputKeyup: function($$input, event){
        return true;
        switch (event.keyCode) {
            case 27: //esc
                field.$$input.val(this._$selectedEnum ? this._$selectedEnum.$title : "");
                this.toggleList(false);
                break;
            case 40: //down
            case 38: //up
                var current = this._$listSelection ? this._$listSelection.$index : -1;
                var newIndex = (event.keyCode == 40) ? Math.min(current + 1, this._choices.length - 1) : Math.max(0, current - 1);
                this._$$list.children().toggleClass("s-choice-item-selected", false).filter("[data-s-index=" + newIndex + "]").toggleClass("s-choice-item-selected", true);
                field.$$input.val((this._$listSelection = field.$enum[newIndex]).$title);
                break;
            case 37: //left
            case 39: //right
                break;
            default:
                var filter = field.$$input.val();
                this.renderLayout(filter);
                if (this._choices.length > 0) {
                    var firstChoice = this._choices[0];
                    if (event.keyCode != 8) {
                        this._$listSelection = field.$enum[firstChoice.$index];
                        this.selectText(field.$$input.val(this._$listSelection.$title)[0], filter.length, this._$listSelection.$title.length);
                    }
                    if (event.keyCode == 13) {
                        firstChoice.$$item.click();
                        return;
                    }
                }
                this.toggleList(true);
                break;
        }
        return true;
    },
    releaseMode: function(){
        delete this._choices;
        delete this._table;
    },
    dispose: function(){
        if (this._$$list) {
            this._$$list.undelegate();
        }
        this.releaseMode(true);
        delete this.field;
    }
});
