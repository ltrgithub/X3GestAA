"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Field = require('syracuse-ui/lib/field/field').Field;


function PasswordField(){

}

exports.PasswordField = helpers.defineClass(PasswordField, Field, {
    createHtmlInput: function(){
        var input = document.createElement("input");
        input.setAttribute("type", "password");
        return input;
    },
    setDataValue: function(value, record){
        this.currentValue = value;
        if (this.$isEditMode) {
            this._input.value = this.currentValue;
        }
        else {
            this.fieldValue.textContent = (value || "").length > 0 ? "***" : "";
        }
        this.confirmValue = this.currentValue = value;
    },
    render: function(){
        Field.prototype.render.call(this);
        if (this.$isEditMode) {
            if (!this.$item.$isConfirmDisabled) {
                this.confirmInput = this.createHtmlInput();
                this.confirmInput.setAttribute("data-s-field", this.id);
                this.confirmInput.setAttribute("placeholder", this.getLocalize().pw_confirmPassword);
                this.confirmInput.className += " s-field-pwd-conf";
                this.confirmInput.style.width = "100%";
                if (this.$item.$maxLength) {
                    this.confirmInput.setAttribute("maxlength", this.$item.$maxLength);
                }
                this.fieldValue.appendChild(this.confirmInput);
                
            }
        }
    },
    setState: function(state){
        Field.prototype.setState.call(this, state);
        if (this.confirmInput && state.$isDisabled !== undefined) {
            document.site.disableItem(this.confirmInput, state.$isDisabled);
        }
    },
    
    onInputValidate: function(event){
        var newValue = event.target.value || "";
        if (this.confirmInput && (this._input.value != this.confirmInput.value)) {
            this.validate(newValue);
        }
        else {
            Field.prototype.onInputValidate.call(this, event);
        }
    },
    validateType: function(errors, value){
        if (this.confirmInput && (this._input.value != this.confirmInput.value)) {
			errors.push(this.getLocalize().pw_confirmPasswordError);
        } else {
        	// format value
        	var salt = this.$field.$salt;
        	var self = this;
        	// replace fields of user entity with their corresponding values
        	salt = salt.replace(/\{(\w+)\}/g, function(d0, d1) {
        		try {
        			return self.articleParent.boundFields[d1][0].getDataValue();
        		} catch (e) {
            		errors.push(self.getLocalize().pw_replFieldNotFound+": "+d1)        		
        		} 
        	});
        	if (errors.length === 0) {
               	var md5result = md5(salt+":"+this._input.value)
               	this._input.value = this.confirmValue = this.currentValue = md5result;        		
        	}
        }
    }
});
