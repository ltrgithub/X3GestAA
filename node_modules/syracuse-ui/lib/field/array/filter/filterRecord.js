"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;
var FilterCell = require('./filterCell').FilterCell;

function FilterRecord(){
}

exports.FilterRecord = helpers.defineClass(FilterRecord, Article, {
    loadRecord: function(list){
        this.list = list;
        this.isRecordArticle = true;
        this.$facet = "$filter";
        this.$isEditMode = true;
        this.$prototype = list.$prototype.$item;
        this.$prototype.$localization = list.page.$prototype.$localization;
        list.page.initializeNewItem(this, {
            $layout: {
                $items: list.$item.$layout.$items
            }
        }, list);
        this.loadBox();
    },
    reorderCells: function(targetIndex, sourceIndex, dropAtEnd){
        var children = this.dataRow.childNodes;
        var targetCell = children[targetIndex];
        var sourceCell = children[sourceIndex];
        targetCell.parentNode.insertBefore(sourceCell, dropAtEnd ? targetCell.nextSibling : targetCell);
        this.$item.$layout.$items.splice(newSourceIndex, 0, this.$item.$layout.$items.splice(sourceIndex, 1)[0]);
    },
    _appendCell: function(slot){
        var td = document.createElement("td");
        td.className = "s-list-filter-cell";
        return slot.appendChild(td);
    },
    appendEmptyCell: function(slot){
        return this._appendCell(slot || this.dataRow);
    },
    appendFlagCell: function(slot){
        var td = this.appendEmptyCell(slot);
        td.className += " s-list-filter-flag";
        td.style.backgroundImage = "url('" + document.site.$item.$iconPath + "list/s-filter-flag.png')";
    },
    appendFieldCell: function(col, $field){
        var cell = this._appendCell(this.dataRow);
        if (col.$isHidden) {
            cell.style.display = "none";
        }
        if ($field.$capabilities && ($field.$capabilities.indexOf("filter") >= 0)) {
            (this._cells[col.$item.$bind] = new FilterCell()).render(this, cell, $field, col.$item.$bind);
        }
    },
    drawBox: function(){
        this._cells = {};
        if (this.$$item) {
            this.$$item.empty()[0];
        }
        else {
            this.dataRow = document.createElement("tr");
            this.boxParent.builder._thead.appendChild(this.dataRow);
            this.$$item = $(this.boxParent.builder._thead.appendChild(this.dataRow));
        }
    },
    _buildFilter: function(){
        var values = [];
        var params = {};
        var $binds = Object.keys(this._cells);
        for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
            var value = this._cells[$binds[ii]].getValue();
            if (value) {
                values.push(value);
            }
        }
        params.filter = values.join(" and ");
        this.boxParent.fetch(params);
    },
    onNotifyDataChange: function(field, value){
        this.dataset[field.$item.$bind] = value;
        var filter = this._cells[field.$item.$bind];
        if (value == null || value == "") {
            if (filter && filter.operator !== "none") {
                if (filter.operator == "between") {
                    var fieldFirst = this.record.boundFields[filter.$bind][0];
                    var fieldHigh = this.record.boundFields[filter.$bind + "$High"][0];
                    if (fieldFirst.currentValue == fieldHigh.currentValue) {
                        filter.setOperator("none");
                    }
                }
                else {
                    filter.setOperator("none");
                }
            }
        }
        else {
            if (filter) {
                //for high this._cells[$bind] is not defined
                filter.ensureEqual();
            }
        }
        this._buildFilter();
        return false;
    },
    dispose: function(){
        if (this._cells) {
            var $binds = Object.keys(this._cells);
            for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
                document.controller.disposeObject(this._cells[$binds[ii]]);
            }
        }
        this._cells = this.list = this.page = this.dataRow = null;
        Article.prototype.dispose.call(this);
    },
    // FDB 
    fusionGetInputValues: function(){
        var res = [];
        var $binds = Object.keys(this._cells);
        for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
            var cell = this._cells[$binds[ii]];
            cell.ensureDefault();
            res.push(cell.fusionGetInputValue() || "");
        }
        return res;
    }
});
