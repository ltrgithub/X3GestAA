"use strict";
var helpers = require('syracuse-core/lib/helpers');

function GraphDecorator() {}

exports.GraphDecorator = helpers.defineClass(GraphDecorator, null, {
	switchView: function() {
		this.list.$item.$graphPosition = this.list.$item.$graphPosition == "front" ? "behind" : "front";
		this.ensureGraphVisibility();
		if (this.list.pagging) {
			this.list.pagging.showPagers();
		}
	},
	ensureGraphVisibility: function() {
		if (this.list.$item.$graphPosition == "front" || this.list.$item.$graphPosition == "behind") {
			var showGraph = this.list.$item.$graphPosition == "front";
			this.list.applyActionLinkChange({
				$links: {
					$toggleGraph: {
						$isHidden: false,
						$title: showGraph ? this.list.localize.flSwitchToList : this.list.localize.flSwitchToGraph,
						$iconValue: showGraph ? "switch-to-list" : "switch-to-graph"
					}
				}
			});
			if (this.list.menusBox) {
				document.site.toggleClass(this.list.menusBox.domTitle, "s-list-graph-switch-on", true);
			}
		} else {
			this.list.applyActionLinkChange({
				$links: {
					$toggleGraph: {
						$isHidden: true
					}
				}
			});
			if (this.list.menusBox) {
				document.site.toggleClass(this.list.menusBox.domTitle, "s-list-graph-switch-on", true);
			}
		}
		this.ensureGraph();
		this.list.tableSlot.style.display = this.list.$item.$graphPosition == "front" ? "none" : "";
		this.list.graphSlot.style.display = this.list.$item.$graphPosition == "behind" ? "none" : "";
		if (this.list.chart) {
			this.list.chart.onWindowResize();
		} else {
			this.list.onWindowResize();
		}
	},
	ensureGraph: function() {
		if (!this.list.chart && this.list.$item.$graphPosition != "behind") {
			this.list.chart = this.list.page.loadNewItem(this.list.graphSlot, {
				$category: "tabularChart",
				$renderer: this.list.$item.$renderer,
				$cube: this.list.$item.$cube,
				$isListEmbeded: true,
				$bind: this.list.$item.$bind
			}, this.list.articleParent);
			this.list.chart.attachedField = this.list;
			if (this.list.records && this.list.records.length) {
				var dataset = this.list.articleParent.dataset;
				if (dataset) {
					this.setDataBind(dataset[this.list.$item.$bind], dataset, dataset.$properties && dataset.$properties[this.list.$item.$bind]);
				}
			}
		}
	},
	applyGraphSettings: function(list, metaData) {
		this.list = list;
		if (metaData.$graphPosition !== undefined) {
			list.$item.$graphPosition = metaData.$graphPosition;
		}
		list.$item.$graphPosition = list.$item.$graphPosition || "bottom";
		if (metaData.$cube) {
			list.$item.$cube = metaData.$cube;
		}

		this.ensureGraphVisibility();
		if (this.list.chart) {
			this.list.chart.applyDesignMetaData(metaData);
		}
	},
	onWindowResize: function() {
		this.list.chart && this.list.chart.onWindowResize && this.list.chart.onWindowResize();
	},
	setDataBind: function(dataRecordSet, parentDataRecord, metaData) {
		this.list.chart && this.list.chart.setDataBind(dataRecordSet, parentDataRecord, metaData);
	},
	dispose: function() {
		if (this._chart) {
			this._chart.attachedField = null;
		}
		if (this.list) {
			if (this.list.chart && this.list.chart.attachedField) {
				this.list.chart.attachedField = null;
			}
			this.list.chart = null;
		}
		this.list = null;
	}
});