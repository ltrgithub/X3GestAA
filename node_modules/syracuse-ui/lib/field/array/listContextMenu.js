"use strict";
var helpers = require('syracuse-core/lib/helpers');
var ContextMenu = require('syracuse-ui/lib/field/menus/contextMenu').ContextMenu;

var _$quickActions = {
    list: {
        array: ["$create", "$select", "$delete"]
    },
    record: {
        array: ["$create", "$edit", "$delete"]
    }
};

Object.keys(_$quickActions).forEach(function($type){
    var actions = _$quickActions[$type];
    actions.array.forEach(function($action){
        actions[$action] = true;
    });
});


function ListContextMenu(){
}

exports.ListContextMenu = helpers.defineClass(ListContextMenu, ContextMenu, {
    appendQuickActions: function($menuItem){
        var self = this;
        if (!self._quickActions) {
            self._quickActions = {};
            self.$quickActions.array.forEach(function($bind){
                var slot = document.createElement("div");
                slot.className = "s-quick-actions-slot";
                self._quickActions[$bind] = $(self._actionsSlot.insertBefore(slot, self._menusBtnSlot));
            });
        }
        var menuItem = document.itemFactory.create({
            $bind: $menuItem.$bind,
            $category: $menuItem.$category || "link",
            $skin: "s-quick-actions-link",
            $icon: {
                $mode: "icon",
                $useCss: true
            }
        }, self.field);
        menuItem.$$container = self._quickActions[$menuItem.$bind];
        return menuItem;
    },
    clearMenuItems: function(){
        var self = this;
        if (self._quickActions) {
            Object.keys(self._quickActions).forEach(function($bind){
                $(self._quickActions[$bind]).remove();
            });
            delete self._quickActions;
        }
        self._isMenuBtnVisible = false;
        self._menusBtnSlot.style.display = "none";
        if (self.hasColumns) {
            self.field.builder.setContextMenusCol(null, true);
        }
    },
    create: function(field){
        var self = this
        if (field.list) {
            self.$skinMenus = "s-record-menus";
            self.$skinActionSlot = field.list.$skin + "-record-actions";
            self.$quickActions = _$quickActions.record;
            self.hasColumns = false;
            switch (field.list.$item.$format) {
                case "vgrid":
                    self.popupContent = {
                        id: helpers.uuid.generate(),
                        $$item: $(field._contextMenusSlot)
                    };
                    break;
                case "grid":
                    self.hasColumns = true;
                    break;
            }
        }
        else {
            self.$skinMenus = "s-list-menus";
            self.$skinActionSlot = "s-list-actions";
            self.$quickActions = _$quickActions.list;
        }
        ContextMenu.prototype.create.call(this, field, {
            onBeforeAddMenuItem: function($menuItem){
                if (self.$quickActions[$menuItem.$bind]) {
                    if (self.hasColumns) {
                        self.field.builder.setContextMenusCol($menuItem.$bind);
                    }
                    return self.appendQuickActions($menuItem);
                }
                else {
                    if (!self._isMenuBtnVisible) {
                        self._menusBtnSlot.style.display = "";
                        self._isMenuBtnVisible = true;
                        if (self.hasColumns) {
                            self.field.builder.setContextMenusCol($menuItem.$bind);
                        }
                        if ($menuItem.$bind == "$lazyload") {
                            var title;
                            if (self.field.list) {
                                title = self.field.list._localize.mn_actions;
                            }
                            else {
                                title = self.field._localize.mn_actions;
                                self.menuPicker.textContent = title;
                            }
                            self.menuPicker.setAttribute("title", title);
                            return false;
                        }
                    }
                }
            }
        });
    },
    appendOpener: function(){
        this._actionsSlot = document.createElement("div");
        this._actionsSlot.className = this.$skinActionSlot;
        this.field._contextMenusSlot.appendChild(this._actionsSlot);
        this.menuPicker = document.createElement("a");
        var title;
        if (this.field.list) {
            this.menuPicker.className = "s-record-menus-btn s-close";
            title = this.field.list._localize.mn_more;
        }
        else {
            this.menuPicker.className = "s-list-menus-btn s-close";
            title = this.field._localize.mn_more;
            this.menuPicker.textContent = title;
        }
        this.menuPicker.setAttribute("title", title);
        this.menuPicker.setAttribute("data-s-picker", "menus");
        this._isMenuBtnVisible = false;
        this.menuPicker.setAttribute("id", this.field.id + "-menu-btn");
        (this._menusBtnSlot = document.createElement("div")).className = "s-quick-actions-slot";
        this._menusBtnSlot.style.display = "none";
        this._actionsSlot.appendChild(this._menusBtnSlot).appendChild(this.menuPicker);
    },
    removeOpener: function(){
        if (this.menuPicker) {
            document.site.emptyDom(this.field._contextMenusSlot);
            delete this.menuPicker;
            delete this._quickActions;
        }
    }
});
