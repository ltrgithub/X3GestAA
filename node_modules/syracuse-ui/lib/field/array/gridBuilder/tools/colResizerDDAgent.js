"use strict";
var helpers = require('syracuse-core/lib/helpers');

function ColResizerDDAgent() {}

exports.ColResizerDDAgent = helpers.defineClass(ColResizerDDAgent, null, {
	start: function(dropItem) {
		this.resizedCol = dropItem.resizedCol;
		this.list = dropItem.list;
		document.site.ddManager.ddAgent = this;
		delete this.rightResizedCol;
		var offset = this.resizedCol.titleCell.getBoundingClientRect();
		this.left = offset.left;
		this.top = offset.top;
		this.height = offset.height;
		this.right = offset.right;
		this.bottom = offset.bottom;
		this.startX = this.resizedCol.resizer.getBoundingClientRect().left;
		this.resizedCol.resizer.style.cursor = this.cursor = "e-resize";

		if (this.list.scroller.isProportionalWidth) {
			var resizedColIndex;
			for (var ii = 0, jj = this.list.orderCols.length; ii < jj; ii++) {
				var col = this.list.orderCols[ii];
				if (col.realWidth !== undefined) {
					col.widthValue = col.realWidth;
				}
				if (col == this.resizedCol) {
					resizedColIndex = ii;
				}
			}
			if (resizedColIndex != undefined) {
				if ((resizedColIndex + 1) < this.list.orderCols.length) {
					this.rightResizedCol = this.list.orderCols[resizedColIndex + 1];
					this.rightResizedCol.widthValue = this.rightResizedCol.titleCell.clientWidth;
				}
			}
		}
	},
	onDragMouseMove: function(target, event) {
		var cursor = "not-allowed";
		if ((event.pageY >= (this.top - 20)) && (event.pageY <= (this.bottom + 20))) {
			var newWidth = this.resizedCol.widthValue + (event.pageX - this.startX);
			if (newWidth > 50) {
				this.resizedCol.groupHead.style.width = this.resizedCol.groupBody.style.width = (this.newWidth = newWidth) + "px";
				if (this.rightResizedCol) {
					this.rightResizedCol.groupHead.style.width = this.rightResizedCol.groupBody.style.width = (this.rightResizedCol.widthValue = this.rightResizedCol.realWidth - (event.pageX - this.startX)) + "px";
				}
				cursor = "e-resize";
			}
		}
		document.site.body.style.cursor = cursor;
	},
	onDragMouseUp: function(target, event) {
		this.resizedCol.widthValue = this.newWidth;
		var $items = this.list.$item.$layout.$items;
		for (var ii = 0, jj = $items.length; ii < jj; ii++) {
			if ($items[ii].$bind == this.resizedCol.$bind) {
				$items[ii].$width = Math.round(this.resizedCol.widthValue) + "px";
				this.list.saveListDesign(true, this.list.saveUserPreferences("$colWidths"));
				break;
			}
		}
		document.site.body.style.cursor = "default";
	},
	dispose: function() {
		this.startX = this.resizedCol = this.list = this.resizedCol = this.rightResizedCol = null;
	}
});