"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;
var FilterCell = require('./filterCell').FilterCell;

function FilterRecord() {}

exports.FilterRecord = helpers.defineClass(FilterRecord, Article, {
	loadRecord: function(list) {
		this.list = list;
		this.isRecordArticle = true;
		this.isFilterArticle = true;
		this.$facet = "$filter";
		this.$isEditMode = true;
		this.$prototype = list.$prototype.$item;
		this.$prototype.$localization = list.page.$prototype.$localization;
		list.page.initializeNewItem(this, {
			$layout: {
				$items: list.$item.$layout.$items
			}
		}, list);
		this.loadBox();
	},
	//set focus on first field
	setFocus: function() {
		for (var ii = 0, jj = this.list.orderCols.length; ii < jj; ii++) {
			var col = this.list.orderCols[ii];
			if (col.$bind) {
				var $field = this.list.$fields[col.$bind];
				if ($field && !$field.$isHidden && !$field.$isHidden && !$field.$isDisabled) {
					var cell = this.fieldCells[col.$bind];
					if (cell && cell.field) {
						cell.field.focus();
						break;
					}
				}
			}
		}
	},
	createCell: function() {
		var td = document.createElement("td");
		td.className = "s-list-filter-cell";
		return td;
	},
	appendCell: function(slot) {
		return (slot || this.dataRow).appendChild(this.createCell());
	},
	appendFlagCell: function(slot) {
		var td = this.appendCell(slot);
		td.className += " s-filter-popup-picker";
		td.style.backgroundImage = "url('" + syra_site.$item.$iconPath + "page/s-filter-flag.png')";
	},
	appendFieldCell: function(col, $field) {
		var cell = this.appendCell(this.dataRow);
		if (col.$isHidden) {
			cell.style.display = "none";
		}
		if (this.list.hasFieldFilterCapability($field)) {
			this.list.fomatter.filter.renderCell(this.fieldCells[col.$item.$bind] = new FilterCell(), this, cell, $field, col.$item.$bind);
		}
	},
	drawBox: function() {
		this.fieldCells = {};
		if (this.domItem) {
			RecordArticle.prototype.remove.call(this);
		} else {
			this.domItem = this.dataRow = document.createElement("tr");
			this.list.scrollTable.headTable.appendChild(this.dataRow);
		}
	},
	checkVisibility: function() {
		var isVisible;
		var $binds = Object.keys(this.fieldCells);
		for (var ii = 0, jj = $binds.length; !isVisible && ii < jj; ii++) {
			var $bind = $binds[ii];
			if (!this.fieldCells[$bind].$field.$isHidden) {
				isVisible = true;
			}
		}
		this.domItem.style.display = isVisible ? "" : "none";
	},
	onNotifyDataChange: function(field, value) {
		return this.list.fomatter.filter.onNotifyDataChange(this, field, value);
	},
	dispose: function() {
		if (this.fieldCells) {
			var $binds = Object.keys(this.fieldCells);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				this.fieldCells[$binds[ii]].dispose();
			}
		}
		this.fieldCells = this.list = this.dataRow = null;
		Article.prototype.dispose.call(this);
	}
});