"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RecordArticle = require("syracuse-ui/lib/field/array/recordArticle").RecordArticle;


function _drawVgridRecord(record){
    var cols = record.builder.cols;
    record.orderCols = [];
    record.$isVerticalDirection = false;
    if (record.list.$item.$isRowIndexVisible) {
        var td = record.appendRowIndexCell(record.builder.cols.$rowIndex.slot);
        td.setAttribute("data-s-record", record.$recordUuid);
        if (record.list._store.selector.isRowMode) {
            td.className += " s-list-selector-row";
        }
        record.orderCols.push(td);
    }
    if (record.list._store.selector.appendToRecord) {
        record.orderCols.push(record.appendRecordSelector(cols.$recordSelector.slot));
        record._selectorCheck.setAttribute("data-s-record", record.$recordUuid);
    }
    
    if (!record.list.$item.$isMenuRecordHidden) {
        record._contextMenusSlot = document.createElement("td");
        record._contextMenusSlot.className = record.builder.gridCss.cell + " " + record.list.$skin + "-actions-cell";
        record.orderCols.push(cols.$contextMenus.slot.appendChild(record._contextMenusSlot));
        
        record.list.applyCapabilities(record);
    }
    
    record.builder.parseItems(function($item, $field){
        var td = record.appendFieldCell(cols[$item.$bind].slot, $item, true);
        td.setAttribute("data-s-record", record.$recordUuid);
        if (record.$isEditMode) {
            record.boundFields[$item.$bind][0].$$dataValue[0].style.minWidth = cols[$item.$bind].group.style.width;
        }
        if (record.list._store.selector.isRowMode) {
            td.className += " s-list-selector-row";
        }
        record.orderCols.push(td);
    });
    
    
}

function reorderVGridRecord(sourceRecord, targetRecord, $insert){
    for (var ii = 0; ii < sourceRecord.orderCols.length; ii++) {
        $(sourceRecord.orderCols[ii])[$insert](targetRecord.orderCols[ii]);
    }
}

function GridRecord(){
}

exports.GridRecord = helpers.defineClass(GridRecord, RecordArticle, {
    onNotifyRecordChange: function(value, binding){
        var self = this;
        var sendBag = this.builder.ensureSendBag();
        
        if (binding == "$actions") {
            if (!self.$isDisabled && !self.$isDeleted) {
                if (value.$delete || value.$create) {
                    var builder = self.builder;
                    var $resources = builder.list.getDataSet();
                    if (value.$delete) {
                        $resources.splice(self.$recordIndex, 1);
                        builder.list._store._records.splice(self.$recordIndex, 1);
                        builder.list.removeItem(self, true);
                    }
                    if (value.$create) {
                        var index = self.$recordIndex;
                        $resources.splice(index, 0, null);
                        var newRecord = builder.list._store.appendRecord({
                            dataRecord: {
                                $uuid: document.controller.generateUUID()
                            },
                            isInsert: true,
                            $recordIndex: index
                        });
                        builder.list._store.setRecordsIndex();
                        sendBag.recordDataset.push(newRecord.dataset);
                        document.controller.notifyChange(self.list.getArticleParent(), self.list.$item.$bind, sendBag.recordDataset);
                    }
                    //builder.list._store.setRecordsIndex();
                    //builder._notifyChange($resources);
                }
            }
            return null; //cancel notify
        }
        
        //        var sendBag = this.builder.ensureSendBag();
        var bagDataset;
        sendBag.recordDataset.forEach(function(dataset){
            if (dataset.$uuid == self.dataset.$uuid) {
                (bagDataset = dataset)[binding] = value;
                return true;
            }
            return false;
        });
        if (!bagDataset) {
        
            bagDataset = {
                $uuid: self.dataset.$uuid
            };
            bagDataset[binding] = value;
            sendBag.recordDataset.push(bagDataset);
        }
        /*debugger;
         var data = {
         $uuid: self.dataset.$uuid
         };
         data[binding] = value;*/
        document.controller.notifyChange(this.list.getArticleParent(), this.list.$item.$bind, sendBag.recordDataset);
        return null;
        return bagDataset;
    },
    notifyReorder: function(targetRecord, $insert){
        if (this.list.$item.$format == "vgrid") {
            reorderVGridRecord(this, targetRecord, $insert);
        }
        else {
            this.$$item[$insert](targetRecord.$$item);
            if (this.rowDiagnose) {
                this.$$item.after(this.rowDiagnose);
            }
            if (this.$$cardsSlot) {
                this.$$item.after(this.$$cardsSlot.parent());
            }
        }
    },
    ensureFieldDiagnoseSlot: function(field){
        if (!this.cellDiagnose) {
            this.cellDiagnose = document.createElement("td");
            this.cellDiagnose.className = this.boxParent.$skin + "-diagnose-cell";
            this.cellDiagnose.setAttribute("colspan", this.boxParent.builder._orderCols.length);
            this.rowDiagnose = document.createElement("tr");
            this.rowDiagnose.setAttribute("data-s-record", this.$recordUuid);
            $(this.rowDiagnose).insertAfter(this.$$item);
            this.rowDiagnose.appendChild(this.cellDiagnose);
        }
        this.cellDiagnose.appendChild(field.domDiagnose);
    },
    initializeRecord: function(options){
        options.$item = {
            $layout: {
                $items: this.list.$item.$layout.$items
            }
        };
    },
    remove: function(){
        if (this.list.$item.$format == "grid") {
            this.$$item.remove();
            if (this.builder.cardview) {
                this.builder.cardview.onRecordRemove(this);
            }
        }
    },
    appendRowIndexCell: function(slot){
        var td = document.createElement("td");
        td.className = this.builder.gridCss.rowIndex;
        $(slot.appendChild(td)).text((this.list._store.pagingCapability._$startIndex || 0) + this.$recordIndex);
        if (this.list.$capability.reorder) {
            td.className += " s-list-record-reorder";
        }
        return td;
    },
    appendFieldCell: function(slot, $item, $isBindInputEvent){
        var td = document.createElement("td");
        td.className = this.builder.gridCss.cell;
        document.itemFactory.load($(slot.appendChild(td)), {
            $bind: $item.$bind,
            $isCellChild: true,
            $inplace: true,
            $isBindInputEvent: $isBindInputEvent
        }, this)
        return td;
    },
    appendRecordSelector: function(slot){
        var td = document.createElement("td");
        td.className = this.builder.gridCss.cell;
        this._selectorCheck = this.list._store.selector.appendToRecord(slot.appendChild(td));
        return td;
    },
    drawBox: function(){
        if (this.list.$item.$format == "vgrid") {
            _drawVgridRecord(this);
        }
        else {
            var self = this;
            
            self.$isVerticalDirection = true;
            self._dataRow = document.createElement("tr");
            self._dataRow.setAttribute("data-s-record", self.$recordUuid);
            
            
            if (self.isInsert) {
                self.$$item = $(self._dataRow);
                if (self.builder.list._store._records[self.$recordIndex]) {
                    self.$$item.insertBefore(self.builder.list._store._records[self.$recordIndex].$$item);
                    
                }
                else {
                    //hack temp pour teddy
                    
                    self.$$item = $(self.builder._body.appendChild(self._dataRow));
                }
                delete self.isInsert;
            }
            else {
                self.$$item = $(self.builder._body.appendChild(self._dataRow));
            }
            
            if (self.list.$item.$alternateStyle && self.$recordIndex % 2) {
                self._dataRow.className = self.list.$skin + "-alt";
            }
            
            if (self.list.$item.$isRowIndexVisible) {
                this.appendRowIndexCell(self._dataRow);
            }
            
            if (self.builder.cardview) {
                self.builder.cardview.onRecordDrawBox(self);
            }
            if (!self.list.$item.$isMenuRecordHidden) {
                self._contextMenusSlot = document.createElement("td");
                self._contextMenusSlot.className = self.builder.gridCss.cell + " " + self.list.$skin + "-actions-cell";
                self._dataRow.appendChild(self._contextMenusSlot);
                self.list.applyCapabilities(self);
            }
            
            if (self.list._store.selector.appendToRecord) {
                self.appendRecordSelector(self._dataRow);
            }
            if (self.list._store.selector.isRowMode) {
                self._dataRow.className = "s-list-selector-row";
            }
            
            self.builder.parseItems(function($item, $field){
                self.appendFieldCell(self._dataRow, $item);
            });
        }
    },
    highlightSelection: function(selected){
        if (this.list.$item.$format == "grid") {
            document.site.toggleClass(this.$$item[0], "s-list-record-selected", selected);
            if (this.builder.cardview) {
                this.builder.cardview.onRecordHighlightSelection(this, selected);
            }
        }
        else {
            if (this.orderCols) {
                this.orderCols.forEach(function(td){
                    document.site.toggleClass(td, "s-list-record-selected", selected);
                });
            }
        }
        if (this._selectorCheck) {
            $(this._selectorCheck).attr("checked", selected);
        }
    }
});
