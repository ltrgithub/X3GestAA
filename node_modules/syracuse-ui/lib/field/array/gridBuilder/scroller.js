"use strict";
var helpers = require('syracuse-core/lib/helpers');

function Scroller() {}

exports.Scroller = helpers.defineClass(Scroller, null, {
	load: function(list) {
		this.list = list;
		this.setFixedBodyHeight(this.list.$item.$fixedBodyHeight);
	},
	getInvisibleSize: function() {
		var bodyRect = this.getVisibleSize();
		return {
			height: this.bodySlot.scrollHeight - bodyRect.height,
			width: this.bodySlot.scrollWidth - bodyRect.width
		};
	},
	getVisibleSize: function() {
		return this.bodySlot.getBoundingClientRect();
	},
	setFixedBodyHeight: function($fixedBodyHeight) {
		this.$fixedBodyHeight = parseInt($fixedBodyHeight || 0, 10);
	},
	validateFixedColumns: function() {
		var isFixed = true;
		for (var ii = 0, jj = this.list.orderCols.length; ii < jj; ii++) {
			var col = this.list.orderCols[ii];
			if (col.$bind) {
				isFixed = col.$isFixed = isFixed && col.$item.$isFixed;
				if (!isFixed) {
					delete col.$item.$isFixed;
				} else {
					col.$item.$isFixed = true;
				}
			} else {
				col.$isFixed = true;
			}
		}
	},
	scrollToTitleItem: function(domItem) {
		this.list.page.scrollToItem(domItem, this._headSlot, true);
	},
	scrollToItem: function(domItem) {
		this.list.page.scrollToItem(domItem, this.bodySlot, true);
	},
	getScrollBoundary: function() {
		var boundary = document.site.getBoundingClientRect(this.bodySlot);
		boundary.bodySlot = this.bodySlot;
		boundary.hscroller = this._hscroller;
		boundary.scrollWidth = this._hscroller.scrollWidth;
		boundary.scrollHeight = this.bodySlot.scrollHeight;
		return boundary;
	},
	drawSlots: function(core, header, body) {
		this._headSlot = document.createElement("div");
		this._headSlot.className = this.list.$skin + "-slot-head";
		this._headSlot.appendChild(header);

		this._hscroller = document.createElement("div");
		this._hscroller.className = this.list.$skin + "-h-scroll";
		this._hscroller.appendChild(this._hscrollBody = document.createElement("div"));
		this._hscrollBody.className = this.list.$skin + "-h-scroll-body";
		this._$$hscroller = $(this._hscroller);

		this._$$bodySlot = $(this.bodySlot = document.createElement("div"));
		this.bodySlot.className = this.list.$skin + "-slot-body";
		this.bodySlot.appendChild(body);

		core.appendChild(this._headSlot);
		core.appendChild(this.bodySlot);
		core.appendChild(this._hscroller);

		this._bindEvents(true);
	},
	_calculateScrollableView: function(clientWidth, firstScrollableColIndex) {
		var cols = this.list.orderCols;
		this._widthTotal = 0;
		this.scrollWidthTotal = 0;
		this.fixWidth = 0;
		this.lastColIndex = cols.length - 1;

		if (firstScrollableColIndex == undefined) {
			this.firstScrollableColIndex = 0;
			for (var ii = 0, jj = cols.length; ii < jj; ii++) {
				var col = cols[ii];
				if (!col.$isHidden && !col.$isFixed) {
					this.firstScrollableColIndex = ii;
					break;
				}
			}
		} else {
			this.firstScrollableColIndex = firstScrollableColIndex;
		}
		for (var ii = 0, jj = cols.length; ii < jj; ii++) {
			var col = cols[ii];
			if (!col.$isHidden) {
				if (this.firstScrollableColIndex) {
					if ((ii >= this.firstScrollableColIndex) || (this.fixWidth > clientWidth)) {
						col.minX = this.scrollWidthTotal;
						col.scrollWidth = col.widthValue;
						this.scrollWidthTotal += col.widthValue;
						col.maxX = this.scrollWidthTotal;
					} else {
						this.fixWidth += col.widthValue;
					}
				}
				this._widthTotal += col.widthValue;
			}
		}
		if (firstScrollableColIndex === undefined) {
			if (this.firstScrollableColIndex && (clientWidth < this._widthTotal)) {
				var space = clientWidth - this.fixWidth;
				if (space < 100 && this.scrollWidthTotal > (space + 100)) {
					for (var ii = this.firstScrollableColIndex - 1; ii > 0; ii--) {
						var col = cols[ii];
						if (!col.$isHidden) {
							this.fixWidth -= col.widthValue;
							space = clientWidth - this.fixWidth;
							if (space < 100 && this.scrollWidthTotal > (space + 100)) {
								break;
							}
						}
					}
					this._calculateScrollableView(clientWidth, ii > 0 ? ii : 0);
				}
			}
		}
	},
	onListResize: function() {
		if (this.bodySlot && this.bodySlot.clientWidth) {
			var clientWidth = this.bodySlot.clientWidth;
			if (clientWidth) {
				this._calculateScrollableView(clientWidth);
				if (this._widthTotal < clientWidth) {
					this.isProportionalWidth = true;
					var propWidthTotal = this._widthTotal;
					var propClientWidth = clientWidth;
					for (var ii = 0, jj = this.list.orderCols.length; ii < jj; ii++) {
						var col = this.list.orderCols[ii];
						if (!col.$isHidden) {
							if (col.$bind) {
								var width = col.widthValue;
								if (col.isUserPreferenceWidth) {
									col.scrollWidthValue = col.realWidth = width;
									propWidthTotal -= width;
									propClientWidth -= width;
								} else {
									width = width / propWidthTotal;
									col.scrollWidthValue = col.realWidth = width = width * propClientWidth;
								}
								col.groupHead.style.width = col.groupBody.style.width = width + "px";
							} else {
								propWidthTotal -= col.widthValue;
								propClientWidth -= col.widthValue;
							}
						}
					}
				} else {
					if (this.isProportionalWidth) {
						for (var ii = 0, jj = this.list.orderCols.length; ii < jj; ii++) {
							var col = this.list.orderCols[ii];
							if (!col.$isHidden) {
								col.groupHead.style.width = col.groupBody.style.width = (col.realWidth = col.widthValue) + "px";
							} else {
								col.groupHead.style.width = col.groupBody.style.width = (col.realWidth = 0) + "px";
							}
						}
						delete this.isProportionalWidth;
					}
				}
			}
			this.scrollAreaWidth = this._widthTotal - clientWidth;
			this._hscrollBody.style.width = this._widthTotal + "px";

			if (this.bodySlot.scrollHeight > (this.bodySlot.clientHeight + 1)) {
				this._headSlot.style.marginRight = "17px";
				if (!this._headerCorner) {
					this._headerCorner = document.createElement("div");
					this._headerCorner.className = this.list.$skin + "-head-corner";
					this._headSlot.parentNode.appendChild(this._headerCorner);
				}
				this._headerCorner.style.display = "";
				this._headerCorner.style.height = this._headSlot.clientHeight + "px";
			} else {
				this._headSlot.style.marginRight = "";
				if (this._headerCorner) {
					this._headerCorner.style.display = "none";
				}
			}
			this._hscroller.style.display = this.scrollAreaWidth > 0 ? "" : "none";
			if (this.$fixedBodyHeight || this.list.$item.$fitContainer || this.list.$isDockedHeight) {
				if (this.bodySlot.style.overflowY != "auto") {
					this.bodySlot.style.overflowY = "auto";
				}
				if (this.list.$isDockedHeight) {
					var scrollRect = document.site.getBoundingClientRect(this.list.page.scrollview);
					var bodyRect = document.site.getBoundingClientRect(this.bodySlot);
					var fieldRect = document.site.getBoundingClientRect(this.list.$$fieldValue[0]);
					var headerH = Math.ceil(bodyRect.top - fieldRect.top);
					var bottomH = Math.ceil(Math.max(0, (fieldRect.height - headerH) - bodyRect.height));
					bodyHeight = this.list.page.scrollview.clientHeight - ((bodyRect.top - scrollRect.top) + bottomH);
				} else {
					if (this.$fixedBodyHeight || this.list.$item.$fitContainer) {
						var bodyHeight;
						var bodyRect = document.site.getBoundingClientRect(this.bodySlot);
						bodyHeight = this.list.$item.$fitContainer ? 0 : this.$fixedBodyHeight;
						if (!bodyHeight) {
							var slotRect = this.list.layoutSlot.getBoundingClientRect();
							var containerHeight = this.list.layoutSlot.offsetHeight - ((this.list.$$item.outerHeight() - this.list.$$item.height()));
							bodyHeight = containerHeight - (bodyRect.top - slotRect.top) - this._hscroller.offsetHeight;
						}
						if (Math.abs(bodyHeight - bodyRect.height) < 2) {
							bodyHeight = bodyRect;
						}
						this.bodySlot.style.height = bodyHeight + "px";
					}
				}
			} else {
				if (this.bodySlot.style.overflowY == "auto") {
					this.bodySlot.style.overflowY = "";
					this.bodySlot.style.height = "";
				}
			}
			this._appendButtons();
		}
	},
	scrollFixedColumns: function(isScrollSet) {
		if (!this.isProportionalWidth && this.firstScrollableColIndex) {
			for (var ii = this.firstScrollableColIndex; ii <= this.lastColIndex; ii++) {
				var col = this.list.orderCols[ii];
				if (!col.$isHidden) {
					if (this._hscroller.scrollLeft > col.maxX) {
						if (this.focusedCol === col) {
							this._hscroller.scrollLeft = col.minX;
							return;
						}
						col.groupHead.style.width = col.groupBody.style.width = (col.scrollWidthValue = 0) + "px";
					} else {
						if (this._hscroller.scrollLeft <= col.minX) {
							col.groupHead.style.width = col.groupBody.style.width = (col.scrollWidthValue = col.widthValue) + "px";
						} else {
							if (this._hscroller.scrollLeft >= col.minX && this._hscroller.scrollLeft <= col.maxX) {
								if (this.focusedCol === col) {
									continue;
								}
								var diff = this._hscroller.scrollLeft - col.minX;
								col.groupHead.style.width = col.groupBody.style.width = (col.scrollWidthValue = (col.widthValue - diff)) + "px";
							}
						}
					}
				}
			}
			this._currentHScrollerScrollLeft = this._hscroller.scrollLeft;
		}
	},
	ensureFieldVisibility: function(field) {
		if (this.firstScrollableColIndex) {
			var index = (field.$item.$isFilterMode ? field.layoutSlot.parentNode : field.layoutSlot).cellIndex;
			if (index !== undefined) {
				var fieldRect = field.domItem.getBoundingClientRect();
				var bodyRect = this.bodySlot.getBoundingClientRect();
				var col = this.list.orderCols[index];
				if (col) {
					this._calculateScrollableView(this.bodySlot.clientWidth);
					var firstX = bodyRect.left + this.fixWidth;
					var lastX = bodyRect.right - 10; //margin
					var visibleWidth = lastX - firstX;
					var newScrollLeft;
					if (col.scrollWidthValue != col.scrollWidth || fieldRect.right > bodyRect.right) {
						if (this._hscroller.scrollLeft > col.minX || visibleWidth < col.widthValue) {
							newScrollLeft = col.minX;
						} else {
							var space = (fieldRect.left - lastX) + Math.min(visibleWidth, col.widthValue);
							newScrollLeft = this._hscroller.scrollLeft + space;
						}
						if (newScrollLeft !== undefined) {
							this.focusedCol = col;
							this._hscroller.scrollLeft = newScrollLeft;
						}
					}
				}
			}
		}
	},
	_bindEvents: function(bind) {
		var self = this;
		if (bind) {
			(self._$$hscroller = $(self._hscroller)).bind("scroll", function(event) {
				document.site.onBeforClick(self.list, event);
				if (!self.firstScrollableColIndex) {
					if (self.bodySlot.scrollLeft != self._hscroller.scrollLeft) {
						self.bodySlot.scrollLeft = self._hscroller.scrollLeft;
					}
					if (self._headSlot.scrollLeft != self._hscroller.scrollLeft) {
						self._headSlot.scrollLeft = self._hscroller.scrollLeft;
					}
				} else {
					self.bodySlot.scrollLeft = self._headSlot.scrollLeft = 0;
					self.scrollFixedColumns();
					delete self.focusedCol;
				}

			});
			self._$$bodySlot.bind("scroll", function(event) {
				if (!self.firstScrollableColIndex) {
					if (self._hscroller.scrollLeft != self.bodySlot.scrollLeft) {
						self._hscroller.scrollLeft = self.bodySlot.scrollLeft;
					}
					if (self._headSlot.scrollLeft != self.bodySlot.scrollLeft) {
						self._headSlot.scrollLeft = self.bodySlot.scrollLeft;
					}
				} else {
					if (self.bodySlot && self.bodySlot.scrollLeft) {
						self._hscroller.scrollLeft += self.bodySlot.scrollLeft;
						self.bodySlot.scrollLeft = 0;
					}
					return false;
				}
			});
			(self._$$headSlot = $(self._headSlot)).bind("scroll", function(event) {
				if (!self.firstScrollableColIndex) {
					if (self._hscroller.scrollLeft != self._headSlot.scrollLeft) {
						self._hscroller.scrollLeft = self._headSlot.scrollLeft;
					}
					if (self.bodySlot.scrollLeft != self._headSlot.scrollLeft) {
						self.bodySlot.scrollLeft = self._headSlot.scrollLeft;
					}
				} else {
					if (self._headSlot.scrollLeft) {
						self._hscroller.scrollLeft += self._headSlot.scrollLeft;
						self._headSlot.scrollLeft = 0;
					}
					return false;
				}
			});
		} else {
			if (self._$$hscroller) {
				self._$$hscroller.unbind();
			}
			if (self._$$bodySlot) {
				self._$$bodySlot.unbind();
			}
			if (self._$$headSlot) {
				self._$$headSlot.unbind();
			}
		}
	},
	_scrollCols: function(left) {
		// in order to scroll column per column
		var self = this;
		clearTimeout(self._scrollColsTimeout);
		self._scrollColsTimeout = setTimeout(function() {
			var cols = self.list.orderCols;
			var colToScroll;
			for (var ii = self.firstScrollableColIndex; ii <= self.lastColIndex; ii++) {
				// if scrollWidthValue is not set, no scrolling has been done yet (cols[ii] will thus be the 1st column from which to scroll) 
				if (cols[ii].scrollWidthValue == undefined) {
					colToScroll = cols[ii];
					break;
				} else {
					// once scrolling has already been done, scrollWidthValue is either == 0 or > 0
					// scrollWidthValue == 0 for scrolled columns. First column with scrollWidthValue > 0 is to consider for scrolling 
					if (cols[ii].scrollWidthValue != 0) {
						colToScroll = cols[ii];
						break;
					}
				}
			}
			// calculating scroll offset
			// if scrollWidthValue is undefined, colToScroll is the first scrollable column. Offset corresponds to the column width.
			// if scrollWidthValue is defined, offset depends whether scroll is going left or right.
			// if scroll goes to left, then offset value depends on whether column is halfed scrolled (colToScroll.scrollWidthValue != colToScroll.realWidth) or not scrolled at all (colToScroll.scrollWidthValue == colToScroll.realWidth).
			// if scroll goes to right, offset corresponds to column scrollWidthValue  
			var offset = colToScroll.scrollWidthValue == undefined ? colToScroll.realWidth : (left ? (colToScroll.scrollWidthValue == colToScroll.realWidth ? (ii - 1 >= self.firstScrollableColIndex ? cols[ii - 1].realWidth : colToScroll.scrollWidthValue) : colToScroll.realWidth - colToScroll.scrollWidthValue) : colToScroll.scrollWidthValue);
			self._hscroller.scrollLeft = left ? self._hscroller.scrollLeft - offset : self._hscroller.scrollLeft + offset;
		}, 20);
	},
	_bindButton: function(btn, left) {
		var self = this;
		$(btn).bind("click", function() {
			self._scrollCols(left);
		}).bind("mousedown", function() {
			if (left) {
				self._leftBtnTimeout = setInterval(function() {
					if (self._hscroller) {
						self._scrollCols(true);
					}
				}, 100);
			} else {
				self._rightBtnTimeout = setInterval(function() {
					if (self._hscroller) {
						self._scrollCols(false);
					}
				}, 100);
			}
		}).bind("mouseup mouseout", function() {
			clearInterval(left ? self._leftBtnTimeout : self._rightBtnTimeout);
		});
	},
	_appendButtons: function() {
		if (this.list.isScrollButtonEnabled !== false && !this.list.treeDecorator) {
			if (this.list.records.length > 20) {
				if (!this.leftBtn) {
					this.leftBtn = document.createElement("a");
					this.leftBtn.className = "s-list-btn-scroll-left";
					this._bindButton(this.list._core.appendChild(this.leftBtn), true);
					this.rightBtn = document.createElement("a");
					this.rightBtn.className = "s-list-btn-scroll-right";
					this._bindButton(this.list._core.appendChild(this.rightBtn));
					if (this.list.page && this.list.page.addScrollViewListener) {
						this.list.page.addScrollViewListener(this.list.id, this._updateButtonsPosition);
					}
				}
				this._updateButtonsPosition(this);
			} else {
				if (this.leftBtn) {
					this.leftBtn.style.display = this.rightBtn.style.display = "none";
				}
			}
		}
	},
	_updateButtonsPosition: function(scroller) {
		if (scroller.leftBtn) {
			var listRect = scroller.list.domValueSlot.getBoundingClientRect();
			var scrollRect = scroller.list.page.scrollview.getBoundingClientRect();
			var display = "none";
			if (!(listRect.top > scrollRect.top && listRect.bottom < scrollRect.bottom)) {
				var bottom = (listRect.bottom < scrollRect.bottom) ? listRect.bottom : scrollRect.bottom;
				var top;
				if (listRect.top > scrollRect.top) {
					top = (bottom - listRect.top) / 2;
				} else {
					top = Math.abs(listRect.top) + ((bottom - scrollRect.top) / 2);
				}
				scroller.leftBtn.style.top = scroller.rightBtn.style.top = top + "px";
				display = "";
			}
			scroller.leftBtn.style.display = scroller.rightBtn.style.display = display;
		}
	},
	dispose: function() {
		if (this.leftBtn) {
			if (this.list.page && this.list.page.removeScrollViewListener) {
				this.list.page.removeScrollViewListener(this.list.id);
			}
			$(this.leftBtn).unbind();
			$(this.rightBtn).unbind();
			this.leftBtn = this.rightBtn = null;
		}
		this._headerCorner = this.list = this._headSlot = this.bodySlot = this._hscroller = this._$$headSlot = this._$$hscroller = this._$$bodySlot = this._hscrollBody = this._scrollColsTimeout = null;
	}
});