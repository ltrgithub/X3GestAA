"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;
var flashWrapper = require("./flashWrapper").flashWrapper;
var syraUtil = require('syracuse-ui/lib/fusion/core/client/sap/util').Syra;

var debug = false;

function _debugSyraTrans() {
    document.syraTrans = document.syraTrans || {};
    document.syraTrans.logSwitches = {
        all: true
    };
}

function RecordArticle() {}

exports.RecordArticle = helpers.defineClass(RecordArticle, Article, {
    drawBox: function() {
        this.page.loadNewItem($("<div style='display:none'/>").appendTo(this.boxParent.$$container), {
            $category: "links"
        }, this);
    },
});


function FlashWidget() {}

exports.FlashWidget = helpers.defineClass(FlashWidget, Article, {
    _executeRecordMenu: function(context) {
        if (!this.recordArticle) {
            this.recordArticle = new RecordArticle();
            this.recordArticle.$prototype = this.$prototype.$item;
            this.page.initializeNewItem(this.recordArticle, {}, this);
            this.recordArticle.loadBox(context.$item);
        } else {
            this.recordArticle.applyChange(context.$item);
        }
        var $links = context["$links" || "$actions"];
        if ($links) this.recordArticle.menuItems[Object.keys($links)[0]][0].click();
    },
    fxgetinitialdata: function(callback, myData) {
        callback(null, null, this.$prototype);
        this._protoUpToDate = true;
    },
    fxgetctxmenu: function(callback, myData, serieId) {
        document.site.onBeforClick();
        if (!this.attachedField.$isDisabled) {
            this.page.externalAdapter.onGraphClickPicker({
                field: this,
                rcdUuid: serieId,
                pickerType: "menus",
                grapLevel: "measure",
                doEvent: function(err, menus) {
                    var errEx = null;
                    if (!menus && !err) {
                        // TODO : default error
                        errEx = [{
                            "message": "not yet implemented",
                            "severity": "warning"
                        }];
                    }
                    callback(errEx || err, menus);
                }
            });
        }
    },
    fxexeclink: function(callback, myData, link, options) {
        var data = {
            field: this,
            link: link
        };

        function _result(res) {
            debug && console.log("FlashWidget.fxexeclink._reply");
            var err = !res ? {
                "message": "Error"
            } : res.$diagnoses || null;
            // No reply is expected
            callback(err, null);
        }
        if (options && options.legacy) {
            debug && _debugSyraTrans();

            var args = link.linkCtx.split("=");
            // LINKVUE = SUBAPSMON:LINKVUE(FONCTION,OBJET,PARAM)
            this.page.externalAdapter.onBlockExRpc({
                field: this.attachedField,
                call: {
                    proxy: "LINKVUE",
                    values: [args[0].split(",")[0], args[1].substr(0, 3), args[2]],
                    callback: _result
                }
            });

        } else if (this.page.externalAdapter.onGraphClickLink(data)) {
            this._executeRecordMenu(link);
        }
    },
    fxexecdrill: function(callback, myData, drillParams) {
        delete this._protoUpToDate;
        this.fetch({
            jsonParams: {
                $axes: drillParams.$axes,
                $slicer: drillParams.$slicer
            }
        });
    },
    fxnamedsvccall: function(callback, myData, svcParams) {
        alert("Hi, i'm \"" + myData.id + "\" and y should process named service \"" + svcParams.svcId + "\"");
        callback(null, null);
    },

    fxspro: function(callback, myData, request) {
        var self = this;
        debug && console.log("FlashWidget.fxspro: request=" + request);

        function _result(res) {
            debug && console.log("FlashWidget.fxspro._reply");
            // AINTERFL:AINTERFL(CLOBD,MESSAG,GRAV,OK)
            var err = !res ? {
                "message": "Error"
            } : res.$diagnoses || null,
                reply = {};
            if (res) {
                // reply.data = self.currentValue;
                reply.data = self.wrapper.rawData;
                reply.args = {
                    clob: res.argsModified[0],
                    message: res.argsModified[1],
                    grav: res.argsModified[2],
                    ok: res.argsModified[3]
                }
            }
            callback(err, reply);
        }

        debug && _debugSyraTrans();

        this.page.externalAdapter.onBlockExRpc({
            field: this.attachedField,
            call: {
                proxy: "AINTERFL",
                values: [request],
                callback: _result
            }
        });
    },

    drawBox: function() {
        this.wrapper = this._createWrapper();
        this.$$item = this.wrapper.$$elt;
        this.getArticleParent().bind(this, this.$item.$bind);
    },

    setDataBind: function(value, record, metaData) {
        var valueEx = null,
            type;
        debug && console.log("FlashWidget.setDataBind: value=" + value);
        this.currentValue = value;
        if (value && this.wrapper) {
            type = this.attachedField ? syraUtil.getFieldType(this.attachedField) : null;
            valueEx = type && type == syraUtil.dataTypes.collectionType && this.attachedField.dataset && Array.isArray(this.attachedField.dataset) && this.attachedField.dataset.length > 0 ? this.attachedField.dataset : null;
            this.wrapper.setData(valueEx || value, this._protoUpToDate ? null : this.$prototype, metaData);
            this._protoUpToDate = true;
        }
    },
    dispose: function() {
        delete this.$$item;
        delete this.wrapper;
    },
    applyDesignMetaData: function(metadata, onAuthoring) {
        //
    },
    _createWrapper: function(componentType) {
        var id = this.id + "_flash",
            proto = this.$prototype,
            $fusionController = syraUtil.getFusionController(this);
        return new flashWrapper(componentType, {
            cont: this.$$container,
            id: id,
            swf: "/syracuse-ui/addins/sageFlash/swf/FLASH",
            base: ".",
            bgcolor: "#FFFFFF",
            width: "100%",
            height: "100%"
        }, {
            instance: this,
            id: id
        }, {
            dataBinding: this.$item.$bind,
            legacyRequest: ($fusionController != null),
            legacyLinks: ($fusionController != null),
            userLang: $fusionController && $fusionController.getLang()
        });
    },
    getEnumeration: function(code) {
        var $fusionController = syraUtil.getFusionController(this),
            fusionSess = $fusionController ? $fusionController.getSession() : null;
        return fusionSess && code ? fusionSess.getMenloc(code) : null;
    },
    // for compatibility : TODO remove later
    getLocalMenu: function(code) {
        return this.getEnumeration(code);
    }
});

function CubeChart() {}

exports.CubeChart = helpers.defineClass(CubeChart, FlashWidget, {});