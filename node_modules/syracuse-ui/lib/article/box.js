"use strict";
var helpers = require('syracuse-core/lib/helpers');

var locale = require('syracuse-core/lib/locale');
var boxHelper = require('./boxHelper');

function Box(){
}

exports.Box = helpers.defineClass(Box, null, {
    getDefaultTitle: function(){
        if (!this.localize) {
            this.localize = locale.resources(module)();
        }
        return this.localize["box_" + this.$authoringLevel + "Title"];
    },
    applyDesignMetaData: function(metaData, onAuthoring){
        this.setState(metaData);
        
        if (metaData.$isTitleHidden !== undefined) {
            this.$item.$isTitleHidden = metaData.$isTitleHidden;
            if (!this._tabTitle) {
                this._header.style.display = metaData.$isTitleHidden ? "none" : "";
            }
        }
        if (metaData.$isBoxCollapsable !== undefined) {
            this.setCollapsable(this.$item.$isBoxCollapsable = metaData.$isBoxCollapsable);
        }
        if (metaData.$isRefreshable !== undefined) {
            boxHelper.togglePicker(this, "refresh", this.$item.$isRefreshable = metaData.$isRefreshable);
        }
        if (metaData.$isMaximizable !== undefined) {
            boxHelper.togglePicker(this, "maximize", this.$item.$isMaximizable = metaData.$isMaximizable);
        }
        
        if (onAuthoring !== false) {
            if (metaData.$title !== undefined) {
                this.setTitle(this.$item.$title = metaData.$title);
            }
            if (metaData.$fieldsIsTopLabelAlignment !== undefined) {
                this.$item.$fieldsIsTopLabelAlignment = metaData.$fieldsIsTopLabelAlignment;
            }
            if (metaData.$fieldsIsRightTextLabelAlignment !== undefined) {
                this.$item.$fieldsIsRightTextLabelAlignment = metaData.$fieldsIsRightTextLabelAlignment;
            }
            if (metaData.$field !== undefined) {
                this.$item.$field = this.$item.$field || {};
                var $props = Object.keys(metaData.$field);
                for (var ii = 0, jj = $props.length; ii < jj; ii++) {
                    var $prop = $props[ii];
                    this.$item.$field[$prop] = metaData.$field[$prop];
                }
            }
        }
    },
    setCollapsable: function($isBoxCollapsable){
        boxHelper.setCollapsable(this, $isBoxCollapsable);
    },
    _loadChildItem: function(item, layoutParent, $$container){
    
    },
    getArticle: function(){
        return this.boxParent ? this.boxParent.getArticle() : null;
    },
    loadBox: function(){
        this.drawBox();
    },
    getTitle: function(){
        var title = this._textTitle.textContent || this.$item.$title || "";
        if (title.trim() == "") {
            title = this.getDefaultTitle();
        }
        return title;
    },
    setTitle: function(title){
        if (this.domTitle) {
            if (title) {
                this.domTitle.style.display = "";
                if (title == "-") {
                    title = "";
                }
                if (title.indexOf("{") < 0) {
                    this._textTitle.textContent = title;
                    if (this._tabTitle) {
                        this._tabTitle.textContent = title;
                        this._tabTitle.setAttribute("title", title);
                    }
                    this.domTitle.setAttribute("title", title);
                }
                else {
                    this._renderExpression(title, $(this._textTitle).empty(), this.$skin + "-title-field", false);
                }
            }
            else {
                this.domTitle.style.display = "none";
                if (this._tabTitle) {
                    this._tabTitle.textContent = title = this.getDefaultTitle();
                    this._tabTitle.setAttribute("title", title);
                }
            }
            if (!this._tabTitle) {
                this._header.style.display = (title != null) && !this.$item.$isTitleHidden ? "" : "none";
            }
        }
    },
    _setTitleIcon: function(){
        this._iconTitle = document.createElement("div");
        this._iconTitle.className = this.$skin + "-title-icon";
        this.domTitle.appendChild(this._iconTitle);
        if (this.$item.$titleIcon.$cssName) {
            this._iconTitle.className += " " + this.$item.$titleIcon.$cssValue;
        }
        else {
            var $path = document.site.$item.$iconPath + (this.$item.$titleIcon.$path || "");
            this._iconTitle.style.backgroundImage = "url('" + $path + this.$item.$titleIcon.$value + ".png')";
        }
        this._textTitle = document.createElement("div");
        this._textTitle.className = this.$skin + "-title-text s-icon";
        this.domTitle.appendChild(this._textTitle);
    },
    _createBoxTitle: function(){
        this._textTitle = this.domTitle = this.domTitle || document.createElement("a");
        this.domTitle.style.display = "none";
        this.domTitle.className = this.$skin + "-title";
        this.domTitle.setAttribute("data-s-box", this.id);
        if (this.$item.$titleIcon) {
            this._setTitleIcon();
            if (this.$item.$titleIcon.$mode === "icon") {
                this.domTitle.style.display = "";
            }
        }
        return this.domTitle;
    },
    setDescription: function($description){
        if ($description) {
            if (!this.domDescription) {
                this.domDescription = document.createElement("div");
                this.domDescription.className = this.$skin + "-description";
                this._header.appendChild(this.domDescription);
            }
            if ($description.indexOf("{") < 0) {
                this.domDescription.textContent = $description;
                if (this._tabTitle) {
                    this._tabTitle.title = $description; //to improve manage expression
                }
            }
            else {
                this._renderExpression($description, $(this.domDescription), this.$skin + "-description-field", false);
            }
        }
    },
    ensureSkin: function(){
        this.$skin = this.$skin || this.$item.$skin;
    },
    drawBox: function(){
        this.ensureSkin();
        this._item = document.createElement("div");
        this.$$item = $(this._item = document.createElement("div"));
        if (this.$item.$expression) {
            if (this.$item.$css) {
                this._item.className = this.$item.$css;
            }
            this.$$container[0].appendChild(this._item);
            this.$isEditMode = this.getArticle().$isEditMode;
            this._renderExpression(this.$item.$expression, this.$$item);
        }
        else {
            this.$$body = $(this._body = document.createElement("div"));
            this._body.style.display = "none";
            this.appendHeader();
            this.ensureLayoutMode();
            if (this.$item.$width) {
                this._item.style.width = this.$item.$width;
            }
            this._item.appendChild(this._body);
            if (this.$$container) {
                this.$$container[0].appendChild(this._item);
            }
            this.setDescription(this.$item.$description);
            if (this.$item.$isPopupContent) {
                this.$item.$opened = false
                this._body.className += " s-box-popup";
            }
            this.applyDesignMetaData(this.$item, false);
            
            this.openBox(!this._tabTitle && this.$item.$opened !== false);
            if (!this.loaded && this.page.$facet == "$edit") {
                this._renderLayoutContent();
                this.loaded = true;
            }
        }
    },
    appendHeader: function(){
        this._header = document.createElement("header");
        this._header.className = this.$skin + "-head";
        if (this.$item.$style) {
            this._header.className += " s-cst-sty-" + this.$item.$style;
        }
        this._header.style.display = "none";
        this._header.appendChild(this._createBoxTitle());
        //this.$$item.prepend(this._header);
        this._item.appendChild(this._header);
        this.setTitle(this.$item.$title || (this.$field ? this.$field.$title : null));
    },
    doPicker: function(pickerId, callback){
        boxHelper.doPicker(this, pickerId, callback);
    },
    doOpenPicker: function(){
        var self = this;
        self.openBox(self.$opened);
        if (self.$item.$isPopupContent) {
            if (!self._popupMenus) {
                self._popupMenus = self.openDialog({
                    $dialogMode: "popup",
                    content: self,
                    $$dialog: self.$$body,
                    position: {
                        my: "right top",
                        at: "right bottom",
                        of: $(self.domTitle)
                    },
                    onClose: function(){
                        if (self.domTitle) {
                            document.site.toggleClass(self.domTitle, "s-close", true);
                        }
                        self._popupMenus = null;
                    }
                });
            }
            else {
                self._popupMenus.close();
            }
        }
    },
    _renderLayoutContent: function(){
        this.layoutContent = this.page.createNewLayout(this.$item.$layout, this);
        this.layoutContent.$$container = this.$$body;
        this.layoutContent.render();
    },
    _renderExpression: function(expression, $$container, $fieldCss, $isEditMode){
        return boxHelper.renderExpression(this, expression, $$container, $fieldCss, $isEditMode);
    },
    _applyDiagnoseState: function(){
        if (this.boxDiagnose && this.boxDiagnose.diagClassName && this._tabTitle) {
            document.site.toggleClass(this._tabTitle, this.boxDiagnose.diagClassName, true);
        }
    },
    openBox: function(open){
        if (open && !this.loaded) {
            this._renderLayoutContent();
            this.loaded = true;
        }
        if (this._tabTitle) {
            if (open) {
                if (this.layoutParent.tabOpened !== undefined) {
                    this.layoutParent.tabOpened.openBox(false);
                }
                this.layoutParent.tabOpened = this;
                this.$item.$opened = true;
            }
            else {
                delete this.$item.$opened;
            }
            document.site.toggleClass(this._tabTitle, "s-tab-open", open);
            
            this._item.style.display = open ? "" : "none";
        }
        if (this.$item.$isBoxCollapsable) {
            document.site.toggleClass(this.domTitle, "s-close", !open);
        }
        this._applyDiagnoseState();
        this._body.style.display = open ? "" : "none";
        if (this.$item.onOpen) {
            this.$item.onOpen(this);
        }
    },
    ensureLayoutMode: function(){
        this.ensureSkin();
        var $style;
        if (this.$item.$style) {
            $style = " s-cst-sty-" + this.$item.$style;
        }
        if (this.$isTabLayout) {
            if (!this._tabTitle) {
                boxHelper.appendTabTitle(this);
                this._header.style.display = "none";
            }
            this._item.className = this.$skin + "-tab-box";
            this._body.className = this.$skin + "-tab-body";
            if (this.$item.$opened) {
                document.site.toggleClass(this._tabTitle, "s-tab-open", true);
                //this._body.style.display = "none";	
            }
            else {
                document.site.toggleClass(this._tabTitle, "s-tab-open", false);
                this._body.style.display = "none";
            }
            if ($style) {
                this._item.className += $style;
                this._body.className += $style;
                this._tabTitle.className += $style;
            }
        }
        else {
            if (this._tabTitle) {
                delete this._tabTitle;
                this._header.style.display = "";
                this._item.style.display = "";
                this._body.style.display = "";
            }
            this._item.className = this.$skin;
            this._header.className = this.$skin + "-head";
            this.domTitle.className = this.$skin + "-title";
            this._body.className = this.$skin + "-body";
            if (this.$item.$css) {
                var $css = " " + this.$item.$css;
                this._item.className += $css;
                this._body.className += $css;
                this._header.className += $css;
                if (this.domTitle) {
                    this.domTitle.className += $css;
                }
                
            }
            if ($style) {
                this._item.className += $style;
                this._header.className += $style;
                this.domTitle.className += $style;
                this._body.className += $style;
            }
            if (this.$item.$slotStyle && this.$$container) {
                this.$$container[0].className += " " + this.$item.$slotStyle;
            }
        }
        if (this.page.authoringPage) {
            this.page.authoringPage.toggleItemAuthoring(this, true);
        }
    },
    setState: function(state){
        if (state.$isHidden !== undefined) {
            var display = (this.$item.$isHidden = state.$isHidden) ? "none" : "";
            this._item.style.display = display;
            if (this._tabTitle) {
                this._tabTitle.style.display = display;
            }
        }
    },
    openDialog: function(options){
        options.boxParent = this;
        var dialog = document.site.openDialog(options);
        if (!this._dialogs) {
            this._dialogs = [];
        }
        this._dialogs.push(dialog);
        return dialog;
    },
    closeDialog: function(dialog){
        if (this._dialogs) {
            for (var ii = 0, jj = this._dialogs.length; ii < jj; ii++) {
                if (this._dialogs[ii] == dialog) {
                    this._dialogs.splice(ii, 1);
                    break;
                }
            }
        }
    },
    closeDialogs: function(dispose){
        if (this._dialogs) {
            for (var ii = 0, jj = this._dialogs.length; ii < jj; ii++) {
                this._dialogs[ii].close(undefined, dispose);
                this._dialogs[ii] = null;
            }
            this._dialogs = null;
        }
    },
    dispose: function(){
        if (this.boxDiagnose) {
            this.boxDiagnose.dispose();
            delete this.boxDiagnose;
        }
        if (this.articleDiagnose) {
            this.articleDiagnose.dispose();
            delete this.articleDiagnose;
        }
        this.closeDialogs();
        this.localize = this._item = this.$$item = this._body = this.$$body = this._header = null;
        this._tabTitle = this.domTitle = this.domDescription = this._textTitle = this._iconTitle = null;
        this.page = null;
    }
});

