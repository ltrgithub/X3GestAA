"use strict";
var helpers = require('syracuse-core/lib/helpers');
function Datasource(){
}

exports.Datasource = helpers.defineClass(Datasource, null, {
    applyArrayDelta: function(targetList, sourceList){
        if (sourceList) {
            var self = this;
            var targetMap = {};
            if (sourceList.length == 1 || self.page.$isFullDelta) {
                sourceList.forEach(function(sourceRecord){
                    var found, foundIndex;
                    targetList.some(function(record, index){
                        if (record.$uuid == sourceRecord.$uuid) {
                            found = record;
                            foundIndex = index;
                            return true;
                        }
                        return false;
                    });
                    debugger;
                    if (found) {
                        self.applyObjectDelta(found, sourceRecord);
                        if (sourceRecord.$index !== undefined && sourceRecord.$index != foundIndex) {
                            targetList.splice(foundIndex, 1);
                            targetList.splice(sourceRecord.$index, 0, found);
                            delete found.$index;
                        }
                    }
                    else {
                        if (sourceRecord.$index !== undefined) {
                            targetList.splice(sourceRecord.$index, 0, sourceRecord);
                            if (!self.page.$isFullDelta) {
                                delete sourceRecord.$index;
                            }
                        }
                        else {
                            targetList.push(sourceRecord);
                        }
                        
                    }
                });
            }
            else {
                targetList.forEach(function(record){
                    targetMap[record.$uuid] = record;
                });
                targetList = sourceList.filter(function(record){
                    return !record.$isDeleted;
                }).map(function(record){
                    if (targetMap[record.$uuid]) {
                        return self.applyObjectDelta(targetMap[record.$uuid], record);
                    }
                    return record;
                });
            }
            
        }
        return targetList;
    },
    applyObjectDelta: function(target, source){
        if (source) {
            var self = this;
            Object.keys(source).forEach(function(property){
                var targetValue = target[property];
                var sourceValue = source[property];
                if (typeof(sourceValue) == 'object') {
                    if (!(targetValue == null || sourceValue === null)) {
                        if (Array.isArray(sourceValue)) {
                            if (self.page.isDeltaMode || self.page.$isFullDelta) {
                                sourceValue = self.applyArrayDelta(targetValue, sourceValue);
                            }
                        }
                        else {
                            sourceValue = self.applyObjectDelta(targetValue, sourceValue);
                        }
                    }
                }
                target[property] = sourceValue;
            });
        }
        return target;
    }
});
