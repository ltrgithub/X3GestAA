"use strict";
var helpers = require('syracuse-core/lib/helpers');

function Layout() {}

exports.Layout = helpers.defineClass(Layout, null, {
	create: function($layout, boxParent) {
		this.boxParent = boxParent;
		this.articleParent = boxParent.getArticle();
		this.page = this.boxParent.page;
		this.$designLevel = "layout";
		this.id = this.boxParent.id + "-" + (++this.page._childItemOffset);
		this.articleParent.layouts[this.id] = this;
		this.isLayout = true;
		this.$item = this.$layout = $layout;
		if (!$layout.$items) {
			$layout.$items = [];
		}
		if (!this.$layout.$layoutType) {
			this.$layout.$layoutType = "stack";
			this.$layout.$widths = "100";
		} else {
			if (this.$layout.$layoutType == "side") {
				this.$layout.$layoutType = "row";
				this.$layout.$autoSize = true;
			}
			if (this.$layout.$layoutType == "columns") {
				this.$layout.$layoutType = "row";
			}
			if (this.$layout.$layoutSubType) {
				this.$layout.$widths = this.$layout.$layoutSubType;
			}
		}
		this.isRow = this.$layout.$layoutType == "row";
	},
	getTitle: function() {
		return "";
	},
	applyDesignMetaData: function(metaData, designing) {
		if (designing !== false) {
			if (metaData.$fieldsIsTopLabelAlignment !== undefined) {
				this.$item.$fieldsIsTopLabelAlignment = metaData.$fieldsIsTopLabelAlignment;
			}
			if (metaData.$fieldsIsRightTextLabelAlignment !== undefined) {
				this.$item.$fieldsIsRightTextLabelAlignment = metaData.$fieldsIsRightTextLabelAlignment;
			}
			if (metaData.$field !== undefined) {
				this.$item.$field = this.$item.$field || {};
				var $props = Object.keys(metaData.$field);
				for (var ii = 0, jj = $props.length; ii < jj; ii++) {
					var $prop = $props[ii];
					this.$item.$field[$prop] = metaData.$field[$prop];
				}
			}
		}
	},
	ensureSection: function(item, index) {
		var layoutParent = this;
		if (!item.isSection) {
			layoutParent = this.loadChildItem(null, {
				$category: "section",
				$layout: {
					$items: []
				}
			}, index).layoutContent;
			index = undefined;
		}
		layoutParent.loadChildItem(item, null, index);
		return item;
	},
	loadChildItem: function(childItem, $childItem, index) {
		if (childItem) {
			return this.appendChildItem(childItem, index, false);
		}
		return this.createChildItem($childItem, null, index);
	},
	appendChildItem: function(item, index, load) {
		if (item.layoutParent) {
			item.layoutParent.extractItem(item, true);
		}
		item.layoutParent = this;
		item.boxParent = this.boxParent;
		this.page.registerBoxField(item);

		var append;
		if (!item.layoutSlot) {
			item.layoutSlot = document.createElement("div");
		}
		item.isTabLayout = this.$layout.$layoutType == "tabs";
		if (index === undefined) {
			if (this.isItemRegisterDisable == false) {
				this.$layout.$items.push(item.$item);
			}
			this.items.push(item);
			this.domItem.appendChild(item.layoutSlot);
		} else {
			if (this.isItemRegisterDisable == false) {
				this.$layout.$items.splice(index, 0, item.$item);
			}
			this.items.splice(index, 0, item);
			var sibling = this.items[index + 1];
			if (sibling) {
				sibling.layoutSlot.parentNode.insertBefore(item.layoutSlot, sibling.layoutSlot);
			} else {
				if (item.isTabLayout) {
					append = true;
				}
				this.domItem.appendChild(item.layoutSlot);
			}
		}
		if (this.$layout.$layoutType == "row") {
			if (this.$layout.$valign) {
				item.layoutSlot.style.verticalAlign = this.$layout.$valign;
			}
		}
		item.ensureLayoutMode();
		if (item.$newAddItem) {
			load = true;
			delete item.$newAddItem;
		}
		if (load) {
			if (item.isReloading) {
				item.applyDesignMetaData(item.$item, true);
				delete item.isReloading;
			} else {
				item.loadBox();
			}
		}
		if (item.isTabLayout) {
			if (sibling && sibling.tabTitle && item.tabTitle) {
				sibling.tabTitle.parentNode.insertBefore(item.tabTitle, sibling.tabTitle);
			} else {
				if (append) {
					this._tabs.appendChild(item.tabTitle);
				}
			}
		}
		return item;
	},
	createChildItem: function($item, item, index) {
		item = this.page.createNewItem($item, this.boxParent, item);
		if (item) {
			this.appendChildItem(item, index, true);
		}
		return item;
	},
	extractItem: function(item, addSpaceBox) {
		var index = this.items.indexOf(item);
		if (index >= 0) {
			this.items.splice(index, 1);
		}
		index = this.$layout.$items.indexOf(item.$item);
		if (index >= 0) {
			this.$layout.$items.splice(index, 1);
		}
		if (addSpaceBox && this.isRow) {
			this.addSpaceBox(index);
		}
		if (item.isTabLayout && item.tabTitle) {
			document.site.removeDomChild(item.tabTitle);
			item.isTabTitleRemoved = true;
		}
		if (this.isRow && item.layoutSlot) {
			item.layoutSlot.style.width = "";
		}
		item.layoutParent = null;
		if (item.boxParent && item.boxParent.boxChildItems) {
			delete item.boxParent.boxChildItems[item.id];
		}
		if (item.isSection) {
			item.page.unregisterSectionBlock(item);
		}
		return item;
	},
	extractItems: function(children, addSpaceBox) {
		children = (children || this.getItems()) || [];
		for (var ii = 0, jj = children.length; ii < jj; ii++) {
			if (!children[ii].isSpaceBox) {
				children[ii].layoutParent.extractItem(children[ii], addSpaceBox);
			}
		}
		return children;
	},
	removeItem: function(item, removeSlot, addSpaceBox) {
		this.extractItem(item, addSpaceBox);
		if (removeSlot && item.layoutSlot) {
			document.site.removeDomChild(item.layoutSlot);
		}
		if (item.rowSeparator) {
			this.page.layoutValidator.removeRowSeparator(item);
		}
		this.articleParent.removeItem(item, true);
	},
	addSpaceBox: function(index) {
		return this.createChildItem({
			$category: "space"
		}, null, index);
	},
	removeSpaceBox: function(all) {
		var spaces = [];
		for (var ii = 0, jj = this.items.length; ii < jj; ii++) {
			if (this.items[ii].isSpaceBox) {
				spaces.push(this.items[ii]);
			}
		}
		if (!all && spaces.length == this.items.length) {
			spaces.shift();
		}
		for (var ii = 0, jj = spaces.length; ii < jj; ii++) {
			this.removeItem(spaces[ii], true);
		}
	},
	ensureLayoutSlot: function(item) {
		if (item.$skin) {
			item.layoutSlot.className = (item.isField ? (item.$skinSlot || "s-field") : item.$skin) + "-slot s-slot-" + this.$layout.$layoutType;
		} else {
			item.layoutSlot.className = "s-slot-" + this.$layout.$layoutType;
			if (this.boxParent) {
				item.layoutSlot.className += " " + this.boxParent.$skin + "-layout-parent";
			}
		}
		if (item.$item.$layoutCss) {
			item.layoutSlot.className += " " + item.$item.$layoutCss;
		}
	},
	ensureLayoutMode: function() {
		if (this.layoutParent) {
			this.layoutParent.ensureLayoutSlot(this);
		}
		if (!this.domItem) {
			this.domItem = document.createElement("div");
			this.domItem.syraAwLayoutId = this.id;
			this.layoutSlot.appendChild(this.domItem);
			this.$$item = $(this.domItem);
		}
		var css = "s-layout-" + this.$layout.$layoutType;
		if (this.boxParent.$skin) {
			css = this.boxParent.$skin + "-layout " + css;
		}
		if (this.$item.$css) {
			css += " " + this.$item.$css;
		}
		this.domItem.className = css;
		this.isRow = this.$layout.$layoutType == "row";
	},
	loadChildItems: function(items, index) {
		if (this.isRow && index != undefined) {
			var lastItem = this.items[index];
			if (!lastItem && items.length > 1) {
				this.wrapIntack(items, index);
				return;
			} else {
				if (lastItem && !lastItem.isLayout) {
					this.wrapIntack([lastItem], index).loadChildItems(items);
					return;
				}
			}
		}
		for (var ii = 0, jj = items.length; ii < jj; ii++) {
			var item = items[ii];
			this.loadChildItem(item, null, index);
		}
	},
	wrapIntack: function(items, index) {
		var children = this.extractItems(items);
		var stack = this.loadChildItem(null, {
			$layoutType: "stack",
			$items: []
		}, index);
		stack.newLoadChildItems(children);
		return stack;
	},
	loadBox: function() {
		this.ensureLayoutMode();
		this.items = [];
		this.isItemRegisterDisable = true;
		for (var ii = 0, jj = this.$layout.$items.length; ii < jj; ii++) {
			this.createChildItem(this.$layout.$items[ii]);
		}
		this.isItemRegisterDisable = false;
		//this.page.layoutValidator.validate(this, true);
	},
	appendTab: function(box) {
		if (!this._tabs) {
			this._tabs = document.createElement("div");
			this._tabs.className = box.$skin + "-tabs-nav";
			$(this.domItem).prepend(this._tabs);
		}
		this._tabs.appendChild(box.tabTitle);
	},
	ensureItemVisibility: function(item, $isHidden) {
		var display = (!item.isAuthingEnabled && (!this.isRow && ($isHidden || item.$isHidden || item.isInvisible || item.isItemHidden))) ? "none" : "";
		if (item.layoutSlot) {
			item.layoutSlot.style.display = display;
		}
		if (item.rowSeparator) {
			item.rowSeparator.style.display = display;
		}
	},
	ensureContentIsLoaded: function() {
		for (var ii = 0, jj = this.items.length; ii < jj; ii++) {
			var item = this.items[ii];
			if (item.isLayout) {
				item.ensureContentIsLoaded();
			} else {
				if (!item.isLayout && item.isSection && !item.loaded) {
					item.renderLayoutContent();
					item.loaded = true;
				}
				if (item.layoutContent) {
					item.layoutContent.ensureContentIsLoaded();
				}
			}
		}
	},
	getFields: function() {
		return this.getItems("field");
	},
	getItems: function($designLevel, children) {
		if (!children) {
			children = [];
		}
		for (var ii = 0, jj = this.items.length; ii < jj; ii++) {
			var item = this.items[ii];
			if (item != this.boxParent && !item.isSpaceBox) {
				if (item.isLayout || ($designLevel && item.layoutContent)) {
					children = (item.isLayout ? item : item.layoutContent).getItems($designLevel, children);
				} else {
					if (!$designLevel || ($designLevel == item.$designLevel)) {
						children.push(item);
					}
				}
			}
		}
		return children;
	},
	getChildren: function() {
		var children = [];
		for (var ii = 0, jj = this.items.length; ii < jj; ii++) {
			children.push(this.items[ii]);
		}
		return children;
	},
	clearContent: function() {
		if (this._tabs) {
			document.site.removeDomChild(this._tabs);
			delete this._tabs;
		}
		while (this.items.length > 0) {
			var item = this.items[0];
			if (item.isLayout) {
				item.clearContent();
			} else {
				if (item.layoutContent) {
					item.layoutContent.clearContent();
				}
			}
			this.removeItem(item, true);
		}
	},
	convertToNewLayout: function($newLayout) {
		var children = this.getChildren();
		this.extractItems(children); //, true);
		//Clear space old layout
		this.clearContent();

		var newChildren = [];
		if (children) {
			for (var ii = 0, jj = children.length; ii < jj; ii++) {
				var child = children[ii];
				if (child && child.articleParent && !child.disposed) {
					newChildren.push(child);
				}
			}
		}
		children = newChildren;
		delete this.$layout.$autoSize;
		delete this.$layout.$widths;
		this.$layout.$autoSize = $newLayout.$autoSize;
		this.$layout.$widths = $newLayout.$widths;
		this.$layout.$layoutType = $newLayout.$layoutType;
		this.ensureLayoutMode();
		var obsoleteLayouts = [];
		if (this.isRow) {
			var widths = this.getWidthValues();
			if (children.length <= widths.length) {
				this.newLoadChildItems(children); //fill rows
			} else {
				for (var ii = 0, jj = widths.length - 1; ii < jj; ii++) {
					this.loadChildItem(children.shift());
				}
				this.loadChildItem(null, {
					$layoutType: "stack",
					$items: []
				}).newLoadChildItems(this.clearRootStackChildren(children, obsoleteLayouts)); //fill first row
			}
		} else {
			this.newLoadChildItems(this.clearRootStackChildren(children, obsoleteLayouts));
		}
		for (var ii = 0, jj = obsoleteLayouts.length; ii < jj; ii++) {
			this.removeItem(obsoleteLayouts[ii], true);
		}
	},
	clearRootStackChildren: function(children, obsoleteLayouts) {
		var newChildren = [];
		if (children) {
			for (var ii = 0, jj = children.length; ii < jj; ii++) {
				var child = children[ii];
				if (child && child.isLayout && child.$item.$layoutType == "stack") {
					newChildren = newChildren.concat(child.extractItems(child.getChildren()));
					obsoleteLayouts.push(child);
				} else {
					newChildren.push(child);
				}
			}
		}
		return newChildren;
	},
	newLoadChildItems: function(children, start) {
		for (var ii = start || 0, jj = children.length; ii < jj; ii++) {
			var child = children[ii];
			if (child && child.articleParent && !child.disposed) {
				this.loadChildItem(child);
			}
		}
	},
	getWidthValues: function() {
		var widths;
		if (this.$layout.$widths) {
			widths = this.$layout.$widths.split(",");
			for (var ii = 0, jj = widths.length; ii < jj; ii++) {
				widths[ii] = parseInt(widths[ii], 10);
			}
		}
		return widths || [];
	},
	deleteRowColumn: function(deletedIndex) {
		var widths = this.getWidthValues();
		var deletedWidth = widths[deletedIndex];
		var updatedIndex = Math.min(deletedIndex > 0 ? (deletedIndex - 1) : 1, widths.length - 1);
		widths[updatedIndex] += deletedWidth;
		widths.splice(deletedIndex, 1);
		this.$layout.$widths = widths.join(",");
		if (this.items.length == 1) {
			this.convertToNewLayout({
				$layoutType: "stack",
				$width: "100"
			});
		}
	},
	setChildAuhtoringLevel: function() {
		if (this.boxParent.$designLevel == "block") {
			this.$chilAuthoringLevel = "field";
		} else {
			var children = this.getItems();
			if (children.length > 0) {
				this.$chilAuthoringLevel = children[0].$designLevel;
			} else {
				this.$chilAuthoringLevel = this.boxParent.$designLevel == "section" ? "block" : "section";
			}
		}
	},
	ensureHasParent: function() {
		var $layoutType = this.$layout.$layoutType,
			$widths = this.$layout.$widths,
			$autoSize = this.$layout.$autoSize;
		var boxParent = this.boxParent;
		var children = this.extractItems(this.getChildren());
		this.dispose();
		boxParent.$item.$layout = {
			$layoutType: "stack",
			$items: [{
				$layoutType: $layoutType,
				$widths: $widths,
				$autoSize: $autoSize,
				$items: []
			}]
		};
		boxParent.renderLayoutContent();
		var layoutContent = boxParent.layoutContent.items[0];
		layoutContent.removeSpaceBox(true);
		layoutContent.newLoadChildItems(children);
		return layoutContent;
	},
	getColumnsCount: function() {
		return (this.$item.$widths || "100").split(",").length;
	},
	dispose: function() {
		this.rowSeparators = this.$$item = this.domItem = this.rowSeparator = this._tabs = this.items = this.layoutSlot = this.$item = this.$layout = this.tabOpened = null;
		this.layoutParent = this.boxParent = this.articleParent = this.page = null;
	}
});