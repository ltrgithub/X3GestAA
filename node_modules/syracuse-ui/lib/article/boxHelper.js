"use strict";
var advancedStateHelper = require('syracuse-ui/lib/field/helpers/advancedStateHelper');

function _setMaximizePicker(box) {
	var picker = box.pickers.items.maximize;
	picker.setAttribute("data-s-picker", "box-picker");
	picker.syraBoxId = box.id;
	picker.syraBoxPickerId = box.isMaximized ? "minimize" : "maximize";
	picker.className = box.$skin + "-maximize s-" + picker.syraBoxPickerId;
	picker.title = box.localize["box_" + picker.syraBoxPickerId];
}

function _toggleTabSiblings(box, show) {
	var tab = box.tabTitle;
	var node = tab.parentNode.firstChild;
	while (node) {
		if (node != tab) {
			node.style.display = show ? "" : "none";
		}
		node = node.nextSibling;
	}
}

exports.onClickPicker = {
	maximize: function(box) {
		box.isMaximized = true;
		if (!box.$$memBody) {
			box.$$memBody = $(document.createElement("div"));
		}
		box.$$memBody.empty().append($(box.page.body).children());
		if (box.tabTitle) {
			box.page.body.appendChild(box.layoutParent._tabs);
			_toggleTabSiblings(box, false);
			box.layoutParent.openTab(box);
		}
		_setMaximizePicker(box);
		box.page.body.appendChild(box.domItem);
		if (box.onSwitchMaximize) {
			box.onSwitchMaximize();
		}
	},
	minimize: function(box) {
		box.isMaximized = false;
		if (box.tabTitle) {
			if (box.layoutParent.domItem.firstChild) {
				box.layoutParent.domItem.firstChild.parentNode.insertBefore(box.layoutParent._tabs, box.layoutParent.domItem.firstChild);
			} else {
				box.layoutParent.domItem.appendChild(box.layoutParent._tabs);
			}
			_toggleTabSiblings(box, true);
		}
		box.layoutSlot.appendChild(box.domItem);
		$(box.page.body).append(box.$$memBody.children());
		box.$$memBody.remove();
		delete box.$$memBody;
		_setMaximizePicker(box);
		if (box.onSwitchMaximize) {
			box.onSwitchMaximize();
		}
	},
	advanced: function(box) {
		advancedStateHelper.onClickPicker(box);
	},
	close: function(box) {
		if (box.isMaximized) {
			exports.onClickPicker.minimize(box);
		}
		var layoutParent = box.layoutParent;
		layoutParent.removeItem(box, true);
		layoutParent.page.ensurePageVisibility();
	}
};

exports.applyPickerMetadata = function(box, metaData, designing) {
	if (metaData.$isBoxCollapsable !== undefined) {
		box.$item.$isBoxCollapsable = metaData.$isBoxCollapsable;
		exports.toggleExpandPicker(box, designing);
	}
	if (metaData.$isCloseable !== undefined) {
		exports.togglePicker(box, "close", box.$item.$isCloseable = metaData.$isCloseable);
	}
	if (metaData.$isMaximizable !== undefined) {
		exports.togglePicker(box, "maximize", box.$item.$isMaximizable = metaData.$isMaximizable);
	}
	if (metaData.$hasMenus !== undefined) {
		exports.togglePicker(box, "menus", metaData.$hasMenus);
	}
	box.ensurePickersVisibiliy();
};

exports.toggleExpandPicker = function(box, designing) {
	if (box.$item.$isBoxCollapsable && !box.$item.$isTitlePicker) {
		if (!box.expandPicker) {
			box.expandPicker = document.createElement("a");
			box.expandPicker.setAttribute("href", "#");
			box.expandPicker.setAttribute("data-s-box", box.id);
			box.expandPicker.syraIsDesignEnable = true;
			box.expandPicker.syraBoxId = box.id;
			box.expandPicker.syraBoxPickerId = "expand";
			box.expandPicker.className = box.$skin + "-expand";
			box.expandPicker.title = box.localize.box_collapse;
			if (box.$item.$css) {
				box.expandPicker.className += " " + box.$item.$css;
			}
			box.header.insertBefore(box.expandPicker, box.header.firstChild);
		}
		box.$opened = box.$item.$opened !== false;
		box.expandPicker.title = box.$opened ? box.localize.box_collapse : box.localize.box_expand;
		document.site.toggleClass(box.expandPicker, "s-close", !box.$opened);
	} else {
		if (box.expandPicker) {
			document.site.removeDomChild(box.expandPicker);
			box.expandPicker = null;
		}
	}
	if (designing) {
		if (!box.$item.$isBoxCollapsable && !box.$opened) {
			box.expandBody(true);
		}
	}
};

exports.togglePicker = function(box, pickerId, show) {
	var slotParent = box.tabTitleHead ? box.tabTitleHead : box.header;
	if (show) {
		if (!box.pickers) {
			box.pickers = {
				items: {},
				slot: document.createElement("div"),
				width: 0
			};
			box.pickers.slot.setAttribute("data-s-box", box.id);
			box.pickers.slot.className = box.$skin + ((box.tabTitleHead) ? "-tab-pickers" : "-pickers");
			if (slotParent) {
				slotParent.appendChild(box.pickers.slot);
			}
		}
		if (!box.pickers.items[pickerId]) {
			var picker = box.pickers.items[pickerId] = document.createElement("a");
			picker.className = box.$skin + "-" + pickerId;
			picker.setAttribute("data-s-picker", "box-picker");
			picker.syraBoxId = box.id;
			picker.syraBoxPickerId = pickerId;
			picker.title = box.localize["box_" + pickerId];
			box.pickers.width += 18;
			box.pickers.slot.style.width = box.pickers.width + "px";
			box.pickers.slot.appendChild(picker);
		}
	} else {
		if (box.pickers && box.pickers.items[pickerId]) {
			document.site.removeDomChild(box.pickers.items[pickerId]);
			delete box.pickers.items[pickerId];
			box.pickers.width = Math.max(0, box.pickers.width - 18);
			box.pickers.slot.style.width = box.pickers.width + "px";
		}
	}
};


exports.setTitleIcon = function(box) {
	box._iconTitle = document.createElement("div");
	box._iconTitle.className = box.$skin + "-title-icon";
	box.domTitle.appendChild(box._iconTitle);
	if (box.$item.$titleIcon.$cssName) {
		box._iconTitle.className += " " + box.$item.$titleIcon.$cssValue;
	} else {
		var $path = document.site.$item.$iconPath + (box.$item.$titleIcon.$path || "");
		box._iconTitle.style.backgroundImage = "url('" + $path + box.$item.$titleIcon.$value + ".png')";
	}
	box.textTitle = document.createElement("div");
	box.textTitle.className = box.$skin + "-title-text s-icon";
	box.domTitle.appendChild(box.textTitle);
};


exports.appendTabTitle = function(box) {
	box.tabTitle = document.createElement("a");
	if (box.isSection) {
		box.tabTitle.setAttribute("href", "#");
	}
	box.tabTitle.className = box.$skin + "-tab";
	box.tabTitle.setAttribute("data-s-box", box.id);
	box.tabTitleHead = document.createElement("div");
	box.tabTitleHead.className = box.$skin + "-tab-head";
	box.tabTitleText = document.createElement("div");
	box.tabTitleText.className = box.$skin + "-tab-text";
	box.tabTitleHead.appendChild(box.tabTitleText);
	box.tabTitle.appendChild(box.tabTitleHead);
	box.setTitle(box.getTitle());
	box.layoutParent.appendTab(box);
	box.header.style.display = "none";
};


exports.applyDesignFieldsSettings = function(box, metaData) {
	if (metaData.$fieldsIsTopLabelAlignment !== undefined ||
		metaData.$fieldsIsRightTextLabelAlignment !== undefined ||
		metaData.$fieldsIsTitleHidden !== undefined) {
		if (metaData.$fieldsIsTopLabelAlignment !== undefined) {
			box.$item.$fieldsIsTopLabelAlignment = metaData.$fieldsIsTopLabelAlignment;
		}
		if (metaData.$fieldsIsRightTextLabelAlignment !== undefined) {
			box.$item.$fieldsIsRightTextLabelAlignment = metaData.$fieldsIsRightTextLabelAlignment;
		}
		if (metaData.$fieldsIsTitleHidden !== undefined) {
			box.$item.$fieldsIsTitleHidden = metaData.$fieldsIsTitleHidden;
		}
		var items = box.layoutContent.getItems();
		for (var ii = 0, jj = items.length; ii < jj; ii++) {
			var item = items[ii];
			if (item.isField) {
				box.applyDesignMetaDataToField(item, metaData);
			} else {
				if (!item.isLayout && item.layoutContent) {
					exports.applyDesignFieldsSettings(item, metaData);
				}
			}
		}
	}
};