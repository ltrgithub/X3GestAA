"use strict";
var advancedStateHelper = require('syracuse-ui/lib/field/helpers/advancedStateHelper');

function _setMaximizePicker(box) {
	var picker = box.pickers.items.maximizebox;
	var key = box.isMaximized ? "maximizebox" : "minimizebox";
	picker.className = box.$skin + "-" + key;
	picker.title = box.localize["box_" + key];
}

function _toggleTabSiblings(box, show) {
	var tab = box.tabTitle;
	var node = tab.parentNode.firstChild;
	while (node) {
		if (node != tab) {
			node.style.display = show ? "" : "none";
		}
		node = node.nextSibling;
	}
}

exports.onMaximizeBoxClick = function(box) {
	box.isMaximized = !box.isMaximized;
	if (box.isMaximized) {
		if (!box.$$memBody) {
			box.$$memBody = $(document.createElement("div"));
		}
		box.$$memBody.empty().append($(box.page.body).children());
		if (box.tabTitle) {
			box.page.body.appendChild(box.layoutParent._tabs);
			_toggleTabSiblings(box, false);
			box.layoutParent.openTab(box);
		}
		_setMaximizePicker(box);
		box.page.body.appendChild(box.domItem);
	} else {
		if (box.tabTitle) {
			if (box.layoutParent.domItem.firstChild) {
				box.layoutParent.domItem.firstChild.parentNode.insertBefore(box.layoutParent._tabs, box.layoutParent.domItem.firstChild);
			} else {
				box.layoutParent.domItem.appendChild(box.layoutParent._tabs);
			}
			_toggleTabSiblings(box, true);
		}
		box.layoutSlot.appendChild(box.domItem);
		$(box.page.body).append(box.$$memBody.children());
		box.$$memBody.remove();
		delete box.$$memBody;
		_setMaximizePicker(box);
	}
	if (box.onSwitchMaximize) {
		box.onSwitchMaximize();
	}
};

exports.onAdvancedClick = function(box) {
	advancedStateHelper.onAdvancedClick(box);
};
exports.onCloseClick = function(box) {
	if (box.isMaximized) {
		exports.onMaximizeBoxClick(box);
	}
	var layoutParent = box.layoutParent;
	layoutParent.removeItem(box, true);
	layoutParent.page.ensurePageVisibility();
};


exports.applyPickerMetadata = function(box, metaData, designing) {
	if (metaData.$isBoxCollapsable !== undefined) {
		box.$item.$isBoxCollapsable = metaData.$isBoxCollapsable;
		exports.toggleExpandPicker(box, designing);
	}
	if (metaData.$isCloseable !== undefined) {
		exports.togglePicker(box, "close", box.$item.$isCloseable = metaData.$isCloseable);
	}
	if (metaData.$isMaximizable !== undefined) {
		exports.togglePicker(box, "maximizebox", box.$item.$isMaximizable = metaData.$isMaximizable);
	}
	if (metaData.$hasMenus !== undefined) {
		exports.togglePicker(box, "menus", metaData.$hasMenus);
	}
	box.ensurePickersVisibiliy();
};

var _onClickHandlers = {
	"maximizebox": "onMaximizeBoxClick",
	"design": "onDesignOpenerClick",
	"delete": "onDeleteClick",
	"refresh": "onRefreshClick",
	"close": "onCloseClick",
	"advanced": "onAdvancedClick"
};

exports.toggleExpandPicker = function(box, designing) {
	if (box.$item.$isBoxCollapsable && !box.$item.$isTitlePicker) {
		if (!box.expandPicker) {
			box.expandPicker = document.createElement("a");
			box.expandPicker.setAttribute("href", "#");
			box.expandPicker.syraItem = box.id;
			box.expandPicker.syraOnClick = "expand";
			box.expandPicker.className = box.$skin + "-expand";
			box.expandPicker.title = box.localize.box_collapse;
			if (box.$item.$css) {
				box.expandPicker.className += " " + box.$item.$css;
			}
			box.header.insertBefore(box.expandPicker, box.header.firstChild);
		}
		box.$opened = box.$item.$opened !== false;
		box.expandPicker.title = box.$opened ? box.localize.box_collapse : box.localize.box_expand;
		syra_site.dom.toggleClass(box.expandPicker, "s-close", !box.$opened);
	} else {
		if (box.expandPicker) {
			syra_site.dom.removeChild(box.expandPicker);
		}
	}
	if (designing) {
		if (!box.$item.$isBoxCollapsable && !box.$opened) {
			box.expandBody(true);
		}
	}
};

exports.togglePicker = function(box, pickerId, show, syraOnClick) {
	var slotParent = box.tabTitleHead ? box.tabTitleHead : box.header;
	if (show) {
		if (!box.pickers) {
			box.pickerWidth = box.pickerWidth || 18;
			box.pickers = {
				items: {},
				slot: document.createElement("div"),
				width: 0
			};
			box.pickers.slot.syraItem = box.id;
			box.pickers.slot.className = "s-section-pickers";
			if (slotParent) {
				slotParent.appendChild(box.pickers.slot);
			}
		}
		if (!box.pickers.items[pickerId]) {
			var picker = box.pickers.items[pickerId] = document.createElement("a");
			picker.className = box.$skin + "-" + pickerId;
			picker.syraOnClick = _onClickHandlers[pickerId] || syraOnClick;
			picker.title = box.localize["box_" + pickerId];
			box.pickers.width += box.pickerWidth;
			box.pickers.slot.style.width = box.pickers.width + "px";
			box.pickers.slot.appendChild(picker);
		}
	} else {
		if (box.pickers && box.pickers.items[pickerId]) {
			syra_site.dom.removeChild(box.pickers.items[pickerId]);
			delete box.pickers.items[pickerId];
			box.pickers.width = Math.max(0, box.pickers.width - box.pickerWidth);
			box.pickers.slot.style.width = box.pickers.width + "px";
		}
	}
};


exports.setTitleIcon = function(box) {
	box._iconTitle = document.createElement("div");
	box._iconTitle.className = box.$skin + "-title-icon";
	box.domTitle.appendChild(box._iconTitle);
	if (box.$item.$titleIcon.$cssName) {
		box._iconTitle.className += " " + box.$item.$titleIcon.$cssValue;
	} else {
		var $path = syra_site.$item.$iconPath + (box.$item.$titleIcon.$path || "");
		box._iconTitle.style.backgroundImage = "url('" + $path + box.$item.$titleIcon.$value + ".png')";
	}
	box.textTitle = document.createElement("div");
	box.textTitle.className = box.$skin + "-title-text s-icon";
	box.domTitle.appendChild(box.textTitle);
};


exports.appendTabTitle = function(box) {
	box.tabTitle = document.createElement("a");
	box.tabTitle.syraOnClick = "onOpenerClick";
	if (box.isSection) {
		box.tabTitle.setAttribute("href", "#");
	}
	box.tabTitle.className = box.$skin + "-tab";
	box.tabTitle.syraItem = box.id;
	box.tabTitleHead = document.createElement("div");
	box.tabTitleHead.className = box.$skin + "-tab-head";
	box.tabTitleText = document.createElement("div");
	box.tabTitleText.className = box.$skin + "-tab-text";
	box.tabTitleHead.appendChild(box.tabTitleText);
	box.tabTitle.appendChild(box.tabTitleHead);
	box.setTitle(box.getTitle());
	box.layoutParent.appendTab(box);
	box.header.style.display = "none";
};


exports.applyDesignFieldsSettings = function(box, metaData) {
	if (metaData.$fieldsIsTopLabelAlignment !== undefined ||
		metaData.$fieldsIsRightTextLabelAlignment !== undefined ||
		metaData.$fieldsIsTitleHidden !== undefined) {
		if (metaData.$fieldsIsTopLabelAlignment !== undefined) {
			box.$item.$fieldsIsTopLabelAlignment = metaData.$fieldsIsTopLabelAlignment;
		}
		if (metaData.$fieldsIsRightTextLabelAlignment !== undefined) {
			box.$item.$fieldsIsRightTextLabelAlignment = metaData.$fieldsIsRightTextLabelAlignment;
		}
		if (metaData.$fieldsIsTitleHidden !== undefined) {
			box.$item.$fieldsIsTitleHidden = metaData.$fieldsIsTitleHidden;
		}
		var items = box.layoutContent.getItems();
		for (var ii = 0, jj = items.length; ii < jj; ii++) {
			var item = items[ii];
			if (item.isField) {
				box.applyDesignMetaDataToField(item, metaData);
			} else {
				if (!item.isLayout && item.layoutContent) {
					exports.applyDesignFieldsSettings(item, metaData);
				}
			}
		}
	}
};

function _expandSiblingBoxes(box, layout, expand) {
	for (var ii = 0, jj = layout.items.length; ii < jj; ii++) {
		var item = layout.items[ii];
		if (item.isLayout) {
			_expandSiblingBoxes(box, item, expand);
		} else {
			if (item.isSection && item != box) {
				item.expandBody(expand);
			}
		}
	}
}

exports.expandSiblingBoxes = function(box, expand) {
	if (box.boxParent && box.boxParent.layoutContent) {
		_expandSiblingBoxes(box, box.boxParent.layoutContent, expand);
	}
};