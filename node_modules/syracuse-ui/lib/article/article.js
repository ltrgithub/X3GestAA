"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Box = require("./box").Box;
var locale = require('syracuse-core/lib/locale');
var _templatePattern = /(\{.*?\})/g;

function Article(){

}

exports.Article = helpers.defineClass(Article, Box, {
    fetch: function(options, callback){
        this.page.fetch(options, callback);
    },
    loadBox: function(initData){
        document.controller.registerArticle(this);
        
        this.articleParent = this.getArticleParent();
        if (this.articleParent) {
            this.$facet = this.$facet || this.articleParent.$facet;
            this.$isEditMode = this.$isEditMode === undefined ? this.articleParent.$isEditMode : this.$isEditMode;
            this.$prototype = this.$prototype || this.articleParent.$prototype.$properties[this.$item.$bind];
        }
        this.dataset = this.dataset || {};
        this.boundFields = {};
        this.idMap = {};
        this.menuItems = {};
        this.$menus = {};
        this.menuBoxes = [];
        this.drawBox();
        if (this.$$item) {
            this.$$item[0].setAttribute("data-s-article", this.id);
        }
        else {
            //debugger;
        }
        this.applyActionLinkChange(this.$prototype);
        //this.applyChange(this.$prototype);
        if (initData) {
            this.applyChange(initData);
        }
    },
    validateFields: function(){
        var self = this;
        var isValidated = true;
        Object.keys(self.boundFields).forEach(function($bind){
            self.boundFields[$bind].forEach(function(field){
                if (field.validate && field.$isEditMode && !field.validate()) {
                    isValidated = false;
                }
            });
        });
        return isValidated;
    },
    
    getArticleParent: function(){
        return this.boxParent ? this.boxParent.getArticle() : null;
    },
    getArticle: function(){
        return this;
    },
    bindMenuBox: function(box){
        var self = this;
        self.menuBoxes.push(box);
        if (self.$menus) {
            Object.keys(self.$menus).forEach(function($bind){
                var item = self.menuItems[$bind];
                if (!item || (item.length == 0)) {
                    box.addMenuItem(self.$menus[$bind], self.dataset);
                }
            });
        }
    },
    bindMenuItem: function(item, record){
        var bounds = this.menuItems[item.$item.$bind];
        if (!bounds) {
            bounds = this.menuItems[item.$item.$bind] = [];
        }
        bounds.push(item);
        var $menu = this.$menus[item.$item.$bind];
        if ($menu) {
            item.setMenu($menu, record);
        }
    },
    unbindMenuItem: function(item){
        if (this.menuItems) {
            var bounds = this.menuItems[item.$item.$bind];
            if (bounds) {
                for (var ii = 0; ii < bounds.length; ii++) {
                    if (bounds[ii] == item) {
                        bounds.splice(ii, 1);
                        break;
                    }
                }
            }
        }
    },
    applyActionLinkChange: function(resources, record){
        var self = this;
        if (record) {
            Object.keys(self.menuItems).forEach(function($bind){
                self.menuItems[$bind].forEach(function(menu){
                    menu.setMenu(null, record);
                });
            });
        }
        if (resources) {
            if (resources.$links === null) {
                Object.keys(self.menuItems).forEach(function($bind){
                    self.menuItems[$bind].forEach(function(menu){
                        document.controller.disposeObject(menu);
                    });
                    
                });
                self.menuItems = {}
                self.$menus = {};
                self.menuBoxes.forEach(function(box){
                    box.clearMenuItems();
                });
            }
            else {
                if (resources.$links) {
                    self._applyMenuChange(resources.$links, record);
                }
                if (resources.$actions) {
                    self._applyMenuChange(resources.$actions, record, true);
                }
            }
        }
    },
    _applyMenuChange: function($deltaMenu, record, $isAction){
        var self = this;
        Object.keys($deltaMenu).forEach(function($bind){
            var $menu = $deltaMenu[$bind];
            $menu.$isAction = $isAction;
            $menu.$bind = $bind;
            var $memMenu = self.$menus[$bind];
            if ($memMenu) {
                Object.keys($menu).forEach(function($property){
                    switch ($property) {
                        case "$links":
                        case "$actions":
                            var $delta = $menu[$property];
                            var $mem = $memMenu[$property] = $memMenu[$property] || {};
                            Object.keys($delta).forEach(function($bind){
                                var $source = $delta[$bind];
                                var $target = $mem[$bind] || {};
                                Object.keys($source).forEach(function($prop){
                                    $target[$prop] = $source[$prop];
                                });
                            });
                            break;
                        default:
                            $memMenu[$property] = $menu[$property];
                            break;
                    }
                });
            }
            else {
                self.$menus[$bind] = $menu;
            }
            var bounds = self.menuItems[$bind];
            if (bounds) {
                bounds.forEach(function(menu){
                    menu.setMenu($menu, record);
                });
            }
            else {
                self.menuBoxes.forEach(function(box){
                    box.addMenuItem($menu, record);
                });
            }
        });
    },
    ensureDataSet: function(){
        if (this.$item.$bind) {
            this.dataset = this.articleParent.dataset[this.$item.$bind] = this.articleParent.dataset[this.$item.$bind] || {};
        }
        return this.dataset;
    },
    applyChange: function(newData){
        if (newData) {
            var self = this;
            self.ensureDataSet();
            var actionsLinks;
            if ((newData.$links !== undefined) || (newData.$actions !== undefined)) {
                actionsLinks = {
                    $links: newData.$links,
                    $actions: newData.$actions
                };
                delete newData.$links;
                delete newData.$actions; //avoid copy of action links
            }
            var $properties = newData.$properties || {};
            
            if (newData.$title) {
                self.renderTitle(newData.$title);
            }
            if (newData.$description) {
                self.renderDescription(newData.$description);
            }
            var newFieldMetaData, newFieldValue;
            Object.keys(self.boundFields).forEach(function($bind){
                newFieldValue = newData[$bind];
                newFieldMetaData = $properties[$bind]
                if (newFieldValue || newFieldMetaData) {
                    self.boundFields[$bind].forEach(function(field){
                        field.setDataBind(newFieldValue, newData, newFieldMetaData);
                    });
                }
            });
            self.applyActionLinkChange(actionsLinks, self.dataset);
            if (newData.$diagnoses) {
                document.site.showDiagnoses({
                    $diagnoses: newData.$diagnoses
                }, self);
            }
            self.$syraLoaded = true;
            if (actionsLinks) {
                newData.$links = actionsLinks.$links;
                newData.$actions = actionsLinks.$actions;
            }
        }
    },
    bind: function(item, $bind){
        (this.boundFields[$bind] = this.boundFields[$bind] || []).push(item);
        var store = this.$syraLoaded ? this.dataset : this.$prototype; //set loaded value or default value
        item.setDataBind(store[$bind], store);
    },
    unbind: function(item){
        if (item.$item.$bind) {
            var boundFields = this.boundFields[item.$item.$bind];
            if (boundFields) {
                for (var ii = 0; ii < boundFields.length; ii++) {
                    if (boundFields[ii] == item) {
                        boundFields.splice(ii, 1);
                        break;
                    }
                }
            }
        }
    },
    matchProperty: function(property, record, properties){
        var value;
        if (properties) {
            value = properties[property];
        }
        if (value === undefined) {
            if ((value = record[property]) === undefined) {
                if ((value = this.$prototype[property]) === undefined) {
                    var articleParent = this.getArticleParent();
                    if (articleParent) {
                        value = articleParent.matchProperty(property, articleParent.dataset, properties);
                    }
                }
            }
        }
        return value;
    },
    formatMenuUrl: function($menu, record, callback){
        if (callback) {
            if ($menu.$parameters) {
                var self = this;
                $menu.$parameters.$title = $menu.getTitle ? $menu.getTitle() : null;
                self.parseParameters($menu.$parameters, record, function(values, isCanceled){
                    if (isCanceled) {
                        callback(null, isCanceled);
                    }
                    else {
                        callback(self.parseExpression($menu.$url, record, values));
                    }
                });
            }
            else {
                callback(this.parseExpression($menu.$url, record));
            }
            return;
        }
        else {
            var properties;
            if ($menu.$parameters) {
                properties = this.parseParameters($menu.$parameters, record);
            }
            return this.parseExpression($menu.$url, record, properties);
        }
    },
    _openSelectParametersDialog: function(values, $parameters, record, callback){
        this.openDialog({
            article: this,
            $url: ($parameters.$actions.$select || $parameters.$actions.$lookup).$url,
            onValidate: function(page){
                if (page.selectedRecords) {
                    values.$select = page.selectedRecords;
                    callback(values);
                    return;
                }
                callback(null, true); //input propoerties was canceled
            },
            onClose: function(isCanceled){
                if (isCanceled) {
                    callback(null, true); //input propoerties was canceled 
                }
            },
            onSelectRecord: function(selectedRecords, page){
                page.selectedRecords = Object.keys(selectedRecords).map(function(rec){
                    return selectedRecords[rec].dataset;
                });
                return false;
            }
        });
    },
    _openParametersDialog: function(values, $parameters, record, callback){
        var self = this;
        var localize = locale.resources(module)();
        var $itemPage;
        if (!$parameters.$url) {
            var $prototype = helpers.object.clone($parameters);
            if (values) {
                Object.keys(values).forEach(function(prop){
                    $prototype[prop] = values[prop];
                });
            }
            if (this.$prototype && this.$prototype.$localization) {
                $prototype.$localization = this.$prototype.$localization;
            }
            $prototype.$title = $parameters.$title || localize.article_parameters_title;
            $itemPage = {
                $category: "page",
                $urlParts: {
                    $facet: "$edit"
                },
                $representation: {
                    $prototype: $prototype
                }
            };
        }
        this.openDialog({
            $dialogMode: "modal",
            article: this,
            initData: values,
            onOpened: function(dialogPage){
                if ($parameters && $parameters.$url) {
                    Object.keys(values).forEach(function($prop){
                        var $defaultValue = values[$prop];
                        if (dialogPage.boundFields && dialogPage.boundFields[$prop] && dialogPage.boundFields[$prop][0]) {
                            var field = dialogPage.boundFields[$prop][0];
                            field.setDataValue($defaultValue);
                            field.notifyFieldChange(field.currentValue);
                        }
                    });
                }
            },
            onValidate: function(dialogPage){
                Object.keys(dialogPage.dataset).forEach(function($prop){
                    // if ($prop != "$syraLoaded") {
                    values[$prop] = dialogPage.dataset[$prop];
                    // }
                });
                callback(values);
            },
            onClose: function(isCanceled){
                if (isCanceled) {
                    callback(null, true); //input propoerties was canceled 
                }
            },
            $itemPage: $itemPage,
            $url: $parameters.$url,
            $method: $parameters.$method || "GET"
        });
    },
    parseParameters: function($parameters, record, callback){
        var self = this;
        var values = {};
        Object.keys($parameters).forEach(function(prop){
            switch (prop) {
                case "$properties":
                case "$":
                case "$links":
                case "$actions":
                    break;
                default:
                    var expression = $parameters[prop];
                    if (expression && typeof(expression) == "string") {
                        expression = self.parseExpression(expression, record);
                    }
                    values[prop] = expression;
                    break;
            }
        });
        if (callback) {
            if ($parameters.$actions) {
                self._openSelectParametersDialog(values, $parameters, record, callback);
                return;
            }
            if ($parameters.$properties) {
                self._openParametersDialog(values, $parameters, record, callback);
                return;
            }
            callback(values);
        }
        return values;
    },
    getLocalization: function(){
        return this.$prototype.$localization || this.page.$prototype.$localization;
    },
    getLocalizeText: function(text){
        if (text.length > 0 && text[1] == "@") {
            text = this.parseExpression(text);
        }
        return text;
    },
    parseExpression: function(expression, record, properties){
        var result = expression;
        var self = this;
        record = record || self.dataset;
        if (result && result.indexOf("{") >= 0) {
            if (result[1] == "@") {
                var text = result.slice(1, result.length - 1);
                var $localization = self.getLocalization();
                if ($localization) {
                    return $localization[text] || text;
                }
                return text;
            }
            else {
                var matches = result.match(_templatePattern);
                matches.forEach(function(match){
                    var property = match.substr(1, match.length - 2);
                    var value = self.matchProperty(property, record, properties);
                    if (value != null) {
                        if (value.indexOf && value.indexOf("{") >= 0) {
                            value = self.parseExpression(value, record, properties);
                        }
                        else {
                            if (typeof(value) == "object") {
                                value = value.$uuid || value.$key || value[property] || null;
                                if (value == null) {
                                    console.log("can not match " + property + " in " + expression);
                                    value = "";
                                }
                            }
                        }
                        if (value != null) {
                            result = result.replace(match, value);
                        }
                    }
                });
            }
        }
        return result;
    },
    removeItem: function(item, removeDom, unbind){
        if (item) {
            if (removeDom) {
                if (item.remove) {
                    item.remove();
                }
                else {
                    if (item.$$item) {
                        item.$$item.remove();
                    }
                }
            }
            if (unbind) {
                this.unbind(item);
            }
            if (item.id) {
                delete this.idMap[item.id];
            }
            if (item.dispose) {
                document.controller.disposeObject(item);
            }
        }
    },
    diposeContent: function(){
        var self = this;
        delete self.menuItems;
        delete self.$menus;
        delete self.menuBoxes;
        if (self.idMap) {
            Object.keys(self.idMap).forEach(function(prop){
                document.controller.disposeObject(self.idMap[prop]);
            });
            delete self.idMap;
        }
        if (self.layoutContent) {
            self.layoutContent.dispose();
        }
        delete self.boundFields;
    },
    dispose: function(){
        this.diposeContent();
        document.controller.unregisterArticle(this);
        delete this.$layoutOptions;
        delete this.$uuid;
        delete this.$facet;
        delete this.$isEditMode;
        delete this.$prototype;
        delete this.dataset;
        delete this.$syraLoaded;
        Box.prototype.dispose.call(this);
    }
});
