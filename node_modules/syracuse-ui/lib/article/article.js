"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Box = require("./box").Box;
var FieldsGarbage = require("./fieldsGarbage").FieldsGarbage;

function Article() {}

exports.Article = helpers.defineClass(Article, Box, {
	setMustBeResized: function() {
		if (!this.mustBeResized) {
			var article = this;
			while (article && !article.mustBeResized) {
				article.mustBeResized = true;
				article = article.articleParent;
			}
		}
	},
	isChildItemDisplay: function(item) {
		var boxParent = item.boxParent;
		while (boxParent && boxParent.$opened && boxParent != this) {
			boxParent = boxParent.boxParent;
		}
		return boxParent == this;
	},
	setArticleId: function(dom) {
		dom.setAttribute("data-s-article", this.id);
		dom.syraarticle = this.id;
	},
	notifyClientSave: function(savedDelta) {
		if (savedDelta) {
			var delta = {};
			var $binds = Object.keys(this.$prototype.$properties);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var $bind = $binds[ii];
				if (savedDelta[$bind] !== undefined) {
					delta[$bind] = savedDelta[$bind];
				}
			}
			syra_site.deltaManager.applyObjectDelta(this.page, this.dataset, delta);
			this.applyChange(delta);
		}
	},
	getMetaData: function() {
		var $meta = this.articleParent.dataset.$properties;
		if ($meta) {
			$meta = $meta[this.$item.$bind];
		}
		if ($meta && this.$item.$variantItemKey) {
			return $meta[this.$item.$variantItemKey];
		}
		return $meta;
	},
	getPrototype: function() {
		if (!this.$prototype) {
			this.$prototype = this.articleParent.$prototype.$properties[this.$item.$bind];
			if (this.$prototype && this.$prototype.$variants && this.$item.$variantItemKey) {
				this.$prototype = this.$prototype.$variants[this.$item.$variantItemKey];
			}
			this.$prototype = this.page.addPrototypeToRepository(this.$prototype);
		}
		return this.$prototype;
	},
	loadBox: function(initData) {
		this.autosizeFields = [];
		if (this.articleParent) {
			this.$facet = this.$facet || this.articleParent.$facet;
			if (!this.$urlParams) {
				this.$urlParams = this.articleParent.$urlParams || {};
			}
		} else {
			this.$urlParams = this.$urlParams || {};
		}
		this.$prototype = this.getPrototype();

		if (this.$isEditMode === undefined) {
			if (this.$item) {
				this.$isEditMode = this.$item.$isEditMode;
			}
			if (this.$isEditMode === undefined && this.articleParent) {
				this.$isEditMode = this.articleParent.$isEditMode;
			}
		}
		this.dataset = this.dataset || {};
		this.boundFields = {};
		this.layouts = {};
		this.idMap = {};
		syra_menus.initialize(this);
		this.drawBox();
		this.domItem && this.setArticleId(this.domItem);
		syra_menus.setMenus(this, this.$prototype);
		initData && this.applyChange(initData);
	},

	validateFields: function() {
		var isValidated = true;
		var $binds = Object.keys(this.boundFields);
		for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
			var fields = this.boundFields[$binds[ii]];
			for (var kk = 0, mm = fields.length; kk < mm; kk++) {
				var field = fields[kk];
				if (!field.$isHidden) {
					if (field.validate && field.$isEditMode) {
						var newValue = field.getDataValue();
						if (!field.validate(newValue)) {
							isValidated = false;
						} else {
							if (newValue != undefined) {
								field.notifyFieldChange && field.notifyFieldChange(newValue);
							}
						}
					}
				}
			}
		}
		return isValidated;
	},
	getArticle: function() {
		return this;
	},
	ensureDataSet: function() {
		if (this.$item.$bind && this.articleParent) {
			this.dataset = this.articleParent.dataset[this.$item.$bind] = this.articleParent.dataset[this.$item.$bind] || {};
		}
		return this.dataset;
	},
	applyChange: function(newData) {
		if (newData) {
			this.ensureDataSet();
			var $properties = newData.$properties || {};

			if (newData.$title) {
				this.setTitle(newData.$title);
			}
			if (newData.$description) {
				this.setDescription(newData.$description);
			}
			var newFieldMetaData, newFieldValue;
			var $binds = Object.keys(this.boundFields);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var $bind = $binds[ii];
				newFieldValue = newData[$bind];
				newFieldMetaData = $properties[$bind];
				if (newFieldValue !== undefined || newFieldMetaData !== undefined) {
					var fields = this.boundFields[$bind];
					for (var kk = 0, mm = fields.length; kk < mm; kk++) {
						fields[kk].setDataBind(newFieldValue, newData, newFieldMetaData, $bind);
						fields[kk].isWidgetUpated = true;
						this.isWidgetUpated = true;
					}
				}
			}

			var $binds = Object.keys($properties);
			if ($binds.length > 0) {
				for (var mm = 0, pp = $binds.length; mm < pp; mm++) {
					var $bind = $binds[mm];
					if (!this.boundFields[$bind]) {
						if ($properties[$bind].$diagnoses) {
							syra_site.showDiagnoses({
								$bind: $bind,
								$diagnoses: $properties[$bind].$diagnoses
							}, this);
						}
					}
				}
			}

			$binds = Object.keys(this.menuItems);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var $bind = $binds[ii];
				var items = this.menuItems[$bind];
				for (var kk = 0, mm = items.length; kk < mm; kk++) {
					items[kk].outOfDate = true;
				}
			}
			syra_menus.setMenus(this, newData);

			if (newData.$diagnoses && !newData.noDispDiag) {
				syra_site.showDiagnoses({
					$diagnoses: newData.$diagnoses
				}, this);
			}
			this.$syraLoaded = true;
		}
	},
	bind: function(item, $bind) {
		if ($bind) {
			(this.boundFields[$bind] = this.boundFields[$bind] || []).push(item);
			item.setDataBind(this.$prototype[$bind], this.$prototype, undefined, $bind);
			if (this.$syraLoaded) {
				item.setDataBind(this.dataset[$bind], this.dataset, this.dataset.$properties && this.dataset.$properties[$bind], $bind);
			}
		}
	},
	unbind: function(item) {
		if (item.$item.$bind) {
			var map = item.isMenuItem ? this.menuItems : this.boundFields;
			var bounds = map[item.$item.$bind];
			if (bounds) {
				for (var ii = 0; ii < bounds.length; ii++) {
					if (bounds[ii] == item) {
						bounds.splice(ii, 1);
						break;
					}
				}
			}
		}
	},

	getLocalizeText: function(text) {
		if (text.length > 0 && text[1] == "@") {
			text = syra_site.expressionMaker.parse(this, text);
		}
		return text;
	},
	removeItem: function(item, removeDom, unbind) {
		if (item) {
			if (removeDom) {
				if (item.remove) {
					item.remove();
				} else {
					if (item.domItem && item.domItem.parentNode) {
						item.domItem.parentNode.removeChild(item.domItem);
					}
				}
			}
			if (unbind) {
				this.unbind(item);
			}
			if (item.id) {
				delete this.idMap[item.id];
				delete this.layouts[item.id];
			}
			item.dispose && item.dispose();
		}
	},
	diposeContent: function() {
		this.childLists = this.menuItems = this.menusBag = null;
		if (this.idMap) {
			var ids = Object.keys(this.idMap);
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				var item = this.idMap[ids[ii]];
				item && item.dispose(); //test manadatory because item could be remode by previous dispose
			}
		}
		if (this.layouts) {
			var ids = Object.keys(this.layouts);
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				var item = this.layouts[ids[ii]];
				item && item.dispose();
			}
		}
		this.autosizeFields = this.childLists = this.layouts = this.idMap = this.boundFields = this.layoutContent = null;
	},
	registerAutoSizeFields: function(field, register) {
		var index = this.autosizeFields.indexOf(field);
		if (register && index < 0) {
			this.autosizeFields.push(field);
		}
		if (!register && index >= 0) {
			this.autosizeFields.splice(index, 1);
		}
	},
	ensureArticleVisibility: function(resizeIfNeed, boxParent) {
		if (this.childrenSection) {
			for (var mm = 0, kk = this.childrenSection.length; mm < kk; mm++) {
				if (!boxParent || boxParent.isChild(this.childrenSection[mm])) {
					this.childrenSection[mm].ensureVisibility();
				}
			}
		}
		if (this.childLists) {
			for (var ii = 0, jj = this.childLists.length; ii < jj; ii++) {
				if (!boxParent || boxParent.isChild(this.childLists[ii])) {
					this.childLists[ii].ensureArticleVisibility();
				}
			}
		}
		var layoutContent = (boxParent || this).layoutContent;
		layoutContent && syra_site.layoutValidator.validate(layoutContent, true);

		resizeIfNeed && this.resizeArticle(undefined, boxParent);
	},
	resizeArticle: function(doResize, boxParent) {
		if (this.childLists) {
			for (var ii = 0, jj = this.childLists.length; ii < jj; ii++) {
				if (!boxParent || boxParent.isChild(this.childLists[ii])) {
					this.childLists[ii].resizeArticle(doResize);
				}
			}
		}
		if (this.autosizeFields && this.autosizeFields.length) {
			for (var ii = 0, jj = this.autosizeFields.length; ii < jj; ii++) {
				if (!boxParent || boxParent.isChild(this.autosizeFields[ii])) {
					this.autosizeFields[ii].resizeField(doResize);
				}
			}
		}
	},
	dispose: function() {
		syra_menus.dispose(this);
		this.diposeContent();
		this.parentVariantField = this.$prototype = this.dataset = this.layouts = this.$urlParams = this.designer = null;
		Box.prototype.dispose.call(this);
	}
});