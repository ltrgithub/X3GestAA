"use strict";
var helpers = require('syracuse-core/lib/helpers');
var fieldsInsert = require('syracuse-ui/lib/article/fieldInsertion').fieldsInsert;
var util = require('syracuse-ui/lib/fusion/tools/util');

function FieldsGarbage() {}

exports.FieldsGarbage = helpers.defineClass(FieldsGarbage, null, {
	load: function(article, dontWarnForUpdates) {
		this.article = article;
		this._garbageFields = {};
		var $garbageFields = this.article.$item.$garbageFields;
		if ($garbageFields) {
			this._$properties = this._getProperties();
			for (var ii = 0, jj = $garbageFields.length; ii < jj; ii++) {
				this._garbageFields[$garbageFields[ii]] = this._$properties[$garbageFields[ii]];
			}
		}
		if (!dontWarnForUpdates) {
			this._warnAdministrationUpdates();
		}
	},
	_getProperties: function() {
		return (this.article.$prototype.$item ? this.article.$prototype.$item.$properties : this.article.$prototype.$properties) || {};
	},
	onAddField: function($bind) {
		if (this._$freeFieldBinds && this._$freeFieldBinds.indexOf($bind) >= 0) {
			this._$freeFieldBinds.splice(this._$freeFieldBinds.indexOf($bind), 1);
		}
		delete this._garbageFields[$bind];
		this._saveGarbageField();
	},
	onExcludeField: function($bind) {
		this._garbageFields[$bind] = 1;
		this._saveGarbageField();
	},
	garbageFreeItems: function() {
		if (this._$freeFieldBinds) {
			this._garbageFields = this._garbageFields || {};
			for (var ii = 0, jj = this._$freeFieldBinds.length; ii < jj; ii++) {
				this._garbageFields[this._$freeFieldBinds[ii]] = 1;
			}
			this._$freeFieldBinds = [];
			this._saveGarbageField();
		}
	},
	_saveGarbageField: function() {
		this.article.$item.$garbageFields = Object.keys(this._garbageFields);
	},
	loadFreeField: function(page, layoutMap) {
		this._isFusionPage = (page || this.article.page).isFusionPage;
		this._$freeFieldBinds = [];
		if (!this._$properties) {
			this._$properties = this._getProperties();
		}
		var $fieldsBinds = Object.keys(this._$properties);
		var $definedBinds = {};
		this._getDefinedFieldsObject(this.article.$item, $definedBinds, layoutMap);
		for (var ii = 0, jj = $fieldsBinds.length; ii < jj; ii++) {
			var $bind = $fieldsBinds[ii];
			var $field = this._$properties[$bind];
			if ($field && !$field.$isExcluded) {
				if (!$definedBinds[$bind] && ($bind.charAt(0) != "$")) {
					if (!(this._isFusionPage && (page || this.article.page).isNavigationListItem($bind))) {
						if (!this._garbageFields[$bind]) {
							this._$freeFieldBinds.push($bind);
						}
					}
				}
			}
		}
		return this._$freeFieldBinds.length;
	},
	_warnAdministrationUpdates: function(showDiagnoses) {
		if (!this.article.page.isDashBoard) {
			this.loadFreeField();
		}
	},
	_getDefinedFieldsObject: function($article, $object, layoutMap, checkProperties) {
		var secCount = -1,
			checkProps = checkProperties || this._$properties,
			blockCount, cat, currSec = null,
			currBlock = null,
			deepMax = 9999,
			deep = 0,
			deepS = deepMax,
			deepB = deepMax;
		var parentLayout, $items = $article && $article.$layout && $article.$layout.$items;
		var parentLayoutB, parentLayoutS;
		if (layoutMap) {
			layoutMap.section = [];
			parentLayout = $items && $article.$layout.$layoutType ? $article.$layout : null;
			parentLayoutB = parentLayoutS = parentLayout;
		}

		function _walk(items) {
			if (items) {
				deep++;
				for (var ii = 0, jj = items.length; ii < jj; ii++) {
					var $item = items[ii];
					if ($item.$bind) {
						$object[$item.$bind] = true;
						if (currBlock && checkProps[$item.$bind]) {
							currBlock.boundFields.push($item.$bind);
						}
					} else {
						if (layoutMap && $item.$category && ($item.$category == "section" || $item.$category == "block")) {
							cat = {
								"$title": $item.$title,
								"$XID": $item.$XID,
								"$name": $item.$name,
								"parent": items,
								"parentSlot": ii
							};
							if ($item.$category === "section" && deep <= deepS) {
								deepS = deep;
								cat.block = [];
								cat.boundBlocks = [];
								blockCount = -1;
								layoutMap[$item.$category].push(cat);
								currSec = layoutMap[$item.$category][++secCount];
								cat.parentLayout = parentLayoutS;
							} else
							if (currSec) {
								deepB = deep;
								cat.items = $item.$items || ($item.$layout && $item.$layout.$items);
								cat.boundFields = [];
								currSec.block.push(cat);
								currSec.boundBlocks.push(cat.$title);
								currBlock = currSec.block[++blockCount];
								cat.parentLayout = parentLayoutB;
							}
						}
						if ($item.$layoutType || $item.$layout && $item.$layout.$layoutType) {
							parentLayout = $item.$layoutType ? $item : $item.$layout;
							parentLayoutS = deep < deepS ? parentLayout : parentLayoutS;
							parentLayoutB = deep < deepB ? parentLayout : parentLayoutB;
						}
						if ($item.$items) {
							_walk($item.$items);
						}
						if ($item.$layout && $item.$layout.$items) {
							_walk($item.$layout.$items);
						}
					}
				}
				deep--;
				if (deep == deepS) {
					deepS = deepMax;
				} else
				if (deep == deepB) {
					deepB = deepMax;
				}
			}
		}
		_walk($items);
	},
	dispose: function() {
		this.article = this._garbageFields = this._$freeFieldBinds = this._$sourceArticle = this._$properties = null;
	}
});

function FieldsAutoInsert() {}

exports.FieldsAutoInsert = helpers.defineClass(FieldsAutoInsert, FieldsGarbage, {
	load: function(article, $designLevel) {
		var $definedBinds = {};
		this._elapse = {
			"elapseF": (new Date()).getTime(),
			"elapseI": 0
		};
		this._designLevel = $designLevel;
		this.page = $designLevel == "article" ? article : article.page;
		if (!this.page.isAutoInsertFieldDisabled) {
			FieldsGarbage.prototype.load.call(this, article, true);
			if (this.loadFreeField(this.page, (this._$layoutMap = {}))) {
				this._elapse.elapseI = (new Date()).getTime();
				this._elapse.elapseF = this._elapse.elapseI - this._elapse.elapseF;
				if (!this.page._$protoLayoutMap) {
					this._$protoLayoutMapOwnerShip = true;
					this._getDefinedFieldsObject(this.page.$prototype.$article, $definedBinds, (this.page._$protoLayoutMap = {}), this.page.$prototype.$properties);
				}
				this._result = fieldsInsert($designLevel, this._isFusionPage, this);
				this._elapse.elapseI = (new Date()).getTime() - this._elapse.elapseI;
			} else {
				this._elapse.elapseF = (new Date()).getTime() - this._elapse.elapseF;
			}
		}
	},
	_getArticleTitle: function() {
		var code = null,
			name, pref, i, len, view, viewSel, viewLabel = "";
		if (this._designLevel == "article") {
			code = this.article.$prototype.$title;
			pref = "representation '";
		} else {
			code = this.article.boxParent && this.article.boxParent.$item && this.article.boxParent.$item.$title;
			name = this.article.$prototype && this.article.$prototype.$X3Name || this.article.$item.$bind;
			pref = "grid '";
		}
		viewLabel = this.page.$selectedDesignView && this.page.$selectedDesignView.$title;
		return (code ? ((pref + this.article.getLocalizeText(code)) || (pref + name)) : (pref + name)) + (viewLabel ? "' - view " + viewLabel : "'");

	},
	showDiagnoses: function() {
		var result, i, j, len, lenj, $diagKeys, diagField, $diagnoses = [],
			logger, statsBlocks = null,
			self = this,
			statsFields = null,
			statsSections = null,
			failed, applyChange = false,
			change = {
				"$properties": {}
			};

		function _processDiagnoses(category) {
			var stats = null,
				res;
			if ((res = self._result[category]) && res.diagnoses) {
				// Deal with blocks diagnoses
				$diagKeys = Object.keys(res.diagnoses);
				for (i = 0, len = $diagKeys.length; i < len; i++) {
					$diagnoses.push(res.diagnoses[$diagKeys[i]]);
				}
				stats = self.insertStats(res);
			}
			return stats;
		}
		if (this._result) {
			// Deal with fields diagnoses
			if ((result = this._result.field) && result.diagnoses) {
				$diagKeys = Object.keys(result.diagnoses);
				for (i = 0, len = $diagKeys.length; i < len; i++) {
					diagField = result.diagnoses[$diagKeys[i]];
					if (!util.isErrDiagnosis(diagField.$severity)) {
						change.$properties[$diagKeys[i]] = {
							"$diagnoses": [result.diagnoses[$diagKeys[i]]]
						};
						applyChange = true;
					} else {
						$diagnoses.push(diagField);
					}
					if (diagField.$diagnoses && (lenj = diagField.$diagnoses.length)) {
						for (j = 0; j < lenj; j++) {
							$diagnoses.push(diagField.$diagnoses[j]);
						}
					}
				}
				statsFields = this.insertStats(result);
			}
			// Others diagnoses...
			statsBlocks = _processDiagnoses("block");
			statsSections = _processDiagnoses("section");
			// General diagnoses
			if (statsBlocks || statsFields || statsSections) {
				failed = statsBlocks && statsBlocks.ko || (statsFields && statsFields.ko) || (statsSections && statsSections.ko);
				$diagnoses.splice(0, 0, this.makeDiagnosis(null, null, "detection duration : " + this._elapse.elapseF + " ms - insert duration : " + this._elapse.elapseI + " ms", "info"));
				$diagnoses.push(this.makeDiagnosis(failed ? "autoInsertResultError" : "autoInsertResultSuccess", null, null, failed ? "error" : "info"));
				logger = util.getLog(util.getDefaultLogSwitches(document.syraTrans, {}));
				if (failed || (logger && logger.isTraceEnable())) {
					if (applyChange) {
						this.page.applyChange(change);
					}
					syra_site.showDiagnoses({
						"$diagnoses": $diagnoses
					}, this);
				} else {
					logger = util.getLog({
						"logId": "insertFieldAuto",
						"on": {
							"trc": true
						}
					});
					this._tracedDiagnoses(logger, $diagnoses.splice($diagnoses.length - 1, 1), {
						"f": statsFields,
						"b": statsBlocks,
						"s": statsSections
					}, $diagnoses.splice(0, 1), $diagnoses, change);
				}
			}
		}
	},
	insertStats: function(result) {
		var i, len, $diagKeys = Object.keys(result),
			diag, ret = {
				"ok": 0,
				"ko": 0
			};
		for (i = 0, len = $diagKeys.length; i < len; i++) {
			diag = result[$diagKeys[i]];
			if (util.isKnownDiagnosisSeverity($diagKeys[i])) {
				if (diag && util.isErrDiagnosis($diagKeys[i])) {
					ret.ko += diag;
				} else
				if (diag) {
					ret.ok += diag;
				}
			}
		}
		return ret;
	},
	_tracedDiagnoses: function(logger, status, stats, timing, containersDiag, fieldsDiag) {
		var i, len, diag, fld;
		var title = this._getArticleTitle();

		function _getLevel(severity) {
			return util.isErrDiagnosis(severity) ? "error" : (util.isWarnDiagnosis(severity) ? "warn" : "info");
		}
		logger.trace({
			"severety": "warn"
		}, "\t\t=== Entities insertion in authored for " + title + " : start reporting ===");
		logger.trace({
			"severety": _getLevel(status[0].$severity)
		}, status[0].$message);
		for (i = 0, len = containersDiag.length; i < len; i++) {
			diag = containersDiag[i];
			logger.trace({
				"severety": _getLevel(diag.$severity)
			}, diag.$message + (diag.$details ? (" - " + diag.$details) : ""));
		}
		fld = fieldsDiag ? Object.keys(fieldsDiag.$properties) : [];
		for (i = 0, len = fld.length; i < len; i++) {
			diag = fieldsDiag.$properties[fld[i]].$diagnoses[0];
			logger.trace({
				"severety": _getLevel(diag.$severity)
			}, diag.$message + (diag.$details ? (" - " + diag.$details) : ""));
		}
		logger.trace({
			"severety": "info"
		}, timing[0].$message);
		logger.trace({
			"severety": "warn"
		}, "\t\t=== Entities insertion in authored for " + title + " : stop reporting ===");
	},
	makeDiagnosis: function(labelCode, labelCodeArgs, labelString, severity, details, stack) {
		return util.makeDiagnosisLocale(labelCode, labelCodeArgs, labelString, severity, details, stack, !this._isFusionPage ? "Client framework" : null);
	},
	dispose: function() {
		FieldsGarbage.prototype.dispose.call(this);
		if (this._$protoLayoutMapOwnerShip) {
			this.page._$protoLayoutMap = null;
			this._$protoLayoutMapOwnerShip = false;
		}
		this._$layoutMap = this.page = this._result = null;
	}
});