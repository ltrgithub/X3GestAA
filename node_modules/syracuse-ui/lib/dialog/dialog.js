"use strict";
var helpers = require('syracuse-core/lib/helpers');
//0 0 90px 5px #000000

function Dialog() {}

exports.Dialog = helpers.defineClass(Dialog, null, {
	open: function(options) {
		if ((this.options = options).content) {
			this._openContent();
		} else {
			this._openDialogPage();
		}
	},
	_openContent: function() {
		var self = this;
		self._content = self.options.content;
		self.dialogSlot = self.options.slot || self.options.content.$$item[0];
		if (self.dialogSlot.style.position != "fixed") {
			self.dialogSlot.style.position = "absolute";
		}
		self.dialogSlot.style.display = '';
		if (self.options.isAutoClose !== false) {
			self._appendAutoClose(true);
		}
		if (self.options.dragSpot) {
			self._widgetResizer = document.site.setWidgetResizable({
				source: self,
				slot: self.dialogSlot,
				dragSpot: self.options.dragSpot,
				isResizingEnabled: self.options.isResizingEnabled,
				onResize: function(resizer, moving) {
					if (moving) {
						self.widgetResizing = true;
						self.resizeDialog(true);
						self.widgetResizing = false;
					}
				}
			});
		}
		self._endOpen();
	},
	isTargetInBoundary: function(event) {
		if (event && this._autoCloseBoundary) {
			if ($(event.target).closest(this._autoCloseBoundary).length > 0) {
				return true;
			}
		}
		return false;
	},
	_appendAutoClose: function(append) {
		var self = this;
		if ((self.options.$autoClose === undefined) ? true : self.options.$autoClose) {
			if (append) {
				self._autoCloseNamespace = self.dialogSlot.getAttribute("id") || self.id;
				self.isAutoClose = true;
				self.dialogSlot.id = self._autoCloseNamespace;
				self._autoCloseBoundary = "#" + self._autoCloseNamespace;
				if (self.options.autoCloseBoundaryId) {
					self._autoCloseBoundary += "," + "#" + self.options.autoCloseBoundaryId;
				}
				$(document).bind("click." + self._autoCloseNamespace, function(event) {
					if (self.dialogSlot) {
						if ($(self.dialogSlot).is(":visible")) {
							if (!self.isTargetInBoundary(event)) {
								self.close();
							}
						}
					}
					return true;
				});

			} else {
				if (self._autoCloseNamespace) {
					self.isAutoClose = false;
					$(document).unbind("click." + self._autoCloseNamespace);
				}
			}
		}
	},
	_endOpen: function() {
		if (this.isModal) {
			this.overlay = document.createElement("div");
			this.overlay.className = "s-overlay";
			document.site.setZIndex(this.overlay);
			document.site.layoutSlot.appendChild(this.overlay);
		}
		document.site.setZIndex(this.dialogSlot);
		document.site.layoutSlot.appendChild(this.dialogSlot);
		this.isOpened = true;
		this.resizeDialog();
		if (this.options.onOpened) {
			this.options.onOpened(this._content);
		}
		// anchor to set focus on message box (fix issue #3243)
		if (this.options.$autoFocus) {
			var focusAnchor = document.createElement("a");
			focusAnchor.className = "s-dialog-focus-anchor";
			focusAnchor.setAttribute('href', '#');
			this.dialogSlot.appendChild(focusAnchor);
			$(focusAnchor).focus();
		}
	},
	_openDialogPage: function($itemPage) {
		var self = this;
		if ($itemPage || self.options.page) {
			if (self.options.page) {
				self._content = self.options.page;
				self.dialogSlot = self.options.page.layoutSlot || document.createElement("div");
				self._content.dialogWrapper = self;
			} else {
				self.dialogSlot = $itemPage.layoutSlot = document.createElement("div");
				$itemPage.dialogWrapper = self;
				self._content = document.site.loadNewPage($itemPage);
				self._content.domItem.style.display = "none";
			}
			self.dialogSlot.className = self.$skin + "-page-container";
			self._content.header.className = self.$skin + "-page-head";
			self._content.body.className = self.$skin + "-page-body";
			self._content.dataSlot.className = self.$skin + "-page-data";
			self._content.domItem.className = self.$skin + "-page";
			self.dialogSlot.setAttribute("tabindex", "2");
			self.options.$autoClose = self.options.$autoClose || false;
			self._appendAutoClose(true);
			self.appendCloseButton(self._content.header);
			if (self._content.$facet == "$lookup" || self._content.scrollview) {
				self._content.body.style.overflow = "hidden";
			} else {
				self._content.body.style.overflow = "auto";
			}
			if (self.options.onValidate) {
				self.okBtn = document.createElement("a");
				self._content.setArticleId(self.okBtn);
				self.okBtn.setAttribute("data-s-picker", "s-dialog-ok");
				self.okBtn.className = self.$skin + "-page-ok";
				self.okBtn.title = document.site.localize.dlgOk;
				if (self.options.$isOkHidden) {
					self.hideOkButton(true);
				}
				self._content.header.appendChild(self.okBtn);
			}
			if (self.options.onSelectRecord) {
				self._content.onSelectRecord = function(selectedRecords) {
					if (self.options.onSelectRecord(selectedRecords, self._content) !== false) {
						self.close();
					}
				};
			}
			self._content.domItem.style.display = "";

			self._endOpen();

			self._widgetResizer = document.site.setWidgetResizable({
				source: self,
				slot: self.dialogSlot,
				dragSpot: self._content.header,
				onResize: function(resizer, moving) {
					if (moving) {
						self.widgetResizing = true;
						self.resizeDialog();
						self.widgetResizing = false;
					}
				}
			});
			self.isDialogPage = true;
		} else {
			if (self.options.$itemPage) {
				self._openDialogPage(self.options.$itemPage);
			} else {
				if (self.options.$method && (self.options.$method != "GET"))
					document.controller.postQuery(self.options, null, self.options.article, function($location, data) {
						self.hasCallback = true; // in order not to dispose the dialog before the callback
						document.controller.loadRepresentation(self.options.article, $location.$url, function($itemPage) {
							if (data && document.controller.isWorkingCopyUrl(self.options.$url)) {
								$itemPage.initData = data;
							}
							self._openDialogPage($itemPage);
							self.hasCallback = null;
						});
					});
				else {
					self.hasCallback = true; // in order not to dispose the dialog before the callback
					document.controller.loadRepresentation(self.options.article, self.options.$url, function($itemPage) {
						self._openDialogPage($itemPage);
						self.hasCallback = null;
					});
				}
			}
		}
	},
	close: function(validated, dispose) {
		if (!this.disposed) {
			if (this.options && this.options.onClose ? (this.options.onClose(validated !== true, dispose) !== false) : true) {
				document.controller.disposeObject(this);
			}
		}
	},
	hideOkButton: function(hide) {
		if (this.okBtn) {
			this.okBtn.style.display = hide ? "none" : "";
		}
	},
	onOkClick: function() {
		if (this.options.onValidate(this._content) !== false) {
			this.close(true);
		}
	},
	appendCloseButton: function(header) {
		var self = this;
		var btn = document.createElement("a");
		btn.className = self.$skin + "-page-close";
		btn.title = document.site.localize.dlgClose;
		self.$$closeBtn = $(header.appendChild(btn)).bind("click", function() {
			self.close();
			return false;
		});
	},
	getScrollSizes: function() {
		var size = {
			dialog: document.site.getBoundingClientRect(this.dialogSlot),
			scrollview: document.site.getBoundingClientRect(this._content.scrollview)
		};
		size.dialog.inner = document.site.getInnerSize(this.dialogSlot);
		size.dialog.inner.height = size.dialog.inner.height - (this._content.diagnoseSlot ? this._content.diagnoseSlot.clientHeight : 0);
		size.space = size.dialog.inner.height - size.scrollview.height;
		return size;
	},
	resizeDialogSlot: function() {
		var sizes = this.getScrollSizes();
		if (!this.widgetResizing) {
			if (sizes.space) {
				if (!document.site.isResizing) {
					this.dialogSlot.style.height = Math.min(this.dialogSlot.clientHeight - sizes.space, this._maxHeight) + "px";
					sizes = this.getScrollSizes();
				} else {
					if (sizes.space > 0) {
						this.dialogSlot.style.height = (this.dialogSlot.clientHeight - sizes.space) + "px";
						sizes = this.getScrollSizes();
					}
				}
			}
		}
		return sizes;
	},
	onContentPageChange: function(init) {
		var siteBodyRect = this.getSiteBodyRect();
		if (init && !this.widgetResizing) {
			this.dialogSlot.style.top = siteBodyRect.top + "px";
			this.dialogSlot.style.left = siteBodyRect.left + "px";
			this.dialogSlot.style.width = siteBodyRect.width + "px";
			this.dialogSlot.style.height = this._maxHeight + "px";
		}
		if (!this.isOnContentPageChange) {
			this.isOnContentPageChange = true;
			if (this._content) {
				switch (this._content.$facet) {
					case "$lookup":
					case "$select":
						var sizes = this.resizeDialogSlot();
						var scroller = this._content.lookupField && this._content.lookupField.scroller;
						if (scroller && scroller.bodySlot) {
							if (this.widgetResizing || document.site.isResizing) {
								if (sizes.dialog.right > siteBodyRect.right) {
									this.dialogSlot.style.width = (sizes.dialog.width - (sizes.dialog.right - siteBodyRect.right)) + "px";
								}
								if (sizes.dialog.bottom > siteBodyRect.bottom) {
									this.dialogSlot.style.height = (sizes.dialog.height - (sizes.dialog.bottom - siteBodyRect.bottom)) + "px";
								}
							}
							sizes = this.getScrollSizes();
							var diff = scroller.bodySlot.scrollHeight - scroller.bodySlot.clientHeight;
							if (diff > 0 || sizes.space < 0) {
								if (!this.widgetResizing) {
									if (sizes.space < 0) {
										if (siteBodyRect.height > sizes.dialog.height) {
											sizes.space = diff > 0 ? diff : Math.abs(sizes.space);
											this.dialogSlot.style.height = (sizes.dialog.height + Math.min((siteBodyRect.height - sizes.dialog.height), sizes.space)) + "px";
											sizes = this.getScrollSizes();
										}
									}
								} else {
									if (scroller.bodySlot.clientHeight < 40) {
										this.dialogSlot.style.height = (sizes.dialog.height + Math.abs(sizes.space)) + "px";
										sizes = this.getScrollSizes();
									}
								}
								scroller.bodySlot.style.height = (scroller.bodySlot.clientHeight + sizes.space) + "px";
								scroller.onListResize();
							}
						}
						break;
					default:
						var scrollview = this._content.scrollview;
						var scrollTop = scrollview.scrollTop;
						if (scrollview.style.maxHeight) {
							scrollview.style.maxHeight = "";
						}
						var sizes = this.resizeDialogSlot();
						var diff = scrollview.scrollHeight - scrollview.clientHeight;
						if (!this.widgetResizing) {
							if (diff > 0 || sizes.space < 0) {
								if (sizes.space < 0) {
									if (siteBodyRect.height > sizes.dialog.height) {
										sizes.space = diff > 0 ? diff : Math.abs(sizes.space);
										this.dialogSlot.style.height = (sizes.dialog.height + Math.min((siteBodyRect.height - sizes.dialog.height), sizes.space)) + "px";
										sizes = this.getScrollSizes();
									}
									if (sizes.space < 0) {
										scrollview.style.maxHeight = sizes.dialog.inner.height + "px";
										scrollview.scrollTop = scrollTop;
										this._content.resizeArticle();
									}
								}
							}
						} else {
							if (sizes.dialog.right > siteBodyRect.right) {
								this.dialogSlot.style.width = (sizes.dialog.width - (sizes.dialog.right - siteBodyRect.right)) + "px";
							}
							if (sizes.dialog.bottom > siteBodyRect.bottom) {
								this.dialogSlot.style.width = (sizes.dialog.height - (sizes.dialog.bottom - siteBodyRect.bottom)) + "px";
							}
							sizes = this.getScrollSizes();
							if (scrollview.clientHeight > 40 && sizes.space < 0) {
								scrollview.style.maxHeight = sizes.dialog.inner.height + "px";
								scrollview.scrollTop = scrollTop;
								this._content.resizeArticle();
							}
						}
						if (this._content && this._content.resizeSideBars) {
							this._content.resizeSideBars();
						}
						break;
				}
			}
			this.isOnContentPageChange = false;
		}
	},
	getSiteBodyRect: function() {
		var rect = document.site.getBoundingClientRect(document.site.body);
		rect.bounding = {
			top: rect.top,
			bottom: rect.bottom,
			left: rect.left,
			right: rect.right,
			width: rect.width,
			height: rect.height
		};
		rect.left = rect.width * 0.05;
		rect.right -= rect.left;
		rect.width = rect.width - (rect.left * 2);

		rect.top = Math.max(rect.top, 50);

		rect.height = rect.height - (2 * rect.top);
		rect.bottom -= rect.top;
		return rect;
	},
	activate: function(isActivated) {
		this.isDeactivated = !isActivated;
		if (this.overlay) {
			this.overlay.style.display = isActivated ? "" : "none";
		}
		this.dialogSlot.style.display = isActivated ? "" : "none";
	},
	resizeDialog: function(resize, onScroll) {
		if (this._content) {
			if (!onScroll && this.overlay) {
				var areaRect = document.site.getBoundingClientRect(document.site.layoutSlot);
				if (this._content.$isFusionPage) {
					var bodyRect = document.site.getBoundingClientRect(document.site.body);
					this.overlay.style.top = bodyRect.top + "px";
					this.overlay.style.height = bodyRect.height + "px";
				} else {
					this.overlay.style.height = areaRect.height + "px";
				}
				this.overlay.style.width = areaRect.width + "px";
				if (!this.isDeactivated) {
					if (this._content.layoutSlot.style.display !== "none") // manage of multiple window under modal
						this.overlay.style.display = "";
				}
			}
			// in case of too fast move, dialog can be disposed too quickly
			if (!this.disposed && document.site.body) { // && document.site.header) {
				var siteBodyRect = this.getSiteBodyRect();
				this._maxHeight = siteBodyRect.height - siteBodyRect.top;
				if (this._widgetResizer) {
					this._widgetResizer.maxHeight = this._maxHeight;
				}
				if (this.options.position) {
					var dialogRect = document.site.getBoundingClientRect(this.dialogSlot);
					if (dialogRect.width > siteBodyRect.width) {
						this.dialogSlot.style.width = (dialogRect.width = siteBodyRect.width) + "px";
					}
					if (dialogRect.height > this._maxHeight) {
						this.dialogSlot.style.height = (dialogRect.height = this._maxHeight) + "px";
					}
					var $position = {
						my: this.options.position.my,
						at: this.options.position.at,
						of: this.options.position.of,
					};
					var openerPage = this.openerBox && this.openerBox.page;
					if (openerPage && openerPage.scrollview) {
						var isWithIn = true;
						if (this.options.position.of) {
							isWithIn = document.site.isParentNode(openerPage.scrollview, this.options.position.of);
						}
						if (isWithIn) {
							$position.collision = "flipfit";
							$position.within = $(openerPage.scrollview);
						}
					}
					$(this.dialogSlot).position($position);
					if (this.options.onresize) {
						this.options.onresize(this);
					}
					return;
				} else {
					if (this._content) {
						if (this.options.$dialogSize == "content") {
							if (!this.widgetResizing) {
								var siteBodyRect = this.getSiteBodyRect();
								this.dialogSlot.style.height = this.dialogSlot.style.width = "";
								var dialogRect = document.site.getBoundingClientRect(this.dialogSlot);
								this.dialogSlot.style.width = (dialogRect.width = Math.min(dialogRect.width, siteBodyRect.width)) + "px";
								this.dialogSlot.style.height = (dialogRect.height = Math.min(dialogRect.height, siteBodyRect.height)) + "px";
								this.dialogSlot.style.top = (siteBodyRect.bounding.height - dialogRect.height) / 2 + "px";
								this.dialogSlot.style.left = (siteBodyRect.bounding.width - dialogRect.width) / 2 + "px";
							}
							if (this.options.onresize) {
								this.options.onresize(this);
							}
							return;
						} else {
							if (this._content.page && this._content.page.scrollview) {
								this.onContentPageChange(true);
								return;
							}
						}
					}
				}

			} else {
				if (this.options.position) {
					if (this.options.position.left) {
						var position = this.draggedPosition ? this.draggedPosition : this.options.position;
						this.dialogSlot.style.left = position.left;
						this.dialogSlot.style.top = position.top;
					} else {
						$(this.dialogSlot).position({
							my: this.options.position.my,
							at: this.options.position.at,
							of: this.options.position.of
						});
					}
				}
				if (this.options.onresize) {
					this.options.onresize(this);
				}
			}
		}
	},
	onSave: function(menuItem) {
		if (this.options.onSave) {
			return this.options.onSave(menuItem, this);
		}
		return true;
	},
	dispose: function() {
		if (this.overlay) {
			document.site.removeDomChild(this.overlay);
		}
		if (this._widgetResizer) {
			this._widgetResizer.dispose();
			this._widgetResizer = null;
		}
		if (this.$$closeBtn) {
			this.$$closeBtn.unbind();
		}
		this.isDialogPage = true;
		if (this._content) {
			delete this._content.dialogWrapper;
		}
		document.site.dialogManager.close(this);
		if (this.options) {
			this.options.dragSpot = this.options.page = null;
			this._appendAutoClose(false);
			if (this.options.content) {
				delete this.options.content;
			} else {
				document.controller.disposeObject(this._content);
				if (this.dialogSlot) {
					document.site.emptyDom(this.dialogSlot);
				}
			}
			if (this.dialogSlot) {
				document.site.removeDomChild(this.dialogSlot);
			}
			this.options.article = this.options.onValidate = this.options.onSelectRecord = this.options.onresize = null;
		}
		this.okBtn = this.dialogSlot = this.overlay = this._content = this.options = null;
	}
});