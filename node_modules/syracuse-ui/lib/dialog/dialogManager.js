"use strict";
var Dialog = require('./dialog').Dialog;

var _stack = [];

function _open(box, $mode, options) {
	var dlg = new Dialog();
	dlg.isModal = $mode == "modal";
	dlg.$skin = ($mode == "popup") ? "s-popup" : "s-modal";
	dlg.openerBox = box;
	dlg.openerPage = box.page;
	dlg.open(options);
	_stack.push(dlg);
	return dlg;
};
exports.openModeless = function(box, options) {
	return _open(box, "modeless", options);
};
exports.openModal = function(box, options) {
	return _open(box, "modal", options);
};

exports.openPopup = function(box, options) {
	return _open(box, "popup", options);
};

exports.openLookup = function(box, options) {
	options.resizeDialog = function(dlg) {
		var page = dlg._content;
		if (!dlg.isLookupInit) {
			dlg.centerDialog();
			dlg.isLookupInit = true;
		} else {
			var siteBodyRect = dlg.getSiteBodyRect();
			var slot = dlg.dialogSlot;
			var sizes = dlg.resizeDialogSlot();
			var scroller = page.lookupField && page.lookupField.scroller;
			if (scroller && scroller.bodySlot) {
				if (dlg.widgetResizing || document.site.isResizing) {
					if (sizes.dialog.right > siteBodyRect.right) {
						slot.style.width = (sizes.dialog.width - (sizes.dialog.right - siteBodyRect.right)) + "px";
					}
					if (sizes.dialog.bottom > siteBodyRect.bottom) {
						slot.style.height = (sizes.dialog.height - (sizes.dialog.bottom - siteBodyRect.bottom)) + "px";
					}
				}
				sizes = dlg.getScrollSizes();
				var diff = scroller.bodySlot.scrollHeight - scroller.bodySlot.clientHeight;
				if (diff > 0 || sizes.space < 0) {
					if (!dlg.widgetResizing) {
						if (sizes.space < 0) {
							if (siteBodyRect.height > sizes.dialog.height) {
								sizes.space = diff > 0 ? diff : Math.abs(sizes.space);
								slot.style.height = (sizes.dialog.height + Math.min((siteBodyRect.height - sizes.dialog.height), sizes.space)) + "px";
								sizes = dlg.getScrollSizes();
							}
						}
					} else {
						if (scroller.bodySlot.clientHeight < 40) {
							slot.style.height = (sizes.dialog.height + Math.abs(sizes.space)) + "px";
							sizes = dlg.getScrollSizes();
						}
					}
					scroller.bodySlot.style.height = (scroller.bodySlot.clientHeight + sizes.space) + "px";
					scroller.onListResize();
				}
				dlg.centerDialog();
			}
		}

	};
	return exports.openModal(box, options);
};

exports.close = function(dlg) {
	dlg.openerBox = dlg.openerPage = null;
	var index = _stack.indexOf(dlg);
	if (index >= 0) {
		_stack.splice(index, 1);
	}
};
exports.closeAll = function(box, dispose) {
	for (var ii = 0, jj = _stack.length; ii < jj; ii++) {
		var dlg = _stack[ii];
		if (!dlg.disposed && dlg.openerBox == box) {
			dlg.openerBox = dlg.openerPage = null;
			if (!dlg.hasCallback) {
				dlg.close(undefined, dispose);
				_stack.splice(ii, 1);
				ii--;
				jj--;
			}
		}
	}
};

exports.activateAll = function(box, isActivated) {
	for (var ii = 0, jj = _stack.length; ii < jj; ii++) {
		var dlg = _stack[ii];
		if (!dlg.disposed && dlg.openerBox == box) {
			if (dlg._content) {
				exports.activateAll(dlg._content, isActivated);
			}
			dlg.activate(isActivated);
		}
	}
};

exports.closePopups = function(box, event) {
	var site = document.site;
	for (var ii = 0, jj = _stack.length; ii < jj; ii++) {
		var dlg = _stack[ii];
		if (dlg.options && dlg.options.$isAutoClose) {
			if (dlg._content && dlg._content == box) {
				continue;
			}
			if (dlg._content && dlg._content.onBeforeAutoClose && !dlg._content.onBeforeAutoClose(box)) {
				continue;
			}
			if (!event || !(site.isParentNode(dlg.dialogSlot, event.target) ||
				site.isParentNode(dlg.options.autoCloseBoundary, event.target))) {
				dlg.close();
				if (_stack.indexOf(dlg) < 0) {
					ii--;
					jj--;
				}
			}
		}
	}
};

exports.resizePositionedDialogs = function(page) {
	for (var ii = 0, jj = _stack.length; ii < jj; ii++) {
		var dlg = _stack[ii];
		if (!dlg.disposed && dlg.openerPage == page) {
			dlg.resizeDialog(null, true);
		}
	}
};

exports.getTopDialogPage = function() {
	for (var ii = _stack.length - 1; ii >= 0; ii--) {
		if (_stack[ii].isDialogPage) {
			return _stack[ii];
		}
	}
	return null;
};

exports.dispose = function() {
	_stack = null;
};