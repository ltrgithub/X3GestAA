var $ = jQuery;

require('test-runner/deps/jquery/development-bundle/ui/ui.core');
require('test-runner/deps/jquery/development-bundle/ui/ui.accordion');
require('test-runner/deps/jquery/development-bundle/ui/ui.datepicker');
require('test-runner/deps/jquery.flash');

var helpers = require('syracuse-core/lib/helpers');
var controller = require('../squeryController').controller;

$.fn.biView = function(settings){
	var self = this;
	
    var environnement = '0';
    var theDomaine = '0';
    var server = 'famez-test-s08';
    var dataBase = 'demoSl100EP';
    var service = '';
    var port = '';
    var password = '';
    var urlService = '/proxy?service_url=' + escape('famez-test-s08:5555/Sage100EP/recupAmount') + '&service_params=';
    var theTitle = '';
    var nbIndic = '1';
    var nbAxis = '1';
    var indexDimension = '0';
    var indexIndicateur = '0';
    var typeComparaison = '1';
    var modeComparaison = '1';
    var viewRepresentation = '0';
    var P1deb = '01/01/2004';
    var P1fin = '31/12/2009';
    var P2deb = '01/01/2005';
    var P2fin = '31/12/2009';
    var theTri = 'ORDER BY 1 ASC';
    var theCollaborateur = '';
    var theCodeArticle = '';
    var theCompteClient = '';
    var theFournisseur = '';
    var theNatureComptes = '';
    var theNumeroCompte = '';
    var theTypeTiers = '';
    var theDevise = '';
    
    $.ajax({
        type: "GET",
        url: "/syracuse-ui/lib/bi/xml/ventes.xml",
        dataType: "xml",
        success: function(xml){
            $(xml).find('node').find('node').each(function(){
                var index = $(this).attr('index');
                var title = $(this).attr('label');
                var url = $(this).attr('requete');
                $('<input type="checkbox">' + title + '</input >').appendTo('#Div_XML1').click(function(){
                    indexIndicateur = index;
                });
                
            });
        }
    });
    
    $.ajax({
        type: "GET",
        url: "/syracuse-ui/lib/bi/xml/ventes2.xml",
        dataType: "xml",
        success: function(xml){
            $(xml).find('node').find('node').each(function(){
                var index = $(this).attr('index');
                var title = $(this).attr('label');
                var url = $(this).attr('requete');
                $('<input type="checkbox">' + title + '</input >').appendTo('#Div_XML0').click(function(){
                    indexDimension = index;
                });
                
            });
        }
    });
    
    fill();
    
    function initDatePicker(sel){
        $(sel).mousedown(function(){
            $(sel).datepicker({
                minDate: '-36500',
                maxDate: '+36500',
                dateFormat: 'dd/mm/yy',
                firstDay: 1,
                cgangeFirstDay: false
            }).attr("readonly", "readonly");
        });
    }
    
    function changeFlex(){
        $('#composantFlex').empty();
        
        P1deb = $('#maDate1Deb').val();
        P2deb = $('#maDate2Deb').val();
        P1fin = $('#maDate1Fin').val();
        P2fin = $('#maDate2Fin').val();
        
        $('#composantFlex').flash({
            src: '/syracuse-ui/lib/bi/swf/mobiliteEP.swf',
            width: '720',
            height: '500',
            flashvars: {
                environnement: environnement,
                theDomaine: theDomaine,
                server: server,
                dataBase: dataBase,
                service: service,
                port: port,
                password: password,
                urlService: urlService,
                theTitle: theTitle,
                nbIndic: nbIndic,
                nbAxis: nbAxis,
                indexIndicateur: indexIndicateur,
                indexDimension: indexDimension,
                typeComparaison: typeComparaison,
                modeComparaison: modeComparaison,
                viewRepresentation: viewRepresentation,
                P1deb: P1deb,
                P1fin: P1fin,
                P2deb: P2deb,
                P2fin: P2fin,
                theTri: theTri,
                theCollaborateur: theCollaborateur,
                theCodeArticle: theCodeArticle,
                theCompteClient: theCompteClient,
                theFournisseur: theFournisseur,
                theNatureComptes: theNatureComptes,
                theNumeroCompte: theNumeroCompte,
                theTypeTiers: theTypeTiers,
                theDevise: theDevise
            }
        }, {
            version: 9
        });
    };
    
    function fill(){
        self.html('<div id="accordion"></div>' +
        '<div><img border="0" id="execute" src="/syracuse-ui/lib/bi/img/button1B1.jpg" height="20" width="100" alt="Exécuter" align="right"></div>' +
        '<div id="composantFlex"></div>');
        
        $("#accordion").html('<h3><a href="#">Sélectionner vos dimensions</a></h3>' +
        '<div id="Div_XML0"></div>' +
        '<h3><a href="#">Sélectionner vos mesures</a></h3>' +
        '<div id="Div_XML1"></div>' +
        '<h3><a href="#">Sélection votre période</a></h3>' +
        '<div id="Div_Period"></div>' +
        '<h3><a href="#">Sélection du type de représentation </a></h3>' +
        '<div id="Div_Representation"></div>')
        
        $('#Div_Period').html('<form method="POST" action="">' +
        '<p>' +
        'Sélection de vos périodes : ' +
        '<select id="mySelect">' +
        '<OPTION VALUE="Plage">Plage de Date</OPTION>' +
        '<OPTION VALUE="CompPlage">Comparaison Plage de date</OPTION>' +
        '<OPTION VALUE="ComparaionN-1">Comparaison N-1</OPTION>' +
        '<OPTION VALUE="Moisglissant">2 mois glissant</OPTION>' +
        '<OPTION VALUE="autre">Autre</OPTION>' +
        '</select>' +
        '</p>' +
        '</form>' +
        '<table border="0" id="table2">' +
        '<tr><td>P1 : Du</td><td><input id="maDate1Deb" class="date_input" name="maDate1" type="text" value="01/01/2004" /></td>' +
        '<td>Au</td><td><input id="maDate1Fin" class="date_input" name="maDate1" type="text" value="31/12/2004" /></td>' +
        '</tr>' +
        '<tr>' +
        '<td>P2 : Du</td><td><input id="maDate2Deb" class="date_input" name="maDate1" type="text" value="01/01/2005" /></td>' +
        '<td>Au</td><td><input id="maDate2Fin" class="date_input" name="maDate1" type="text" value="31/12/2005" /></td>' +
        '</tr>' +
        '</table>');
        
        $('#Div_Representation').html('<table border="0" id="table1">' +
        '<tr><td><img id="1" src="/syracuse-ui/lib/bi/img/1.png" class="change-representation"/></td>' +
        '<td><img id="4" src="/syracuse-ui/lib/bi/img/3.png" class="change-representation"/></td>' +
        '<td><img id="3" src="/syracuse-ui/lib/bi/img/2.png" class="change-representation"/></td>' +
        '<td><img id="2" src="/syracuse-ui/lib/bi/img/4.png" class="change-representation"/></td>' +
        '<td><img id="5" src="/syracuse-ui/lib/bi/img/5.png" class="change-representation"/></td>' +
        '<td><img id="6" src="/syracuse-ui/lib/bi/img/6.png" class="change-representation"/></td>' +
        '</tr>' +
        '</table>');
        
        
        $.datepicker.setDefaults($.datepicker.regional['fr']);
        initDatePicker('#maDate1Deb');
        initDatePicker('#maDate2Deb');
        initDatePicker('#maDate1Fin');
        initDatePicker('#maDate2Fin');
        
        $("#accordion").accordion({
            collapsible: true
        });
        
        $('.change-representation').click(function(ev){
            viewRepresentation = this.id;
            changeFlex();
        })
        
        $('#execute').click(changeFlex);
    }
	return self;
};
