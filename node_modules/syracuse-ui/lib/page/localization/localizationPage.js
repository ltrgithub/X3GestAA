"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var DesktopPage = require("syracuse-ui/lib/page/desktopPage").DesktopPage;
var localizationPagePrototype = require("./setting/localizationPagePrototype");
var localizationPageArticle = require("./setting/localizationPageArticle");

function LocalizationPage() {}

exports.LocalizationPage = helpers.defineClass(LocalizationPage, DesktopPage, {
	notifyDataChange: function(field, value) {
		// clean diagnoses panel if any
		if (this.diagnosesPanel) {
			this.diagnosesPanel.clean();
		}

		var record = field.articleParent;

		// on locale field value change
		if (field.$item.$bind == '$localeValue') {
			// if locale not set, display err

			if (record.dataset.$localeChoice == 0) {
				this.showErrMsg(document.site.localize.lPageLocaleNotSet, field);
			} else {
				// == update this.$values (which is to be sent on $save action) ==

				// get $localeChoice value corresponding
				var $locale = record.dataset.$localeChoice;

				// set value in $values array
				var index = this.enumLocaleData.enumLocale[$locale].$index;
				this.$values[index].$value = value !== '' ? value : null;

				// update enumLocaleUnset (remove the corresponding locale choice)
				delete this.enumLocaleData.enumLocaleUnset[$locale];

				// add remove link -- set localeChoice state readOnly
				this.applyChange({
					$translations: [{
						$uuid: record.$uuid,
						$index: record.$recordIndex,
						$links: {
							$delete: {
								$isHidden: false
							}
						},
						$properties: {
							$localeChoice: {
								$isReadOnly: true
							}
						}
					}]
				});
			}
		}

		// on locale choice value change
		if (field.$item.$bind == '$localeChoice') {
			// set locale field editable
			this.applyChange({
				$translations: [{
					$uuid: record.$uuid,
					$index: record.$recordIndex,
					$properties: {
						$localeValue: {
							$isEditMode: true
						}
					}
				}]
			});
		}
	},
	_getLocale: function($enum, $enumValue) {
		var $locale;
		for (var ii = 0, jj = $enum.length; ii < jj; ii++) {
			$locale = $enum[ii].$value == $enumValue ? $enum[ii].$locale : $locale;
			if ($locale) {
				break;
			}
		}
		return $locale;
	},
	onMenuClick: function(menuItem) {
		if (menuItem.$bind == '$delete') {
			this._onRemoveLocale(menuItem.articleParent);
			menuItem.onMenuClick = function() {
				return false;
			};
		}
	},
	onSave: function() {

		var $menu = this.$menus.$save;

		if ($menu.$url !== 'test') { // 'test' is $url value for $save link in test page
			var reqOpt = {
				method: $menu.$method,
				$location: {
					$url: $menu.$url
				},
				data: {
					$values: this.$values
				},
				$contentType: "application/json"
			};

			document.controller.sendRequest(null, reqOpt, function(data, response, $url) {
				// assuming client receives data for the underneath page
				if (this.dialogWrapper.options && this.dialogWrapper.options.article) {
					this.dialogWrapper.options.article.applyChange(data);
				}
				this.dialogWrapper.close();
			}, function(error, httpquery) {
				var $diagnoses;
				if (error.data.indexOf("$diagnoses") != -1) {
					$diagnoses = JSON.parse(error.data).$diagnoses;
				} else {
					$diagnoses = [{
						$severity: "error",
						$message: error.data
					}];
				}
				document.site.showDiagnoses({
					$diagnoses: $diagnoses
				}, this);
			});
		}
	},
	_onRemoveLocale: function(record) {
		var list = record.list;
		// on removing record with locale choice set
		if (record.dataset.$localeChoice) {
			// ==  update enumLocaleUnset ==
			var $enum = record.boundFields.$localeChoice[0].$enum;
			var $locale = record.dataset.$localeChoice;

			this.enumLocaleData.enumLocaleUnset[$locale] = {
				$title: this.enumLocaleData.enumLocale[$locale].$title
			};

			// == update this.$values ==
			var index = this.enumLocaleData.enumLocale[$locale].$index;
			this.$values[index].$value = null;

			// == update display ==
			var newData = {
				$translations: [{
					$uuid: record.$uuid,
					$index: record.$recordIndex,
					$isDeleted: true
				}]
			};
			this.applyChange(newData);
		}
	},
	setInitData: function(builder) {
		this.enumLocaleData = builder.getEnumLocaleData(); //enumLocale, enumLocaleSet, enumLocaleUnset
		this.$values = builder.getValues();
		this.builder = builder;
	},
	applyChange: function(newData) {
		// apply change
		DesktopPage.prototype.applyChange.call(this, newData);
		// set non empty locale enum to read-only state
		// set enum list for empty record
		if (this.boundFields && this.boundFields.$translations[0].records) {
			for (var ii = 0, jj = this.boundFields.$translations[0].records.length; ii < jj; ii++) {
				var record = this.boundFields.$translations[0].records[ii];
				if (record.dataset && record.dataset.$localeChoice != undefined) {
					var keys = Object.keys(record.idMap);
					for (var mm = 0, kk = keys.length; mm < kk; mm++) {
						var item = record.idMap[keys[mm]];
						if (item && item.$item && item.$item.$format == '$combo') {
							// set enum list for empty row if enumLocaleUnset defined
							if (record.dataset.$localeChoice == 0 || item.$isEditMode) {
								var keys = Object.keys(this.enumLocaleData.enumLocaleUnset);
								if (keys.length > 0) {
									var $enum = [];
									for (var ff = 0, pp = keys.length; ff < pp; ff++) {
										if (this.enumLocaleData.enumLocaleUnset[keys[ff]]) {
											$enum.push({
												$value: keys[ff],
												$title: this.enumLocaleData.enumLocaleUnset[keys[ff]].$title
											});
										}
									}
									item.builder.setEnum($enum);
								}
							}
						}
					}
				}
			}
		}
	},
	showErrMsg: function(msg, item) {
		this.builder.showErrMsg(msg, item);
	},
	dispose: function() {
		this.builder = this.enumLocaleData = this.$isReadOnly = this.$values = this.newData = null;
		DesktopPage.prototype.dispose.call(this);
	},
	applyShortCuts: function(shortcurts, event, focusField) {
		// /!\ TODO to update when raw#applyShortCuts() will be updated
		var self = this;
		if (!focusField) {
			focusField = (self.focusField && !self.focusField.disposed) ? self.focusField : null;
		}
		if (shortcurts.esc) {
			if (shortcurts.g) {
				if (shortcurts.h) {
					document.site.gotoHome();
				}
				return true;
			}
			if (shortcurts.h || shortcurts.f11) {
				if ((shortcurts.h && (shortcurts.a || shortcurts.r)) || shortcurts.f11) {
					if (self.menuBar) {
						self.menuBar.collapse();
					}
					return true;
				}
				if (event.syraKeyMap == "h") {
					event.returnValue = false;
					if (event.preventDefault) {
						event.preventDefault();
					}
				}
			}
			if (shortcurts.enter) {
				self.clickMainMenu();
				return true;
			}
			if (shortcurts.left || shortcurts.right) {
				self.openNextTab(shortcurts.right);
				return true;
			}
			if (shortcurts.f1) {
				if (focusField) {
					focusField.page.externalAdapter.onFieldClickPicker({
						field: focusField,
						pickerType: "help",
						doEvent: function() {
							self.openHelp(focusField);
						}
					});
				} else {
					self.openHelp();
				}
				return true;
			}
			if (shortcurts["delete"]) {
				(focusField ? focusField.articleParent : self).clickMenu("$delete");
				return true;
			}
			if (shortcurts.insert) {
				var article;
				if (focusField) {
					article = focusField.articleParent;
					while (!article.disposed && (article != article.page) && !article.menuItems.$create) {
						article = article.articleParent;
					}
				}
				(article || self).clickMenu("$create");
				return true;
			}
			if (shortcurts.n) {
				self.clickMenu("$create");
				return true;
			}
			if (shortcurts.p) {
				self.clickMenu("$print");
				return true;
			}
			if (focusField && ((!shortcurts.h && shortcurts.l) || shortcurts.f12)) {
				focusField.clickPicker("lookup");
				return true;
			}
			if (shortcurts.r) {
				var list = self.getLastFocusGrid(focusField);
				var lists = list ? [list] : self.getLists();
				if (lists) {
					for (var ii = 0, jj = lists.length; ii < jj; ii++) {
						var list = lists[ii];
						if (list && list.builder && list.builder.fitToWidth) {
							list.builder.fitToWidth();
						}
					}
				}
				return true;
			}
			if (shortcurts.pagedown || shortcurts.pageup) {
				var list = self.getLastFocusGrid(focusField);
				var lists = list ? [list] : self.getLists();
				if (lists.length == 1 && lists[0].pagging) {
					lists[0].pagging.onShortKeyEvent(shortcurts.pagedown, shortcurts.shift);
				}
				return true;
			}
			if (shortcurts.a) {
				//selectAllGridLines
				// get current grid, we need to have focus at least of an element of the grid
				var list = self.getLastFocusGrid(focusField);
				var lists = list ? [list] : self.getLists();
				if (lists.length == 1 && lists[0].pagging) {
					var range = document.createRange();
					range.selectNode(lists[0].$$item[0]);
					window.getSelection().addRange(range);
				}
				return true;
			}
			if (focusField && (shortcurts.m || shortcurts.f4)) {
				if (shortcurts.shift) {
					focusField = focusField.articleParent;
				}
				if (focusField.menusBox && focusField.menusBox.domTitle) {
					$(focusField.menusBox.domTitle).click();
				}
				return true;
			}
			if (shortcurts.k || shortcurts.j) {
				self.clickMenu(shortcurts.k ? (shortcurts.shift ? "$first" : "$previous") : (shortcurts.shift ? "$last" : "$next"));
				return true;
			}
			if ((shortcurts[":"] && shortcurts.shift) || shortcurts.s || shortcurts.divide) {
				if (document.site.searchField) {
					var $searchFields = document.site.searchField.boundFields.$search;
					if ($searchFields && $searchFields.length) {
						$searchFields[0].focus();
					}
					return true;
				}

			}
		} else {
			if (shortcurts.enter || shortcurts.up || shortcurts.down || shortcurts.tab) {
				return self.navRowList(shortcurts.enter, shortcurts.down, focusField, shortcurts.tab);
			}
		}
		return false;
	},
	navRowList: function(isSelect, isDown, focusField, isTab) {
		// /!\ TODO to update when raw#navRowList() will be updated

		// add a new row on enter if last cell focused
		if ((isSelect || isTab) && focusField) {
			var list = this.getLastFocusGrid(focusField);
			if (focusField.getDataValue() &&
				focusField.$item.$bind == "$localeValue" &&
				focusField.articleParent.$recordIndex == (list.dataset.length - 1) &&
				list.dataset.length < Object.keys(this.enumLocaleData.enumLocale).length) {
				this.applyChange({
					$translations: [{
						$uuid: helpers.uuid.generate(),
						$index: focusField.articleParent.$recordIndex + 1,
						$localeChoice: "",
						$localeValue: "",
						$links: {
							$delete: {
								$isHidden: true
							}
						},
						$properties: {
							$localeValue: {
								$isEditMode: false
							}
						}
					}]
				});
			}
		}

		DesktopPage.prototype.navRowList.call(this, isSelect, isDown, focusField);
	}
});