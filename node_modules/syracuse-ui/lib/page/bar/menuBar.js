"use strict";
var helpers = require('syracuse-core/lib/helpers');
var BarSplitter = require("syracuse-ui/lib/page/bar/barSplitter").BarSplitter;

var _$mainActions = {
	$cube: "$create",
	$query: "$create",
	$details: "$edit",
	$edit: "$save",
	$request: "$invoke"
};


function _addInlinePageMenus(page) {
	page.$item.$menus = [{
		$skin: "s-mn-inline",
		$category: "menus",
		$isMenuPage: true,
		$layout: {
			$items: [{
				$bind: page.$mainAction
			}, {
				$bind: "$abort"
			}]
		}
	}];
	var $actions = page.$prototype.$actions = page.$prototype.$actions || {};
	if (!$actions.$abort) {
		$actions.$abort = {
			$title: syra_local.inlinepage_cancel
		};
	}
	return page.$item.$menus;
}

function _addDefaultPageMenus(page) {
	if (!page.$item.$menus) {
		page.$item.$menus = [{
			$skin: page.$skinMenu || "s-mn-main",
			$category: "menus",
			$isBoxCollapsable: true,
			$isMenusBag: true,
			$layout: {
				$items: []
			}
		}];
		if (page.$mainAction) {
			page.$item.$menus[0].$layout.$items.push({
				$showIfSet: true,
				$bind: page.$mainAction,
				$style: "main"
			});
		}
	} else {
		if (!Array.isArray(page.$item.$menus)) {
			page.$item.$menus = [{
				$isMenusBag: true,
				$layout: {
					$items: syra_page.getDefinedFieldList(page.$item.$menus.$layout.$items)
				}
			}];
		}
	}
	for (var ii = 0, jj = page.$item.$menus.length; ii < jj; ii++) {
		var $menus = page.$item.$menus[ii];
		$menus.$isMenuPage = true;
		$menus.$category = "menus";
		if ($menus.$isBoxCollapsable === undefined) {
			$menus.$isBoxCollapsable = true;
		}
		if ($menus.$skin === undefined) {
			$menus.$skin = page.$skinMenu || "s-mn-main";
		}
	}
	return page.$item.$menus;
}

function _addMenus(page, slot) {
	if (!syra_site.mobileGateway) {
		if (page.isFusionPage && page.$item.$menus && page.$item.$menus.length) {
			page.$item.$menus[0].$isMenusBag = true;
		}
		page.$mainAction = _$mainActions[page.$facet];
		page.loadNewItem(slot, {
			$layoutType: "stack",
			$items: page.inlinePageHost ? _addInlinePageMenus(page) : _addDefaultPageMenus(page)
		}).isMenuBarLayout = true;
	}
}



function MenuBar() {}

exports.MenuBar = helpers.defineClass(MenuBar, BarSplitter, {
	load: function(page) {
		this.preferenceKey = page.isVignettePage ? "vignette-menubar" : "menuBar";
		this.options = this.options || {};
		if (page.inlinePageHost) {
			this.options.$isResizerDisabled = true;
			this.options.resizeDirection = "bottom";
		} else {
			this.options.resizeDirection = (page.$pageCategory == "vignette" || page.$pageCategory == "dashboard") ? "left" : "right";
		}
		this.options.$skin = page.$skin + "-menubar";
		page.initializeNewItem(this);
		this.barSlot = document.createElement("div");
		this.barSlot.className = page.$skin + "-menubar-slot";
		this.barSlot.style.display = "none";

		this.barBody = document.createElement("div");
		this.barBody.className = page.$skin + "-menubar-body";

		if (page.$pageCategory == "vignette" || page.$pageCategory == "dashboard") {
			this.page.domItem.insertBefore(this.barSlot, this.page.domItem.firstChild);
		} else {
			this.page.domItem.appendChild(this.barSlot);
		}
		this.isSlotVisible = false;
		BarSplitter.prototype.load.call(this, page);
		_addMenus(this.page, this.barBody);
	},

	ensureState: function(startResize) {
		if (this.isSlotVisible) {
			BarSplitter.prototype.ensureState.call(this, startResize);
		}
	},
	onMenuDataFilled: function(menuItem) {
		if (!this.isSlotVisible && !this.isHidden) {
			if (menuItem.boxParent.menuGroupRoot) {
				if (menuItem.boxParent.menuGroupRoot.$item.$isMenuPage) {
					this.isSlotVisible = true;
					if (!this.page.designer) {
						this.toggleBar(true);
						this.ensureState();
					}
				}
			}
		}
	},
	toggleBar: function(show) {
		if (!this.isSlotVisible) {
			show = false;
		}
		if (show && this.page.dialogWrapper) {
			if (this.page.isFusionPage) {
				show = this.$facet != "$lookup";
			} else {
				show = false;
			}
		}
		BarSplitter.prototype.toggleBar.call(this, show);
	}
});