"use strict";
var helpers = require("syracuse-core/lib/helpers");
var DesktopPage = require("syracuse-ui/lib/page/desktopPage").DesktopPage;

function SoapPage() {}

helpers.defineClass(SoapPage, DesktopPage, {
	loadBox: function(initData) {
		this.$responseCount = 0;
		this.$item.$layout.$layoutType = "tabs";
		this.$item.$layout.$items[0].$title = "Request";
		DesktopPage.prototype.loadBox.call(this, initData);
	},
	onMenuClick: function(menuItem) {
		if (menuItem.$bind == "$invoke") {
			var self = this;
			if (syra_form.validate(self)) {
				var invokeMenu = self.$prototype.$links.$invoke;
				syra_url.formatMenuUrl(self, menuItem, null, function($url) {
					menuItem.$url = $url;
					syra_http.send({
						page: self,
						url: $url,
						accept: menuItem.$type,
						contentType: menuItem.$contentType,
						data: self.sendBag,
						method: menuItem.$method,
						noDisplayErr: menuItem.noDisplayErr || false,
						success: function(data, response) {
							var newTab = self.layoutContent.createChildItem({
								$title: "Response " + (++self.$responseCount),
								$category: "section",
								$isCloseable: true,
								$isEmptyVisible: true,
								$layout: {
									$items: []
								}
							});
							var $itemPage = {
								layoutSlot: newTab.body,
								$category: "vignette",
								openerUrlSegments: syra_url.parse($url),
								$representation: response.data
							};
							$itemPage.openerUrlSegments.$facet = "$response";
							var initData = $itemPage.$representation.$prototype;
							var databody = initData.body;
							delete initData.body;
							syra_pageBuilder.load($itemPage, function(page) {
								page.masterPage = self;
								delete initData.$description;
								initData.body = databody;
								newTab.openTab();
								page.applyChange(initData);
							});
						},
						error: function(error, response) {
							var data = error && error.data;
							syra_diagnose.showDiagnoses({
								$diagnoses: data && data.length > 0 ? (data.indexOf("$diagnoses") >= 0 ? JSON.parse(data).$diagnoses : [{
									$message: data ? data : syra_local.http_empty_error
								}]) : [{
									$message: syra_local.default_err_msg
								}]
							});
						}
					});
				});
			}
			return false; //not 
		}
		return true;
	}
});

exports.open = function(segments) {
	syra_http.get({
		url: segments.$url,
		success: function(data, response, requestUrl) {
			var $itemPage = {
				layoutSlot: document.createElement("div"),
				$isEditMode: true,
				$pageCategoryClass: SoapPage,
				$representation: data,
				openerUrlSegments: segments
			};
			$itemPage.openerUrlSegments.$facet = "$request";
			$itemPage.openerUrlSegments.fullUrl = document.location.href;
			syra_site.onMainPageChange($itemPage);
		},
		error: function(error, response) {
			var data = error && error.data;
			syra_diagnose.showDiagnoses({
				$diagnoses: data && data.length > 0 ? (data.indexOf("$diagnoses") >= 0 ? JSON.parse(data).$diagnoses : [{
					$message: data ? data : syra_local.http_empty_error
				}]) : [{
					$message: syra_local.default_err_msg
				}]
			});
		}
	});
};