"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RecordArticle = require("syracuse-ui/lib/field/array/recordArticle").RecordArticle;
var LandingPageChild = require('syracuse-ui/lib/page/landing/landingPageChild').LandingPageChild;

function LandingPageRecord() {}

exports.LandingPageRecord = helpers.defineClass(LandingPageRecord, RecordArticle, {
	loadLandingPreferences: function() {
		if (!this.landingPreferences) {
			this.landingPreferences = sessionStorage && sessionStorage.getItem("landingpage_" + this.$uuid);
			this.landingPreferences = (this.landingPreferences && JSON.parse(this.landingPreferences)) || {};
		}
		return this.landingPreferences;
	},
	getVignettePreferences: function(vignetteId) {
		return this.landingPreferences[vignetteId] || {};
	},
	setVignettePreferences: function(vignetteId, preferences) {
		this.landingPreferences[vignetteId] = preferences;
		sessionStorage && sessionStorage.setItem("landingpage_" + this.$uuid, JSON.stringify(this.landingPreferences));
	},
	loadBox: function() {
		this.$defaultSkinSection = this.$defaultSkinBlock = this.list.$item.$skinCard || "s-h3";
		RecordArticle.prototype.loadBox.call(this);
	},
	resizeArticle: function(resize) {
		RecordArticle.prototype.resizeArticle.call(this, resize);
		this.childPage && this.childPage.resizeArticle(resize);
	},
	reorderItem: function(targetRecord, isAfter) {
		if (targetRecord) {
			targetRecord.domItem.parentNode.insertBefore(this.domItem, isAfter ? targetRecord.domItem.nextSibling : targetRecord.domItem);
		} else {
			if (isAfter) {
				this.list.body.appendChild(this.domItem);
			} else {
				this.list.body.insertBefore(this.domItem, this.list.body.firstChild);
			}
		}
	},
	applyChange: function(metaData) {
		RecordArticle.prototype.applyChange.call(this, metaData);
		if (this.dataset.description && this.dataset.description != this.dataset.title) {
			this.domItem.title = this.dataset.description;
		}
		if (this.childPage && metaData && metaData.vignettes) {
			this.loadVignettesInChildPage(metaData.vignettes);
		}
	},
	drawBox: function() {
		this.$useDeletePicker = true;
		this.$item.$isPickerMenuHidden = true;
		this.$mnPickersCss = "s-inplace-picker";
		this.$isVerticalDirection = true;
		this.dataRow = this.domItem = document.createElement("div");
		this.$skin = "s-ldpm-record";
		this.domItem.className = this.$skin;
		this.domItem.setAttribute("data-s-record", this.domItem.syraRecord = this.$uuid);
		this.domItem.syrainout = this.domItem.syraItem = this.id;
		this.dataSlot = this.body = document.createElement("div");
		this.body.className = this.$skin + "-title";
		this.domItem.appendChild(this.body);

		if (!this.list.isRoleList()) {
			this.menusSlot = this.domItem;
			this.list.capabilityMaker.addReorder(this);
		}

		if (this.list.selector.isRowMode) {
			this.body.syraOnClick = "onSelectorClick";
			this.body.className += " s-list-selector-row";
		}
		this.cardItem = this.page.loadNewItem(this.body, {
			$bind: "title",
			$isMenusHidden: true,
			$isDetailLinkDisabled: true,
			$category: "field",
			$isEditMode: this.$isEditMode,
			$inplace: true,
			$css: "s-ldpm-title-field"
		}, this);
		this.list._core.appendChild(this.domItem);
		this.list.capabilityMaker.applyToRecord(this);
	},
	loadVignettesInChildPage: function(vignettes) {
		var $fields = {};
		var $diagnoses = [];
		if (vignettes) {
			this.loadLandingPreferences();
			for (var ii = 0, jj = vignettes.length; ii < jj; ii++) {
				var source = helpers.object.clone(vignettes[ii]);
				if (source.$links && source.$links.$location) {
					var preferences = this.getVignettePreferences(source.bind);
					var $altLocation = preferences && preferences.$location;
					source.$links.$location.$url = syra_site.expressionMaker.parse(this.page, source.$links.$location.$url);
					if ($altLocation) {
						$altLocation.$url = syra_site.expressionMaker.parse(this.page, $altLocation.$url);
					}
					$fields[source.bind] = {
						$vignetteId: source.$uuid,
						$type: "application/x-vignette",
						$title: source.$links.$location.$title,
						$location: source.$links.$location,
						$altLocation: $altLocation
					};
				} else {
					$diagnoses.push({
						$message: syra_local.ldpVignetteNoLocation.replace("{0}", source.bind),
						$severity: "warning"
					});
				}
			}
		}
		if ($diagnoses.length) {
			this.page.showDiagnoses({
				$diagnoses: $diagnoses
			});
		}
		if (!this.childPage) {
			this.childPage = syra_site.pageLoader.load({
				$pageCategoryClass: LandingPageChild,
				layoutSlot: this.page.childSlot,
				$category: "dashboard",
				openerUrlSegments: this.page.openerUrlSegments,
				$representation: {
					$prototype: {
						masterRecord: this,
						$title: this.dataset.title,
						$properties: $fields
					},
					$article: (this.dataset.stdLayout && this.dataset.stdLayout.content) || null
				}
			});
		} else {
			this.childPage.applyVignettesChange($fields);
		}
		return this.childPage;
	},
	getSaveDesignLink: function() {
		var stdLayout = this.$prototype.$properties.stdLayout;
		return stdLayout && stdLayout.$item && stdLayout.$item.$links && stdLayout.$item.$links.$save;
	},
	dispose: function() {
		if (this.page && this.page.selectedPageRecord == this) {
			this.list.showRecordSelection(this, false);
		}
		if (this.childPage) {
			this.removeItem(this.childPage, true);
		}
		this.childPage = this.cardItem = this.dataSlot = this.body = this.menusSlot = this.dataRow = null;
		RecordArticle.prototype.dispose.call(this);
	}
});