"use strict";
var helpers = require("syracuse-core/lib/helpers");
var DesktopPage = require('syracuse-ui/lib/page/desktopPage').DesktopPage;
var MenuBar = require('syracuse-ui/lib/page/bar/menuBar').MenuBar;

var _step2, _modules, _categories, _vignettes;
var _gadgetTypes = ["requests", "processes", "stats", "representation", "calendar", "extLink"];

function _addBlock(slot, $title) {
	var block = document.createElement("div");
	block.className = "s-sv-wiz-step-block";

	var title = document.createElement("label");
	title.className = "s-sv-wiz-step-block-title";
	title.textContent = $title;
	block.appendChild(title);

	var body = document.createElement("div");
	body.className = "s-sv-wiz-step-body";
	block.appendChild(body);
	slot.appendChild(block);
	return {
		block: block,
		title: title,
		body: body
	};
}

function _addStep1(page) {
	var step = document.createElement("div");
	step.className = "s-sv-wiz-step";

	var box = _addBlock(step, syra_local.ldpSelectEndpoint);
	page.loadNewItem(box.body, {
		$isTitleHidden: true,
		$bind: "endpoint"
	});


	var box = _addBlock(step, syra_local.ldpBrowseCategory);
	var rowCount = 0;
	for (var ii = 0, jj = _gadgetTypes.length; ii < jj; ii++) {
		page.loadNewItem(box.body, {
			$category: "link",
			$bind: _gadgetTypes[ii],
			$css: "s-sv-type-link s-sv-type-" + _gadgetTypes[ii],
			$skin: "s-sv-type-skin"
		});
		if (++rowCount == 3) {
			rowCount = 0;
			var sep = document.createElement("div");
			sep.className = "s-sv-wiz-cat-sep";
			box.body.appendChild(sep);
		}
	}
	return step;
}

function _addStep2(page) {
	_step2 = {};
	var step = document.createElement("div");
	step.className = "s-sv-wiz-step";

	var box = _addBlock(step, syra_local.ldpNoVignetteFounds);
	page.loadNewItem(box.body, {
		$bind: "selectedEndpoint",
		$isHidden: true
	});
	page.loadNewItem(box.body, {
		$bind: "$searchVignetteField",
		$isTopLabelAlignment: false,
		$isHidden: true
	});
	page.loadNewItem(box.body, {
		$category: "field",
		$bind: "selectedVignettes",
		$isTitleHidden: false,
		$clientId: "s-sv-selectedvignettes",
		$noDataText: syra_local.ldpNoVignetteSelected,
		$isHidden: true
	});


	var box = _addBlock(step, syra_local.ldpNoVignetteFounds);
	page.loadNewItem(box.body, {
		$bind: "$searchVignetteResult"
	});

	_step2.categories = _addBlock(step, "");

	return step;
}



function _gotoPage2(page, show) {
	return;
	page.idMap["s-sv-page-2"].setState({
		$isHidden: !show
	});
	page.idMap["s-sv-page-1"].setState({
		$isHidden: show
	});
}

function _updateBrowseViewDisplay(page, show) {
	syra_site.dom.empty(_step2.categories.body);
	_step2.categories.body.appendChild(page.browseView);
}

function _onVignetteAdd(page, vignette) {
	page.selectedVignettes.push({
		vignette: vignette,
		endpoint: {
			$uuid: page.selectedEndpoint.$uuid
		}
	});
	page.dialogWrapper.hideOkButton(false);
}

function _findSelectedVignette(page, $uuid) {
	for (var ii = 0, jj = page.selectedVignettes.length; ii < jj; ii++) {
		var sel = page.selectedVignettes[ii];
		if ((sel.vignette.$key || sel.vignette.$uuid) == $uuid) {
			return sel;
		}
	}
	return null;
}

function _formatResourcesData($dataResources) {
	var $resources = [];
	for (var ii = 0, jj = $dataResources.length; ii < jj; ii++) {
		var res = $dataResources[ii];
		res.properties = "";
		if (res.module) {
			var span = document.createElement("span");
			span.className = "s-sv-search-res-mod-value";
			span.textContent = res.module;
			res.properties += span.outerHTML + " | ";
		}
		if (res.categories) {
			for (var mm = 0, pp = res.categories.length; mm < pp; mm++) {
				var span = document.createElement("span");
				span.className = "s-sv-search-res-cat-value";
				span.textContent = res.categories[mm];
				res.properties += span.outerHTML;
				res.properties += mm == pp - 1 ? "" : " | ";
			}
		}
		$resources.push(res);
	}
	return $resources;
}

function _buildBrowseView(page) {
	// dispose values
	page.selectedModId = page.selectedModLink = page.selectedCatId = page.selectedCatLink = null;

	// browse content slot
	page.browseLayout = document.createElement("div");
	page.browseLayout.className = "s-sv-browse-layout";

	// modules layout
	page.browseLayout.appendChild((_modules = _addLevel("s-sv-browse-modules", syra_local.ldpModulesTitle)).slot);
	_modules.header.className += " s-active";

	// append separator
	var sep = document.createElement("div");
	sep.className = "s-sv-browse-sep";
	page.browseLayout.appendChild(sep);

	// append modules
	var modKeys = Object.keys(page.vignetteData.modules);
	// sort alphabetical order
	var self = page;
	modKeys.sort(function(itemA, itemB) {
		if (self.vignetteData.modules[itemA].title > self.vignetteData.modules[itemB].title)
			return self.vignetteData.modules[itemB].title == syra_local.ldpNoModule ? -1 : 1;
		if (self.vignetteData.modules[itemA].title < self.vignetteData.modules[itemB].title)
			return self.vignetteData.modules[itemA].title == syra_local.ldpNoModule ? 1 : -1;
		return 0;
	});

	for (var ii = 0, jj = modKeys.length; ii < jj; ii++) {
		var modKey = modKeys[ii];
		var btn = syra_menus.addTextButton(page.vignetteData.modules[modKey].title, "s-sv-browse-item", "onModuleClick");
		btn.syrainout = page.id;
		btn.setAttribute("sv-module-id", modKey);
		btn.title = page.vignetteData.modules[modKey].code || "";
		_modules.body.appendChild(btn);
		var modIcon = document.createElement("div");
		modIcon.className = "s-sv-browse-module-icon";
		modIcon.setAttribute("style", "background-image: url('/syracuse-ui/themes/desktop/sage/images/modules/s_module_" + (page.vignetteData.modules[modKey].code || "no_code").toLowerCase() + ".png')");
		btn.insertBefore(modIcon, btn.firstChild);
	}


	// categories layout
	page.browseLayout.appendChild((_categories = _addLevel("s-sv-browse-categories", syra_local.ldpCategoriesTitle)).slot);
	// append separator (2)
	var sep = document.createElement("div");
	sep.className = "s-sv-browse-sep";
	page.browseLayout.appendChild(sep);

	// vignettes layout
	page.browseLayout.appendChild((_vignettes = _addLevel("s-sv-browse-vignettes", syra_local.ldpVignettesTitle)).slot);

	return page.browseLayout;
}

function _addLevel($skin, $title) {
	var level = {
		slot: document.createElement("div"),
		header: document.createElement("div"),
		body: document.createElement("div"),
	};
	level.slot.className = $skin;
	level.header.className = "s-sv-browse-vignettes-header";
	level.header.textContent = $title;
	level.slot.appendChild(level.header);

	level.body.className = "s-sv-browse-vignettes-body";
	level.slot.appendChild(level.body);
	return level;
}


function _updatePage(page, data, isSearchRequest) {
	page.startChange();
	if (isSearchRequest) {
		var $resources = _formatResourcesData(data.$resources);
		data.$searchResult = data.$resources;
		delete data.$resources;
		page.boundFields.$searchVignetteResult[0].vignette.applyChange(data);
		page._applySelectedStyle();
		var searchPage = page.boundFields.$searchVignetteResult[0].vignette;
		searchPage.checkFacetBarVisibility();
	} else {
		var newData = {
			$searchVignetteField: "",
			selectedEndpoint: page.selectedEndpoint,
			$properties: {
				$searchVignetteField: {
					$isHidden: false
				}
			}
		};
		page.applyChange(newData);
		page._buildBrowseData(data);
		page.browseView = _buildBrowseView(page);
	}
	_updateBrowseViewDisplay(page, !isSearchRequest);
	page.endChange();
}

function LandingVignetteSelect() {}

exports.LandingVignetteSelect = helpers.defineClass(LandingVignetteSelect, DesktopPage, {
	onItemInOut: function(onEnter, event, target) {
		if (target.className.indexOf("s-sv-browse-item") >= 0) {
			syra_site.dom.toggleClass(target, "s-record-enter", onEnter);
		} else {
			DesktopPage.prototype.onItemInOut.call(this, onEnter, event, target);
		}
	},
	fetch: function(options) {
		if (options && options.isPageLoading) {
			options.method = "POST";
			DesktopPage.prototype.fetch.call(this, options);
		} else {
			var self = this;
			options.method = options.method || "GET";
			options.$location = options.$location || {
				$url: this.requestUrlComplete
			};
			this.sendRequest(undefined, undefined, function(data) {
				_updatePage(self, data, true);
			}, options);
		}
	},
	onErrorHandler: function(error) {
		var $diagnoses;
		if (error.data.indexOf("$diagnoses") != -1) {
			$diagnoses = JSON.parse(error.data).$diagnoses;
		} else {
			$diagnoses = [{
				$severity: "error",
				$message: error.data
			}];
		}
		syra_site.showDiagnoses({
			$diagnoses: $diagnoses
		});
	},
	sendRequest: function(method, url, onSuccess, options) {
		var self = this;
		syra_controller.sendRequest(this, options || {
			method: method || "GET",
			$location: {
				$url: url
			}
		}, onSuccess, self.onErrorHandler);
	},
	getPrototype: function() {
		this.selectedVignettes = []; // adding prototype properties for search field and results page
		if (this.$prototype && this.$prototype.$properties) {
			this.$prototype.$properties.$searchVignetteField = {
				$type: "application/x-string",
				$title: syra_local.ldpSearch
			};
			this.$prototype.$properties.selectedEndpoint = this.$prototype.$properties.endpoint;
			this.$prototype.$properties.selectedVignettes = {
				$type: "application/x-array",
				$title: syra_local.ldpSelectedVignettes,
				$item: {
					$type: "application/x-string"
				}
			};
			this.$prototype.$properties.$searchVignetteResult = {
				$type: "application/x-vignette",
				$format: "$page",
				$isLandingSearchVignette: true,
				$prototype: {
					$properties: {
						$searchResult: {
							$type: "application/x-array",
							$item: {
								$type: "application/json",
								$properties: {
									title: {
										$title: syra_local.ldpSearchResultTitle,
										$type: "application/x-string",
										$format: "$html",
										$links: {
											$details: {}
										}
									},
									properties: {
										$type: "application/x-string",
										$format: "$html"
									}
								}
							}
						}
					},
					$article: {
						$isTitleHidden: true,
						$skin: "s-sv-vignette",
						$layout: {
							$layoutType: "stack",
							$items: [{
								$bind: "$searchResult",
								$isMenuRecordHidden: true,
								$noDataText: syra_local.search_no_res,
								$format: "cards",
								$alternateStyle: false,
								$skin: "s-sv-search-res",
								//$selectMode: "row",
								$layout: {
									$items: [{
										$bind: "title",
										$isTitleHidden: true,
										$skin: "s-sv-search-res-title"
									}, {
										$isTitleHidden: true,
										$skin: "s-sv-search-class",
										$bind: "properties"
									}]
								}
							}]
						}
					}
				}
			};
		};
		delete this.$prototype.$description; // in order not to display description text value
		return this.$prototype;
	},

	onBackClick: function() {
		this.startChange();
		this.backBtn.style.display = "none";
		this.applyChange({
			$properties: {
				$searchVignetteField: {
					$isHidden: true
				},
				selectedEndpoint: {
					$isHidden: true
				}
			}
		});
		_gotoPage2(this, false);
		_updateBrowseViewDisplay(this);
		this.endChange();
	},
	onMenuClick: function(menu) {
		var self = this;
		if (_gadgetTypes.indexOf(menu.$bind) >= 0) {
			_step2.categories.title.title = _step2.categories.title.textContent = menu.getTitle();
			self.requestUrl = menu.$searchUrl || menu.$url;
			self.sendRequest(menu.$method, menu.$url, function(data) {
				if (!self.backBtn) {
					self.backBtn = syra_menus.addIconButton(syra_local.ldpBack, "s-sv-back-link", "onBackClick", null, "reload_back");
					self.titleLabel.parentNode.insertBefore(self.backBtn, self.titleLabel);
				}
				self.backBtn.style.display = "";
				_gotoPage2(self, true);
				_updatePage(self, data);
			});
			return false;
		}

		if (menu.$item && menu.$item.$bind == "$detail") {
			if (_findSelectedVignette(this, menu.articleParent.dataset.$key || menu.articleParent.dataset.$uuid)) {
				this._onVignetteRemove(menu.articleParent.dataset.$key || menu.articleParent.dataset.$uuid);
				syra_site.dom.toggleClass(menu.articleParent.domItem, "s-list-record-selected");
				// update vignette categories and module info style
				this._updatePropertiesStyle(menu.articleParent, false, true);
			} else {
				_onVignetteAdd(this, menu.articleParent.dataset);
				syra_site.dom.toggleClass(menu.articleParent.domItem, "s-list-record-selected", true);
				// update vignette categories and module info style
				this._updatePropertiesStyle(menu.articleParent, true, true);
			}
		}
		return false;
	},
	_updatePropertiesStyle: function(record, selected, onClick) {
		if (record.boundFields.properties[0]._dataValue.children.length > 0) {
			var children = record.boundFields.properties[0]._dataValue.children;
			for (var ii = 0, jj = children.length; ii < jj; ii++) {
				syra_site.dom.toggleClass(children[ii], "s-list-record-selected", selected);
			}
			if (onClick) {
				record.$isSelected = selected;
			}
		}
	},
	onModuleClick: function(event, btn) {
		this.selectedCatId = null;
		var modId = btn.getAttribute("sv-module-id");
		if (!this.selectedModId || (this.selectedModId != modId)) {
			syra_site.dom.toggleClass(_modules.header, "s-active", true);
			syra_site.dom.toggleClass(_categories.header, "s-active");
			syra_site.dom.toggleClass(_vignettes.header, "s-active");
			// update selected css
			if (this.selectedModId) {
				syra_site.dom.toggleClass(this.selectedModLink, "s-list-record-selected");
			}
			syra_site.dom.toggleClass(btn, "s-list-record-selected", true);
			this.selectedModId = modId;
			this.selectedModLink = btn;
			syra_site.dom.empty(_categories.body);
			syra_site.dom.empty(this.vignettesLayoutBody);
			var categories = this.vignetteData.modules[modId].categories;
			var catKeys = Object.keys(categories);

			// sort alphabetical order
			catKeys.sort(function(itemA, itemB) {
				if (categories[itemA].description > categories[itemB].description)
					return categories[itemB].description == syra_local.ldpNoCategory ? -1 : 1;
				if (categories[itemA].description < categories[itemB].description)
					return categories[itemA].description == syra_local.ldpNoCategory ? 1 : -1;
				return 0;
			});

			for (var ii = 0, jj = catKeys.length; ii < jj; ii++) {
				var btn = syra_menus.addTextButton(this.vignetteData.modules[modId].categories[catKeys[ii]].description, "s-sv-browse-item", "onCategoryClick");
				btn.syrainout = this.id;
				btn.setAttribute("sv-category-id", catKeys[ii]);
				_categories.body.appendChild(btn);
			}
		}
		this.endChange();
	},
	onCategoryClick: function(event, btn) {
		var catId = btn.getAttribute("sv-category-id");
		if (!this.selectedCatId || this.selectedCatId != catId) {
			syra_site.dom.toggleClass(_modules.header, "s-active");
			syra_site.dom.toggleClass(_categories.header, "s-active", true);
			// update selected css
			if (this.selectedCatId) {
				syra_site.dom.toggleClass(this.selectedCatLink, "s-list-record-selected");
			}
			syra_site.dom.toggleClass(btn, "s-list-record-selected", true);
			this.selectedCatId = catId;
			this.selectedCatLink = btn;
			syra_site.dom.empty(_vignettes.body);
			var vignettes = this.vignetteData.modules[this.selectedModId].categories[catId].$vignettes;

			// sort alphabetical order
			vignettes.sort(function(itemA, itemB) {
				if (itemA.title > itemB.title)
					return 1;
				if (itemA.title < itemB.title)
					return -1;
				return 0;
			});

			for (var ii = 0, jj = vignettes.length; ii < jj; ii++) {
				var vignette = vignettes[ii];
				var btn = syra_menus.addTextButton(vignette.title || syra_local.ldpNoTitle, "s-sv-browse-item", "onVignetteClick");
				btn.syrainout = this.id;
				if (_findSelectedVignette(this, vignette.$key || vignette.$uuid)) {
					syra_site.dom.toggleClass(btn, "s-list-record-selected", true);
				}
				btn.setAttribute("sv-vignette-id", vignette.$key || vignette.$uuid);
				btn.title = vignette.code;
				_vignettes.body.appendChild(btn);
			}
		}
		this.endChange();
	},
	onVignetteClick: function(event, btn) {
		syra_site.dom.toggleClass(_modules.header, "s-active");
		syra_site.dom.toggleClass(_categories.header, "s-active");
		syra_site.dom.toggleClass(_vignettes.header, "s-active", true);
		var isSelected = btn.className.indexOf("s-list-record-selected") >= 0;
		syra_site.dom.toggleClass(btn, "s-list-record-selected", !isSelected);
		var vignetteId = btn.getAttribute("sv-vignette-id");
		if (!isSelected) {
			var vignettes = this.vignetteData.modules[this.selectedModId].categories[this.selectedCatId].$vignettes;
			for (var ii = 0, jj = vignettes.length; ii < jj; ii++) {
				if ((vignettes[ii].$key || vignettes[ii].$uuid) == vignetteId) {
					_onVignetteAdd(this, vignettes[ii]);
					break;
				}
			}
		} else {
			this._onVignetteRemove(vignetteId);
		}
		//this.endChange();
	},

	_onVignetteRemove: function(vignetteId) {
		var selected = _findSelectedVignette(this, vignetteId);
		if (selected) {
			this.selectedVignettes.splice(this.selectedVignettes.indexOf(selected), 1);
		}
		this.dialogWrapper.hideOkButton(!this.selectedVignettes.length);
	},
	onNotifyDataChange: function(field, value) {
		var self = this;
		switch (field.$item.$bind) {
			case "$searchVignetteField":
				if (value != '') {
					// change count value
					this.requestUrlComplete = this.requestUrl.replace(/(count=)\d+(.+)/g, "$120$2") + ("&search=" + value);
					this.sendRequest("GET", this.requestUrlComplete, function(data) {
						_updatePage(self, data, true);
					});
				} else {
					this.endChange();
				}
				return false;
			case "endpoint":
				this._updateSelectedEndpoint(value);
				return true;
			default:
				return true;
		}
	},
	applyChange: function(newData) {
		if (newData && newData.endpoint) {
			this._updateSelectedEndpoint(newData.endpoint);
		}
		DesktopPage.prototype.applyChange.call(this, newData);
	},

	_applySelectedStyle: function() {
		var records = this.boundFields.$searchVignetteResult[0].vignette.boundFields.$searchResult[0].records;
		for (var ii = 0, jj = records.length; ii < jj; ii++) {
			var record = records[ii];
			if (_findSelectedVignette(this, record.dataset.$key)) {
				syra_site.dom.toggleClass(record.domItem, "s-list-record-selected", true);
				this._updatePropertiesStyle(record, true, true);
			}
		}
	},

	_updateSelectedEndpoint: function(endpoint) {
		this.selectedEndpoint = endpoint;
		syra_site.dom.empty(this.securityViewSlot);
		if (endpoint) {
			this.securityViewSlot.appendChild(syra_menus.addFontIconText(endpoint.$value || endpoint.description, "s-security-user", "endpoint"));
		}
	},
	updateFilterState: function(options) {
		this.jsonParams = options.jsonParams;
		options.method = "GET";
	},

	_buildBrowseData: function(data) {
		// build browse data
		this.vignetteData = {
			modules: {}
		};
		for (var ii = 0, jj = data.$resources.length; ii < jj; ii++) {

			var resource = data.$resources[ii];
			var noCategoryKey = "noCategory";
			var noModuleKey = "noModule";
			var moduleKey = resource.module && (resource.module.$key || resource.module.$uuid) || noModuleKey;
			var hasCategories = resource.categories && resource.categories.length > 0;

			if (!this.vignetteData.modules[moduleKey]) {
				this.vignetteData.modules[moduleKey] = resource.module || {
					title: syra_local.ldpNoModule
				};
				this.vignetteData.modules[moduleKey].categories = {};
			}

			if (!hasCategories) {
				if (!this.vignetteData.modules[moduleKey].categories[noCategoryKey]) {
					this.vignetteData.modules[moduleKey].categories[noCategoryKey] = {
						$uuid: noCategoryKey,
						$vignettes: [],
						description: syra_local.ldpNoCategory
					};
				}
				this.vignetteData.modules[moduleKey].categories[noCategoryKey].$vignettes.push(resource);
			} else {
				for (var mm = 0, pp = resource.categories.length; mm < pp; mm++) {
					var category = resource.categories[mm];
					if (!this.vignetteData.modules[moduleKey].categories[category.$uuid]) {
						this.vignetteData.modules[moduleKey].categories[category.$uuid] = category;
						this.vignetteData.modules[moduleKey].categories[category.$uuid].$vignettes = [];
					}
					this.vignetteData.modules[moduleKey].categories[category.$uuid].$vignettes.push(resource);
				}
			}

		}

		if (data.$totalResults && data.$itemsPerPage && (data.$totalResults > data.$itemsPerPage)) {
			//TODO show info diagnose only $itemPerPage results considered. Use search feature for complete list
		}
	},
	_ensureMenus: function() {
		this.menuBar = new MenuBar();
		this.menuBar.options = {
			$isResizerDisabled: true
		};
		this.menuBar.load(this);
	},
	ensureDefaultArticle: function($article, $prototype) {
		$prototype.$title = syra_local.ldpAddNewVignette;
		return {
			$layout: {
				$items: []
			}
		};
	},
	drawBox: function() {
		DesktopPage.prototype.drawBox.call(this);
		this.layoutContent.domItem.appendChild(_addStep1(this));
		this.layoutContent.domItem.appendChild(_addStep2(this));
	}

});