"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DesktopPage = require('syracuse-ui/lib/page/desktopPage').DesktopPage;
var LandingPageBar = require('./master/landingPageBar').LandingPageBar;
var LandingPageList = require('./master/landingPageList').LandingPageList;

function LandingPageMaster() {}

exports.LandingPageMaster = helpers.defineClass(LandingPageMaster, DesktopPage, {
	designArticle: function() {},
	onExecuteMenuResponse: function(menuItem, responseData) {
		if (menuItem.$bind == "$delete") {
			var record = menuItem.articleParent;
			var list = record.list;
			list.removeRecord(record, true, true);
			if (list.records.length == 0) {
				list.emptyBody(true);
			}
			if (!this.selectedPageRecord) {
				this.ensureChildPageSelection();
			}
		}
		DesktopPage.prototype.onExecuteMenuResponse.call(this, menuItem, responseData);
	},
	getChildPageItem: function(childPage) {
		var $article = helpers.object.clone(childPage.$item, true);
		delete $article.$menus;
		delete $article.$isModel;
		var $lastItem = $article.$layout.$items[$article.$layout.$items.length - 1];
		if ($lastItem && $lastItem.$isAddLandingTab) {
			$article.$layout.$items.splice($article.$layout.$items.length - 1, 1);
		}
		return $article;
	},
	saveDesignUpdate: function(childPage) {
		var self = this;
		var sendBag = {
			$etag: 1,
			$url: childPage.masterRecord.formatMenuUrl(childPage.masterRecord.getSaveDesignLink()),
			content: self.getChildPageItem(childPage)
		};
		document.controller.sendRequest(self, {
			$location: {
				$url: sendBag.$url
			},
			data: sendBag,
			method: "PUT",
			$etag: sendBag.$etag
		}, function(data, response, requestUrl) {
			if (!self.disposed) {
				//debugger;

			}
		});
	},
	deleteVignettes: function(record, $uuids) {
		var sendBag = this.ensureSendBag(record);
		sendBag.vignettes = sendBag.vignettes || [];
		for (var ii = 0, jj = $uuids.length; ii < jj; ii++) {
			sendBag.vignettes.push({
				$isDeleted: true,
				$uuid: $uuids[ii]
			});
		}
		for (var ii = 0, jj = record.dataset.vignettes.length; ii < jj; ii++) {
			if ($uuids.indexOf(record.dataset.vignettes[ii].$uuid) >= 0) {
				record.dataset.vignettes.splice(ii, 1);
				ii--;
				jj--;
			}
		}
		record.loadVignettesInChildPage(record.dataset.vignettes);
		sendBag.content = this.getChildPageItem(record.childPage);
		this.notifyChangeToServer(sendBag, record);
	},
	onDeleteVignetteClick: function(vignetteField) {
		var self = this;
		document.site.showMessage({
			$title: self.localize.landingVignetteDeleteTitle,
			$message: self.localize.landingVignetteDeleteConfirm.replace("{0}", vignetteField.getTitle()),
			$type: "question",
			callback: function(response) {
				if (response && response.$clientId === "yes") {
					self.deleteVignettes(vignetteField.page.masterRecord, [vignetteField.$field.$vignetteId]);
				}
			}
		});
	},
	addVignette: function(childPage) {
		var self = this;
		var $url = childPage.masterRecord.formatMenuUrl(childPage.getAddVignetteDefinition(), childPage.masterRecord);
		self.openDialog({
			article: self,
			$url: $url,
			$isOkHidden: true,
			onValidate: function(searchPage) {
				if (searchPage.selectedVignettes) {
					var sendBag = self.ensureSendBag(self.selectedPageRecord);
					sendBag.vignettes = sendBag.vignettes || [];
					var $serverIndex = self.selectedPageRecord.dataset.vignettes.length + sendBag.vignettes.length;
					var selectedVignettes = helpers.object.clone(searchPage.selectedVignettes, true);
					for (var ii = 0, jj = selectedVignettes.length; ii < jj; ii++) {
						selectedVignettes[ii].$index = $serverIndex++;
						sendBag.vignettes.push(selectedVignettes[ii]);
					}
					self.notifyChangeToServer(sendBag, self.selectedPageRecord, true);
				}
			}
		});
	},
	ensureReorderAndMenusVisibility: function(item, event, useCssForMenus) {
		if (useCssForMenus) {
			this.toggleCssOnEnter(item.menusSlot, event);
		} else {
			this.showOnEnter(item.menusSlot, event);
		}
		this.showOnEnter(item.reorderPicker, event);
	},
	onBarEvent: function(picker, event) {
		if (picker.className.indexOf("s-ldpm-bar") >= 0) {
			this.bar.onClickPicker(picker, event);
		} else {
			DesktopPage.prototype.onBarEvent.call(this, picker, event);
		}
	},
	getDataUrl: function(article) {
		article = article || this;
		var $parsedUrl = article.parseExpression(article.dataset.$url || article.$prototype.$url);
		return $parsedUrl || this.$prototype.$representationUrl;
	},
	notifyChangeToServer: function(sendBag, articleSender, onAdd) {
		var self = this;
		articleSender = articleSender || this;
		if (!self.disposed && !self.isServerNotifyDisabled) {
			if (self.$prototype.$representationUrl) {
				sendBag.$url = self.getDataUrl(articleSender);
				sendBag.$etag = articleSender.dataset.$etag;
				document.controller.sendRequest(self, {
					$location: {
						$url: self.getDataUrl(articleSender)
					},
					data: sendBag,
					method: "PUT",
					$etag: sendBag.$etag
				}, function(newData, response, requestUrl) {
					if (!articleSender.disposed) {
						if (articleSender.page != articleSender) {
							articleSender.page.ensureDeltaManager().applyObjectDelta(articleSender.dataset, newData);
						}
						articleSender.applyChange(newData, response, requestUrl);
						self.ensurePageVisibility();
						if (onAdd) {
							self.saveDesignUpdate(articleSender.childPage);
						}

					}
				});
			}
		}
	},
	_ensureMenus: function() {

	},
	ensureDefaultArticle: function($article, $prototype) {
		return {
			$layout: {
				$items: []
			}
		};
	},
	createField: function($field, $item, boxParent, $class) {
		switch ($item.$bind) {
			case "rolePages":
			case "userPages":
				return (this[$item.$bind] = new LandingPageList());
		}
		return null;
	},
	ensureDesignerOpenerVisibility: function() {
		document.site.enablePageDesign(false);
	},
	getPreferences: function() {
		return this.preferences = document.site.getPreferences("landingpage", {});
	},
	setPreferences: function($selected) {
		(this.preferences = this.preferences || {}).$selected = $selected;
		document.site.setPreferences("landingpage", this.preferences);
	},
	loadBox: function(initData, $initDiagnoses) {
		this.isAutoInsertFieldDisabled = true;
		this.$isEditMode = true;
		this.$skin = this.$item.$skin || "s-ldpm-page";
		this.$defaultSkinSection = this.$defaultSkinBlock = "s-ldpm-page-h1";
		this.$autoFetch = false;
		var data = {};
		if (initData) {
			var $keys = Object.keys(initData);
			for (var ii = 0, jj = $keys.length; ii < jj; ii++) {
				if ($keys[ii] != "$prototype" && $keys[ii] != "$article") {
					data[$keys[ii]] = initData[$keys[ii]];
				}
			}
		}
		DesktopPage.prototype.loadBox.call(this, data, $initDiagnoses);
		this.childSlot = document.createElement("div");
		this.childSlot.className = "s-ldpm-child-slot";
		this.layoutContent.domItem.appendChild(this.childSlot);
		(this.bar = new LandingPageBar()).load(this);
		this.ensureChildPageSelection();
		this.ensurePageVisibility();
	},
	ensureChildPageSelection: function(ignoreLastSelected) {
		var $uuid = (!ignoreLastSelected) ? (this.getPreferences().$selected || this.dataset.$selected) : undefined;
		if (!$uuid) {
			$uuid = this.userPages.dataset && this.userPages.dataset.length && this.userPages.dataset[0].$uuid;
			if (!$uuid) {
				$uuid = this.rolePages.dataset && this.rolePages.dataset.length && this.rolePages.dataset[0].$uuid;
			}
		}
		if ($uuid) {
			if (this.rolePages.recordsMap[$uuid]) {
				this.userPages.selector.select(null, false);
				this.rolePages.selector.select($uuid, true);
			} else {
				if (this.userPages.recordsMap[$uuid]) {
					this.rolePages.selector.select(null, false);
					this.userPages.selector.select($uuid, true);
				}
			}
		}
		if (!this.selectedPageRecord && !ignoreLastSelected) {
			this.ensureChildPageSelection(true);
		}
	},
	appendHeader: function() {
		this.header = document.createElement("header");
		this.header.className = this.$skin + "-head";
		this.header.style.display = "none";
	},
	onMenuClick: function(menuItem) {
		var self = this;
		if (!menuItem.$isAction) {
			switch (menuItem.$item.$bind) {
				case "delete":
					return false;
				case "$create":
				case "$edit":
					self.openDialog({
						article: menuItem.articleParent,
						$url: menuItem.$url,
						$method: menuItem.$method,
						onSave: function(menuItem, dialog) {
							dialog.options.article.notifyClientSave(dialog._content.dataset);
							dialog.close(true);
							return false;
						},
						onValidate: function(page) {
							if (page.validateFields()) {
								page.clickMenu("$save");
							}
							return false;
						},
						onClose: function(isCanceled, dispose) {
							return true;
						}
					});
					return false;
			}
		}
		return true;
	},
	resizeArticle: function() {
		DesktopPage.prototype.resizeArticle.call(this);
		if (this.isPageLoaded && this.bar) {
			this.bar.resizeBar();
		}
	},
	dispose: function() {
		if (this.bar) {
			this.bar.dispose();
		}
		this.bar = this.rolePages = this.userPages = this.selectedPageRecord = null;
		DesktopPage.prototype.dispose.call(this);
	}

});