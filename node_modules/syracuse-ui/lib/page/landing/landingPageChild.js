"use strict";
var helpers = require('syracuse-core/lib/helpers');
var LandingPageDesigner = require("syracuse-ui/lib/page/landing/designer/landingPageDesigner").LandingPageDesigner;
var DesktopPage = require('syracuse-ui/lib/page/desktopPage').DesktopPage;

function LandingPageChild() {}

exports.LandingPageChild = helpers.defineClass(LandingPageChild, DesktopPage, {
	designArticle: function(open) {
		if (open) {
			this.designer = new LandingPageDesigner();
			this.designer.openDesigner(this);
		} else {
			if (this.designer) {
				this.designer.dispose();
			}
			this.designer = null;
			this.resizeArticle();
		}
	},
	dispose: function() {
		this.landingPageMaster = this.masterRecord = this.addLink = this.refreshLink = this.designPicker = null;
		DesktopPage.prototype.dispose.call(this);
	},
	getAddVignetteDefinition: function() {
		var vignettes = this.masterRecord.$prototype.$properties.vignettes;
		return vignettes && vignettes.$links && vignettes.$links.$select;
	},
	setMasterContext: function(record) {

	},
	appendHeader: function() {
		DesktopPage.prototype.appendHeader.call(this);
		this.addLink = document.createElement("a");
		this.addLink.style.display = "none";
		this.addLink.className = "s-ldp-add-vignette";
		this.addLink.title = this.localize.ldpAddVignette;
		this.addLink.setAttribute("data-s-picker", "ldp-addVignette");
		this.headerCoreRight.appendChild(this.addLink);
		this.headerCoreRight.setAttribute("data-s-inout", this.id);
		this.refreshLink = document.createElement("a");
		this.refreshLink.className = "s-ldp-refresh";
		this.refreshLink.title = this.localize.ldpRefresh;
		this.refreshLink.setAttribute("data-s-picker", "ldp-refresh");
		this.headerCoreRight.appendChild(this.refreshLink);
		if (this.isDesignModeEnabled) {
			this.designPicker = document.createElement("a");
			this.designPicker.className = "s-ldp-designer-picker";
			this.designPicker.setAttribute("data-s-picker", "ldp-openDesigner");
			this.designPicker.title = this.localize.ldpOpenDesigner;
			this.designPicker.style.display = this.refreshLink.style.display = "none";
			this.headerCoreRight.appendChild(this.designPicker);
		}
	},
	onItemEnterLeave: function(event) {
		if (event.currentTarget == this.headerCoreRight) {
			this.toggleCssOnEnter(this.headerCoreRight, event);
		}
	},
	onClickPicker: function(picker, event) {
		switch (picker.getAttribute("data-s-picker")) {

			case "ldp-addVignette":
				this.landingPageMaster.addVignette(this);
				event.stopPropagation();
				return false;
			case "ldp-refresh":
				var items = this.layoutContent.getFields();
				for (var ii = 0, jj = items.length; ii < jj; ii++) {
					items[ii].refresh();
				}
				event.stopPropagation();
				return false;
			case "ldp-openDesigner":
				this.designer.toggleDesigner();
				event.stopPropagation();
				return false;
		}
		return true;
	},
	onEditTabClick: function(picker) {
		var box = document.site.findBox(picker);
		this.editTitleSlot = document.createElement("div");
		this.editTitleSlot.className = box.$skin + "-edit-text";
		var titleText = box.tabTitle ? box.tabTitleText : box.titleText;
		titleText.style.display = "none";
		titleText.parentNode.insertBefore(this.editTitleSlot, titleText);
		this.editTitleField = this.page.loadNewItem(this.editTitleSlot, {
			$category: "field",
			//$contentEditable: true,
			$isTitleHidden: true,
			$isTopLabelAlignment: false,
			$isEditMode: true,
			$field: {
				$isMandatory: true,
				$type: "application/x-string"
			}
		});
		this.editTitleField.setDataValue(box.getTitle());
	},
	getOpenedTab: function() {
		return this.layoutContent.tabOpened;
	},
	deleteOpenedTab: function() {
		var self = this;
		var box = self.getOpenedTab();
		if (box && box.layoutContent) {
			var vignettes = box.layoutContent.getFields();
			document.site.showMessage({
				$title: self.localize.ldpDeleteVignette,
				$message: self.localize.ldpConfirmTabDeleteVignette.replace("{0}", box.getTitle()),
				$type: "question",
				callback: function(response) {
					if (response && response.$clientId === "yes") {
						var uiids = [];
						for (var ii = 0, jj = vignettes.length; ii < jj; ii++) {
							uiids.push(vignettes[ii].$field.$vignetteId);
						}
						var fields = box.layoutContent.getFields();
						for (var ii = 0, jj = fields.length; ii < jj; ii++) {
							self.removeItem(fields[ii], true, true);
						}
						box.layoutParent.removeItem(box, true);
						self.landingPageMaster.deleteVignettes(self.masterRecord, uiids, box);
					}
				}
			});
		}
	},
	applyShortCuts: function(shortcurts, event) {
		if (shortcurts.esc && shortcurts.r) {
			var $binds = Object.keys(this.boundFields);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var field = this.boundFields[$binds[ii]][0];
				if (field.vignette && field.vignette.applyShortCuts) {
					field.vignette.applyShortCuts(shortcurts);
				}
			}
			return true;
		}
		return DesktopPage.prototype.applyShortCuts.call(this, shortcurts, event);
	},
	createDefaultArticle: function($article, $prototype) {
		if (!$article) {
			$article = {};
		}
		if (!$article.$layout) {
			$article.$layout = {};
		}
		if (!$article.$layout.$items) {
			var $items = [];
			var $itemFields = [];
			var binds = Object.keys($prototype.$properties);
			for (var ii = 0, jj = binds.length; ii < jj; ii++) {
				var $bind = binds[ii];
				var $field = $prototype.$properties[$bind];
				if ($field && !$field.$isExcluded && !$field.$isTOC) {
					$itemFields.push({
						$bind: $bind
					});
				}
			}
			$article.$layout.$layoutType = "tabs";
			var $newTab = this._defineNewTab();
			$newTab.$layout = {
				$items: $itemFields
			};
			$article.$layout.$items = [$newTab];
		}
		for (var ii = 0, jj = $article.$layout.$items.length; ii < jj; ii++) {
			$article.$layout.$items[ii].$isEmptyVisible = true;
		}
		return $article;
	},
	ensureDefaultArticle: function($article, $prototype) {
		return this.createDefaultArticle($article, $prototype);
	},
	ensureDesignerOpenerVisibility: function() {
		document.site.enablePageDesign(false);
	},


	ensurePageVisibility: function() {
		DesktopPage.prototype.ensurePageVisibility.call(this);
		/*if (this.isDesignModeEnabled && this.isPageLoaded && this.layoutContent) {
         for (var ii = 0, jj = this.layoutContent.items.length; ii < jj; ii++) {
         var item = this.layoutContent.items[ii];
         if (!item.$item.$isAddLandingTab) {
         
         }
         }
         }*/
	},
	_defineNewTab: function() {
		return {
			$category: "section",
			$title: document.site.localizer.getDefaultTabTitle(this),
		};
	},
	_createNewTab: function(sibling) {
		var $newTab = this._defineNewTab();
		$newTab.$isEmptyVisible = true;
		var tab = this.layoutContent.loadChildItem(null, $newTab, this.layoutContent.items.indexOf(sibling));
		tab.openBox(true);
		return tab;
	},
	onBoxClickItem: function(box, link) {
		if (box) {
			if (box.$item.$isAddLandingTab) {
				this._createNewTab(box);
				this.designer.endArticleUpdate();
				return false;
			} else {
				if (box.isTabLayout && this.designer) {
					this.designer.onTabClik(box);
				}
			}
		}
		return true;
	},
	removeDeletedVignettes: function($vignettes) {
		var $binds = Object.keys(this.$prototype.$properties);
		for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
			var $bind = $binds[ii];
			if (!$vignettes[$bind]) {
				var fields = this.boundFields[$bind];
				if (fields) {
					for (var mm = 0, kk = fields.length; mm < kk; mm++) {
						var vignette = fields[mm];
						vignette.layoutParent.removeItem(vignette, true, true);
						delete this.$prototype.$properties[$bind];
					}
				}
				delete this.boundFields[$bind];
			}
		}
	},
	applyVignettesChange: function($vignettes) {
		this.removeDeletedVignettes($vignettes);
		var $binds = Object.keys($vignettes);
		for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
			var $bind = $binds[ii];
			var $vignette = $vignettes[$bind];
			var $field = this.$prototype.$properties[$bind];
			if (!$field) {
				var tab = this.getOpenedTab();
				if (tab.$item.$isAddLandingTab) {
					this._createNewTab(tab);
				}
				this.$prototype.$properties[$bind] = $vignette;
				tab.layoutContent.createChildItem({
					$bind: $bind
				});
			}
		}
		if (this.designer) {
			this.designer.endArticleUpdate(null, null, false);
		}
	},
	getPageSlot: function() {
		return document.site.body;
	},
	loadBox: function(initData, $initDiagnoses) {
		this.landingPageMaster = (this.masterRecord = this.$prototype.masterRecord).page;
		delete this.$prototype.masterRecord;
		this.isDesignModeEnabled = this.masterRecord.getSaveDesignLink() != null;
		this.isAutoInsertFieldDisabled = true;
		this.isLandingPage = true;
		this.isDashBoard = true;
		this.$skin = this.$item.$skin || "s-ldp";
		this.$skinMenu = "s-ldp-nav";
		this.$defaultSkinBlock = "s-ldp-h2";
		this.$defaultSkinSection = "s-ldp-h1";
		this._defaultTitle = this.localize.ldpTitle;
		this.$autoFetch = false;
		DesktopPage.prototype.loadBox.call(this, initData, $initDiagnoses);
		if (this.isDesignModeEnabled) {
			this.designPicker.style.display = this.refreshLink.style.display = "";
			this.layoutContent.loadChildItem(null, {
				$category: "section",
				$isAddLandingTab: true,
				$isAuthoringEnabled: false,
				$isEmptyVisible: true,
				$title: "+",
				$description: this.localize.ldpAddTab
			});
		}
		if (this.layoutContent && this.layoutContent.items.length) {
			if (this.layoutContent.items[0].isTabLayout) {
				this.layoutContent.items[0].openBox(true, true);
			}
		}
		document.site.userProfile.showPageSecurity(this);
		//temp for right implementation
		if (this.pageViewSelector) {
			this.pageViewSelector.disable(false);
		}
		if (this.isDesignModeEnabled) {
			this.designArticle(true);
		}
		if (this.isDesignModeEnabled && this.getAddVignetteDefinition()) {
			this.addLink.style.display = "";
		}
	}
});