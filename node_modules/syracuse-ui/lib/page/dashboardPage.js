"use strict";
var helpers = require('syracuse-core/lib/helpers');
var LandingPageDesigner = require("syracuse-ui/lib/authoring/landingPageDesigner").LandingPageDesigner;
var DesktopPage = require('./desktopPage').DesktopPage;
var importHelper = require('./utility/importHelper');

function DashboardPage() {}

exports.DashboardPage = helpers.defineClass(DashboardPage, DesktopPage, {
	designPage: function(open) {
		if (open) {
			this.designer = new LandingPageDesigner();
			this.designer.openDesigner(this);
		} else {
			if (this.designer) {
				this.showDiagnoses({
					$diagnoses: null
				});
				this.designer.dispose();
			}
			this.designer = null;
			document.site.resize();
		}
	},
	dispose: function() {
		this.$freeFieldBinds = this.registeredVignettes = null;
		DesktopPage.prototype.dispose.call(this);
	},
	appendHeader: function() {
		DesktopPage.prototype.appendHeader.call(this);
		this.refreshLink = document.createElement("a");
		this.refreshLink.className = "s-dash-refresh";
		this.refreshLink.title = "Refresh";
		this.refreshLink.setAttribute("data-s-picker", "refresh");
		this.designerOpenerLink = document.createElement("a");
		this.designerOpenerLink.className = "s-dash-designer-opener";
		this.designerOpenerLink.setAttribute("data-s-picker", "openDesigner");
		this.designerOpenerLink.title = "Customize Page";
		this.headerCore.appendChild(this.refreshLink);
		this.headerCore.appendChild(this.designerOpenerLink);
	},
	onClickPicker: function(picker, event) {
		if (picker == this.refreshLink || picker == this.designerOpenerLink) {
			var items = this.layoutContent.getFields();
			if (picker == this.refreshLink) {
				for (var ii = 0, jj = items.length; ii < jj; ii++) {
					if (items[ii].doPicker) {
						items[ii].doPicker("refresh");
					}
				}
			} else {
				this.designPage(!this.designer);
			}
			event.stopPropagation();
			return false;
		}
		return true;
	},
	applyShortCuts: function(shortcurts, event) {
		if (shortcurts.esc && shortcurts.r) {
			if (this.registeredVignettes) {
				var $binds = Object.keys(this.registeredVignettes);
				for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
					var field = this.registeredVignettes[$binds[ii]];
					if (field.vignette && field.vignette.applyShortCuts) {
						field.vignette.applyShortCuts(shortcurts);
					}
				}
			}
			return true;
		}
		return DesktopPage.prototype.applyShortCuts.call(this, shortcurts, event);
	},
	registerVignette: function(vignette, $bind) {
		this.registeredVignettes[$bind || vignette.$item.$bind] = vignette;
	},
	_addDefaultMenus: function($vignette) {
		var $layout = {
			$layoutType: "row",
			$widths: "33,33,33",
			$items: [{
				$layoutType: "stack",
				$items: []
			}, {
				$layoutType: "stack",
				$items: []
			}, {
				$layoutType: "stack",
				$items: []
			}]
		};
		var $linkBinds = Object.keys(this.$prototype.$links);
		var index = 0;
		for (var ii = 0, jj = $linkBinds.length; ii < jj; ii++) {
			var $linkBind = $linkBinds[ii];
			var $link = this.$prototype.$links[$linkBind];
			if ($link.$vignettes && $link.$vignettes.indexOf($vignette) >= 0) {
				$layout.$items[index++].$items.push({
					$category: "link",
					$skin: "s-dash-h2-link",
					$bind: $linkBind
				});
				if (index == 3) {
					index = 0;
				}
			}
		}
		return $layout;
	},
	addDefaultField: function($bind, $field, addSection) {
		addSection = addSection !== false;
		var $item = ($field.$format == "$menu") ? {
			$category: "menus",
			$vignette: $bind,
			$layout: this._addDefaultMenus($bind)
		} : {
			$isTitleHidden: addSection,
			$bind: $bind
		};
		if (addSection) {
			$item = {
				$category: "section",
				$title: $field.$title,
				$layout: {
					$items: [$item]
				}
			};
		}
		return $item;
	},
	createDefaultArticle: function($article, $prototype) {
		if (!$article) {
			$article = {};
		}
		if (!$article.$layout) {
			$article.$layout = {};
		}
		if (!$article.$layout.$items) {
			var $items = [];
			var $itemFields = [];
			var binds = Object.keys($prototype.$properties);
			for (var ii = 0, jj = binds.length; ii < jj; ii++) {
				var $bind = binds[ii];
				var $field = $prototype.$properties[$bind];
				if ($field && !$field.$isExcluded && !$field.$isTOC) {
					$itemFields.push(this.addDefaultField($bind, $prototype.$properties[$bind]));
				}
			}
			if ($itemFields.length == 1) {
				$items = $itemFields;
			} else {
				$article.$layout.$layoutType = "row";
				$items.push({
					$layoutType: "stack",
					$items: []
				}, {
					$layoutType: "stack",
					$items: []
				});
				var half = Math.ceil($itemFields.length / 2);
				for (var ii = 0, jj = $itemFields.length; ii < jj; ii++) {
					$items[ii < half ? 0 : 1].$items.push($itemFields[ii]);
				}
			}
			$article.$layout.$items = $items;
		}
		return $article;
	},
	ensureDefaultArticle: function($article, $prototype) {
		if ($article && $article.$importHint) {
			importHelper.importArticle($article, $prototype, this);
		} else {
			$article = this.createDefaultArticle($article, $prototype);
		}
		return $article;
	},
	isTOCMenu: function($menu) {
		if ($menu.$vignettes) {
			for (var ii = 0, jj = $menu.$vignettes.length; ii < jj; ii++) {
				var $vignette = this.$prototype.$properties[$menu.$vignettes[ii]];
				if ($vignette && $vignette.$isTOC) {
					return true;
				}
			}
		}
		return false;
	},
	_addMenuToMenusBag: function($bind, $menu) {
		if ($menu.$vignettes) {
			if (!this.isTOCMenu($menu)) {
				this.freeLinks[$bind] = $menu;
				return;
			}
		}
		DesktopPage.prototype._addMenuToMenusBag.call(this, $bind, $menu);

	},
	reloadLayout: function($item) {
		this.registeredVignettes = {};
		this.freeLinks = {};
		DesktopPage.prototype.reloadLayout.call(this, $item);
	},
	findSiblingMenu: function($vignette) {
		var vignette = this.registeredVignettes[$vignette];
		if (!vignette) {
			var $binds = Object.keys(this.menuItems);
			for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
				var menus = this.menuItems[$binds[ii]];
				if (menus.length > 0 && menus[0].$vignettes) {
					if (menus[0].$vignettes.indexOf($vignette) >= 0) {
						return menus[0];
					}
				}
			}
		}
		return null;
	},
	warnAdministrationUpdates: function(showDiagnoses) {
		return;
		var $freeLinkBinds = Object.keys(this.freeLinks);
		var $fieldsBinds = Object.keys(this.$prototype.$properties);
		this.$freeFieldBinds = [];
		var $definedBinds = {};
		this.getDefinedFieldsObject(this.$item.$layout.$items, $definedBinds);
		for (var ii = 0, jj = $fieldsBinds.length; ii < jj; ii++) {
			var $bind = $fieldsBinds[ii];
			if (!this.registeredVignettes[$bind]) {
				var $field = this.$prototype.$properties[$bind];
				if ($field && !$field.$isExcluded && !$field.$isTOC) {
					if ($field.$format == "$menu") {
						for (var mm = 0, kk = $freeLinkBinds.length; mm < kk; mm++) {
							var $freeLink = this.freeLinks[$freeLinkBinds[mm]];
							if ($freeLink.$vignettes && $freeLink.$vignettes.indexOf($bind) >= 0) {
								//vignette has new menu Item 
								if (!this.loadedVignettesMenus[$bind]) {
									if (!this.garbageFields[$bindd]) {
										this.$freeFieldBinds.push($bind);
									}
								}
								break;
							}
						}
					} else {
						if ($bind != "$pageViewSelector" && !$definedBinds[$bind]) {
							if (!this.garbageFields[$bind]) {
								this.$freeFieldBinds.push($bind);
							}
						}
					}
				}
			}
		}
		if ($freeLinkBinds.length > 0 || this.$freeFieldBinds.length > 0) {
			var $message;
			if (document.site.userProfile.getAuthoringLevel() !== "none") {
				if ($freeLinkBinds.length > 0) {
					if (this.$freeFieldBinds.length > 0) {
						$message = this.localize.dskpDashNewLinkVignette.replace("{0}", $freeLinkBinds.length);
						$message = $message.replace("{1}", this.$freeFieldBinds.length);
					} else {
						$message = this.localize.dskpDashNewLink.replace("{0}", $freeLinkBinds.length);
					}
				} else {
					$message = this.localize.dskpDashNewVignette.replace("{0}", this.$freeFieldBinds.length);
				}
			}
		}
	},
	_highlightPageLink: function() {
		if (this.$urlParts && this.$urlParts.params) {
			var representationParam = "representation=" + this.$urlParts.params.representation;
			if (this.menusBags && this.menusBags.length && this.menusBags[0].layoutContent) {
				var menusItems = this.menusBags[0].layoutContent.items;
				if (menusItems.length > 0) {
					var currentMenu;
					for (var ii = 0, jj = menusItems.length; ii < jj; ii++) {
						var menu = menusItems[ii];
						if (menu.$url.indexOf(representationParam) >= 0) {
							currentMenu = menu;
							break;
						}
					}
				}
				if (currentMenu) {
					document.site.toggleClass(currentMenu.mn, "s-cst-sty-main", true);
					document.site.toggleClass(currentMenu.layoutSlot, "s-cst-sty-main", true);

				}
			}
		}
	},
	extractMenus: function($layout, $menus) {
		$menus = $menus || [];
		if ($layout && $layout.$items) {
			for (var ii = 0, jj = $layout.$items.length; ii < jj; ii++) {
				var $item = $layout.$items[ii];
				if ($item.$bind) {
					$menus.push($item);
				} else
				if ($item.$layout || $item.$items) {
					$menus = this.extractMenus($item.$layout || $item, $menus);
				}
			}
		}
		return $menus;
	},
	updateNavigationMenus: function($layout) {
		if ($layout && $layout.$items) {
			for (var ii = 0, jj = $layout.$items.length; ii < jj; ii++) {
				var $item = $layout.$items[ii];
				if ($item.$layout) {
					if ($item.$category) {
						if ($item.$title) {
							$item.$isBoxCollapsable = true;
						}
						var $menus = this.extractMenus($item.$layout);
						$item.$layout.$items = [{
							$layoutType: "stack",
							$items: []
						}, {
							$layoutType: "stack",
							$items: []
						}, {
							$layoutType: "stack",
							$items: []
						}, {
							$layoutType: "stack",
							$items: []
						}];
						var col = 0;
						for (var mm = 0, kk = $menus.length; mm < kk; mm++) {
							$item.$layout.$items[col].$items.push($menus[mm]);
							col = (col == 3) ? 0 : ++col;
						}
					}
				} else
				if ($item.$items) {
					this.updateNavigationMenus($item);
				}
			}
		}
	},
	extractSection: function($layout, $sections) {
		$sections = $sections || [];
		if ($layout && $layout.$items) {
			for (var ii = 0, jj = $layout.$items.length; ii < jj; ii++) {
				var $item = $layout.$items[ii];
				if ($item.$layout) {
					if (!$item.$category || ($item.$category == "section")) {
						$item.$skin = "s-dash-subtopic";
						delete $item.$isBoxCollapsable;
						this.updateNavigationMenus($item.$layout);
						$sections.push($item);
					}
				} else
				if ($item.$items) {
					$sections = this.extractSection($item, $sections);
				}
			}
		}
		return $sections;
	},
	extractBinds: function($layout, $binds) {
		if (!$binds) {
			$binds = [];
		}
		if ($layout.$items) {
			for (var ii = 0, jj = $layout.$items.length; ii < jj; ii++) {
				var $item = $layout.$items[ii];
				if ($item.$bind && $item.$category != "link") {
					$binds[ii] = $item;
				} else {
					if ($item.$layout || $item.$items) {
						$binds = this.extractBinds($item.$layout || $item, $binds);
					}
				}
			}
		}
		return $binds;
	},
	_applyBinds: function($layout, $binds) {
		if ($layout.$items) {
			for (var ii = 0, jj = $layout.$items.length; ii < jj; ii++) {
				var $item = $layout.$items[ii];
				if ($item.$bind && $binds[$item.$bind]) {
					$item = $binds[$item.$bind];
				} else {
					if ($item.$layout || $item.$items) {
						$binds = this._applyBinds($item.$layout || $item, $binds);
					}
				}
			}
		}
		return $binds;
	},
	applyNavigationLayout: function() {
		var $binds = Object.keys(this.$prototype.$properties);
		var hasMenus = $binds.length == 0;
		for (var ii = 0, jj = $binds.length; ii < jj && !hasMenus; ii++) {
			var $field = this.$prototype.$properties[$binds[ii]];
			if ($field.$format == "$menu" && !$field.$isTOC) {
				hasMenus = true;
			}
		}
		$binds = null;
		if (!this.$prototype.$isDefaultDashboard) {
			if (this.$item && this.$item.$layout) {
				$binds = this.extractBinds(this.$item.$layout);
			}
			this.$item = helpers.object.clone(this.ensureDefaultArticle(this.$prototype.$article, this.$prototype), true);
		}
		if (this.$item && this.$item.$layout) {
			if ($binds && $binds.length) {
				this._applyBinds(this.$item.$layout, $binds);
			}
			//this.$item.$layout.$items = 
			var $sections = this.extractSection(this.$item.$layout);
			if ($sections.length == 0 && !$binds) {
				if (this.$item && this.$item.$layout) {
					$binds = this.extractBinds(this.$item.$layout);
				}
				this.$item = helpers.object.clone(this.ensureDefaultArticle(this.$prototype.$article, this.$prototype), true);
				if ($binds && $binds.length) {
					this._applyBinds(this.$item.$layout, $binds);
				}
				this.$item.$layout.$items = this.extractSection(this.$item.$layout);
			} else {
				this.$item.$layout.$items = $sections;
			}
			delete this.$item.$layout.$layoutType;
			delete this.$item.$layout.$widths;
		}
	},
	ensureDesignerOpenerVisibility: function() {
		if (document.site.pageDesignerOpener) {
			document.site.pageDesignerOpener.style.display = "none";
		}
	},
	loadBox: function(initData, $initDiagnoses) {
		this.freeLinks = {};
		this.registeredVignettes = {};
		this.isDashBoard = true;
		this.$skin = this.$item.$skin || "s-dash";
		this.$skinMenu = "s-dash-nav";
		this.$defaultSkinBlock = "s-dash-h2";
		this.$defaultSkinSection = "s-dash-h1";
		this._defaultTitle = this.localize.dskpDashboardTitle;
		this.$autoFetch = false;
		//this.applyNavigationLayout();
		DesktopPage.prototype.loadBox.call(this, initData, $initDiagnoses);
		this._highlightPageLink();
	}
});