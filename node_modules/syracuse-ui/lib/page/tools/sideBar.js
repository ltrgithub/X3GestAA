"use strict";
var helpers = require('@sage/syracuse-core').helpers;
var Draggable = require('syracuse-ui/lib/scroll/drag').Draggable;

function _getDefaultSate(key) {
	var state;
	if (syra_site.isTabletDevice) {
		state = {
			convergenceBar: {
				$isFloating: true,
				$isCollapsed: true
			},
			menuBar: {
				$isCollapsed: !syra_site.isLandscape
			}
		}[key];
	}
	return state || {
		$isCollapsed: false
	};
}

function SideBar() {}

exports.SideBar = helpers.defineClass(SideBar, null, {
	load: function(page) {
		var self = this;
		self.articleParent = page;
		if (!self.id) {
			self.id = page.id + "-" + (++page._childItemOffset);
		}
		syra_item.register(self);
		self.closeWidth = 100;
		self.minWidth = self.minWidth || 200;
		self.page = page;
		self._appplyPreferences();
		self.options.resizeDirection = self.options.resizeDirection || "left";
		self.slot.className += " s-bar-slot s-bar-slot-" + self.options.resizeDirection;
		if (self.$width != undefined && parseInt(self.$width) <= self.closeWidth) {
			delete self.$width;
		}

		self.resizePicker = syra_dom.div(self.options.$skin + "-resizer s-bar-resizer-" + self.options.resizeDirection);
		self.openButton = syra_button.add({
			parent: self,
			slot: self.resizePicker,
			text: syra_local.bar_collapse,
			css: self.options.$skin + "-opener s-bar-opener",
			iconOnly: true,
			shortCutTip: ((self.options.resizeDirection == "left") ? syra_shortCuts.tip.hideLeftBar : syra_shortCuts.tip.hideRightBar) + ", " + syra_shortCuts.tip.hideFull,
			fontIcon: self.options.resizeDirection + "_arrow",
			click: function() {
				self.collapse();
			}

		});
		self.slot.appendChild(self.resizePicker);

		self.draggable = new Draggable({
			sideBar: self,
			handle: self.resizePicker,
			exclude: [self.openButton.link],
			cursor: "e-resize",
			delay: true,
			start: function() {
				syra_dom.getBoundingClientRect(this.sideBar.slot, this);
				this.isLeftDirection = this.sideBar.options.resizeDirection == "left";
				if (syra_context.isRTL) {
					this.isLeftDirection = !this.isLeftDirection;
				}
				this.resizerRect = this.sideBar.resizePicker.getBoundingClientRect();
				if (this.sideBar.$isCollapsed) {
					this.sideBar.ensureState(true);
				}
			},
			drag: function(event) {
				if (this.resizerRect && (event.pageY >= this.top) && (event.pageY <= this.bottom)) {
					var newWidth = this.width + (this.isLeftDirection ? (event.pageX - this.resizerRect.left) : (this.resizerRect.left - event.pageX));
					if (newWidth > 0) {
						this.sideBar.resizeSplitter(this.newWidth = newWidth);
					}
				}
			},
			stop: function() {
				var newWidth = this.sideBar.slot.clientWidth;
				if (newWidth <= this.sideBar.closeWidth) {
					this.sideBar.$isCollapsed = true;
					this.sideBar.ensureState();
				} else {
					this.sideBar.$width = this.sideBar.slot.clientWidth;
				}
				this.sideBar.savePreferences();
				this.sideBar.page.resizeItem(true);
			}
		});

		self.slot.appendChild(self.body);
		syra_dom.setZIndex(self.slot, true);
		self.page.bars.push(self);
		self.ensureState();
	},
	_appplyPreferences: function() {
		var defaultState = _getDefaultSate(this.preferenceKey || this.pagePreferenceKey);
		var pref;
		if (this.preferenceKey) {
			pref = localStorage.getItem(this.preferenceKey);
			pref = pref && JSON.parse(pref);
		} else {
			pref = this.pagePreferenceKey && syra_preference.page.get(this.page, this.pagePreferenceKey);
		}
		pref = pref || {};
		this.$width = pref.$width;
		this.$isCollapsed = !!pref.$isCollapsed;
		this.$isFloating = this.options.$isFloating;
	},
	resizeSplitter: function(newWidth) {
		if (!this.designing) {
			if (!this.options.isAutoModeDisabled) {
				if (this.isSmall != syra_site.getSize().isSmall) {
					this.isSmall = syra_site.getSize().isSmall;
					this.$isCollapsed = this.isSmall;
				}
			}
			if (!newWidth) {
				this.ensureState();
			}
			if (this.slot.parentNode) {
				if (newWidth !== undefined) {
					this.slot.style.width = newWidth + "px";
				}
				var direction = this.options.resizeDirection;
				if (this.$isCollapsed || !this.$isFloating) {
					if (syra_context.isRTL) {
						direction = direction == "left" ? "right" : "left";
					}
					if (this.slot.parentNode) {
						this.slot.parentNode.style["padding" + direction.substr(0, 1).toUpperCase() + direction.substr(1)] = (newWidth || this.slot.clientWidth) + "px";
					}
				}
			}
		}
	},
	toggleBar: function(show) {
		syra_dom.hide(this.slot, this.isHidden = !show);
	},
	ensureState: function(startResize) {
		if (!this.isHidden) {
			if (startResize && this.$isCollapsed) {
				this.curCollapsedState = this.$isCollapsed = false;
				delete this.$width;
				this.slot.style.width = this.slot.clientWidth + "px";
				syra_dom.hide(this.body, false);
			} else {
				if (this.curCollapsedState != this.$isCollapsed) {
					if (this.$isCollapsed) {
						syra_dom.hide(this.body, true);
						this.slot.style.width = "";
					} else {
						this.$isCollapsed = false;
						this.slot.style.width = Math.max(this.$width || 0, this.minWidth) + "px";
						syra_dom.hide(this.body, false);
					}
					this.curCollapsedState = this.$isCollapsed;
				}
			}
			syra_dom.toggleClass(this.slot, "s-close", this.$isCollapsed);
			if (this.resizePicker) {
				var icon = this.options.resizeDirection;
				if (this.$isCollapsed) {
					icon = icon == "left" ? "right" : "left";
				}
				syra_button.setText(this.openButton, this.$isCollapsed ? syra_local.bar_expand : syra_local.bar_collapse, icon + "_arrow");
			}
		}
	},
	collapse: function() {
		delete this.onBeforeMaximized;
		this.$isCollapsed = !this.$isCollapsed;
		this.savePreferences();
		this.ensureState();
		this.page.resizeItem(true);
	},
	clearPreferences: function() {
		var key = this.preferenceKey || this.pagePreferenceKey;
		if (key) {
			localStorage.removeItem(this.preferenceKey);
			delete this.$width;
			delete this.$isCollapsed;
			this.ensureState();
			this._appplyPreferences();
		}
	},
	savePreferences: function(key) {
		if (this.preferenceKey) {
			localStorage.setItem(this.preferenceKey, JSON.stringify({
				$width: this.$width,
				$isCollapsed: this.$isCollapsed
			}));
		} else {
			if (this.pagePreferenceKey) {
				var preference = syra_preference.page.get(this.page, this.pagePreferenceKey) || {};
				preference.$width = this.$width;
				preference.$isCollapsed = this.$isCollapsed;
				syra_preference.page.save(this.page, this.pagePreferenceKey, preference);
			}
		}
	},
	dispose: function() {
		this.draggable && this.draggable.dispose();
		var bars = this.page && this.page.bars;
		if (bars) {
			var index = bars.indexOf(this);
			if (index >= 0) {
				bars.splice(index, 1);
			}
		}
		this.$isFloating && syra_dom.remove(this.slot);
		syra_site.disposeObject(this);
	}
});