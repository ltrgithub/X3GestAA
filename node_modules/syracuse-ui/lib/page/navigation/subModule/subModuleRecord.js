"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RecordArticle = require("syracuse-ui/lib/field/array/recordArticle").RecordArticle;
var NavigationItemReorderDDAgent = require("./navigationItemReorderDDAgent").NavigationItemReorderDDAgent;

function SubModuleRecord(){
}

exports.SubModuleRecord = helpers.defineClass(SubModuleRecord, RecordArticle, {
    loadBox: function(options){
        this.isSubModuleRecord = true;
        this.$defaultSkinSection = this.$defaultSkinBlock = this.list.$item.$skinCard || "s-h3";
        RecordArticle.prototype.loadBox.call(this);
    },
    onLoadNavigationItem: function(navigationItem){
        navigationItem.RecordReorderDDAgentClass = NavigationItemReorderDDAgent;
    },
    reorderItem: function(targetRecord, isAfter){
        if (targetRecord) {
            targetRecord.domItem.parentNode.insertBefore(this.domItem, isAfter ? targetRecord.domItem.nextSibling : targetRecord.domItem);
            if (this.page.isAdminMode) {
                targetRecord.header.parentNode.insertBefore(this.header, isAfter ? targetRecord.header.nextSibling : targetRecord.header);
            }
        }
        else {
            if (isAfter) {
                this.list.body.appendChild(this.domItem);
            }
            else {
                this.list.body.insertBefore(this.domItem, this.list.body.firstChild);
            }
            if (this.page.isAdminMode) {
                var subModulesAdminTitleList = this.list.articleParent.subModulesAdminTitleList;
                if (isAfter) {
                    subModulesAdminTitleList.appendChild(this.header);
                }
                else {
                    subModulesAdminTitleList.insertBefore(this.header, subModulesAdminTitleList.firstChild);
                }
            }
        }
    },
    remove: function(){
        if (this.$$item) {
            this.$$item.remove();
        }
    },
    applyReorderCapability: function(reorder){
        if (this.hasReorderCapability = reorder) {
            if (!this.reorderPicker) {
                this.reorderPicker = document.createElement("div");
                this.reorderPicker.className = this.$skin + "-card-reorder";
                this.reorderPicker.syraReorderRecordId = this.list.id;
                document.site.ddManager.setDragSpot(this.reorderPicker, true);
                this.domTitle.parentNode.insertBefore(this.reorderPicker, this.domTitle);
            }
        }
        else {
            if (this.reorderPicker) {
                document.site.removeDomChild(this.reorderPicker);
                delete this.reorderPicker;
            }
        }
    },
    applyChange: function(newData, serverResponse){
        if (serverResponse) {
            this.page.ensureDeltaManager().applyObjectDelta(this.dataset, newData);
        }
        RecordArticle.prototype.applyChange.call(this, newData);
        if (this.dataset.description && this.dataset.description != this.dataset.title) {
            this.domItem.title = this.dataset.description;
        }
    },
    onItemEnterLeave: function(event){
        if (this.itemsField && this.itemsField.menusSlot) {
            this.page.ensureReorderAndMenusVisibility(this.itemsField, event, true);
        }
        this.page.ensureReorderAndMenusVisibility(this, event, true);
        this.page.toggleCssOnEnter(this.expandMenus, event);
        RecordArticle.prototype.onItemEnterLeave.call(this, event);
    },
    onSelectMouseEvent: function(event){
        document.site.toggleClass(this.header, "s-record-over", event.type == "mouseenter");
    },
    highlightSelection: function(selected){
        document.site.toggleClass(this.header, "s-list-record-selected", selected);
        this.expandMenus.style.display = this.domItem.style.display = selected ? "" : "none";
        if (selected && this.page.isAdminMode) {
            this.page.onSubModuleSelected(this);
        }
    },
    drawBox: function(){
        this.$isVerticalDirection = true;
        this.dataRow = this.domItem = document.createElement("div");
        this.$skin = this.page.isAdminMode ? "s-nav-admin-submodule" : "s-nav-submodule";
        this.domItem.className = this.$skin;
        this.domItem.setAttribute("data-s-record", this.$uuid);
        this.$$item = $(this.domItem);
        
        this.header = document.createElement("header");
        this.header.className = this.$skin + "-head";
        this.domTitle = document.createElement("div");
        this.header.appendChild(this.domTitle).className = this.$skin + "-title";
        
        if (this.page.isAdminMode) {
            this.header.setAttribute("data-s-record", this.$uuid);
            this.list.articleParent.subModulesAdminTitleList.appendChild(this.header);
            this.setArticleId(this.header);
            this.header.setAttribute("data-s-inout", this.id);
            this.domItem.style.display = "none";
            
            this.domTitle.setAttribute("data-s-picker", "list-selector");
            this.domTitle.className += " s-list-selector-row";
            this.domTitle.setAttribute("data-s-record", this.$uuid);
            
        }
        else {
            this.domItem.appendChild(this.header);
        }
        this.domItem.setAttribute("data-s-inout", this.id);
        this.dataSlot = this.body = document.createElement("div");
        this.body.className = this.$skin + "-body";
        
        this.menusBar = document.createElement("div");
        this.menusBar.className = this.$skin + "-bar";
        
        this.page.defineExpandAllItems(this.list.$skinMenus, this, "page/s-nav-sub-");
        
        if (!this.page.isAdminMode) {
            this.menusBar.appendChild(this.expandMenus);
        }
        this.page.toggleCssOnEnter(this.expandMenus);
        this.menusSlot = document.createElement("div");
        this.menusSlot.className = this.$skin + "-links";
        if (this.page.isAdminMode) {
            this.header.appendChild(this.menusSlot);
        }
        this.itemsFieldSlot = document.createElement("div");
        this.itemsFieldSlot.className = this.page.isAdminMode ? "s-nav-admin-submodules-slot" : "s-nav-submodules-slot";
        this.body.appendChild(this.itemsFieldSlot);
        this.itemsField = this.page.loadNewItem(this.itemsFieldSlot, {
            $isTitleHidden: true,
            $bind: "items"
        }, this);
        
        this.list.applyRecordCapabilities(this);
        this.applyReorderCapability(true);
        
        this.cardItem = this.page.loadNewItem(this.domTitle, {
            $bind: "title",
            $category: "field",
            $isDetailLinkDisabled: true,
            $isMenusHidden: true,
            $isEditMode: this.$isEditMode,
            $inplace: true
        }, this);
        this.list._core.appendChild(this.domItem);
        this.page.ensureReorderAndMenusVisibility(this, null, true);
        this.page.addExpandAllLinks(this)
        
        
        //this.body.insertBefore(this.menusBar, this.page.isAdminMode ? null : this.body.firstChild);
        this.body.insertBefore(this.menusBar, this.body.firstChild);
        this.domItem.appendChild(this.body);
    },
    expandMenuBlocks: function(expand, itemsField){
        if (!itemsField) {
            itemsField = this.itemsField;
        }
        for (var ii = 0, jj = itemsField.records.length; ii < jj; ii++) {
            var record = itemsField.records[ii];
            if (record.singleField.variantItem.isMenuBlock) {
                record.singleField.variantItem.record.expandMenuBlock(expand);
                this.expandMenuBlocks(expand, record.singleField.variantItem.record.itemsField);
            }
        }
    },
    onMenuClick: function(menuItem){
        switch (menuItem.$bind) {
            case "$expand-all":
                this.expandMenuBlocks(true);
                return false;
            case "$collapse-all":
                this.expandMenuBlocks(false);
                return false;
        }
        return true;
    },
    _createMenusBox: function(){
        if (!this._isMenuLoaded) {
            this._isMenuLoaded = true;
            if (this.page.isAdminMode) {
                this.page.ensureReorderAndMenusVisibility(this, null, true);
                this.itemsField.menusSlot.className = "s-nav-admin-items-menus-slot";
                this.menusBar.appendChild(this.itemsField.menusSlot);
                this.page.loadNewItem(this.menusSlot, this.list.defineNewIconMenu("$edit", this.list.$skinMenus + "-link", true), this);
                this.page.loadNewItem(this.menusSlot, this.list.defineNewIconMenu("$delete", this.list.$skinMenus + "-link", true), this);
            }
        }
    },
    dispose: function(){
        if (this.page && this.page.selectedSubModuleRecord == this) {
            delete this.page.selectedSubModuleRecord;
        }
        this.collapseLink = this.expandLink = null;
        this.cardItem = this.domItem = this.dataSlot = this.body = this.menusSlot = this.dataRow = null;
        this.itemsFieldSlot = this.itemsField = this.header = this.domTitle = this.body = null;
        RecordArticle.prototype.dispose.call(this);
    }
});
