"use strict";
var helpers = require('syracuse-core').helpers;
var DesktopPage = require('syracuse-ui/lib/page/desktopPage').DesktopPage;
var _module = require('./module');

var _mode = {
	mega: require('./modeMega'),
	map: require('./modeMap'),
	breadcrumb: require('./modeBreadcrumb')
};

function Navigator() {}

helpers.defineClass(Navigator, DesktopPage, {
	load: function() {
		(this.page = this).$item = {
			$layout: {
				$items: []
			}
		};

		syra_pageBuilder.initialize(this);
		this.externalAdapter = syra_site.externalAdapter;
		syra_article.beforeDraw(this);
		syra_article.endDraw(this);
		this._loadModules();
		this.resizeItem();
	},

	_loadModules: function() {
		var items = this.page.dataset && this.page.dataset.modules;

		this.children = [];
		if (items) {
			// if (this.page.breadcrumbIndex) {
			// 	this._loadFilteredModules(items, 0);
			// } else {
			for (var ii = 0, jj = items.length; ii < jj; ii++) {
				this.children.push(_module.add(this, items[ii]));
			}
			//}
		}
		if (!this.children.length) {
			syra_dom.text(this.$skin + "-no-modules", syra_local.nvpNoModule, this.modulesBar);
		}
		this.isModulesLoaded = true;
	},
	// _loadFilteredModules: function(items, level) {
	// 	// get the breadcrumb level of the selected breadcrumb
	// 	for (var ii = 0, jj = items.length; ii < jj; ii++) {
	// 		var item = items[ii];
	// 		if (level < this.breadcrumbIndex) {
	// 			if (item.$uuid === this.page.breadcrumbs[level].uuid) {
	// 				this._loadFilteredModules(item.submodules || item.items || item.menuBlock, level+1);
	// 			}
	// 		} else {
	// 			this.children.push(_module.add(this, item));
	// 		}
	// 	}
	// },
	resizeItem: function() {
		this.mode.page.resizeItem(this);
	},
	clear: function() {
		syra_dom.empty(this.mega_popup);
		syra_dom.empty(this.modulesSlot);
		this.more && this.more.dispose();
		this.more = this.lastSelected = null;
		if (this.children) {
			for (var ii = 0, jj = this.children.length; ii < jj; ii++) {
				this.disposeChild(this.children[ii]);
			}
		}
	},
	disposeChild: function(child) {
		if (child) {
			if (child.children) {
				for (var ii = 0, jj = child.children.length; ii < jj; ii++) {
					this.disposeChild(child.children[ii]);
				}
			}
			child.carousel && child.carousel.dispose();
			syra_item.unregister(child);
			syra_site.disposeObject(child);
		}
	},
	dispose: function() {
		this.clear();
		this.mode.page.dispose(this);
		DesktopPage.prototype.dispose.call(this);
	}
});

exports.showMegaMenus = function($representation) {
	var page = syra_site.megaMenus = new Navigator();
	page.$representation = $representation;
	(page.mode = _mode.mega).page.load(page);
};

exports.showSiteMap = function() {
	var page = syra_site.sitemap = new Navigator();
	(page.mode = _mode.map).page.load(page);
};

exports.showBreadcrumbs = function(breadcrumbs, options) {
	var page = syra_site.breadcrumbs = new Navigator();
	page.breadcrumbs = breadcrumbs;
	page.breadcrumbIndex = options.menu.index;

	(page.mode = _mode.breadcrumb).page.load(page, options);
	(page.mode = _mode.breadcrumb).module.activate(true, syra_site.breadcrumbs.children[0]);
};