"use strict";
var helpers = require('syracuse-core/lib/helpers');
var SingleList = require("syracuse-ui/lib/field/array/singleBuilder/singleList").SingleList;
var NavigationItemRecord = require('./navigationItemRecord').NavigationItemRecord;

function NavigationItemList() {}

exports.NavigationItemList = helpers.defineClass(NavigationItemList, SingleList, {
	loadBox: function(initData) {
		this.RecordClass = NavigationItemRecord;
		this._initRows();
		this.columnsCount = (this.articleParent.isSubModuleRecord && !this.page.isAdminMode) ? 3 : 1;
		this.emptyMessage = syra_local.nvpNoMenuItem;
		this.$item.$isTopLabelAlignment = true;
		this.$item.$iconPath = "page/s-nav-";
		this.$item.$skin = this.page.isAdminMode ? "s-nav-admin-items" : "s-nav-items";
		this.$item.$skinMenus = "s-nav-list-menus";
		if (this.articleParent.isSubModuleRecord) {
			this.subModuleRecord = this.articleParent;
		} else {
			this.subModuleRecord = this.articleParent.list.subModuleRecord; //this.articleParent.list = childField
		}
		SingleList.prototype.loadBox.call(this, initData);
		this.subModuleRecord.onLoadNavigationItem(this);
	},
	emptyBody: function(addEmptySlot, onFetch) {
		this._initRows();
		SingleList.prototype.emptyBody.call(this, addEmptySlot, onFetch);
		if (this.emptyDataItem) {
			this.emptyDataItem.isDroppable = false;
			this.emptyDataItem.defautTextContent = this.emptyDataItem.textContent;
			this.emptyDataItem.syraIsEmptyItem = this.id;
		}
	},
	onItemInOut: function(onEnter, event) {
		if (event && (event.currentTarget == this.emptyDataItem)) {
			var isDroppable = !! (onEnter && syra_dd.ddAgent && syra_dd.ddAgent.isNavigationItemReorderDDAgent);
			if (this.emptyDataItem.isDroppable != isDroppable) {
				this.emptyDataItem.isDroppable = isDroppable;
				if (isDroppable) {
					this.emptyDataItem.textContent = syra_local.nvpDropOnEmpty;
					this.emptyDataItem.className = "s-nav-admin-items-empty-drop";
				} else {
					this.emptyDataItem.className = "s-nav-admin-items-empty-slot";
					this.emptyDataItem.textContent = this.emptyDataItem.defautTextContent;
				}

			}

		}
	},
	_appendMenusBar: function() {
		//!!important overrride default menus bar management
	},
	dispose: function() {
		this.subModuleRecord = null;
		SingleList.prototype.dispose.call(this);
	},
	_createMenusBox: function() {
		if (!this.isMenuLoaded) {
			this.isMenuLoaded = true;
			if (this.page.isAdminMode) {
				var iconOnly = !this.articleParent.isSubModuleRecord;
				var $itemBlock = this.defineNewIconMenu("$create", this.$skinMenus + "-link", iconOnly);
				$itemBlock.$icon.$value = "new-menus-block" + (iconOnly ? "-icon" : "");
				var $itemMenu = this.defineNewIconMenu("$select", this.$skinMenus + "-link", iconOnly);
				$itemMenu.$icon.$value = "new-menu" + (iconOnly ? "-icon" : "");
				this.page.loadNewItem(this.menusSlot, {
					$layoutType: "row",
					$autoSize: true,
					$items: [$itemBlock, $itemMenu]
				}, this);
			}
		}
		this.topbar.style.display = "";
	},
	appendMenusSlot: function() {
		this.menusSlot = document.createElement("div");
	},
	_initRows: function() {
		this.rows = [];
		this.currentCol = 0;
	},
	appendRow: function() {
		var row = {
			slot: document.createElement("div"),
			cols: [],
		};
		row.slot.className = this.$skin + "-row";
		this.body.appendChild(row.slot);
		for (var ii = 0; ii < this.columnsCount; ii++) {
			var slot = document.createElement("div");
			slot.className = this.$skin + "-col";
			row.slot.appendChild(slot);
			row.cols.push({
				slot: slot,
				items: []
			});
		}
		return row;
	},

	setDataBind: function(dataRecordSet, parentDataRecord, metaData) {
		SingleList.prototype.setDataBind.call(this, dataRecordSet, parentDataRecord, metaData);
		if (this.articleParent.isSubModuleRecord) {
			this.page.refreshExpandAllLinks(this.articleParent);
		}
	},
	onAppendRecord: function(newRecord) {
		if (this.rows.length == 0) {
			this.rows = [this.appendRow()];
		}
		this.rows[0].cols[this.currentCol++].slot.appendChild(newRecord.domItem);
		newRecord.rowIndex = 0;
		newRecord.colIndex = this.currentCol;
		if (this.currentCol == this.columnsCount) {
			this.currentCol = 0;
		}
	}
});