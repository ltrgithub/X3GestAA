"use strict";
var helpers = require('syracuse-core/lib/helpers');
var ChildFieldRecord = require('syracuse-ui/lib/field/child/childFieldRecord').ChildFieldRecord;

function NavigationMenuBlockRecord() {}

exports.NavigationMenuBlockRecord = helpers.defineClass(NavigationMenuBlockRecord, ChildFieldRecord, {
	drawBox: function() {
		var $skin = this.page.isAdminMode ? "s-nav-admin-block" : "s-nav-block";
		this.$expanded = true;
		this.domItem = this.list._core;
		this.blockCard = this.domItem.appendChild(document.createElement("div"));
		this.blockCard.className = this.list.$skin + "-record";
		this.blockCardHeader = this.blockCard.appendChild(document.createElement("div"));
		this.blockCardHeader.className = this.list.$skin + "-record-head";
		this.$prototype.$properties.title.$isMandatory = true;

		var prevTitleField = this.titleField;
		this.titleField = this.page.loadNewItem(this.blockCardHeader, {
			$bind: "title",
			$isEditMode: this.page.isAdminMode,
			$isAutoSizeDisabled: true,
			$isTitlePlaceHolder: true,
			$title: syra_local.nvpEnterMenuBlock,
			$contentEditable: true,
			$skin: $skin + "-title-field",
			$isMenusHidden: !this.page.isAdminMode,
			$isDetailLinkDisabled: true,
			$useLocalizePicker: true,
			$isTitleHidden: true
		}, this);
		if (!this.itemsField) {
			this.itemsField = this.page.loadNewItem(this.blockCard, {
				$bind: "items",
				$isTitleHidden: true
			}, this);
			this.itemsField.body.className += " " + $skin + "-items-field";
		} else {
			this.blockCard.insertBefore(this.titleField.domItem, this.itemsField.domItem);
		}
		this.navigationItemRecord = this.articleParent.articleParent;
		//this.page.isAdminMode && this.titleField._dataValue.appendChild(this.itemsField.menusSlot);
		this.addExpandButton();
		if (this.navigationItemRecord.reorderBtn) {
			this.expandBtn.parentNode.insertBefore(this.navigationItemRecord.reorderBtn, this.expandBtn);
		}
		this.blockCardHeader.syrainout = this.id;
		if (prevTitleField) {
			this.removeItem(prevTitleField, true, true);
		}
		if (this.page.isAdminMode) {
			this.navigationItemRecord.menusSlot = this.titleField.domItem;
			var deleteMenu = this.navigationItemRecord.menuItems.$delete;
			deleteMenu = deleteMenu && deleteMenu[0];
			if (deleteMenu) {
				deleteMenu.layoutSlot = this.navigationItemRecord.menusSlot;
				this.navigationItemRecord.menusSlot.appendChild(deleteMenu.domItem);
			}
		}
	},
	onLocalizeField: function(field, data, response, $url) {
		this.articleParent.subModuleRecord.applyChange(data, response, $url);
		return false;
	},
	addExpandButton: function() {
		if (!this.expandBtn) {
			var css = this.page.isAdminMode ? "s-nav-admin-block-expand" : "s-nav-block-expand";
			if (this.$item.$css) {
				css += " " + this.$item.$css;
			}
			this.expandBtn = syra_menus.addIconButton(syra_local.box_collapse, css, "onExpandClick");
			this.expandBtn.syraItem = this.id;
			this.titleField.domItem.insertBefore(this.expandBtn, this.titleField.domItem.firstChild);
		}
		this.ensureExpandedState();
	},
	onExpandClick: function() {
		this.expandMenuBlock(!this.$expanded);
	},
	expandMenuBlock: function(expanded) {
		this.$expanded = expanded;
		this.ensureExpandedState();
	},
	ensureExpandedState: function() {
		syra_menus.setButtonTitle(this.expandBtn, this.$expanded ? syra_local.box_collapse : syra_local.box_expand);
		syra_site.dom.toggleClass(this.expandBtn, "s-close", !this.$expanded);
		this.itemsField.domItem.style.display = this.$expanded ? "" : "none";
	},
	onItemInOut: function(on) {
		if (this.page.isAdminMode) {
			syra_menus.highlight(this.titleField, on);
			this.page.toggleCssOnEnter(this.navigationItemRecord.menusSlot, on);
			this.page.toggleCssOnEnter(this.navigationItemRecord.reorderBtn, on);
		}
	},
	dispose: function() {
		this.blockCard = this.titleField = this.itemsField = this.blockCardHeader = null;
		ChildFieldRecord.prototype.dispose.call(this);
	}
});