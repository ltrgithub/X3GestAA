"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RecordArticle = require("syracuse-ui/lib/field/array/recordArticle").RecordArticle;


function ModuleRecord() {}

exports.ModuleRecord = helpers.defineClass(ModuleRecord, RecordArticle, {
	loadBox: function() {
		this.isModuleRecord = true;
		this.$defaultSkinSection = this.$defaultSkinBlock = this.list.$item.$skinCard || "s-h3";
		RecordArticle.prototype.loadBox.call(this);
	},
	reorderItem: function(targetRecord, isAfter) {
		if (targetRecord) {
			targetRecord.domItem.parentNode.insertBefore(this.domItem, isAfter ? targetRecord.domItem.nextSibling : targetRecord.domItem);
		} else {
			if (isAfter) {
				this.list.body.appendChild(this.domItem);
			} else {
				this.list.body.insertBefore(this.domItem, this.list.body.firstChild);
			}
		}
	},

	applyChange: function(metaData) {
		RecordArticle.prototype.applyChange.call(this, metaData);
		if (this.dataset.description && this.dataset.description != this.dataset.title) {
			this.domItem.title = this.dataset.description;
		}
		if (this.dataset.code && this.icon) {
			this.icon.style.backgroundImage = "url('" + document.site.$item.$iconPath + "modules/s_module_" + this.dataset.code.toLowerCase() + ".png')";
		}
		if (this.page.isAdminMode) {
			var titleMeta = metaData && metaData.$properties && metaData.$properties.title;
			if (titleMeta) {
				titleMeta.$isDisabled = true;
			}
			if (titleMeta && titleMeta.$isDisabled && this.boundFields.title && this.boundFields.title.length) {
				document.site.dom.toggleClass(this.boundFields.title[0]._dataValue, "s-disabled", false);
			}
		}
	},
	drawBox: function() {
		this.isReorderDisabled = !this.page.isAdminMode;
		this.$isVerticalDirection = true;
		this.dataRow = this.domItem = document.createElement("div");
		this.$skin = this.page.isAdminMode ? "s-nav-admin-module" : "s-nav-module";
		this.domItem.className = this.$skin;
		this.domItem.setAttribute("data-s-record", this.$uuid);
		this.domItem.syrainout = this;
		this.dataSlot = this.body = document.createElement("div");
		this.icon = document.createElement("div");
		this.icon.className = this.$skin + "-icon";
		this.domItem.appendChild(this.icon);

		this.body.className = this.$skin + "-title";
		this.domItem.appendChild(this.body);

		if (this.page.isAdminMode) {
			this.menusSlot = document.createElement("div");
			this.menusSlot.className = this.$skin + "-links";
			this.domItem.appendChild(this.menusSlot);
		}
		this.applyReorderCapability(true);

		if (this.list.selector.isRowMode) {
			this.body.setAttribute("data-s-picker", "list-selector");
			this.body.className += " s-list-selector-row";
			this.body.setAttribute("data-s-record", this.$uuid);
		}
		this.cardItem = this.page.loadNewItem(this.body, {
			$bind: "title",
			$isMenusHidden: true,
			$isDetailLinkDisabled: true,
			$category: "field",
			$isEditMode: this.$isEditMode,
			$inplace: true
		}, this);
		this.list._core.appendChild(this.domItem);
		this.applyRecordCapabilities();
	},
	_createMenusBox: function() {
		if (!this._isMenuLoaded) {
			this._isMenuLoaded = true;
			if (this.page.isAdminMode) {
				this.page.loadNewItem(this.menusSlot, this.list.defineNewIconMenu("$edit", this.$skin + "-link", true), this);
				this.page.loadNewItem(this.menusSlot, this.list.defineNewIconMenu("$delete", this.$skin + "-link", true), this);
			}
		}
	},

	highlightSelection: function(selected) {
		document.site.dom.toggleClass(this.domItem, "s-list-record-selected", selected);
		if (this.page.isAdminMode) {
			if (selected) {
				if (!this.subModulesItem) {
					this.subModulesHead = document.createElement("div");
					this.subModulesHead.className = "s-nav-admin-submodules-head";
					this.subModulesAdminActions = document.createElement("div");
					this.subModulesHead.appendChild(this.subModulesAdminActions).className = "s-nav-list-menus-cell";

					this.subModulesAdminTitleList = document.createElement("div");
					this.subModulesHead.appendChild(this.subModulesAdminTitleList).className = "s-nav-admin-submodules-titles";

					this.subModulesAdminBodySep = document.createElement("div");
					this.subModulesAdminBodySep.className = "s-nav-admin-body-sep";
					this.subModulesBody = document.createElement("div");
					this.subModulesBody.className = "s-nav-admin-submodules-body";
					this.subModulesItem = this.page.loadNewItem(this.subModulesBody, {
						$isTitleHidden: true,
						$bind: "submodules"
					}, this);
					this.page.adminTableBody.appendChild(this.subModulesHead);
					this.page.adminTableBody.appendChild(this.subModulesAdminBodySep);
					this.page.adminTableBody.appendChild(this.subModulesBody);
				}
			}
			this.subModulesHead.style.display = this.subModulesAdminBodySep.style.display = this.subModulesBody.style.display = selected ? "" : "none";
		} else {
			if (selected) {
				if (!this.subModulesItem) {
					this.subModulesSlot = document.createElement("div");
					this.subModulesSlot.className = "s-nav-submodules-slot";
					this.subModulesBody = document.createElement("div");
					this.subModulesBody.className = "s-nav-submodules-body";
					this.subModulesItem = this.page.loadNewItem(this.subModulesBody, {
						$isTitleHidden: true,
						$bind: "submodules"
					}, this);
					this.subModulesSlot.appendChild(this.subModulesBody);
					this.page.layoutContent.domItem.appendChild(this.subModulesSlot);
				}
				this.subModulesSlot.style.display = "";
			} else {
				if (this.subModulesSlot) {
					this.subModulesSlot.style.display = "none";
				}
			}
		}
		if (selected) {
			this.page.setPreferences(this.dataset.$uuid);
			this.page.ensurePageVisibility();
		}
	},
	dispose: function() {
		var site = document.site;
		site.dom.removeChild(this.subModulesHead);
		site.dom.removeChild(this.subModulesAdminBodySep);
		site.dom.removeChild(this.subModulesBody);
		site.dom.removeChild(this.subModulesSlot);
		this.subModulesItem = this.subModulesSlot = this.subModulesAdminTitleList = this.subModulesAdminBodySep = this.subModulesHead = this.subModulesAdminActions = this.subModulesBody = null;
		this.icon = this.cardItem = this.dataSlot = this.body = this.menusSlot = this.dataRow = null;
		RecordArticle.prototype.dispose.call(this);
	}
});