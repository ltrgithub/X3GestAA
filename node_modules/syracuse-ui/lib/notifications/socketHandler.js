"use strict";
var helpers = require('syracuse-core').helpers;
var io = require('syracuse-ui/deps/socket.io-client/socket.io');




///
/// # socketHandle API
/// This module allow the client framework to register any kind of event in order
//  to receive push server message and emit in return message to server
/// ```javascript
/// var SocketHandler = require('syracuse-x3/lib/notifications/SocketHandler').create();
/// ```
///
var SocketHandler = helpers.defineClass(function() {
	this.listSocketEvent = {};
	this.host = window.location.protocol + "//" + window.location.host;
	this.listSocket = {};
	// on message receive

}, null, {
	///
	/// # register socketio event
	/// register for a specific path and socket io callback depending of event and return the socket instanciate by socket io
	/// ```javascript
	/// var socketio = register(namespace [, messageEvent])
	/// ```
	///
	/// id : identifier of the registered events (session id or other...)
	/// namespace : namespace used by socket io. must be the same in the server.
	/// messageEvent : list of message event with id and callback function that the client can receive.
	/// socketio : return a socketIo Object that allow the client to emit request and send the close socket event to the server.
	/// ```javascript
	/// 	socketio.close(); // for send a close event to the server
	/// ```
	/// ```javascript
	///  	socketio.emit(...) // follow the specs of socket.io
	/// ```
	/// 		message : string that identify the message that the server can received as a event
	///			data : data to send to the server that can be a JSON object or primitive type
	///
	/// ```javascript
	/// var messageEvent = {
	/// 	"event1" : function(socket){
	///      	//some code
	///     },
	/// 	"event2" : function(socket){
	///			// some code
	///     },...
	/// }
	/// ```

	///
	///
	register: function(namespace, messageEvent) {
		this.listSocketEvent[namespace] = {
			namespace: namespace,
			messageEvent: messageEvent
		};
		this._initEvents(); // reinitialize event to manage
		// return a object that allow the client to emit request and close the client
		return this.listSocket[namespace];

	},

	///
	/// # unregister socketio event
	/// unregister socket io event identified by an namespace
	/// ```javascript
	/// unregister: function(namespace)
	/// ```
	///
	/// id : identifier of the registered events
	///
	unregister: function(namespace) {
		// send force disconnection to the server API to disconnect the socket between client and server and remove the event and socket
		if (this.listSocket[namespace]) {
			this.listSocket[namespace].emit("forceDisconnect");
			delete this.listSocket[namespace];
			delete this.listSocketEvent[namespace];
			this._initEvents(); // reinitialize event to manage
		}
	},

	_initEvents: function() {
		var self = this;
		Object.keys(this.listSocketEvent).forEach(function(key) {
			var event = self.listSocketEvent[key];
			if (event) {
				// check if we are already connected
				if (!self.listSocket[key])
					self.listSocket[key] = io.connect(self.host + event.namespace);

				// register all message
				event.messageEvent && Object.keys(event.messageEvent).forEach(function(k) {
					var message = event.messageEvent[k];
					self.listSocket[key].on(k, message);
				});

				self.listSocket[key].on('reconnect', function(data) {
					if (self.listSocket[key] && self.listSocket[key].askKill) {
						clearTimeout(self.listSocket[key].timeoutDisconnect);
					}
				});
				// event to detect disconnection
				self.listSocket[key].on('reconnect_error', function(data) {
					// call disconnect
					// let handle 3 try before
					if (self.listSocket[key] && !self.listSocket[key].askKill) {
						self.listSocket[key].askKill = true;
						self.listSocket[key].timeoutDisconnect = setTimeout(function() {
							self.listSocket[key].disconnect();
							delete self.listSocket[key];
						}, 1000); // disconnect in 1 second
					}

				});

			}
		});
	},
});

///
/// # create an instance of socket Io handler
/// ```javascript
/// create()
/// ```
///
exports.create = function() {
	return new SocketHandler();
};