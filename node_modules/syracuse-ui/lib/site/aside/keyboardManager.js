"use strict";
var helpers = require('syracuse-core/lib/helpers');

var _keyCodeMap = {
	"8": "backspace",
	"9": "tab",
	"13": "enter",
	"16": "shift",
	"17": "ctrl",
	"27": "esc",
	"32": "space",
	"33": "pageup",
	"34": "pagedown",
	"36": "home",
	"37": "left",
	"38": "up",
	"39": "right",
	"40": "down",
	"45": "insert",
	"46": "delete",
	"58": ",",
	"65": "a",
	"66": "b",
	"67": "c",
	"68": "d",
	"69": "e",
	"70": "f",
	"71": "g",
	"72": "h",
	"73": "i",
	"74": "j",
	"75": "k",
	"76": "l",
	"77": "m",
	"78": "n",
	"79": "o",
	"80": "p",
	"81": "q",
	"82": "r",
	"83": "s",
	"84": "t",
	"85": "u",
	"86": "v",
	"87": "w",
	"88": "x",
	"89": "y",
	"90": "z",
	"111": "divide",
	"112": "f1",
	"115": "f4",
	"116": "f5",
	"117": "f6",
	"118": "f7",
	"120": "f9",
	"122": "f11",
	"123": "f12",
	"188": ":"
};


function KeyboardManager() {}


exports.KeyboardManager = helpers.defineClass(KeyboardManager, null, {
	getPage: function(focusField, article) {
		var page = focusField ? focusField.page : null;
		var dialog = document.site.dialogManager.getTopDialogPage();
		if (dialog) {
			if (!page || (page != document.site)) {
				page = dialog._content;
			}
		}
		if (!page && article && article != document.site) {
			page = article.page;
		}
		page = page || document.site.mainPage;
		if (page && page.disposed) {
			page = null;
		}
		return page || document.site;
	},
	_neutralizeWhileUILocker: function(evt) {
		if (evt.target.className === "s-uilocker-loading-blackhole") {
			evt.returnValue = false;
			if (evt.preventDefault) {
				evt.preventDefault();
			}
			evt.stopPropagation();
		}
	},
	load: function() {
		var self = this,
			list, currIst;
		self.shortcurts = {};
		self.keydown = document.addEventListener("keydown", function(event) {
			console.log("keydown " + JSON.stringify(self.shortcurts));
			var site = document.site;
			var focusField = document.site.findField(event.target);
			var article = document.site.findArticle(event.target);
			var page = self.getPage(focusField, article);
			var doEvent = true,
				isFocusOnMesgBox = false;
			event = event || window.event;
			if (event.keyCode == 27) {
				self.shortcurts = {
					esc: true
				};
			} else {
				if (self.shortcurts.esc) {
					self.shortcurts.isEnabled = true;
				}
			}
			var isShorcutApplyed = false;
			self.shortcurts[event.syraKeyMap = _keyCodeMap[event.keyCode]] = true;
			if (site.messageBox && !site.messageBox.displayDisabled) {
				isShorcutApplyed = site.messageBox.applyShortCuts(self.shortcurts);
				isFocusOnMesgBox = true;
			}
			if (!isShorcutApplyed && focusField && focusField.applyShortCuts) {
				isShorcutApplyed = focusField.applyShortCuts(self.shortcurts, event);
			}
			if (!isShorcutApplyed && page) {
				//focusField = (focusField || page.focusField);
				var articleParent = (focusField) ? focusField.articleParent : null;
				if (articleParent && articleParent.arrayLevel === "record" && articleParent.applyShortCuts) {
					isShorcutApplyed = articleParent.applyShortCuts(self.shortcurts, event, focusField);
				}
			}
			if (!isShorcutApplyed && page) {
				var lists;
				list = (page.getLastFocusGrid(focusField) || (((lists = page.getLists()) && lists.length == 1) ? lists[0] : null));
				if (list) {
					isShorcutApplyed = list.applyShortCuts(self.shortcurts, event, focusField);
				} else
				if (page.getCurrNavigationList) {
					list = page.getCurrNavigationList();
					if (list) {
						isShorcutApplyed = list.applyShortCuts(self.shortcurts, event, focusField);
					}
				}
			}
			if (!isShorcutApplyed && page) {
				if (focusField) {
					isShorcutApplyed = page.applyShortCuts(self.shortcurts, event, focusField);
					//TODO : find best way to do that.
					// pb is: f1 open new window so keypress and keyup dont catch so shortcurts is not reinit
					if (isShorcutApplyed && self.shortcurts.f1) {
						self.shortcurts = {};
					}

					if (!isShorcutApplyed && page && page.$isFusionPage && focusField.onFieldInputEvent && event.keyCode !== 27) {
						focusField.onFieldInputEvent(event, self.shortcurts);
						event.stopPropagation();
						return;
					}
				}
				if (isShorcutApplyed && page.$isFusionPage) {
					doEvent = site.fusionGateway.onKeyDow(event);
				}
			}
			if (isShorcutApplyed && self.shortcurts.esc) {
				self.shortcurts = {
					esc: true,
					isEnabled: true
				};
				event.returnValue = false;
				if (event.preventDefault) {
					event.preventDefault();
				}
				return false;
			}
			if ((isShorcutApplyed && self.shortcurts.tab) || isFocusOnMesgBox) {
				event.returnValue = false;
				if (event.preventDefault) {
					event.preventDefault();
				}
				return false;
			}
			self._neutralizeWhileUILocker(event);
		}, false);
		self.keypress = document.addEventListener("keypress", function(event) {
			console.log("keypress " + JSON.stringify(self.shortcurts));
			event = event || window.event;
			var charCode;
			if (event.which == null) {
				charCode = String.fromCharCode(event.keyCode); // old IE			 	
			} else {
				if (event.which != 0 && event.charCode != 0) {
					charCode = event.which;
				}
				if (self.shortcurts.esc) {
					var funcKey = charCode || event.keyCode;
					if (funcKey && funcKey >= 112 && funcKey <= 123) {
						return false;
					}
				}
			}
			if (charCode !== undefined) {
				if (!(self.shortcurts && self.shortcurts.esc)) {
					var focusField = document.site.findField(event.target);
					if (focusField && focusField.validateKeyPress) {
						if (!focusField.validateKeyPress(String.fromCharCode(event.charCode || event.keyCode), self.shortcurts, event)) {
							event.returnValue = false;
							if (event.preventDefault) {
								event.preventDefault();
							}
							return false;
						}
					}
				}
			}
			self._neutralizeWhileUILocker(event);
		}, false);
		self.keyup = document.addEventListener("keyup", function(event) {
			console.log("keyup " + JSON.stringify(self.shortcurts));
			event = event || window.event;
			var site = document.site;
			var focusField = document.site.findField(event.target);
			var article = document.site.findArticle(event.target);
			var page = self.getPage(focusField, article);
			if (self.shortcurts) {
				if (event.keyCode == 27) {
					if (!self.shortcurts.isEnabled) {
						var isEscApplyed;
						if (focusField && focusField.applyEscape) {
							isEscApplyed = focusField.applyEscape(self.shortcurts, event);
						}
						if (!isEscApplyed && page) {
							page.applyEscape(self.shortcurts);
						}
					}
					console.log("keyup clean shortcurts");
					self.shortcurts = {};
				} else {
					if (!self.shortcurts.esc) {
						delete self.shortcurts[event.syraKeyMap = _keyCodeMap[event.keyCode]];
						if (focusField) {
							if (focusField.onKeyUp) {
								focusField.onKeyUp(event);
							} else {
								if (page.$isFusionPage && focusField.onFieldInputEvent) {
									focusField.onFieldInputEvent(event);
									event.stopPropagation();
									return;
								}
							}
						}
					}
				}
			}
			self._neutralizeWhileUILocker(event);
		}, false);
	},
	dispose: function() {
		if (this.keydow || this.keypress || this.keyup) {
			document.removeEventListener("keydown", this.keydown, false);
			document.removeEventListener("keypress", this.keypress, false);
			document.removeEventListener("keyup", this.keyup, false);
		}
		this.keydow = this.keypress = this.keyup = null;
	}
});