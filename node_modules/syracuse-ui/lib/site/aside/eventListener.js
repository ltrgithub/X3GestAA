"use strict";
var helpers = require('syracuse-core/lib/helpers');

function EventListener(){
}

exports.EventListener = helpers.defineClass(EventListener, null, {
    load: function(){
        this._bindGlobalEvent();
        this._bindMenuClick();
        this._bindFieldEvents();
        this._bindSearchFacetEvents();
        this._bindResize();
        this._bindListEvents();
        this._bindChoiceFieldList();
        this._bindBox();
    },
    
    
    _bindGlobalEvent: function(){
        document.site.$$container.bind("click", function(event){
            var availableTarget = false;
            if (document.site.mainPage && document.site.mainPage.isFusionPage) {
                var $$target = $(event.target);
                ["data-s-menu", "data-s-field", "data-s-picker"].some(function(selector){
                    if ((event.target.getAttribute(selector) != null) ||
                    $$target.closest("[" + selector + "]").length > 0) 
                        return availableTarget;
                });
                if (!availableTarget) {
                    if ($$target.closest("[data-s-fusion-page]").length > 0) {
                        return document.site.mainPage.externalAdapter.onGlobalClick(event);
                    }
                }
            }
        });
    },
    _bindResize: function(){
        $(window).bind("resize", function(evt){
            document.site.resize();
        });
    },
    _bindMenuClick: function(){
        document.site.$$container.delegate("a[data-s-menu]", "click", function(event){
            try {
                var $$menu = $(this);
                var menu = document.controller.findItem($$menu);
                if (!menu) {
                    throw new Error("menu not found"); // to manage by
                    // diagnose
                }
                if (!menu.$isDisabled) {
                    menu.click();
                }
            } 
            catch (error) {
                document.site.onError(error);
                return false;
            }
            return false;
        });
    },
    _bindFieldEvents: function(){
        document.site.$$container.delegate("textarea[data-s-field],input[data-s-field],select[data-s-field]", "click change keydown keypress keyup focusin focusout", function(event){
            var field = document.controller.findField($(event.target));
            if (field) {
                var doEvent = true;
                if (event.type == "click" && document.site.layoutAuthoring) {
                    doEvent = document.site.layoutAuthoring.onClickItem(field, this);
                }
                if (doEvent) {
                    field.onFieldInputEvent(event);
                    event.stopPropagation();
                }
            }
        }).delegate("a.s-icon-link", "click", function(event){
            var field = document.controller.findField($(event.target));
            if (field) {
                field.onFieldInputEvent(event);
                event.stopPropagation();
            }
            return false;
        }).delegate("[data-s-picker]", "click", function(event){
            var field = document.controller.findField($(event.target));
            if (event.target.getAttribute("data-s-picker") == "menus") {
                (field ? field.menusController : document.controller.findArticle($(event.target))).contextMenu.onFieldClickPicker();
            }
            else {
                if (field) {
                    field.onClickPicker(event.target);
                }
            }
            return false;
        }).delegate("[data-s-field-item]", "mouseenter mouseleave", function(event){
            var field = document.controller.findField($(event.target));
            if (field) {
                field.onFieldMouseEvent(event);
                //event.stopPropagation();
            }
        });
    },
    _bindListEvents: function(){
        document.site.$$container.delegate("a[data-s-sort]", "click", function(event){
            var $$link = $(this);
            var list = document.controller.findArticle($$link);
            list.sortCapability.onSortClick(event, $$link.attr("data-s-sort"));
            return false;
        }).delegate("a.s-alphatab-link", "click", function(){
            var $$link = $(this);
            document.controller.findArticle($$link).sortCapability.onSortAlphaTab($$link);
            return false;
        }).delegate("a[data-s-cardview-opener]", "click", function(event){
            var $$link = $(this);
            var article = document.controller.findArticle($$link);
            article.builder.cardview.onOpenerClick($$link, article);
            return false;
        }).delegate("a[data-s-page]", "click", function(event){
            var $$link = $(this);
            document.controller.findArticle($$link).pagingCapability.onPageClick($$link);
            return false;
        }).delegate(".s-list-selector-row", "click mouseenter mouseleave", function(event){
            var list = document.controller.findArticle($(this)).list;
            if (event.type == "click") {
                list._store.selector.onSelectRecords(event);
            }
            else {
                list._store.selector.onSelectMouseEvent(event);
            }
            return false;
        }).delegate(".s-list-selector,.s-list-selector-all", "click", function(event){
            var $$link = $(this);
            var article = document.controller.findArticle($$link);
            event.stopPropagation();
            (article.list ? article.list : article)._store.selector.onSelectRecords(event);
        }).delegate("a.s-field-diagnose-link", "click", function(event){
            var $$link = $(event.currentTarget);
            var field = document.controller.findField($$link);
            if (field) {
                field.focus();
            }
            event.stopPropagation();
        });
    },
    _bindSearchFacetEvents: function(){
        document.site.$$container.delegate("input.s-search-facet-member-check", "change", function(){
            var $$input = $(event.target);
            document.controller.findArticle($$input).onInputMemberChange($$input);
            event.stopPropagation();
        });
    },
    _bindChoiceFieldList: function(){
        document.site.$$container.delegate("a[data-s-cb-index]", "click", function(){
            var field = document.controller.findField($(this));
            if (field) {
                field.builder.onChoiceItemClick(parseInt(this.getAttribute("data-s-cb-index"), 10));
            }
            return false;
        });
    },
    _bindBox: function(){
        document.site.$$container.delegate("a[data-s-box]", "click", function(event, data){
            var $$link = $(this);
            var box = document.controller.findBox($$link);
            var doEvent = true;
            if (document.site.layoutAuthoring) {
                doEvent = document.site.layoutAuthoring.onClickItem(box, this);
            }
            if (doEvent) {
                if (box._tabTitle) {
                    var isTabSelected = box.layoutParent.tabOpened == box;
                    if (isTabSelected) {
                        box.page.externalAdapter.onBoxClick({
                            box: box,
                            event: event,
                            tabIdx: $$link.index()
                        });
                    }
                    else {
                        if (!document.site.DDAuthoring) {
                            var open = !box.$item.$opened;
                            var isFirstTime = !box.loaded;
                            box.page.externalAdapter.onBoxToggle({
                                nativeEvent: event,
                                nativeEvenData: data,
                                box: box,
                                isTabSelected: isTabSelected,
                                open: open,
                                isFirstTime: isFirstTime,
                                tabIdx: $$link.index(),
                                doEvent: function(){
                                    if (!isTabSelected) {
                                        box.openBox(open);
                                    }
                                    document.site.resize();
                                }
                            });
                            return box.authoringNode ? true : false; //authoringNode => true hooked by layout
                        }
                    }
                }
                else {
                    if (box.$item.$isBoxCollapsable) {
                        document.site.onBeforClick();
                        box.$opened = !box.$opened;
                        var isFirstTime = !box.loaded || false;
                        if (box.$opened) {
                            document.site.resize();
                        }
                        box.page.externalAdapter.onBoxToggle({
                            box: box,
                            open: box.$opened,
                            isFirstTime: isFirstTime,
                            doEvent: function(){
                                box.openBox(box.$opened);
                            }
                        });
                    }
                }
            }
            return false;
        });
        document.site.$$container.delegate("a[data-s-box-picker]", "click", function(event){
            document.controller.findBox($(this)).doPicker(this.getAttribute("data-s-box-picker"));
            return false
        });
    },
    dispose: function(){
        document.site.$$container.unbind();
        document.site.$$container.undelegate();
        $(window).unbind("resize");
    }
});
