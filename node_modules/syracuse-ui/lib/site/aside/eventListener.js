"use strict";
var helpers = require('syracuse-core/lib/helpers');
var KeyboardManager = require('syracuse-ui/lib/site/aside/keyboardManager').KeyboardManager;

function EventListener() {}

exports.EventListener = helpers.defineClass(EventListener, null, {
	load: function() {
		this._bindGlobalEvent();
		(this.keyboardManager = new KeyboardManager()).load();
		this._bindFieldEvents();
		this._bindSearchFacetEvents();
		this._bindResize();
		this._bindListEvents();
		this._bindMouseEnterLeave();
	},
	_bindGlobalEvent: function() {
		// return;
		document.site.$$layoutSlot.bind("click", function(event) {
			var availableTarget = false;
			document.site.toggleTopPanel(false, event);
			document.site.onBeforClick(undefined, event);
			var mainPage = document.site.mainPage;
			if (mainPage && !mainPage.designer && mainPage.isFusionPage) {
				var $$target = $(event.target);
				["data-s-menu", "data-s-field", "data-s-picker"].some(function(selector) {
					if ((event.target.getAttribute(selector) != null) || $$target.closest("[" + selector + "]").length > 0)
						return availableTarget;
				});
				if (!availableTarget) {
					if ($$target.closest("[data-s-fusion-page]").length > 0) {
						return mainPage.externalAdapter.onGlobalClick(event);
					}
				}
			}
		});
	},
	_bindResize: function() {
		$(window).bind("resize", function(event) {
			document.site.resizeTimeOut = setTimeout(function() {
				document.site.resize();
				clearTimeout(document.site.resizeTimeOut);
			});
		});
	},
	_bindMouseEnterLeave: function() {
		document.site.$$layoutSlot.delegate("[data-s-inout]", "mouseenter mouseleave", function(event) {
			if (event.currentTarget.getAttribute("data-s-field")) {
				var field = document.site.findField(event.currentTarget);
				if (field && field.domItem == this) {
					field.onItemEnterLeave(event);
				}
			} else {
				var article = document.site.findArticle(event.currentTarget);
				if (article.onItemEnterLeave) {
					article.onItemEnterLeave(event);
				}
			}
		});
	},
	_bindFieldEvents: function() {
		var self = this; // manage key tab +
		document.site.$$layoutSlot.delegate("textarea,input,select,[contenteditable]", "mousedown click change focusin focusout", function(event) {
			if (this.syra_field_id) {
				var field = document.site.findField(this);
				if (field) {
					if (event.type == "focusin" || event.type == "click") {
						document.site.onBeforClick(null, event);
					}
					if (field.page.designer && field.page.designer.itemTool) {
						if (!field.page.designer.itemTool.onClickItem(field, this, field.article)) {
							event.stopPropagation();
							return false;
						}
					}
					field.onFieldInputEvent(event);
					field.page.registerLastFocusGrid(field);
					event.stopPropagation();
				}
			}
		}).delegate("object.s-field-flash", "mousedown", function(event) {
			var field = document.site.findArticle(this);
			if (field && !field.page.isDesignFreeze) {
				field.onFieldInputEvent(event);
				event.stopPropagation();
			}
		}).delegate("a[data-s-field-binary]", "click focusin focusout", function(event) {
			var field = document.site.findField(this);
			if (field && !field.page.isDesignFreeze) {
				field.onFieldInputEvent(event);
				if (event.type != "click") {
					event.stopPropagation();
					return false;
				}
			}
		}).delegate("a.s-icon-link", "click", function(event) {
			var field = document.site.findField(this);
			if (field && !field.page.isDesignFreeze) {
				field.onFieldInputEvent(event);
				event.stopPropagation();
			}
			return false;
		}).delegate("textarea", "input", function(event) {
			var field = document.site.findField(this);
			if (field) {
				field.onFieldInputEvent(event);
				event.stopPropagation();
			}
			return false;
		});
	},
	_bindListEvents: function() {
		document.site.$$layoutSlot.delegate("[data-s-menu],[data-s-picker],[data-s-box]", "click", function(event, data) {
			try {
				if (!this.syraIsDisabled) {
					var article = document.site.findArticle(this);
					var pickerId = event.currentTarget.getAttribute("data-s-picker");
					var menuId = this.getAttribute("data-s-menu");
					var boxId = this.getAttribute("data-s-box");
					var doEvent = true;
					if (article && pickerId == "diag-picker") {
						var panel;
						if (this.$syraDiagPage) {
							if (document.site.pagesMap[this.$syraDiagPage]) {
								panel = document.site.pagesMap[this.$syraDiagPage].diagnosesPanel;
							}
						}
						panel = panel || document.site.diagnosesPanel;
						if (panel) {
							panel.onClickPicker(this);
							doEvent = false;
						}
					}
					if (doEvent) {
						if (article.page.designer && article.page.designer.itemTool) {
							doEvent = article.page.designer.itemTool.onClickItem(box, this, article);
						}
						if (doEvent) {
							if (boxId) {
								var box = document.site.findBox(this);
								if (box) {
									doEvent = !article.onBoxClickItem || article.onBoxClickItem(box, this);
									if (doEvent) {
										if (box.isTitleUrlLink && this.syraBoxPickerId != "expand") {
											return true;
										}
										var $$link = $(this);
										if (box.tabTitle) {
											var isTabSelected = box.layoutParent.tabOpened == box;
											if (isTabSelected) {
												box.page.externalAdapter.onBoxClick({
													box: box,
													event: event,
													tabIdx: $$link.index()
												});
											} else {
												if (!document.site.ddManager.ddAgent) {
													var open = !box.$item.$opened;
													var isFirstTime = !box.loaded;
													box.page.externalAdapter.onBoxToggle({
														nativeEvent: event,
														nativeEvenData: data,
														box: box,
														isTabSelected: isTabSelected,
														open: open,
														isFirstTime: isFirstTime,
														tabIdx: $$link.index(),
														doEvent: function() {
															if (!isTabSelected) {
																document.site.boxFocus = box;
																box.openBox(open);
															}
															document.site.resize(true);
														}
													});
													return false;
												}
											}
										} else {
											if (box.$item.$isBoxCollapsable) {
												document.site.onBeforClick(box);
												box.expandBody(undefined, event);
											}
										}
									} else {
										event.stopPropagation();
									}
								}
							} else {
								document.site.onBeforClick(undefined, event);
								if (menuId) {
									var menu = document.site.findMenu(this);
									if (menu && !menu.$isDisabled) {
										menu.click(event);
									}
								} else {
									if (pickerId && article) {
										if (!article.onClickPicker || article.onClickPicker(event.currentTarget, event)) {
											if (event.currentTarget.syraSiteObserver) {
												document.site[event.currentTarget.syraSiteObserver].onClickPicker(event.currentTarget, event);
											} else {
												switch (pickerId) {
													case "s-dialog-close":
													case "s-dialog-ok":
														var content = article.page;
														if (this.syraBoxId) {
															content = document.site.findBox(this);
														}
														if (content && content.dialogWrapper) {
															content.dialogWrapper.onClickPicker(this);
														}
														break;
													case "field-choice":
														var field = document.site.findField(this);
														if (field) {
															field.builder.onChoiceItemClick(this.syraChoice);
														}
														break;
													case "box-picker":
														document.site.findBox(event.target).doPicker(event.target.syraBoxPickerId);
														break;
													case "field-diagnose-link":
														var field = document.site.findField(this);
														if (field) {
															field.focus();
														}
														event.stopPropagation();
														break;
													case "s-bar-collapse":
													case "s-bar-title":
														article.page.onBarEvent(event.currentTarget, event);
														break;
													default:
														var field = document.site.findField(this);
														if (field) {
															field.onClickPicker(event.currentTarget, event);
														}
														break;
												}
											}
										}

									}

								}
							}
						} else {
							event.stopPropagation();
						}
					}
				}
			} catch (error) {
				document.site.onError(error);
			} finally {
				if (article && article.page) {
					article.page.registerLastFocusGrid(article);
				}
				return event.syraRetValue || false;
			}
		});
	},
	_bindSearchFacetEvents: function() {
		document.site.$$layoutSlot.delegate("input.s-search-facet-member-check,input.s-sv-search-facet-member-check", "change", function() {
			var $$input = $(this);
			document.site.findArticle(this).onInputMemberChange($$input);
			return false;
		});
	},
	dispose: function() {
		if (this.keyboardManager) {
			this.keyboardManager.dispose();
			this.keyboardManager = null;
		}
		document.site.$$layoutSlot.unbind();
		document.site.$$layoutSlot.undelegate();
		$(window).unbind("resize");
	}
});