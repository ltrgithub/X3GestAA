"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Article = require("syracuse-ui/lib/article/article").Article;

function SiteTopPanel() {}

exports.SiteTopPanel = helpers.defineClass(SiteTopPanel, Article, {
	loadBox: function() {
		this._localize = document.site.localize;
		this.page.initializeNewItem(this, {});
		this.$$item = $(this.layoutSlot);
		document.site.setZIndex(this.layoutSlot);
		Article.prototype.loadBox.call(this);
		if (document.site.userProfile) {
			document.site.userProfile.ensureFormBlock();
			document.site.userProfile.ensurePageVisibility();
			if (document.site.userProfile.domItem) {
				document.site.emptyDom(this.userProfileSlot);
				this.userProfileSlot.appendChild(document.site.userProfile.domItem);
			}
		}
		if (this.page.fusionGateway && this.page.fusionGateway.activatedBook) {
			$(".s-user-form-title-field").css("display", "none");
			$(".s-site-nav-bar").css("display", "none");
		} else {
			$(".s-user-form-title-field").css("display", "");
			$(".s-site-nav-bar").css("display", "");
		}
		var rect = document.site.getBoundingClientRect(this.body);
		this.layoutSlot.style.height = (rect.height + rect.top) + "px";
	},
	_buildItems: function($links, addColumns) {
		var ids = Object.keys($links);
		var $items = [];
		if (addColumns) {
			var $layout;
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				if (!$layout || $layout.$items.length == 4) {
					$items.push($layout = {
						$layoutType: "stack",
						$items: []
					});
				}
				this.$prototype.$links[ids[ii]] = $links[ids[ii]];
				$layout.$items.push({
					$bind: ids[ii]
				});
			}
		} else {
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				this.$prototype.$links[ids[ii]] = $links[ids[ii]];
				$items.push({
					$bind: ids[ii]
				});
			}
		}
		return {
			$layoutType: "row",
			$autoSize: true,
			$items: $items
		};
	},
	onMenuClick: function(menuItem) {
		switch (menuItem.$item.$bind) {
			case "$help":
				document.site.gotoHelp();
				return false;
		}
		return true;
	},
	addNavigationBar: function() {
		var $dashboard = this.$prototype.$navigation.$dashboard;
		var ids = Object.keys($dashboard);
		for (var ii = 0, jj = ids.length; ii < jj; ii++) {
			switch (ids[ii]) {
				case "devsos":
				case "devsosqueries":
				case "arrayTest":
				case "changeLog":
					// case "mobileHome":
					// case "mobileDesktopAuthoring":
				case "office":
					if (!document.site.developpementMode) {
						delete $dashboard[ids[ii]];
						continue;
					}
					break;
			}
			/*var $title = this._localize["dash_" + ids[ii]];
            
            
             if ($title) {
            
            
             $dashboard[ids[ii]].$title = $title;
            
            
             }*/


		}


		var $menu = {
			$category: "menus",
			$skin: "s-site-nav-bar",
			$layout: {
				$layoutType: "stack",
				$items: [{
					$category: "menus",
					$title: this._localize.siteTopPanel_dashboards,
					$slotStyle: "s-site-top-pn-dashboards",
					$skin: "s-site-nav",
					$layout: this._buildItems(this.$prototype.$navigation.$dashboard, true)
				}]
			}
		};
		this.page.layoutValidator.validate(this.page.loadNewItem(this.body, $menu, this).layoutContent, true);
	},
	drawBox: function() {
		this.body = document.createElement("div");
		this.$$item[0].appendChild(this.body).id = "s-site-top-pn-body";
		var bar = document.createElement("div");
		this.body.appendChild(bar).id = "s-site-top-pn-top-bar";
		this.userProfileSlot = document.createElement("div");
		bar.appendChild(this.userProfileSlot).id = "s-site-top-pn-user-profile";

		this.addNavigationBar();

		if (this.$prototype.$navigation.$about) {
			this._aboutItem = this.page.loadNewItem(this.body, {
				$category: "menus",
				$title: this._localize.siteTopPanel_about,
				$skin: "s-site-top-pn-about-bar",
				$layout: this._buildItems(this.$prototype.$navigation.$about)
			}, this);
			this.page.layoutValidator.validate(this._aboutItem.layoutContent, true);
		}
	},
	closePanel: function() {
		var $$item = document.site.userProfile ? document.site.userProfile.$$item : null;
		if ($$item) {
			$$item.detach();
		}
		this.layoutSlot.style.display = "none";
		document.site.emptyDom(this.layoutSlot);
		this.dispose();
	},
	dispose: function() {
		this._localize = this._aboutItem = this.userProfileSlot = this.$urlParams = null;
		Article.prototype.dispose.call(this);
	}
});