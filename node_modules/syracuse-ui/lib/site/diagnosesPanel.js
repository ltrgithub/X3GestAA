"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var AreaScroller = require('syracuse-ui/lib/site/authoring/areaScroller').AreaScroller;

function Group(severity, viewer){
    var group = document.createElement("div");
    group.className = 's-diag-view-group-' + (this.severity = severity);
    this.$$group = $(group);
    this.viewer = viewer;
}

helpers.defineClass(Group, null, {
    empty: function(field){
        if (field) {
            this.$$group.children().children().children("a[data-s-menu=" + field.id + "]").parent().parent().remove();
        }
        else {
            this.$$group.empty();
        }
    },
    drawLabel: function($diagnose){
        var label = document.createElement("label");
        label.className = "s-diag-view-msg-label";
        var $$label = $(label);
        $$label.append(document.site.formatHTMLMessage($diagnose.message));
        return $$label;
    },
    drawDiagnose: function($diagnose, options){
        var self = this;
        var html = document.createElement("div");
        html.className = "s-diag-view-msg s-diag-view-msg-" + self.severity;
        var $$diagMsg = $(html);
        
        var $$label = self.drawLabel($diagnose);
        $$diagMsg[0].appendChild($$label[0]);
        // add field link if any
        if (options) {
            $$label.prepend(options.$$fieldLink);
            // push field and $$diagMsg into viewer _fieldDiagnoses array for focus purposes
            self.viewer.pushFieldDiagnose($$label[0], options.field);
        }
        // add expand button if needed (line break or string max length)
        if ($$label.find("br")[0]) {//$diagnose.message.indexOf("\n") > 0
            var expandedText = $$label[0].innerHTML.substr($$label[0].innerHTML.indexOf("<br>") + "<br>".length);
            self._wrapTextToHide(expandedText, $$label, $$diagMsg);
        }
        else {
            var diagMaxLength = 130;
            if ($$label[0].textContent.length > diagMaxLength) {
                // getting understandable text from 100 first characters
                var maxLengthText = $$label[0].textContent.substr(0, diagMaxLength);
                var maxLengthTextWords = maxLengthText.split(/\s/);
                maxLengthTextWords.splice(maxLengthTextWords.length - 1);
                maxLengthText = maxLengthTextWords.join(" ");
                
                // wrap text to hide
                var expandedText = $$label[0].innerHTML.substr($$label[0].innerHTML.lastIndexOf(maxLengthText) + maxLengthText.length);
                self._wrapTextToHide(expandedText, $$label, $$diagMsg, true);
            }
        }
        
        // close button
        //self._appendDiagnoseCloseButton($$diagMsg);
        
        $$diagMsg[0].style.display = "none";
        self.$$group[0].appendChild($$diagMsg[0]);
    },
    _appendDiagnoseCloseButton: function($$diagMsg){
        var html = document.createElement("a");
        html.className = "s-diag-view-msg-close";
        $$diagMsg[0].appendChild(html);
    },
    _wrapTextToHide: function(textToHide, $$label, $$diagMsg, lineBreak){
        if (textToHide.match(/\S/g)) {
            $$label[0].innerHTML = $$label[0].innerHTML.replace(textToHide, (lineBreak ? "<br>" : "") + "<span class='s-diag-view-msg-expanded-text'>" + textToHide + "</span>");
            var expander = document.createElement("a");
            expander.className = "s-diag-view-msg-expand";
            $$diagMsg.append($(expander));
        }
    },
    appendToViewer: function($$body){
        this.$$group.appendTo($$body);
    },
    dispose: function(){
        this.$$count = this.$$group = null;
    }
});

function Groups(viewer){
    var self = this;
    self.severities = {};
    self._groups = (["fatal", "error", "warning", "info", "success"]).map(function(severity){
        return self.severities[severity] = new Group(severity, viewer);
    });
    self.viewer = viewer;
}

helpers.defineClass(Groups, null, {
    getGroup: function(severity){
        // FDB - Take into account bad severity values
        if (severity == null || severity.length == 0) {
            severity = "error";
        }
        else {
            severity = severity.toLowerCase();
        }
        var grp = this.severities[severity];
        return grp ? grp : this.severities["error"];
    },
    drawFieldDiagnoses: function($diagnoses, field){
        var self = this;
        field.ensureDiagnoseSlot();
        var group;
        $diagnoses.forEach(function($diagnose){
            field.drawDiagnose($diagnose, group = self.getGroup($diagnose.severity));
            self.drawLinks($diagnose);
            //self.viewer.pushFieldDiagnose(field);
        });
        field.domDiagnose.style.visibility = "";
        if (group) {
            field.toggleDiagnose("s-" + group.severity, true);
        }
    },
    drawDiagnoses: function($diagnoses){
        var self = this;
        $diagnoses.forEach(function($diagnose){
            self.getGroup($diagnose.severity).drawDiagnose($diagnose);
            self.drawLinks($diagnose);
        });
    },
    drawLinks: function($diagnose){
        if ($diagnose.$links || $diagnose.$actions) {
            this.viewer.drawLinks($diagnose);
        }
    },
    empty: function(field){
        var self = this;
        self._groups.forEach(function(group){
            group.empty(field);
        });
    },
    appendToViewer: function($$body){
        this._groups.forEach(function(group){
            group.appendToViewer($$body);
        });
    },
    dispose: function(){
        var self = this;
        self._groups.forEach(function(group){
            delete self.severities[group.severity];
            group.dispose();
        });
        delete self._groups;
        delete self.viewer;
    }
});

function DiagnosesPanel(){
}

exports.DiagnosesPanel = helpers.defineClass(DiagnosesPanel, null, {
    _emptyViewer: function(){
        this._fieldDiagnoses = null;
        this.$$item.hide();
        this._emptyMenus();
        this._emptyGroups();
        this._fitPageToContainer();
    },
    _emptyMenus: function(){
        if (this._menus) {
            this._menus.getArticle().removeItem(this._menus, true);
            delete this._menus;
        }
    },
    _emptyGroups: function(){
        if (this.groups) {
            this.groups.empty();
        }
    },
    appendToPage: function(page){
        this.page = page;
        var html = document.createElement("div");
        html.className = "s-diag-view";
        this.$$item = $(html).appendTo($(this.page.diagnoseSlot));
    },
    _refreshViewer: function(options, page){
        if (!this.disableViewer) {
            var self = this;
            
            // append diagnoses to body
            self.total = 0;
            self.$$body.empty();
            self.groups._groups.forEach(function(group){
                var count = group.$$group.children().children("label").length;
                if (count) {
                    self.total += count;
                    group.$$group.appendTo(self.$$body);
                }
            });
            
            // show diagnoses panel if any diagnose
            if (self.total > 0) {
                self.showDiagnosesPanel();
            }
            // 0 diagnose => clean
            else {
                self.$$item.hide();
            }
            self._fitPageToContainer();
        }
    },
    _fitPageToContainer: function(){
        if (this.page.fitPageToContainer) {
            this.page.fitPageToContainer();
        }
    },
    showDiagnosesPanel: function(){
        var self = this;
        
        // show next nav button if necessary (field diagnoses > 0)
        var fieldDiag = [];
        fieldDiag = self.$$body.find("a.s-diag-view-msg-link");
        if (self._fieldDiagnoses.length > 0) {
            self.$$nextLink.show();
        }
        else {
            self.$$nextLink.hide();
        }
        
        // diagnoses in an array 
        var diagMsg = [];
        diagMsg = self.$$body.find("div.s-diag-view-msg");
        
        
        // show expand (more/less) button if necessary (total > 1)
        if (self.total > 1) { //(self.$$body.find("label").length > 1)
            // expand link text value for diagnose panel closed state
            var moreText = (self.total) - 1 == 0 ? self.localize.diag_expand : (self.total - 1) + self.localize.diag_expand;
            
            // if expand link already set
            if (self.$$expandLink[0].textContent) {
                // diagnoses panel is in opened mode
                if (self.$$expandLink[0].textContent.indexOf(self.localize.diag_collapse) != -1) {
                    for (var ii = 0; ii < diagMsg.length; ii++) {
                        diagMsg[ii].style.display = "block";
                    }
                }
                // diagnoses panel is in closed mode
                else {
                    for (var ii = 0; ii < diagMsg.length; ii++) {
                        diagMsg[ii].style.display = ii == 0 ? "block" : "none";
                    }
                    self.$$expandLink[0].textContent = moreText;
                }
            }
            // expand link not yet set
            else {
                for (var i = 0; i < diagMsg.length; i++) {
                    diagMsg[i].style.display = i == 0 ? "block" : "none";
                }
                self.$$expandLink[0].textContent = moreText;
            }
            self.$$expandLink.show();
        }
        else {
            // if one diag only, expand button is not necessary.
            if (self.total == 1) {
                diagMsg[0].style.display = "block";
                self.$$expandLink[0].textContent = "";
                self.$$expandLink.hide();
            }
        }
        
        // show diagnoses panel content
        self.$$core[0].style.display = "inline-block";
        self.$$item.show();
        document.site.setZIndex(self.$$item[0]);
        document.site.setZIndex(self.$$diagCloser[0]);
        self.$$diagOpener[0].style.display = "none";
        
        // success style if severity success
        if (self.onSuccess) {
            self._applySuccessStyle();
        }
    },
    _applySuccessStyle: function(){
        var self = this;
        
        // append success menu icon
        // TODO
        /*
         menuItem.$$menuIcons.empty();
         var html = document.createElement("a");
         html.className = "s-page-menus-icons-info-success";
         menuItem.$$menuIcons[0].appendChild(html);
         */
        // apply success style to diagnoses panel
        self.$$core[0].className = "s-diag-view-core-success";
        self.$$core.find("ul.s-diag-view-links-body")[0].className = "s-diag-view-links-body-success";
        self.$$core.find("nav.s-diag-view-links")[0].className = "s-diag-view-links-success";
        self.$$diagViewLinks[0].className = "s-diag-view-links-bar-success";
        var listArray = self.$$diagViewLinks.find("li.s-diag-view-links-li");
        var listArrayMain = self.$$diagViewLinks.find("li.s-diag-view-links-li");
        var anchorArray = self.$$diagViewLinks.find("a.s-diag-view-links-link");
        var anchorArrayMain = self.$$diagViewLinks.find("a.s-diag-view-links-main-link");
        
        if (listArray[0]) {
            self._applyStyleToArray(listArray, "s-diag-view-links-li-success");
            //self.$$diagViewLinks.find("li.s-diag-view-links-li")[0].className = "s-diag-view-links-li-success";
        }
        else 
            if (listArrayMain[0]) {
                self._applyStyleToArray(listArrayMain, "s-diag-view-links-li-success");
            //self.$$diagViewLinks.find("li.s-diag-view-links-main-li")[0].className = "s-diag-view-links-main-li-success";
            }
        
        if (anchorArray[0]) {
            self._applyStyleToArray(anchorArray, "s-diag-view-links-link-success");
            //self.$$diagViewLinks.find("a.s-diag-view-links-link")[0].className = "s-diag-view-links-link-success";
        }
        else 
            if (anchorArrayMain[0]) {
                self._applyStyleToArray(anchorArray, "s-diag-view-links-main-link-success");
            //self.$$diagViewLinks.find("a.s-diag-view-links-main-link")[0].className = "s-diag-view-links-main-link-success";
            }
        this._fitPageToContainer();
    },
    _applyStyleToArray: function(array, css){
        for (var ii = 0; ii < array.length; ii++) {
            array[ii].className = css;
        }
    },
    _cleanSuccessStyle: function(){
        var self = this;
        // clean diagnoses panel
        self._emptyViewer();
        
        // remove success style
        self.$$core[0].className = "s-diag-view-core";
        self.$$diagViewLinks[0].className = "s-diag-view-links-bar";
        
        // remove success icon from menu
        // TODO
        
        self.onSuccess = false;
    },
    _initialize: function(){
        this.localize = locale.resources(module)();
        var self = this;
        
        // core ($$item child)
        var html = document.createElement("div");
        html.className = "s-diag-view-core";
        self.$$item.append(self.$$core = $(html));
        
        // close button ($$core child)
        html = document.createElement("a");
        html.className = "s-diag-view-close";
        self.$$core.append(self.$$diagCloser = $(html));
        
        
        // content ($$core child)
        html = document.createElement("div");
        html.className = "s-diag-view-content";
        self.$$core.append(self.$$content = $(html));
        
        
        // body ($$content child)
        html = document.createElement("div");
        html.className = "s-diag-view-msg-list";
        self.$$body = $(html);
        self.groups = new Groups(self);
        self.$$content.append(self.$$body);
        
        // navigation bar ("next" button) (navigation through diagnoses with field links)
        // $$content child
        html = document.createElement("div");
        html.className = "s-diag-view-navigation-bar";
        self.$$content.append(self.$$diagNavBar = $(html));
        
        // navigation links/buttons ("next") ($$diagNavBar child)
        html = document.createElement("a");
        html.className = "s-diag-view-nav-next";
        html.title = self.localize.diag_next_tooltip;
        html.textContent = self.localize.diag_next;
        self.$$diagNavBar.append(self.$$nextLink = $(html));
        self.$$nextLink.hide();
        
        
        // links bar ($$core child)
        html = document.createElement("div");
        html.className = "s-diag-view-links-bar";
        self.$$core.append(self.$$diagViewLinks = $(html));
        
        
        // expand tab (collapse/expand) ($$core child)
        html = document.createElement("a");
        html.className = "s-diag-view-expander";
        self.$$core.append(self.$$expandLink = $(html));
        self.$$expandLink.hide();
        
        // diag opening tab (used when diagnoses panel is closed) ($$item child)
        html = document.createElement("a");
        html.className = "s-diag-view-opener";
        self.$$diagOpener = $(html);
        self.$$diagOpener[0].textContent = self.localize.diag_opener;
        self.$$diagOpener[0].style.display = "none";
        
        html = document.createElement("div");
        html.className = "s-diag-view-open";
        html.appendChild(self.$$diagOpener[0]);
        self.$$item[0].appendChild(html);
        
        self._bindEvents(true);
        
        self.pageScroller = new AreaScroller(this.page.$$body);
        self.diagPanelScroller = new AreaScroller(this.$$content);
    },
    _bindEvents: function(bind){
        var self = this;
        if (self.$$item) {
            if (bind) {
                self.$$item.delegate("a.s-diag-view-msg-link", "click", function(){
                    var field = document.controller.findItem($(this));
                    if (field) {
                        self._focusField(field);
                        self.onNavigationClick(0, field);
                    }
                    return false;
                }).delegate("a.s-diag-view-msg-expand, a.s-diag-view-msg-collapse", "click", function(){
                    $(this).parent().find("span").toggle();
                    $(this).toggleClass("s-diag-view-msg-expand").toggleClass("s-diag-view-msg-collapse");
                    self._fitPageToContainer();
                    return false;
                }).delegate("a.s-diag-view-msg-close", "click", function(){
                    //self._onDiagnoseClose($(this));
                }).delegate("a.s-diag-view-nav-next", "click", function(){// bind actions for navigation link
                    self.onNavigationClick($(this)[0]);
                }).delegate("a.s-diag-view-close", "click", function(){
                    if (self.$$core) {
                        self.$$core[0].style.display = "none";
                        self._showDiagOpener();
                        self._fitPageToContainer();
                    }
                    return false;
                }).delegate("a.s-diag-view-opener", "click", function(){
                    self._onDiagOpenerClick();
                }).delegate("a.s-diag-view-expander", "click", function(){
                    self._onDiagExpand();
                });
            }
            else {
                self.$$item.undelegate();
            }
        }
    },
    _onDiagExpand: function(){
        var self = this;
        // expand link text value for diagnose panel closed state
        var moreText = (self.total) - 1 == 0 ? self.localize.diag_expand : (self.total - 1) + self.localize.diag_expand;
        
        // getting all diagnoses in diagnose panel
        var diagMsg = [];
        diagMsg = self.$$body.find("div.s-diag-view-msg");
        
        // precondition 1 : is a diag focused ?
        var diagFocused;
        for (var ii = 0; ii < diagMsg.length; ii++) {
            if (diagMsg[ii].children[0].className.indexOf("s-diag-view-msg-focus") > -1) {
                diagFocused = ii;
            }
        }
        
        // precondition 2 : was expand link on diagnose panel opened/closed state ?
        // expand link previously on diagnose panel opened state
        if (self.$$expandLink[0].textContent.indexOf(self.localize.diag_collapse) > -1) {
        
            // precondition 1 true, showing previous diag focused
            if (diagFocused != undefined) {
                for (var ii = 0; ii < diagMsg.length; ii++) {
                    diagMsg[ii].style.display = "none";
                }
                diagMsg[diagFocused].style.display = "block";
            }
            // precondition 1 false, showing first diag 
            else {
                for (var ii = 0; ii < diagMsg.length; ii++) {
                    diagMsg[ii].style.display = ii == 0 ? "block" : "none";
                }
            }
            self.$$expandLink[0].textContent = moreText;
            
        }
        // expand link previously on diagnose panel closed state, show all diagnoses
        else {
            for (var ii = 0; ii < diagMsg.length; ii++) {
                diagMsg[ii].style.display = "block";
            }
            self.$$expandLink[0].textContent = self.localize.diag_collapse;
        }
        self._fitPageToContainer();
    },
    _showDiagOpener: function(){
        if (this.$$diagOpener) {
            document.site.setZIndex(this.$$diagOpener[0]);
            this.$$diagOpener[0].style.display = "inline-block";
        }
    },
    _hideDiagOpener: function(){
        if (this.$$diagOpener) {
            this.$$diagOpener.hide();
        }
    },
    onNavigationClick: function(navLink, field){
        var self = this;
        var index;
        
        // getting index of previously focused diagnose if any
        for (var ii = 0; ii < self._fieldDiagnoses.length; ii++) {
            if (self._fieldDiagnoses[ii].label.className.indexOf("s-diag-view-msg-focus") > -1) {
                index = ii;
                break;
            }
        }
        
        // if navigation from direct field focus and not from "next" button
        // getting corresponding index to update focus in diagnose panel
        if (!navLink && field) {
            for (var ii = 0; ii < self._fieldDiagnoses.length; ii++) {
                if (self._fieldDiagnoses[ii].field.id == field.id) {
                    index = ii;
                    break;
                }
            }
        }
        else {
            // update index
            if (index != undefined) {
            
                if (index == (self._fieldDiagnoses.length - 1)) {
                    index = 0;
                }
                else {
                    index++;
                }
            }
            // set index value
            else {
                index = 0;
            }
            
            // focus corresponding field
            self._focusField(self._fieldDiagnoses[index].field);
        }
        
        // focus corresponding diag
        self._focusDiag(index, self._fieldDiagnoses[index].label);
        
        // if in collapse mode, show focused diag
        if (self.$$expandLink[0].textContent.indexOf(self.localize.diag_expand) > -1) {
            // getting all diagnoses in diagnose panel
            var diagMsg = [];
            diagMsg = self.$$body.find("div.s-diag-view-msg");
            for (var ii = 0; ii < diagMsg.length; ii++) {
                diagMsg[ii].style.display = "none";
            }
            $(self._fieldDiagnoses[index].label).parent().show();
        }
        return false;
    },
    _onDiagOpenerClick: function(){
        var self = this;
        if (self.$$diagOpener) {
            if (self.$$core) {
                self.$$core[0].style.display = "inline-block";
                self._hideDiagOpener();
                self._fitPageToContainer();
            }
        }
        return false;
    },
    _onDiagnoseClose: function($$closeButton){
        // update self.total, update expandLink text value, hide $$item if no diag left
        
        var self = this;
        
        // getting all diagnoses in diagnose panel
        var diagMsg = [];
        diagMsg = self.$$body.find("div.s-diag-view-msg");
        
        var isLastDialog = diagMsg.length == 1 ? true : false;
        
        // removing diagnose
        $$closeButton.parent().remove();
        
        // clean if last dialog removed
        if (isLastDialog) {
            self._emptyViewer();
        }
        
        // else, update info accordingly
        else {
            self.total--;
            // if diagnoses panel was collapsed, update expand link text or hide it
            if (self.$$expandLink[0].textContent.indexOf(self.localize.diag_expand) != -1) {
                diagMsg[1].style.display = "block";
                
                if (self.total == 1) {
                    self.$$expandLink.hide();
                }
                else {
                    self.$$expandLink[0].textContent = (self.total - 1) + self.localize.diag_expand;
                }
            }
            // if diagnoses panel was expanded, remove expand link if one diagnose left
            else {
                if (self.total == 1) {
                    self.$$expandLink.hide();
                }
            }
        }
        self._fitPageToContainer();
        return false;
    },
    _focusField: function(field){
        if (!(field.focus && field.focus())) {
            this.pageScroller.scrollToTarget(field.$$item, true);
        }
    },
    _focusDiag: function(index, label){
        var self = this;
        for (var ii = 0; ii < self._fieldDiagnoses.length; ii++) {
            if (ii == index) {
                document.site.toggleClass(label, "s-diag-view-msg-focus", true);
            }
            else {
                document.site.toggleClass(self._fieldDiagnoses[ii].label, "s-diag-view-msg-focus");
            }
        }
        this.diagPanelScroller.scrollToTarget($(label).parent(), true);
    },
    pushFieldDiagnose: function(label, field){
        var self = this;
        if (self._fieldDiagnoses) {
            var diag = {};
            diag.label = label;
            diag.field = field;
            self._fieldDiagnoses.push(diag);
        }
    },
    _removeFieldDiagnose: function(field){
        var self = this;
        if (self._fieldDiagnoses) {
            var index;
            // getting index of field to remove
            for (var ii = 0; ii < self._fieldDiagnoses.length; ii++) {
                index = self._fieldDiagnoses[ii].field.id == field.id ? ii : index;
                if (index != undefined) {
                    break;
                }
            }
            // removing field from array
            if (index != undefined) {
                self._fieldDiagnoses.splice(index, 1);
            }
        }
    },
    _updateFieldFocusHandling: function(field){
        // remove field from viewer._fieldDiagnoses array
        this._removeFieldDiagnose(field);
        // reset viewer.numFocusedField value
        this.numFocusedField = 0;
    },
    cleanGlobalDiagnoses: function(){
        var self = this;
        if (self.$$body) {
            var diagMsg = [];
            diagMsg = self.$$body.find("div.s-diag-view-msg");
            if (diagMsg.length > 0) {
                var globalDiag = [];
                for (var ii = 0; ii < diagMsg.length; ii++) {
                    if ($(diagMsg[ii]).find("a.s-diag-view-msg-link").length < 1) {
                        globalDiag.push(diagMsg[ii]);
                    }
                }
                for (var ii = 0; ii < globalDiag.length; ii++) {
                    globalDiag[ii].parentNode.removeChild(globalDiag[ii]);
                }
            }
        }
    },
    drawLinks: function(message, page){
        page = page || this.page;
        var self = this;
        if (!self._menus) {
            self._menus = page.loadNewItem(self.$$diagViewLinks, {
                $category: "links",
                $skin: "s-diag-view-links",
                $isBindDisabled: true,
                $links: {},
                $actions: {}
            });
        }
        ["$links", "$actions"].forEach(function($type){
            var $menus = message[$type];
            if ($menus) {
                var $isAction = $type == "$actions";
                Object.keys($menus).forEach(function($bind){
                    var $menu = $menus[$bind];
                    var bound = page.menuItems[$menu.$bind || $bind];
                    if (bound && bound[0]) {
                        bound[0].setMenu($menu);
                    }
                    else {
                        $menu.$isAction = $isAction;
                        self._menus.addMenuItem($menu);
                    }
                });
            }
        });
    },
    showDiagnoses: function(message, page, options){
        var self = this;
        
        // clean if no message
        if (!message || (!message.field && !message.$diagnoses)) {
            self._emptyViewer();
            if (options) {
                // for further usage ?
            }
        }
        else {
            // initialize
            if (!self.$$core) {
                self._initialize();
            }
            
            if (self.onSuccess) {
                self._cleanSuccessStyle();
            }
            
            if (options) {
                // for further usage ?
            }
            
            // append message links
            if (message.$links || message.$actions) {
                // links are most of the times supposed to be sent when there is success after validation
                // flaging success mode, cleaning body 
                if (message.$diagnoses.length == 1 && message.$diagnoses[0].severity == "success") {
                    self.onSuccess = true;
                    this._emptyViewer();
                }
                this.drawLinks(message, page);
            }
            
            // array used for field focus purpose
            self._fieldDiagnoses = self._fieldDiagnoses || [];
            
            // draw diagnoses
            if (message.$diagnoses && message.$diagnoses.length > 0) {
                if (message.field) {
                    self.groups.drawFieldDiagnoses(message.$diagnoses, message.field);
                }
                else {
                    self.groups.drawDiagnoses(message.$diagnoses);
                }
            }
            
            // cleaning
            else {
                self.groups.empty(message.field);
                if (message.field && message.field.domDiagnose) {
                    message.field.emptyDiagnoseSlot();
                    self._updateFieldFocusHandling(message.field);
                }
                
            }
            
            // show/refresh diagnoses panel
            if (!options || !options.noViewer) {
                self._refreshViewer(options, page);
                if (message.autoHide) {
                    setTimeout(function(){
                        self._emptyViewer();
                    }, 4000);
                }
            }
        }
    },
    dispose: function(){
        if (this.groups) {
            this.groups.dispose();
            delete this.groups;
        }
        
        if (this.total) {
            delete this.total;
        }
        
        this._bindEvents(false);
        
        if (this.pageScroller) {
            this.pageScroller.dispose();
            delete this.pageScroller;
        }
        if (this.diagPanelScroller) {
            this.diagPanelScroller.dispose();
            delete this.diagPanelScroller;
        }
        if (this.onSuccess) {
            delete this.onSuccess;
        }
        //TODO remove success icon if any
        delete this.page;
    }
});
