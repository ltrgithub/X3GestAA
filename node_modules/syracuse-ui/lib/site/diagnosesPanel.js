"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var AreaScroller = require('syracuse-ui/lib/site/authoring/areaScroller').AreaScroller;

function Group(severity){
    var group = document.createElement("div");
    group.className = 's-diag-view-group-' + (this.severity = severity);
    this.$$group = $(group);
}

helpers.defineClass(Group, null, {
    empty: function(field){
        if (field) {
            this.$$group.children().children("a[data-s-menu=" + field.id + "]").parent().remove();
        }
        else {
            this.$$group.empty();
        }
    },
    drawLabel: function($diagnose){
        var label = document.createElement("label");
        label.className = "s-diag-view-msg-" + this.severity;
        $(label).append(document.site.formatHTMLMessage($diagnose.message));
        return $(label);
    },
    drawDiagnose: function($diagnose){
        this.drawLabel($diagnose).appendTo(this.$$group);
    },
    appendToViewer: function($$body){
        this.$$group.appendTo($$body);
    },
    dispose: function(){
        this.$$count = this.$$group = null;
    }
});

function Groups(viewer){
    var self = this;
    self.severities = {};
    self._groups = (["error", "fatal", "warning", "info"]).map(function(severity){
        return self.severities[severity] = new Group(severity);
    });
    self.viewer = viewer;
}

helpers.defineClass(Groups, null, {
    getGroup: function(severity){
        // FDB - Take into account bad severity values
        if (severity == null || severity.length == 0) {
            severity = "error";
        }
        else {
            severity = severity.toLowerCase();
        }
        var grp = this.severities[severity];
        return grp ? grp : this.severities["error"];
    },
    drawFieldDiagnoses: function($diagnoses, field){
        var self = this;
        field.ensureDiagnoseSlot();
        var group;
        $diagnoses.forEach(function($diagnose){
            field.drawDiagnose($diagnose, group = self.getGroup($diagnose.severity));
            self.drawLinks($diagnose);
            self.viewer._fieldDiagnoses.push(field);
        });
        field.domDiagnose.style.visibility = "";
        if (group) {
            field.toggleDiagnose("s-" + group.severity, true);
        }
    },
    drawDiagnoses: function($diagnoses){
        var self = this;
        $diagnoses.forEach(function($diagnose){
            self.getGroup($diagnose.severity).drawDiagnose($diagnose);
            self.drawLinks($diagnose);
        });
    },
    drawLinks: function($diagnose){
        if ($diagnose.$links || $diagnose.$actions) {
            this.viewer.drawLinks($diagnose);
        }
    },
    empty: function(field){
        this._groups.forEach(function(group){
            group.empty(field);
        });
    },
    appendToViewer: function($$body){
        this._groups.forEach(function(group){
            group.appendToViewer($$body);
        });
    },
    dispose: function(){
        var self = this;
        self._groups.forEach(function(group){
            delete self.severities[group.severity];
            group.dispose();
        });
        delete self._groups;
        delete self.viewer;
    }
});


function MenuIcons(viewer){
    this.severityIcons = {};
    this.countIcons = {};
    this.viewer = viewer;
}

helpers.defineClass(MenuIcons, null, {
    load: function(menu){
        this.viewer.menuItemFromMenuBar = menu;
        if (menu.$$menuIcons) {
            this.$$menuIcons = menu.$$menuIcons;
            this.$$menuIcons.empty();
        }
        else {
            this.appendMenuIcons(menu);
        }
    },
    appendMenuIcons: function(menu){
        var self = this;
        var div = document.createElement("div");
        div.className = "s-page-menus-icons";
        menu.$$container.append(menu.$$menuIcons = self.$$menuIcons = $(div));
    },
    empty: function(){
        if (this.$$menuIcons) {
            this.$$menuIcons.empty();
        }
    },
    setDiagnoseIcons: function(severity){
        if (this.$$menuIcons) {
            var self = this;
            var localize = locale.resources(module)();
            var severityIcon = self.severityIcons[severity] = document.createElement("a");
            var countIcon = self.countIcons[severity] = document.createElement("a");
            severityIcon.className = "s-page-menus-icons-" + severity;
            severityIcon.title = localize.diag_severityIcon_title;
            countIcon.className = "s-page-menus-icons-count-" + severity;
            countIcon.title = localize.diag_countIcon_title;
        }
    },
    appendDiagnoseIcons: function(severity, count){
        var self = this;
        if (self.$$menuIcons) {
            self.$$menuIcons[0].appendChild(self.severityIcons[severity]);
            self.countIcons[severity].textContent = count;
            self.$$menuIcons[0].appendChild(self.countIcons[severity]);
        }
    },
    cleanDiagnoseIcons: function(severity){
        var self = this;
        if (self.$$menuIcons) {
            self.severityIcons[severity].style.display = "none";
            self.countIcons[severity].style.display = "none";
        }
    }
});

function DiagnosesPanel(){
}

exports.DiagnosesPanel = helpers.defineClass(DiagnosesPanel, null, {
    _emptyViewer: function(){
        this._fieldDiagnoses = null;
        //this.$$item.hide();
        this.$$item.css("visibility", "hidden");
        if (this._menus) {
            this._menus.getArticle().removeItem(this._menus, true);
            delete this._menus;
        }
        if (this.groups) {
            this.groups.empty();
        }
        // TODO empty menu icons ?
    },
    appendToPage: function(page, $$container){
        this.page = page;
        var html = document.createElement("div");
        html.className = "s-diag";
        this.$$diag = $(html).prependTo($$container || $(this.page._headerTop));
        
        html = document.createElement("div");
        html.className = "s-diag-view";
        this.$$item = $(html).appendTo(this.$$diag);
        
        //this.$$diag = $("<div class='s-diag'/>").prependTo(this.page._headerTop);
        //this.$$item = $("<div class='s-diag-view'/>").appendTo(this.$$diag);
        //this.$$item = $("<div class='s-diag-view'/>").prependTo(this.page._headerTop);
    },
    _refreshViewer: function(options, page){
        if (!this.disableViewer) {
            var self = this;
            var menuIcons = new MenuIcons(self);
            
            if (options && options.menu) {
                menuIcons.load(options.menu)
            }
            else {
                if (page && page.menuBar) {
                    var menu;
                    page.menuBar._menusBox.menuItems.forEach(function(menuItem){
                        if (menuItem.$isAction) {
                            menu = menuItem;
                        }
                    });
                    if (menu) {
                        menuIcons.load(menu);
                    }
                }
            }
            
            self.total = 0;
            self.$$body.empty();
            menuIcons.empty();
            self.groups._groups.forEach(function(group){
                var count = group.$$group.children().length;
                menuIcons.setDiagnoseIcons(group.severity);
                if (count) {
                    self.total += count;
                    group.$$group.appendTo(self.$$body);
                    // add diagnose icon and count icon + value to menu
                    menuIcons.appendDiagnoseIcons(group.severity, count);
                }
                if (count == 0) {
                    menuIcons.cleanDiagnoseIcons(group.severity);
                }
            });
            
            if (self.total > 0) {
                self.showDiagnosesPanel(self.total);
                //document.site.setZIndex(self.$$item.show()[0]);
            }
            else {
                self.$$item.css("visibility", "hidden");
                //self.$$item.hide();
            }
        }
    },
    showDiagnosesPanel: function(total){
        var self = this;
        var isShortened;
        // shorten first diagnose if necessary
        // FIRST_DIAG_LENGTH_MAX = 80
        var firstDiag = self.$$core.find("label")[0];
        if (firstDiag && firstDiag.textContent.length > 80) {
            if (!$(firstDiag).hasClass("s-diag-view-msg-short")) {
                $(firstDiag).toggleClass("s-diag-view-msg-short")
                isShortened = true;
            }
        }
        
        if (total == 1) {
            self.$$expandLink[0].textContent = "";
            self.$$expandLink[0].style.display = "none";
            
            // in case of success info
            var $isOnlyInfo;
            var count;
            var $$group;
            self.groups._groups.forEach(function(group){
                if (group.severity == "info") {
                    count = group.$$group.children().length;
                    $$group = group.$$group;
                }
            });
            $isOnlyInfo = count == 1;
            if (self.menuItemFromMenuBar && self.menuItemFromMenuBar.$isAction && $isOnlyInfo) {
                self.showSuccessDiagnosesPanel(self.menuItemFromMenuBar, $$group);
            }
            else 
                if (isShortened) {
                    self.$$expandLink[0].textContent = self.localize.diag_expand;
                    self.$$expandLink.show();
                }
        }
        else {
            var moreText = (total - 1) + self.localize.diag_expand;
            self.$$expandLink[0].textContent = self.$$body.hasClass("s-diag-view-msg-list") ? self.localize.diag_collapse : moreText;
            self.$$expandLink.show();
        }
        self.$$item.css("visibility", "visible");
        document.site.setZIndex(self.$$diag[0]);
    },
    showSuccessDiagnosesPanel: function(menuItem, $$group){
        var self = this;
        
        // modify menu icon
        menuItem.$$menuIcons.empty();
        var html = document.createElement("a");
        html.className = "s-page-menus-icons-info-success";
        menuItem.$$menuIcons[0].appendChild(html);
        
        // modify diagnoses panel        
        self.$$item[0].className = "s-diag-view-success";
        $$group.children("label")[0].className = "s-diag-view-msg-info-success";
        self.$$body[0].className = "s-diag-view-msg-list-success";
        self.$$core[0].className = "s-diag-view-core-success";
        self.$$item.find("nav.s-diag-view-links")[0].className = "s-diag-view-links-success";
        self.$hasSuccessStyle = true;
        
    },
    cleanSuccessStyle: function(){
        var self = this;
        self._emptyViewer();
        self.$$item[0].className = "s-diag-view";
        self.$$body[0].className = "s-diag-view-msg-list-close";
        self.$$core[0].className = "s-diag-view-core";
        self.$hasSuccessStyle = false;
    },
    /*
     onWindowResize: function(setMinimumDimensions){
     var style = this.$$body[0].style;
     var bodyHeight = document.site.$$body.height();
     var bodyWidth = document.site.$$body.width();
     if (setMinimumDimensions) {
     this.$$core[0].style.minWidth = "150px";
     this.$$body[0].style.minHeight = "30px";
     }
     this.$$core[0].style.maxWidth = (bodyWidth - 100) + "px";
     this.$$body[0].style.maxHeight = (bodyHeight - 200) + "px";
     
     // minHeight set to scrollbar height if any
     if (this._hasScrollBar(this.$$body)) {
     style.minHeight = this.$$body[0].scrollHeight;
     }
     },*/
    _hasScrollBar: function($$area){
        var _area = $$area[0]
        return (_area.clientHeight < _area.scrollHeight) || (_area.clientWidth < _area.scrollWidth);
    },
    _initializeCore: function(){
        this.localize = locale.resources(module)();
        var self = this;
        //self.id = helpers.uuid.generate();
        //document.site.addResizeListener(self);
        
        var html = document.createElement("div");
        //html.setAttribute("id", "s-diag-view-core");
        html.className = "s-diag-view-core";
        
        self.$$item.append(self.$$core = $(html));
        
        html = document.createElement("div");
        html.className = "s-diag-view-msg-list-close";
        self.$$body = $(html);
        
        self.groups = new Groups(self);
        self.$$core.append(self.$$body);
        
        html = document.createElement("a");
        html.className = "s-diag-view-count";
        self.$$item.append(self.$$expandLink = $(html));
        self.$$expandLink.hide();
        
        self.$$item.delegate("a.s-diag-view-msg-link", "click", function(){
            var field = document.controller.findItem($(this));
            if (field) {
                self.focusField(field);
            }
            return false;
        }).delegate("a.s-diag-view-count", "click", function(){
            var $$expandLink = $(this);
            var moreText = (self.total) - 1 == 0 ? self.localize.diag_expand : (self.total - 1) + self.localize.diag_expand;
            self.$$body.toggleClass("s-diag-view-msg-list-close").toggleClass("s-diag-view-msg-list");
            var firstDiag = self.$$core.find("label")[0];
            if (firstDiag && firstDiag.textContent.length > 80) {
                $(firstDiag).toggleClass("s-diag-view-msg-short");
            }
            $$expandLink[0].textContent = self.$$body.hasClass("s-diag-view-msg-list") ? self.localize.diag_collapse : moreText;
            return false;
        });
        //self.onWindowResize(true);
        self.scroller = new AreaScroller(this.page.$$body);
        self.bindEvents(true);
    },
    focusField: function(field){
        if (field.focus() && field.focus().noFocusable) {
            this.scroller.scrollToTarget(field.$$item, true);
        }
    },
    bindEvents: function(bind){
        var self = this;
        if (bind) {
            if (self.page && self.page.menuBar) {
                self.page.menuBar.$$slot.delegate(".s-page-menus-icons-error,.s-page-menus-icons-fatal,.s-page-menus-icons-warning,.s-page-menus-icons-info", "click", function(){
                    self.numFocusedField = self.numFocusedField || 0;
                    if (self._fieldDiagnoses.length) {
                        self.focusField(self._fieldDiagnoses[self.numFocusedField++]);
                        if (self._fieldDiagnoses.length == self.numFocusedField) {
                            self.numFocusedField = 0;
                        }
                    }
                }).delegate(".s-page-menus-icons-count-error,.s-page-menus-icons-count-fatal,.s-page-menus-icons-count-warning,.s-page-menus-icons-count-info", "click", function(){
                    self.scroller.scrollToTarget($("div.s-diag-view"), true);
                    return false;
                });
            }
        }
        else {
            if (self.page && self.page.menuBar) 
                self.page.menuBar.$$slot.undelegate();
        }
    },
    drawLinks: function(message, page){
        page = page || this.page;
        var self = this;
        if (!self._menus) {
            self._menus = page.loadNewItem(self.$$item, {
                $category: "links",
                $skin: "s-diag-view-links",
                $isBindDisabled: true,
                $links: {},
                $actions: {}
            });
        }
        ["$links", "$actions"].forEach(function($type){
            var $menus = message[$type];
            if ($menus) {
                var $isAction = $type == "$actions";
                Object.keys($menus).forEach(function($bind){
                    var $menu = $menus[$bind];
                    var bound = page.menuItems[$menu.$bind || $bind];
                    if (bound && bound[0]) {
                        bound[0].setMenu($menu);
                    }
                    else {
                        $menu.$isAction = $isAction;
                        self._menus.addMenuItem($menu);
                    }
                });
            }
        });
    },
    showDiagnoses: function(message, page, options){
        var self = this;
        
        //        if (!page.diagnosesPanel) {
        //            debugger;
        //            page.showDiagnoses(message, options);
        //        }
        //        
        //        if (!page.diagnosesPanel.$$item) {
        //            self.appendToPage(page);
        //        }
        
        if (!self.$$core) {
            self._initializeCore();
        }
        if (!message || (!message.field && !message.$diagnoses)) {
            self._emptyViewer();
        }
        if (self.$hasSuccessStyle) {
            self.cleanSuccessStyle();
        }
        self._fieldDiagnoses = self._fieldDiagnoses || [];
        if (message.$diagnoses && message.$diagnoses.length > 0) {
            if (message.field) {
                self.groups.drawFieldDiagnoses(message.$diagnoses, message.field);
            }
            else {
                self.groups.drawDiagnoses(message.$diagnoses);
            }
        }
        else {
            self.groups.empty(message.field);
            if (message.field && message.field.domDiagnose) {
                message.field.emptyDiagnoseSlot();
            }
        }
        if (message.$links || message.$actions) {
            this.drawLinks(message, page);
        }
        
        if (!options || !options.noViewer) {
            self._refreshViewer(options, page);
            if (message.autoHide) {
                setTimeout(function(){
                    self._emptyViewer();
                }, 4000);
            }
        }
    },
    appendMenuIcons: function(menu){
        var self = this;
        if (!self.$hasMenuIcons) {
            var div = document.createElement("div");
            div.className = "s-page-menus-icons";
            menu.$$container.append(self.$$menuIcons = $(div));
            self.$hasMenuIcons = true;
        }
    },
    dispose: function(){
        //document.site.removeResizeListener(this);
        if (this.groups) {
            this.groups.dispose();
            delete this.groups;
        }
        if (this.menuItemFromMenuBar) {
            delete this.menuItemFromMenuBar;
        }
        if (this.total) {
            delete this.total;
        }
        if (this.$hasSucessStyle) {
            delete this.$hasSucessStyle;
        }
        if (this.$$item) {
            this.$$item.undelegate();
        }
        if (this.$$expandLink) {
            this.$$expandLink.unbind();
        }
        if (this.scroller) {
            this.scroller.dispose();
            delete this.scroller;
        }
        this.bindEvents(false);
        delete this.page;
    }
});
