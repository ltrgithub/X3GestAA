"use strict";
var searchUtils = require('./searchUtils');
exports.isSearchUrl = function($url) {
	return $url && (decodeURIComponent($url).indexOf("$search?representation=queryResult.$search&q=") >= 0);
};

exports.getProperties = function() {
	var localize = document.site.localize;
	var $skin = "s-search-res";
	return {
		"$vignetteFunctions": {
			$type: "application/x-vignette",
			$format: "$searchPage",
			$prototype: {
				$properties: {
					$searchModeDescription: {
						$type: "application/x-string"
					},
					"$queryFunctions": {
						"$type": "application/x-array",
						"$item": {
							"$type": "application/json",
							"$prototype": "{$baseUrl}/$prototypes('{$representation}.$search')",
							"$url": "{$baseUrl}/{$pluralType}('{$key}')",
							"$value": "{$key}",
							"$title": "queryResult {$key}",
							"$key": "{$uuid}",
							"$description": "queryResult {$key}",
							"$pluralType": "queryResults",
							"$representation": "queryResult",
							"$properties": {
								"$descriptionData": {
									"$title": "Resume",
									"$type": "application/x-array",
									"$item": {
										"$type": "application/x-string",
										"$format": "$html",
									}
								},
								"title": {
									"$title": "Description",
									"$type": "application/x-string",
									"$format": "$html",
									"$capabilities": "sort,filter,alphaTab",
									"$links": {
										"$details": {
											"$type": "application/json;vnd.sage=syracuse",
											"$url": "{$url}"
										}
									}
								}
							},
							"$defaultOrder": "title"
						}
					}
				},
				$links: searchUtils.getSearchModeLinks(),
				$article: {
					"$layout": {
						"$layoutType": "columns",
						"$widths": "100",
						"$items": [{
							"$items": [{
								$isTitleHidden: true,
								$bind: "$searchModeDescription",
								$skin: $skin + "-searchmode"
							}, {
								$isTitleHidden: true,
								$layout: {
									$layoutType: "row",
									$autoSize: true,
									$items: [{
										$bind: "$searchStartingWith",
										$category: "link",
										$isHidden: true
									}, {
										$bind: "$searchContaining",
										$category: "link"
									}, {
										$bind: "$searchSimilar",
										$category: "link"
									}]
								}
							}, {
								"$bind": "$queryFunctions",
								$isMenuRecordHidden: true,
								"$noDataText": localize.search_no_res,
								"$format": "cards",
								$skin: $skin,
								$css: $skin,
								$layout: {
									$items: [{
										$bind: "title",
										$skin: $skin,
										$isTitleHidden: true
									}, {
										$bind: "$descriptionData",
										"$noDataText": " ",
										$isTitleHidden: true,
										$skin: $skin + "-desc"
									}]
								}
							}, {
								$isTitleHidden: true,
								$layout: {
									$layoutType: "row",
									$autoSize: true,
									$items: [{
										$bind: "$searchStartingWith",
										$category: "link",
										$isHidden: true
									}, {
										$bind: "$searchContaining",
										$category: "link"
									}, {
										$bind: "$searchSimilar",
										$category: "link"
									}]
								}
							}]
						}]
					}
				}
			}
		},
		$vignetteData: {
			$type: "application/x-vignette",
			$format: "$searchPage",
			$prototype: {
				$properties: {
					$searchModeDescription: {
						$type: "application/x-string"
					},
					"$queryData": {
						"$type": "application/x-array",
						"$item": {
							"$type": "application/json",
							"$prototype": "{$baseUrl}/$prototypes('{$representation}.$search')",
							"$url": "{$baseUrl}/{$pluralType}('{$key}')",
							"$value": "{$key}",
							"$title": "queryResult {$key}",
							"$key": "{$uuid}",
							"$description": "queryResult {$key}",
							"$pluralType": "queryResults",
							"$representation": "queryResult",
							"$properties": {
								"title": {
									"$title": "Description",
									"$type": "application/x-string",
									"$format": "$html",
									"$capabilities": "sort,filter,alphaTab",
									"$links": {
										"$details": {
											"$type": "application/json;vnd.sage=syracuse",
											"$url": "{$url}"
										}
									}
								},
								"$descriptionData": {
									"$title": "Resume",
									"$type": "application/x-array",
									"$item": {
										"$type": "application/x-string",
										"$format": "$html"
									}
								},
								"$resultTypeTitle": {
									"$title": "Result type title",
									"$type": "application/x-string",
									"$format": "$html",
									"$capabilities": "sort,filter,alphaTab"
								}
							},
							"$defaultOrder": "title"
						}
					}
				},
				$links: searchUtils.getSearchModeLinks(),
				$article: {
					"$layout": {
						"$layoutType": "columns",
						"$widths": "100",
						"$items": [{
							"$items": [{
								$isTitleHidden: true,
								$bind: "$searchModeDescription",
								$skin: $skin + "-searchmode"
							}, {
								$isTitleHidden: true,
								$layout: {
									$layoutType: "row",
									$autoSize: true,
									$items: [{
										$bind: "$searchStartingWith",
										$category: "link",
										$isHidden: true
									}, {
										$bind: "$searchContaining",
										$category: "link"
									}, {
										$bind: "$searchSimilar",
										$category: "link"
									}]
								}
							}, {
								"$bind": "$queryData",
								$isMenuRecordHidden: true,
								"$noDataText": localize.search_no_res,
								"$format": "cards",
								$skin: $skin,
								$css: $skin,
								$layout: {
									$items: [{
										$bind: "title",
										$skin: $skin,
										$isTitleHidden: true
									}, {
										$bind: "$resultTypeTitle",
										$skin: $skin + "-type",
										$isTitleHidden: true
									}, {
										$bind: "$descriptionData",
										"$noDataText": " ",
										$isTitleHidden: true,
										$skin: $skin + "-desc"
									}]
								}
							}, {
								$isTitleHidden: true,
								$layout: {
									$layoutType: "row",
									$autoSize: true,
									$items: [{
										$bind: "$searchStartingWith",
										$category: "link",
										$isHidden: true
									}, {
										$bind: "$searchContaining",
										$category: "link"
									}, {
										$bind: "$searchSimilar",
										$category: "link"
									}]
								}
							}]
						}]
					}
				}
			}
		},
		"query": {
			"$type": "application/x-string"
		}
	};
};


exports.getArticle = function() {
	var localize = document.site.localize;
	var $skin = "s-search-res";
	return {
		"$title": "Search results",
		"$layout": {
			"$layoutType": "tabs",
			"$items": [{
				"$category": "section",
				$clientId: "searchDataTab",
				"$title": localize.search_data_tab,
				$layout: {
					$items: [{
						$bind: "$vignetteData"
					}]
				},
				onOpen: function(block) {
					if (block.page && block.page.searchFacets) {
						block.page.searchFacets.domItem.style.display = "";
					}
				}
			}, {
				"$category": "section",
				"$title": localize.search_functions_tab,
				$clientId: "searchFunctionsTab",
				$layout: {
					$items: [{
						$bind: "$vignetteFunctions"
					}]
				},
				onOpen: function(block) {
					if (block.page && block.page.searchFacets) {
						block.page.searchFacets.domItem.style.display = "none";
					}
				}
			}]
		}
	};
};

exports.getPrototype = function() {
	return {
		"$baseType": "application/json;vnd.sage=syracuse",
		"$url": "{$baseUrl}/queryResults",
		"$type": "application/json",
		"$properties": exports.getProperties(),
		"$descriptor": "prototype queryResult.$search",
		$article: exports.getArticle()
	};
};


exports.openRequestPage = function(httpQuery) {
	var $itemPage = {
		$category: "search",
		$urlParts: httpQuery.$urlParts,
		$representation: {
			$prototype: exports.getPrototype()
		}
	};

	document.site.onMainPageChange($itemPage);

};