"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var RawPage = require('syracuse-ui/lib/article/rawPage').RawPage;
var Field = require('syracuse-ui/lib/field/field').Field;
function SearchRequest(){
}

exports.SearchRequest = helpers.defineClass(SearchRequest, RawPage, {
    drawBox: function(){
        var dom;
        this.$layoutOptions = {
            $skin: this.$skin = "s-search-rq",
            section: "s-h1",
            block: "s-h2",
            menus: "s-page-menus"
        };
        dom = document.createElement("article");
        dom.className = this.$skin;
        this.$$item = $(dom).appendTo(this.$$container);
        
        dom = document.createElement("div");
        this.$$body = $(dom).appendTo(this.$$item);
        
        this._renderLayoutContent(this.$item);
        this.appendArticleMenus();
    },
    createNewItem: function($item, boxParent){
        if ($item.$bind == "$search") {
            var searcField = new SearchField();
            searcField.$field = this.$prototype.$properties[$item.$bind];
            return this.initializeNewItem(searcField, $item, boxParent);
        }
        return RawPage.prototype.createNewItem.call(this, $item, boxParent);
    },
    notifyDataChange: function(field, value){
        if (field.$item.$bind == "$search") {
            this.dataset[field.$item.$bind] = value;
            document.controller.executeMenu(this.menuItems["$searchLink"][0]);
        }
    },
    loadAutoCompleteList: function(searchField){
        var self = this;
        self._autoCompleteList = document.createElement("div");
        self._autoCompleteList.className = searchField.$skin + "-autocomplete-list";
        self.loadNewItem($(self._autoCompleteList), {
            $category: "section",
            $layout: {
                $items: [{
                    $category: "block",
                    $title: "Query1",
                    $layout: {
                        $items: [{
                            $isTitleHidden: true,
                            $bind: "$query1",
                            "$layout": {
                                "$items": [{
                                    "$bind": "login"
                                }, {
                                    "$bind": "firstName"
                                }, {
                                    "$bind": "lastName"
                                }, {
                                    "$bind": "photo"
                                }]
                            }
                        }]
                    }
                }, {
                    $category: "block",
                    $title: "Query2",
                    $layout: {
                        $items: [{
                            $isTitleHidden: true,
                            $bind: "$query2"
                        }]
                    }
                }, {
                    $catgory: "link",
                    $skin: "s-field-menus-link",
                    $bind: "$advanceSearch"
                }]
            }
        }, self);
        
        self.dataset.$search = searchField.getDataValue();
        self.formatMenuUrl(self.$prototype.$links.$queryLink2, self.dataset, function($url, isCanceled){
            document.controller.sendRequest(self, {
                $location: {
                    $url: $url
                }
            }, function(data){
                data.$itemsPerPage = 5;
                data.$query1 = data.$resources;
                delete data.$resources;
                self.applyChange(data);
            });
        });
        self.formatMenuUrl(self.$prototype.$links.$queryLink2, self.dataset, function($url, isCanceled){
            document.controller.sendRequest(self, {
                $location: {
                    $url: $url
                }
            }, function(data){
                data.$itemsPerPage = 5;
                data.$query2 = data.$resources;
                delete data.$resources;
                self.applyChange(data);
            });
        });
        return self._autoCompleteList;
    },
    unloadAutoCompleteList: function(){
        if (this._autoCompleteList) {
            document.site.emptyDom(this._autoCompleteList);
            this._autoCompleteList = null;
        }
    },
    dispose: function(){
        this.unloadAutoCompleteList();
        RawPage.prototype.dispose.call(this);
    }
});

function SearchField(){
}

exports.SearchField = helpers.defineClass(SearchField, Field, {
    _onAutoCompleteOpen: function(){
        return this.page.loadAutoCompleteList(this);
    },
    _onAutoCompleteClose: function(){
        this.page.unloadAutoCompleteList();
    },
    onClickPicker: function(){
        this.onInputValidate(); //trigger notification change
    }
});

exports.loadRequest = function($$container){
    var $url = "/sdata/syracuse/search/syracuse/$search?representation=queryResult.$search&q={$search}";
    var httpQuery = document.controller.parseUrl($url);
    var $itemPage = {
        $autoFetch: false,
        $isEditMode: true,
        $$container: $$container,
        $category: "searchRequest",
        $urlParts: httpQuery.$urlParts,
        $pageCategoryClass: SearchRequest,
        $representation: {
            $prototype: {
                "$baseUrl": "/sdata/sprint1/settings/sprint1",
                $properties: {
                    $query1: {
                        "$type": "application/x-array",
                        $item: {
                            "$properties": {
                                "login": {
                                    "$title": "Default Account",
                                    "$type": "application/x-string",
                                    "$capabilities": "sort",
                                },
                                "firstName": {
                                    "$title": "First Name",
                                    "$type": "application/x-string",
                                    "$capabilities": "sort,filter,alphaTab"
                                },
                                "lastName": {
                                    "$title": "Last Name",
                                    "$type": "application/x-string",
                                    "$capabilities": "sort"
                                }
                            }
                        }
                    },
                    $query2: {
                        "$type": "application/x-array",
                        $item: {
                            "$properties": {
                                "firstName": {
                                    "$title": "First Name",
                                    "$type": "application/x-string",
                                    "$capabilities": "sort,filter,alphaTab"
                                },
                                "lastName": {
                                    "$title": "Last Name",
                                    "$type": "application/x-string",
                                    "$capabilities": "sort"
                                }
                            }
                        }
                    },
                    $search: {
                        $type: "application/x-string",
                        $title: "Search by key words",
                        $linkstmp: {
                            $suggest: {}
                        }
                    }
                },
                $links: {
                    $queryLink1: {
                        $url: "/sdata/syracuse/collaboration/syracuse/users?representation=user.$query&where=(lastName like '{param1}')",
                        "$parameters": {
                            "param1": "{$search}",
                        }
                    },
                    $queryLink2: {
                        $url: "/sdata/syracuse/collaboration/syracuse/users?representation=employe.$query&where=(lastName like '{param1}')",
                        "$parameters": {
                            "param1": "{$search}",
                        }
                    },
                    $searchLink: {
                        "$type": "application/json;vnd.sage=syracuse",
                        $url: "/sdata/syracuse/search/syracuse/$search?representation=queryResult.$search&q={$search}"
                    },
                    $advanceSearch: {
                        $title: "Advanced Search",
                        $url: "/sdata/syracuse/search/syracuse/$search?representation=queryResult.$search&q={$search}"
                    }
                }
            },
            $article: {
                $isTitleHidden: true,
                $layout: {
                    $items: [{
                        $bind: "$search",
                        $isTopLabelAlignment: false,
                        $category: "field",
                        $validationTrigger: "keyup",
                        $skin: "s-search-rq-field",
                        $inplace: true
                    }, {
                        $bind: "$searchLink",
                        $category: "link",
                        $noText: true,
                        $skin: "s-site-search-picker"
                    }]
                }
            }
        }
    };
    return document.site.loadNewPage($itemPage);
    
};
