"use strict";

function _replaceTitle(source, mapList) {
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var ii = 0, jj = sourceValue.length; ii < jj; ii++) {
							_replaceTitle(sourceValue[ii], mapList);
						}
					} else {
						_replaceTitle(sourceValue, mapList);
					}
				}
			} else {
				if (sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(1, sourceValue.length - 2);
						if (mapList[key]) {
							source.$title = "{" + mapList[key] + "}";
						}
					}
				}
			}
		}
	}
}

function generateHack($prototype) {
	$prototype.$hackLocalization = {};
	var $oldBinds = Object.keys($prototype.$localization);
	for (var ii = 0, jj = $oldBinds.length; ii < jj; ii++) {
		var $oldBind = $oldBinds[ii];
		var $oldTitleKey = "{" + $oldBind + "}";
		var $newBind = "@new_" + $oldBinds[ii];
		var $newTitleKey = "{" + $newBind + "}";
		$prototype.$localization[$newBind] = "NEW " + $prototype.$localization[$oldBind];
		delete $prototype.$localization[$oldBind];
		$prototype.$hackLocalization[$oldBind] = $newBind;
	}
	_replaceTitle($prototype, $prototype.$hackLocalization);
}

exports.convertLocalization = function($prototype, $article) {
	if ($prototype.$localization) {
		if (!$prototype.$hackLocalization) {
			generateHack($prototype);
		}
		_replaceTitle($article, $prototype.$hackLocalization);
	}
};