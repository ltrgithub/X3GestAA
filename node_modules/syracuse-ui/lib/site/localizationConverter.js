"use strict";

function _warnNotFound(source, $localization, notFound) {
	if (!notFound) {
		notFound = notFound || [];
	}
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var mm = 0, kk = sourceValue.length; mm < kk; mm++) {
							_warnNotFound(sourceValue[mm], $localization, notFound);
						}
					} else {
						_warnNotFound(sourceValue, $localization, notFound);
					}
				}
			} else {
				if (sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(1, sourceValue.length - 2);
						if (!$localization[key]) {
							notFound.push(key);
						}
					}
				}
			}
		}
	}
	return notFound;
}

function _replaceTitle(source, mapList) {
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var mm = 0, kk = sourceValue.length; mm < kk; mm++) {
							_replaceTitle(sourceValue[mm], mapList);
						}
					} else {
						_replaceTitle(sourceValue, mapList);
					}
				}
			} else {
				if (sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(1, sourceValue.length - 2);
						if (mapList[key]) {
							source.$title = "{" + mapList[key] + "}";
						}
					}
				}
			}
		}
	}
}

function generateHack($prototype) {
	$prototype.$hackLocalization = {};
	var $oldBinds = Object.keys($prototype.$localization);
	for (var ii = 0, jj = $oldBinds.length; ii < jj; ii++) {
		var $oldBind = $oldBinds[ii];
		var $oldTitleKey = "{" + $oldBind + "}";
		var $newBind = "@new_" + $oldBinds[ii];
		var $newTitleKey = "{" + $newBind + "}";
		$prototype.$localization[$newBind] = "NEW " + $prototype.$localization[$oldBind];
		delete $prototype.$localization[$oldBind];
		$prototype.$hackLocalization[$oldBind] = $newBind;
	}
	_replaceTitle($prototype, $prototype.$hackLocalization);
}

exports.convertLocalization = function($prototype, $article) {
	if ($prototype.$localization && $prototype.$hackLocalization) {
		/*if (!$prototype.$hackLocalization) {
         generateHack($prototype);
         }*/
		_replaceTitle($article, $prototype.$hackLocalization);
		var notFound = _warnNotFound($article, $prototype.$localization);
		if (notFound.length) {
			alert(notFound.join(" , "));
		}
	}
};