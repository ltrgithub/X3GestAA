"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var _date = require('syracuse-core/lib/types/date');
var jsurl = require('jsurl/lib/jsurl');
var _unloadActionProperties = ["donotuse", "selectedLocale", "selectedRole", "selectedEndpoint"];

function UserProfile() {

}

exports.UserProfile = helpers.defineClass(UserProfile, RawPage, {
	dispose: function() {
		if (!this.saveSiteTimeout) {
			clearTimeout(this.saveSiteTimeout);
		}
		this.saveSiteTimeout = this.formBlock = null;
		RawPage.prototype.dispose.call(this);
	},
	hasDesignRight: function() {
		return !(this.getAuthoringLevel() === "none");
	},
	getLogonUrl: function() {
		var $url = syra_site.$item.$userProfileUrl;
		var profile = syra_site.$prototype.$userprofile;
		if (!profile) {
			var seg = syra_site.urlMaker.parse(syra_site.history.getSdataUrl(document.location.href));
			profile = seg && seg.params && seg.params.profile;
			if (profile) {
				syra_site.$prototype.$userprofile = profile;
			}
		}
		if (profile) {
			$url += "&profile={$userprofile}";
		}
		return $url;
	},
	switchToNewSession: function(onsuccess) {
		var self = this;
		syra_controller.postQuery({
			$url: self.getLogonUrl()
		}, null, null, function($location, data) {
			self.applyChange(data);
			onsuccess();
		});
	},
	getAuthoringLevel: function() {
		return (this.dataset ? this.dataset.authoringLevel : null) || "none";
	},
	onMenuClick: function(menuItem) {
		if (menuItem.$subRecordKey == "user") {
			menuItem.$target = "blank";
		}
		return true;
	},
	onNotifyDataChange: function(field, value) {
		var self = this;
		if (_unloadActionProperties.indexOf(field.$item.$bind)) {
			syra_site.fusionGateway &&
				syra_site.fusionGateway.onUserActionUnload(function() {
					self.notifyDataChange(field, value);
				}, function() {
					if (self.oldValue) {
						field.setDataValue(self.oldValue);
					}

				}, field.$item.$bind);
			return false;
		}
		return true;
	},
	onClickPicker: function(btn, event) {
		var field = syra_site.findField(event.target);
		if (field && field.$item && _unloadActionProperties.indexOf(field.$item.$bind)) {
			this.oldValue = helpers.object.clone(field.currentValue);
		}
		return true;
	},
	getRegionalPreferences: function(success) {
		this.ensureFormBlock();
		var lookup = this.boundFields.selectedLocale[0];
		syra_controller.sendRequest(this, {
			$location: {
				$url: syra_site.expressionMaker.parse(this, lookup.$menus.$lookup.$url)
			}
		}, function(data) {
			success(data && data.$resources);
		});
	},
	ensureFormBlock: function() {
		var self = this;
		if (!self.formBlock) {
			self.formBlock = self.loadNewItem(self.domItem, {
				$category: "section",
				$title: syra_local.userProfile_up_welcome,
				$skin: "s-user-form",
				$layout: {
					$items: [{
						$bind: "$save",
						$category: "link",
						$isHidden: true,
						onServerRequest: function(menu) {
							//this is item menu
							if (menu.$links && menu.$links.$location) {
								if (self.dataset && self.dataset.selectedRole) {
									self.$prototype.$role = self.dataset.selectedRole.$uuid; //important for url 
								}
							}
							return false;
						}
					}, {
						$isEditMode: true,
						$isHidden: syra_site.siteOptions.isUserEndpointChangeDisabled,
						$isTopLabelAlignment: false,
						$isReferenceTitleVisible: false,
						$css: "s-user-profile-selectedRole",
						$bind: "selectedRole",
						$title: syra_local.userProfile_up_role
					}, {
						$isEditMode: true,
						$isTopLabelAlignment: false,
						$isReferenceTitleVisible: false,
						$css: "s-user-profile-selectedEndpoint",
						$bind: "selectedEndpoint",
						$title: syra_local.userProfile_up_endpoint
					}, {
						$isEditMode: true,
						$isTopLabelAlignment: false,
						$isReferenceTitleVisible: false,
						$css: "s-user-profile-selectedLocale",
						$bind: "selectedLocale",
						$title: syra_local.userProfile_up_locale
					}]
				}
			});
			self.isPageLoaded = true;
		}
	},
	loadBox: function(initData) {
		// adding selectedLocale into dom for test purposes
		if (initData && initData.selectedLocale) {
			syra_site.body.setAttribute('data-s-q-local', initData.selectedLocale.$value);
		}
		if (this.$prototype && this.$prototype.$properties) {
			this.$prototype.$properties.$fieldSelectEndPoint = {
				$type: "application/x-choice",
				$value: {
					$type: "application/x-integer",
					$enum: []
				}
			};
			RawPage.prototype.loadBox.call(this, initData);
		} else {
			syra_site.layoutSlot.style.display = "";
			this.showDiagnoses(initData);
			this.hasLogonFailed = true;
		}
	},
	drawBox: function() {
		this.externalAdapter = syra_site.externalAdapter;
		this.domItem = document.createElement("div");
		this.domItem.id = "s-user-profile";
	},
	showDiagnoses: function(message) {
		// display user profile errors in popup ???
		if (message.$diagnoses && Object.keys(message.$diagnoses).length > 0) {
			var options = {};
			var onlyOneDiagnose = message.$diagnoses.length == 1;
			options.$message = syra_local.userProfile_siteMsgboxMsg;
			options.$useLinkAsOk = onlyOneDiagnose && message.$diagnoses[0].$links; //temp hack
			options.$type = "alert";
			options.$buttons = "ok";
			options.$title = syra_local.userProfile_upDiagMsgboxTitle;
			options.$diagnoses = message.$diagnoses;
			options.$origin = onlyOneDiagnose ? message.$diagnoses[0].$origin : "";
			syra_site.showMessage(options);
		}
	},
	notifyDataChange: function(field, value) {
		this.notifyActionChange(null, this, {
			$save: {
				$isRequested: true
			}
		}, false);
		RawPage.prototype.notifyDataChange.call(this, field, value);
	},
	saveSitePreferences: function() {
		var self = this;
		if (!self.saveSiteTimeout) {
			self.saveSiteTimeout = setTimeout(function() {
				self.saveSiteTimeout = null;
				self.ensureSendBag().sitePreferences = self.dataset.sitePreferences;
				self.notifyActionChange(null, self, {
					$save: {
						$isRequested: true
					}
				}, true);
			}, 3000);
		}
	},
	applyChange: function(newData) {
		var reloadMainPage, changeEndpoint;
		var isFusionPage = syra_site.mainPage && syra_site.mainPage.isFusionPage;
		// refresh page when user changes locale
		var selectedLocale = this.getSelectedLocale();
		var hasLocalizationChanged;
		if (newData && newData.serverETag != null && module.etag != newData.serverETag) {
			hasLocalizationChanged = true;
		} else {
			if (Object.keys(this.dataset).length > 0) {
				if (selectedLocale && newData.selectedLocale && selectedLocale.code != newData.selectedLocale.code) {
					hasLocalizationChanged = true;
				}
			}
		}
		if (this._selectedEndpointUiid && newData.selectedEndpoint) {
			changeEndpoint = this._selectedEndpointUiid != newData.selectedEndpoint.$uuid;
		} else {
			reloadMainPage = this._selectedEndpointUiid || newData.selectedEndpoint;
		}
		if (!reloadMainPage) {
			if (this._selectedRoleUiid && newData.selectedRole) {
				reloadMainPage = this._selectedRoleUiid != newData.selectedRole.$uuid;
			} else {
				reloadMainPage = this._selectedRoleUiid || newData.selectedRole;
			}
		}
		if (hasLocalizationChanged) {
			setTimeout(function() {
				syra_site.isSiteReloading = true;
				syra_site.history.reloadSite();
			}, 10);
		} else {
			RawPage.prototype.applyChange.call(this, newData);
			if (newData.selectedRole !== undefined || newData.selectedEndpoint !== undefined) {
				this.applyNewSecurity();
			}
			if (reloadMainPage) {
				syra_site.history.loadMainPage();
			} else {
				syra_site.siteFunctions.refreshMainPageSecurity(syra_site.mainPage);
				if (changeEndpoint && !reloadMainPage) {
					if (syra_site.bookmarksManager) {
						syra_site.bookmarksManager.refresh();
					}
					var url = syra_site.history.getCurrentSdataUrl();
					if (syra_site.urlMaker.parse(url).isFusion) {
						syra_site.history.updateCurrentEndpoint(newData.selectedEndpoint);
					} else {
						syra_site.gotoNavigationPage();
					}
				}
			}
		}
	},
	applyNewSecurity: function() {
		syra_site.$prototype.$role = this._selectedRoleUiid = (this.dataset.selectedRole && this.dataset.selectedRole.$uuid) || null;
		this._selectedEndpointUiid = (this.dataset.selectedEndpoint && this.dataset.selectedEndpoint.$uuid) || null;
		this.setEncodedValue();
		var page = syra_site.mainPage;
		if (page) {
			var segments = page.openerUrlSegments;
			if (segments) {
				(segments.params = segments.params || {}).profile = syra_site.$prototype.$userprofile;
				if (this.dataset.selectedEndpoint !== undefined) {
					syra_site.urlMaker.replaceSegmentEndpoint(segments, this.dataset.selectedEndpoint);
				}
				syra_site.urlMaker.build(segments);
				syra_site.history.update(page, segments.$url);
			}
			syra_site.siteFunctions.refreshMainPageSecurity(page);
		}
	},
	setSecurityToRepresentation: function($representation) {
		if (this.dataset.selectedRole) {
			$representation.$prototype.$role = this.dataset.selectedRole.$uuid; //important for url 
		}
		$representation.$prototype.$userprofile = this.getEncodedValue();
	},
	setEncodedValue: function() {
		var value = {
			loc: syra_site.currentLangCode
		};
		if (this._selectedRoleUiid) {
			value.role = this._selectedRoleUiid;
		}
		if (this._selectedEndpointUiid) {
			value.ep = this._selectedEndpointUiid;
		}
		syra_site.$prototype.$userprofile = jsurl.stringify(value);
	},
	getEncodedValue: function() {
		return syra_site.$prototype.$userprofile || "";
	},
	getSelectedRole: function() {
		return this.dataset.selectedRole;
	},
	getSelectedEndpoint: function() {
		return this.dataset.selectedEndpoint;
	},
	getSelectedLocale: function() {
		return this.dataset.selectedLocale || {};
	},
	getSelectedEndpointString: function() {
		var endpoint = this.dataset ? this.dataset.selectedEndpoint : null;
		return endpoint ? (endpoint.application + "." + endpoint.contract + "." + endpoint.dataset) : null;
	},
	getDateFormat: function(displayFormat) {
		var selectedLocale = this.getSelectedLocale();
		return displayFormat == "DD" ? (selectedLocale.longDate || "dd MMMM yyyy") : (selectedLocale.shortDate || "yyyy-MM-dd");
	},
	getTimeFormat: function(displayFormat) {
		var selectedLocale = this.getSelectedLocale();
		return displayFormat == "TT" ? (selectedLocale.longTime || "HH:mm:ss") : (selectedLocale.shortTime || "HH:mm");
	},
	getDatetimeFormat: function(displayFormat) {
		var selectedLocale = this.getSelectedLocale();
		var format;
		switch (displayFormat) {
			case "F":
				// sortable datetime format
				format = _date.resources().formatPatterns ? _date.resources().formatPatterns["sortableDateTime"] : "yyyy-MM-ddTHH:mm:ss";
				break;
			case "FF":
				// full datetime format
				format = selectedLocale.selectedLocale.longDatetime || (_date.resources().formatPatterns ? _date.resources().formatPatterns["fullDateTime"] : "dd MMMM yyyy HH:mm:ss");
				break;
			case "U":
				// universal sortable datetime format
				format = _date.resources().formatPatterns ? _date.resources().formatPatterns["universalSortableDateTime"] : "yyyy-MM-dd HH:mm:ssZ";
				break;
			default:
				// datetime default format is dateformat + space + timeformat
				format = selectedLocale.shortDatetime || (this.getDateFormat() + " " + this.getTimeFormat());
		}
		return format;
	},
	getNumberFormatObj: function(type) {
		var selectedLocale = this.getSelectedLocale();
		var f = "#,";
		var numberGroupSize = selectedLocale.numberGroupSize || "3";
		for (var i = 0; i < numberGroupSize; i++) {
			f += (i == numberGroupSize - 1) ? "0" : "#";
		}
		f += type == "application/x-integer" ? '' : '.##';
		// numFormat default -> #,##0 (integer) or #,##0.## (decimal)
		return {
			numFormat: f,
			decimalSeparator: selectedLocale.numberDecimalSeparator || ".",
			groupSeparator: selectedLocale.numberGroupSeparator || ",",
			groupSize: numberGroupSize
		};
	},
	getNumberFormat: function(type) {
		return this.getNumberFormatObj(type).numFormat;
	},
	getTwoDigitYearMax: function() {
		return this.getSelectedLocale().twoDigitYearMax || 2029;
	},
	getServerSessionTimeOut: function() {
		return (this.dataset ? this.dataset.sessionTimeout : 2) * 60 * 1000; // converting minutes into milliseconds
		//return 186000; // 3.1 minutes for test
	},
	getCurrencyDisplay: function() {
		return this.dataset.currencyDisplay || "symbol";
	},
	getUnitDisplay: function() {
		return this.dataset.unitDisplay || "symbol";
	},
	getCurrencyPosition: function() {
		return this.dataset.currencyPosition || "right";
	},
	buildWCContent: function() {
		var dd = this.dataset || {};
		return ["selectedEndpoint", "selectedRole", "selectedLocale"].reduce(function(prev, item) {
			var val = dd[item];
			prev[item] = (val && val.$uuid) ? {
				$uuid: val.$uuid
			} : null;
			return prev;
		}, {
			$etag: dd.$etag
		});
	}
});