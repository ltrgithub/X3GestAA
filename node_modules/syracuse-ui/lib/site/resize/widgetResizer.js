"use strict";
var helpers = require('syracuse-core/lib/helpers');

var WidgetResizerDDAgent = require("./widgetResizerDDAgent").WidgetResizerDDAgent;
var WidgetMoveDDAgent = require("./widgetMoveDDAgent").WidgetMoveDDAgent;

function WidgetResizer() {}

exports.WidgetResizer = helpers.defineClass(WidgetResizer, null, {
	isDraggable: function(target, event) {
		if (target) {
			if (target.syraWidgetResizer == this.id) {
				if (this.isEnabled && (this.isLeft || this.isRight || this.isTop || this.isBottom)) {
					syra_dd.dropableItem = this;
					syra_dd.start(this, WidgetResizerDDAgent, this.options.slot);
					event.syraRetValue = false;
					return;
				}
			} else {
				if (target.syraWidgetDrag == this.id) {
					syra_dd.dropableItem = this;
					syra_dd.start(this, WidgetMoveDDAgent, this.options.slot);
					event.syraRetValue = false;
					return;
				}
			}
		}
		return null;
	},
	onDragMove: function(target, event) {
		if (!syra_dd.ddAgent) {
			if (this.isEnabled && target && target.syraWidgetResizer == this.id) {
				if (!this.slotRect) {
					this.slotRect = syra_site.dom.getBoundingClientRect(this.options.slot, this);
				}
				this.isLeft = this.options.direction.left && ((event.pageX >= this.left) && (event.pageX <= (this.left + 5)));
				this.isRight = this.options.direction.right && ((event.pageX <= this.right) && (event.pageX >= (this.right - 5)));
				this.isTop = this.options.direction.top && ((event.pageY >= this.top) && (event.pageY <= (this.top + 5)));
				this.isBottom = this.options.direction.bottom && ((event.pageY <= this.bottom) && (event.pageY >= (this.bottom - 5)));
				this.cursor = "default";
				if (this.isLeft) {
					this.cursor = (this.isTop) ? "nw-resize" : ((this.isBottom) ? "sw-resize" : "w-resize");
				} else
				if (this.isRight) {
					this.cursor = (this.isTop) ? "ne-resize" : ((this.isBottom) ? "se-resize" : "e-resize");
				} else {
					this.cursor = (this.isTop) ? "n-resize" : ((this.isBottom) ? "s-resize" : "default");
				}
				this.resizerSpot.style.cursor = this.cursor;
			}
		} else {
			delete this.slotRect;
			if (syra_dd.ddAgent.resizer == this) {
				return;
			}
		}
		return true;
	},
	setResizable: function(options) {
		this.id = helpers.uuid.generate();
		syra_dd.barResizer.push(this);
		this.options = options;
		this.isEnabled = true;
		if (this.options.dragSpot) {
			this.options.dragSpot.syraWidgetDrag = this.id;
			this.options.dragSpot.syraDragSpot = this.options.source.id;
			this.options.dragSpot.style.cursor = "move";
		}
		if (this.options.isResizingEnabled !== false && this.options.direction !== null) {
			if (this.options.direction === undefined) {
				this.options.direction = {
					top: true,
					left: true,
					right: true,
					bottom: true
				};
			}
			this.resizerSpot = this.options.resizerSpot || this.options.slot;
			this.resizerSpot.syraWidgetResizer = this.id;
			this.resizerSpot.style.cursor = "default";
			this.options.dragSpot.resizerSpot = this.options.source.id;
		}
	},
	dispose: function() {
		var ii = syra_dd.barResizer.indexOf(this);
		if (ii >= 0) {
			syra_dd.barResizer.splice(ii, 1);
		}
		if (this.options) {
			this.options.onResize = null;
		}
		this.resizerSpot = this.options = null;
	}
});