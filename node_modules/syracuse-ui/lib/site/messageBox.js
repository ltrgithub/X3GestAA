"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var keyHelper = require('syracuse-ui/lib/site/keyHelper');

function MessageBox(){
}

exports.MessageBox = helpers.defineClass(MessageBox, null, {
    open: function(options){
        var self = this;
        self.localize = locale.resources(module)();
        document.site.addResizeListener(self);
        self.$$btns = {};
        var domItem = document.createElement("div");
        domItem.className = "s-msgbox";
        self.$$item = $(domItem);
        self.callback = options.callback;
        
        // header
        var div = document.createElement("div");
        div.className = "s-msgbox-header";
        self.$$header = $(div).appendTo(self.$$item);
        
        // header title
        div = document.createElement("div");
        div.className = "s-msgbox-header-title s-msgbox-msg-" + (options.$severity || options.$type);
        $(div).appendTo(self.$$header).text(options.$title)
        
        // body
        div = document.createElement("div");
        div.className = "s-msgbox-body";
        self.$$body = $(div).appendTo(self.$$item);
        
        
        //-----------------------
        // building body content
        //-----------------------
        
        // message
        self._appendMessage(options);
        
        // links (AFTER MSG ADDITION !)
        if (options.$links || options.$actions) {
            var div = document.createElement("div");
            div.className = "s-msgbox-links";
            self.$$links = $(div).appendTo(self.$$body);
            self.drawLinks(options);
        }
        
        
        // origin
        if (options.$origin) 
            self._appendOrigin(options.$origin);
        
        // details
        if (options.$details) 
            self._appendDetails(options.$details);
        
        // diagnoses
        if (options.$diagnoses) 
            self._appendDiagnoses(options.$diagnoses);
        
        // building footer
        div = document.createElement("div");
        div.className = "s-msgbox-foot";
        self.$$footer = $(div).appendTo(self.$$item).delegate("a.s-msgbox-button", "click", function(){
            var response = {
                $$button: $(this),
                $id: $(this).attr("data-s-id")
            };
            if (self.$$prompt) {
                response.prompt = self.$$prompt.val();
            }
            self.close(response.$id, response);
            return false;
        });
        
        // drawing buttons
        self.drawButtons(options);
        
        // handling window dimension 
        self._setMinimumDimensions();
        self.onWindowResize();
        
        // showing msgbox
        if (options.$$container) {
            (self.$$container = options.$$container).append(self.$$item);
            domItem.style.display = "inline-block";
        }
        else {
            domItem.style.position = "fixed";
            self.dialog = document.site.openDialog({
                id: document.controller.generateUUID(),
                content: self,
                $autoClose: false,
                $dialogSize: "content",
            });
        }
        
        // autoclose
        if (options.$autoClose) {
            var count = (typeof(options.$autoClose) == "number" ? options.$autoClose : 4000) / 1000;
            var titleDom = self.$$header.children("div.s-msgbox-header-title")[0];
            titleDom.textContent = options.$title + "  (" + count + ")";
            self.autoCloseTimeOut = setInterval(function(){
                var countTxt = "(" + (--count) + ")";
                titleDom.textContent = options.$title + " " + countTxt;
                if (count == 0) {
                    clearInterval(self.autoCloseTimeOut);
                    self.close("auto");
                }
            }, 1000);
        }
        
        // handling window close with ENTER or ESCAPE buttons
        $(document).bind("keypress.msgbox", function(evt){
            switch (evt.keyCode) {
                case keyHelper.keyCode.ENTER:
                    setTimeout(function(){
                        self.$$defaultBtn.click();
                    }, 100);
                    break;
                case keyHelper.keyCode.ESCAPE:
                    setTimeout(function(){
                        self.close("esc");
                    }, 100);
                    break;
            }
        });
    },
    _appendMessage: function(options){
        var self = this;
        // message
        var msg;
        msg = options.$message || self.localize.msgbox_default_message;
        var div = document.createElement("div");
        div.className = "s-msgbox-msg";
        self.$$message = $(div);
        self.$$message.html(msg.replace(/\n/g, '<br/>')).appendTo(self.$$body);
    },
    _appendStackTrace: function(){
        var self = this;
        var div = document.createElement("div");
        div.className = "s-msgbox-core";
        self.$$core = $(div);
        self.$$core.appendTo(self.$$body).hide();
        
        // navbar
        var nav = document.createElement("nav");
        nav.className = "s-msgbox-core-tabs-nav";
        self.$$coreTabsNav = $(nav);
        self.$$coreTabsNav.appendTo(self.$$core);
        
        var tab = document.createElement("a");
        tab.className = "s-msgbox-core-tab-open";
        tab.textContent = "Formatted";
        self.$$coreTabsNav[0].appendChild(tab);
        tab = document.createElement("a");
        tab.className = "s-msgbox-core-tab";
        tab.textContent = "Raw";
        self.$$coreTabsNav[0].appendChild(tab);
        
        self.$$coreTabsNav.delegate("a.s-msgbox-core-tab", "click", function(){
        	$(this).parent().children("a.s-msgbox-core-tab-open")[0].className = "s-msgbox-core-tab";
			$(this)[0].className = "s-msgbox-core-tab-open";
			//tab.toggleClass("s-msgbox-core-tab").toggleClass("s-msgbox-core-tab-open");
			
			// change content
			self.$$coreFormatted.toggle();
			self.$$coreRaw.toggle();
			
			return false;
        });
		
		// tabs content
		div = document.createElement("div");
		div.className = "s-msgbox-core-tab-formatted";
		self.$$coreFormatted = $(div).appendTo(self.$$core);
		
		div = document.createElement("div");
		div.className = "s-msgbox-core-tab-raw";
		self.$$coreRaw = $(div).appendTo(self.$$core).hide();
//		var textArea = document.createElement("textarea");
//		textArea.className = "s-msgbox-core-textarea";
//		textArea.setAttribute('readonly','readonly');
//		self.$$coreRaw[0].appendChild(textArea);
        
        // show/hide picker button
        self.$$bodyPicker = $(document.createElement("a")).addClass("s-msgbox-picker-closed");
        self.$$bodyPicker.text(self.localize.msgbox_body_picker_closed);
        self.$$bodyPicker.bind("click", function(){
            self.$$core.toggle();
            self.$$bodyPicker.toggleClass("s-msgbox-picker-closed").toggleClass("s-msgbox-picker-opened");
            var pickerTxt = self.$$bodyPicker.hasClass("s-msgbox-picker-closed") ? self.localize.msgbox_body_picker_closed : self.localize.msgbox_body_picker_opened;
            self.$$bodyPicker.text(pickerTxt);
            
            self.onWindowResize();
            if (self.dialog) {
                self.dialog.onWindowResize();
            }
            return false;
        });
        div = document.createElement("div");
        div.className = "s-msgbox-picker";
        self.$$body.find("div.s-msgbox-msg").after($(div).append(self.$$bodyPicker));
    },
    _appendOrigin: function($origin){
        var self = this;
        if (!self.$$core) {
            self._appendStackTrace();
        }
        var origin = self.localize.msgbox_body_stackTrace_origin + $origin;
		
		// add to formatted tab content
        var div = document.createElement("div");
        div.className = "s-msgbox-origin";
        $(div).html(origin).appendTo(self.$$coreFormatted);
		
		// add to raw tab content
		//self.$$coreRaw.children("textarea.s-msgbox-core-textarea")[0].innerHTML += $origin + "\n";
		self.$$coreRaw[0].innerHTML += $origin + "<br/>";
    },
    _appendDetails: function($details){
        var self = this;
        if (!self.$$core) {
            self._appendStackTrace();
        }
		// add to formatted tab content
        var div = document.createElement("div");
        div.className = "s-msgbox-details";
        $(div).html($details.replace(/\n/g, '<br/>')).appendTo(self.$$coreFormatted);
		
		// add to raw tab content
		//self.$$coreRaw.children("textarea.s-msgbox-core-textarea")[0].innerHTML += $details + "\n";
		self.$$coreRaw[0].innerHTML += $details + "<br/>";
    },
    _appendDiagnoses: function($diagnoses){
        var self = this;
        if (!self.$$core) {
            self._appendStackTrace();
        }
		// add to formatted tab content
        var div = document.createElement("div");
        div.className = "s-msgbox-diagnoses";
        self.$$diagnoses = $(div).appendTo(self.$$coreFormatted);
        self.groups = new Groups(self);
        self.groups.drawDiagnoses($diagnoses);
        self.groups.appendToViewer(self.$$diagnoses);
		
		// add to raw tab content
		//self.$$coreRaw.children("textarea.s-msgbox-core-textarea")[0].innerHTML += detailToString($diagnoses);
		self.$$coreRaw[0].innerHTML += detailToString($diagnoses);
    },
    drawLinks: function(message){
        var page = document.site.mainPage;
        var self = this;
        if (!self._menus) {
            self._menus = document.itemFactory.load(self.$$links, {
                $category: "links",
                $skin: "s-msgbox-links",
                $isBindDisabled: true,
                $links: {},
                $actions: {}
            }, page);
        }
        ["$links", "$actions"].forEach(function($type){
            var $menus = message[$type];
            if ($menus) {
                var $isAction = $type == "$actions";
                Object.keys($menus).forEach(function($bind){
                    var $menu = $menus[$bind];
                    var bound = page.menuItems[$menu.$bind || $bind];
                    if (bound) {
                        bound[0].setMenu($menu);
                    }
                    else {
                        $menu.$isAction = $isAction;
                        self._menus.addMenuItem($menu);
                    }
                });
            }
        });
    },
    _setMinimumDimensions: function(){
        this.$$item[0].style.minWidth = "350px"; // "400px" ? "100px" ?
        //this.$$body[0].style.minHeight = "30px";
        if (this.$$core) {
            this.$$core[0].style.minHeight = "180px";
        }
    },
    onWindowResize: function(setMinimumDimensions){
        var body = document.site.$$body[0];
        
        var computeItemMaxWidth = (body.clientWidth - 600);
        //var computeBodyMaxHeight = (body.clientHeight - this.$$header.outerHeight() - 150);
        
        this.$$item[0].style.maxWidth = computeItemMaxWidth >= 800 ? "800px" : computeItemMaxWidth + "px";
        //this.$$body[0].style.maxHeight = computeBodyMaxHeight;
        
        if (this.$$core) {
            var bodyMsgHeight = this.$$body.children(".s-msgbox-msg").outerHeight();
            var computeBodyStackMaxHeight = (body.clientHeight - this.$$header.outerHeight() - bodyMsgHeight - 150);
            this.$$core[0].style.maxHeight = computeBodyStackMaxHeight >= 500 ? "500px" : computeBodyStackMaxHeight + "px";
        }
    },
    drawButtons: function(options){
        var self = this;
        var $buttons = options.$buttons;
        if (options.$type == "question") {
            $buttons = $buttons || "yesno";
        }
        if (options.$type == "prompt") {
            $buttons = $buttons || "okcancel";
            self.$$prompt = $("<input type='text'/>").addClass("s-msgbox-prompt").attr("size", "50").appendTo(self.$$body);
        }
        
        $buttons = $buttons || "ok";
        ["yes", "no", "ok", "cancel"].forEach(function($id){
            if ($buttons.indexOf($id) >= 0) {
                self.drawButton({
                    $id: $id,
                    $text: self.localize["msgbox_" + $id]
                });
            }
        });
        
        self.$$defaultBtn = self.$$btns[options.$default || "ok"];
        if (!self.$$defaultBtn) {
            self.$$defaultBtn = self.$$btns[Object.keys(self.$$btns)[0]];
        }
        self.$$defaultBtn.addClass("s-msgbox-button-default");
    },
    drawButton: function($btn){
        var btn = document.createElement("a");
        btn.className = "s-msgbox-button";
        btn.setAttribute("data-s-id", $btn.$id);
        this.$$btns[$btn.$id] = $(btn).text($btn.$text).appendTo(this.$$footer);
    },
    close: function(closedBy, response){
        if (this.callback ? (this.callback(response, closedBy) !== false) : true) {
            if (this.$$item) {
                this.$$item.remove();
            }
            document.controller.disposeObject(this);
        }
    },
    dispose: function(){
        document.site.removeResizeListener(this);
        if (this.groups) {
            this.groups.dispose();
            delete this.groups;
        }
        if (this.$$coreTabsNav) {
            this.$$coreTabsNav.undelegate();
        }
        if (this.autoCloseTimeOut) {
            clearInterval(this.autoCloseTimeOut);
            delete this.autoCloseTimeOut;
        }
        if (this.$$footer) {
            this.$$footer.undelegate();
        }
        $(document).unbind("keypress.msgbox");
        if (this.$$bodyPicker) {
            this.$$bodyPicker.unbind();
        }
        if (this.$$copyPicker) {
            this.$$copyPicker.unbind();
        }
        if (this.$$openPicker) {
            this.$$openPicker.unbind();
        }
        if (this.autoCloseConfirMsg) {
            clearTimeout(this.autoCloseConfirMsg);
            delete this.autoCloseConfirMsg;
        }
    }
});


function Group(){

}

helpers.defineClass(Group, null, {
    create: function(severity){
        var group = document.createElement("div");
        group.className = 's-diag-view-group-' + (this.severity = severity);
        this.localize = locale.resources(module)();
        this.$$group = $(group);
        this._messages = [];
        this.bindEvents(true);
    },
    bindEvents: function(bind){
        var self = this;
        if (bind) {
            self.$$group.delegate(".s-msgbox-diag-picker", "click", function(){
                var message = self._messages[this.getAttribute("data-s-index")];
                if (message.$$stackTraceView) {
                    message.$$stackTraceView.toggle();
                    //self.toggle(message.$$stackTraceView, $(this));
                }
                else {
                    var stackTraceView = document.createElement("div");
                    stackTraceView.className = "s-msgbox-diag-stackTrace";
                    stackTraceView.innerHTML = preformat(message.stackTrace.replace(/\n/g, "<br/>"));
                    message.label.appendChild(stackTraceView).style.display = "none";
                    message.$$stackTraceView = $(stackTraceView);
                    message.$$stackTraceView.toggle();
                    //document.site.setZIndex(message.$$stackTraceView = $(stackTraceView));
                    //self.toggle(message.$$stackTraceView, $(this));
                }
                return false;
            });
        }
        else {
            self.$$group.undelegate();
        }
    },
    /*
     toggle: function($$item, $$parent){
     if ($$item.is(":visible")) {
     $$item.toggle(false);
     }
     else {
     document.site.$$container.append($$item);
     $$item.show().position({
     my: "left top",
     at: "right bottom",
     of: $$parent
     });
     }
     },*/
    empty: function(field){
        if (field) {
            this.$$group.children().children("a[data-s-menu=" + field.id + "]").parent().remove();
        }
        else {
            this.$$group.empty();
        }
    },
    drawLabel: function($diagnose){
        var message = {
            label: document.createElement("label"),
            stackTrace: $diagnose.stackTrace
        };
        this._messages.push(message);
        message.label.className = "s-diag-view-msg-" + this.severity;
        message.label.innerHTML = document.site.formatHTMLMessage($diagnose.message || this.localize.msgbox_diagnose_default_msg);
        //$(label).append(document.site.formatHTMLMessage($diagnose.message || this.localize.msgbox_diagnose_default_msg));
        if ($diagnose.stackTrace) {
            // picker
            var picker = document.createElement("a");
            picker.setAttribute("data-s-index", this._messages.length - 1);
            picker.className = "s-msgbox-diag-picker";
            message.label.appendChild(picker);
        }
        return message.label;
    },
    drawDiagnose: function($diagnose){
        this.$$group[0].appendChild(this.drawLabel($diagnose));
    },
    appendToViewer: function($$body){
        this.$$group.appendTo($$body);
    },
    dispose: function(){
        this.bindEvents(false);
        this.$$count = this.$$group = null;
    }
});

function Groups(viewer){
    var self = this;
    self.severities = {};
    self._groups = (["error", "fatal", "warning", "info"]).map(function(severity){
        (self.severities[severity] = new Group()).create(severity);
        return self.severities[severity];
    });
    self.viewer = viewer;
}

helpers.defineClass(Groups, null, {
    getGroup: function(severity){
        // FDB - Take into account bad severity values
        if (severity == null || severity.length == 0) {
            severity = "error";
        }
        else {
            severity = severity.toLowerCase();
        }
        var grp = this.severities[severity];
        return grp ? grp : this.severities["error"];
    },
    drawFieldDiagnoses: function($diagnoses, field){
        var self = this;
        field.ensureDiagnoseSlot();
        var group;
        $diagnoses.forEach(function($diagnose){
            field.drawDiagnose($diagnose, group = self.getGroup($diagnose.severity));
            self.drawLinks($diagnose);
        });
        field.domDiagnose.style.visibility = "";
        if (group) {
            field.toggleDiagnose("s-" + group.severity, true);
        }
    },
    drawDiagnoses: function($diagnoses){
        var self = this;
        $diagnoses.forEach(function($diagnose){
            self.getGroup($diagnose.severity).drawDiagnose($diagnose);
            self.drawLinks($diagnose);
        });
    },
    drawLinks: function($diagnose){
        if ($diagnose.$links || $diagnose.$actions) {
            this.viewer.drawLinks($diagnose);
        }
    },
    empty: function(field){
        this._groups.forEach(function(group){
            group.empty(field);
        });
    },
    appendToViewer: function($$body){
        this._groups.forEach(function(group){
            group.appendToViewer($$body);
        });
    },
    dispose: function(){
        var self = this;
        self._groups.forEach(function(group){
            delete self.severities[group.severity];
            group.dispose();
        });
        delete self._groups;
        delete self.viewer;
    }
});


function preformat(txt){
    return "<pre class='s-msgbox-pre'>" + txt + "</pre>";
}

function detailToString(o){
    if (o == undefined) 
        return "";
    try {
        if (typeof(o) == 'string') {
            if (o.length == 0) 
                return o;
            o = JSON.parse(o);
        }
        return JSON.stringify(o, null, "   ");
    } 
    catch (e) {
        return o.toString();
    }
}
