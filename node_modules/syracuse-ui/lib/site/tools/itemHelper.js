"use strict";

var _pagesMap = {};

//for convergence
exports.getDashBoard = function(){
    var categories = ["dashboard", "navigation", "landing"];
    var keys = Object.keys(_pagesMap);
    for (var ii = 0, jj = keys.length; ii < jj; ii++) {
        var page = _pagesMap[keys[ii]];
        if (categories.indexOf(page.$pageCategory) >= 0) {
            return page;
        }
    }
};

exports.findPage = function(pageId){
    return _pagesMap[pageId];
}

exports.findArticle = function(item){
    while (item != null && !item.syraArticle) {
        item = item.parentNode;
    };
    if (item && item.syraArticle) {
        var page = _pagesMap[item.syraPageId];
        if (page) {
            return item.syraPageId == item.syraArticle ? page : page.findChildArticle(item.syraArticle);
        }
    }
    return null;
};
exports.findField = function(target){
    var article = exports.findArticle(target);
    if (article && article.idMap) {
        while (target != null && !target.syra_field_id && !target.syraArticle) {
            target = target.parentNode;
        }
        if (target && target.syra_field_id) {
            return article.idMap[target.syra_field_id];
        }
    }
    return (article && (!article.idMap || !article.idMap.length) && article.isField) ? article : null;
};

exports.findBox = function(item){
    var article = exports.findArticle(item);
    var id = item.syraBoxId || item.getAttribute("data-s-box");
    while (item != null && !id) {
        id = item.getAttribute("data-s-box");
        item = item.parentNode;
    }
    var box = null;
    if (article) {
        box = article.idMap[id];
    }
    if (!box && id == article.id) {
        box = article;
    }
    return box;
};

exports.findMenu = function(item){
    var article = exports.findArticle(item);
    if (article) {
        var id = item.getAttribute("data-s-menu");
        return (article.id == id) ? article : (article.idMap[id] || null);
    }
    return null;
};

exports.registerArticle = function(article){
    if (article.page == article) {
        _pagesMap[article.id] = article;
    }
    else {
        if (article && article.page) {
            article.page._articles.push(article);
        }
    }
};
exports.unregisterArticle = function(article){
    if (article.page) {
        if (article.page == article) {
            delete _pagesMap[article.id];
        }
        else {
            if (article.page._articles) {
                article.page._articles.splice(article.page._articles.indexOf(article), 1);
            }
        }
    }
};
exports.dispose = function(){
    _pagesMap = null;
};
