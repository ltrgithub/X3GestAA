"use strict";
var _locker, _overlay, _dummy, _timeout;

exports.lock = function(delay, isLong, forceFocusLoss, evtBuffering) {
	function _lock() {
		if (isLong) {
			syra_quality.logLock(2);
			_overlay.style.display = "";
		}
		exports.ensureLock();
		return null;
	}
	if (!_locker) {
		_locker = document.createElement('div');
		_locker.className = "s-uiLocker-loading";
		_dummy = document.createElement('a');
		_dummy.setAttribute("href", "#");
		_dummy.syrUILockerBlackHole = true;
		_locker.appendChild(_dummy);
		syra_site.layoutSlot.appendChild(_locker);
	}
	if (!_overlay) {
		_overlay = syra_dom.addDiv("s-uiLocker-overlay", syra_site.layoutSlot);
		_overlay.syraIsOverlay = true;
		_overlay.style.display = "none";
	}
	_dummy.syrUILockerEvtBuffering = _dummy.syrUILockerBlackHole ? evtBuffering : null;
	_locker.style.display = "";
	syra_quality.logLock(1);
	if (forceFocusLoss) {
		_dummy.focus();
	}
	_timeout = !delay ? _lock() : setTimeout(_lock, delay);

};

exports.ensureLock = function(toggleOverlay) {
	if (_locker && _locker.style.display !== "none") {
		var site = syra_site;
		if (!toggleOverlay) {
			syra_dom.setZIndex(_locker);
		}
		var siteSize = site.getSize();
		var height = siteSize.height;
		var style, top = 0;
		if (site.header) {
			var headerH = site.header.clientHeight;
			if (headerH) {
				top = headerH;
				height -= top;
			}
		}
		if (!toggleOverlay) {
			style = _locker.style;
			style.top = top + "px";
			style.height = height + "px";
		}

		style = _overlay && _overlay.style;
		if (style && style.display !== "none") {
			style.top = top + "px";
			style.height = height + "px";
			if (!toggleOverlay) {
				syra_dom.setZIndex(_overlay);
			}
		}
	}
};

exports.unlock = function() {
	if (_locker) {
		_locker.style.display = "none";
	}
	if (_overlay) {
		_overlay.style.display = "none";
	}
	if (_timeout) {
		clearTimeout(_timeout);
		_timeout = null;
	}
	syra_quality.logLock(0);
};

exports.toggleOverlay = function() {
	syra_quality.logLock(2);
	_overlay.style.display = "";
	exports.ensureLock(true);
};

exports.dispose = function() {
	_locker = _overlay = _dummy = _timeout = null;
};