"use strict";
var helpers = require('syracuse-core/lib/helpers');
var bookmarksManager = require("syracuse-ui/lib/site/bookmarks/bookmarksManager");
var dragDropManager = require("syracuse-ui/lib/site/tools/dragDropManager");
var TopPanel = require("syracuse-ui/lib/site/tools/topPanel").TopPanel;
var spyer = require('syracuse-ui/lib/site/spy/spyer');
var searcherPage = require('syracuse-ui/lib/site/search/searcherPage');

var _pageDesignerOpener;

exports.addBookmarkManager = function() {
	var bar = document.createElement("div");
	bar.id = "s-site-header-bottom-bookmarks";
	syra_site.bookmarksManager = bookmarksManager;
	syra_site.bookmarksManager.load(syra_site.headerBottom.appendChild(bar));
};

exports.addJobsOpener = function(slot) {
	var btn = syra_site._jobsViewerOpener = syra_menus.addIconButton("", "s-jobs-viewer-opener", "onJobsOpenerClick");
	btn.syraSiteObserver = "siteFunctions";
	btn.style.display = "none";
	slot.appendChild(btn);
};
exports.onJobsOpenerClick = function() {
	syra_site.jobsPage && syra_site.jobsPage.toggle();
};

function _runJobsViewer() {
	syra_controller.sendRequest(null, {
		method: "GET",
		$location: {
			$url: "/sdata/$trackers"
		}
	}, function(data, response, $url) {
		if (data.$resources && data.$resources.length > 0) {
			for (var ii = 0, jj = data.$resources.length; ii < jj; ii++) {
				var resource = data.$resources[ii];
				var params = {
					$location: resource.location || resource.$location,
					$state: resource.phase,
					$title: resource.title || "(Title not retrieved)",
					uuid: resource.uuid,
					kind: "operation"
				};
				syra_site.registerJobSyra(params.$location, params.$state, params.$title, params.uuid);
			}
		}
	}, function(error, httpquery) {
		httpquery.showError(error);
	});
}

exports.addLogo = function(slot) {
	var title, href;
	var home = syra_site._getHomeMenu();
	if (home) {
		title = home.domItem.title;
		href = home.domItem.getAttribute("href");
	}
	var btn = syra_menus.addIconButton(title || "", "s-site-header-logo", "onLogoClick");
	btn.syraSiteObserver = "siteFunctions";
	href && btn.setAttribute("href", href);
	slot.appendChild(btn);

};
exports.onLogoClick = function() {
	syra_menus.gotoHome();
};

exports.addLogoutButton = function() {
	var btn = syra_menus.addIconButton(syra_local.siteLogoutLink, "s-site-logout", "onLogoutClick");
	btn.syraSiteObserver = "siteFunctions";
	syra_site.headerTop.appendChild(btn);
};
exports.onLogoutClick = function() {
	syra_site.logout();
};
exports.addPageDesignerOpener = function() {
	_pageDesignerOpener = syra_menus.addIconButton(syra_local.userProfile_siteAuthoringOpen, "s-page-designer-opener", "onPageDesignerClick");
	_pageDesignerOpener.syraSiteObserver = "siteFunctions";
	_pageDesignerOpener.style.visibility = "hidden";
	syra_site.headerTop.appendChild(_pageDesignerOpener);
};
exports.showPageDesignerOpener = function(show) {
	if (_pageDesignerOpener) {
		_pageDesignerOpener.style.visibility = show ? "" : "hidden";
	}
};
exports.onPageDesignerClick = function() {
	var page;
	exports.toggleTopPanel(false);
	if (syra_site.mainPage.isFusionPage) {
		page = syra_site.fusionGateway.activatedBook.selectedSheet;
	} else {
		page = syra_site.dialogManager.getTopDialogPage();
		if (page) {
			page = page._content;
		}
	}
	page = page || syra_site.mainPage;
	page && page.designArticle(true);
};

exports.addDragDropManager = function() {
	window.syra_dd = dragDropManager;
};

exports.loadSpyer = function() {
	syra_site.spyer = spyer;
};


var _topPanel;

exports.appendTopPanelOpener = function(layoutSlot) {
	var btn = syra_menus.addIconButton(syra_local.site_openWelcomePanel, "s-site-top-pn-opener-link", "onTopPanelClick");
	btn.syraSiteObserver = "siteFunctions";
	_topPanel = {
		opener: btn
	};
	layoutSlot.appendChild(btn);
};
exports.onTopPanelClick = function() {
	exports.toggleTopPanel(true);
};
exports.toggleTopPanel = function(show, event, onBeforeClick) {
	if (_topPanel) {
		var isVisible;
		if (show) {
			if (!_topPanel.panel) {
				_topPanel.container = document.createElement("div");
				_topPanel.container.className = "s-site-top-pn";
				_topPanel.container.style.display = "none";
				syra_site.layoutSlot.appendChild(_topPanel.container);
				_topPanel.panel = new TopPanel();
				_topPanel.panel.$prototype = syra_site.$prototype;
				_topPanel.panel.page = syra_site;
				_topPanel.panel.layoutSlot = _topPanel.container;
				_topPanel.panel.loadBox();
			}
			if (_topPanel.container.style.display == "none") {
				isVisible = true;
				var rect = _topPanel.opener.getBoundingClientRect();
				if (document.dir === 'rtl') {
					_topPanel.container.style.left = rect.left + "px";
				} else {
					_topPanel.container.style.right = (syra_site.getLayoutSize().right - rect.right) + "px";
				}
				if (_topPanel.panel.navigationBar) {
					_topPanel.panel.navigationBar.domItem.style.display = (syra_site.fusionGateway && syra_site.fusionGateway.activatedBook) ? "none" : "";
				}
			}
		} else {
			if (onBeforeClick && event &&
				((event.target == _topPanel.opener) ||
					_topPanel.opener.contains(event.target))) {
				return;
			}
			if (_topPanel.panel) {
				var panel = _topPanel.panel;
				if (event) {
					var isNavigationLink = panel.navigationBar && panel.navigationBar.domItem.contains(event.target);
					if (!isNavigationLink && panel.domItem.contains(event.target)) {
						return;
					}
				}
			}
		}
		if (_topPanel.container) {
			_topPanel.container.style.display = isVisible ? "" : "none";
		}
		if (_topPanel.opener) {
			syra_site.dom.toggleClass(_topPanel.opener, "s-open", isVisible);
		}
	}
};


function _showPageSecurity(page, role, endpoint) {
	if (syra_site.$item.$isPageSecurityView !== false) {
		if (role || endpoint) {
			role = role && role.description;
			endpoint = endpoint && endpoint.description;
			var pages = page ? [page] : syra_site.pageLoader.getLoaded();
			for (var ii = 0, jj = pages.length; ii < jj; ii++) {
				page = pages[ii];
				if (page.securityViewSlot) {
					syra_site.dom.empty(page.securityViewSlot);
					if (role) {
						var item = document.createElement("div");
						item.className = "s-security-user-role";
						item.textContent = role;
						page.securityViewSlot.appendChild(item);
					}
					if (endpoint) {
						var item = document.createElement("div");
						item.className = "s-security-user-endpoint";
						item.textContent = endpoint;
						page.securityViewSlot.appendChild(item);
					}
				}
			}
		}
	}
}

function _refreshBrowserTitle(page, role, endpoint) {
	var title = page.getTitle();
	if (title) {
		if (page.$item.$isSecurityTitleVisible !== false) {
			var role = syra_site.userProfile.getSelectedRole();
			var endpoint = syra_site.userProfile.getSelectedEndpoint();
			if (role) {
				title += " (" + role.description + ")";
			}
			if (endpoint) {
				title += " (" + endpoint.description + ")";
			}
		}
		document.title = title;
	}
}

exports.refreshMainPageSecurity = function(page, role, endpoint) {
	if (page && !page.disposed) {
		role = role || syra_site.userProfile.getSelectedRole();
		endpoint = endpoint || syra_site.userProfile.getSelectedEndpoint();
		_showPageSecurity(page, role, endpoint);
		(page.isLandingPage || (page == syra_site.mainPage)) && _refreshBrowserTitle(page, role, endpoint);
		if (page.mainPageDesignerAccess != "unknow") {
			exports.showPageDesignerOpener(page.mainPageDesignerAccess != "disabled" && syra_site.userProfile.hasDesignRight());
		}
	}
};


exports.showUserIdentity = function() {
	var userProfile = syra_site.userProfile;
	if (_topPanel && _topPanel.opener && userProfile.dataset.user && !syra_site.nameDiv) {
		var nameDiv = syra_site.nameDiv = document.createElement("div");
		nameDiv.className = "s-site-user-name";
		nameDiv.textContent = (userProfile.dataset.user.firstName ? userProfile.dataset.user.firstName + " " : "") + (userProfile.dataset.user.lastName ? userProfile.dataset.user.lastName : "");
		_topPanel.opener.appendChild(nameDiv);

		var photoDiv = document.createElement("div");
		photoDiv.className = "s-site-user-photo";
		if (userProfile.dataset.user.photo) {
			userProfile.loadNewItem(photoDiv, {
				$css: "s-site-user-photo",
				$skin: "s-site-user-photo",
				$inplace: true,
				$imageWidth: " ",
				$imageHeight: " ",
				$bind: "photo",
				$category: "field",
				$field: {
					$type: "image"
				}
			}).setDataValue({
				$url: syra_site.expressionMaker.parse(userProfile, userProfile.dataset.user.photo.$url, {
					$uuid: userProfile.dataset.user.$uuid,
					$pluralType: "users",
					$key: userProfile.$prototype.$key,
					$baseUrl: userProfile.$prototype.$baseUrl
				})
			});
		} else {
			var mn = document.createElement("a");
			mn.className = "s-site-user-nophoto";
			photoDiv.appendChild(mn);
		}
		_topPanel.opener.appendChild(photoDiv);
	}
};


exports.onBeforeClick = function(box, event) {
	exports.toggleTopPanel(false, event, true);
	if (event && event.type != "scroll") {
		syra_dd.stop();
	}
	syra_site.dialogManager.closePopups(box, event);
};



var _titleTip = {};

function _clearTitleTip(disposing) {
	_titleTip.timeOut && clearTimeout(_titleTip.timeOut);
	_titleTip.popup && _titleTip.popup.close();
	_titleTip.timeOut = _titleTip.popup = null;
	if (disposing) {
		_titleTip = null;
	}
}

exports.toggleTitleTip = function(text, target) {
	_clearTitleTip();
	if (text) {
		_titleTip.timeOut = setTimeout(function() {
			if (!_titleTip.textItem) {
				_titleTip.textItem = document.createElement("div");
				_titleTip.textItem.className = "s-title-tip";
			}
			_titleTip.textItem.textContent = text;
			if (target.syraShortCutTip) {
				var shortCut = document.createElement("div");
				shortCut.className = "s-title-shortcut";
				shortCut.textContent = target.syraShortCutTip;
				_titleTip.textItem.appendChild(shortCut);
			}
			_titleTip.popup = syra_site.dialogManager.openPopup(syra_site, {
				content: {},
				slot: _titleTip.textItem,
				position: {
					my: "left top",
					at: "left bottom+15",
					of: $(target)
				}
			});
		}, 800);
	}
};

exports.addSearchField = function(slot) {
	syra_site.searcher = searcherPage.load(slot);
};

exports.closeSearchFieldPopup = function() {
	syra_site.searcher && syra_site.searcher.searchField && syra_site.searcher.searchField.closeSuggest();
};

exports.showSearcher = function(show) {
	if (syra_site.searcher) {
		syra_site.searcher.domItem.style.display = show ? "none" : "";
	}
};

exports.refreshPageData = function(page) {
	if (page.isFusionPage) {
		syra_menus.clickMenu(page, "2823");
	} else {
		page.$autoFetch &&
			page.fetch({}, function(data, response, requestUrl) {
				if (!page || !page.disposed) {
					page.startChange();
					page.applyChange(data, response, requestUrl);
					page.endChange();
				}
			});
	}
};



exports.refreshPageData = function(page) {
	if (page.isFusionPage) {
		syra_menus.clickMenu(page, "2823");
	} else {
		page.$autoFetch &&
			page.fetch({}, function(data, response, requestUrl) {
				if (!page || !page.disposed) {
					page.startChange();
					page.applyChange(data, response, requestUrl);
					page.endChange();
				}
			});
	}
};

exports.togglePageSideBar = function(page, switchLeft, switchRight) {
	exports.toggleTitleTip();
	if (switchLeft) {
		page.fusionBar && page.fusionBar.collapse();
		var landingMaster = page.isLandingMaster ? page : page.landingPageMaster;
		if (!landingMaster) {
			landingMaster = page.vignetteField && page.vignetteField.page && page.vignetteField.page.landingPageMaster;
		}
		landingMaster && landingMaster.bar && landingMaster.bar.collapse();

		if (page.menuBar && page.menuBar.options.resizeDirection == "left") {
			page.menuBar.collapse();
		}
	}
	if (switchRight) {
		if (page.menuBar && page.menuBar.options.resizeDirection !== "left") {
			page.menuBar.collapse();
		}
	}
};

exports.showFieldProperty = function(field) {
	if (field.page.isFusionPage) {
		syra_menus.clickMenu(field.page, "1172");
	} else {

	}
};

exports.dispose = function() {
	_clearTitleTip(true);
	if (syra_site) {
		syra_site.bookmarksManager && syra_site.bookmarksManager.dispose();
		syra_site.jobsPage && syra_site.jobsPage.dispose();
		syra_site.spyer && syra_site.spyer.dispose();
		dragDropManager.dispose();
		syra_site.jobsPage = syra_site.bookmarksManager = window.syra_dd = syra_site.spyer = null;
		_pageDesignerOpener = _topPanel = null;
	}
};



exports.showFieldProperty = function(field) {
	if (field.page.isFusionPage) {
		syra_menus.clickMenu(field.page, "1172");
	} else {

	}
};

exports.dispose = function() {
	_clearTitleTip(true);
	if (syra_site) {
		syra_site.bookmarksManager && syra_site.bookmarksManager.dispose();
		syra_site.jobsPage && syra_site.jobsPage.dispose();
		syra_site.spyer && syra_site.spyer.dispose();
		dragDropManager.dispose();
		syra_site.jobsPage = syra_site.bookmarksManager = window.syra_dd = syra_site.spyer = null;
		_pageDesignerOpener = _topPanel = null;
	}
};