"use strict";
var helpers = require('syracuse-core/lib/helpers');
var bookmarksManager = require("syracuse-ui/lib/site/bookmarks/bookmarksManager");
var LegalPage = require('syracuse-ui/lib/site/legal/legalPage').LegalPage;
var DragDropManager = require("syracuse-ui/lib/site/tools/dragDropManager").DragDropManager;
var TopPanel = require("syracuse-ui/lib/site/tools/topPanel").TopPanel;
var spyer = require('syracuse-ui/lib/site/spy/spyer');

var _helpPopupSlot, _helpPopup;
exports.openHelpPopup = function(menuItem) {
	var site = document.site;
	if (!_helpPopupSlot) {
		_helpPopupSlot = document.createElement("div");
		_helpPopupSlot.className = "s-site-help-links-slot";
		var $links = site.$prototype.$helpLinks;
		for (var ii = 0, jj = $links.length; ii < jj; ii++) {
			site.loadNewItem(_helpPopupSlot, {
				$bind: $links[ii],
				$category: "link",
				$skin: "s-site-help-item-link"
			});
		}
	}
	if (!_helpPopup) {
		_helpPopup = site.dialogManager.openPopup(site, {
			content: site,
			slot: _helpPopupSlot,
			position: {
				my: "left top",
				at: "left bottom",
				of: $(menuItem.domItem)
			},
			onClose: function() {
				setTimeout(function() {
					_helpPopup = null;
				}, 200);
			}
		});
	} else {
		_helpPopup.close();
	}
};

exports.openLegalPage = function(menuItem) {
	document.controller.sendRequest(null, {
		method: "GET",
		$location: {
			$url: document.site.$item.$legalPrototypeUrl
		}
	}, function(data, response, $url) {
		var page = new LegalPage();
		page.loadBox(data);
		if (page.menuBar) {
			page.menuBar.toggleBar(false);
		}
		document.controller.sendRequest(null, {
			method: "GET",
			$location: {
				$url: document.site.$item.$legalDataUrl
			}
		}, function(data, response, $url) {
			page.applyChange(data);
			document.site.dialogManager.openModal(menuItem.page, {
				page: page
			});
		}, function(error) {
			var $diagnoses;
			if (error.data.indexOf("$diagnoses") != -1) {
				$diagnoses = JSON.parse(error.data).$diagnoses;
			} else {
				$diagnoses = [{
					$severity: "error",
					$message: error.data
				}];
			}
			document.site.showDiagnoses({
				$diagnoses: $diagnoses
			});
		});

	}, function(error) {
		var $diagnoses;
		if (error.data.indexOf("$diagnoses") != -1) {
			$diagnoses = JSON.parse(error.data).$diagnoses;
		} else {
			$diagnoses = [{
				$severity: "error",
				$message: error.data
			}];
		}
		document.site.showDiagnoses({
			$diagnoses: $diagnoses
		});
	});

};

exports.addBookmarkManager = function(site) {
	var bar = document.createElement("div");
	bar.id = "s-site-header-bottom-bookmarks";
	site.bookmarksManager = bookmarksManager;
	site.bookmarksManager.load(site.headerBottom.appendChild(bar));
};


exports.addDragDropManager = function(site) {
	(site.ddManager = new DragDropManager()).load();
};

exports.loadSpyer = function(site) {
	site.spyer = spyer;
};


var _topPanel;

exports.appendTopPanelOpener = function(layoutSlot) {
	var opener = document.createElement("a");
	opener.className = "s-site-top-pn-opener-link";
	opener.setAttribute("href", "#");
	opener.setAttribute("data-s-picker", "s-site-top-pn-opener-link");
	_topPanel = {
		opener: opener
	};
	layoutSlot.appendChild(opener);
};

exports.toggleTopPanel = function(show, event, onBeforClick) {
	if (_topPanel) {
		var site = document.site;
		var isVisible;
		if (show) {
			if (!_topPanel.panel) {
				_topPanel.container = document.createElement("div");
				_topPanel.container.className = "s-site-top-pn";
				_topPanel.container.style.display = "none";
				site.layoutSlot.appendChild(_topPanel.container);
				_topPanel.panel = new TopPanel();
				_topPanel.panel.$prototype = site.$prototype;
				_topPanel.panel.page = site;
				_topPanel.panel.layoutSlot = _topPanel.container;
				_topPanel.panel.loadBox();
			}
			if (_topPanel.container.style.display == "none") {
				isVisible = true;
				var rect = _topPanel.opener.getBoundingClientRect();
				if (document.dir === 'rtl') {
					_topPanel.container.style.left = rect.left + "px";
				} else {
					_topPanel.container.style.right = (site.getLayoutSize().right - rect.right) + "px";
				}
				if (_topPanel.panel.navigationBar) {
					_topPanel.panel.navigationBar.domItem.style.display = (site.fusionGateway && site.fusionGateway.activatedBook) ? "none" : "";
				}
			}
		} else {
			if (onBeforClick && event &&
				((event.target == _topPanel.opener) ||
					_topPanel.opener.contains(event.target))) {
				return;
			}
			if (_topPanel.panel) {
				var panel = _topPanel.panel;
				if (event) {
					var isNavigationLink = panel.navigationBar && panel.navigationBar.domItem.contains(event.target);
					if (!isNavigationLink && panel.domItem.contains(event.target)) {
						return;
					}
				}
			}
		}
		if (_topPanel.container) {
			_topPanel.container.style.display = isVisible ? "" : "none";
			var rect = _topPanel.panel.body.getBoundingClientRect();
			_topPanel.container.style.height = (rect.height + rect.top) + "px";
		}
		if (_topPanel.opener) {
			site.dom.toggleClass(_topPanel.opener, "s-open", isVisible);
		}
	}
};

exports.showUserIdentity = function(userProfile, newData) {
	if (_topPanel && _topPanel.opener && userProfile.dataset.user && !document.site.nameDiv) {
		// append user profile info (firstname, lastname and photo)
		// name info
		document.site.nameDiv = document.createElement("div");
		document.site.nameDiv.className = "s-site-user-name";
		document.site.nameDiv.textContent = (userProfile.dataset.user.firstName ? userProfile.dataset.user.firstName + " " : "") + (userProfile.dataset.user.lastName ? userProfile.dataset.user.lastName : "");

		_topPanel.opener.appendChild(document.site.nameDiv);

		// photo info
		var photoDiv = document.createElement("div");
		photoDiv.className = "s-site-user-photo";
		if (userProfile.dataset.user.photo) {
			userProfile.loadNewItem(photoDiv, {
				$css: "s-site-user-photo",
				$skin: "s-site-user-photo",
				$inplace: true,
				$imageWidth: " ",
				$imageHeight: " ",
				$bind: "photo",
				$category: "field",
				$field: {
					$type: "image",
					$url: document.site.expressionMaker.parse(userProfile, userProfile.dataset.user.photo.$url, {
						$uuid: userProfile.dataset.user.$uuid,
						$pluralType: "users",
						$key: userProfile.$prototype.$key,
						$baseUrl: userProfile.$prototype.$baseUrl
					})
				}
			});

			var newPhoto = helpers.object.clone(userProfile.dataset.user.photo);
			newPhoto.$url = document.site.expressionMaker.parse(userProfile, userProfile.dataset.user.photo.$url, {
				$pluralType: "users",
				$key: userProfile.dataset.user.$uuid,
				$baseUrl: userProfile.$prototype.$baseUrl
			});
			newData.photo = newPhoto;
		} else {
			var mn = document.createElement("a");
			mn.className = "s-site-user-nophoto";
			photoDiv.appendChild(mn);
		}
		_topPanel.opener.appendChild(photoDiv);
	}
};


exports.showPageSecurity = function(page) {
	if (document.site.$item.$isPageSecurityView !== false) {
		var dataset = document.site.userProfile && document.site.userProfile.dataset;
		if (dataset) {
			var role = dataset.selectedRole && dataset.selectedRole.description;
			var endpoint = dataset.selectedEndpoint && dataset.selectedEndpoint.description;
			var pages = page ? [page] : document.site.itemHelper.getLoadedPages();
			for (var ii = 0, jj = pages.length; ii < jj; ii++) {
				page = pages[ii];
				if (page.securityViewSlot) {
					document.site.dom.empty(page.securityViewSlot);
					if (role) {
						var item = document.createElement("div");
						item.className = "s-security-user-role";
						item.textContent = item.title = role;
						page.securityViewSlot.appendChild(item);
					}
					if (endpoint) {
						var item = document.createElement("div");
						item.className = "s-security-user-endpoint";
						item.textContent = item.title = endpoint;
						page.securityViewSlot.appendChild(item);
					}
				}
			}
		}
	}
};




exports.dispose = function(site) {
	if (site.bookmarksManager) {
		site.bookmarksManager.dipsose();
	}
	if (site.ddManager) {
		site.ddManager.dispose();
	}
	if (site.spyer) {
		site.spyer.dispose();
	}
	site.bookmarksManager = site.ddManager = site.spyer = null;
	_topPanel = helpPopupSlot = _helpPopup = null;
};