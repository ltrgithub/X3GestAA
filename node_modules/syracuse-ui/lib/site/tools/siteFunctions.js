"use strict";
var helpers = require('syracuse-core/lib/helpers');
var bookmarksManager = require("syracuse-ui/lib/site/bookmarks/bookmarksManager");
var LegalPage = require('syracuse-ui/lib/site/legal/legalPage').LegalPage;
var dragDropManager = require("syracuse-ui/lib/site/tools/dragDropManager");
var TopPanel = require("syracuse-ui/lib/site/tools/topPanel").TopPanel;
var spyer = require('syracuse-ui/lib/site/spy/spyer');

var _helpPopupSlot, _helpPopup;
exports.openHelpPopup = function(menuItem) {
	if (!_helpPopupSlot) {
		_helpPopupSlot = document.createElement("div");
		_helpPopupSlot.className = "s-site-help-links-slot";
		var $links = syra_site.$prototype.$helpLinks;
		for (var ii = 0, jj = $links.length; ii < jj; ii++) {
			syra_site.loadNewItem(_helpPopupSlot, {
				$bind: $links[ii],
				$category: "link",
				$skin: "s-site-help-item-link"
			});
		}
	}
	if (!_helpPopup) {
		_helpPopup = syra_site.dialogManager.openPopup(syra_site, {
			content: syra_site,
			slot: _helpPopupSlot,
			position: {
				my: "left top",
				at: "left bottom",
				of: $(menuItem.domItem)
			},
			onClose: function() {
				setTimeout(function() {
					_helpPopup = null;
				}, 200);
			}
		});
	} else {
		_helpPopup.close();
	}
};

exports.openLegalPage = function(menuItem) {
	syra_controller.sendRequest(null, {
		method: "GET",
		$location: {
			$url: syra_site.$item.$legalPrototypeUrl
		}
	}, function(data, response, $url) {
		var page = new LegalPage();
		page.loadBox(data);
		if (page.menuBar) {
			page.menuBar.toggleBar(false);
		}
		syra_controller.sendRequest(null, {
			method: "GET",
			$location: {
				$url: syra_site.$item.$legalDataUrl
			}
		}, function(data, response, $url) {
			page.applyChange(data);
			syra_site.dialogManager.openModal(menuItem.page, {
				page: page
			});
		}, function(error) {
			var $diagnoses;
			if (error.data.indexOf("$diagnoses") != -1) {
				$diagnoses = JSON.parse(error.data).$diagnoses;
			} else {
				$diagnoses = [{
					$severity: "error",
					$message: error.data
				}];
			}
			syra_site.showDiagnoses({
				$diagnoses: $diagnoses
			});
		});

	}, function(error) {
		var $diagnoses;
		if (error.data.indexOf("$diagnoses") != -1) {
			$diagnoses = JSON.parse(error.data).$diagnoses;
		} else {
			$diagnoses = [{
				$severity: "error",
				$message: error.data
			}];
		}
		syra_site.showDiagnoses({
			$diagnoses: $diagnoses
		});
	});

};

exports.addBookmarkManager = function() {
	var bar = document.createElement("div");
	bar.id = "s-site-header-bottom-bookmarks";
	syra_site.bookmarksManager = bookmarksManager;
	syra_site.bookmarksManager.load(syra_site.headerBottom.appendChild(bar));
};

exports.addJobsOpener = function(slot) {
	var picker = syra_site._jobsViewerOpener = document.createElement("a");
	picker.syraSiteObserver = "siteFunctions";
	picker.className = "s-jobs-viewer-opener";
	picker.syraOnClick = "onJobsOpenerClick";
	picker.setAttribute("href", "#");
	picker.style.display = "none";
	slot.appendChild(picker);
};
exports.onJobsOpenerClick = function() {
	syra_site.jobsPage && syra_site.jobsPage.toggle();
};

function _runJobsViewer() {
	syra_controller.sendRequest(null, {
		method: "GET",
		$location: {
			$url: "/sdata/$trackers"
		}
	}, function(data, response, $url) {
		if (data.$resources && data.$resources.length > 0) {
			for (var ii = 0, jj = data.$resources.length; ii < jj; ii++) {
				var resource = data.$resources[ii];
				var params = {
					$location: resource.location || resource.$location,
					$state: resource.phase,
					$title: resource.title || "(Title not retrieved)",
					uuid: resource.uuid,
					kind: "operation"
				};
				syra_site.registerJobSyra(params.$location, params.$state, params.$title, params.uuid);
			}
		}
	}, function(error, httpquery) {
		httpquery.showError(error);
	});
}

exports.addLogo = function(slot) {
	var logo = syra_site.headerLogo = document.createElement("a");
	logo.id = "s-site-header-logo";
	logo.syraSiteObserver = "siteFunctions";
	logo.syraOnClick = "onLogoClick";
	slot.appendChild(logo);
};
exports.onLogoClick = function() {
	syra_site.gotoHome();
};

exports.addLogoutButton = function() {
	var picker = document.createElement("a");
	picker.syraSiteObserver = "siteFunctions";
	picker.className = "s-site-logout";
	picker.syraOnClick = "onLogoutClick";
	picker.setAttribute("href", "#");
	picker.title = syra_local.siteLogoutLink;
	syra_site.headerTop.appendChild(picker);
};
exports.onLogoutClick = function() {
	syra_site.logout();
};
exports.addPageDesignerOpener = function() {
	var picker = syra_site.pageDesignerOpener = document.createElement("a");
	picker.syraSiteObserver = "siteFunctions";
	picker.className = "s-page-designer-opener";
	picker.syraOnClick = "onPageDesignerClick";
	picker.style.visibility = "hidden";
	picker.setAttribute("href", "#");
	picker.title = syra_local.userProfile_siteAuthoringOpen;
	syra_site.headerTop.appendChild(picker);
};
exports.onPageDesignerClick = function() {
	var page;
	exports.toggleTopPanel(false);
	if (syra_site.mainPage.isFusionPage) {
		page = syra_site.fusionGateway.activatedBook.selectedSheet;
	} else {
		page = syra_site.dialogManager.getTopDialogPage();
		if (page) {
			page = page._content;
		}
	}
	page = page || syra_site.mainPage;
	page && page.designArticle(true);
};

exports.addDragDropManager = function() {
	window.syra_dd = dragDropManager;
};

exports.loadSpyer = function() {
	syra_site.spyer = spyer;
};


var _topPanel;

exports.appendTopPanelOpener = function(layoutSlot) {
	var opener = document.createElement("a");
	opener.syraSiteObserver = "siteFunctions";
	opener.className = "s-site-top-pn-opener-link";
	opener.syraOnClick = "onTopPanelClick";
	opener.setAttribute("href", "#");
	_topPanel = {
		opener: opener
	};
	layoutSlot.appendChild(opener);
};
exports.onTopPanelClick = function() {
	exports.toggleTopPanel(true);
};
exports.toggleTopPanel = function(show, event, onBeforeClick) {
	if (_topPanel) {
		var isVisible;
		if (show) {
			if (!_topPanel.panel) {
				_topPanel.container = document.createElement("div");
				_topPanel.container.className = "s-site-top-pn";
				_topPanel.container.style.display = "none";
				syra_site.layoutSlot.appendChild(_topPanel.container);
				_topPanel.panel = new TopPanel();
				_topPanel.panel.$prototype = syra_site.$prototype;
				_topPanel.panel.page = syra_site;
				_topPanel.panel.layoutSlot = _topPanel.container;
				_topPanel.panel.loadBox();
			}
			if (_topPanel.container.style.display == "none") {
				isVisible = true;
				var rect = _topPanel.opener.getBoundingClientRect();
				if (document.dir === 'rtl') {
					_topPanel.container.style.left = rect.left + "px";
				} else {
					_topPanel.container.style.right = (syra_site.getLayoutSize().right - rect.right) + "px";
				}
				if (_topPanel.panel.navigationBar) {
					_topPanel.panel.navigationBar.domItem.style.display = (syra_site.fusionGateway && syra_site.fusionGateway.activatedBook) ? "none" : "";
				}
			}
		} else {
			if (onBeforeClick && event &&
				((event.target == _topPanel.opener) ||
					_topPanel.opener.contains(event.target))) {
				return;
			}
			if (_topPanel.panel) {
				var panel = _topPanel.panel;
				if (event) {
					var isNavigationLink = panel.navigationBar && panel.navigationBar.domItem.contains(event.target);
					if (!isNavigationLink && panel.domItem.contains(event.target)) {
						return;
					}
				}
			}
		}
		if (_topPanel.container) {
			_topPanel.container.style.display = isVisible ? "" : "none";
		}
		if (_topPanel.opener) {
			syra_site.dom.toggleClass(_topPanel.opener, "s-open", isVisible);
		}
	}
};

exports.showUserIdentity = function(userProfile) {
	if (_topPanel && _topPanel.opener && userProfile.dataset.user && !syra_site.nameDiv) {
		var nameDiv = syra_site.nameDiv = document.createElement("div");
		nameDiv.className = "s-site-user-name";
		nameDiv.textContent = (userProfile.dataset.user.firstName ? userProfile.dataset.user.firstName + " " : "") + (userProfile.dataset.user.lastName ? userProfile.dataset.user.lastName : "");
		_topPanel.opener.appendChild(nameDiv);

		var photoDiv = document.createElement("div");
		photoDiv.className = "s-site-user-photo";
		if (userProfile.dataset.user.photo) {
			userProfile.loadNewItem(photoDiv, {
				$css: "s-site-user-photo",
				$skin: "s-site-user-photo",
				$inplace: true,
				$imageWidth: " ",
				$imageHeight: " ",
				$bind: "photo",
				$category: "field",
				$field: {
					$type: "image"
				}
			}).setDataValue({
				$url: syra_site.expressionMaker.parse(userProfile, userProfile.dataset.user.photo.$url, {
					$uuid: userProfile.dataset.user.$uuid,
					$pluralType: "users",
					$key: userProfile.$prototype.$key,
					$baseUrl: userProfile.$prototype.$baseUrl
				})
			});
		} else {
			var mn = document.createElement("a");
			mn.className = "s-site-user-nophoto";
			photoDiv.appendChild(mn);
		}
		_topPanel.opener.appendChild(photoDiv);
	}
};

var _titleTip = {};

function _clearTitleTip(disposing) {
	_titleTip.timeOut && clearTimeout(_titleTip.timeOut);
	_titleTip.popup && _titleTip.popup.close();
	_titleTip.timeOut = _titleTip.popup = null;
	if (disposing) {
		_titleTip = null;
	}
}

exports.showTitleTip = function(text, target) {
	_clearTitleTip();
	if (text) {
		_titleTip.timeOut = setTimeout(function() {
			if (!_titleTip.textItem) {
				_titleTip.textItem = document.createElement("div");
				_titleTip.textItem.className = "s-title-tip";
			}
			_titleTip.textItem.textContent = text;
			_titleTip.popup = syra_site.dialogManager.openPopup(syra_site, {
				content: {},
				slot: _titleTip.textItem,
				position: {
					my: "left top",
					at: "left bottom+15",
					of: $(target)
				}
			});
		}, 500);
	}
};


exports.dispose = function() {
	_clearTitleTip(true);
	if (syra_site) {
		syra_site.bookmarksManager && syra_site.bookmarksManager.dispose();
		syra_site.jobsPage && syra_site.jobsPage.dispose();
		syra_site.spyer && syra_site.spyer.dispose();
		dragDropManager.dispose();
		syra_site.jobsPage = syra_site.bookmarksManager = window.syra_dd = syra_site.spyer = null;
		_topPanel = _helpPopupSlot = _helpPopup = null;
	}
};