"use strict";
var _helpers = require('syracuse-core').helpers;
var _externalAdapter = require("syracuse-ui/lib/utility/externalAdapter");
var _dragDrop = require("syracuse-ui/lib/site/aside/dragDrop");
var DesktopPage = require("syracuse-ui/lib/page/desktopPage").DesktopPage;
var _eventListener = require('syracuse-ui/lib/events/eventListener');
var _locale = require('streamline-locale');
var _fusion = require('syracuse-ui/lib/fusion/fusionGateway').gateway;
var UserProfile = require('./userProfile').UserProfile;

var _searcher = require('syracuse-ui/lib/search/searcher');
var jsurl = require('jsurl/lib/jsurl');
var SocketHandler = require('syracuse-ui/lib/notifications/socketHandler');
var _quality = require('syracuse-ui/lib/quality/qualityController');
var _ext = require('syracuse-ui/lib/extend/extendGateway');
var _log = require('syracuse-ui/lib/quality/log');
var _manager = {
	bookmarks: require("syracuse-ui/lib/bookmark/query"),
	config: require('syracuse-ui/lib/site/config'),
	nav: require('syracuse-ui/lib/page/navigation/navigator'),
	culture: require('syracuse-ui/lib/data/culture'),
	dataset: require('syracuse-ui/lib/data/dataset'),
	router: require('syracuse-ui/lib/controller/router'),
	help: require('syracuse-ui/lib/help/helpCenter'),
	item: require("syracuse-ui/lib/item/itemManager"),
	localizer: require('syracuse-ui/lib/localization/localizer'),
	locker: require('syracuse-ui/lib/utility/locker'),
	url: require('syracuse-ui/lib/controller/url'),
	tip: require('syracuse-ui/lib/over/tip'),
	button: require('syracuse-ui/lib/menus/button'),
	alert: require('syracuse-ui/lib/alert/manager'),
	shortCuts: require("syracuse-ui/lib/events/shortCutInvoker"),
	picker: require('syracuse-ui/lib/menus/picker'),
	fields: require('syracuse-ui/lib/field/helpers/fieldHelper'),
	menus: require('syracuse-ui/lib/menus/menusHelper'),
	pageBuilder: require("syracuse-ui/lib/page/pageBuilder"),
	trackers: require('syracuse-ui/lib/tracker/trackersManager'),
	form: require('syracuse-ui/lib/controller/form'),
	over: require('syracuse-ui/lib/over/manager'),
	layout: require("syracuse-ui/lib/item/layoutManager"),
	maximizer: require('syracuse-ui/lib/utility/maximizer'),
	expression: require('syracuse-ui/lib/utility/expression'),
	article: require("syracuse-ui/lib/item/article"),
	dom: require('syracuse-ui/lib/utility/dom'),
	icon: require("syracuse-ui/lib/utility/icon"),
	ajax: require('syracuse-ui/lib/controller/ajax'),
	preference: require('syracuse-ui/lib/controller/preference'),
	context: _ext.context = {}
};

var _styleSheetPath = "/syracuse-ui/themes/desktop/";
var _styleSheets = {};
var _themeStyleSheet;

function _unloadStyleSheet(name) {
	var link = _styleSheets[name];
	link && syra_site.documentHeader.removeChild(link);
	delete _styleSheets[name];
}

function _getBrowser() {
	var M = navigator.userAgent.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
	var browser = {
		name: (M ? M[1] : navigator.appName).toLowerCase()
	};
	var tem;
	if (M && (tem = navigator.userAgent.match(/version\/([\.\d]+)/i)) != null) {
		M[2] = tem[1];
	}
	browser.info = M ? [M[1], M[2]] : [navigator.appName, navigator.appVersion, '-?'];
	browser.version = browser.info[1];
	browser.isFireFox = browser.name == "firefox";
	browser.isSafari = browser.name == "safari";
	browser.isMSIE = browser.name == "msie";
	return browser;
}

exports.create = function() {
	var site = new Site();
	site.btns = {};
	window.syra_site = site;
	var keys = Object.keys(_manager);
	for (var ii = 0, jj = keys.length; ii < jj; ii++) {
		window["syra_" + keys[ii]] = _manager[keys[ii]];
	}
	//syra_over.no = true;
	syra_context.browser = _getBrowser();
	return site;
};

function Site() {

}

exports.Site = _helpers.defineClass(Site, DesktopPage, {
	clone: function(obj) {
		return _helpers.object.clone(obj, true);
	},
	loadStyleSheet: function(name, isExtended) {
		if (!isExtended) {
			name = _styleSheetPath + name;
		}
		if (!_styleSheets[name]) {
			var link = _styleSheets[name] = document.createElement("link");
			link.syraName = name;
			link.setAttribute("rel", "stylesheet");
			link.setAttribute("type", "text/css");
			link.setAttribute("href", name);
			if (_themeStyleSheet) {
				this.documentHeader.insertBefore(link, _themeStyleSheet);
			} else {
				this.documentHeader.appendChild(link);
			}
			return link;
		}
	},
	applyTheme: function(theme) {
		if (theme && theme.cssFiles) {
			var name = theme.cssFiles[0].path.toLowerCase();
			if (name.indexOf(".css") < 0) {
				name = "custom/" + name + ".css";
				if (_themeStyleSheet) {
					if (_themeStyleSheet.syraName == name) {
						return;
					}
					_unloadStyleSheet(_themeStyleSheet.syraName);
				}
				_themeStyleSheet = null;
				_themeStyleSheet = this.loadStyleSheet(name);
			}
		} else {
			_themeStyleSheet && _unloadStyleSheet(_themeStyleSheet.syraName);
			_themeStyleSheet = null;
		}
	},
	randomStr: function(m) {
		var m = m || 9,
			s = '',
			r = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		for (var i = 0; i < m; i++) {
			s += r.charAt(Math.floor(Math.random() * r.length));
		}
		return s;
	},
	logout: function(doPost) {
		if (!doPost && syra_fusion) {
			syra_fusion.onUserActionUnload(function() {
				syra_site.logout(true);
			}, null, "logout");
			return;
		}
		_manager.router.postQuery({
			menu: {
				$title: syra_local.siteLogout,
				$method: "POST",
				$url: "/logout",
				headers: {
					authorization: "basic"
				}
			},
			success: function($url, data) {
				syra_site.hasDoneLogOut = true;
				window.open($url, "_self");
			},
			error: function($diagnoses) {
				_manager.alert.error($diagnoses);
				if (!syra_site.mainPage || syra_site.mainPage.disposed) {
					_manager.menus.click.home();
				}
			}
		});
	},
	onMenuClick: function(options) {
		switch (options.menu.$bind) {
			case "site_sitemap":
				syra_nav.showSiteMap();
				break;
			case "site_help_designer":
			case "site_help_center":
				if (!options.menu.$documentationUrl) {
					options.menu.$documentationUrl = options.menu.$sourceUrl;
				}
				var edp = this.userProfile.getSelectedEndpoint();
				options.menu.$sourceUrl = options.menu.$documentationUrl + (edp ? ("&ep=" + edp.$uuid) : "");
				break;
			case "site_help":
				_manager.help.openPopup(options.menu);
				return false;
			case "site_help_legal":
				_manager.help.openLegalPage(options.menu);
				return false;
			default:
				if (options.menu.$bind && options.menu.$bind.split("-")[0] === "bookmark") {
					_manager.bookmarks.onLinkClick(options.menu);
					return false;
				}
				break;
		}
		return true;
	},
	dispose: function() {
		_eventListener.dispose();
		syra_fusion && syra_fusion.dispose();
		_manager.bookmarks.dispose();
		_manager.trackers.dispose();
		_manager.locker.dispose();
		_manager.help.dispose();
		DesktopPage.prototype.dispose.call(this);
		_dragDrop.dispose();
		_manager.alert.dispose();
		_manager.over.dispose();
		_manager.item.dispose();
		var keys = Object.keys(window);
		for (var ii = 0, jj = keys.length; ii < jj; ii++) {
			var key = keys[ii];
			if (key.indexOf("syra_") >= 0) {
				delete window[key];
			}
		}
		this.disposeObject(_ext.context);
		_themeStyleSheet = _styleSheets = null;
	},
	_focusBox: function(box, hasFocus) {
		if (box) {
			var target = box.layoutSlot || box.body;
			if (!target && box.domItem) {
				target = box.domItem;
			}
			if (target) {
				if (box != box.page) {
					_manager.dom.toggleClass(target, "s-selected-box", hasFocus);
				}
			}
		}
	},

	logon: function(onAfterLogon) {
		var self = this;
		var prevdataset;
		if (self.userProfile) {
			prevdataset = self.userProfile.buildWCContent();
			self.userProfile.dispose(self.userProfile);
			self.userProfile = null;
		}
		self.userProfile = new UserProfile();
		self.userProfile.dataset = {}; //important
		self.userProfile.isSiteRegisterDisabled = true;
		_manager.pageBuilder.initialize(self.userProfile);
		self.userProfile.onLogonProcessing = true;

		var $userProfileUrl = self.userProfile.getLogonUrl();

		if (!prevdataset) {
			var urlSeg = _manager.url.history.getUrlSegment();
			var $userProfileSeg = _manager.url.history.getUrlSegment($userProfileUrl);
			var profile = urlSeg.params && urlSeg.params.profile;
			var selectedEndpoint, selectedRole;
			if (profile) {
				if (profile == "{$userprofile}") {
					delete urlSeg.params.profile;
					window.history.replaceState(null, null, _manager.url.build(urlSeg));
				} else {
					profile = jsurl.parse(profile);
					selectedEndpoint = "\'" + profile.ep + "\'";
					selectedRole = "\'" + profile.role + "\'";
				}
			}
			if (!selectedEndpoint) {
				if (!urlSeg.hasNoEndpoint) {
					if (urlSeg.endpointSeg.application != "syracuse" && ["collaboration", "search"].indexOf(urlSeg.endpointSeg.contract) < 0) {
						if (urlSeg.endpointSeg.dataset != $userProfileSeg.dataset) {
							selectedEndpoint = "dataset eq \'" + urlSeg.endpointSeg.dataset + "\'";
						}
					}
				}
			}
			if (selectedEndpoint || selectedRole) {
				var $baseUrl = _manager.url.getBaseUrl($userProfileSeg);
				prevdataset = {
					$etag: 0
				};
				if (selectedRole) {
					prevdataset.selectedRole = {
						$url: $baseUrl + "/roles(" + selectedRole + ")"
					};
				}
				if (selectedEndpoint) {
					prevdataset.selectedEndpoint = {
						$url: $baseUrl + "/endPoints(" + selectedEndpoint + ")"
					};
				}
			}
		}
		_manager.form.load({
			isLogon: true,
			menu: {
				$url: $userProfileUrl,
				sendData: prevdataset
			},
			article: self.userProfile,
			success: function() {
				if (!self.hasLogonFailed) {
					self.userProfile.onLogonSucees();
					syra_log.enable(syra_context.enableUILog);
					_locale.setCurrent(function(err) {
						window.syra_local = _locale.resources(module)();
						self.dataset.language = self.dataset.helpLanguage = _manager.localizer.getLanguage() || "";
						self.$menus.site_sitemap.$title = self.$menus.$navigation.$title = syra_local.site_btn_sitemap;
						self.$menus.$home.$title = syra_local.site_btn_home;
						self.$menus.site_help.$title = syra_local.site_btn_help;
						self.$menus.site_help_designer.$title = syra_local.site_btn_help_designer;
						self.$menus.site_help_center.$title = syra_local.site_btn_help_center;
						self.$menus.site_help_shortcuts.$title = syra_local.site_btn_help_shortcuts;
						self.$menus.site_help_legal.$title = syra_local.site_btn_help_legal;

						self._renderHeader();
						self.userProfile.showIdentity();
						syra_quality.onAfterLogon(onAfterLogon);
						delete self.userProfile.onLogonProcessing;
					}, self.userProfile.currentLangCode, self.userProfile.dataset.selectedLocale);
				}
			}
		});

	},
	getSessIdCookieName: function() {
		return "syracuse.sid." + window.location.port;
	},
	getSessionId: function() {
		return _helpers.http.parseCookie(document.cookie)["syracuse.sid." + window.location.port] || "";
	},
	unload: function() {
		this.dispose();
	},
	toggleMainPage: function(page, show) {
		_manager.over.activateAll(page, show);
		if (show && page.domItem && page.displayed !== true) {
			page.displayed = show;
			this.refreshBrowserTitle(this.mainPage = page);
			(page.layoutSlot = this.body).appendChild(page.domItem);
			page.resizeItem();
		} else {
			if (!show && page.displayed !== false) {
				page.displayed = show;
				_manager.dom.remove(page.domItem);
			}
		}
	},
	resetMainPage: function() {
		this.userProfile.toggle(false);
		var prev = this.mainPage;
		if (prev && prev.externalAdapter) {
			prev.externalAdapter.releaseMainPage({
				mainPage: prev,
				doEvent: function() {
					prev.dispose && prev.dispose();
				}
			});
		}
		_manager.dom.empty(this.body);
		this.alertPanel && this.alertPanel.clean();
	},
	onMainPageChange: function($itemPage, onLoaded) {
		this.mainPage && _manager.url.history.queryPageSession.save(this.mainPage);
		_manager.dom.hide(this.body, true);
		$itemPage.boxParent = null;
		$itemPage.layoutSlot = this.body;
		this.resetMainPage();
		$itemPage.onMainPagechange = true;
		_manager.pageBuilder.load({
			$itemPage: $itemPage,
			success: function(page) {
				syra_site.mainPage = page;
				page.urlSeg = $itemPage.urlSeg;
				page.isMainPage = true;
				syra_site.refreshBrowserTitle(page);
				syra_site.lastOpenedMainPageUrlSegments = page.urlSeg;
				_manager.url.history.addBackButton(page);
				_manager.form.showLastSavingDiagnoses(page);
				onLoaded && onLoaded(page);
			}
		});
	},
	addDragDrop: function() {
		window.syra_dd = _dragDrop;
	},
	roundDecimal: function(num, precision) {
		precision = precision || 2;
		var tmp = Math.pow(10, precision);
		return Math.round(num * tmp) / tmp;
	},
	drawPage: function() {
		var self = this;
		self.addDragDrop();
		self.domItem = self.body = document.createElement("div");
		self.body.id = "s-site-body";
		self.body.setAttribute("tabindex", "1"); // add for receive keyboard event  for shortcut
		self.layoutSlot.appendChild(self.body);
		self.footer = document.createElement("footer");
		self.footer.className = "s-footer";
		self.layoutSlot.appendChild(self.footer);
		self.logon(function() {
			self._onAfterLogon();
		});
	},
	_onAfterLogon: function() {
		_manager.dom.hide(this.layoutSlot, false);
		this.resizeItem();
		_manager.url.history.start();
	},
	registerScreenDesigner: function(add, designer) {
		if (add) {
			if (!this.screenDesigners) {
				this.screenDesigners = [];
			} else {
				var top = this.screenDesigners && this.screenDesigners.length && this.screenDesigners[this.screenDesigners.length - 1];
				if (top) {
					top.onTopScreenDesigner(false);
				}
			}
			_manager.dom.hide(this.header, true);
			this.screenDesigners.push(designer);
		} else {
			if (this.screenDesigners) {
				var index = this.screenDesigners.indexOf(designer);
				if (index >= 0) {
					this.screenDesigners.splice(index, 1);
				}
				if (this.screenDesigners.length == 0) {
					delete this.screenDesigners;
					_manager.dom.hide(this.header, false);
				} else {
					var top = this.screenDesigners && this.screenDesigners.length && this.screenDesigners[this.screenDesigners.length - 1];
					if (top) {
						top.onTopScreenDesigner(true);
					}
				}
			}
		}
	},
	closePopups: function(box, event) {
		event && syra_dd.stop();
		_manager.over.closePopups(box, event);
	},

	setProductName: function(name) {
		if (this.productName != name) {
			this.productName = name;
			this.productNameBtn && this.productNameBtn.setProductName(name);
		}
	},
	getSize: function() {
		if (this.layoutSlot && this.size == undefined) {
			this.size = {
				isSmall: window.innerWidth < 900 || (window.innerHeight > window.innerWidth),
				minWidth: syra_config.size.minWidth,
				height: this.layoutSlot.clientHeight,
				width: this.layoutSlot.clientWidth
			};
			this.size.overPanel = {
				maxHeight: Math.max(this.size.height - 50, 100),
				maxWidth: Math.max(Math.round(this.size.width * 0.9), 100),
				minWidth: Math.round(this.size.width * 0.75)
			};
			if (this.body) {
				this.size.body = {
					top: this.body.offsetTop
				};
				var height = this.size.height;
				if (this.header) {
					height -= this.header.clientHeight;
				}
				if (this.footer) {
					height -= this.footer.clientHeight;
				}
				this.body.style.height = height + "px";
				this.size.body.height = this.body.clientHeight;
				this.size.body.width = this.body.clientWidth;
				this.size.popupMaxHeight = Math.round(this.size.body.height * 0.65);
			}
		}
		return this.size;
	},
	resizeItem: function() {
		this.isResizing = true;
		delete this.size;
		this.getSize();
		_manager.pageBuilder.resize();
		syra_nav.resize();
		syra_bookmarks.resize();
		syra_locker.ensureLock();
		this.isResizing = false;
	},
	refreshMainPageSecurity: function(page) {
		if (this.btns.authoring && page.mainPageDesignerAccess != "unknow") {
			syra_button.disable(this.btns.authoring, page.mainPageDesignerAccess == "disabled" || !this.userProfile.hasDesignRight());
		}
	},
	_renderHeader: function() {
		this.header = document.createElement("header");
		this.header.id = "s-header";
		this.header.style.minWidth = syra_config.size.minWidth + "px";
		this.layoutSlot.insertBefore(this.header, this.layoutSlot.firstChild);

		this.headerBar = syra_dom.div("s-header-bar");

		(this.productNameBtn = this.addItem(this.headerBar, {
			$bind: "$home",
			$noText: true,
			$category: "link",
			$skin: "s-header-logo"
		})).setProductName = function(name) {
			this.domItem.className = this.$skin = "s-header-logo" + (name ? (" s-logo-" + name.trim().toLowerCase()) : "");
		};
		this.productName && this.productNameBtn.setProductName(this.productName);

		if (!this.isOfficeSite) {
			this.btns.tracker = _manager.button.add({
				parent: this,
				slot: this.headerBar,
				text: "",
				css: "s-header-link s-header-tracker",
				isHidden: true,
				iconOnly: true,
				click: function() {
					_manager.trackers.toggle();
				}
			});
		}


		this.userProfile.addOpener();

		if (!this.isOfficeSite) {
			this.btns.home = this.addItem(this.headerBar, {
				$bind: "$home",
				$noText: true,
				$category: "link",
				$skin: "s-header-link s-header-home",
				$shortCutTip: _manager.shortCuts.tip.goToDefaultHome
			});

			this.btns.bookmark = _manager.button.add({
				parent: this,
				slot: this.headerBar,
				iconOnly: true,
				text: syra_local.site_btn_bookmark,
				css: "s-header-link s-header-bookmark",
				click: function() {
					_manager.bookmarks.open(this);
				}
			});

			this.btns.authoring = _manager.button.add({
				parent: this,
				slot: this.headerBar,
				text: syra_local.site_btn_authoring,
				css: "s-header-link s-header-authoring",
				iconOnly: true,
				isDisabled: true,
				checkWorkingCopy: true,
				click: function() {
					var page;
					var site = this.parent;
					site.userProfile.toggle(false);
					if (site.mainPage && site.mainPage.isFusionPage) {
						page = syra_fusion.activatedBook.selectedSheet;
					} else {
						var over = _manager.over.getMostOverPage();
						page = over && over.page;
					}
					page = page || site.mainPage;
					page && site.switchItemDesigner(page, true);
				}
			});

			this.btns.help = this.addItem(this.headerBar, {
				$bind: "site_help",
				$noText: true,
				$category: "link",
				$skin: "s-header-link s-header-help"
			});

			this.btns.search = _manager.button.add({
				parent: this,
				slot: this.headerBar,
				text: syra_local.site_btn_search,
				css: "s-header-link s-header-search",
				iconOnly: true,
				click: function() {
					this.parent.searcher.toggle(true);
				}
			});
			this.searcher = _searcher.load();
		}
		this.header.appendChild(this.headerBar);
		if (!this.isOfficeSite) {
			syra_nav.fetch();
		}
		this.btns.legal = syra_site.addItem(this.footer, {
			$bind: "site_help_legal",
			$category: "link",
			$skin: "s-footer-link"
		}, this);
		this.btns.navigation = this.addItem(this.footer, {
			$bind: "$navigation",
			$category: "link",
			$skin: "s-footer-link",
			$shortCutTip: _manager.shortCuts.tip.goToNavigationPage
		});
		this.btns.site_sitemap = this.addItem(this.footer, {
			$bind: "site_sitemap",
			$category: "link",
			$skin: "s-footer-link",
			$shortCutTip: _manager.shortCuts.tip.goToNavigationPage
		});

		syra_ajax.survey.addFlag(this.footer);
		if (this.$isLicenceTool) {
			_manager.dom.hide(this.searcher && this.searcher.domItem, true);
			this.btns.navigation.setMenu({
				$isHidden: true
			});
		}
	},
	isLandscape: function() {
		return window.orientation && (window.orientation == 90 || window.orientation == -90);
	},
	switchItemDesigner: function(item, open) {
		if (item.switchDesigner) {
			if (open && !this._isCssLoaded) {
				this._isCssLoaded = true;
				this.loadStyleSheet("authoring.css");
			}
			item.switchDesigner(open);
		}
	},


	load: function() {
		_log.load();
		syra_culture.format.initialize();

		this.isAutoInsertFieldDisabled = true;
		this.documentHeader = document.getElementsByTagName("head")[0];
		syra_context.isRTL = document.dir === 'rtl';
		this.isSiteRegisterDisabled = true;

		if (!this.$isSocketIODisabled) {
			this.socketHandler = SocketHandler.create();
			//session event
			this.socketHandler.register("/session");
		}
		// send ip address to allow the server to detect drop failed session
		window.syra_local = _locale.resources(module)();

		window.syra_quality = _quality.create();

		this.$device = this.$device || "desktop";
		if (this.isTabletDevice = document.location.pathname.indexOf("-tablet.html") >= 0) {
			this.$device = "tablet";
			this.$sitePreferences = {
				convergenceBar: {
					$isFloating: true,
					$isCollapsed: true
				},
				menuBar: {
					$isCollapsed: !this.isLandscape
				}
			};
		}
		this.$prototype = this.$prototype || {};
		this.$prototype.$properties = this.$prototype.$properties || {};
		this.$item = this.$item || {};
		var $links = this.$prototype.$links = this.$prototype.$links || {};

		$links.site_sitemap = {
			$url: ""
		};

		$links.$navigation = {
			$url: syra_config.$sitemapUrl,
			$target: "modal"
		};
		$links.$home = $links.$home || {
			$url: syra_config.$homeUrl
		};
		$links.site_help = {
			$url: "",
			$type: "text/html",
			$target: "help"
		};
		$links.site_help_designer = {
			$url: syra_config.$help_designer,
			$type: "text/html",
			$target: "help"
		};
		$links.site_help_center = {
			$url: syra_config.$help_center,
			$type: "text/html",
			$target: "help"
		};
		$links.site_help_shortcuts = {
			$url: syra_config.$help_shortcuts,
			$type: "text/html",
			$target: "help"
		};
		$links.site_help_legal = {
			$url: ""
		};
		$links.$support = {
			$url: syra_config.$support
		};

		if (this.$device == "mobile") {
			syra_config.$pageTemplateUrl = "/sdata/syracuse/collaboration/syracuse/pages('{endpoint}.{representation},{target},{pageview},phone')?role={$role}&profile={$userprofile}";
			syra_config.$userProfileUrl += "&device=phone";
		}

		this._childPageOffset = 1;
		_manager.pageBuilder.initialize(this);

		window.syra_fusion = !this.isOfficeSite ? _fusion : null;

		this.externalAdapter = _externalAdapter;

		this.layoutSlot = document.getElementById("s-site");
		_manager.dom.hide(this.layoutSlot, true);

		_eventListener.load();

		_manager.item.initialize(this, this, this.$item);
		DesktopPage.prototype.load.call(this);
		return this;
	},

	refreshBrowserTitle: function(page) {
		if (page == this.mainPage) {
			var title = page.getTitle();
			if (title) {
				if (this.$isSecurityTitleVisible !== false) {
					var role = syra_site.userProfile.getSelectedRole();
					var endpoint = syra_site.userProfile.getSelectedEndpoint();
					if (!this.tabBrowserTitles) {
						this.tabBrowserTitles = {
							$edit: syra_local.tab_browser_facet_edit,
							$details: syra_local.tab_browser_facet_details,
						};
					}
					var facet = this.tabBrowserTitles[page.$facet];
					if (facet) {
						title += " - " + facet + " ";
					}
					if (role) {
						title += " (" + role.description + ")";
					}
					if (endpoint) {
						title += " (" + endpoint.description + ")";
					}
				}
				document.title = title;
			}
		}
	},
	onItemInOut: function(onEnter, event, target) {

	},
	disposeObject: function(obj) {
		if (obj) {
			_manager.item.unregister(obj);
			if (obj.buttons && obj.buttons.length) {
				for (var ii = 0, jj = obj.buttons.length; ii < jj; ii++) {
					_manager.button.dispose(obj.buttons[ii]);
				}
				delete obj.buttons;
			}
			var keys = Object.keys(obj);
			for (var ii = 0, jj = keys.length; ii < jj; ii++) {
				obj[keys[ii]] = null;
			}
			obj.disposed = true;
		}
	}
});