"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Dialog = require('./dialog').Dialog;
var MessageBox = require('./messageBox').MessageBox;
var SiteTopPanel = require("./aside/siteTopPanel").SiteTopPanel;
var ExternalAdapter = require("./aside/externalAdapter").ExternalAdapter;
var DragDrop = require("./aside/dragDrop").DragDrop;
var AuthorPage = require("./authoring/authorPage").AuthorPage;
var DiagnosesPanel = require('./diagnosesPanel').DiagnosesPanel;
var Article = require("syracuse-ui/lib/article/article").Article;
var itemFactory = require('./itemFactory');
var Controller = require('syracuse-ui/lib/controller/controller').Controller;
var searchRequest = require('./search/searchRequest');
var EventListener = require('./aside/eventListener').EventListener;
var SpyGateway = require('./aside/spyGateway').SpyGateway;
var _fieldWidths = {
    "application/x-icon": {
        $width: 50
    },
    "application/x-choice": {
        $width: 100,
        $minWidth: 50
    },
    "application/x-date": {
        $width: 100
    },
    "application/x-time": {
        $width: 80,
        $minWidth: 80
    },
    "application/x-datetime": {
        $width: 170,
        $minWidth: 170
    },
    "application/x-boolean": {
        $width: 50,
        $minWidth: 50
    },
    "application/x-integer": {
        $width: 100,
        $minWidth: 50
    },
    "application/x-decimal": {
        $width: 100,
        $minWidth: 50
    },
    "application/x-real": {
        $width: 100,
        $minWidth: 50
    },
    "application/x-password": {
        $charWidth: 10,
        $maxLength: 10
    },
    "application/x-string": {
        $charWidth: 10,
        $maxLength: 10
    },
    "application/x-string$phone": {
        $charWidth: 10,
        $maxLength: 14,
        $minLength: 5
    },
    "application/x-string$email": {
        $charWidth: 10,
        $maxLength: 20,
    },
    "application/x-reference": {
        $charWidth: 10,
        $maxLength: 20,
        $minLength: 5
    },
    "image": {
        $width: 40,
        $minWidth: 40
    },
    $default: {
        $width: 100,
        $minWidth: 50
    }
};
function Site(){
}

exports.Site = helpers.defineClass(Site, Article, {
    dispose: function(){
        if (this.spyGateway) {
            this.spyGateway.dispose();
            delete this.spyGateway;
        }
        if (this.$$spy) {
            this.$$spy.unbind();
            delete this.spy;
        }
        delete this.lastFocusField;
        $(window).unbind();
        if (this.$$topPanelOpener) {
            this.$$topPanelOpener.unbind();
        }
        Article.prototype.dispose.call(this);
    },
    
    ensurePreferences: function(){
        return (this._preferences = this._preferences || {});
    },
    addResizeListener: function(listener){
        this.resizeListeners[listener.id] = listener;
    },
    removeResizeListener: function(listener){
        if (this.resizeListeners) {
            delete this.resizeListeners[listener.id];
        }
        
    },
    onBeforClick: function(){
        delete this.requestedDDAuthoringItem;
        if (this.DDAuthoring) {
            this.DDAuthoring.stop();
            delete this.DDAuthoring;
        }
    },
    getPage: function(){
        //hack ensure external adpater 
        return this;
    },
    maximizeBox: function(box, callback){
        setTimeout(function(){
            if (!box.$$memBody) {
                box.$$memBody = $("<div/>");
            }
            var page = box.getArticle().getPage();
            box.$$memBody.empty().append(page.$$body.children());
            page.$$body.append(box.$$item);
            if (callback) {
                callback(box, page);
            }
        }, 20);
        box.$isMaximized = true;
        box.maximizeBtn.className = box.maximizeBtn.className.replace("-maximize", "-minimize");
    },
    minimizeBox: function(box, callback){
        setTimeout(function(){
            var page = box.getArticle().getPage();
            box.$$item.appendTo(box.$$container);
            page.$$body.append(box.$$memBody.children());
            box.$$memBody.remove();
            delete box.$$memBody;
            if (callback) {
                callback(box, page);
            }
        }, 20);
        box.$isMaximized = false;
        box.maximizeBtn.className = box.maximizeBtn.className.replace("-minimize", "-maximize");
        
    },
    formatHTMLMessage: function(message){
        return message.replace(/\n/g, "<BR/>");
    },
    showDiagnoses: function(message, item, options){
        var page;
        if (item) {
            var article = item.getArticle();
            page = (article ? article.getPage() : null) || this.mainPage;
        }
        if (this._diagnosesPanel) {
            this._diagnosesPanel.showDiagnoses(message, page, options);
        }
    },
    appendDiagnosesPanel: function($$container, host, isTest){
        var diagnosesPanel = new DiagnosesPanel();
        diagnosesPanel.appenToPage(host, $$container);
        if (!isTest) {
            host._diagnosesPanel = diagnosesPanel;
        }
        return diagnosesPanel;
        
    },
    logon: function(onAfterLogon){
        var self = this;
        if (self.userProfile) {
            document.controller.disposeObject(self.userProfile);
            self.userProfile = null;
        }
        document.controller.loadWorkingCopy({
            menu: {
                $url: self.$item.$userProfileUrl
            },
            article: self.userProfile = new (self.siteOptions.userProfileClass)(),
            callback: function(){
                self.developpementMode = (self.userProfile.dataset && self.userProfile.dataset.developpementMode);
                onAfterLogon();
            }
        });
    },
    getSessionId: function(){
        return helpers.http.parseCookie(document.cookie)["syracuse.sid"] || "";
    },
    showMessage: function(options){
        if (this._msgBox) {
            document.controller.disposeObject(this._msgBox);
        }
        options.$type = options.$type || "alert";
        (this._msgBox = new MessageBox).open(options);
    },
    _releaseMainPage: function(){
        var prev = this.mainPage;
        if (prev && prev.externalAdapter) {
            prev.externalAdapter.releaseMainPage({
                mainPage: prev,
                doEvent: function(){
                    setTimeout(function(){
                        document.controller.disposeObject(prev);
                    }, 10);
                }
            });
        }
        this.$$body.empty();
    },
    unload: function(){
        $(document).unbind();
        delete this.resizeListeners;
        document.controller.disposeObject(this._eventListener);
        document.controller.disposeObject(this);
        document.controller.disposeObject(document.controller);
        document.site = document.controller = null;
    },
    
    
    setZIndex: function(item){
        item.style.zIndex = this._zIndex++;
    },
    toggleClass: function(dom, css, show){
        if (show) {
            if (dom.className.indexOf(css) < 0) {
                dom.className += (" " + css);
            }
        }
        else {
            dom.className = dom.className.replace(css, "");
        }
    },
    emptyDom: function(domNode){
        while (domNode.firstChild) {
            domNode.removeChild(domNode.firstChild);
        }
    },
    removeDomChild: function(child){
        if (child && child.parentNode) {
            child.parentNode.removeChild(child);
        }
    },
    disableItem: function(item, isDisabled){
        if (isDisabled) {
            item.setAttribute("disabled", isDisabled);
        }
        else {
            item.removeAttribute("disabled");
        }
        this.toggleClass(item, "s-disabled", isDisabled);
    },
    
    openHomeLink: function(){
        var self = this;
        setTimeout(function(){
            var homeLinks = self.menuItems.$home;
            if (homeLinks && homeLinks[0]) {
                homeLinks[0].click();
            }
        }, 20);
    },
    getFieldWidth: function($field, $isEditMode){
        return this._fieldWidths[($field.$type || "$default") + ($field.$format || "")] || this._fieldWidths.$default;
    },
    setFieldWidth: function(field){
        var $width = this.getFieldWidth(field.$field, field.$isEditMode);
        var widthValue = $width.$width;
        if ($width.$charWidth) {
            widthValue = ($width.$charWidth * (field.$field.$maxLength || $width.$maxLength));
            if ($width.$minLength) {
                field.domValueSlot.style.minWidth = ($width.$charWidth * $width.$minLength) + +"px";
            }
        }
        field.domValueSlot.style.maxWidth = widthValue + "px";
        if (field.layoutParent && widthValue > field.layoutParent.fieldMaxWidth) {
            field.layoutParent.fieldMaxWidth = widthValue;
        }
    },
    setDraggable: function(source, $$hotspot){
        (new DragDrop()).setDraggable(source, $$hotspot);
    },
    onFieldFocusIn: function(field){
        this.lastFocusField = field;
    },
    notifyRequestSurvey: function(pendingRequests){
        if (!this.requestSurvey) {
            this.requestSurvey = document.createElement("div");
            this.requestSurvey.setAttribute("id", "s-site-request");
            this.setZIndex(this.requestSurvey);
            
            this.$$container[0].appendChild(this.requestSurvey);
            this.requestSurveyCount = document.createElement("label");
            this.requestSurveyCount.setAttribute("id", "s-site-request-count");
            this.requestSurvey.appendChild(this.requestSurveyCount);
        }
        pendingRequests = pendingRequests || 0;
        this.requestSurveyCount.textContent = pendingRequests;
        if (pendingRequests > 0) {
            if (this.requestSurvey.style.right != "0px") {
                this.requestSurvey.style.right = "0px";
            }
        }
        else {
            this.requestSurvey.style.right = "-80px";
        }
    },
    onMainPageChange: function($itemPage){
        this.$$body[0].style.display = "none";
        $itemPage.boxParent = null;
        $itemPage.$$container = this.$$body;
        this._releaseMainPage();
        if (this._diagnosesPanel) {
            this._diagnosesPanel._emptyViewer();
        }
        this.closeTopPanel();
        
        this.mainPage = document.itemFactory.loadPage($itemPage);
        this.mainPage.openerHttpQuery = $itemPage.httpQuery;
        this.mainPage.isMainPage = true;
        this.updateDocumentTitle();
        this.$$body[0].style.display = "";
        this.resize();
        document.site.spyGateway.setSpyedPage(this.mainPage);
        return this.mainPage;
    },
    drawBox: function(){
        var self = this;
        
        self._renderHeader();
        self.$$item = self.$$body = $("<div id='s-site-body'/>").appendTo(self.$$container);
        
        document.site.logon(function(){
            document.controller.startNavigation();
            self.$$container.show();
            self.resize();
        });
    },
    updateDocumentTitle: function(){
        var title = this.mainPage.getTitle();
        if (title) {
            var record = this.userProfile.dataset;
            if (record) {
                if (record.selectedRole) {
                    title += " (" + record.selectedRole.description + ")";
                }
                if (record.selectedEndpoint) {
                    title += " (" + record.selectedEndpoint.description + ")";
                }
            }
            else {
                this.userProfile.$isTitleUpdateRequested = true;
            }
            this.mainPage.drawUserProfile(record);
            document.title = title;
        }
    },
    toggleAuthoring: function(open){
        if (open) {
            this.closeTopPanel();
            this._header.style.display = "none";
            this.authorPage = new AuthorPage();
            this.authorPage.$$container = $(document.getElementById("s-site-author")).empty().show();
            this.authorPage.open();
        }
        else {
            this._header.style.display = "";
            this.authorPage.$$container.hide().empty();
            document.controller.disposeObject(this.authorPage);
            delete this.authorPage;
            this.resize();
        }
    },
    openDialog: function(options){
        var dialog = new Dialog();
        dialog.open(options);
        return dialog;
    },
    resize: function(){
        var self = this;
        if (self._header && self.$$body) {
            var $$header = (self.authorPage) ? self.authorPage.$$container : self._$$header;
            var newHeight = $$header.outerHeight(true);
            self.$$body[0].style.height = (self.$$container.height() - newHeight) + "px";
        }
        if (self.resizeListeners) {
            Object.keys(self.resizeListeners).forEach(function(id){
                self.resizeListeners[id].onWindowResize();
            });
        }
    },
    closeTopPanel: function(){
        if (this.topPanel) {
            this.$$topPanelOpener.click(); //Close
        }
    },
    _appendTopPanelOpener: function($$container, topPanelClass){
        var self = this;
        self.$$topPanelOpener = $("<a id='s-site-top-pn-opener-link'/>").attr("href", "#").bind("click", function(event){
            if (!self.topPanel) {
                self.topPanel = new (topPanelClass || SiteTopPanel)();
                self.topPanel.$prototype = self.$prototype;
                self.topPanel.$$container = $(document.getElementById("s-site-top-pn")).empty().show();
                self.topPanel.loadBox();
            }
            else {
                self.topPanel.closePanel();
                delete self.topPanel;
            }
            self.$$topPanelOpener.toggleClass("s-open", self.topPanel != null);
            return false;
        }).appendTo($$container);
    },
    openSpy: function(){
        this.spyGateway.open();
    },
    appendSpy: function(div){
        var self = this;
        //var div = document.createElement("div");
        //div.setAttribute("id", "s-site-spy");
        (self.$$spy = $(div)).bind("click", function(event){
            if (event.ctrlKey) {
                self.openSpy();
            }
            return false;
        });
    },
    _renderHeader: function(){
        this._$$header = $(this._header = document.createElement("header"));
        this._header.setAttribute("id", "s-site-header");
        this.setZIndex(this._header);
        
        var topLeft = document.createElement("div");
        topLeft.setAttribute("id", "s-site-header-top-left");
        this._header.appendChild(topLeft);
        
        var div = document.createElement("div");
        div.setAttribute("id", "s-site-sage");
        topLeft.appendChild(div);
        
        div = document.createElement("div");
        div.setAttribute("id", "s-site-module");
        div.textContent = this.$item.$module;
        topLeft.appendChild(div);
        //if (document.site.developpementMode) {
        //debugger;
        this.appendSpy(div);
        //   }
        div = document.createElement("div");
        div.setAttribute("id", "s-site-favorites");
        
        var link = document.createElement("a");
        link.setAttribute("id", "s-site-favorites-link");
        link.setAttribute("href", "#");
        div.appendChild(link);
        topLeft.appendChild(div);
        
        var topRight = document.createElement("div");
        topRight.setAttribute("id", "s-site-header-top-right");
        this._header.appendChild(topRight);
        
        searchRequest.loadRequest($(topRight));
        
        div = document.createElement("div");
        div.setAttribute("id", "s-site-home");
        document.itemFactory.load($(topRight.appendChild(div)), {
            $bind: "$home",
            $category: "link",
            $noText: true,
            $skin: "s-site-home-link"
        }, this);
        
        div = document.createElement("div");
        div.setAttribute("id", "s-site-help");
        document.itemFactory.load($(topRight.appendChild(div)), {
            $bind: "$help",
            $category: "link",
            $noText: true,
            $skin: "s-site-help-link"
        }, this);
        
        div = document.createElement("aside");
        div.setAttribute("id", "s-site-author");
        this.$$container[0].appendChild(div);
        
        div = document.createElement("div");
        div.setAttribute("id", "s-fusion-sessions-opener");
        div.style.visibility = "hidden";
        this._header.appendChild(div);
        
        this._appendTopPanelOpener($(this._header));
        this.$$container[0].appendChild(this._header);
        
        div = document.createElement("div");
        div.setAttribute("id", "s-site-top-pn");
        this.$$container[0].appendChild(div);
        
        this.appendDiagnosesPanel(this.$$container, this);
    },
    
    loadSite: function(siteOptions){
        document.site = this;
        this.spyGateway = new SpyGateway();
        this.siteOptions = siteOptions;
        this._fieldWidths = siteOptions._fieldWidths || _fieldWidths;
        document.itemFactory = itemFactory.create(this.siteOptions.widgetsLibrary);
        (document.controller = new (this.siteOptions.controllerClass || Controller)()).initialize();
        
        if (this.siteOptions.fusionGatewayClass) {
            document.controller.fusionGateway = new this.siteOptions.fusionGatewayClass();
        }
        this.requestControllers = {
            http: require("syracuse-ui/lib/controller/httpController")
        }
        this.agents = {};
        this.resizeListeners = {};
        this.externalAdapter = new ExternalAdapter();
        this._zIndex = 100;
        $(window).unload = function(){
            if (document.site) {
                document.site.unload();
            }
        };
        this.$$container = $("#s-site");
        (this._eventListener = new EventListener()).load();
        this.$prototype = this.siteOptions.$prototype;
        document.itemFactory.initializeItem(this, this.siteOptions.$item);
        this.$item.$layoutOptions = this.$item.$layoutOptions || {};
        this.loadBox();
        //window.onerror = this.onUncaughtError; // uncaught exception handler
        return this;
    },
    onUncaughtError: function(errorMsg, url, lineNumber, error){
        if (document.site.mainPage) {
            // diagnose component will be improved, with specific msg and stack properties
            var $diagnose = {};
            $diagnose.message = "Exception thrown and not caught !!\n" + "Error message : " + errorMsg;
            $diagnose.message += error ? "\nStack:\n" + error.stack : "";
            $diagnose.severity = "alert";
            document.site.showDiagnoses({
                $diagnoses: [$diagnose]
            });
            return true;
        }
        else {
            //debugger; //TODO	
        }
    },
    onError: function(error){
        this.onUncaughtError(error.message, error.fileName, error.lineNumber, error);
    }
    
});

exports.load = function($item, $prototype){
    return (new Site()).loadSite({
        widgetsLibrary: require('./widgetsLibrary'),
        fusionGatewayClass: require('syracuse-ui/lib/fusion/fusionGateway').FusionGateway,
        userProfileClass: require('./userProfile').UserProfile,
        $item: $item,
        $prototype: $prototype
    });
};
