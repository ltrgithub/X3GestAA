"use strict";
var helpers = require('syracuse-core/lib/helpers');
var dialogManager = require('syracuse-ui/lib/dialog/dialogManager');
var MessageBox = require('syracuse-ui/lib/diagnoses/messageBox').MessageBox;

var ExternalAdapter = require("./aside/externalAdapter").ExternalAdapter;
var diagnoseManager = require('syracuse-ui/lib/diagnoses/diagnosesPanel');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var Controller = require('syracuse-ui/lib/controller/controller').Controller;
var searchRequest = require('./search/searchRequest');
var eventListener = require('./events/eventListener');
var disconnectUtils = require('./disconnectUtils');
var globals = require('streamline/lib/globals');
var locale = require('syracuse-core/lib/locale');
//var localizationConverter = require('syracuse-ui/lib/localization/localizationConverter');
var JobSyra = require('syracuse-ui/lib/jobs/jobHandlerSyra').JobHandlerSyra;
var siteFunctions = require("syracuse-ui/lib/site/tools/siteFunctions");
var pageLoader = require("syracuse-ui/lib/site/tools/pageLoader");

var deltaManager = require('syracuse-ui/lib/page/delta/deltaManager');
var fusionGatewayClass = require('syracuse-ui/lib/fusion/fusionGateway').FusionGateway;
var UserProfile = require('./userProfile').UserProfile;
var layoutValidator = require("syracuse-ui/lib/site/layout/layoutValidator");
var layoutUpdater = require("syracuse-ui/lib/site/layout/layoutUpdater");
var expressionMaker = require('./tools/expressionMaker');
var localizer = require('syracuse-ui/lib/localization/localizer');
var urlMaker = require('syracuse-ui/lib/site/url/urlMaker');
var history = require('syracuse-ui/lib/site/url/history');
var filterMaker = require('syracuse-ui/lib/site/filter/filterMaker');
var domHelper = require('syracuse-ui/lib/site/tools/domHelper');
var uiLocker = require('syracuse-ui/lib/site/tools/uiLocker');
var browser = require('syracuse-ui/lib/site/tools/browser');



window.repository = {};

function Site() {}

exports.Site = helpers.defineClass(Site, RawPage, {
	findArticle: function(dom) {
		while (dom != null) {
			if (dom.syraarticle) {
				return repository[dom.syraarticle];
			}
			dom = dom.parentNode;
		}
	},
	findField: function(dom) {
		var field;
		while (dom != null) {
			if (dom.syraItem) {
				field = repository[dom.syraItem];
				if (!field || (field && field.isField)) {
					break;
				}
			}
			dom = dom.parentNode;
		}
		return field;
	},
	checkMainPageBookmarkStatus: function() {
		if (this.bookmarksManager) {
			this.bookmarksManager.checkMainPageStatus();
		}
	},
	designArticle: function(open, article, classDesigner) {
		if (open) {
			article.designer = new(classDesigner)();
			article.designer.openDesigner(article);
		} else {
			if (article.designer) {
				article.page.showDiagnoses({
					$diagnoses: null
				});
				article.designer.dispose();
			}
			article.designer = null;
		}
	},

	setSpecificAttributes: function(dom, specificity) {
		if (dom) {
			switch (specificity) {
				case "disableSpellCheck":
					dom.setAttribute("spellcheck", false);
					break;
				case "disableAutoCorrect":
					dom.setAttribute("autocorrect", "off");
					break;
				default:
					dom.setAttribute("spellcheck", false);
					dom.setAttribute("autocorrect", "off");
			}
		}
	},
	randomStr: function(m) {
		var m = m || 9,
			s = '',
			r = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		for (var i = 0; i < m; i++) {
			s += r.charAt(Math.floor(Math.random() * r.length));
		}
		return s;
	},
	logout: function() {
		var self = this;
		disconnectUtils.onUserActionUnload(function() {
			syra_controller.postQuery({
				$title: self.localize.siteLogout,
				$method: "POST",
				$url: "/logout",
				httpHeaders: {
					authorization: "basic"
				}
			}, null, null, function($location, data) {
				// return to login page (or to the logout location)
				window.open($location.$url, "_self");
			});
		}, null, "logout");
	},

	onMenuClick: function(menuItem) {
		var res = true;
		if (this.bookmarksManager) {
			res = this.bookmarksManager.onMenuClick(menuItem);
		}
		if (menuItem.$bind && menuItem.$bind == '$help') {
			siteFunctions.openHelpPopup(menuItem);
			res = false;
		}
		if (menuItem.$bind == "$legal") {
			siteFunctions.openLegalPage(menuItem);
			res = false;
		}
		return res;
	},
	dispose: function() {
		eventListener.dispose();

		if (this.fusionGateway) {
			this.fusionGateway.dispose();
		}
		$(window).unbind();
		if (this.dialogManager) {
			this.dialogManager.dispose();
		}

		if (this.uiLocker) {
			this.uiLocker.dispose();
		}
		siteFunctions.dispose(this);

		this.pageLoader = this.siteFunctions = this.browser = this.uiLocker = this.dom = this.layoutUpdater = this.layoutValidator = null;
		this.history = this.urlMaker = this.filterMaker = this.screenDesigners = this.fusionHeaderFunctionLink = this.fusionHeaderHomeLink = this.homeLink = null;

		this._jobsViewerOpener = this.pageDesignerOpener = this.fusionHeader = this.fusionHeaderHomeLink = null;
		this.fusionGateway = null;
		this.headerLogo = this.headerTop = this.wcReqArray = this.bookmarks = null;
		RawPage.prototype.dispose.call(this);
		this.expressionMaker = this.deltaManager = this.diagnoseManager = this.localizer = window.onerror = window.onbeforeunload = window.onunload = null;

	},
	_focusBox: function(box, hasFocus) {
		if (box) {
			var target = box.layoutSlot || box.body;
			if (!target && box.domItem) {
				target = box.domItem;
			}
			if (target) {
				if (box != box.page) {
					this.dom.toggleClass(target, "s-selected-box", hasFocus);
				}
			}
		}
	},
	registerJobSyra: function($location, $state, $title, uuid) {
		var job = new JobSyra();
		var jobParams = {
			$location: $location,
			$state: $state,
			title: $title,
			uuid: uuid,
			kind: "operation"
		};
		job.register(jobParams);
	},
	onBeforeClick: function(box, event) {
		siteFunctions.toggleTopPanel(false, event, true);
		if (event && event.type != "scroll") {
			syra_dd.stop();
		}
		this.dialogManager.closePopups(box, event);
	},

	formatHTMLText: function(message) {
		return message.replace(/\n/g, "<BR/>");
	},
	isEllipsisActive: function(e) {
		return (e.clientWidth < e.scrollWidth);
	},
	showDiagnoses: function(message, item, options) {
		if (item && item.page) {
			var diagnosePage = item.page.diagnosePage || item.page;
			if (diagnosePage.diagnosesPanel) {
				diagnosePage.diagnosesPanel.showDiagnoses(message, item.page, options);
			} else {
				diagnosePage.showDiagnoses(message, options);
			}
		} else {
			if (this.diagnosesPanel) {
				this.diagnosesPanel.showDiagnoses(message, item, options);
			} else {
				if (this.mainPage) {
					this.mainPage.showDiagnoses(message, options);
				} else { // default: message box
					var options = {};
					var onlyOneDiagnose = message.$diagnoses.length == 1;
					options.$message = (onlyOneDiagnose && message.$diagnoses[0].$message) || this.localize.userProfile_siteMsgboxMsg;
					options.$type = "alert";
					options.$buttons = "ok";
					options.$title = this.localize.siteMsgboxTitle;
					options.$diagnoses = message.$diagnoses;
					options.$origin = onlyOneDiagnose ? message.$diagnoses[0].$origin : "";
					this.showMessage(options);
				}
			}
		}
	},
	logon: function(onAfterLogon) {
		var self = this;
		var prevdataset;
		if (self.userProfile) {
			prevdataset = self.userProfile.buildWCContent();
			self.userProfile.dispose(self.userProfile);
			self.userProfile = null;
		}

		self.userProfile = new UserProfile();
		self.localize = this.localize;
		this.pageLoader.initialize(self.userProfile);
		self.userProfile.onLogonProcessing = true;
		syra_controller.loadWorkingCopy({
			menu: {
				$url: self.$item.$userProfileUrl,
				sendData: prevdataset
			},
			article: self.userProfile,
			callback: function() {
				var dataset = self.userProfile.dataset;
				self.developpementMode = dataset && dataset.developpementMode;
				self.enableTestRobot = dataset && dataset.enableTestRobot;
				delete self.userProfile.onLogonProcessing;
				onAfterLogon();
			}
		});

	},
	_runJobsViewer: function() {
		// get trackers list in order to run jobs viewer if necessary
		var $trackersUrl = "/sdata/$trackers";
		syra_controller.sendRequest(null, {
			method: "GET",
			$location: {
				$url: $trackersUrl
			}
		}, function(data, response, $url) {

			if (data.$resources && data.$resources.length > 0) {
				for (var ii = 0, jj = data.$resources.length; ii < jj; ii++) {
					var resource = data.$resources[ii];
					var params = {
						$location: resource.location || resource.$location,
						$state: resource.phase,
						$title: resource.title || "(Title not retrieved)",
						uuid: resource.uuid,
						kind: "operation"
					};
					syra_site.registerJobSyra(params.$location, params.$state, params.$title, params.uuid);
				}
			}
		}, function(error, httpquery) {
			this.requestControllers.http._onResponseError(httpquery, error);
		});
	},

	getSessionId: function() {
		//console.log("client syracuse.sid." + window.location.port);

		return helpers.http.parseCookie(document.cookie)["syracuse.sid." + window.location.port] || "";
	},
	showMessage: function(options, displayDisabled) {
		if (this.messageBox) {
			this.messageBox.dispose();
		}
		options.$type = options.$type || "alert";
		this.messageBox = new MessageBox();
		this.messageBox.$prototype = {};
		this.messageBox.displayDisabled = displayDisabled; // property necessary for htmleditor msgbox
		this.initializeNewItem(this.messageBox, options);
		this.messageBox.loadBox();
	},
	_releaseMainPage: function() {
		var prev = this.mainPage;
		if (prev && prev.externalAdapter) {
			prev.externalAdapter.releaseMainPage({
				mainPage: prev,
				doEvent: function() {
					setTimeout(function() {
						syra_controller.disposeObject(prev);
					}, 10);
				}
			});
		}
		this.dom.empty(this.body);
	},
	unload: function() {
		$(document).unbind();
		this.dispose();
		syra_controller && syra_controller.dispose();
		document.site = document.controller = null;
		window.syra_site = window.syra_controller = null;
	},
	_getHomeMenu: function() {
		if (this.menuItems && this.menuItems.$home) {
			return this.menuItems.$home[0];
		}
		return null;
	},
	gotoNavigationPage: function() {
		this.clickMenu("$navigation");
	},
	gotoHome: function() {
		this.clickMenu("$home");
	},
	gotoHelp: function() {
		this.clickMenu("$help");
	},
	notifyRequestSurvey: function(pendingRequests) {
		if (!this.requestSurvey) {
			this.requestSurvey = document.createElement("div");
			this.requestSurvey.id = "s-site-request";
			this.dom.setZIndex(this.requestSurvey);

			this.layoutSlot.appendChild(this.requestSurvey);
			this.requestSurveyCount = document.createElement("label");
			this.requestSurveyCount.id = "s-site-request-count";
			this.requestSurvey.appendChild(this.requestSurveyCount);
		}
		pendingRequests = pendingRequests || 0;
		this.requestSurveyCount.textContent = pendingRequests;
		if (pendingRequests > 0) {
			if (this.requestSurvey.style.right != "0px") {
				this.requestSurvey.style.right = "0px";
			}
		} else {
			this.requestSurvey.style.right = "-80px";
		}
	},
	onMainPageChange: function($itemPage) {
		siteFunctions.toggleTopPanel(false);
		this.body.style.display = "none";
		$itemPage.boxParent = null;
		$itemPage.layoutSlot = this.body;
		this._releaseMainPage();
		if (this.diagnosesPanel) {
			this.diagnosesPanel.clean();
		}

		this.mainPage = this.pageLoader.load($itemPage, true);
		this.mainPage.openerUrlSegments = $itemPage.openerUrlSegments;
		this.mainPage.isMainPage = true;
		this.spyer.setSpyedPage(this.mainPage);
		return this.mainPage;
	},

	drawBox: function() {
		var self = this;
		siteFunctions.addDragDropManager();
		self._renderHeader();
		self.domItem = self.body = document.createElement("div");
		self.body.id = "s-site-body";
		self.body.setAttribute("tabindex", "1"); // add for receive keyboard event  for shortcut
		self.layoutSlot.appendChild(self.body);
		self.logon(function() {
			self._onLogon();
		});
	},
	_onLogon: function() {
		if (!this._isLocalChanging) {
			this.isUserLogonEnd = true;
			syra_site.history.start();
			this.ensureDesignerOpenerVisibility(this.mainPage);
			this.layoutSlot.style.display = "";
			if (this.bookmarksManager) {
				this.bookmarksManager.loadBookmarks();
			}
			this.resize();
		}
	},
	ensureDesignerOpenerVisibility: function(page) {
		if (page && page != this && page.mainPageDesignerAccess != "unknow") {
			var enabled = page.mainPageDesignerAccess != "disabled" && !(this.userProfile.getAuthoringLevel() === "none");
			if (this.pageDesignerOpener) {
				this.pageDesignerOpener.style.visibility = enabled ? "" : "hidden";
			}
		}
	},
	getPreferences: function(key, defaultValues, target) {
		var values = this.userProfile.dataset.sitePreferences;
		if (values) {
			values = (values[this.$item.$device] || {})[key];
		}
		if (values === undefined && this.$item.$preferences) {
			values = this.$item.$preferences[key];
		}
		values = values || {};
		if (defaultValues) {
			var keys = Object.keys(defaultValues);
			for (var ii = 0, jj = keys.length; ii < jj; ii++) {
				if (values[keys[ii]] === undefined) {
					values[keys[ii]] = defaultValues[keys[ii]];
				}
			}
		}
		if (target) {
			this.applyValues(target, values);
		}
		return values;
	},
	setPreferences: function(key, source, props) {
		var sitePreferences = this.userProfile.dataset.sitePreferences = this.userProfile.dataset.sitePreferences || {};
		var preferences = sitePreferences[this.$item.$device] = sitePreferences[this.$item.$device] || {};
		if (props) {
			this.applyValues(preferences[key] = preferences[key] || {}, source, props);
		} else {
			preferences[key] = source;
		}
		this.userProfile.saveSitePreferences();
	},
	applyValues: function(target, values, keys) {
		if (target) {
			keys = keys || Object.keys(values);
			for (var ii = 0, jj = keys.length; ii < jj; ii++) {
				target[keys[ii]] = values[keys[ii]];
			}
		}
	},
	onUserProfileChange: function(reloadMainPage) {
		var self = this;
		// adding localePreferences to globals.context
		if (self.userProfile.dataset && self.userProfile.dataset.selectedLocale) {
			globals.context = globals.context || {};
			var localePreferences = globals.context.localePreferences = self.userProfile.dataset.selectedLocale;
			var map = globals.context.localeMap = globals.context.localeMap || {};
			var lang = localePreferences && localePreferences.code || "en";
			/*if (lang == locale.current) {
             map[lang] = lang;
             }*/
			if (map[lang] == null) {
				map[lang] = lang;
				self._isLocalChanging = true;
				locale.setCurrent(function(err) {
					self.loadSiteLocalize();
					delete self._isLocalChanging;
					if (self.isUserLogonEnd) {
						syra_site.history.reload();
					} else {
						self._onLogon();
					}
				}, lang, localePreferences);
				return;
			}
		}
		if (reloadMainPage) {
			syra_site.history.reload();
		} else {
			pageLoader.showPageSecurity();
			if (self.mainPage) {
				self.updateDocumentTitle();
				self.ensureDesignerOpenerVisibility(self.mainPage);
			}
		}
	},
	updateDocumentTitle: function() {
		if (this.mainPage) {
			var title = this.mainPage.getTitle();
			if (title) {
				if (this.$item.$isSecurityTitleVisible !== false) {
					if (this.userProfile.dataset) {
						if (this.userProfile.dataset.selectedRole) {
							title += " (" + this.userProfile.dataset.selectedRole.description + ")";
						}
						if (this.userProfile.dataset.selectedEndpoint) {
							title += " (" + this.userProfile.dataset.selectedEndpoint.description + ")";
						}
					}
				}
				document.title = title;
			}
		}
	},
	appendJobsViewer: function(jobsViewer) {
		if (this.layoutSlot) {
			this.layoutSlot.appendChild(this.jobsViewer ? this.jobsViewer.domItem : (this.jobsViewer = jobsViewer).domItem);
		}
	},
	registerScreenDesigner: function(add, designer) {
		if (add) {
			if (!this.screenDesigners) {
				this.screenDesigners = [];
			} else {
				var top = this.screenDesigners && this.screenDesigners.length && this.screenDesigners[this.screenDesigners.length - 1];
				if (top) {
					top.onTopScreenDesigner(false);
				}
			}
			this.header.style.display = "none";
			this.screenDesigners.push(designer);
		} else {
			if (this.screenDesigners) {
				var index = this.screenDesigners.indexOf(designer);
				if (index >= 0) {
					this.screenDesigners.splice(index, 1);
				}
				if (this.screenDesigners.length == 0) {
					delete this.screenDesigners;
					this.header.style.display = "";
				} else {
					var top = this.screenDesigners && this.screenDesigners.length && this.screenDesigners[this.screenDesigners.length - 1];
					if (top) {
						top.onTopScreenDesigner(true);
					}
				}
			}
		}
	},

	resize: function(onBoxToggle) {
		this.bodyRect = this.layoutRect = null;
		if (this.body) {
			var bodyRect = this.dom.getBoundingClientRect(this.body);
			this.body.style.height = (this.getLayoutSize().height - bodyRect.top) + "px";
		}
		this.isResizing = true;
		this.pageLoader.resize();

		if (this.bookmarksManager) {
			this.bookmarksManager.onResize();
		}
		this.isResizing = false;
		this.uiLocker.ensureLock();
	},

	closeSearchFieldPopup: function() {
		this.searchField.searchField && this.searchField.searchField._autoCompletePopup && this.searchField.searchField._autoCompletePopup.close();
	},
	_renderHeader: function() {
		this.header = document.createElement("header");
		this.header.id = "s-site-header";
		this.layoutSlot.appendChild(this.header);

		// top right
		this.headerTop = document.createElement("div");
		this.headerTop.id = "s-site-header-top";

		this.siteHelpLink = this.loadNewItem(this.headerTop, {
			$clientId: "s-site-help-link",
			$bind: "$help",
			$category: "link",
			$noText: true,
			$skin: "s-site-help-link"
		});

		siteFunctions.addPageDesignerOpener();

		var middleCell = document.createElement("div");
		middleCell.id = "s-site-header-middle-cell";
		this.headerTop.appendChild(middleCell);

		siteFunctions.addJobsOpener(middleCell);

		this.setArticleId(this.layoutSlot);
		siteFunctions.appendTopPanelOpener(middleCell);

		siteFunctions.addLogoutButton(this);

		this.homeLink = this.loadNewItem(this.headerTop, {
			$bind: "$home",
			$category: "link",
			$noText: true,
			$skin: "s-site-home"
		});

		this.navigationLink = this.loadNewItem(this.headerTop, {
			$bind: "$navigation",
			$category: "link",
			$noText: true,
			$skin: "s-site-navigation"
		});

		this.searchField = searchRequest.loadRequest(this.headerTop);
		this.header.appendChild(this.headerTop);

		this.headerBottom = document.createElement("div");
		this.headerBottom.id = "s-site-header-bottom";

		siteFunctions.addLogo(this.headerBottom);

		siteFunctions.addBookmarkManager();

		this.header.appendChild(this.headerBottom);
	},


	loadSiteLocalize: function() {
		this.localize = locale.resources(module)();
		if (this.pageDesignerOpener) {
			this.pageDesignerOpener.title = this.localize.userProfile_siteAuthoringOpen;
		}
		if (this.fusionHeaderHomeLink) {
			this.fusionHeaderHomeLink.title = this.localize.userProfile_siteTabLink;
		}
		if (this.userProfile) {
			var code = this.localizer.getLanguage() || "";
			this.applyChange({
				language: code,
				helpLanguage: code,
				$links: {
					$documentation: {
						$title: this.localize.siteHelpDocumentationLink
					},
					$shortcuts: {
						$title: this.localize.siteHelpShortcutsLink
					},
					$legal: {
						$title: this.localize.siteHelpLegalLink
					}
				}
			});
		}

		// update site header links tootips text
		if (this.siteHelpLink) {
			if (this._logoutPicker) {
				this._logoutPicker.setAttribute("title", this.localize.siteLogoutLink);
			}
			this.siteHelpLink.domItem.title = this.localize.siteHelpLink;
			this.homeLink.domItem.title = this.localize.siteHomeLink;
			this.navigationLink.domItem.title = this.localize.siteNavigationLink;
			//this._topPanelOpener.setAttribute("title", this.localize.siteUserProfile);
		}
		if (this.searchField) {
			this.searchField.updateLocalization();
		}

	},
	loadBox: function(siteOptions) {
		this.isSiteRegisterDisabled = true;
		this.pageLoader = pageLoader;
		this.siteFunctions = siteFunctions;
		this.browser = browser;
		this.uiLocker = uiLocker;
		this.dom = domHelper;
		this.layoutUpdater = layoutUpdater;
		this.layoutValidator = layoutValidator;
		this.diagnoseManager = diagnoseManager;
		this.deltaManager = deltaManager;
		this.expressionMaker = expressionMaker;
		this.dialogManager = dialogManager;
		this.urlMaker = urlMaker;
		this.filterMaker = filterMaker;
		this.history = history;
		this.localizer = localizer;

		this.siteOptions = siteOptions;
		document.site = window.syra_site = this;
		this.loadSiteLocalize();
		this.$autoFetch = false;
		this._childPageOffset = 1;
		this.pageLoader.initialize(this);
		siteFunctions.loadSpyer();
		document.syra_controller = window.syra_controller = new(this.siteOptions.controllerClass || Controller)();

		if (this.siteOptions.fusionGatewayClass) {
			this.fusionGateway = new this.siteOptions.fusionGatewayClass();
			this.fusionGateway.initialize();
		}
		this.requestControllers = {
			http: require("syracuse-ui/lib/controller/httpController")
		};
		this.agents = {};
		this.externalAdapter = new ExternalAdapter();

		$(window).unload = function() {
			if (syra_site) {
				syra_site.unload();
			}
		};
		this.layoutSlot = document.getElementById("s-site");
		this.layoutSlot.style.display = "none";
		eventListener.load();

		this.$prototype = this.siteOptions.$prototype;
		this.initializeNewItem(this, this.siteOptions.$item);
		this.isTabletDevice = this.$item.$device == "tablet";
		this.setArticleId(this.layoutSlot);
		RawPage.prototype.loadBox.call(this);
		this.onWindowError();
		disconnectUtils.onWindowUnload(this);
		if (this.headerLogo) {
			var homeMenu = this._getHomeMenu();
			if (homeMenu) {
				this.headerLogo.title = homeMenu.domItem.title;
				this.headerLogo.setAttribute("href", homeMenu.domItem.getAttribute("href"));
			}
		}
		return this;
	},
	onWindowError: function() {
		var self = this;
		window.onerror = function(errorMsg, url, lineNumber, error) {
			self.onUncaughtError(errorMsg, url, lineNumber, error);
		};
	},
	onUncaughtError: function(errorMsg, url, lineNumber, error) {
		var self = this;
		if (self.mainPage) {
			var options = {
				errorMsg: errorMsg,
				url: url,
				lineNumber: lineNumber,
				error: error,
				doEvent: function() {
					// diagnose component will be improved, with specific msg and stack properties
					var $diagnose = {};
					$diagnose.$message = options.errorMsg;
					$diagnose.$message += error ? "\nStack:\n" + error.stack : "";
					$diagnose.$severity = "error"; //"alert";
					self.showDiagnoses({
						$diagnoses: [$diagnose]
					});
				}
			};
			if (self.mainPage.externalAdapter)
				self.mainPage.externalAdapter.onUncaughtError(options);
		} else {
			self.showDiagnoses({
				$diagnoses: [{
					$severity: "fatal",
					$message: errorMsg
				}]
			});
		}
	},
	onError: function(error) {
		this.onUncaughtError(error.message, error.fileName, error.lineNumber, error);
	},

	getBodySize: function() {
		if (!this.bodyRect) {
			this.bodyRect = this.dom.getBoundingClientRect(this.body);
		}
		return this.bodyRect;
	},
	getLayoutSize: function() {
		if (!this.layoutRect) {
			this.layoutRect = this.dom.getBoundingClientRect(this.layoutSlot);
		}
		return this.layoutRect;
	},
	scrollToField: function(field) {
		if (field.articleParent) {
			var parent = field.articleParent.isRecordArticle ? field.articleParent.articleParent : field.articleParent;
			if (parent.scroller) {
				parent.scroller.ensureFieldVisibility(field);
			} else {
				field.page.scrollToItem(field);
			}
		}
	},
	getPageTemplateUrl: function(url) {
		return this.$item.$pageTemplateUrl;
	}
});

exports.load = function($item, $prototype) {
	return (new Site()).loadBox({
		widgetsLibrary: require('./widgetsLibrary'),
		fusionGatewayClass: fusionGatewayClass,
		$item: $item,
		$prototype: $prototype
	});
};