"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Dialog = require('./dialog').Dialog;
var MessageBox = require('syracuse-ui/lib/diagnoses/messageBox').MessageBox;
var SiteTopPanel = require("./aside/siteTopPanel").SiteTopPanel;
var ExternalAdapter = require("./aside/externalAdapter").ExternalAdapter;
var WidgetResizer = require("./resize/widgetResizer").WidgetResizer;
var ResizeListener = require("./resize/resizeListener").ResizeListener;
var DiagnosesPanel = require('syracuse-ui/lib/diagnoses/diagnosesPanel').DiagnosesPanel;
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var Controller = require('syracuse-ui/lib/controller/controller').Controller;
var searchRequest = require('./search/searchRequest');
var EventListener = require('./aside/eventListener').EventListener;
var SpyGateway = require('./aside/spyGateway').SpyGateway;
var disconnectUtils = require('./disconnectUtils');
var locale = require('syracuse-core/lib/locale');
var cvgPageConverter = require('syracuse-x3/lib/cvgPageConverter');
//var localizationConverter = require('./localizationConverter');
var JobSyra = require('syracuse-ui/lib/jobs/jobHandlerSyra').JobHandlerSyra;
var DocCookies = require('./aside/docCookies').DocCookies;

var _fieldSmartWidth = {
	charWidth: 8,
	small: 15, //10
	medium: 30, //20
	large: 50
};

var _fieldWidths = {
	"application/x-icon": {
		$width: 50
	},
	"application/x-date": {
		$maxLength: 10
	},
	"application/x-time": {
		$maxLength: 8
	},
	"application/x-datetime": {
		$maxLength: 20
	},
	"application/x-boolean": {
		$maxLength: 5
	},
	"application/x-binary": {
		$width: 30
	},
	"image": {
		$width: 40
	}
};

var _iconFields = {
	"application/x-array": "a",
	"application/x-boolean": "b",
	"application/x-choice": "c",
	"application/x-date": "d",
	"application/x-time": "e",
	"application/x-datetime": "e",
	"application/x-decimal": "f",
	"application/x-integer": "f",
	"application/x-real": "f",
	"application/x-graph": "g",
	"application/x-cube": "g",
	"application/x-icon": "h",
	"application/x-binary": "h",
	"application/x-document": "h",
	"image": "h",
	"application/x-quantity": "j",
	"application/x-reference": "j",
	"text/rtf": "k",
	"text/plain": "k",
	"text/html": "k",
	"application/x-password": "l",
	"application/x-string": "l"

	/*"application/x-calendar": require('syracuse-ui/lib/field/schedule/calendar').Calendar,
     "application/x-gantt": require('syracuse-ui/lib/field/schedule/gantt').Gantt,
     "application/x-process": require('syracuse-ui/lib/field/process/visualProcess').VisualProcess,
     */
};



function Site() {}

exports.Site = helpers.defineClass(Site, RawPage, {
	designItem: function(open, designedItem, classDesigner) {
		if (open) {
			designedItem.designer = new(classDesigner)();
			designedItem.designer.openDesigner(designedItem);
		} else {
			if (designedItem.designer) {
				designedItem.page.showDiagnoses({
					$diagnoses: null
				});
				designedItem.designer.dispose();
			}
			designedItem.designer = null;
			this.resize();
		}
	},
	getFieldIconType: function($type) {
		return _iconFields[$type] || "";
	},
	setSpecificAttributes: function(dom, specificity) {
		if (dom) {
			switch (specificity) {
				case "disableSpellCheck":
					dom.setAttribute("spellcheck", false);
					break;
				case "disableAutoCorrect":
					dom.setAttribute("autocorrect", "off");
					break;
				default:
					dom.setAttribute("spellcheck", false);
					dom.setAttribute("autocorrect", "off");
			}
		}
	},
	randomStr: function(m) {
		var m = m || 9,
			s = '',
			r = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
		for (var i = 0; i < m; i++) {
			s += r.charAt(Math.floor(Math.random() * r.length));
		}
		return s;
	},
	onMenuClick: function(menuItem) {
		var self = this;
		if (menuItem.$bind == "$logout") {
			disconnectUtils.onUserActionUnload(function() {
				menuItem.httpHeaders = {
					authorization: "basic"
				};
				document.controller.postQuery(menuItem, null, null, function($location, data) {
					// return to login page (or to the logout location)
					window.open($location.$url, "_self");
				});
			});
			return false;
		}
		return true;
	},
	dispose: function() {
		if (this.fusionGateway) {
			this.fusionGateway.dispose();
		}
		if (this.spyGateway) {
			this.spyGateway.dispose();
		}
		$(window).unbind();
		this._uiLocker = this._uiLockerOverlay = this._uiLockerTimeout = null;
		this.desktopPages = this.pageDesignerOpener = this._newTabLink = null;
		this._pageDialogs = this.autoCloseDialogs = this.fusionGateway = this._topPanelClass = this._topPanel = this._topPanelContainer = this.spyGateway = this.spy = null;
		this.wcReqArray = null;
		RawPage.prototype.dispose.call(this);
		window.onerror = window.onbeforeunload = window.onunload = null;
	},
	_focusBox: function(box, hasFocus) {
		if (box) {
			var target = box.layoutSlot || box.body;
			if (!target && box.$$item) {
				target = box.$$item[0];
			}
			if (target) {
				if (box != box.page) {
					this.toggleClass(target, "s-selected-box", hasFocus);
				}
			}
		}
	},
	onChildFieldFocus: function(boxParent, hasFocus) {
		/*var self = this;
         if (boxParent) {
         if (hasFocus) {
         clearTimeout(self.focusBoxTimeOut);
         if (self.boxFocus != boxParent) {
         self._focusBox(self.boxFocus, false);
         }
         self._focusBox(self.boxFocus = boxParent, true);
         }
         else {
         self.focusBoxTimeOut = setTimeout(function(){
         self._focusBox(self.boxFocus, false);
         }, 500);
         }
         }*/
	},
	registerJobSyra: function($location, $state, $title, uuid) {
		var job = new JobSyra();
		var jobParams = {
			$location: $location,
			$state: $state,
			title: $title,
			uuid: uuid,
			kind: "operation"
		};
		job.register(jobParams);
	},
	closePopups: function(box, event) {
		if (this.autoCloseDialogs) {
			var ids = Object.keys(this.autoCloseDialogs);
			for (var ii = 0, jj = ids.length; ii < jj; ii++) {
				var dlg = this.autoCloseDialogs[ids[ii]];
				if (dlg && !dlg.disposed) {
					if (dlg._content && dlg._content == box) {
						continue;
					}
					if (dlg._content && dlg._content.onBeforeAutoClose && !dlg._content.onBeforeAutoClose(box)) {
						continue;
					}
					if (!event || !dlg.isTargetInBoundary(event)) {
						dlg.close();
						delete this.autoCloseDialogs[ids[ii]];
					}
				}
			}
			// this.autoCloseDialogs = null;
		}

	},
	ensurePreferences: function() {
		return (this._preferences = this._preferences || {});
	},

	onBeforClick: function(box, event) {
		delete this.requestedDDAuthoringItem;
		if (this.dragDropInstance) {
			if (this.dragDropInstance.stop) {
				this.dragDropInstance.stop();
			} else {
				document.controller.disposeObject(this.dragDropInstance);
			}
			this.setDragDropInstance();
		}
		this.closePopups(box, event);
	},

	formatHTMLMessage: function(message) {
		return message.replace(/\n/g, "<BR/>");
	},
	setDragDropInstance: function(instance, ident) {
		if (instance) {
			this.dragDropInstance = instance;
		} else {
			delete this.dragDropInstance;
		}
	},
	showDiagnoses: function(message, item, options) {
		if (item && item.page) {
			var diagnosePage = item.page.diagnosePage || item.page;
			if (diagnosePage.diagnosesPanel) {
				diagnosePage.diagnosesPanel.showDiagnoses(message, item, options);
			} else {
				diagnosePage.showDiagnoses(message, options);
			}
		} else {
			if (this.diagnosesPanel) {
				this.diagnosesPanel.showDiagnoses(message, item, options);
			} else {
				if (this.mainPage) {
					this.mainPage.showDiagnoses(message, options);
				} else { // default: message box
					var options = {};
					var onlyOneDiagnose = message.$diagnoses.length == 1;
					options.$message = this.localize.siteMsgboxMsg;
					options.$type = "alert";
					options.$buttons = "ok";
					options.$title = this.localize.siteMsgboxTitle;
					options.$diagnoses = message.$diagnoses;
					options.$origin = onlyOneDiagnose ? message.$diagnoses[0].$origin : "";
					this.showMessage(options);
				}
			}
		}
	},
	logon: function(onAfterLogon) {
		var self = this;
		var prevdataset;
		if (self.userProfile) {
			prevdataset = self.userProfile.buildWCContent();
			document.controller.disposeObject(self.userProfile);
			self.userProfile = null;
		}
		self.userProfile = new(self.siteOptions.userProfileClass)();
		self.localize = this.localize;
		self.userProfile._initializePage();
		self.userProfile.onLogonProcessing = true;
		document.controller.loadWorkingCopy({
			menu: {
				$url: self.$item.$userProfileUrl,
				sendData: prevdataset
			},
			article: self.userProfile,
			callback: function() {
				var dataset = self.userProfile.dataset;
				self.developpementMode = dataset && dataset.developpementMode;
				self.enableTestRobot = dataset && dataset.enableTestRobot;
				delete self.userProfile.onLogonProcessing;
				onAfterLogon();
			}
		});
	},
	getSessionId: function() {
		return helpers.http.parseCookie(document.cookie)["syracuse.sid"] || "";
	},
	showMessage: function(options, displayDisabled) {
		if (this.messageBox) {
			document.controller.disposeObject(this.messageBox);
		}
		options.$type = options.$type || "alert";
		this.messageBox = new MessageBox();
		this.messageBox.$prototype = {};
		this.messageBox.displayDisabled = displayDisabled; // property necessary for htmleditor msgbox
		this.initializeNewItem(this.messageBox, options);
		this.messageBox.loadBox();
	},
	_releaseMainPage: function() {
		var prev = this.mainPage;
		if (prev && prev.externalAdapter) {
			prev.externalAdapter.releaseMainPage({
				mainPage: prev,
				doEvent: function() {
					setTimeout(function() {
						document.controller.disposeObject(prev);
					}, 10);
				}
			});
		}
		this.emptyDom(this.body);
	},
	unload: function() {
		$(document).unbind();
		document.controller.disposeObject(this._eventListener);
		document.controller.disposeObject(this);
		document.controller.disposeObject(document.controller);
		document.site = document.controller = null;
	},
	trimString: function(ss) {
		return typeof ss == 'string' || ss instanceof String ? ss.trim() : ss;
	},
	setZIndex: function(item) {
		this._zIndex++;
		if (item) {
			item.style.zIndex = this._zIndex;
		}
		return this._zIndex;
	},
	toggleClass: function(dom, css, show) {
		if (show) {
			if (dom.className.indexOf(css) < 0) {
				dom.className += (" " + css);
			}
		} else {
			dom.className = dom.className.replace(css, "");
		}
	},
	toggleDom: function(dom) {
		dom.style.display = this.isDomDisplay(dom) ? "none" : "";
	},
	isDomDisplay: function(dom) {
		return dom.style.display != "none";
	},
	emptyDom: function(domNode) {
		if (domNode) {
			while (domNode.firstChild) {
				domNode.removeChild(domNode.firstChild);
			}
		}
	},
	removeDomChild: function(child) {
		if (child && child.parentNode) {
			child.parentNode.removeChild(child);
		}
	},
	isScrolledIntoView: function($$elem, $$view) {
		if ($$view) {
			var docViewTop = $$view.scrollTop();
			var docViewBottom = docViewTop + $$view.height();
			var elemTop = $$elem.position().top;
			var elemBottom = elemTop + $$elem.height();

			return ((elemBottom <= docViewBottom) && (elemTop >= docViewTop));
		} else {
			return true;
		}
	},
	disableItem: function(item, isDisabled) {
		if (isDisabled) {
			item.setAttribute("disabled", isDisabled);
		} else {
			item.removeAttribute("disabled");
		}
		this.toggleClass(item, "s-disabled", isDisabled);
	},
	_getHomeMenu: function() {
		if (this.menuItems && this.menuItems.$home) {
			return this.menuItems.$home[0];
		}
		return null;
	},
	gotoHome: function() {
		this.clickMenu("$home");
	},
	gotoHelp: function() {
		this.clickMenu("$help");
	},
	getFieldWidth: function($field, useSmartMode, $titleLength, isSortable) {
		var $width;
		if ($field.$type) {
			if ($field.$format) {
				$width = this._fieldWidths[$field.$type + $field.$format];
			}
			if (!$width) {
				$width = this._fieldWidths[$field.$type];
			}
		}
		if (!$width) {
			$width = {};
		}
		var widthValue = $width.$width;
		var $maxLength = 0;
		if ($field.$precision) {
			$maxLength = $field.$precision + 2 * ($field.$precision / 3); //separator
		}
		if ($field.$scale) {
			$maxLength += $field.$scale + 1; //for separator
		}
		if (!$maxLength) {
			$maxLength = $field.$displayLength || $field.$maxLength || $width.$maxLength;
		}
		if (useSmartMode) {
			$maxLength = $maxLength || _fieldSmartWidth.large;
			if ($maxLength <= _fieldSmartWidth.small) {
				$maxLength = _fieldSmartWidth.small;
			} else {
				if ($maxLength <= _fieldSmartWidth.medium) {
					$maxLength = _fieldSmartWidth.medium;
				} else {
					$maxLength = _fieldSmartWidth.large;
				}
			}
			widthValue = (_fieldSmartWidth.charWidth * $maxLength);
		} else {
			if (isSortable) {
				$titleLength += 2;
			}
			if ($titleLength > $maxLength) {
				if (($titleLength - $maxLength) <= 4) {
					$maxLength = $titleLength;
				} else {
					if (isSortable) {
						$maxLength += 2;
					}
				}
				$maxLength = Math.max(isSortable ? 7 : 5, $maxLength);
			} else {
				if (isSortable) {
					$maxLength += 2;
				}
			}
			if (!widthValue) {
				$maxLength = Math.min(_fieldSmartWidth.medium, $maxLength || _fieldSmartWidth.medium);
				widthValue = (_fieldSmartWidth.charWidth * $maxLength);
			}

		}
		return widthValue;
	},
	setWidgetResizable: function(options) {
		var widgetResizer = new WidgetResizer();
		widgetResizer.setResizable(options);
		return widgetResizer;
	},
	attachResizeListeners: function(attach, page) {
		if (page) {
			if (!page._unregisterResizer) {
				var parent = page.dialogWrapper || document.site;
				if (parent && parent.resizeListener) {
					if (attach) {
						parent.resizeListener.add(page);
					} else {
						parent.resizeListener.remove(page);
					}
				}
			}
		}
		if (attach) {
			(page.resizeListener = new ResizeListener()).load();
		} else {
			if (page.resizeListener) {
				page.resizeListener.dispose();
				page.resizeListener = null;
			}
		}

	},
	notifyRequestSurvey: function(pendingRequests) {
		if (!this.requestSurvey) {
			this.requestSurvey = document.createElement("div");
			this.requestSurvey.id = "s-site-request";
			this.setZIndex(this.requestSurvey);

			this.layoutSlot.appendChild(this.requestSurvey);
			this.requestSurveyCount = document.createElement("label");
			this.requestSurveyCount.id = "s-site-request-count";
			this.requestSurvey.appendChild(this.requestSurveyCount);
		}
		pendingRequests = pendingRequests || 0;
		this.requestSurveyCount.textContent = pendingRequests;
		if (pendingRequests > 0) {
			if (this.requestSurvey.style.right != "0px") {
				this.requestSurvey.style.right = "0px";
			}
		} else {
			this.requestSurvey.style.right = "-80px";
		}
	},
	onMainPageChange: function($itemPage) {
		if (!this.body) {
			this.body = this.$$body[0]; //hack temp for office
		}
		this.body.style.display = "none";
		$itemPage.boxParent = null;
		$itemPage.layoutSlot = this.$$body[0];
		this._releaseMainPage();
		if (this.diagnosesPanel) {
			this.diagnosesPanel.clean();
		}
		this.toggleTopPanel(false);

		this.mainPage = this.loadNewPage($itemPage);
		this.mainPage.openerHttpQuery = $itemPage.httpQuery;
		this.mainPage.isMainPage = true;
		this.updateDocumentTitle();
		this.body.style.display = "";
		this.resize();
		this.spyGateway.setSpyedPage(this.mainPage);
		return this.mainPage;
	},
	drawBox: function() {
		var self = this;
		self._renderHeader();
		self.$$item = self.$$body = $(self.body = document.createElement("div"));
		self._$$header = $(self.header);
		self.body.id = "s-site-body";
		self.body.setAttribute("tabindex", "1"); // add for receive keyboard event  for shortcut
		self.layoutSlot.appendChild(self.body);
		self.logon(function() {
			document.controller.startNavigation();
			self._onLogon();
			self.layoutSlot.style.display = "";
			self.resize();
		});
	},
	applyLocalize: function() {
		if (this.pageDesignerOpener) {
			this.pageDesignerOpener.title = this.localize.siteAuthoringOpen;
		}
		if (this._newTabLink) {
			this._newTabLink.title = this.localize.siteTabLink;
		}
		var local = this.userProfile.getSelectedLocale();
		if (local) {
			this.applyChange({
				language: local.code || "",
				helpLanguage: (local.code || "").replace("-", "_")
			});
		}
	},
	_onLogon: function() {
		this.userProfile.ensureFormBlock();
		this.applyLocalize();
		if (this.mainPage) {
			this.mainPage.ensureDesignerOpenerVisibility();
		}
	},
	updateDocumentTitle: function() {
		var title = this.mainPage.getTitle();
		if (title) {
			if (this.$item.$isSecurityTitleVisible !== false) {
				if (this.userProfile.dataset) {
					if (this.userProfile.dataset.selectedRole) {
						title += " (" + this.userProfile.dataset.selectedRole.description + ")";
					}
					if (this.userProfile.dataset.selectedEndpoint) {
						title += " (" + this.userProfile.dataset.selectedEndpoint.description + ")";
					}
				} else {
					this.userProfile.$isTitleUpdateRequested = true;
				}
			}
			this.userProfile.showPageSecurity(this.mainPage);
			document.title = title;
		}
	},
	openDialog: function(options) {
		var dialog = new Dialog();
		dialog.open(options);
		return dialog;
	},
	appendJobsViewer: function(jobsViewer) {
		if (this.layoutSlot) {
			this.layoutSlot.appendChild(this.jobsViewer ? this.jobsViewer._item : (this.jobsViewer = jobsViewer)._item);
		}
	},
	resize: function(onBoxToggle) {
		var self = this;
		self.resizeTimeOut = setTimeout(function() {
			if (self.$$body && self.body) {
				if (self.authorPage && self.authorPage.onBeforeSiteResize) {
					self.authorPage.onBeforeSiteResize(self);
				} else {
					var newHeight = 0;
					if (self.header) {
						self._$$header = self._$$header || $(self.header);
						newHeight = self._$$header.outerHeight(true);
					}
					self.body.style.height = (self.$$layoutSlot.height() - newHeight) + "px";
				}
			}
			self.resizeListener.notifyObservers(onBoxToggle);
			clearTimeout(self.resizeTimeOut);
			self.ensureUILocker();
		}, 10);
	},
	onClickPicker: function(btn, event) {
		switch (btn.getAttribute("data-s-picker")) {
			case "s-site-top-pn-opener-link":
				this.toggleTopPanel();
				return false;
			case "s-page-designer-opener":
				var page;
				this.toggleTopPanel(false);
				if (this.mainPage.isFusionPage) {
					page = document.site.fusionGateway.activatedBook.selectedSheet;
				} else {
					page = document.site.getTopDialogPage();
					if (page) {
						page = page._content;
					}
				}
				page = page || this.mainPage;
				if (page) {
					page.designItem(true);
				}
				return false;
			case "s-site-jobs-viewer-opener-link":
				this.jobsViewer && this.jobsViewer.toggle();
				return false;
			case "s-site-sage":
				this.gotoHome();
				return false;
			case "$spygateway":
				if (event.ctrlKey) {
					this.openSpy();
				}
				return false;
		}
		return true;
	},

	closeSearchFieldPopup: function() {
		this.searchField.searchField && this.searchField.searchField._autoCompletePopup && this.searchField.searchField._autoCompletePopup.close();
	},
	toggleTopPanel: function(show, event) {
		if (show !== false && !this._topPanel) {
			var side = document.dir === 'rtl' ? 'right' : 'left';
			this._topPanelContainer.style[side] = $(this._topPanelOpener).offset()[side] + "px";
			this._topPanel = new(this._topPanelClass || SiteTopPanel)();
			this._topPanel.$prototype = this.$prototype;
			this._topPanel.page = this;
			this.emptyDom(this._topPanelContainer);
			this._topPanelContainer.style.display = "";
			document.site.emptyDom(this._topPanelContainer);
			this._topPanelContainer.style.display = "";
			this._topPanel.layoutSlot = this._topPanelContainer;
			this._topPanel.loadBox();
		} else {
			if (this._topPanel) {
				if (event && $(event.target).closest(this._topPanel.$$item).length) {
					return;
				}
				this._topPanel.closePanel();
			}
			delete this._topPanel;
		}
		if (this._topPanelOpener) {
			this.toggleClass(this._topPanelOpener, "s-open", this._topPanel != null);
		}
	},
	_appendTopPanelOpener: function(layoutSlot, topPanelClass) {
		this.layoutSlot.setAttribute("data-s-article", this.id); //ensure for compatibility office
		this._topPanelOpener = document.createElement("a");
		this._topPanelOpener.className = "s-site-top-pn-opener-link";
		this._topPanelOpener.setAttribute("href", "#");
		this._topPanelOpener.setAttribute("data-s-picker", "s-site-top-pn-opener-link");
		this._topPanelClass = topPanelClass;
		layoutSlot.appendChild(this._topPanelOpener);
	},
	openSpy: function() {
		this.spyGateway.open();
	},
	_renderHeader: function() {
		this.header = document.createElement("header");
		this.header.id = "s-site-header";
		this.setZIndex(this.header);
		this.layoutSlot.appendChild(this.header);

		this._topPanelContainer = document.createElement("div");
		this._topPanelContainer.id = "s-site-top-pn";
		this.layoutSlot.appendChild(this._topPanelContainer);

		var topLeft = document.createElement("div");
		topLeft.id = "s-site-header-top-left";
		this.header.appendChild(topLeft);

		this._sageLink = document.createElement("a");
		this._sageLink.id = "s-site-sage";
		this._sageLink.setAttribute("data-s-picker", "s-site-sage");
		topLeft.appendChild(this._sageLink);

		var div = document.createElement("div");
		div.id = "s-site-help";
		this.loadNewItem(topLeft.appendChild(div), {
			$id: "s-site-help-link",
			$bind: "$help",
			$category: "link",
			$noText: true,
			$skin: "s-site-help-link"
		});

		this._appendTopPanelOpener(topLeft);

		this.pageDesignerOpener = document.createElement("a");
		this.pageDesignerOpener.className = "s-page-designer-opener";
		this.pageDesignerOpener.style.display = "none";
		this.pageDesignerOpener.setAttribute("href", "#");
		this.pageDesignerOpener.setAttribute("data-s-picker", "s-page-designer-opener");
		topLeft.appendChild(this.pageDesignerOpener);

		var logoutSlot = document.createElement("div");
		logoutSlot.id = "s-site-logout";
		this.loadNewItem(topLeft.appendChild(logoutSlot), {
			$bind: "$logout",
			$category: "link",
			$skin: "s-user-profile-logout-top"
		});

		// top right
		var topRight = document.createElement("div");
		topRight.id = "s-site-header-top-right";
		this.header.appendChild(topRight);

		this.searchField = searchRequest.loadRequest(topRight);

		div = document.createElement("div");
		div.id = "s-site-home";
		this.loadNewItem(topRight.appendChild(div), {
			$bind: "$home",
			$category: "link",
			$noText: true,
			$skin: "s-site-home-link"
		});


		topRight = document.createElement("div");
		topRight.id = "s-site-header-top-right-fusion";
		topRight.style.display = "none";
		this.header.appendChild(topRight);

		div = document.createElement("div");
		div.id = "s-site-tab";
		this._newTabLink = document.createElement("a");
		this._newTabLink.className = "s-site-tab-link";
		this._newTabLink.setAttribute("href", "?representation=home.$dashboard");
		this._newTabLink.setAttribute("target", "_blank");
		div.appendChild(this._newTabLink);
		topRight.appendChild(div);
		// jobs viewer opener
		this._appendJobsViewerOpener(this.header);
	},
	_appendJobsViewerOpener: function(layoutSlot) {
		this._jobsViewerOpener = document.createElement("a");
		this._jobsViewerOpener.className = "s-jobs-viewer-opener";
		this._jobsViewerOpener.setAttribute("href", "#");
		this._jobsViewerOpener.setAttribute("data-s-picker", "s-site-jobs-viewer-opener-link");
		this._jobsViewerOpener.style.display = "none";

		/*var div = document.createElement('div');
         div.className = 's-jobs-viewer-opener-area';
         div.appendChild(this._jobsViewerOpener);*/
		layoutSlot.appendChild(this._jobsViewerOpener);
	},
	loadBox: function(siteOptions) {
		this._unregisterResizer = true;
		this.desktopPages = {};
		this.siteOptions = siteOptions;
		document.site = this;
		this.localize = locale.resources(module)();
		this.$autoFetch = false;
		this._childPageOffset = 1;
		this._initializePage();
		this.spyGateway = new SpyGateway();
		this._fieldWidths = siteOptions._fieldWidths || _fieldWidths;
		(document.controller = new(this.siteOptions.controllerClass || Controller)()).initialize();

		if (this.siteOptions.fusionGatewayClass) {
			this.fusionGateway = new this.siteOptions.fusionGatewayClass();
		}
		this.requestControllers = {
			http: require("syracuse-ui/lib/controller/httpController")
		};
		this.agents = {};
		this.externalAdapter = new ExternalAdapter();
		this._zIndex = 100;
		$(window).unload = function() {
			if (document.site) {
				document.site.unload();
			}
		};
		this.layoutSlot = (this.$$layoutSlot = $("#s-site"))[0];
		this.layoutSlot.style.display = "none";
		(this._eventListener = new EventListener()).load();
		this.$prototype = this.siteOptions.$prototype;
		(this.$prototype.$links = this.$prototype.$links || {}).$logout = {
			$title: this.localize.siteLogout,
			$method: "POST",
			$url: "/logout"
		};
		this.initializeNewItem(this, this.siteOptions.$item);
		this.layoutSlot.setAttribute("data-s-article", this.id);
		RawPage.prototype.loadBox.call(this);
		this.onWindowError();
		disconnectUtils.onWindowUnload(this);
		if (this._sageLink) {
			var homeMenu = this._getHomeMenu();
			if (homeMenu) {
				this._sageLink.title = homeMenu.mn.title;
				this._sageLink.setAttribute("href", homeMenu.mn.getAttribute("href"));
			}
		}
		return this;
	},
	onWindowError: function() {
		var self = this;
		window.onerror = function(errorMsg, url, lineNumber, error) {
			self.onUncaughtError(errorMsg, url, lineNumber, error);
		};
	},
	getBrowserName: function() {
		var N = navigator.appName,
			ua = navigator.userAgent;
		var M = ua.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
		M = M ? M[1] : N;
		return M;
	},
	/**
	 * Get browser name and version in one two length array
	 * --> [browser name, browser version]
	 */
	getBrowserInformation: function() {
		var N = navigator.appName,
			ua = navigator.userAgent,
			tem;
		var M = ua.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
		if (M && (tem = ua.match(/version\/([\.\d]+)/i)) != null) {
			M[2] = tem[1];
		}
		M = M ? [M[1], M[2]] : [N, navigator.appVersion, '-?'];
		return M;
	},
	getBrowserVersion: function() {
		var N = navigator.appName,
			ua = navigator.userAgent,
			tem;
		var M = ua.match(/(opera|chrome|safari|firefox|msie)\/?\s*(\.?\d+(\.\d+)*)/i);
		if (M && (tem = ua.match(/version\/([\.\d]+)/i)) != null) {
			M[2] = tem[1];
		}
		M = M ? [M[1], M[2]] : [N, navigator.appVersion, '-?'];
		return M[1];
	},
	onUncaughtError: function(errorMsg, url, lineNumber, error) {
		if (errorMsg && errorMsg.indexOf("s-is-reload-requested") >= 0) {
			var onSourceLoading = sessionStorage.getItem("onSourceLoading") || 0;
			if (onSourceLoading < 2) {
				sessionStorage.setItem("onSourceLoading", ++onSourceLoading);
				document.location.reload(true);
			} else {
				document.site.showDiagnoses({
					$diagnoses: [{
						$severity: "fatal",
						$message: this.localize.site_src_reload_fail
					}]
				});
			}
		} else {
			var options;
			var self = this;
			if (self.mainPage) {
				options = {
					errorMsg: errorMsg,
					url: url,
					lineNumber: lineNumber,
					error: error,
					doEvent: function() {
						// diagnose component will be improved, with specific msg and stack properties
						var $diagnose = {};
						$diagnose.$message = options.errorMsg;
						$diagnose.$message += error ? "\nStack:\n" + error.stack : "";
						$diagnose.$severity = "error"; //"alert";
						self.showDiagnoses({
							$diagnoses: [$diagnose]
						});
					}
				};
				if (self.mainPage.externalAdapter)
					self.mainPage.externalAdapter.onUncaughtError(options);
			} else {
				//debugger; //TODO
			}
		}
	},
	onError: function(error) {
		this.onUncaughtError(error.message, error.fileName, error.lineNumber, error);
	},
	_cvgPageConverterMakePersistent: function($prototype, $article) {
		cvgPageConverter.makePersistent($prototype, $article);
	},
	_cvgPageConverterMakeVolatile: function($prototype, $article) {
		cvgPageConverter.makeVolatile($prototype, $article);
	},
	loadNewPage: function($itemPage) {
		var $pageCategory = ($itemPage.$representation.$article ? $itemPage.$representation.$article.$category : null) || $itemPage.$category;
		$pageCategory = $pageCategory || ($itemPage.$urlParts.$facet == "$dashboard" ? "dashboard" : "page");
		var item = new($itemPage.$pageCategoryClass || this.siteOptions.widgetsLibrary.pageCategories[$pageCategory] || this.siteOptions.widgetsLibrary.defaultPageCategory)();
		item.id = this._childPageOffset++;
		item.localize = this.localize;
		item.$pageCategory = $pageCategory;
		item.dialogWrapper = $itemPage.dialogWrapper;
		item.$authorUrl = $itemPage.$representation.$authorUrl;
		item.$urlParts = $itemPage.$urlParts;
		item.$facet = $itemPage.$urlParts.$facet;
		item.$isEditMode = $itemPage.$isEditMode || item.$facet == "$edit";
		if ($itemPage.vignetteField) {
			item.vignetteField = $itemPage.vignetteField;
			delete $itemPage.vignetteField;
		}
		var hackFusion = item.$facet.split("_");
		if (hackFusion.length > 1 && hackFusion[0] == "$fusion") {
			item.$isEditMode = true;
			item.$facet = hackFusion[1];
			item.$fusionPageMeta = $itemPage.$fusionPageMeta;
		}
		item.layoutSlot = $itemPage.layoutSlot;
		item.$prototype = $itemPage.$representation.$prototype;
		var $protoArticle = item.$prototype.$article;
		var $article = $itemPage.$representation.$article;
		if ($article) {
			delete $article.$menus;
			if ($article.$generatorVersion) {
				item.$sourcePrototype = helpers.object.clone(item.$prototype, true);
				this._cvgPageConverterMakeVolatile(item.$prototype, $article);
				if ($protoArticle && $protoArticle.$generatorVersion) {
					this._cvgPageConverterMakeVolatile(helpers.object.clone(item.$sourcePrototype, true), $protoArticle);
				}
			}
		} else {
			$article = $protoArticle;
			if ($article && $article.$generatorVersion) {
				this._cvgPageConverterMakeVolatile(item.$prototype, $article);
			}
		}
		$article = item.ensureDefaultArticle($article, item.$prototype);

		if (item.$prototype && !item.$prototype.$fusionBar && $protoArticle) {
			item.$prototype.$fusionBar = $protoArticle.$fusionBar;
			delete $protoArticle.$fusionBar;
		}
		if (item.$prototype.$menus) {
			$article.$menus = item.$prototype.$menus;
		} else {
			if ($protoArticle && $protoArticle.$menus) {
				$article.$menus = $protoArticle.$menus;
			}
		}
		/*if (item.$prototype && item.$prototype.$localization && item.$prototype.$hackLocalization) {
         localizationConverter.convertLocalization(item.$prototype, $article);
         }*/
		this.initializeNewItem(item, $article, $itemPage.boxParent);

		item.$item.externalAdapter = $itemPage.externalAdapter;
		item.$autoFetch = ($itemPage.$autoFetch !== false) && ($itemPage.initData == null);
		if ($itemPage.onBeforeLoadPage) {
			$itemPage.onBeforeLoadPage(item);
		}
		if ($itemPage.httpQuery && $itemPage.httpQuery.$urlParts) {
			item.$urlParams = $itemPage.httpQuery.$urlParts.params;
		}
		item.$views = $itemPage.$representation.$views;
		item.loadBox($itemPage.initData, $itemPage.$representation.$diagnoses);
		if ($itemPage.onAfterLoadPage) {
			$itemPage.onAfterLoadPage(item);
		}
		$itemPage.$pageCategoryClass = $itemPage.boxParent = $itemPage.layoutSlot = $itemPage.$representation = $itemPage.onBeforeLoadPage = $itemPage.onAfterLoadPage = $itemPage.dialogWrapper = null;

		return item;
	},

	registerDialogPage: function(dialog, add) {
		if (add) {
			if (!this._pageDialogs) {
				this._pageDialogs = [];
			}
			this._pageDialogs.push(dialog);
		} else {
			if (this._pageDialogs) {
				for (var ii = 0, jj = this._pageDialogs.length; ii < jj; ii++) {
					if (this._pageDialogs[ii] == dialog) {
						this._pageDialogs.splice(ii, 1);
						break;
					}
				}
			}
		}
	},
	getTopDialogPage: function() {
		if (this._pageDialogs && this._pageDialogs.length > 0) {
			return this._pageDialogs[this._pageDialogs.length - 1];
		}
		return null;
	},
	lockUI: function(delay, isLong) {
		var self = this;
		if (!self._uiLocker) {
			self._uiLocker = document.createElement('div');
			self._uiLocker.className = "s-uilocker";
			self.layoutSlot.appendChild(self._uiLocker);
		}
		self._uiLocker.style.display = "";
		self._uiLockerTimeout = setTimeout(function() {
			if (isLong) {
				if (!self._uiLockerOverlay) {
					self._uiLockerOverlay = document.createElement('div');
					self._uiLockerOverlay.className = "s-uilocker-overlay";
					self.layoutSlot.appendChild(self._uiLockerOverlay);
				}
				self._uiLockerOverlay.style.display = "";
			}
			self.ensureUILocker();
		}, (delay || 0) > 0 ? delay : 0);
	},
	ensureUILocker: function() {
		if (this._uiLocker && this._uiLocker.style.display !== "none") {
			this.setZIndex(this._uiLocker);
			var width = this.layoutSlot.clientWidth,
				height = this.layoutSlot.clientHeight;
			var top = 0;
			if (this.header && this.header.clientHeight) {
				top = this.header.clientHeight;
				height -= top;
			}
			this._uiLocker.style.top = top + "px";
			this._uiLocker.style.width = width + "px";
			this._uiLocker.style.height = height + "px";
			if (this._uiLockerOverlay) {
				var style = this._uiLockerOverlay.style;
				style.top = top + "px";
				style.left = this._uiLocker.style.left;
				style.width = width + "px";
				style.height = height + "px";
				this.setZIndex(this._uiLockerOverlay);
			}
		}
	},
	unlockUI: function() {
		if (this._uiLocker) {
			this._uiLocker.style.display = "none";
			this._uiLocker.style.width = "0px";
			this._uiLocker.style.width = "0px";
		}
		if (this._uiLockerOverlay) {
			this._uiLockerOverlay.display = "none";
			this._uiLockerOverlay.style.width = "0px";
			this._uiLockerOverlay.style.width = "0px";
		}
		if (this._uiLockerTimeout) {
			clearTimeout(this._uiLockerTimeout);
			delete this._uiLockerTimeout;
		}
	}
});

exports.load = function($item, $prototype) {
	return (new Site()).loadBox({
		widgetsLibrary: require('./widgetsLibrary'),
		fusionGatewayClass: require('syracuse-ui/lib/fusion/fusionGateway').FusionGateway,
		userProfileClass: require('./userProfile').UserProfile,
		$item: $item,
		$prototype: $prototype
	});
};