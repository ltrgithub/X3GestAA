"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DesktopPage = require("syracuse-ui/lib/page/desktopPage").DesktopPage;
var $legalPrototypeUrl = "/sdata/syracuse/collaboration/syracuse/$prototypes('licenseData.$query')";
var $eulaUrl = "/syracuse-ui/lib/site/help/legal/SAGE X3 EULA.pdf";
var $eulaDepsUrl = "/syracuse-main/html/main.html?url=/sdata/syracuse/collaboration/syracuse/copyrights?representation=copyright.$query&count&orderBy=name ASC";

var $warning = "Warning: This software is protected by the Intellectual Property Code, copyright laws and international treaties." +
	" Any improper use of the software, including any partial or total reproduction or distribution of the software or any use beyond the rights acquired on the software is strictly prohibited." +
	" Anyone not complying with these provisions shall be guilty of copyright infringement and will be liable to criminal penalties provided by the law.";

function LegalPage() {}

exports.LegalPage = helpers.defineClass(LegalPage, DesktopPage, {
	loadBox: function($prototype) {
		this.layoutSlot = document.createElement("div");
		this.$prototype = $prototype;
		this.$prototype.$properties.$copyright = {
			$type: "application/x-string",
			$isReadOnly: true
		};

		this.$prototype.$properties.$banner = {
			$type: "application/x-string"
		};

		this.$prototype.$properties.$warning = {
			$type: "application/x-string",
			$description: $warning
		};


		this.$prototype.$links = this.$prototype.$links || {};
		this.$prototype.$links.$eula = {
			$title: syra_local.legalEula,
			$url: ""
		};
		this.$prototype.$links.$eulaDeps = {
			$title: syra_local.legalDepsTitle,
			$description: syra_local.legalDepsDescription,
			$url: ""
		};
		this.$prototype.$links.$banner = {
			$isDisabled: true,
			$title: "Legal banner"
		};

		var $skin = "s-site-legal";

		this.$item = {
			$category: "page",
			$css: $skin + "-header",
			$title: syra_local.legalPageTitle,
			$layout: {
				$css: $skin + "-body",
				$layout: {
					$items: [{
						$category: "section",
						$isTitleHidden: true,
						$isEmptyVisible: true,
						$clientId: "s-legal-page-banner"
					}, {
						$isTitleHidden: true,
						$css: $skin + "-copyright-item",
						$bind: "$copyright"
					}, {
						$format: "cards",
						$isTitleHidden: true,
						$isPagerHidden: true,
						$isQuickDesignerDisabled: true,
						$isRowIndexVisible: false,
						$selectByRowIndex: false,
						$isMenuRecordHidden: true,
						$bind: "$resources",
						$skin: $skin + "-card",
						$layout: {
							$isTitleHidden: true,
							$items: [{
								$layoutType: "stack",
								$items: [{
									$isTitleHidden: true,
									$skin: $skin + "-version",
									$layout: {
										$layoutType: "row",
										$isFixedWidth: true,
										$widths: "*,*",
										$items: [{
											$bind: "product",
											$isTitleHidden: true,
											$isMenusHidden: true,
											$skin: $skin + "-version-item"
										}, {
											$bind: "productVersion",
											$skin: $skin + "-version-item",
											$isTitleHidden: true
										}]
									}
								}, {
									$isTitleHidden: true,
									$layout: {
										$layoutType: "row",
										$items: [{
											$isTitleHidden: true,
											$layout: {
												$layoutType: "stack",
												$items: [{
													$css: $skin + "-license-data",
													$bind: "serial"
												}, {
													$css: $skin + "-license-data",
													$bind: "licenseeName"
												}, {
													$css: $skin + "-license-data",
													$bind: "licenseeRegistrationNumber"
												}]
											}
										}, {
											$isTitleHidden: true,
											$layout: {
												$layoutType: "stack",
												$items: [{
													$css: $skin + "-license-data",
													$bind: "valEnd"
												}, {
													$css: $skin + "-license-data",
													$bind: "resellerName"
												}, {
													$css: $skin + "-license-data",
													$bind: "resellerRegistrationNumber"
												}]
											}
										}]
									}
								}]
							}]
						}

					}, {
						$isTitleHidden: true,
						$css: $skin + "-eula-slot",
						$layout: {
							$items: [{
								$isTitleHidden: true,
								$category: "field",
								$css: $skin + "-license-warning",
								$bind: "$warning"
							}, {
								$category: "link",
								$bind: "$eula"
							}, {
								$category: "link",
								$bind: "$eulaDeps"
							}]
						}
					}]
				}

			}
		};
		DesktopPage.prototype.loadBox.call(this);
	},
	applyChange: function(newData) {
		// append copyright data
		if (this.dataset && !this.dataset.$copyright) {
			newData.$copyright = syra_local.legalCopyright;
		}

		if (newData && newData.$resources && newData.$resources.length > 0) {
			for (var ii = 0, jj = newData.$resources.length; ii < jj; ii++) {
				newData.$resources[ii].productVersion = syra_local.legalProductVersionLabel + " " + newData.$resources[ii].productVersion;
			}
		}

		DesktopPage.prototype.applyChange.call(this, newData);

		// append banner
		this._appendBanner();
	},
	_appendBanner: function() {
		var bannerSlot = document.createElement("div");
		bannerSlot.className = "s-site-legal-banner-slot";
		var bannerItem = document.createElement("div");
		bannerItem.className = "s-site-legal-banner-item";
		bannerSlot.appendChild(bannerItem);

		this.idMap["s-legal-page-banner"].body.appendChild(bannerSlot);
		this.idMap["s-legal-page-banner"].setState({
			$isHidden: false
		});

		syra_site.dom.toggleClass(this.idMap["s-legal-page-banner"].domTitle, "s-disabled");
	},
	onMenuClick: function(menuItem) {
		if (menuItem.$bind == "$eula") {
			window.open($eulaUrl, "_blank");
			return false;
		}
		if (menuItem.$bind == "$eulaDeps") {
			window.open($eulaDepsUrl, "_blank");
			return false;
		}
		return true;
	}

});