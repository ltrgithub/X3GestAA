"use strict";
var helpers = require('syracuse-core/lib/helpers');
var DesktopPage = require("syracuse-ui/lib/page/desktopPage").DesktopPage;
var _$eulaUrl = "/syracuse-ui/lib/site/help/legal/SAGE X3 EULA.pdf";

function LegalPage() {}

exports.LegalPage = helpers.defineClass(LegalPage, DesktopPage, {
	loadBox: function($prototype) {
		this.isMenuBarDisabled = true;
		this.isFooterDisabled = true;
		this.layoutSlot = document.createElement("div");
		this.$prototype = $prototype;
		this.$prototype.$properties.$banner = {
			$type: "application/x-string"
		};

		this.$prototype.$links = this.$prototype.$links || {};
		this.$prototype.$links.$eula = {
			$title: syra_local.legalCopyright,
			$description: syra_local.legalEula,
			$target: "blank",
			$url: _$eulaUrl
		};
		this.$prototype.$links.$banner = {
			$isDisabled: true,
			$title: "Legal banner"
		};

		var $skin = "s-site-legal";

		this.$item = {
			$category: "page",
			$css: $skin + "-header",
			$title: syra_local.legalPageTitle,
			$layout: {
				$items: [{
					$format: "cards",
					$clientId: "s-legal-page-list",
					$addMaximize: false,
					$isTitleHidden: true,
					$isPagerHidden: true,
					$isQuickDesignerDisabled: true,
					$isRowIndexVisible: false,
					$selectByRowIndex: false,
					$isMenuRecordHidden: true,
					$bind: "$resources",
					$isHoverDisabled: true,
					$skin: $skin + "-card",
					renderRecordContent: function(record) {
						var head = document.createElement("div");
						head.className = "s-legal-item-head";
						var div = head.appendChild(document.createElement("div"));
						div.className = "s-legal-item-product";
						div.textContent = record.dataset.product;
						div = head.appendChild(document.createElement("div"));
						div.className = "s-legal-item-version";
						div.textContent = record.dataset.productVersion;
						record.body.appendChild(head);
						var $rows = [
							["serial", "valEnd"],
							["licenseeName", "resellerName"],
							["licenseeRegistrationNumber", "resellerRegistrationNumber"]
						];
						var tb = document.createElement("div");
						tb.className = "s-legal-item-body";
						for (var ii = 0, jj = $rows.length; ii < jj; ii++) {
							var $cells = $rows[ii];
							var row = document.createElement("div");
							row.className = "s-legal-item-row";
							for (var mm = 0, kk = $cells.length; mm < kk; mm++) {
								if (mm > 0) {
									row.appendChild(document.createElement("div")).className = "s-legal-item-field-sep";
								}
								var $bind = $cells[mm];
								var cell = document.createElement("div");
								cell.className = "s-legal-item-field-title";
								cell.textContent = record.$prototype.$properties[$bind].$title;
								row.appendChild(cell);
								cell = document.createElement("div");
								cell.className = "s-legal-item-field-value";
								record.page.loadNewItem(cell, {
									$bind: $bind,
									$inplace: true
								}, record);
								row.appendChild(cell);
							}
							tb.appendChild(row);
						}
						record.body.appendChild(tb);
					},
					$layout: {
						$items: []
					}

				}]
			}
		};
		DesktopPage.prototype.loadBox.call(this);
		var list = this.idMap["s-legal-page-list"];
		syra_site.dom.hide(list.topbar, true);

		var footer = document.createElement("div");
		footer.className = "s-legal-footer";
		this.layoutContent.domItem.appendChild(footer);

		this.loadNewItem(footer, {
			$category: "link",
			$skin: "s-site-legal-copyright",
			$bind: "$eula"
		});
	},
	applyChange: function(newData) {
		if (newData) {
			if (newData.$resources && newData.$resources.length > 0) {
				for (var ii = 0, jj = newData.$resources.length; ii < jj; ii++) {
					newData.$resources[ii].productVersion = syra_local.legalProductUpdateLabel + " " + newData.$resources[ii].productVersion;
				}
			}
			if (this.dataset && this.dataset.$copyright) {
				newData.$links = newData.$links || {};
				(newData.$links.$eula = newData.$links.$eula || {}).$title = this.dataset.$copyright;
			}
			DesktopPage.prototype.applyChange.call(this, newData);
		}
	},
	onMenuClick: function(menuItem) {
		if (menuItem.$bind == "$eula") {
			window.open(_$eulaUrl, "_blank");
			return false;
		}
		return true;
	}
});