"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');

function JobsViewer(){
}

exports.JobsViewer = helpers.defineClass(JobsViewer, null, {
    create: function(){
        var self = this;
        
        self.localize = locale.resources(module)();
        
        self.jobsCount = 0;
        
        // $$item
        self._item = document.createElement("div");
        self._item.className = "s-jobs-viewer";
        self.$$item = $(self._item);
        
        // header
        self._appendHeader();
        
        var container = document.createElement("div");
        container.className = "s-jobs-viewer-container";
        self._item.appendChild(container);
        
        // $$core
        self._core = document.createElement("div");
        self._core.className = "s-jobs-viewer-core";
        $(container).append(self.$$core = $(self._core));
        
        // append to site
        document.site.appendJobsViewer(self);
        
        self._bindEvents(true);
    },
    _appendHeader: function(){
        // header will show two informations : job type filtering and delete all button
        
        var self = this;
        
        // container
        self._header = document.createElement("div");
        self._header.className = "s-jobs-viewer-header";
        
        // type
        var div = document.createElement("div");
        div.className = "s-jobs-viewer-type";
        var select = document.createElement("a");
        select.className = "s-jobs-viewer-type-selector"
        
        self._header.appendChild(div);
        
        
        // delete all
        div = document.createElement("div");
        div.className = "s-jobs-viewer-clear";
        var cl = document.createElement("a");
        cl.className = "s-jobs-viewer-clear-btn";
        cl.textContent = self.localize.jv_clear;
        div.appendChild(cl);
        self._header.appendChild(div);
        
        self._item.appendChild(self._header);
    },
    updateHeader: function(operation, jobView){
        var self = this;
        switch (operation) {
            case "add":
                //TODO use jobView ?
                break;
            case "remove":
                //TODO use jobView ?
                break;
        }
    },
    _showTypeSelector: function($views){
        //TODO
    },
    _onJobTypeChange: function(jobTypeBtn){
        var self = this;
        //TODO
    },
    _bindEvents: function(bind){
        var self = this;
        if (self.$$item) {
            if (bind) {
                self.$$item.delegate("a.s-jobs-viewer-clear-btn", "click", function(){
                    var ids = Object.keys(self.jobsViews);
                    for (var ii = 0; ii < ids.length; ii++) {
                        self.onJobViewRemove(self.jobsViews[ids[ii]]);
                    }
                });
            }
            else {
                self.$$item.undelegate();
            }
        }
    },
    appendJobView: function(jobView){
        var self = this;
        self.jobsViews = self.jobsViews || {};
        self.jobsViews[jobView.job.params.uuid] = jobView;
        self._core.appendChild(jobView.$$item[0]);
        self._updateJobsViewCount('add');
        self.toggle(true);
    },
    _updateJobsViewCount: function(operation){
        switch (operation) {
            case 'add':
                document.site._jobsViewerOpener.textContent = ++this.jobsCount;
                break;
            case 'remove':
                document.site._jobsViewerOpener.textContent = --this.jobsCount;
                break;
        }
    },
    onJobViewRemove: function(jobView){
        var self = this;
        // alert if job still in progress 
        if (jobView._progressValue && jobView._progressValue.className == "s-job-view-progress-value") {
            var options = {};
            options.$message = (jobView.localize.job_remove_msg.replace("{jobTitle}", jobView._title.textContent)).replace("{jobKind}", jobView.job.params.kindLabel || jobView.job.params.kind || "");
            options.$message.replace("{jobTitle}", jobView._title.textContent);
            options.$type = "warning";
            options.$buttons = "yesno";
            options.$autoClose = 25000;
            options.$default = "no";
            options.$title = jobView.localize.job_remove_title;
            options.callback = function(response, closedBy){
                var close = closedBy == "no" || closedBy == "auto";
                if (!close) {
                    self._removeJobView(jobView);
                }
                return true;
            }
            document.site.showMessage(options);
        }
        else {
            self._removeJobView(jobView);
        }
    },
    _removeJobView: function(jobView){
        var self = this;
        jobView.$$item.remove();
        self._updateJobsViewCount('remove');
        if (self.jobsCount == 0) {
            self._item.style.display = "none";
            document.site._jobsViewerOpener.style.display = "none";
        }
    },
    toggle: function(show, event){
        var self = this;
        switch (show) {
            case true:
                self._item.style.display = '';
                document.site.setZIndex(self._item);
                //self._core.style.display = "block";
                document.site._jobsViewerOpener.style.display = "";
                break;
            case false:
                if (event && ($(event.target).hasClass('s-job-view-remove-btn') || $(event.target).closest(self.$$item).length)) {
                    return;
                }
                //self._core.style.display = "none";
                self._item.style.display = "none";
                break;
            default:
                //self._core.style.display = !self._core.style.display || self._core.style.display == "block" ? "none" : "block";
                self._item.style.display = !self._item.style.display || self._item.style.display == "block" ? "none" : "block";
        }
    },
    _toggleViewerCore: function(){
        //TODO : animation
    },
    dispose: function(){
        this._bindEvents(false);
    }
});
