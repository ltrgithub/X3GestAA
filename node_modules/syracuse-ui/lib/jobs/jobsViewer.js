"use strict";
var helpers = require('syracuse-core/lib/helpers');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;
var jobsViewerPrototype = require("./setting/jobsViewerPrototype");
var jobsViewerArticle = require("./setting/jobsViewerArticle");

function JobsPage() {

}

exports.JobsPage = helpers.defineClass(JobsPage, RawPage, {
	dispose: function() {
		RawPage.prototype.dispose.call(this);
	},
	addJob: function(jobHandler) {
		this.jobs = this.jobs || {};
		this.jobs[jobHandler.params.uuid] = jobHandler;
		this._updateJobsViewCount('add');
	},
	removeJob: function(uuid) {
		if (this.jobs) {
			this.jobs[uuid] && this.jobs[uuid].dispose && this.jobs[uuid].dispose();
			this._updateJobsViewCount('remove');
		}
	},
	updateJobsTypesList: function(jobType, add) {
		this.jobsTypes = this.jobsTypes || {};
		if (add) {
			var types = Object.keys(this.jobsTypes);
			if (types.length == 0) {
				this.jobsTypes[jobType] = {
					count: 1
				};
			} else {
				if (this.jobsTypes[jobType]) {
					this.jobsTypes[jobType].count++;
				} else {
					this.jobsTypes[jobType] = {
						count: 1
					};
				}
			}
		} else {
			this.jobsTypes[jobType].count--;
		}
	},
	getJobsTypesEnum: function() {
		if (this.jobsTypes) {
			var jobsTypesEnum = [];
			var keys = Object.keys(this.jobsTypes);
			for (var ii = 0; ii < keys.length; ii++) {
				if (this.jobsTypes[keys[ii]].count > 0) {
					jobsTypesEnum.push({
						$value: ii + 1,
						$title: keys[ii]
					});
				}
			}

			if (jobsTypesEnum.length > 1) {
				jobsTypesEnum.push({
					$value: ii + 1,
					$title: syra_local.jv_type_default
				});
			}
			return jobsTypesEnum;
		} else {
			return [{
				$value: "1",
				$title: syra_local.jv_type_default
			}];
		}
	},
	loadBox: function() {
		var $skin = "s-jobs-viewer";
		this.$prototype = jobsViewerPrototype.getPrototype();
		this.$prototype.$properties.$jobType.$value.$enum = this.getJobsTypesEnum();

		//$choiceLayout: this.selectedTypeValue || "1",
		this.$item = jobsViewerArticle.getItem();

		this.layoutSlot = document.createElement("div");
		this.layoutSlot.className = $skin;
		syra_site.layoutSlot.appendChild(this.layoutSlot);

		RawPage.prototype.loadBox.call(this);
	},
	onMenuClick: function(menuItem) {
		var self = this,
			job;
		switch (menuItem.$sourceBind) {
			case "$clearJob":
				self._onJobViewRemove(menuItem, menuItem.$clearForced);
				break;
			case "$clearList":
				self._onClearList(menuItem);
				break;
			case "$download":
				if ((job = self.jobs[menuItem.articleParent.$uuid])) {
					syra_controller.sendRequest(null, job.buildReqOpt("GET", menuItem.$url, job.params.mime), function(data, response, $url) {
						window.open(menuItem.$url, "_blank");
					}, function(error, httpquery) {
						job.onError(error, true);
					});
				} else {
					window.open(menuItem.$url, "_blank");
				}
				break;
			case "$cancel":
				var callback = function() {
					self.jobs[menuItem.articleParent.$uuid].onClientRelease();
				};
				self._showMessage(menuItem, callback);
				break;
			case "$abort":
			case "$suspend":
			case "$resume":
				var callback = function() {
					self.jobs[menuItem.articleParent.$uuid].onClientRelease(menuItem.$url, menuItem.$method);
				};
				self._showMessage(menuItem, callback);
				break;
		}
		return false;
	},

	getRecordsList: function(type) {
		var self = this;
		if (type) {
			var records = self.boundFields.$jobDetails[0].records;
			var list = [];
			for (var mm = 0, pp = records.length; mm < pp; mm++) {
				if ((records[mm].dataset.jobType == type) || (type == syra_local.jv_type_default)) {
					list.push(records[mm]);
				}
			}
			return list;
		} else {
			return (self.boundFields && self.boundFields.$jobDetails[0].records) || [];
		}
	},
	_hasJobInProgress: function(records) {
		for (var ii = 0, jj = records.length; ii < jj; ii++) {
			var $progressValue = records[ii].$menus && records[ii].$menus.$progressValue;
			if ($progressValue && $progressValue.$value == "on") {
				return true;
			}
		}
	},
	getRecord: function(uuid) {
		return this.boundFields && this.boundFields.$jobDetails[0].recordsMap[uuid] || null;
	},
	_onClearList: function(menuItem) {
		var self = this;
		// get selected job type
		var selectedValue = self.boundFields.$jobType[0].currentValue;
		var $enum = self.boundFields.$jobType[0].$enum;
		var selectedTitle;
		for (var ii = 0, jj = $enum.length; ii < jj; ii++) {
			if ($enum[ii].$value == selectedValue) {
				selectedTitle = $enum[ii].$title;
				break;
			}
		}
		var list = self.getRecordsList(selectedTitle);
		if (self._hasJobInProgress(list)) {
			self._showMessage(menuItem, function() {
				self._clearList(list);
			});
		} else {
			self._clearList(list);
		}
	},
	_clearList: function(list) {
		for (var ii = 0, jj = list.length; ii < jj; ii++) {
			var menu = list[ii].menuItems.$clearJob[0];
			menu.$clearForced = true;
			syra_menus.click.menuItem(menu);
		}
	},
	_updateJobsViewCount: function(operation) {
		switch (operation) {
			case 'add':
				syra_site._jobsViewerOpener.style.display = "";
				if (this.domItem) {
					this.domItem.style.display = "";
					syra_site.dom.setZIndex(this.domItem);
				}
				syra_site._jobsViewerOpener.textContent = ++this.jobsCount;
				break;
			case 'remove':
				syra_site._jobsViewerOpener.textContent = --this.jobsCount;
				break;
		}
	},
	_onJobViewRemove: function(menuItem, forced) {
		var self = this;

		// clear forced (in case of list clear action)
		if (forced) {
			self._removeJobView(menuItem.articleParent);
			return;
		}

		// alert if job in progress
		if (self._hasJobInProgress([menuItem.articleParent])) {
			self._showMessage(menuItem, function() {
				self._removeJobView(menuItem.articleParent);
			});
		} else {
			self._removeJobView(menuItem.articleParent);
		}
	},
	_removeJobView: function(record) {
		this.updateJobsTypesList(this.jobs[record.dataset.$uuid].params.kind);
		this.removeJob(record.$uuid);
		var list = this.getRecordsList(syra_local.jv_type_default);

		var newData = {};
		var $enum = this.getJobsTypesEnum();
		if ($enum.length == 1) {
			var $jobType = $enum[0].$value;
		}

		newData = {
			$jobType: $jobType,
			$jobDetails: [{
				$uuid: record.$uuid,
				$index: record.getRecordIndex(),
				$isDeleted: true
			}],
			$properties: {
				$jobType: {
					$value: {
						$enum: $enum
					}
				}
			}
		};
		this.applyChange(newData);

		// if one type left, show previously hidden jobs views (useful in case of previous filtering)
		if ($enum.length == 1) {
			var records = this.getRecordsList();
			for (var ii = 0, jj = records.length; ii < jj; ii++) {
				records[ii].domItem.style.display = "";
			}
		}

		if (this.jobsCount == 0) {
			this.domItem.style.display = "none";
			syra_site._jobsViewerOpener.style.display = "none";
		}
	},
	_showMessage: function(menuItem, cbck) {
		this.msgBoxId = syra_diagnose.showBox({
			$message: (syra_local['job_' + menuItem.$bind.slice(1) + '_msg'].replace("{jobTitle}", menuItem.articleParent.dataset.jobTitle)).replace("{jobKind}", menuItem.articleParent.dataset.jobType),
			$title: syra_local['job_' + menuItem.$bind.slice(1) + '_title'],
			$type: "warning",
			$buttons: "yesno",
			$isAutoClose: 25000,
			$default: "no",
			callback: function(response, closedBy) {
				var close = closedBy == "no" || closedBy == "auto";
				if (!close) {
					cbck();
				}
				return true;
			}
		}).id;
	},
	notifyDataChange: function(field, value) {
		var title;
		for (var ii = 0, jj = field.$enum.length; ii < jj; ii++) {
			if (field.$enum[ii].$value == value) {
				title = field.$enum[ii].$title;
				break;
			}
		}
		if (title) {
			var records = this.getRecordsList();
			for (var mm = 0, pp = records.length; mm < pp; mm++) {
				records[mm].domItem.style.display = ((records[mm].dataset.jobType == title) || (title == syra_local.jv_type_default)) ? "" : "none";
			}
		}
	},
	applyChange: function(newData, closeMsgBox, newRecord) {
		// handle jobs types list update in case of new record
		// assuming there is only one record change
		if (newRecord && newData.$jobDetails && newData.$jobDetails.length <= 1) {
			var $prevEnum = this.dataset && this.dataset.$properties && this.dataset.$properties.$jobType.$value.$enum;
			if ($prevEnum && $prevEnum.length > 0) {
				var recordToHide;
				// if there were only one job type in the jobs types list
				if ($prevEnum.length == 1) {
					// if new job type record, switch selected job type to "all types" value
					if (newData.$jobDetails[0].jobType != $prevEnum[0].$title) {
						newData.$jobType = this.getJobsTypesEnum().length;
					}
					// otherwise, there is nothing to do 
				}
				// if there were more than one job type in the jobs types list
				else {
					// if a specific job type selected (different from "all types")

					// if new job type is different from the selected job type, it has to be hidden
					if ($prevEnum[this.dataset.$jobType - 1].$title != newData.$jobDetails[0].jobType) {
						recordToHide = true;
					}
				}
			}
		}

		RawPage.prototype.applyChange.call(this, newData);

		// css hack in order for text-overflow:ellipsis, white-space:nowrap, overflow:hidden style properties to be effective
		var records = this.boundFields.$jobDetails[0].records;
		for (var ii = 0, jj = records.length; ii < jj; ii++) {
			var record = records[ii];
			var $fields = Object.keys(record.boundFields);
			for (var mm = 0, pp = $fields.length; mm < pp; mm++) {
				var field = record.boundFields[$fields[mm]];
				if (field[0].domValueSlot && field[0].domValueSlot.className.indexOf("s-job-view-info-field") != -1) {
					field[0].domValueSlot.style.display = "";
				}
			}
		}

		// show diagnose block in jobview if any diagnoses
		if (newData.$jobDetails && newData.$jobDetails.length > 0) {
			for (var pp = 0, hh = newData.$jobDetails.length; pp < hh; pp++) {
				if (newData.$jobDetails[pp].jobDiagnoses && newData.$jobDetails[pp].jobDiagnoses.length > 0) {
					var record = this.getRecord(newData.$jobDetails[pp].$uuid);
					if (record) {
						var keys = Object.keys(record.idMap);
						for (var mm = 0, kk = keys.length; mm < kk; mm++) {
							var item = record.idMap[keys[mm]];
							if (item.$item && item.$item.$isDiagBox) {
								item.setState({
									$isHidden: false
								});
							}
						}
					}
				}
			}
		}

		// if success, close any message box opened from jobsViewer
		closeMsgBox && syra_diagnose.closeBox("no", this.msgBoxId);

		// hide record if necessary (according to jobs types list filtering)
		if (recordToHide) {
			this.getRecord(newData.$jobDetails[0].$uuid).domItem.style.display = "none";
		}
		this.ensurePageVisibility();
	},
	close: function() {

	},
	toggle: function(show) {
		var self = this;
		show = show || !self.popupPicker;
		if (self.domItem) {
			if (show) {
				if (!self.popupPicker) {
					self.layoutSlot.style.display = "";
					self.popupPicker = syra_site.dialogManager.openPopup(self, {
						content: self,
						slot: self.layoutSlot,
						position: {
							my: "right top",
							at: "right bottom",
							of: $(syra_site._jobsViewerOpener)
						},
						onClose: function() {
							setTimeout(function() {
								if (self.layoutSlot) {
									self.layoutSlot.style.display = "none";
								}
								self.popupPicker = null;
							}, 200);
						}
					});
				}
			} else {
				self.popupPicker && self.popupPicker.close();
			}
		}
	}
});