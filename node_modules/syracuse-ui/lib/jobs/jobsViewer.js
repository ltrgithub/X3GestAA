"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var RawPage = require("syracuse-ui/lib/page/rawPage").RawPage;

function JobsViewer(){
}

exports.JobsViewer = helpers.defineClass(JobsViewer, RawPage, {

    updateJobsTypesList: function(jobType, add){
        var self = this;
        self.jobsTypes = self.jobsTypes || {};
        if (add) {
            var types = Object.keys(self.jobsTypes);
            if (types.length == 0) {
                self.jobsTypes[jobType] = {
                    count: 1
                };
            }
            else {
                if (self.jobsTypes[jobType]) {
                    self.jobsTypes[jobType].count++;
                }
                else {
                    self.jobsTypes[jobType] = {
                        count: 1
                    };
                }
            }
        }
        else {
            self.jobsTypes[jobType].count--;
        }
    },
    _getJobsTypesEnum: function(){
        var self = this;
        if (self.jobsTypes) {
            var jobsTypesEnum = [];
            var jobsTypes = Object.keys(self.jobsTypes);
            for (var ii = 0; ii < jobsTypes.length; ii++) {
                jobsTypesEnum.push({
                    $value: ii + 1,
                    $title: jobsTypes[ii]
                });
            }
            if (jobsTypes.length > 1) {
                jobsTypesEnum.push({
                    $value: ii + 1,
                    $title: "all jobs"
                })
            }
            return jobsTypesEnum;
        }
        else {
            return [{
                $value: "1",
                $title: "all jobs"
            }]
        }
    },
    drawBox: function(){
        RawPage.prototype.drawBox.call(this);
    },
    loadBox: function(){
    
        var $skin = "s-jobs-viewer";
        var self = this;
        
        self.$prototype = {
            $properties: {
                $jobType: {
                    $type: "application/x-choice",
                    $title: "List of",
                    $value: {
                        $type: "application/x-integer",
                        $enum: self._getJobsTypesEnum()
                    },
                    $capabilities: "sort,filter"
                },
                $jobDetails: {
                    "$type": "application/x-array",
                    $item: {
                        $properties: {
                            jobTitle: {
                                $title: "Job title",
                                $type: "application/x-string",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            phase: {
                                $type: "application/x-string",
                                $title: "Phase",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            phaseDetail: {
                                $type: "application/x-string",
                                $title: "Phase detail",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            progress: {
                                $type: "application/x-decimal",
                                $title: "Progress",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            elapsedSeconds: {
                                $type: "application/x-integer",
                                $title: "Elapsed seconds",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            remainingSeconds: {
                                $type: "application/x-integer",
                                $title: "Elapsed seconds",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            pollingMillis: {
                                $type: "application/x-integer",
                                $title: "Polling millis",
                                $capabilities: "sort,filter,alphaTab"
                            },
                            progressIcon: {
                                $type: "application/x-string",
                                $title: "Progress icon"
                            },
                            diagnoseError: {
                                $type: "application/x-string",
                                $title: "diagnose error"
                            },
                            diagnoseFatal: {
                                $type: "application/x-string",
                                $title: "diagnose fatal"
                            },
                            diagnoseWarning: {
                                $type: "application/x-string",
                                $title: "diagnose warning"
                            },
                            diagnoseInfo: {
                                $type: "application/x-string",
                                $title: "diagnose info"
                            },
                            diagnoseSuccess: {
                                $type: "application/x-string",
                                $title: "diagnose success"
                            }
                        },
                        $links: {
                            $clearJob: {
                                $title: "Remove from the list"
                            }
                        }
                    }
                }
            },
            $links: {
                $clearList: {
                    $title: "Clear this list"
                }
            }
        };
        
        //$choiceLayout: self.selectedTypeValue || "1",
        
        self.$item = {
            $category: "section",
            $skin: $skin + "-h1",
            $isTitleHidden: true,
            $layout: {
                $items: [{
                    $category: "section",
                    $isTitleHidden: true,
                    $layout: {
                        $layoutType: "row",
                        $autoSize: true,
                        $items: [{
                            $css: $skin + "-types-list",
                            $category: "field",
                            $bind: "$jobType",
                            $isEditMode: true,
                            $format: "$combo",
                            $isTopLabelAlignment: false
                        }, {
                            $category: "link",
                            $bind: "$clearList"
                        }]
                    }
                }, {
                    $title: "Jobs",
                    $skin: $skin + "-head",
                    $css: $skin + "-head",
                    $format: "cards",
                    $bind: "$jobDetails",
                    $isTitleHidden: true,
                    $isPagerHidden: true,
                    $isQuickDesignerEnabled: false,
                    $isMenuRecordHidden: true,
                    $cards: {
                        $category: "section",
                        $layout: {
                            $items: [{
                                $category: "section",
                                $isTitleHidden: true,
                                $layout: {
                                    $layoutType: "row",
                                    $autoSize: true,
                                    $css: $skin + "-card",
                                    $items: [{
                                        $layoutType: "stack",
                                        $items: [{
                                            $bind: "$jobPrintIcon",
                                            $isTitleHidden: true,
                                            $category: "link",
                                            $noText: true,
                                            $skin: "s-job-view-type-print"
                                        }, {
                                            $bind: "$jobOperationIcon",
                                            $isTitleHidden: true,
                                            $category: "link",
                                            $noText: true,
                                            $skin: "s-job-view-type-operation"
                                        }]
                                    }, {
                                        $isTitleHidden: true,
                                        $layout: {
                                            $layoutType: "stack",
                                            $items: [{
                                                $bind: "jobTitle",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }, {
                                                $bind: "phase",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            
                                            }, {
                                                $bind: "phaseDetail",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }]
                                        }
                                    }, {
                                        $isTitleHidden: true,
                                        $layout: {
                                            $layoutType: "stack",
                                            $items: [{
                                                $bind: "progressIcon",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }, {
                                                $bind: "progress",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }, {
                                                $bind: "elapsedSeconds",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }, {
                                                $bind: "remainingSeconds",
                                                $isTitleHidden: true,
                                                $isHidden: true
                                            }]
                                        }
                                    }, {
                                        $isTitleHidden: true,
                                        $skin: "s-record-actions",
                                        $category: "menus",
                                        $layout: {
                                            "$layoutType": "row",
                                            "$autoSize": true,
                                            $items: [{
                                                "$isMenusBag": true,
                                                "$category": "menus",
                                                "$title": "-",
                                                "$isTitlePicker": true,
                                                "$isBoxCollapsable": true,
                                                "$isPopupContent": true,
                                                "$skin": "s-record-menus",
                                                "$itemSkin": "s-field-menus-link"
                                            }]
                                        }
                                    }, {
                                        $bind: "$clearJob",
                                        $isTitleHidden: true,
                                        $category: "link",
                                        $noText: true,
                                        $skin: "s-job-view-remove-btn"
                                    }]
                                }
                            }, {
                                $isTitleHidden: true,
                                $layout: {
                                    $layoutType: "stack",
                                    $items: [{
                                        $bind: "diagnoseFatal",
                                        $isTitleHidden: true,
                                        $isHidden: true
                                    }, {
                                        $bind: "diagnoseError",
                                        $isTitleHidden: true,
                                        $isHidden: true
                                    }, {
                                        $bind: "diagnoseWarning",
                                        $isTitleHidden: true,
                                        $isHidden: true
                                    }, {
                                        $bind: "diagnoseInfo",
                                        $isTitleHidden: true,
                                        $isHidden: true
                                    }, {
                                        $bind: "diagnoseSuccess",
                                        $isTitleHidden: true,
                                        $isHidden: true
                                    }]
                                }
                            }]
                        }
                    }
                }]
            }
        };
        
        self.layoutSlot = document.createElement("div");
        self.layoutSlot.className = $skin;
        document.site.layoutSlot.appendChild(self.layoutSlot);
        
        RawPage.prototype.loadBox.call(self);
    },
    notifyDataChange: function(field, value){
    
        /*if (field.$item.$bind == "$search") {
         // only if search field not empty
         if (value.replace(/\s+/g, '') !== "") {
         this.dataset[field.$item.$bind] = value;
         this.menuItems["$searchLink"][0].$url = this.$prototype.$links.$searchLink.$url + "";
         document.controller.executeMenu(this.menuItems["$searchLink"][0]);
         }
         }*/
    },
    onMenuClick: function(menuItem){
        return false;
    },
    applyChange: function(newData){
    
        RawPage.prototype.applyChange.call(this, newData);
    },
    toggle: function(){
        /*if (this.$$item.is(":visible")) {
         this.$$item.hide();
         }*/
        /*
         else {
         this.$$item.show();
         }*/
    },
    dispose: function(){
        RawPage.prototype.dispose.call(this);
    }
});
