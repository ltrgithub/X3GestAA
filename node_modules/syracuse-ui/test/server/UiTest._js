"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var tracer = console.log;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

var db;
asyncTest("init environment", function(_) {
	//
	require('syracuse-main/lib/syracuse').startServers(_, 3004);

	//
	start();
});

var tabUrl = [
	'http://localhost:3004/syracuse-main/html/main.html?url=%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dgrid'
];

var ph = phantom.create(_);

tabUrl.forEach(function(url) {
	asyncTest("launch all ui test page " + url, function(_) {
		var page = ph.createPage(_);

		// test grid
		var status = page.open(url, {
			headers: {
				Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
			}
		}, _);
		strictEqual(status, "success", "Page open success");
		// simple evaluate
		var cls = page.evaluate(function() {
			return syra_site.mainPage.runUnits();
		}, _);

		cls.forEach(function(item) {
			if (item.assertResult)
				strictEqual(item.assertResult.success, true, item.assertResult.message);
		});

		start();
	});
});

asyncTest("stop", 0, function(_) {
	ph.exit(_);

	doStop = true;

	start();
});