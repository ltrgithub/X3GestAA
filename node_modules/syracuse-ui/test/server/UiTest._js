"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var tracer = console.log;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

var db;
asyncTest("init database", 1, function(_) {
	//
	db = adminTestFixtures.initializeTestEnvironnement(_);
	ok(db != null, "Environnement initialized");
	//
	start();
});

asyncTest("launch all ui test page", 3, function(_) {
	var ph = phantom.create(_);
	var page = ph.createPage(_);
	// test grid
	var status = page.open("http://localhost:3004/syracuse-main/html/main.html?url=%3Frepresentation%3Ds-uitest.%24test%26group%3Dgrid", {
		headers: {
			Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
		}
	}, _);
	strictEqual(status, "success", "Page open success");
	// simple evaluate
	var cls = page.evaluate(function() {
		return syra_site.mainPage.runUnits();
	}, _);
	console.log(require('util').inspect(cls));

	ph.exit(_);

	start();
});

asyncTest("stop", 0, function(_) {
	doStop = true;

	start();
});