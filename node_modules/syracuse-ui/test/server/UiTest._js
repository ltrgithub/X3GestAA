"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var tracer = console.log;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

var ph;
asyncTest("init environment", function(_) {
	//
	require('syracuse-main/lib/syracuse').startServers(_, 3004);
	ph = phantom.create(_);

	//
	start();
});

var tabUrl = [{
	"Array Grid": 'syracuse-main/html/main.html?url=%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dgrid'
}, {
	"Array Grid Card": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dgridcards'
}, {
	"Array Card": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dcards'
}, {
	"Array Selection": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dselection'
}, {
	"Array Graph": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_array%26category%3Dselection'
}, {
	"Array Tree": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_tree'
}, {
	"Array single": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Darray_single'
}, {
	"Fields": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dfield_simple'
}, {
	"Fields Binary": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dfield_binary'
}, {
	"Fields Editor": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dfield_editor'
}, {
	"Fields Child object": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dfield_child'
}, {
	"Fields icon": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dfield_icon'
}, {
	"Misc Formula": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dmisc_formula'
}, {
	"Misc Select Printer": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24%24test%26name%3Dmisc_selectPrinter'
}, {
	"Misc Process": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dprocess_process'
}, {
	"Misc Diagnose": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dmisc_diagnoseCenter'
}, {
	"Misc Trackers": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dtrackers_trackers'
}, {
	"Misc Dynamic Parameters": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dmisc_parameters'
}, {
	"Misc Macro": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dmacros_macros'
}, {
	"Misc Layout": 'syracuse-main/html/main.html?url=http%3A%2F%2Flocalhost%3A8124%2Fsyracuse-main%2Fhtml%2Fmain.html%3Frepresentation%3Ds-uitest.%24test%26name%3Dmisc_layout'
}];



for (var i = 0; i < tabUrl.length; i++) {

	var key = Object.keys(tabUrl[i])[0];
	var url = "http://localhost:3004/" + tabUrl[i][key];
	asyncTest("launch all ui test page array " + key, function(_) {

		ok(true, "test ui page " + key);
		var page = ph.createPage(_);
		// test grid
		var status = page.open(url, {
			headers: {
				Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
			}
		}, _);
		strictEqual(status, "success", "Page open success");
		// simple evaluate
		var cls = page.evaluate(function() {
			return syra_site && syra_site.mainPage.runUnits();
		}, _);

		cls && cls.forEach(function(unit) {
			if (unit.assertResult) {
				unit.assertResult.forEach(function(assert) {
					strictEqual(assert.success, true, assert.message);
				});
			}
		});
		page.close();

		start();
	});
};

asyncTest("stop", 0, function(_) {
	ph.exit(_);

	doStop = true;

	start();
});