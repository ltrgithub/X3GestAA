"use strict";

var config = require('config'); // must be first syracuse require
var port = (config.unit_test && config.unit_test.serverPort) || 3004;
var baseUrl = "http://localhost:" + port;
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var tracer = console.log;

QUnit.module(module.id, {});

var db;
asyncTest("init database", 1, function(_) {
	db = adminTestFixtures.initializeTestEnvironnement(_);
	ok(db != null, "Environnement initialized");
	start();
});

asyncTest("simple page open", 3, function(_) {
	var ph = phantom.create(_);
	var page = ph.createPage(_);
	// open
	var status = page.openWait(baseUrl + "/syracuse-main/html/main.html?url=%2Fsdata%2Fsyracuse%2Fcollaboration%2Fsyracuse%2Fapplications%3Frepresentation%3Dapplication.%24query", {
		headers: {
			Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
		}
	}, _);
	strictEqual(status, "success", "Page open success");
	// simple evaluate
	var cls = page.evaluate(function() {
		return document.title;
	}, _);
	strictEqual(cls, "Liste d'applications (Super administrator) (Syracuse administration)", "Got page title ok before click");
	//
	/*   page.onResourceReceived = function(res) {
        console.log("Resource received", res);
    }*/
	var cls = page.evalWait(function() {
		// get 'new application' button		
		var $$actBtn = $('a[title="Nouvelle application"]');

		// trigger click event
		var e = document.createEvent('MouseEvents');
		e.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
		$$actBtn[0].dispatchEvent(e);

		// return page title
		return true;
	}, _);
	var cls = page.evaluate(function() {
		return document.title;
	}, _);
	strictEqual(cls, "Applications - edit (Super administrator) (Syracuse administration)", "Got page title ok after click");
	//
	page.close(_);
	ph.exit(_);

	start();
});

asyncTest("finish test", 1, function(_) {
	ok(true);
	start();
}); // Dummy comment to clean up rollout repository #6948