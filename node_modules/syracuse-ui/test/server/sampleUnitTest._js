"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var tracer = console.log;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

var db;
asyncTest("init database", 1, function(_) {
	//
	db = adminTestFixtures.initializeTestEnvironnement(_);
	ok(db != null, "Environnement initialized");
	//
	start();
});

asyncTest("simple page open", 1, function(_) {
	var ph = phantom.create(_);
	var page = ph.createPage(_);
	var status = page.open("http://localhost:3004/syracuse-main/html/main.html?url=%2Fsdata%2Fsyracuse%2Fcollaboration%2Fsyracuse%2Fapplications%3Frepresentation%3Dapplication.%24query", {
		headers: {
			Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
		}
	}, _);
	strictEqual(status, "success", "Page open success");
	setTimeout(~_, 10000);
	var cls = page.evaluate(function() {
		//return document.getElementsByTagName('body')[0].innerText;
		//        var art = document.querySelector(".s-page");
		//        return (art || {}).className;
		return document.innerHTML;
	}, _);
	strictEqual(cls, "s-page", "Got s-page class ok");
	//    tracer && tracer("Content : " + body);

	//
	ph.exit(_);

	start();
});

asyncTest("stop", 0, function(_) {
	doStop = true;

	start();
});