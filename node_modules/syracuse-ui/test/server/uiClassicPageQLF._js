"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var phantom = require("syracuse-phantomjs");

var config = require('config');
var tracer = console.log;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

asyncTest("init environment", function(_) {
	//
	require('syracuse-main/lib/syracuse').startServers(_, 3004);

	//
	start();
});



asyncTest("launch all ui test page array", function(_) {
	var ph = phantom.create(_);
	var suffix = '&recmode=PLAY&recfile=AQFAUnitTest&onlyx3=true';
	if (config.ui.qunit.online) {
		suffix = "&recmode=REC&recfile=AQFAUnitTest&onlyx3=true";
	}
	// url of qlf function
	var url = "http://localhost:3004/syracuse-main/html/main.html?url=%2Ftrans%2Fx3%2Ferp%2FSUPERV%2F%24sessions%3Ff%3DAQFA%252F2%252F%252FM" + suffix;
	var page = ph.createPage(_);
	// test grid
	var status = page.open(url, {
		headers: {
			Authorization: adminTestFixtures.makeBasicAuthorizationToken("admin", "admin")
		}
	}, _);
	strictEqual(status, "success", "Page open success");
	// simple evaluate
	var cls = page.evaluate(function() {

		return null;
	}, _);


	page.close();

	ph.exit(_);

	start();

});

asyncTest("stop", 0, function(_) {

	doStop = true;

	start();
});