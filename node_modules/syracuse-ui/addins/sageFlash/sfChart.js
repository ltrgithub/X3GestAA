"use strict";
var $ = jQuery;

require('test-runner/deps/jquery.flash');

var helpers = require('syracuse-core').helpers;
var controller = require('../squeryController').controller;

$.fn.sfChart = function(settings) {
	var $$self = this;
	var id = "sf" + helpers.uuid.generate("");

	$$self.empty();
	$$self.flash({
		id: id,
		name: id,
		src: '/syracuse-ui/lib/articles/charts/sageFlash/swf/FLASH/xstart_portal.swf',
		base: '.',
		width: '100%',
		height: '400',
		swLiveConnect: true,
		allowScriptAccess: 'sameDomain',
		quality: 'high',
		scale: 'noscale',
		salign: 'lt',
		wmode: 'transparent',
		bgcolor: '#d8e6f2'
	}, { //version: 9,

	});
	var player = $('#' + id)[0];

	var dispatch = {
		fxgetinitialdata: function(args) {
			player.SetVariable("/_root/xstatic1:ganswer", 'xflashreqcode==fxgetinitialdata&&xdata==' + sampleXml);
			player.TCallLabel("/_root/xstatic1", "lblrecall");
		}
	};

	// TODO: clean up when plugin is removed
	window[id + "_DoFSCommand"] = function(command, args) {
		try {
			var fn = dispatch[command];
			fn ? fn(args) : helpers.log.warn(module, "flash component: unhandled command: " + command);

		} catch (ex) {
			helpers.log.exception(module, ex);
		}
	};

	return $$self;
};

var sampleXml = '<X3PORTAL><Data><Lines>' +
	'<line Num="1"><col><X3IntVal>26/10/06</X3IntVal></col><col><X3IntVal>24</X3IntVal></col><col><X3IntVal>7</X3IntVal></col><col><X3IntVal>2</X3IntVal></col><col><X3IntVal>12</X3IntVal></col></line>' +
	'<line Num="2"><col><X3IntVal>26/10/06</X3IntVal></col><col><X3IntVal>34</X3IntVal></col><col><X3IntVal>9</X3IntVal></col><col><X3IntVal>6</X3IntVal></col><col><X3IntVal>1</X3IntVal></col></line>' +
	'</Lines><Titles>' +
	'<Title /><ColTitle Num="1" X3Type="7" Nam="WABS1">Date</ColTitle><ColTitle Num="2" X3Type="4" Nam="WCRGM">Capacité</ColTitle><ColTitle Num="3" X3Type="4" Nam="WCRGF">Ferme</ColTitle><ColTitle Num="4" X3Type="4" Nam="WCRGP">Planifié</ColTitle><ColTitle Num="5" X3Type="4" Nam="WCRGS">Suggéré</ColTitle>' +
	'</Titles></Data>' +
	'<Technical><DataSrc Type="BTAB" Code="A" /><HtcProvType>TABLEBLOC</HtcProvType>' +
	'<VisCmp Type="FGR"><FGGTYPE>XLINEM</FGGTYPE><FGCVAL>2;3;4;5</FGCVAL><FGCLABEL>1</FGCLABEL><FGCSELG>2</FGCSELG><FGCSELC>2</FGCSELC><FGCDEF /></VisCmp></Technical></X3PORTAL>';