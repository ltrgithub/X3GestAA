"use strict";

var syracuse = require('syracuse-main/lib/syracuse');
var helpers = require('syracuse-core/lib/helpers');
var util = require("etna-supervisor/lib/util");
var globals = require('streamline/lib/globals');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var flows = require("streamline/lib/util/flows");
var ez = require('ez-streams');

var tracer; // = console.log;

var doStop = false;

//var rdbms = ["Oracle"];
//var rdbms = ["Sqlserver"];
var rdbms = ["Oracle","Sqlserver"];

var sqlDrivers={};

QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

function _getSqlDriver(_,driver) {
	var dataset = "etna"+driver;
	if (sqlDrivers[dataset]) return sqlDrivers[dataset];

	var eps = adminHelper.getEndpoints(_, {});
	var epMatch;
	flows.some(_, eps, function(_, ep) {
		if ("x3" === ep.protocol(_) && dataset === ep.dataset(_)) {
			epMatch = ep;
			return true
		}
		return false;
	});
	var sqlConfig =  (epMatch && epMatch.getEtnaConfig(_).sql);
	strictEqual(epMatch != null, true, "Etna Config :" + JSON.stringify(sqlConfig));

	if(driver == "Sqlserver") {
		sqlConfig.user = "X3";
		ok(false,"TODO : REMOVE THIS HACK")
	}
	
	sqlDrivers[dataset] = require('etna-supervisor/lib/drivers/' + sqlConfig.driver)(sqlConfig);
	return sqlDrivers[dataset];
}

asyncTest("Connection", function(_) {
	rdbms.forEach_(_,function(_,driver) {
		try {
		    _getSqlDriver(_,driver).withConnection(_, function (_, cnx) {
	    		ok(true,driver + " connected");
		    });
		} catch (e) {
			ok(false,driver + " Connection failed");
		}
	});
	start();
});

function checkIsUuid(uuid,message) {
	strictEqual(typeof uuid,"string",message + " uuid basic data type");

	var isUuid = /[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/.test(uuid);
	ok(isUuid,message + " " + ((isUuid)? "is":"isn't") + " an UUID ("+uuid + ")");
	
}

function checkIsDatetime(value,message) {
	var isDatetime = false;
	try {
		var datetime = new Date(value);
		isDatetime=true;
	} catch(e) {
	}
	ok(isDatetime, message + " is"+ (isDatetime?"":"'nt")+" a datetime ("+value+")");
}

function sqlInsert(_,driver,cnx,table,value) {

	// Add mandatory fields :
	value.CREDATTIM=new Date();
	value.UPDDATTIM=new Date();
	value.AUUID=util.uuid('');
	value.CREUSR="JUNIT";
	value.UPDUSR="JUNIT";

	var columns =  Object.keys(value).reduce(function(previousValue, currentValue, index, array) {
			previousValue.push(array[index]+"_0");
			return previousValue;
		}, []);

	//DBG:ok(true,"columns:"+JSON.stringify(columns));

	var sql = "insert into " + driver.escape(table)
		+ " ("+ columns.join(',') +") values ("
		+ Object.keys(columns).map(function(column) {
			return driver.param(parseInt(column));
		}).join(',') +  ")";
	ok(true,"insert:"+sql);
	var values = Object.keys(value).reduce(function(previousValue, currentValue, index, array) {
			previousValue.push(value[array[index]]);
			return previousValue;
		}, []);
	ok(true,"values:"+JSON.stringify(values));
	
	driver.execute(_, cnx, sql,values);

}

asyncTest("select * from AQCQRY01 (1 row)", function(_) {
	rdbms.forEach_(_,function(_,driver) {
		try {
			var sqlDriver = _getSqlDriver(_,driver);
		    sqlDriver.withConnection(_, function (_, cnx) {
		    	try {
		    		sqlDriver.execute(_, cnx, "delete from AQCQRY01");
		    		var array = sqlDriver.reader(cnx, "select * from AQCQRY01", []).toArray(_);
		    		strictEqual(array.length,0, "array.length:"+array.length +" ("+driver+")");

		    		for(var i=1;i<=1;i++) {
		    			var j = (1+((i-1)%100));

		    			sqlInsert(_,sqlDriver,cnx,"AQCQRY01",{
		    				FIELD01:"F1_"+("00"+i).slice(-3),
		    				FIELD02:"F2_"+("00"+j).slice(-3),
		    				ACCESS:(j == 1 || j == 2)?"AQCACS"+j:""
		    			});
		    		}

		    		array = sqlDriver.reader(cnx, "select * from AQCQRY01", []).limit(1).toArray(_);

		    		strictEqual(array[0].FIELD01_0, "F1_001", "F1_001 ("+driver+")");
		    		strictEqual(array[0].FIELD02_0, "F2_001", "F2_001 ("+driver+")");
		    		checkIsUuid(array[0].AUUID_0,"AUUID_0 ("+driver+")");
		    		checkIsDatetime(array[0].UPDDATTIM_0,"UPDDATTIM_0 ("+driver+")");
    			} catch(e)	{
    				ok(false,driver+": exception:"+e);
    			}
		    });
		} catch (e) {
			ok(false,driver + " Connection failed");
		}
	});
	start();
});


asyncTest("stop tests",  function(_) {
	doStop = true;
	start();
});