"use strict";

var syracuse = require('syracuse-main/lib/syracuse');
var helpers = require('syracuse-core/lib/helpers');
var util = require("etna-supervisor/lib/util");
var globals = require('streamline/lib/globals');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var flows = require("streamline/lib/util/flows");
var ez = require('ez-streams');
var bcd = require('etna-engine/lib/runtime/bcd');
var tuuid = require('etna-engine/lib/runtime/tuuid');
var tdatetime = require('etna-engine/lib/runtime/tdatetime');
var tdate = require('etna-engine/lib/runtime/tdate');
var BCD = require('etna-engine/lib/runtime/tbcd').BCD;
var tbcd = require('etna-engine/lib/runtime/tbcd');
var config = require("etna-util/lib/nodeconfig").config;
var drvutil = require("etna-supervisor/lib/drivers/util");

var tracer; // = console.log;

var doStop = false;

QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

function sqlInsert(_, driver, cnx, table, value) {
	//console.log("sqlInsert "+JSON.stringify(value));

	// Add mandatory fields :
	var dtm0 = new Date();
	var dtm1 = new Date();
	dtm0.setMilliseconds(0);
	dtm1.setMilliseconds(0);
	value.CREDATTIM = tdatetime.fromJsDate(dtm0);
	value.UPDDATTIM = tdatetime.fromJsDate(dtm1);

	value.CREUSR = "JUNIT";
	value.UPDUSR = "JUNIT";
	value.AUUID = tuuid.generate();

	var columns = Object.keys(value).reduce(function(previousValue, currentValue, index, array) {
		previousValue.push(array[index] + "_0");
		return previousValue;
	}, []);

	//DBG:ok(true,"columns:"+JSON.stringify(columns));

	var sql = "insert into " + driver.escape(table) + " (" + columns.join(',') + ") values (" + Object.keys(columns).map(function(column) {
		return driver.param(parseInt(column));
	}).join(',') + ")";
	//DBG:ok(true,"insert:"+sql);

	var values = Object.keys(value).reduce(function(previousValue, currentValue, index, array) {
		previousValue.push(value[array[index]]);
		return previousValue;
	}, []);
	//DBG:ok(true,"values:"+JSON.stringify(values));
	//setTimeout(_, 5000);

	var prm = drvutil.toSql(values, driver);

	driver.execute(_, cnx, sql, prm);
}

function randomDCB(integer, decimals) {
	var v = ((Math.random() > 0.5) ? 1 : -1) * Math.floor((Math.pow(10, integer + decimals) - 1) * Math.random()) / Math.pow(10, decimals);
	return new BCD(bcd.fromString(v + ""));
}

var sqlDriver;

function testConnect(_) {
	try {
		var epMatch = adminHelper.getEndpoint(_, {
			dataset: config.unit_test.etnaEndPoint
		});

		ok(true, "endPoint:" + config.unit_test.etnaEndPoint);

		var sqlConfig = (epMatch && epMatch.getEtnaConfig(_).sql) || {};
		ok(true, "driver:" + sqlConfig.driver);

		/*
		var sqlConfig = {} ;
		sqlConfig.driver = "sqlserver" ;
		sqlConfig.hostname = "sodsql2k12x64\\SAGE01" ;
		sqlConfig.database = "sydevsql"
		sqlConfig.user = "X3" ;
		sqlConfig.password = "tiger" ;
*/
		sqlDriver = require('etna-supervisor/lib/drivers/' + sqlConfig.driver)(sqlConfig);

		sqlDriver.withConnection(_, function(_, cnx) {
			ok(true, "Connected");
		});
	} catch (e) {
		console.log(e);
		ok(false, "Connection failed:" + JSON.stringify(e));
	}
	start();
}

function testAQCDBTYPES(_) {
	try {
		sqlDriver.withConnection(_, function(_, cnx) {
			try {

				sqlDriver.execute(_, cnx, "delete from AQCDBTYPES");

				var array = sqlDriver.reader(_, cnx, "select * from AQCDBTYPES", []).toArray(_);
				strictEqual(array.length, 0, "array.length:" + array.length);

				var rows = 0;
				var maxRows = 2;
				var now = new Date();
				var values = [];
				var a250 = "";
				for (var i = 1; i <= 246; i++) {
					a250 += String.fromCharCode(32 + (i % 94));
				}
				a250 += "àçéè";

				for (var i = 1; i <= maxRows; i++) {
					//var day = tdate.fromJsDate(  Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
					var day = tdate.make(now.getFullYear(), now.getMonth() + 1, now.getDate());

					//day.setDate(day.getDate() - ((i - 1) % 10));

					var value = {
						IDX: i,
						C5: Math.floor(Math.pow(2, 16) * Math.random()) - Math.pow(2, 15), // random value in the range [-32768, +32767]
						A10: "A" + i,
						A250: "A" + i, //TODO
						DTM: day,
						L8: Math.floor(Math.pow(2, 32) * Math.random()) - Math.pow(2, 31), //random value in the range [-2^31, +2^31].
						//DCB9_2: randomDCB(9, 2)
						DCB9_2: tbcd.fromString("1.234")
					};
					console.log('insert:\n' + JSON.stringify(value));

					sqlInsert(_, sqlDriver, cnx, "AQCDBTYPES", value);
					values.push(value);
					rows += 1;
				}
				strictEqual(rows, maxRows, "inserted rows:" + rows);

				var ftrim = drvutil.maptrim(sqlDriver, [2, 2, 7, 7, 8, 3, 4, 12, 12, 7, 7, 11]);


				array = sqlDriver.reader(_, cnx, "select IDX_0, C5_0, A10_0, A250_0, DTM_0, L8_0, DCB9_2_0,CREDATTIM_0,UPDDATTIM_0,CREUSR_0,UPDUSR_0,AUUID_0 from AQCDBTYPES order by IDX_0", []).toArray(_);
				/*var row = array[0] ;
				row = ftrim(row) ;*/

				[0, maxRows - 1].forEach_(_, function(_, i) {
					var row = array[i];
					row = ftrim(_, row);
					console.log("read:\n" + JSON.stringify(row));
					Object.keys(values[i]).forEach(function(key) {
						var cmp = values[i][key].x3Compare(row[key]);
						strictEqual(cmp, 0, "Value of [" + i + "]." + key + "=" + row[key].x3ToString());
					});
					console.log("done");
				});
			} catch (e) {
				console.error(e.stack);
				ok(false, "exception:" + e);
			}
		});
	} catch (e) {
		ok(false, "Connection failed:" + JSON.stringify(e));
	}
	start();
};

asyncTest("Connection ", testConnect);
asyncTest("AQCDBTYPES ", testAQCDBTYPES);

asyncTest("stop tests", function(_) {
	ok(true, "stop");
	doStop = true;
	start();
});