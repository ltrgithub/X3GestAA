"use strict";
var util = require("etna-supervisor/lib/util");
var InstanceProperty = require("etna-supervisor/lib/instanceProperty").InstanceProperty;
var attributes  = require("etna-supervisor/lib/attributes");
var glob = require('streamline/lib/globals');
var ACTXCACHE = require("etna-supervisor/lib/builtins/ACTXCACHE");
var variables 	= require('etna-engine/lib/runtime/variables');

var locales = {
	' .':/^fr.*/i,
	',.':/^en.*/i
};

// Not exposed by ACTX : 
function _setProtectedProperty(object,property,value) {
	if(object[property] !== undefined) {
		object[property].$_isReadonly = false;
		object[property].$isReadonly  = false;
		object[property].value 	      = value;		
		object[property].$isReadonly  = true;
		object[property].$_isReadonly = true;
	}
}

exports.constructor = util.defineClass(function(superv) {
	this.supervisor = superv;
	this.$exported = true;
	this.class = {properties:{}};
	this.isContext = true;
}, null, {
	init: function(_) {		
		//this.ACACHE = new (ACTXCACHE.constructor)(this.supervisor).init(_);	
		return this;
	},
	set: function(_,name,val) {
		this[name].value = val;
		// TODO : set readonly throw new Error("SET ACTX property " + name);
	},
	get: function(_,name){
		if (this.desactGet)     return this[name].value;
		if (this[name])			return this[name].value;

        this.desactGet = name ;
		var recDb = this.supervisor.loadContextProp(_,name);
		if (!recDb) throw new Error("NIY ACTX property " + name);
		var wprop = {
				"FLDCLA": name,
	            "CODTYP" : recDb.CODTYP,
	            "TYPCLA": 99,
	            "LONG" : recDb.LNGTYP,
		};
		this.class.properties[name] =  this.supervisor.new(_, 'Property', this, wprop);
		var dime;
		if (recDb.FORDIM[0])  dime = recDb.FORDIM[0] ;
		
		if (dime){
			this[name] = new InstanceProperty([1,  this.class.properties[name].type.engineType(), [],1,dime-1],this); 
		} else {
			this[name] = new InstanceProperty(this.class.properties[name].type.defaultValue(),this);		
		}
		var trtini;
		if (recDb.TRTINI)			trtini = recDb.TRTINI;
		if (recDb.FORINI)			trtini = "this."+name+" = "+recDb.FORINI;		
		if (trtini){
			var wcript = "\n$METHODS \n";
			wcript	+= trtini + '\n';
			wcript  += "Return" ;
			//wcript = "$METHODS \n this.IRS(1) = 'TOTO' \n this.IRS(2) = 'TOTA' \n Return" ;
			//console.log("wcript " + wcript);
			this.script = this.supervisor.loadScriptBase(_,wcript,name);
			this.invokeScript(_, this);
		}
		if(this[name] !== undefined) {
			switch (name) {
				case 'USER'	  : _setProtectedProperty(this,name,process.env.USER || "user");break;
				case 'AFOLDER': _setProtectedProperty(this,name,this.supervisor.folderName);break;
				case 'LAN'    : _setProtectedProperty(this,name,this.supervisor.LAN);break;
			}
		}
		this.desactGet = null ;
		return this[name].value;
	},
	invokeScript: function(_, instance) {
		var astatus = 0;
			var handler = this.script.METHODS;

			if (!handler) return;
			var frame = glob.context.x3frame;

			var prev = frame;
			var cx = prev.context;
			glob.context.x3frame = frame = {
				values: {},
				types: {},
				context: cx,
				prev: prev,
				loopLevel: 0,
				loc: {
					file: module.id,
					line: 0
				}
			};
			// current sub is the prog itself
			frame.sub = frame;
			frame.dicts = [frame, cx.globals, cx.sys];
			try {
				util.declVar(frame,'THIS','LY', instance);
				handler(_) ;
			} finally {
				glob.context.x3frame = prev;
			}

		return ;
	},
	setPropertyAttribute:function(_,property,attribut,value) {
		var status = this[property].setAttribute(attribut,value);
		return (typeof status === 'boolean')? (status ? variables.constants.CST_ATRUE : variables.constants.CST_AFALSE): value;
	},
	getPropertyAttribute:function(_,property,attribut,value) {
		return this[property].getAttribute(attribut);
	},
	ACTX_SET_LANISO:function(_,l) {
		if(this.LANISO === undefined) this.get(_,"LANISO");
		_setProtectedProperty(this,'LANISO',l);

		require('syracuse-core/lib/locale').setCurrent(_, l);
		(function($){
			Object.keys(locales).some(function(key) {
				if(locales[key].test(l)) {
					$.ADXSCA = $.ADXSCA.substring(0,2)+key+$.ADXSCA.substring(4);
					return;
				}
			});
		})(glob.context.x3frame.context.sys.values);

	}
},
{hasAttributes:true});
