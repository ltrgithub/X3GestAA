"use strict";
var glob = require('streamline/lib/globals');
var activ = require("etna-supervisor/lib/meta/activ");

exports.$METHODS = function(_, action, resource) {
	switch (action) {
		case "$AQUERY_TRANS_AFTER":
			return AQUERY_TRANS_AFTER(_, resource);
	}
};

function AQUERY_TRANS_AFTER(_, resource) {
	var frame = glob.context.x3frame;
	var superv = frame.context.superv;
	var astatus = superv.constants.CST_AERROR;
	var instance = resource.get(_, "CLA");
	var codact = instance.get(_, "CODACT");
	if ((instance.get(_, "TYPCLA") !== 2) || (codact && activ.getActiv(_, superv, codact) <= 0)) {
		instance.set(_, "FLGSEARCH", 1);
	} else if (instance.get(_, "FLGSEARCH") === 2) {
		var rs = superv.mongoStore.collection("ASHW", _).find({
			CODCLA: instance.get(_, "CODCLA"),
			DEFREP: 2
		}).toArray(_);
		rs && rs.some(function(record) {
			if (record.ENAFAC && record.ENAFAC[0] === 2) {
				astatus = superv.constants.CST_AOK;
				return true;
			}
			return false;
		});
	}
	return astatus;
}