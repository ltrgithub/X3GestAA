"use strict";

var util = require("etna-supervisor/lib/util");

exports.constructor = util.defineClass(function(superv, table, data) {
	this.superv = superv;
	this.table = table;
	this.data = data;
}, null, {
	init: function(_) {
		this.type = this.superv.load(_, 'Type', this.data.CODTYP);
		return this;
	},
	name: {
		get: function() {
			return this.data.CODZONE;
		}
	},
	sqlNames: function(_, prefix) {
		prefix = prefix || '';
		var s = prefix + this.data.CODZONE + '_0';
		for (var i = 1; i < this.data.DIME; i++) s += ',' + prefix + this.data.CODZONE + '_' + i;
		return s;
	},
	sqlDescs: function(descs) {
		for (var i = 0; i < (this.data.DIME || 1); i++) {
			if (!this.type.sqlType()) continue;
			descs.push({
				name: this.data.CODZONE,
				index: this.data.DIME > 1 ? i : null,
				offset: descs.length,
				type: this.type,
			});
		}
	},
	sqlDef: function() {
		var typeStr = this.type.sqlType();
		if (!typeStr) return null;
		var s = "";
		var dim = this.data.DIME || 1; // TODO get dim from activity code if missing here
		for (var i = 0; i < dim; i++) s += (s ? "," : "") + this.data.CODZONE + "_" + i + " " + typeStr;
		return s;
	},
	getSql: function(_, colNames, tableNames, wheres, params, descs, raw) {
		if (!this.type.sqlType()) return;
		if (/^AX[123X]/.test(this.data.CODTYP)) {
			if (raw || !tableNames) return;
			var abbr = "AX" + wheres.length;
			var keyNames = this.table.indexes[0].sqlNames(_).slice(0, 2);
			colNames.push(abbr + ".TEXTE_0 AS " + this.data.CODZONE + '_0');
			tableNames[0] += " left outer join ATEXTRA " + abbr + " on " + keyNames.map(function(keyName, i) {
				return abbr + ".IDENT" + (i + 1) + '_0=T.' + keyName;
			}).join(' and ');
			params.push(this.table.name);
			wheres.push(abbr + ".CODFIC_0=:" + params.length);
			params.push(this.data.CODZONE);
			wheres.push(abbr + ".ZONE_0=:" + params.length);
			params.push(this.superv.LAN);
			wheres.push(abbr + ".LANGUE_0=:" + params.length);
		} else if (this.type && this.type.data.TYPTYP === 9) {
			// see later colNames.push('cast(T.' + this.data.CODZONE + "_0 as VARCHAR2(4000))");
		} else {
			colNames.push(this.sqlNames(_, 'T.'));
			descs && this.sqlDescs(descs);
		}
	},
	convertIn: function(val) {
		return this.type ? this.type.convertIn(val) : val;
	},
});