"use strict";

var glob = require('streamline/lib/globals');
var util = require("etna-supervisor/lib/util");
var activ = require("etna-supervisor/lib/meta/activ");
var runtime = require('etna-engine/lib/runtime/runtime');
var variables = require('etna-engine/lib/runtime/variables');

var Errors = require("etna-supervisor/lib/errors").Errors;

var tracerJs = require("syracuse-trace/lib/helper").getTracer("etna.supervisor");

exports.defineClass = function(constructor, parent, members) {
	// Add base members :
	members.init = function(_) {
		return this;
	};

	// Lazy loading of slots:
	members.slot = function(_, name) {
		if (this.slots[name]) return this.slots[name];
		if (this.properties[name]) {
			this.slots[name] = this.properties[name].createInstance(this);
			if (this.record !== undefined) {
				this.slots[name].fromRecord(_, this.record, this.colnIndex);
			}
			return this.slots[name];
		}
	};

	members.sysProperty = function(name) {
		this.sysProperties = this.sysProperties || {};
		if (!this.sysProperties[name]) {
			if (name === 'AERROR') {
				this.sysProperties.AERROR = function(self) {
					return {
						get: function(_) {
							this.errors = this.errors || new Errors(self);
							return this.errors;
						}
					};
				}(this);
			} else if (name === 'ACTX') {
				this.sysProperties.ACTX = {
					get: function(_) {
						return glob.context.x3session.actx;
					}
				};
			} else if (name === 'APARENT') {
				this.sysProperties.APARENT = function(self) {
					return {
						get: function(_) {
							return self.parent;
						}
					};
				}(this);
			} else if (this.clasName && name === this.clasName) {
				this.sysProperties[this.clasName] = function(self) {
					return {
						get: function(_) {
							return self.instance;
						}
					};
				}(this);
			}
		}
		return this.sysProperties[name];
	};
	members.get = function(_, name, raw) {
		tracerJs.debug && tracerJs.debug(this.$$type + " get:" + name);
		var s = this.slot(_, name) || this.sysProperty(name);
		if (s) {
			return s.get(_, raw);
		} else {
			//External attributes ?
			var valattr = this.getAttribute("$" + name);
			if (valattr !== undefined) return variables.x3Val(valattr);
			throw new Error(this.$$type + ".get property not found: " + name);
		}
	};

	members.set = function(_, name, value, raw) {
		tracerJs.debug && tracerJs.debug("instance.set " + name + " value:" + value);
		if (!raw) this.snapshots();
		// Lazy loading of slots:
		var s = this.slot(_, name);
		if (s) s.set(_, value, raw);
		else {
			try {
				//External attributes ?
				this.setAttribute("$" + name, value);
			} catch (e) {
				throw new Error("Cannot set property :" + name);
			}
		}
	};

	members.getPropertyAttribute = function(_, property, attribut) {
		return this.slot(_, property).getAttribute(attribut);
	};

	members.ASETATTRPROP = function(_, property, attribut, value) {
		try {
			return this.setPropertyAttribute(_, property, attribut, value);
		} catch (ex) {
			return this.supervisor.constants.CST_AERROR;
		}
	};

	members.AGETATTRIBUTE = function(_, property, attribut) {
		return variables.x3Val(this.getPropertyAttribute(_, property, attribut));
	};

	members.setPropertyAttribute = function(_, property, attribut, value) {
		this.snapshots();
		return this.slot(_, property).setAttribute(attribut, value);
	};

	members.ASETATTRIBUTE = function(_, property, attribut, value) {
		return variables.x3Val(this.setPropertyAttribute(_, property, attribut, value));
	};

	members.setColumnAttribute = function(_, collection, column, attribut, value) {
		var slot = this.slot(_, collection);
		if (slot && slot.setColumnAttribute) return slot.setColumnAttribute(column, attribut, value);
	};

	members.getColumnAttribute = function(_, collection, column, attribut) {
		var slot = this.slot(_, collection);
		if (slot && slot.getColAttribute) return slot.getColAttribute(column, attribut);
	};

	members.scripts = function(_) {
		return this.meta.scripts(_);
	};

	members._actionControl = function(_, operation, type) {
		return this._action(_, ("A" + [operation, "CONTROL", type].join('_')).toUpperCase());
	};

	members._actionControlBefore = function(_, operation) {
		return this._actionControl(_, operation, "BEFORE");
	};

	members._actionControlAfter = function(_, operation) {
		return this._actionControl(_, operation, "AFTER");
	};

	members.withControl = function(_, f) {
		var status;
		// Propagate the before  to all elements
		if (status = this.controlBefore(_, f.name)) return status;

		// Execute the operation:
		if (status = f(_)) return status;

		// Propagate the after event to all elements
		if (status = this.controlAfter(_, f.name)) return status;
	};


	members.AINIT = function(_) {
		var status = this.supervisor.constants.CST_AOK;
		// First init properties :
		if (status = this.initProperties(_)) return status;
		if (this.instance && (status = this.instance.initProperties(_))) return status;

		// Then call AINIT event 
		if (this.instance && (status = this.instance._action(_, "AINIT"))) return status;
		return this._action(_, "AINIT");
	};

	members.initProperties = function(_) {
		var cst_aok = this.supervisor.constants.CST_AOK;
		var status = cst_aok;
		if (!this.scripts(_)) return status;

		var properties = this.meta.data.PROPERTIES;
		for (var i = 0; i < properties.length; i++) {
			status = this.runScripts(_, "$PROPERTIES", {
				THIS: {
					type: "LY",
					value: this
				},
				ASTATUS: {
					type: "LI",
					value: cst_aok
				},
				CURPRO: {
					type: "LS",
					value: properties[i].FLDCLA || properties[i].CODFLD
				},
				ACTION: {
					type: "LS",
					value: "INIT"
				}
			});
			if (status) return status;
		}
		return status;
	};
	members.x3Properties = function(_, action, property, oldValue) {
		var args = this.getActionArgs(_, action, null, property);
		if (oldValue) {
			args._AOLDVAL = oldValue;
		}
		var astatus = this.runScripts(_, "$PROPERTIES", args);
		if (astatus === this.supervisor.constants.CST_AOK && this.parent && this.parent.runScripts) {
			astatus = this.parent.runScripts(_, "$PROPERTIES", args);
		}
		return astatus;
	};

	members.setStatus = function(_, path, severity, message) {
		this.diagnoses.push(this.supervisor.new(_, 'Diagnosis', severity, path, message));
		return severity;
	};

	members.ADELETEERROR = function(_, group) {
		console.log("TODO ADELETEERROR:" + group);
	};

	members.ASETERROR = function(_, path, message, severity) {
		return this.setStatus(_, path, severity, message);
	};

	return util.defineClass(function(superv, data, group) {
		this.supervisor = superv;
		this.data = data;
		this.key = null;
		this.diagnoses = [];

		// Call derived constructor :
		constructor.apply(this, arguments);
	}, parent, members, {
		hasAttributes: true,
		hasSnapshots: true
	});
};