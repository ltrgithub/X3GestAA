"use strict";
var db = require("etna-engine/lib/runtime/db");
var helpers = require('syracuse-core').helpers;
var glob = require('streamline/lib/globals');

var tracerJs = require('syracuse-core').getTracer("etna.dbms");

var beginTransaction = db.instructions.TRBEGIN();
var commitTransaction = db.instructions.COMMIT();
var rollbackTransaction = db.instructions.ROLLBACK();

var Transaction = exports.Transaction = helpers.defineClass(function() {
	this.inProgress = false;
}, null, {
	begin: function(_) {
		var frame = glob.context.x3frame;
		if (frame.context.sys.values.ADXLOG === 0) {
			beginTransaction(_);
			tracerJs.debug && tracerJs.debug("begin Transaction");
			this.inProgress = true;
		} else {
			this.inProgress = false;
		}
	},
	commit: function(_) {
		if (this.inProgress) {
			commitTransaction(_);
			tracerJs.debug && tracerJs.debug("commit Transaction");
			this.inProgress = false;
		}
	},
	rollback: function(_) {
		if (this.inProgress) {
			rollbackTransaction(_);
			tracerJs.debug && tracerJs.debug("rollback Transaction");
			this.inProgress = false;
		}
	},
});