"use strict";

var ez = require('ez-streams');
var oracle = require('oracle');

module.exports = function(config) {
	var trace = config.trace;
	var connections = [];
	
	return {
    	decimalCast : function ( name ) {
    		return "to_char( " + name + ", '99999999999999999999.99999999999999999999' ) As "+name ;
    	},
        uuidCast : function ( name ) {
    		return name ;
    	},
    	sqlUuid :  function( val ) {
    		// no conversion needed
    		return val ;
    	},
		nullDate : function ( )  {
    		return new Datetime( 1599, 12, 31, 0, 0, 0, 0 ) ;
    	},
		isNullDate : function( val ) {
            return val && (val.getFullYear( )===1599) && (val.getMonth()===12) && (val.getDay()===31) ;     
        },
		isNullUuid : function( val ) {
            return val === "00000000000000000000000000000000" ;
        },
		escape: function(name) {
			return '"' + name + '"';
		},
		param: function(i) {
			return ':' + (i + 1);
		},
		withConnection: function(_, body) {
			var cnx = connections.pop();
			if (!cnx) {
				trace && trace("connecting ...");
				var cnx = oracle.connect(config, ~_);
				cnx.setPrefetchRowCount(config.setPrefetchRowCount || 50);
			}
			try {
				return body(_, cnx);
			} finally {
				connections.push(cnx);
			}
		},
		execute: function(_, cnx, sql, args) {
			return cnx.execute(sql, args || [], ~_);
		},
		reader: function(cnx, sql, args) {
			return ez.devices.oracle.reader(cnx, sql, args);
		},
		writer: function(cnx, sql) {
			return ez.devices.oracle.writer(cnx, sql);
		},
		dropIndexSql: function(indexName, tableName) {
			return 'drop index "' + indexName + '"';
		},
		isIndexNotFound: function(ex) {
			return /ORA-01418/.test(ex.message);
		},
		isTableNotFound: function(ex) {
			return /ORA-00942/.test(ex.message);
		},
		blobType: function() {
			return "VARCHAR2(1020)";
		},
		blobType2: function() {
			return "VARCHAR2(32)";
		},
		tinyIntType: function() {
			return "NUMBER(3)";
		},
		shortIntType: function() {
			return "NUMBER(5)";
		},
		intType: function() {
			return "NUMBER(10)";
		},
		stringType: function(len) {
			return "VARCHAR2(" + len + ")";
		},
		dateType: function() {
			return "DATE";
		},
		datetimeType: function() {
			return "DATE";
		},
		uuidType: function() {
			return "VARCHAR2(32)";
		},
		decimalType: function() { // for now handle as char to keep full precision
			return "VARCHAR2(32)";
		},
	};
};