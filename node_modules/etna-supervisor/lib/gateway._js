"use strict";

var globals = require('streamline-runtime').globals;
var runtime = require("etna-engine/lib/runtime/runtime");
var etnaClient = require("etna-supervisor/lib/client");
var AGATEWAYADX = require("etna-supervisor/lib/builtins/AGATEWAYADX");

var trace = require("syracuse-trace/lib/helper").getTracer("etna.supervisor");

exports.$exported = true;


exports.gateway = function(_, script_name, operation_name, payload) {
	var context = globals.context;

	var endpoint = require("syracuse-collaboration/lib/helpers").AdminHelper.getEndpoint(_, {
		dataset: globals.context.endpointDataset,
	});
	var client = etnaClient.getClient(_, context.session, endpoint);
	var resp = client.jsonSend(_, {
		head: {
			url: "/sdata/x3/erp/" + globals.context.endpointDataset + "/$service/rpc?module=" + script_name + "&name=" + operation_name,
			method: "POST",
		},
		payload: payload
	});
	trace.debug && trace.debug("gateway response:" + resp.body);
	return resp.body;
};

exports.rpc = function(_, context) {
	var body = context.request.readAll(_);

	trace.debug && trace.debug("rpc module:" + context.qs.module);
	trace.debug && trace.debug("rpc name  :" + context.qs.name);
	trace.debug && trace.debug("rpc body  :" + body);

	try {
		var _this = new(AGATEWAYADX.constructor)(context.superv, body).init(_);

		var module = runtime.requireScript(_, context.qs.module);
		var args = {
			THIS: {
				type: "LY",
				value: _this
			},
			FUNCTION: {
				type: "AS" + context.qs.name.length,
				value: context.qs.name
			}
		};
		runtime.executeProg(_, module, "$GATEWAY", args);
		context.response.end(_this.stringify(_));

	} catch (e) {
		console.error("GATEWAY:" + e.message);
		console.error("GATEWAY:", e.stack);
	}
};