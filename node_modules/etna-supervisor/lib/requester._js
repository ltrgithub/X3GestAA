"use strict";

var glob = require('streamline/lib/globals');
var util = require("etna-supervisor/lib/util");
var bcd = require("etna-engine/lib/runtime/bcd");
var runtime = require("etna-engine/lib/runtime/runtime");
var ASYR = require("etna-supervisor/lib/builtins/ASYR");

var tracerJs = require("syracuse-trace/lib/helper").getTracer("etna.supervisor");


exports.proto = function(_, superv, script, query, facet) {
	var mod;
	try {
		mod = runtime.requireScript(_, "WF" + script);
	} catch (e) {
		return;
	}
	var psyr = new(ASYR.constructor)(superv);

	var args = {
		ACTX: {
			type: "AY",
			value: glob.context.x3session.actx
		},
		PSYR: {
			type: "AY",
			value: psyr
		},
		WCLOB: {
			type: "AT",
			value: ""
		},
		TIME_UPD: {
			type: "AN",
			value: bcd.fromDouble(0)
		},
		LEVEL_NUM: {
			type: "BS",
			value: query
		},
		TYPE_REPRES: {
			type: "BS",
			value: "$query"
		}
	};
	runtime.executeProg(_, mod, "PROTO_JSON", args);
	return args.WCLOB.value;
};