var qunit = require("./qunit"),
	path = require("path"),
	options = JSON.parse(process.argv[2]);
//console.error("OPTIONS: " + JSON.stringify(options));
require('coffee-script/lib/coffee-script/extensions');
if (options.etna) require('etna-engine/lib/register'); // must be before streamline!
require('streamline').register(options.streamline);
var globals = require('streamline/lib/globals');
globals.context = {};
if (options.tenantId != null) globals.context.tenantId = options.tenantId;
require('syracuse-core/lib/localeWrapper');
require('./qunitWrapper');


// add paths to require
if (options.paths) {
	require.paths.push.apply(require.paths, options.paths);
}

function handleError(ex) {
	console.log(JSON.stringify({
		module: "bootstrap",
		name: options.code,
		message: ex.message,
		errorStack: ex.stack
	}));
	process.exit(0);
}

try {
	// require code
	var mod = require(options.code.replace(/\.js$/, ""));
	qunit.extend(global, mod);

	// require tests
	options.tests.forEach(function(test) {
		require(test.replace(/\.js$/, ""));
	});
	if (options.coverage) {
		QUnit.done = function() {
			console.log(
			JSON.stringify({
				cov: _$jscoverage
			}));
		};
	}
	if (typeof mod.MAIN === "function") {
		try {
			require("etna-supervisor/lib/supervisor").create(function(err, superv) {
				if (err) return handleError(err);
				try {
					require("etna-engine/lib/runtime/variables").initStack(superv);
					globals.context.x3frame.loc.file = options.code;
					mod.MAIN(function(err) {
						if (err) return handleError(err);
						try {
							QUnit.begin();
						} catch (ex) {
							handleError(ex);
						}
					});
				} catch (ex) {
					handleError(ex);
				}
			}, "SUPERV");
		} catch (ex) {
			handleError(ex);
		}
	} else {
		QUnit.begin();
	}
} catch (ex) {
	handleError(ex);
}