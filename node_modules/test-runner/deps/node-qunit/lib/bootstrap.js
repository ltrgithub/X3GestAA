var qunit = require( "./qunit" ),
path = require( "path" ),
sys = require( "util" ),
options = JSON.parse( process.argv[2] );
//console.error("OPTIONS: " + JSON.stringify(options.streamline));
require('coffee-script');
require('streamline').register(options.streamline);
require('streamline/lib/util/flows'); // for error stacks
// add paths to require
if ( options.paths ) {
	require.paths.push.apply( require.paths, options.paths );
}

try {
	// require code
	qunit.extend( global, require( options.code.replace( /\.js$/, "" ) ) );

	// require tests
	options.tests.forEach( function( test ) {
		require( test.replace( /\.js$/, "" ) );
	});
	if ( options.coverage ) {
		QUnit.done = function() {
			sys.print(
			JSON.stringify({
				cov: _$jscoverage
			}) + "\n"
			);
		};
	}

	QUnit.begin();
} catch (ex) {
	sys.print( JSON.stringify({
		module: "bootstrap",
		name: options.code,
		message: ex.message,
		errorStack: ex.stack
	}) + "\n" );
}

