"use strict";
require('npm-shadow')();
var qunit = require("./qunit"),
	path = require("path"),
	options = JSON.parse(process.argv[2]) || {};
//console.error("OPTIONS: " + JSON.stringify(options));
var config =  require('../../../../../nodelocal').config;
require('coffee-script').register();
require('syracuse-core/streamline-loader')(config.streamline);
if (options.etna) require('etna/lib/engine/register');

var globals = require('streamline-runtime').globals;
if (options.tenantId != null) globals.context.tenantId = options.tenantId;
require('./qunitWrapper');
require('../../../lib/server/init-apis');

// hacks to pass nodelocal config to tests in public packages (ez-mongodb for example)
config.collaboration = config.collaboration || {};
process.env.MONGO_HOST = config.collaboration.hostname || "localhost";
process.env.MONGO_PORT = config.collaboration.port || 27017;
process.env.HTTP_PORT = (config.unit_test && config.unit_test.serverPort) || 3004;

// add paths to require
if (options.paths) {
	require.paths.push.apply(require.paths, options.paths);
}

function handleError(ex) {
	if (!ex) return;
	console.error("BOOTSTRAP ERROR", ex.stack);
	console.log(JSON.stringify({
		module: "bootstrap",
		name: options.code,
		message: ex.message,
		errorStack: ex.stack,
	    xqz: "t@)$", // marker 
	}));

	if(process.stdout.write("")) {
		setTimeout(function() {
			process.exit(2);
		},100);
	} else {
		process.stdout.on('drain',function(){
			process.exit(2);
		});
		process.stdout.write("");
	};
}

try {	
	// require code
	var mod = require(options.code.replace(/\.js$/, ""));
	qunit.extend(global, mod);

	// require tests
	options.tests.forEach(function(test) {
		require(test.replace(/\.js$/, ""));
	});
	if (options.coverage) {
		QUnit.done = function() {
			console.log(JSON.stringify({
				cov: _$jscoverage
			}));
		};
	}

	if (typeof mod.MAIN === "function") {
		require('./runEtna').run(config, options, mod, handleError);
	} else {
		QUnit.begin();
	}
} catch (ex) {
	handleError(ex);
}
