var qu = require("./qunit");
var QUnit = qu.QUnit;

// We only need the wrapper if running with a fast option. So test and bail out here
if (!/-fast$/.test(require('streamline/lib/globals').runtime)) return;

var oldAsyncTest = global.asyncTest;

global.asyncTest = function(name, expect, test) {
	if (typeof expect === "function") {
		test = expect;
		return oldAsyncTest(name, function(cb) {
			test(_ >> cb);
		});
	} else {
		return oldAsyncTest(name, expect, function(cb) {
			test(_ >> cb);
		});
	}
}

var oldDone = QUnit.done;
QUnit.done = function() {
    if (oldDone) oldDone();
    // shutdown message; marker xqz to identify the origin
    console.log(JSON.stringify({
        shutdown: true,
        xqz: "t@)$" 
    }));
}
