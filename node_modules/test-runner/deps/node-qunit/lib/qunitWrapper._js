var qu = require("./qunit");
var QUnit = qu.QUnit;

var oldDone = QUnit.done;
QUnit.done = function() {
    if (oldDone) oldDone();
    // shutdown message; marker xqz to identify the origin
    console.log(JSON.stringify({
        shutdown: true,
        xqz: "t@)$" 
    }));
}

// redirect chai APIs to QUnit
var assert = require('chai').assert;
function badAssertion(name) {
	return () => { throw new Error(`assert.${name} not supported by QUnit`); }
}

Object.keys(assert).forEach(name => {
	assert[name] = QUnit[name] || badAssertion(name);
})

// redirect mocha API to QUnit
global.describe = function(name, fn) {
	QUnit.module(name);
	fn();
}

global.it = function(name, fn) {
	if (fn.length === 1) {
		QUnit.asyncTest(name, (_) => {
			fn(_);
			QUnit.start();
		});
	} else {
		QUnit.test(name, fn);
	}
}
global.run = () => {};