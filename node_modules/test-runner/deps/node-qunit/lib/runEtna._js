var globals = require('streamline-runtime').globals;
var mongodb = require("mongodb");
var fpromise = require('f-promise');

exports.run = function(config, options, mod, handleError) {
	fpromise.run(() => {
		if (!config.unit_test || !config.unit_test.etnaEndPoint) throw new Error("config.unit_test.etnaEndPoint missing in nodelocal.js")
	    var helper = require('@sage/etna/test/engine/fixtures/helper');
		var etnaConfig = helper.getEtnaConfigForUnitTest(config.unit_test.etnaEndPoint);
		var superv = require("@sage/etna/lib/supervisor/supervisor").create(etnaConfig);
		require("@sage/etna/lib/engine/runtime/variables").initStack(superv);
	       require("@sage/etna/lib/supervisor/builtins/ACTX").init(etnaConfig.session,superv);
		globals.context.x3frame.loc.file = options.code;
		mod.MAIN();
		QUnit.begin();
	}).catch(handleError);
}
