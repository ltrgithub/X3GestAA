var globals = require('streamline-runtime').globals;
var mongodb = require("mongodb");

function getEtnaConfigForUnitTest(_,endpointName) {
    var helper = require('etna/test/engine/fixtures/helper');
    return helper.getEtnaConfigForUnitTest(_, endpointName);
}

function run_(_, config, options, mod, handleError) {
	if (!config.unit_test || !config.unit_test.etnaEndPoint) throw new Error("config.unit_test.etnaEndPoint missing in nodelocal.js")

	var etnaConfig = getEtnaConfigForUnitTest(_,config.unit_test.etnaEndPoint);

	var superv = require("etna/lib/supervisor/supervisor").create(_, etnaConfig);
		require("etna/lib/engine/runtime/variables").initStack(superv);
        require("etna/lib/supervisor/builtins/ACTX").init(_,etnaConfig.session,superv);
	globals.context.x3frame.loc.file = options.code;
	mod.MAIN(_);
	QUnit.begin();
}

exports.run = function(config, options, mod, handleError) {
	return run_(_ >> handleError, config, options, mod, handleError);
}