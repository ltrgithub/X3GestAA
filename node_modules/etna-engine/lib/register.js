"use strict";
require('streamline').register({
	verbose: true,
	fibers: true
});
var fs = require("fs");
var Parser = require("./parser").Parser;
var generate = require('./jsgen').generate;

require('etna-engine/lib/runtime').setupCounters();

function mtimeSync(fname) {
	try {
		return fs.statSync(fname).mtime;
	} catch (ex) {
		return 0;
	}
}

exports.force = true;

function load(module, srcname, jsname) {
	var srcTime = mtimeSync(srcname);
	if ((exports.force && srcTime) || mtimeSync(jsname) < srcTime) {
		var source = fs.readFileSync(srcname, 'utf8');
		var parsed = new Parser(source, srcname).parse();
		var transformed = generate(parsed.node, srcname);
		fs.writeFileSync(jsname, transformed, 'utf8');
	} else {
		transformed = fs.readFileSync(jsname, 'utf8');
	}
	module._compile(transformed, jsname);
}

require.extensions[".js"] = function(module, filename) {
	var srcname = filename.substring(0, filename.length - 2) + "src";
	load(module, srcname, filename);
};

require.extensions['.src'] = function(module, filename) {
	var jsname = filename.substring(0, filename.length - 3) + "js";
	load(module, filename, jsname);
};