"use strict";
var sys = require("util");
var ez = require('ez-streams');
var helpers = require('syracuse-core').helpers;
var uuid = require('syracuse-core').uuid;
var jsxml = require("js-xml");
var config = require("etna-util/lib/nodeconfig").config.etna || {};
var DebugContext = require('./context').DebugContext;

var server;
var pendingClients;
var address = {
	port: ~~(config.debug || {}).port
};

exports.start = function(_) {
	if (!server || server.closed) {
		server = ez.devices.net.server(function(c, _) {
			console.error("New debugger connection: " + c.remoteAddress + ":" + c.remotePort);
			try {
				new DebugContext(c).listen(!_);
			} catch (ex) {
				console.error(ex.stack);
				throw ex;
			}
		}).listen(_, address.port);
		address = server.emitter.address();
		console.error("Etna debugger service running at port " + address.port);
	}
};

exports.getPort = function _getPort(argument) {
	return address.port;
};