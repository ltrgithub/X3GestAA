"use strict";
var flows = require('streamline/lib/util/flows');

var util = require('./util');
var variables = require('./variables');
var errors = require('./errors');
var X3Error = errors.X3Error;

exports.instructions = {
	CALLJS: function(mode, ns, name, args) {
		return function calljs$do(_, frame) {
			var nsVal = ns(_, frame);
			var mod, fn;
			try {
				mod = require(nsVal);
			} catch (ex) {
				throw ex.errn ? ex : new X3Error(20, ex.message);
			}
			fn = mod[name];
			if (!fn) throw new X3Error(4, "unknown JS function: " + nsVal + "." + name);
			var vals = args(_, frame);
			switch (mode) {
				case "sync":
					return fn.apply(this, vals);
				case "async":
					return flows.apply(_, fn, this, vals, 0);
				case "frame":
					return flows.apply(_, fn, this, [frame].concat(vals), 0);
				default:
					throw new X3Error(26, "invalid Calljs mode: " + mode);
			}
		};
	},
	BOX: function(kind, args) {
		var aargs = util.instructions.A(args);
		return function log$do(_, frame) {
			var message = aargs(_, frame).join('\t');
			var logger = kind === 'error' ? console.error : console.log;
			logger(message);
		};
	},
};