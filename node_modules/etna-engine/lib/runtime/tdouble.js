"use strict";
var X3Error = require('./errors').X3Error;
var util = require('./util');
var tbcd = require('./tbcd');
var tstring = require('./tstring');
var tinteger = require('./tinteger');
var tdate = require('./tdate');
var tdatetime = require('./tdatetime');

exports.isDouble = function(val) {
	return val instanceof Double ;
}

var Double = (function() {
	function Double( v ) {
    if (typeof v === "number")
      this.value = v ;
    else if (tinteger.isInteger(v))
      this.value = v.valueOf( ) ;
    else if (tbcd.isBCD(v))
      this.value= v.toDouble( ).valueOf( ) ;
    else throw util.badOperand(v);
  }

  Double.prototype.assertOverflow = function ( type ) {
    return true ;    
  }

  Double.prototype.minus = function( ) {
    return new Double( -this.value ) ;
  } 

  Double.prototype.valueOf = function() {
      return this.value ;
    } ;
  Double.prototype.toDouble = function() {
      return this ;
    } ;

  Double.prototype.toTString = function() {
    	return new tstring.TString( ""+this.value ) ;
  	} ;

  Double.prototype.toString = function() {
      return ""+this.value ;
    } ;

  Double.prototype.toBCD = function() {
    	return new tbcd.BCD( this ) ;
  	} ;

  Double.prototype.toInteger = function() {
      return new tinteger.Integer( Math.round(this.value) ) ;
    } ;

	Double.prototype.toDate = function() {
    	throw util.badOperand(this.value) ;
  	} ; 	

  Double.prototype.toDatetime = function() {
      throw util.badOperand(this.value) ;
    } ;   

	Double.prototype.isNumeric = function() {
		return true ;
	  } ;

  Double.prototype.isZero = function() {
		return (this.value === 0)?true : false ;
	  } ;	

  Double.prototype.compare = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);
      
      var bb=b.toDouble();
      var e = Math.abs( this.value ) ;
      var d = Math.abs( bb.value ) ;

      // compute precision  min(a, b)/10000000 or 1/100000000
      if (d < e) e = d ;
      if (e === 0) e = 1 ;
      e /= 1000000000 ;
      d = this.value - bb.value ;      

      if ((-e < d) && (d < e)) return 0
      else if (d >= e) return 1 ;
      else return -1 ;
  	} ;	

	Double.prototype.add = function( b ) {
      if (b.isNumeric()) { 
        var bb=b.toDouble();
        return new Double (this.value+bb.value) ;
      }
      else if (tdate.isDate(b)) { 
        //return b.add((this.value >= 0)?Math.floor(this.value):Math.ceil(this.value)) ;
        return b.add(this) ;
      }
      else if (tdatetime.isDatetime(b)) { 
        //return b.add((this.value >= 0)?Math.floor(this.value):Math.ceil(this.value)) ;
        return b.add(this) ;
      }
      else throw util.badOperand(b);
    
  	} ;

	Double.prototype.sub = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);

      var bb=b.toDouble();
      return new Double(this.value-bb.value) ;
    
  	} ;

	Double.prototype.mul = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);

      var bb=b.toDouble();
      return new Double(this.value*bb.value) ;
    
  	} ;

	Double.prototype.div = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);
      if (b.isZero())  throw new X3Error(53) ;

      var bb=b.toDouble();
      return new Double(this.value/bb.value);
    
  	} ;

	Double.prototype.mod = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);

      var bb=b.toDouble();
      return new Double(this.value%bb.value) ;
    
  	} ;

	Double.prototype.pow = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);

      var bb=b.toDouble();
      return new Double (Math.pow(this.value, bb.value));

  	} ;

  	Double.prototype.xor = function( b ) {
      if (!b.isNumeric()) throw util.badOperand(b);

      var i = (this.isZero())?1:0 ;
      var j = (b.isZero())?1:0 ;

      return new tinteger.Integer(i ^ j) ;
  	} ;

  	Double.prototype.abs = function() {
    	return new Double( Math.abs( this.value )) ;
  	} ;

  	Double.prototype.truncate = function() {
      var sign=(this.value < 0)?-1:1;
  		return new Double( Math.floor( Math.abs( this.value ) )*sign ) ;
  	} ;

    return Double ;
})( ) ;

exports.Double = Double ;