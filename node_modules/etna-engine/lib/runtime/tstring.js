"use strict";
var X3Error = require('./errors').X3Error;
var util = require('./util');
var tbcd = require('./tbcd');
var tdate = require('./tdate');
var tdatetime = require('./tdatetime');
var tdouble = require('./tdouble');

var RE_NUMBER    = /^([+-]?\d+(\.\d*)?([eE][+-]?\d+)?)$/;
var RE_ZERO      = /^[\s.0]*$/;
var RE_INTEGER   = /^[\s\d]*$/;
var RE_DATETIME  = /^\d{4}-(?:1[0-2]|0\d{1})-\d{2}T\d{2}\:\d{2}\:\d{2}\.\d{3}Z$/;


Object.defineProperty( String.prototype, "x3ToString", {
    value: function() {
	return  this ;
  }, 
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3ToDouble", {
    value: function() {
	return  new tdouble.Double( this ) ;
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3ToBCD", {
    value: function() {
	return  tbcd.fromString( this ) ;
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3ToInteger", {
    value: function() {
	return parseInt(this);
	},
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3Val", {
    value: function() {
      // Is it an integer ? (has to be the first)
      if(RE_INTEGER.exec(this)) return parseInt(this);
      // Is it a null string ?
      if(RE_ZERO.exec(this)) return 0.0;
      // Is it a date time
      if(RE_DATETIME.exec(this)) return new tdouble.Double(tdatetime.x3Parse(this).value);
      
      // is it a decimal ?
      var r = tbcd.fromString( this ) ;

      if (r.x3IsZero() && (RE_NUMBER.exec( this ) === null))
        throw util.badOperand(this) ;  

      return (r.isInt32(1)) ? r.x3ToInteger() : r ; 
 },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3IsEmpty", {
    value: function() {
      return  (this.length === 0)? true : false ;
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3Length", {
    value: function() {
      return  this.length ;
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3ToDate", {
    value: function() {   	
      if ( /^\d{8}$/.test(this) ) return tdate.parse(this, "yyyyMMdd") ;
      if ( /^\d{6}$/.test(this) ) return tdate.parse(this, "yyMMdd") ;
      /*if ( /^\d{2}\/\d{2}\/\d{2}$/.test(this) ) return tdate.parse(this, "dd/MM/yy") ;
      if ( /^\d{2}\/\d{2}\/\d{4}$/.test(this) ) return tdate.parse(this, "dd/MM/yyyy") ;
      */
      if(!this.length) return tdate.NULLDATE();
  		throw new X3Error(10,"") ;
    },
  enumerable: false
}) ;
	
Object.defineProperty( String.prototype, "x3Compare", {
    value: function(b) {
	if (util.x3IsString(b)){
		if (this === b) return 0 ;
		else if (this< b) return -1 ;
		else return 1 ;
	} else if (util.x3IsDate(b)){
		return 1;
	} else {
		throw util.badOperand(b);
	}
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3Add", {
    value: function(b) {
    	if (util.x3IsString(b)){
    		return  this+b;
    	}else if (util.x3IsDate(b)){
			return this+b.x3ToString();
		} else {
			throw util.badOperand(b);
		}
  },
  enumerable: false
}) ;
	
Object.defineProperty( String.prototype, "x3IsNumeric", {
    value: function() {
    	return false ;
  },
  enumerable: false
}) ;
	
Object.defineProperty( String.prototype, "x3Minus", {
    value: function() {
    	return " "+this ;
  },
  enumerable: false
}) ;

Object.defineProperty( String.prototype, "x3Sub", {
    value: function(b) {
    	if (util.x3IsString(b)){
    		return  util.x3Trim( this, 1 )+" "+util.x3Trim( b, 0 ) ;
    	}else if (util.x3IsDate(b)){
			return util.x3Trim( this, 1 )+" "+util.x3Trim( b.x3ToString(), 0 ) ;
		} else {
			throw util.badOperand(b);
		}
  },
  enumerable: false
}) ;



