"use strict";

var helpers = require('syracuse-core/lib/helpers');

var DBFor = helpers.defineClass(function(reader, tables, maptrim, pwhere, key, lvl) {
	var self = this;

	self.reader = reader;
	self.tables = tables;
	self.maptrim = maptrim;
	self.pwhere = pwhere;
	self.key = key;
	self.klvl = lvl;
	self.level = 0;
	self.currkeyValues = [];
	return self;
}, null, {

	x3GetRecord: function(_) {
		var self = this;

		var maptrim = self.maptrim;
		var pwhere = self.pwhere;
		var tables = self.tables;
		var wok = 1;

		var rec = self.reader.read(_, 1);
		while (rec) {
			var row = maptrim(rec);
			Object.keys(row).forEach(function(abv) {
				tables[abv].values = row[abv];
			});

			// post evaluations have to be ok
			for (var i = 0; i < pwhere.length; i++) {
				var w = pwhere[i](_);
				var r = w.reduce(function(r, c) {
					return r & c;
				}, 1);
				wok = wok & r;
			}
			if (!wok) rec = self.reader.read(_, 1);
			else break;
		}
		return rec;
	}
});

exports.DBFor = DBFor;