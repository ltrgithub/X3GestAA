Call OUVRE_TRACE("QLFAC_I_SNAPSHOT") From LECFIC
Call TESTSUITE()

Call FERME_TRACE From LECFIC

GTRACE = "QLFAC_I_SNAPSHOT_"+GACTX.USER
Call LEC_TRACE From LECFIC
End


Funprog TESTSUITE()
Call ADD_TESTCASE("TC_SNAPSHOT0", "Test snapshot 0", 10) From AXUNIT
#Call ADD_TESTCASE("TC_SNAPSHOT1", "Test snapshot 1", 10) From AXUNIT
#Call ADD_TESTCASE("TC_SNAPSHOT2", "Test snapshot 2", 65) From AXUNIT
#Call ADD_TESTCASE("TC_SYSSNAPSHOT0", "Test syssnapshot 0", 5) From AXUNIT
#Call ADD_TESTCASE("TC_SYSSNAPSHOT1", "Test syssnapshot 1", 10) From AXUNIT
End func AXUNIT.RUN_TESTSUITE("QLFAC_I_SNAPSHOT", "QLFAC_I_SNAPSHOT")



#########################################################################
Subprog TC_SNAPSHOT0( )
#########################################################################
Local Instance TST0 Using C_AQCPROC03
Local Instance TST2 Using C_AQCPROC03
Local Integer  I

TST0 = NewInstance C_AQCPROC03

TST0.C03P01  = "5"
TST0.C03P01.$isHidden  = CST_ATRUE
TST0.snapshotEnabled = 1
Call CHECK_EQUAL( TST0.snapshotEnabled, 1 )  From AXUNIT
Call CHECK_EQUAL( TST0.C03P01, "5" )  From AXUNIT

Call CHECK_EQUAL( TST0.snapshot.C03P01, "5" )  From AXUNIT
Call CHECK_EQUAL( TST0.snapshot.C03P01.$isHidden,CST_ATRUE)  From AXUNIT

TST0.C03P01 = "6"
TST0.C03P01.$isHidden  = CST_AFALSE
Call CHECK_EQUAL( TST0.C03P01, "6" )  From AXUNIT
Call CHECK_EQUAL( TST0.C03P01.$isHidden,CST_AFALSE)  From AXUNIT
Call CHECK_EQUAL( TST0.snapshot.C03P01, "5" )  From AXUNIT
Call CHECK_EQUAL( TST0.snapshot.C03P01.$isHidden,CST_ATRUE)  From AXUNIT

TST0.snapshotEnabled = 0
TST2 = TST0.snapshot

I = 0
If(TST2 = null)
  I = 1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT

TST0.snapshotEnabled = 1
TST2 = TST0.snapshot
I = 0
If (TST2 <> null)
  I = 1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT
FreeInstance TST0

End


#########################################################################
Subprog TC_SNAPSHOT1( )
#########################################################################
Local Instance TST0 Using ZXCSTRU3
Local Instance TST2 Using ZXCSTRU3
Local Instance TST4 Using ZXDSTRU3
Local Char FIELDS(20)(1..)
Local Integer I
Local Integer K

TST0 = NewInstance ZXCSTRU3 AllocGroup null

TST0.DDD(1) = NewInstance ZXDSTRU3 AllocGroup TST0
TST0.DDD(2) = NewInstance ZXDSTRU3 AllocGroup TST0

TST0.DDD(1).M = 1
TST0.DDD(1).O = TST0

TST0.DDD(2).M = 2
TST0.DDD(2).O = TST0

# test with extent copy
TST0.AAA(1) = 5
For I = 1 To 100
    Append TST0.IIII, "01234567890123456789"
Next

TST0.snapshotEnabled = 1

TST4 = TST0.snapshot.DDD(2)
TST0.DDD(2).M = 3
I = TST4.M
Call CHECK_NOTEQUAL( I, TST0.DDD(2).M )  From AXUNIT

TST0.AAA(1) = 6
I = TST0.snapshot.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT
Call CHECK_EQUAL( len(TST0.IIII), len( TST0.snapshot.IIII) )  From AXUNIT
Call CHECK_EQUAL( TST0.snapshotEnabled, 1 )  From AXUNIT


Callmet TST0.SNAPAAA( I )
Call CHECK_EQUAL( I, 5 )  From AXUNIT

Callmet TST0.SNAPDDD( I )
Call CHECK_EQUAL( I, 2 )  From AXUNIT


I = TST0.revertToSnapshot

K = TST0.getModified( FIELDS )
Call CHECK_EQUAL( K, 0 )  From AXUNIT


I = TST0.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT

I = TST0.DDD(2).M
Call CHECK_EQUAL( I, 2 )  From AXUNIT

FreeInstance TST0.DDD(2)
TST0.DDD(2) = null
I = TST0.freeSnapshot
TST0.snapshotEnabled = 0

TST2 = TST0.snapshot
I = 0
If (TST2 = null)
  I=1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT

FREEGROUP TST0

End


#########################################################################
Subprog TC_SNAPSHOT2( )
#########################################################################
Local Instance TST0 Using ZXCSTRU3
Local Instance TST2 Using ZXCSTRU3
Local Integer INI(1..5,1..3)
Local Integer I,K,L
Local Integer IND0(1..)
Local Integer IND1(1..)
Local Integer IND2(1..)
Local Integer IND3(1..)
Local Char FIELDS(20)(1..)


TST0 = NewInstance ZXCSTRU3  AllocGroup null

INI(4,2) = 1
INI(3,3) = 1
INI(5,1) = 1
INI(2,2) = 1
INI(4,3) = 1

TST0.snapshotEnabled=1
TST0.AAA(4) = 5
TST0.BBB = "toto"

TST0.GGG(4,2) = 1
TST0.GGG(3,3) = 1
TST0.GGG(5,1) = 1
TST0.GGG(2,2) = 1
TST0.GGG(4,3) = 1

For K=1 To 5
    For L=1 To 3
      Call CHECK_EQUAL( INI(K,L), TST0.GGG(K, L).modified )  From AXUNIT
    Next
Next

K = TST0.getModified( FIELDS , IND0, IND1, IND2, IND3)
Call CHECK_EQUAL( K, 7 )  From AXUNIT

Call CHECK_EQUAL( FIELDS(1), "AAA" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(2), "BBB" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(3), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(4), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(5), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(6), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(7), "GGG" )  From AXUNIT

Call CHECK_EQUAL( IND0(1), 4 )  From AXUNIT
Call CHECK_EQUAL( IND0(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND0(3), 5 )  From AXUNIT
Call CHECK_EQUAL( IND0(4), 2 )  From AXUNIT
Call CHECK_EQUAL( IND0(5), 4 )  From AXUNIT
Call CHECK_EQUAL( IND0(6), 3 )  From AXUNIT
Call CHECK_EQUAL( IND0(7), 4 )  From AXUNIT

Call CHECK_EQUAL( IND1(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND1(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND1(3), 1 )  From AXUNIT
Call CHECK_EQUAL( IND1(4), 2 )  From AXUNIT
Call CHECK_EQUAL( IND1(5), 2 )  From AXUNIT
Call CHECK_EQUAL( IND1(6), 3 )  From AXUNIT
Call CHECK_EQUAL( IND1(7), 3 )  From AXUNIT

Call CHECK_EQUAL( IND2(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(3), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(4), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(5), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(6), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(7), 0 )  From AXUNIT

Call CHECK_EQUAL( IND3(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(3), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(4), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(5), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(6), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(7), 0 )  From AXUNIT

TST2 = NewInstance ZXCSTRU3 ALLOCGROUP NULL
TST2.snapshotEnabled=1
TST2.HHH(1) = 1
TST2.HHH(3) = 1
TST2.HHH(5) = 1

For I = 1 To 5
     Call CHECK_EQUAL( TST2.HHH(I), TST2.HHH(I).modified )  From AXUNIT
Next

TST2.BBB = "tata"
K = TST2.getModified( FIELDS , IND0 )
Call CHECK_EQUAL( K, 4 )  From AXUNIT

Call CHECK_EQUAL( FIELDS(1), "BBB" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(2), "HHH" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(3), "HHH" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(4), "HHH" )  From AXUNIT


Call CHECK_EQUAL( IND0(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND0(2), 1 )  From AXUNIT
Call CHECK_EQUAL( IND0(3), 3 )  From AXUNIT
Call CHECK_EQUAL( IND0(4), 5 )  From AXUNIT



FREEINSTANCE TST0
FreeInstance TST2
End


#########################################################################
Subprog TC_SYSSNAPSHOT0( )
#########################################################################
Local Instance TST0 Using ZXCSTRU3
Local Instance TST2 Using ZXCSTRU3
Local Integer I

TST0 = NewInstance ZXCSTRU3  AllocGroup TST0


TST0.AAA(1) = 5
TST0.sysSnapshotEnabled = 1

I = TST0.sysSnapshot.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT

TST0.AAA(1) = 6
I = TST0.sysSnapshot.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT

TST0.sysSnapshotEnabled = 0
TST2 = TST0.sysSnapshot
I = 0
If (TST2 = null)
  I = 1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT

TST0.sysSnapshotEnabled = 1
TST2 = TST0.sysSnapshot
I = 0
If (TST2 <> null)
  I = 1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT

FreeInstance TST0

End


#########################################################################
Subprog TC_SYSSNAPSHOT1( )
#########################################################################
Local Instance TST0 Using ZXCSTRU3
Local Instance TST2 Using ZXCSTRU3
Local Instance TST4 Using ZXDSTRU3
Local Char FIELDS(20)(1..)
Local Integer I
Local Integer K

TST0 = NewInstance ZXCSTRU3  AllocGroup null

TST0.DDD(1) = NewInstance ZXDSTRU3  AllocGroup TST0
TST0.DDD(2) = NewInstance ZXDSTRU3 AllocGroup TST0

TST0.DDD(1).M = 1
TST0.DDD(1).O = TST0

TST0.DDD(2).M = 2
TST0.DDD(2).O = TST0

# test with extent copy
TST0.AAA(1) = 5
For I = 1 To 100
    Append TST0.IIII, "01234567890123456789"
Next

TST0.sysSnapshotEnabled = 1

TST4 = TST0.sysSnapshot.DDD(2)
TST0.DDD(2).M = 3
I = TST4.M
Call CHECK_NOTEQUAL( I, TST0.DDD(2).M )  From AXUNIT

TST0.AAA(1) = 6
I = TST0.sysSnapshot.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT
Call CHECK_EQUAL( len(TST0.IIII), len( TST0.sysSnapshot.IIII) )  From AXUNIT
Call CHECK_EQUAL( TST0.sysSnapshotEnabled, 1 )  From AXUNIT


Callmet TST0.SYSSNAPAAA( I )
Call CHECK_EQUAL( I, 5 )  From AXUNIT

Callmet TST0.SYSSNAPDDD( I )
Call CHECK_EQUAL( I, 2 )  From AXUNIT

I = TST0.revertToSysSnapshot

K = TST0.getSysModified( FIELDS )
Call CHECK_EQUAL( K, 0 )  From AXUNIT


I = TST0.AAA(1)
Call CHECK_EQUAL( I, 5 )  From AXUNIT

I = TST0.DDD(2).M
Call CHECK_EQUAL( I, 2 )  From AXUNIT

FreeInstance TST0.DDD(2)
TST0.DDD(2) = null
I = TST0.freeSysSnapshot
TST0.sysSnapshotEnabled = 0

TST2 = TST0.sysSnapshot
I = 0
If (TST2 = null)
  I=1
Endif
Call CHECK_EQUAL( I, 1 )  From AXUNIT

FreeGroup TST0

End


#########################################################################
Subprog TC_SYSSNAPSHOT2( )
#########################################################################
Local Instance TST0 Using ZXCSTRU3
Local Instance TST2 Using ZXCSTRU3
Local Integer INI(1..5,1..3)
Local Integer I,K,L
Local Integer IND0(1..)
Local Integer IND1(1..)
Local Integer IND2(1..)
Local Integer IND3(1..)
Local Char FIELDS(20)(1..)


TST0 = NewInstance ZXCSTRU3 AllocGroup null

INI(4,2) = 1
INI(3,3) = 1
INI(5,1) = 1
INI(2,2) = 1
INI(4,3) = 1

TST0.sysSnapshotEnabled=1
TST0.AAA(4) = 5
TST0.BBB = "toto"

TST0.GGG(4,2) = 1
TST0.GGG(3,3) = 1
TST0.GGG(5,1) = 1
TST0.GGG(2,2) = 1
TST0.GGG(4,3) = 1

For K=1 To 5
    For L=1 To 3
      Call CHECK_EQUAL( INI(K,L), TST0.GGG(K, L).sysModified )  From AXUNIT
    Next
Next

K = TST0.getSysModified( FIELDS , IND0, IND1, IND2, IND3)
Call CHECK_EQUAL( K, 7 )  From AXUNIT

Call CHECK_EQUAL( FIELDS(1), "AAA" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(2), "BBB" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(3), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(4), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(5), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(6), "GGG" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(7), "GGG" )  From AXUNIT

Call CHECK_EQUAL( IND0(1), 4 )  From AXUNIT
Call CHECK_EQUAL( IND0(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND0(3), 5 )  From AXUNIT
Call CHECK_EQUAL( IND0(4), 2 )  From AXUNIT
Call CHECK_EQUAL( IND0(5), 4 )  From AXUNIT
Call CHECK_EQUAL( IND0(6), 3 )  From AXUNIT
Call CHECK_EQUAL( IND0(7), 4 )  From AXUNIT

Call CHECK_EQUAL( IND1(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND1(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND1(3), 1 )  From AXUNIT
Call CHECK_EQUAL( IND1(4), 2 )  From AXUNIT
Call CHECK_EQUAL( IND1(5), 2 )  From AXUNIT
Call CHECK_EQUAL( IND1(6), 3 )  From AXUNIT
Call CHECK_EQUAL( IND1(7), 3 )  From AXUNIT

Call CHECK_EQUAL( IND2(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(3), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(4), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(5), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(6), 0 )  From AXUNIT
Call CHECK_EQUAL( IND2(7), 0 )  From AXUNIT

Call CHECK_EQUAL( IND3(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(2), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(3), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(4), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(5), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(6), 0 )  From AXUNIT
Call CHECK_EQUAL( IND3(7), 0 )  From AXUNIT

TST2 = NewInstance ZXCSTRU3 AllocGroup TST0
TST2.sysSnapshotEnabled = 1
TST2.HHH(1) = 1
TST2.HHH(3) = 1
TST2.HHH(5) = 1

For I = 1 To 5
     Call CHECK_EQUAL( TST2.HHH(I), TST2.HHH(I).sysModified )  From AXUNIT
Next

TST2.BBB = "tata"
K = TST2.getSysModified( FIELDS , IND0 )
Call CHECK_EQUAL( K, 4 )  From AXUNIT

Call CHECK_EQUAL( FIELDS(1), "BBB" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(2), "HHH" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(3), "HHH" )  From AXUNIT
Call CHECK_EQUAL( FIELDS(4), "HHH" )  From AXUNIT


Call CHECK_EQUAL( IND0(1), 0 )  From AXUNIT
Call CHECK_EQUAL( IND0(2), 1 )  From AXUNIT
Call CHECK_EQUAL( IND0(3), 3 )  From AXUNIT
Call CHECK_EQUAL( IND0(4), 5 )  From AXUNIT

FreeInstance TST0
FreeInstance TST2

End

