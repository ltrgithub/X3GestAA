"use strict";
var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

var glob = require('streamline/lib/globals');
var runtime = require("etna-engine/lib/runtime/runtime");
var script;
var superv;

asyncTest("start", function(_) {
	var supervisor = require('etna-supervisor/lib/supervisor');
	var config = require("etna-util/lib/nodeconfig").config;
	superv = supervisor.create(_,config.unit_test.etnaEndPoint);
	require("etna-engine/lib/runtime/variables").initStack(superv);
	script = runtime.requireScript(_,"test-snapshots"); 
	ok(true,"start");
	start();
});

function gosub(_,fnName) {
	var frame = glob.context.x3frame;
	frame.done = false;
	frame.sub.done = false;
	ok(true,"=> "+fnName);
	script[fnName].apply_(_, null, [], 0 );
}

function initStack() {
	var frame = glob.context.x3frame;
	frame.values = {};
	frame.types  = {};
	return frame.values;
}

asyncTest("TC_SNAPSHOT", function(_) {
	var locals = initStack();
	gosub(_,"TC_SNAPSHOT_SETUP");
	gosub(_,"TC_SNAPSHOT_00");
	// enable snapshots :
	locals.INS.enableSnapshot();
	gosub(_,"TC_SNAPSHOT_01");
	// disable snapshots :
	locals.INS.disableSnapshot();
	gosub(_,"TC_SNAPSHOT_00");

	// enable snapshots :
	locals.INS.enableSnapshot();
	gosub(_,"TC_SNAPSHOT_01");
	gosub(_,"TC_SNAPSHOT_02");

	// Clean the stack 
	// Revert to initial status
	/*setTimeout(_,5000);
	debugger;*/
	locals.INS.revertToSnapshot();
	locals.INS.enableSnapshot();
	gosub(_,"TC_SNAPSHOT_01");
	gosub(_,"TC_SNAPSHOT_03");

	// Revert to initial status
	locals.INS.revertToSnapshot();
	// disable snapshots :
	locals.INS.disableSnapshot();
	gosub(_,"TC_SNAPSHOT_00");
	
	gosub(_,"TC_SNAPSHOT_99");
	gosub(_,"TC_SNAPSHOT_TEARDOWN");
	start();
});

asyncTest("stop", function() {
	doStop = true;
	ok(true,"stop")
	start();
});
