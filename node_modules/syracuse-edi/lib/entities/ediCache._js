"use strict";

var config = require('config');
var globals = require('streamline/lib/globals');
var sa = require("@sage/syracuse-lib/src/orm/storageArea");
var jsxml = require('js-xml');
var fs = require("streamline-fs");
var os = require("os");

var _TMPDIR = require("os").tmpdir();


exports.entity = {
	$capabilities: "",
	$titleTemplate: "EDI Cache Entity",
	$descriptionTemplate: " ",
	$properties: {
		id: {
			$title: "id", // id of the edi process context , must be unique (ex X3 name + type )
		},
		type: {
			$title: "type of flow", // class json/ representation etc...
			$default: "jsoncache"
		},
		etag: {
			$title: "ETag",
		},
		json: { // json correspond to the context used for a edi process
			$title: "object",
			$type: "json",
			$isHidden: true
		},
		xmlPathId: {
			$title: "Xml paths document id",
			//$isHidden: true,
			$propagate: function(_, instance, val) {
				globals.context.session.xmlPathId = val;
			}
		},
		xsdFiles: {
			$title: "list of xsd file as a json array"
		}


	},
	$relations: {

	},

	$functions: {
		// ge thte main xsd path in order to validate xml
		getMainXsdFilePath: function(_) {
			var xsd = null;
			if (this.xsdFiles(_)) { // contain ordered list of uuid of xsd file store in storage area with the main one at the first one
				var sep = "/"; // always this path separator!
				var pathSchemaLocation = _TMPDIR.replace(/\\/g, "/").replace(/^([A-Za-z]):/, "file:///$1:");

				if (os)
					var p = JSON.parse(this.xsdFiles(_))
						// retrive the xsd files content depending of the uuid
				var pathFirst = "";
				Array.isArray(p) && p.forEach_(_, function(_, obj) {
					xsd = sa.readAll(_, {
						jsonWhere: {
							$uuid: obj.uuid
						}
					}).toString('utf8');
					// WARNING -> limitation here this code has to be improve bnut it's ok for facturae.
					// the filename in storage area should be name of the file in order have it worked and
					// the we can't have 2 xsd with the same name TODO use name space to retrieave xsd link to import and use generated file name
					var rg = new RegExp('schemaLocation=\"(.*.xsd)\"', "g");

					var fileName = rg.exec(xsd);
					fileName = fileName && fileName[1] ? fileName[1] : null;
					if (fileName) {
						var fname = fileName;
						if (fileName.indexOf("/") !== -1) {
							var f = fileName.split("/");
							fname = f[f.length - 1];
						}
						xsd = xsd.replace(rg, "schemaLocation=\"" + pathSchemaLocation + sep + fname + "\"");
					}
					// write this file in a temp folder in order to be able to use it as a validation
					var path = _TMPDIR + sep + obj.fileName;
					fs.writeFile(path, xsd, _);
					if (!pathFirst) pathFirst = path;
				})
			}

			// merge files to have one only xsd file in order to validate 

			return pathFirst;
		},

	},
	$services: {},

	$uniqueConstraints: [
		["id", "type"]
	]

};