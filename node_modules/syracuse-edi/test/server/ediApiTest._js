"use strict";

var config = require('config'); // must be first syracuse require
var helpers = require('syracuse-core').helpers;
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require('mongodb');
var sys = require("util");
var factory = require("syracuse-orm/lib/factory");
var jsonImport = require("syracuse-import/lib/jsonImport");
var jsonExport = require("syracuse-import/lib/jsonExport");
var datetime = require("syracuse-core").types.datetime;
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var fs = require("streamline-fs");
var _defDataDir = require("path").join(__dirname, "../server/data/");
var ez = require('ez-streams');
var EdiProcess = require("syracuse-edi/lib/edi_Process");
var EdiEntity = require("syracuse-edi/lib/edi_Entity");
var EdiType = require("syracuse-edi/lib/enumType").EdiType;
var ediSadUnitConfig = config.edi && config.edi.unit && config.edi.unit.sadfsq || {};
var protocolDirectory = require("syracuse-edi/lib/protocolHandler/directoryProtocol");
var SadFsqClient = require('syracuse-x3/lib/clients/sadfsq/sadfsqClient').SadFsqClient;
var sa = require("syracuse-orm/lib/storageArea");
var jsxml = require('js-xml');
var globals = require('streamline-runtime').globals;

//force basic auth
config.session = config.session || {};
config.session.auth = "basic";
//no integration server
config.integrationServer = null;

helpers.pageFileStorage = false;

var tracer; // = console.error;

//
var requestCount = 0;
var MAX_REQUESTS = 11;

var port = (config.unit_test && config.unit_test.serverPort) || 3004;
var baseUrl = "http://localhost:" + port;
var contractUrl = "/sdata/syracuse/collaboration/unit_test/";
var acceptLanguage = "fr,fr-fr";

var franceID = "";
var usID = "";
var printUuid = "";
var dbName = "unit_test";
var endpoint = adminTestFixtures.modifyCollaborationEndpoint(dbName);

var endpointTest;
var cookie = "";
var x3sId;
var applicationId;
var adminEp;

function _getModel() {
	return dataModel.make(registry.applications.syracuse.contracts.collaboration, "unit_test");
}

function get(_, cookie, url, statusCode, fullResponse) {
	return adminTestFixtures.get(_, cookie, url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/unit_test/" + url, statusCode, fullResponse);
}

function post(_, cookie, url, data, statusCode, fullResponse) {
	return adminTestFixtures.post(_, cookie, url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/unit_test/" + url, data, statusCode, fullResponse);
}

function put(_, cookie, url, data, statusCode, fullResponse) {
	return adminTestFixtures.put(_, cookie, url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/unit_test/" + url, data, statusCode, fullResponse);
}

function del(_, cookie, url, statusCode, fullResponse) {
	return adminTestFixtures.del(_, cookie, url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/unit_test/" + url, statusCode, fullResponse);
}
globals.context.session = {
	id: helpers.uuid.generate(),
	getUserLogin: function(_) {
		return "guest";
	},
	getUserProfile: function(_) {

		return {
			user: function(_) {
				// getting the administration ORM
				// var db = adminHelper.getCollaborationOrm(_);

				// the metamodel is associated to the orm
				var model = db.model;

				var entity = db.model.getEntity(_, "user");
				// fetchInstance(callback, entity, filter)
				return db.fetchInstance(_, entity, {
					jsonWhere: {
						login: "admin"
					}
				});

			}
		};
	},
	getSecurityProfile: function(_) {
		return null;
	},
	getData: function(key) {
		if (key === "userLogin") return "admin";
		return null;
	},
};
var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {}
});

function onlyInfo(diags) {
	return adminTestFixtures.onlyInfo(diags);
}

var db;
asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endpoint.datasets["unit_test"].hostname, endpoint.datasets["unit_test"].port, {});
	db = adminTestFixtures.newMongoDb(endpoint.datasets["unit_test"].database, server, {});
	db = db.open(_);
	db.dropDatabase(_);

	ok(true, "mongodb initialized");
	start();
});

//start syracuse server
asyncTest("initialize syracuse test server", 1, function(_) {
	require('syracuse-main/lib/syracuse').startServers(_, port);
	ok(true, "server initialized");
	start();
});

var prototype_EDISIH1;
var prototype_EDISIHEndFlag;
var baseUrl = "http://localhost:3004";
var db;
var prototype_EDISIH1SCOL;
var prototype_EDIS0H2;
var prototype_EDISIH1FACTURA;

function readFile(filepath, encoding, _) {
	var read = fs.readFile(_defDataDir + filepath, encoding, _);
	if (read.indexOf('\r') === -1) {
		// read.replace(/\n/g,"\n\r");
	}
	return read;
}
var endpointTest;
globals.context = globals.context || {};
globals.context.session = {
	id: helpers.uuid.generate(),
	getUserLogin: function(_) {
		return "guest";
	},
	getUserProfile: function(_) {

		return {
			user: function(_) {
				// getting the administration ORM
				var db = adminHelper.getCollaborationOrm(_);

				// the metamodel is associated to the orm
				var model = db.model;

				var entity = db.model.getEntity(_, "user");
				// fetchInstance(callback, entity, filter)
				return db.fetchInstance(_, entity, {
					jsonWhere: {
						login: "admin"
					}
				});

			},
			selectedLocale: function(_) {
				return adminHelper.getCollaborationOrm(_).fetchInstance(_, db.model.getEntity(_, "localePreference"), {
					sdataWhere: "code eq 'en-us'"
				});
			}
		};
	},
	getSecurityProfile: function(_) {
		return null;
	},
	getData: function(code) {
		return null;
	}
};
QUnit.module(module.id, {});
var endpoint, db;
var prototype_EDISIH1;
var prototype_EDISIHEndFlag;
var port = (config.unit_test && config.unit_test.serverPort) || 3004;
var baseUrl = "http://localhost:" + port;

var prototype_EDISIH1SCOL;
var prototype_EDIS0H2;
var prototype_EDISIH1FACTURA;




function _initPrototypeCache(_, database) {
	EdiEntity.dropAllEdiCacheEntity(_, {
		db: database
	});
	EdiProcess.removeAllEdiProcess(_, {
		db: database
	});
}

asyncTest("start test environment ", function(_) {


	prototype_EDISIH1 = JSON.parse(readFile("context/EDISIH1_$details.json", 'utf-8', _));
	prototype_EDISIH1SCOL = JSON.parse(readFile("context/EDISIH1SCOL_$details.json", 'utf-8', _));
	prototype_EDIS0H2 = JSON.parse(readFile("context/EDISOH2_$details.json", 'utf-8', _));
	prototype_EDISIH1FACTURA = JSON.parse(readFile("context/EDISIH1FACTURA_$details.json", 'utf-8', _));
	prototype_EDISIHEndFlag = JSON.parse(readFile("context/EDISIHEndFlag.json", 'utf-8', _));

	start();

});

asyncTest("data setup", 1, function(_) {
	db = dataModel.getOrm(_, _getModel(), endpoint.datasets.unit_test);
	// import
	var diag = [];

	jsonImport.jsonImport(_, db, "syracuse-admin-demo.json", {
		$diagnoses: diag
	});
	ok(onlyInfo(diag), "Demo database import ok");

	start();
});

asyncTest("init test environment ", function(_) {
	function post(_, cookie, url, data, statusCode) {
		var response = ez.devices.http.client({
			method: "post",
			url: url.indexOf("http") == 0 ? url : baseUrl + contractUrl + url,
			headers: {
				"content-type": "application/json",
				cookie: cookie
			}
		}).end(JSON.stringify(data)).response(_);
		var resp = JSON.parse(response.readAll(_));
		strictEqual(response.statusCode, statusCode || 201, "status verified");
		return resp;
	}

	// create GX3APP endpoint
	var body, appId;
	var cookie = adminTestFixtures.getCookie(_, baseUrl, "admin", "admin");
	var app = adminHelper.getApplication(_, "x3", "erp");
	if (app) {
		appId = app.$uuid;
	}

	// create x3 server
	body = post(_, cookie, "x3solutions", {
		code: "X3 stub server",
		description: "X3 stub server",
		solutionName: "X3DVLP",
		serverHost: "aws-x3-devx3",
		serverPort: 2050,
		proxy: false,
		application: {
			$uuid: appId
		},
		serverTimeout: 60000
	}, 201);
	var x3solutionId = body.$uuid;

	// create endpoint
	//tracer && tracer("x3 endpoint route creating ep");
	body = post(_, cookie, "endPoints", {
		description: "X3 gx3app",
		applicationRef: {
			$uuid: appId
		},
		dataset: "GX3APP",
		enableSearch: false,
		protocol: "x3",
		x3solution: {
			$uuid: x3solutionId
		},
		x3ServerFolder: "GX3APP"
	}, 201);
	endpointTest = adminHelper.getEndpoint(_, {
		application: "x3",
		contract: "erp",
		dataset: "GX3APP"
	});
	start();
});

var uuidJSonSOH;
asyncTest("API store json", function(_) {
	// test create instance
	_initPrototypeCache(_, db);
	var jsons2 = [{
		"json1": "test1"
	}];
	var uuids = EdiEntity.createEdiCacheEntity(_, {
		json: jsons2,
		type: "sas",
		id: "jsons2",
		db: db
	});
	strictEqual(uuids.length === 1, true, "create EdiCacheEntity with an array of 1 json " + JSON.stringify(uuids));

	var jsons1 = [{
		"json2": "test1"
	}, {
		"json4": "toto"
	}, {
		"json5": "tat"
	}];
	var uuids2 = EdiEntity.createEdiCacheEntity(_, {
		json: jsons1,
		type: "sas",
		id: "json1",
		db: db
	});
	strictEqual(uuids2.length === 3, true, "create EdiCacheEntity with an array of 3 json " + JSON.stringify(uuids2));
	// create the same entity --> must failed
	try {
		EdiEntity.createEdiCacheEntity(_, {
			json: jsons1,
			type: "sas",
			id: "json1",
			db: db
		});
		ok(false, "forbidden to create same entity failed ");
	} catch (e) {
		ok(true, "forbidden to create same entity failed ok");

	}

	var uuid = EdiEntity.createEdiCacheEntity(_, {
		json: {
			"json6": "test1"
		},
		type: "sas",
		id: "json6",
		db: db
	});
	strictEqual(uuids != null, true, "create EdiCacheEntity with an json object " + JSON.stringify(uuid));

	// test retrieve  instance
	try {
		var json1 = EdiEntity.getEdiCacheJson(_, {
			uuid: uuid,
			db: db
		});
		strictEqual(JSON.stringify(json1), '{"json6":"test1"}', "get EdiCacheEntity json from a uuid=[" + uuid + "] : " + JSON.stringify(json1));
	} catch (e) {
		ok(false, " get EdiCacheEntity json from a uuid " + e.stack);
	}

	// test with filter
	try {
		var jsonFilter = EdiEntity.getEdiCacheJson(_, {
			filter: {
				jsonWhere: {
					id: "json6",
					type: "sas"
				}
			},
			db: db
		});
		strictEqual(JSON.stringify(jsonFilter), '{"json6":"test1"}', "get EdiCacheEntity with filter json from a uuid=[" + uuid + "] : " + JSON.stringify(jsonFilter));
	} catch (e) {
		ok(false, " get EdiCacheEntity json from a uuid " + e.stack);
	}

	try {
		json1 = EdiEntity.getEdiCacheJson(_, {
			uuid: uuids2,
			db: db
		});
		strictEqual(json1.length === jsons1.length, true, "get EdiCacheEntity json from a uuid=[" + JSON.stringify(uuids2) + "]");
		for (var i = 0; i < json1.length; i++) {
			strictEqual(JSON.stringify(json1[i][uuids2[i]]), JSON.stringify(jsons1[i]), "get EdiCacheEntity json from a uuid=[" + JSON.stringify(json1[i]) + "]");
		}
	} catch (e) {
		ok(false, " get EdiCacheEntity json from a uuid " + e.stack);
	}

	try {
		json1 = EdiEntity.getEdiCacheJson(_, {
			uuid: uuids,
			db: db
		});
		strictEqual(json1.length === jsons2.length, true, "get EdiCacheEntity json from a uuid=[" + JSON.stringify(uuids) + "]");
		for (var i = 0; i < json1.length; i++) {
			strictEqual(JSON.stringify(json1[i][uuids[i]]), JSON.stringify(jsons2[i]), "get EdiCacheEntity json from a uuid=[" + JSON.stringify(json1[i]) + "]");
		}
	} catch (e) {
		ok(false, " get EdiCacheEntity json from a uuid " + e.stack);
	}

	// test delete instance
	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});
	strictEqual(EdiEntity.getEdiCacheJson(_, {
		uuid: uuid,
		db: db
	}) === null, true, "remove EdiCacheEntity json from a uuid=[" + uuid + "] ok ");

	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuids2,
		db: db
	});
	try {
		EdiEntity.getEdiCacheJson(_, {
			uuid: uuids2,
			db: db
		});
		ok(false, "remove EdiCacheEntity json from a uuid=[" + JSON.stringify(uuids2) + "] ok ");
	} catch (e) {
		ok(true, "remove EdiCacheEntity json from a uuid=[" + JSON.stringify(uuids2) + "] ok ");

	}
	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuids,
		db: db
	});
	strictEqual(EdiEntity.getEdiCacheJson(_, {
		uuid: uuids[0],
		db: db
	}) === null, true, "remove EdiCacheEntity json from a uuid=[" + JSON.stringify(uuids) + "] ok ");

	// test get non exists data
	strictEqual(EdiEntity.getEdiCacheJson(_, {
		uuid: "test uuid dummy",
		db: db
	}) === null, true, "get EdiCacheEntity json from a uuid=[test uuid dummy] ok ");

	// test remove non exists data
	EdiEntity.removeEdiCacheEntity(_, {
		uuid: "test uuid dummy",
		db: db
	});

	// create a instance with a bad data
	try {
		uuids = EdiEntity.createEdiCacheEntity(_, {
			json: "test with bad data",
			type: "sas",
			id: "testDummy",
			db: db
		});
		ok(false, "test create edi instance with bad json data passe in a string ");
		EdiEntity.removeEdiCacheEntity(_, {
			uuid: uuids,
			db: db
		});

	} catch (e) {
		ok(true, "test create edi instance with bad json data passe in a string ");
	}


	// test create multiple instance
	uuids = EdiEntity.createEdiCacheEntity(_, {
		json: [{}, {
			"id": "test2"
		}, {
			"id": "test3"
		}],
		type: "sas",
		id: "testdummyArray",
		db: db
	});
	ok(uuids.length, 3, "test create edi instance with 3 json data ");
	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuids,
		db: db
	});

	try {
		uuids = EdiEntity.createEdiCacheEntity(_, {
			json: ["test with bad data", {
				"id": "test2"
			}, {
				"id": "test3"
			}],
			type: "sas",
			id: "testdummyArray",
			db: db
		});
		ok(false, "test create edi instance with bad json data passed in a string ");
		EdiEntity.removeEdiCacheEntity(_, {
			uuid: uuids,
			db: db
		});

	} catch (e) {
		ok(true, "test create edi instance with bad json data passe in an array ");
	}

	// test with etag like seqFile
	var uuidsSeqFile = EdiEntity.createEdiCacheEntity(_, {
		json: {
			test: "testSeqFile",
			test2: {
				test2: "testSeqFile2"
			}
		},
		type: "seqFile",
		etag: "AAAA",
		id: "testSeqFile",
		db: db
	});
	strictEqual(uuidsSeqFile != null, true, "create EdiCacheEntity seqFile  " + JSON.stringify(uuidsSeqFile));

	var seqFile = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuidsSeqFile,
		db: db
	});
	strictEqual(seqFile != null, true, "get EdiCacheEntity  from a uuid=[" + JSON.stringify(uuidsSeqFile) + "] ok ");
	strictEqual(seqFile.etag(_), "AAAA", " get EdiCacheEntity check etag ok");
	strictEqual(seqFile.id(_), "testSeqFile", " get EdiCacheEntity check id ok");
	strictEqual(seqFile.type(_), "seqFile", " get EdiCacheEntity check type ok");
	strictEqual(JSON.stringify(seqFile.json(_)), '{\"test\":\"testSeqFile\",\"test2\":{\"test2\":\"testSeqFile2\"}}', " get EdiCacheEntity check json ok");

	// test with filter
	var seqFile = EdiEntity.getEdiCacheEntity(_, {
		filter: {
			id: "testSeqFile",
			type: "seqFile"
		},
		db: db
	});
	strictEqual(seqFile != null, true, "get EdiCacheEntity  with filter from a uuid=[" + JSON.stringify(uuidsSeqFile) + "] ok ");
	strictEqual(seqFile.etag(_), "AAAA", " get EdiCacheEntity   with filter check etag ok");
	strictEqual(seqFile.id(_), "testSeqFile", " get EdiCacheEntity   with filter check id ok");
	strictEqual(seqFile.type(_), "seqFile", " get EdiCacheEntity   with filter check type ok");
	strictEqual(JSON.stringify(seqFile.json(_)), '{\"test\":\"testSeqFile\",\"test2\":{\"test2\":\"testSeqFile2\"}}', " get EdiCacheEntity  with filter check json ok");


	var uuidsSeqFile = EdiEntity.createEdiCacheEntity(_, {
		json: {
			test: "testSeqFile",
			test2: {
				test2: "testSeqFile2"
			}
		},
		type: "seqFile",
		etag: "AAAA",
		id: "testSeqFile2",
		db: db
	});

	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuidsSeqFile,
		db: db
	});

	var seqFile = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuidsSeqFile,
		db: db
	});
	strictEqual(seqFile == null, true, "drop all  EdiCacheEntity  ok ");

	// test get list of entity
	var uuidsMul = [];
	uuidsMul.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: "test1",
		etag: "AAAA",
		id: "test1",
		db: db
	}));
	uuidsMul.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: "test2",
		etag: "AAAA",
		id: "test2",
		db: db
	}));
	strictEqual(uuidsMul && uuidsMul.length === 2, true, "create 2 entity ");
	var test = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuidsMul,
		db: db
	});
	strictEqual(test && test.length == 2, true, "get multiple entity ok");

	// get multi with one non exists uuid
	uuidsMul.push("uuid-dummy");
	try {
		var test = EdiEntity.getEdiCacheEntity(_, {
			uuid: uuidsMul,
			db: db
		});
		ok(false, "get multiple entity with bad uuid ok");

	} catch (e) {
		ok(true, "get multiple entity with bad uuid ok");
	}


	start();
});
// t
asyncTest("test retrieve cache from a process ", function(_) {
	_initPrototypeCache(_, db);

	var uuid = [];

	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {
			"messageMapping": {}
		},
		type: EdiType.MESSAGEMAPPING,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {
			"seqFile": {}
		},
		type: EdiType.SEQFILE,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {
			"protocol": {}
		},
		type: EdiType.PROTOCOL,
		id: "test",
		etag: "etagDummy",
		db: db
	}));

	strictEqual(uuid.length == 3, true, "create cache entity ok");
	var ediProcess = EdiProcess.createEdiProcess(_, {
		idProcess: "idProcessTest",
		messageMapping: uuid[0],
		sequentialFile: uuid[1],
		protocol: uuid[2],
		repName: "testClass",
		db: db
	});

	strictEqual(ediProcess != null, true, " ediProcess created ");

	strictEqual(JSON.stringify(ediProcess.sequentialFile(_)), "{\"seqFile\":{}}", " retrieve seqFile  ok  created ");
	strictEqual(JSON.stringify(ediProcess.messageMapping(_)), "{\"messageMapping\":{}}", " retrieve messageMapping ok  created ");
	strictEqual(JSON.stringify(ediProcess.protocol(_)), "{\"protocol\":{}}", " retrieve protocol ok  created ");


	//delete all entity
	EdiProcess.removeEdiProcess(_, {
		idProcess: "idProcessTest",
		db: db
	});
	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});

	start();
});
asyncTest("cache process id context identifier", function(_) {
	_initPrototypeCache(_, db);

	// store in mongodb all needed to perform the test
	var seqFileJson = JSON.parse(readFile("context/seqFileSIH.json", 'utf-8', _));
	// var messageMappingJson = readFile("context/messageMapping.json", 'utf-8', _);
	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));

	var uuids = [];
	uuids.push(EdiEntity.createEdiCacheEntity(_, {
		json: seqFileJson,
		type: EdiType.SEQFILE,
		id: "sf",
		etag: "etagDummy",
		db: db
	}));

	uuids.push(EdiEntity.createEdiCacheEntity(_, {
		json: protocolJson,
		type: EdiType.PROTOCOL,
		id: "protocol",
		etag: "etagDummy",
		db: db
	}));
	var cache = EdiProcess.createEdiProcess(_, {
		idProcess: "idProcessEdi1",
		messageMapping: "mm",
		sequentialFile: uuids[0],
		protocol: uuids[1],
		repName: "testClass",
		folder: "GX3APP",
		db: db
	});

	strictEqual(cache !== null, true, "create EdiProcess ok");

	strictEqual(cache.idProcess(_), "idProcessEdi1", "create EdiProcess  idProcess ok ");
	strictEqual(cache.idMessageMapping(_), "mm", "create EdiProcess  messageMapping ok ");
	strictEqual(cache.idSequentialFile(_) !== null, true, "create EdiProcess  sequentialFile ok , uuid seqFile " + cache.idSequentialFile(_));
	strictEqual(cache.idProtocol(_) !== null, true, "create EdiProcess  protocol ok uuid protocol " + cache.idProtocol(_));
	strictEqual(cache.folder(_), "GX3APP", "create EdiProcess  folder ok ");
	strictEqual(cache.endPoint(_) != null, true, "create EdiProcess :needs endPoint GX3APP in syracuse database ok ");

	cache = EdiProcess.getEdiProcess(_, {
		idProcess: "idProcessEdi1",
		db: db
	});
	strictEqual(cache != null, true, "get EdiProcess ok");

	strictEqual(cache.idProcess(_), "idProcessEdi1", "get EdiProcess  idProcess ok ");
	strictEqual(cache.idSequentialFile(_) !== null, true, "create EdiProcess  sequentialFile ok , uuid seqFile " + cache.idSequentialFile(_));
	strictEqual(cache.idProtocol(_) !== null, true, "create EdiProcess  protocol ok uuid protocol " + cache.idProtocol(_));

	cache = EdiProcess.removeEdiProcess(_, {
		idProcess: "idProcessEdi1",
		db: db
	});

	cache = EdiProcess.getEdiProcess(_, {
		idProcess: "idProcessEdi1",
		db: db
	});
	strictEqual(cache === null, true, "get EdiProcess ok");

	start();
});

asyncTest("read receipt file", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "read_receipt1.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	var seqFileJson = JSON.parse(readFile("context/seqFileSIH.json", 'utf-8', _));
	// var messageMappingJson = readFile("context/messageMapping.json", 'utf-8', _);
	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));

	var opt = {
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		}
	};
	var buffList = protocolDirectory.getReceiptFiles(_, protocolJson, seqFileJson, null, opt); // for unit test
	strictEqual(Object.keys(buffList).length === 5, true, " list file to read (nbreaded=[" + JSON.stringify(Object.keys(buffList)) + "] ok");
	strictEqual(typeof buffList[Object.keys(buffList)[0]], "string", "all buffer has be decoded in string ok");

	recOptions.fileName = "moveEnd.json";
	var sadfs = new SadFsqClient(_, endpointTest, "apisu", "apisu", false, recOptions);

	// firstaval, remove all archive directory
	// remove files in archive folder to unit test
	sadfs.rmdir(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/EDIARC/"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	// create a test file
	var write = sadfs.writeFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/RECEIPT/testMoveEnd.txt"
	}, "test", {
		flag: "w",
		encoding: "utf-8"
	});
	strictEqual(true, sadfs.exists(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/RECEIPT/testMoveEnd.txt"
	}), " file create ok ");

	recOptions.fileName = "moveArchive.json";

	protocolDirectory.mvReceiptArchiveFiles(_, protocolJson, {
		"testMoveEnd.txt": ""
	}, null, opt); // for unit test
	// check existance of test file
	recOptions.fileName = "moveEndExists.json";
	var sadfs = new SadFsqClient(_, endpointTest, "apisu", "apisu", false, recOptions);

	strictEqual(false, sadfs.exists(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/RECEIPT/testMoveEnd.txt"
	}), " file doesn't exists ok ");
	start();
});

asyncTest("write issue file", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "write_issue1.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	// var messageMappingJson = readFile("context/messageMapping.json", 'utf-8', _);
	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));
	var output = {
		"test.txt": {
			content: "string to write "
		}
	};
	var opt = {
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		encoding: "utf8",
		unittest: true

	};


	protocolDirectory.writeIssueFiles(_, protocolJson, null, null, output, opt); // for unit test
	recOptions.fileName = "write_check.json";
	var sadfs = new SadFsqClient(_, endpointTest, "apisu", "apisu", false, recOptions);

	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/test.txt"
	}, {
		flag: "r",
		encoding: "utf-8"
	});
	strictEqual(read != null, true, " write issue file ok  ");
	strictEqual(read, output["test.txt"].content, " check content of written file ok ");

	sadfs.unlink(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/test.txt"
	});
	try {
		recOptions.fileName = "write_checkunlink.json";

		var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);

		var read = sadfs.readFile(_, {
			path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/test.txt"
		}, {
			flag: "r",
			encoding: "utf-8"
		});
		ok(false, "unlink file ok " + read);

	} catch (e) {
		ok(true, "unlink file ok");
	}

	start();
});

asyncTest("decode file API", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "decodeFile1.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	var seqFileJson = JSON.parse(readFile("context/seqFileSIH.json", 'utf-8', _));
	// var messageMappingJson = readFile("context/messageMapping.json", 'utf-8', _);
	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));
	var uuid = [];
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: seqFileJson,
		type: EdiType.SEQFILE,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: EdiType.MESSAGEMAPPING,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: protocolJson,
		type: EdiType.PROTOCOL,
		id: "test",
		etag: "etagDummy",
		db: db
	}));

	var option = {
		messageMapping: uuid[1],
		sequentialFile: uuid[0],
		protocol: uuid[2],
		prototype: prototype_EDISIH1,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISIH1",
		folder: "GX3APP",
		db: db,
		unittest: true
			//moveEnd : true

	};
	var uuidList = EdiProcess.decodeEdiFiles(_, "idProcess", option);

	strictEqual(uuidList != null, true, "decoded file ok and return a uuid = " + JSON.stringify(uuidList));
	// check if the json generate exists
	uuidList.forEach_(_, function(_, item) {
		var entityGen = EdiEntity.getEdiCacheEntity(_, {
			uuid: item.uuid,
			db: db
		});
		strictEqual(entityGen != null, true, "json generate exists in syracuse mongodb database identify by uuid = " + item.uuid);

		strictEqual(JSON.stringify(entityGen.json(_)), '{"NUM":"FCC11014VEN00000014","BPR":"ESP0001","CPY":"110","FCY":"C110","BPAPAY":"A01","CUR":"EUR","PTE":"CHEQ100COMPTANT","AMTATI":75880,"AMTNOT":66000,"SIVTYP":"FAC","ACCDAT":"2014-02-24","ESIH1SID":[{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":20000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000}]}', "json generate from files ok");

	});
	var option = {
		messageMapping: uuid[1],
		sequentialFile: uuid[0],
		protocol: uuid[2],
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		folder: "GX3APP",
		db: db,
		unittest: true


	};
	var uuidList = EdiProcess.decodeEdiFiles(_, "idProcessSad", option);


	strictEqual(uuidList != null, true, "decoded file ok and return a uuid = " + JSON.stringify(uuidList));
	// check if the json generate exists
	uuidList.forEach_(_, function(_, item) {
		var entityGen = EdiEntity.getEdiCacheEntity(_, {
			uuid: item.uuid,
			db: db
		});
		strictEqual(entityGen != null, true, "json generate exists in syracuse mongodb database identify by uuid = " + item.uuid);
		strictEqual(JSON.stringify(entityGen.json(_)), '{"NUM":"FCC11014VEN00000014","BPR":"ESP0001","CPY":"110","FCY":"C110","BPAPAY":"A01","CUR":"EUR","PTE":"CHEQ100COMPTANT","AMTATI":75880,"AMTNOT":66000,"SIVTYP":"FAC","ACCDAT":"2014-02-24","ESIH1SID":[{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":20000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000}]}', "json generate from files ok");

	});

	// decode file wihtout cache
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		folder: "GX3APP",
		db: db,
		unittest: true


	};
	var uuidList = EdiProcess.decodeEdiFiles(_, "idProcessWithoutCache", option);

	strictEqual(uuidList != null, true, "decoded file without cache ok and return a uuid = " + JSON.stringify(uuidList));
	// check if the json generate exists
	uuidList.forEach_(_, function(_, item) {
		var entityGen = EdiEntity.getEdiCacheEntity(_, {
			uuid: item.uuid,
			db: db
		});
		strictEqual(entityGen != null, true, "json generate without cache exists in syracuse mongodb database identify by uuid = " + item.uuid);

		strictEqual(JSON.stringify(entityGen.json(_)), '{"NUM":"FCC11014VEN00000014","BPR":"ESP0001","CPY":"110","FCY":"C110","BPAPAY":"A01","CUR":"EUR","PTE":"CHEQ100COMPTANT","AMTATI":75880,"AMTNOT":66000,"SIVTYP":"FAC","ACCDAT":"2014-02-24","ESIH1SID":[{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":20000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000}]}', "json generate without cache from files ok");


	});


	// case entity that doesn't exists
	option.repName = "NOTEXISTCLASS";
	option.prototype = {};
	try {
		var uuid = EdiProcess.decodeEdiFiles(_, "idProcessNonExist", option);
		ok(false, "decoded file with non exists file ok ");
	} catch (e) {
		ok(true, "decoded file with non exists file ok ");
	}

	// case entity that doesn't exists
	option.repName = "EDISIH1";
	option.prototype = prototype_EDISIH1;
	option.sequentialFile = {};
	try {
		var uuid = EdiProcess.decodeEdiFiles(_, "idProcessBadSeqFile", option);
		ok(false, "decoded file without correct sequentielFile  ok ");
	} catch (e) {
		ok(true, "decoded file without correct sequentielFile  ok ");
	}

	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		db: db,
		unittest: true

	};

	var uuid = EdiProcess.decodeEdiFiles(_, "idProcessNoCustomFolder", option);
	strictEqual(uuidList != null, true, "decoded file without cache ok and return a uuid = " + JSON.stringify(uuidList));
	// check if the json generate exists
	uuidList.forEach_(_, function(_, item) {
		var entityGen = EdiEntity.getEdiCacheEntity(_, {
			uuid: item.uuid,
			db: db
		});
		strictEqual(entityGen != null, true, "json generate without cache exists in syracuse mongodb database identify by uuid = " + item.uuid);

		strictEqual(JSON.stringify(entityGen.json(_)), '{"NUM":"FCC11014VEN00000014","BPR":"ESP0001","CPY":"110","FCY":"C110","BPAPAY":"A01","CUR":"EUR","PTE":"CHEQ100COMPTANT","AMTATI":75880,"AMTNOT":66000,"SIVTYP":"FAC","ACCDAT":"2014-02-24","ESIH1SID":[{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":20000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000},{"NUM":"FCC11014VEN00000014","SIDLIN":1000,"ITMREF":"CDROM","ITMDES":"CD-ROM 16X","SAU":"Un","QTY":3,"GROPRI":1000000,"NETPRI":1000000,"AMTLIN":30000},{"NUM":"FCC11014VEN00000014","SIDLIN":2000,"ITMREF":"CDROM1","ITMDES":"CD-ROM1 16X","SAU":"Un","QTY":2,"GROPRI":1000000}]}', "json generate without cache from files ok");
	});


	start();
});

asyncTest("generate EDI file API", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "generateFile1.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	var seqFileJson = JSON.parse(readFile("context/seqFileSIH.json", 'utf-8', _));

	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));

	var jsonSIH = {
		"ESIH1SID": [{
			"NUM": "FCC11014VEN00000014",
			"SIDLIN": 1000,
			"ITMREF": "CDROM",
			"ITMDES": "CD-ROM 16X",
			"SAU": "Un",
			"QTY": 3,
			"GROPRI": 1000000,
			"NETPRI": 1000000,
			"AMTLIN": 30000
		}, {
			"NUM": "FCC11014VEN00000014",
			"SIDLIN": 2000,
			"ITMREF": "CDROM1",
			"ITMDES": "CD-ROM1 16X",
			"SAU": "Un",
			"QTY": 2,
			"GROPRI": 1000000,
			"NETPRI": 1000000,
			"AMTLIN": 20000
		}],
		"NUM": "FCC11014VEN00000014",
		"BPR": "ESP0001",
		"CPY": "110",
		"FCY": "C110",
		"BPAPAY": "A01",
		"CUR": "EUR",
		"PTE": "CHEQ100COMPTANT",
		"AMTATI": 75880,
		"AMTNOT": 66000,
		"SIVTYP": "FAC",
		"ACCDAT": "2014-02-24"
	};
	var fileBuff = {};
	fileBuff["CABFAC"] = readFile("ediFiles/CABFAC", 'utf-8', _);
	fileBuff["LINFAC"] = readFile("ediFiles/LINFAC", 'utf-8', _);
	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSIH,
		id: "sas",
		etag: "etagDummy",
		db: db
	});
	var uuid = [];
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: EdiType.MESSAGEMAPPING,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: seqFileJson,
		type: EdiType.SEQFILE,
		id: "test",
		etag: "etagDummy",
		db: db
	}));

	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: protocolJson,
		type: EdiType.PROTOCOL,
		id: "test",
		etag: "etagDummy",
		db: db
	}));

	// test edi file without valid option
	var option = {
		protocol: uuid[2],
		prototype: prototype_EDISIH1,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISIH1",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC",
			L: "LINFAC"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		db: db,
		unittest: true

	};
	try {
		var result = EdiProcess.generateEdiFiles(_, "idProcess", option);
	} catch (e) {
		ok(true, "not valid option uuiid, sequentialFile and messageMapping not present ");
	}
	var option = {
		messageMapping: uuid[0],
		sequentialFile: uuid[1],
		protocol: uuid[2],
		prototype: prototype_EDISIH1,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISIH1",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC",
			L: "LINFAC"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		db: db,
	};
	try {
		var result = EdiProcess.generateEdiFiles(_, "idProcess", option);
	} catch (e) {
		ok(true, "not valid option uuid not present ");
	}

	var option = {
		messageMapping: uuid[0],
		sequentialFile: uuid[1],
		protocol: uuid[2],
		flow: "test dummy",
		prototype: prototype_EDISIH1,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISIH1",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC1",
			L: "LINFAC1"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],
		db: db,
		unittest: true

	};
	var result = EdiProcess.generateEdiFiles(_, "idProcess", option);

	strictEqual(result.length, 1, "result length ok ");
	strictEqual(result[0].fileNames && result[0].fileNames.length, 2, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidjson, "result uuid ok ");
	strictEqual(result[0].purgeCache, true, "result purge Cache  ok ");

	// check if the file generate exists and is ok
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdi1.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC1"
	}, {
		flag: "r",
		encoding: "utf-8"
	});


	fileBuff["CABFAC1"] = readFile("ediFiles/CABFAC1", 'utf-8', _);
	fileBuff["LINFAC1"] = readFile("ediFiles/LINFAC1", 'utf-8', _);
	strictEqual(read, fileBuff["CABFAC1"], "file  CABFAC generate ok");

	read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/LINFAC1"
	}, {
		flag: "r",
		encoding: "utf-8"
	});


	strictEqual(read, fileBuff["LINFAC1"], "file LINFAC generate ok");

	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSIH,
		id: "sas",
		etag: "etagDummy",
		db: db
	});
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		folder: "GX3APP",
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],
		fileNames: {
			C: "CABFAC",
			L: "LINFAC"
		},
		keepCache: true,
		db: db,
		unittest: true

	};
	recOptions.fileName = "generateEdiJsonCache.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessJsonCache", option);
	strictEqual(result.length, 1, "result length ok ");

	strictEqual(result[0].fileNames.length, 2, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidjson, "result uuid ok ");
	strictEqual(!result[0].purgeCache, true, "result purge Cache false ok ");



	// cehck with context passed in paraemeter instead of using the cache
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC2",
			L: "LINFAC2"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],
		db: db,
		unittest: true

	};
	recOptions.fileName = "generateEdi2.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessWithoutCache", option);
	strictEqual(result.length, 1, "result length ok ");

	strictEqual(result[0].fileNames.length, 2, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidjson, "result uuid ok ");
	strictEqual(result[0].purgeCache, true, "result purge Cache  ok ");

	// check if the file generate exists and is ok
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdi2.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC2"] = readFile("ediFiles/CABFAC2", 'utf-8', _);
	fileBuff["LINFAC2"] = readFile("ediFiles/LINFAC2", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC2"
	}, {
		flag: "r",
		encoding: "utf-8"
	});
	strictEqual(read, fileBuff["CABFAC2"], "file  CABFAC without cache generate ok");
	read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/LINFAC2"
	}, {
		flag: "r",
		encoding: "utf-8"
	});
	strictEqual(read, fileBuff["LINFAC2"], "file LINFAC without cache generate ok");

	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSIH,
		id: "sas",
		etag: "etagDummy",
		db: db
	});
	var uuidjson2 = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSIH,
		id: "sas2",
		etag: "etagDummy",
		db: db
	});
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC3",
			L: "LINFAC3"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson, uuidjson2],
		db: db,
		unittest: true

	};
	// generate multiple instance of rep in 1 seqFile
	recOptions.fileName = "generateEdi3.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessWithoutCache2", option);
	strictEqual(result.length, 2, "result length ok ");
	strictEqual(result[0].fileNames.length, 2, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidjson, "result uuid ok ");

	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdiCache2.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC3"] = readFile("ediFiles/CABFAC3", 'utf-8', _);
	fileBuff["LINFAC3"] = readFile("ediFiles/LINFAC3", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC3"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff["CABFAC3"], "file  CABFAC without cache generate ok");
	read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/LINFAC3"
	}, {
		flag: "r",
		encoding: "utf-8"
	});
	strictEqual(read, fileBuff["LINFAC3"], "file LINFAC without cache generate ok");


	// generate with multiple endFlag in the same file and not only one


	var seqFileJson = JSON.parse(readFile("context/seqFileSIHMultipleEndFlag.json", 'utf-8', _));
	var SIHJson = JSON.parse(readFile("context/jsonSIHmultipleEndFlag.json", 'utf-8', _));

	var uuidJSONMultiple = EdiEntity.createEdiCacheEntity(_, {
		json: SIHJson,
		type: EdiType.JSONCACHE,
		id: "testMultiple",
		etag: "etagDummy",
		db: db
	});
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIHEndFlag,
		repName: "EDISIH",
		folder: "GX3APP",
		fileNames: {
			C: "CABFAC4",
			L: "LINFAC4",
			O: "OBSFAC4"

		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidJSONMultiple],
		db: db,
		unittest: true

	};
	recOptions.fileName = "generateEdi4.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessMultiple", option);
	strictEqual(result.length, 1, "result length ok ");
	strictEqual(result[0].fileNames.length, 3, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidJSONMultiple, "result uuid ok ");

	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdiCache3.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC4"] = readFile("ediFiles/CABFAC4", 'utf-8', _);
	fileBuff["LINFAC4"] = readFile("ediFiles/LINFAC4", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC4"
	}, {
		flag: "r",
		encoding: "utf-8"
	});


	strictEqual(read, fileBuff["CABFAC4"], "file  CABFAC with multiple end flag");
	recOptions.fileName = "checkGenerateEdiCache4.json";

	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/LINFAC4"
	}, {
		flag: "r",
		encoding: "utf-8"
	});
	strictEqual(read, fileBuff["LINFAC4"], "file  LINFAC with multiple end flag");


	try {
		var read = sadfs.readFile(_, {
			path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/OBSFAC4"
		}, {
			flag: "r",
			encoding: "utf-8"
		});
		ok(false, "file OBSFAC4 can't be read and is not dumped ");

	} catch (e) {
		ok(true, "file OBSFAC4 can't be read and is not dumped " + e.message);
	}


	var seqFileJson = JSON.parse(readFile("context/seqFileTruncate.json", 'utf-8', _));
	var SIHJson = JSON.parse(readFile("context/jsonTruncate.json", 'utf-8', _));
	uuidJSONMultiple = EdiEntity.createEdiCacheEntity(_, {
		json: SIHJson,
		type: EdiType.JSONCACHE,
		id: "testTruncate",
		etag: "etagDummy",
		db: db
	});
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIHEndFlag,
		repName: "EDISIH",
		folder: "GX3APP",
		fileNames: {
			H: "CABFAC5"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidJSONMultiple],
		db: db,
		unittest: true

	};
	recOptions.fileName = "generateEdi5.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessTruncate", option);
	strictEqual(result.length, 1, "result length ok ");
	strictEqual(result[0].fileNames.length, 1, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidJSONMultiple, "result uuid ok ");


	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdiCache4.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC5"] = readFile("ediFiles/CABFAC5", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC5"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff["CABFAC5"], "file  CABFAC with multiple end flag");

	var seqFileJson = JSON.parse(readFile("context/seqFileallIn1file.json", 'utf-8', _));
	uuidJSONMultiple = EdiEntity.createEdiCacheEntity(_, {
		json: SIHJson,
		type: EdiType.JSONCACHE,
		id: "testTruncate",
		etag: "etagDummy",
		db: db
	});
	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIHEndFlag,
		repName: "EDISIH",
		folder: "GX3APP",
		fileNames: {
			H: "CABFAC6"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidJSONMultiple],
		db: db,
		unittest: true

	};
	recOptions.fileName = "generateEdi6.json";

	result = EdiProcess.generateEdiFiles(_, "idProcessallin1file", option);
	strictEqual(result.length, 1, "result length ok ");
	strictEqual(result[0].fileNames.length, 1, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidJSONMultiple, "result uuid ok ");
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdiCache5.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC6"] = readFile("ediFiles/CABFAC6", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUE/CABFAC6"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff["CABFAC6"], "file  CABFAC with multiple flag, all in 1 file");

	var option = {
		messageMapping: {},
		sequentialFile: seqFileJson,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIHEndFlag,
		repName: "EDISIH",
		folder: "GX3APP",
		fileNames: {
			H: "CABFAC6"
		},
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidJSONMultiple],
		db: db,
		unittest: true,
		test: true

	};
	recOptions.fileName = "generateEdi7.json";
	strictEqual(result.length, 1, "result length ok ");
	strictEqual(result[0].fileNames.length, 1, "result fileNames ok ");
	strictEqual(result[0].uuid, uuidJSONMultiple, "result uuid ok ");

	result = EdiProcess.generateEdiFiles(_, "idProcessallin2file", option);

	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateEdiCache6.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	fileBuff["CABFAC6"] = readFile("ediFiles/CABFAC6", 'utf-8', _);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/ISSUETEST/CABFAC6"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff["CABFAC6"], "file  CABFAC with multiple flag, all in 1 file");

	start();
});

asyncTest("generate import file API", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "generateFile2.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	var messageMappingJson = JSON.parse(readFile("context/messageMappingSOH.json", 'utf-8', _));

	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));
	var jsonSOH = JSON.parse(readFile("context/jsonImport.json", 'utf-8', _));
	var fileBuff = readFile("context/importSOH.csv", 'utf-8', _);

	var uuid = [];
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: messageMappingJson,
		type: EdiType.MESSAGEMAPPING,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: EdiType.SEQFILE,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: protocolJson,
		id: "test",
		etag: "etagDummy",
		type: EdiType.PROTOCOL,
		db: db
	}));
	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSOH,
		id: "sas",
		etag: "etagDummy",
		type: "sas",
		db: db
	});

	var option = {
		messageMapping: uuid[0],
		sequentialFile: uuid[1],
		protocol: uuid[2],
		prototype: prototype_EDIS0H2,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISOH2",
		folder: "GX3APP",

		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],
		fileName: "test",
		db: db,
		unittest: true

	};
	var result = EdiProcess.generateImportFiles(_, "idProcess", option);
	// check if the file generate exists and is ok
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateImport.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/import/test"
	}, {
		flag: "r",
		encoding: "utf-8"
	});


	strictEqual(read, fileBuff, "file import generate ok");
	sadfs.unlink(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/import/test"
	});

	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSOH,
		id: "sas",
		etag: "etagDummy",
		type: "sas",
		db: db
	});
	// with context directly in parameter instead of use cache
	var option = {
		messageMapping: messageMappingJson,
		sequentialFile: {},
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDIS0H2,
		repName: "EDISOH2",
		folder: "GX3APP",

		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],
		fileName: "test2",
		db: db,
		unittest: true,
		test: true

	};
	recOptions.fileName = "generateImport3.json";

	var result = EdiProcess.generateImportFiles(_, "idProcessWithoutCache", option);

	// check if the file generate exists and is ok
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateImport3.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);

	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/importtest/test2"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff, "file import without cache generate ok");
	sadfs.unlink(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/importtest/test2"
	});


	start();
});

asyncTest("generate import file API with failure during pushed files", function(_) {
	_initPrototypeCache(_, db);

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "generateFileFailedWrite.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// store in mongodb all needed to perform the test
	var messageMappingJson = JSON.parse(readFile("context/messageMappingSOH.json", 'utf-8', _));
	var protocolJsonOk = JSON.parse(readFile("context/protocol.json", 'utf-8', _));

	var protocolJson = JSON.parse(readFile("context/protocolWrongPath.json", 'utf-8', _));
	var jsonSOH = JSON.parse(readFile("context/jsonImport.json", 'utf-8', _));
	var fileBuff = readFile("context/importSOH.csv", 'utf-8', _);

	var uuid = [];
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: messageMappingJson,
		type: EdiType.MESSAGEMAPPING,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	uuid.push(EdiEntity.createEdiCacheEntity(_, {
		json: {},
		type: EdiType.SEQFILE,
		id: "test",
		etag: "etagDummy",
		db: db
	}));
	var uuidProtocol = EdiEntity.createEdiCacheEntity(_, {
		json: protocolJson,
		id: "test",
		etag: "etagDummy",
		type: EdiType.PROTOCOL,
		db: db
	});
	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSOH,
		id: "sas",
		etag: "etagDummy",
		type: "sas",
		db: db
	});

	var option = {
		messageMapping: uuid[0],
		sequentialFile: uuid[1],
		protocol: uuidProtocol,
		prototype: prototype_EDIS0H2,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		repName: "EDISOH2",
		folder: "GX3APP",
		endpoint: endpointTest, // add for unit in order to not use th standard endpoint and to work offline
		uuid: [uuidjson],

		path: "/home1/adonix/GX3APP/POUET/TMP/TESTAP/import",
		fileName: "test",
		db: db,
		unittest: true

	};
	try {
		EdiProcess.generateImportFiles(_, "idProcessFailed", option);

		ok(false, "generate not raised exception ");

	} catch (e) {
		ok(true, "generate raise exception " + e.message);
	}
	// check if document are store in storage Area
	var doc = sa.getDocumentInstance(_, {
		sdataWhere: "description eq idProcessFailed"
	}, "EDI");
	strictEqual(doc && doc.length != 0, true, "document saved in storage area");
	var docBuf = sa.readAll(_, {
		jsonWhere: {
			$uuid: doc.$uuid
		}
	}).toString('utf-8');

	strictEqual(docBuf, fileBuff, "document saved content ok");


	EdiEntity.removeEdiCacheEntity(_, {
		uuid: uuidProtocol
	});
	var uuidProt = EdiEntity.createEdiCacheEntity(_, {
		json: protocolJsonOk,
		id: "test2",
		etag: "etagDummy",
		type: EdiType.PROTOCOL,
		db: db
	});
	option.path = "/home1/adonix/GX3APP/TMP/TESTAP/import";
	option.protocol = uuidProt;
	recOptions.fileName = "generateFileFailedWriteOK.json";
	var uuidjson = EdiEntity.createEdiCacheEntity(_, {
		json: jsonSOH,
		id: "sas",
		etag: "etagDummy",
		type: "sas",
		db: db
	});
	option.uuid = [uuidjson];
	var result = EdiProcess.generateImportFiles(_, "idProcessFailed", option);

	console.log("result " + JSON.stringify(result));
	strictEqual(result[0].uuid, uuidjson, "recall generate to write uuid ok");
	strictEqual(result[0].fileNames[0] != null, true, "recall generate to write file : " + result[0].fileNames[0] + " ");

	var doc = sa.getDocumentInstance(_, {
		sdataWhere: "description eq idProcessFailed"
	}, "EDI");
	strictEqual(doc === null, true, "document saved removed in storage area");

	// check if the file generate exists and is ok
	var endpoint = endpointTest;
	recOptions.fileName = "checkGenerateImportFailed.json";
	var sadfs = new SadFsqClient(_, endpoint, "apisu", "apisu", false, recOptions);
	var read = sadfs.readFile(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/import/test"
	}, {
		flag: "r",
		encoding: "utf-8"
	});

	strictEqual(read, fileBuff, "file import generate ok");
	sadfs.unlink(_, {
		path: "/home1/adonix/GX3APP/TMP/TESTAP/import/test"
	});

	start();
});


asyncTest("test update edi entity ", function(_) {
	// clean
	EdiEntity.dropAllEdiCacheEntity(_, {
		db: db
	});
	EdiProcess.removeAllEdiProcess(_, {
		db: db
	});

	// create a sample entity

	var uuid = EdiEntity.createEdiCacheEntity(_, {
		json: {
			test: "test"
		},
		type: "test",
		id: "testUpdate",
		etag: "etagDummy",
		db: db
	});
	var uuid2 = EdiEntity.createEdiCacheEntity(_, {
		json: {
			test: "test2"
		},
		type: "test",
		id: "testUpdate2",
		etag: "etagDummy",
		db: db
	});

	strictEqual(uuid != null, true, "create of entity testUpdate ok");
	//check if it's create  and if value is correctly store
	var inst = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});
	strictEqual(inst != null, true, "instance exists in mongo (stored ok)");
	strictEqual(inst.$uuid, uuid, "uuid  " + inst.$uuid);
	strictEqual(inst.type(_), "test", "type  " + inst.type(_));
	strictEqual(inst.id(_), "testUpdate", "id  " + inst.id(_));
	strictEqual(inst.etag(_), "etagDummy", "etag " + inst.etag(_));
	strictEqual(JSON.stringify(inst.json(_)), '{"test":"test"}', "json  " + JSON.stringify(inst.json(_)));

	// update the value
	EdiEntity.updateEdiCacheEntity(_, {
		elems: [{
			uuid: uuid,
			json: {
				test: "testUpdate"
			}
		}],
		db: db
	});

	// check the change
	var inst = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});
	strictEqual(inst != null, true, "instance exists in mongo (updated ok)");
	strictEqual(inst.$uuid, uuid, "uuid  " + inst.$uuid);
	strictEqual(inst.type(_), "test", "type  " + inst.type(_));
	strictEqual(inst.id(_), "testUpdate", "id  " + inst.id(_));
	strictEqual(inst.etag(_), "etagDummy", "etag " + inst.etag(_));
	strictEqual(JSON.stringify(inst.json(_)), '{"test":"testUpdate"}', "json  " + JSON.stringify(inst.json(_)));

	// update the value
	EdiEntity.updateEdiCacheEntity(_, {
		elems: [{
			uuid: uuid,
			json: ""
		}],
		db: db
	});

	// check the change
	var inst = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});
	strictEqual(inst != null, true, "instance exists in mongo (updated ok)");
	strictEqual(inst.$uuid, uuid, "uuid  " + inst.$uuid);
	strictEqual(inst.type(_), "test", "type  " + inst.type(_));
	strictEqual(inst.id(_), "testUpdate", "id  " + inst.id(_));
	strictEqual(inst.etag(_), "etagDummy", "etag " + inst.etag(_));
	strictEqual(JSON.stringify(inst.json(_)), '\"\"', "json  " + JSON.stringify(inst.json(_)));

	// test update 2 entities
	EdiEntity.updateEdiCacheEntity(_, {
		elems: [{
			uuid: uuid,
			json: {
				test: "testUpdate2"
			}
		}, {
			uuid: uuid2,
			json: {
				test: "test2Update"
			}
		}],
		db: db
	});
	var inst = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuid,
		db: db
	});
	strictEqual(inst != null, true, "update 2 entity : instance exists in mongo (updated ok)");
	strictEqual(inst.$uuid, uuid, "update 2 entity : uuid  " + inst.$uuid);
	strictEqual(inst.type(_), "test", "update 2 entity : type  " + inst.type(_));
	strictEqual(inst.id(_), "testUpdate", "update 2 entity : id  " + inst.id(_));
	strictEqual(inst.etag(_), "etagDummy", "update 2 entity : etag " + inst.etag(_));
	strictEqual(JSON.stringify(inst.json(_)), '{"test":"testUpdate2"}', "update 2 entity : json  " + JSON.stringify(inst.json(_)));

	var inst = EdiEntity.getEdiCacheEntity(_, {
		uuid: uuid2,
		db: db
	});
	strictEqual(inst != null, true, "update 2 entity : instance exists in mongo (updated ok)");
	strictEqual(inst.$uuid, uuid2, "update 2 entity : uuid  " + inst.$uuid);
	strictEqual(inst.type(_), "test", "update 2 entity : type  " + inst.type(_));
	strictEqual(inst.id(_), "testUpdate2", "update 2 entity : id  " + inst.id(_));
	strictEqual(inst.etag(_), "etagDummy", "update 2 entity : etag " + inst.etag(_));
	strictEqual(JSON.stringify(inst.json(_)), '{"test":"test2Update"}', "update 2 entity : json  " + JSON.stringify(inst.json(_)));
	// test with non exists entity
	try {
		EdiEntity.updateEdiCacheEntity(_, {
			elems: [{
				uuid: "testDummy",
				json: {
					test: "testUpdate"
				}
			}],
			db: db
		});
		ok(false, "update non exists entity exception not raised ");
	} catch (e) {
		ok(true, "update non exists entity raise exception " + e.message);
	}

	try {

		EdiEntity.updateEdiCacheEntity(_, {
			elems: [{
				uuid: uuid,
				json: {
					test: "testUpdate2"
				}
			}, {
				uuid: "uuid-dummy",
				json: {
					test: "test2UpdateDummy"
				}
			}],
			db: db
		});
		ok(false, "update multiple instance with on non exists entity raise exception ");

	} catch (e) {
		ok(true, "update multiple instance with on non exists entity raise exception " + e.message);
	}

	start();
});

asyncTest("test parsing xsd file", function(_) {
	/*var jsXsd = jsxml.parse(readFile("context/xsdSample.xsd", 'utf-8', _));
     var list = EdiEntity.executeParseXsd(jsXsd);
     strictEqual(Object.keys(list).length, 10, "number of element generated ok " + Object.keys(list).length);

     strictEqual(JSON.stringify(Object.keys(list)), '["shiporder.item.price","shiporder.item.quantity","shiporder.item.note","shiporder.item.title","shiporder.shipto.country","shiporder.shipto.city","shiporder.shipto.address","shiporder.shipto.name","shiporder.orderperson","shiporder.$.orderid"]', "check elements in the result");

     var jsXsd = jsxml.parse(readFile("context/xsdSample2.xsd", 'utf-8', _));

     var list = EdiEntity.executeParseXsd(jsXsd);
     strictEqual(Object.keys(list).length, 10, "number of element generated ok " + Object.keys(list).length);
     strictEqual(JSON.stringify(Object.keys(list)), '["shiporder.item.price","shiporder.item.quantity","shiporder.item.note","shiporder.item.title","shiporder.shipto.country","shiporder.shipto.city","shiporder.shipto.address","shiporder.shipto.name","shiporder.orderperson","shiporder.$.orderid"]', "check elements in the result");

     var jsXsd = jsxml.parse(readFile("context/xsdSample3.xsd", 'utf-8', _));

     var list = EdiEntity.executeParseXsd(jsXsd);
     strictEqual(Object.keys(list).length, 25, "number of element generated ok " + Object.keys(list).length);
     strictEqual(JSON.stringify(Object.keys(list)), '["Root.Orders.Order.ShipInfo.ShipCountry","Root.Orders.Order.ShipInfo.ShipPostalCode","Root.Orders.Order.ShipInfo.ShipRegion","Root.Orders.Order.ShipInfo.ShipCity","Root.Orders.Order.ShipInfo.ShipAddress","Root.Orders.Order.ShipInfo.ShipName","Root.Orders.Order.ShipInfo.Freight","Root.Orders.Order.ShipInfo.ShipVia","Root.Orders.Order.ShipInfo.$.ShippedDate","Root.Orders.Order.RequiredDate","Root.Orders.Order.OrderDate","Root.Orders.Order.EmployeeID","Root.Orders.Order.CustomerID","Root.Customers.Customer.FullAddress.Country","Root.Customers.Customer.FullAddress.PostalCode","Root.Customers.Customer.FullAddress.Region","Root.Customers.Customer.FullAddress.City","Root.Customers.Customer.FullAddress.Address","Root.Customers.Customer.FullAddress.$.CustomerID","Root.Customers.Customer.Fax","Root.Customers.Customer.Phone","Root.Customers.Customer.ContactTitle","Root.Customers.Customer.ContactName","Root.Customers.Customer.CompanyName","Root.Customers.Customer.$.CustomerID"]', "check elements in the result");

     var jsXsd1 = jsxml.parse(readFile("context/xsdSample4Import.xsd", 'utf-8', _));

     var jsXsd2 = jsxml.parse(readFile("context/xsdSample4.xsd", 'utf-8', _));
     var list = EdiEntity.executeParseXsd([jsXsd1, jsXsd2]);
     strictEqual(Object.keys(list).length, 96876, "number of element generated ok " + Object.keys(list).length);
     var result = readFile("context/xsdSample4result.json", 'utf-8', _);

     strictEqual(JSON.stringify(Object.keys(list)), result, "check elements in the result");
     */
	start();
});


asyncTest("test parsing xsd file with storage area", function(_) {
	// store content in storage area
	var jsXsd = readFile("context/xsdSample.xsd", 'utf-8', _);
	var doc = sa.open(_, null);
	sa.write(_, doc, {
		description: "xsdSample",
		content: {
			contentType: "application/xml",
			fileName: "xsdSample.xsd",
		}
	}, new Buffer(jsXsd, "utf8"));
	var d = sa.close(_, doc, true);


	var uuid = EdiProcess.parseXsd(_, {
		xsdUuid: [d.$uuid],
		id: "testxsdStorage"
	});
	d.deleteSelf(_);
	console.log("UUID " + require('util').format(uuid))
	strictEqual(uuid != null, true, "result contains an uuid");
	var resStored = EdiEntity.getXmlPath(_, {
		uuid: uuid,
		startIndex: 1,
		count: 20
	});

	strictEqual(JSON.stringify(resStored), '{"startIndex":1,"count":20,"elems":[{"id":1,"path":"shiporder.item[0..n].price.$value","type":"xs:decimal"},{"id":2,"path":"shiporder.item[0..n].quantity.$value","type":"xs:positiveInteger"},{"id":3,"path":"shiporder.item[0..n].note.$value","type":"xs:string"},{"id":4,"path":"shiporder.item[0..n].title.$value","type":"xs:string"},{"id":5,"path":"shiporder.shipto.country.$value","type":"xs:string"},{"id":6,"path":"shiporder.shipto.city.$value","type":"xs:string"},{"id":7,"path":"shiporder.shipto.address.$value","type":"xs:string"},{"id":8,"path":"shiporder.shipto.name.$value","type":"xs:string"},{"id":9,"path":"shiporder.orderperson.$value","type":"xs:string"},{"id":10,"path":"shiporder.$.orderid","type":"xs:string"}],"totalResult":10}', "result ok");

	// delete of document that store xml
	EdiEntity.removeXmlPath(_, {
		uuid: uuid
	});
	//strictEqual(JSON.stringify(result.json), '{"shiporder.item.price":{"path":"shiporder.item.price","type":"xs:decimal"},"shiporder.item.quantity":{"path":"shiporder.item.quantity","type":"xs:positiveInteger"},"shiporder.item.note":{"path":"shiporder.item.note","type":"xs:string"},"shiporder.item.title":{"path":"shiporder.item.title","type":"xs:string"},"shiporder.shipto.country":{"path":"shiporder.shipto.country","type":"xs:string"},"shiporder.shipto.city":{"path":"shiporder.shipto.city","type":"xs:string"},"shiporder.shipto.address":{"path":"shiporder.shipto.address","type":"xs:string"},"shiporder.shipto.name":{"path":"shiporder.shipto.name","type":"xs:string"},"shiporder.orderperson":{"path":"shiporder.orderperson","type":"xs:string"},"shiporder.$.orderid":{"path":"shiporder.$.orderid","type":"xs:string"}}', "result json ok");

	// test upate of the data
	var jsXsd = readFile("context/xsdSample2.xsd", 'utf-8', _);
	var doc = sa.open(_, null);
	sa.write(_, doc, {
		description: "xsdSample",
		content: {
			contentType: "application/pdf",
			fileName: "xsdSample.xsd",
		}
	}, new Buffer(jsXsd, "utf8"));
	var d = sa.close(_, doc, true);

	var uuid = EdiEntity.parseXsd(_, {
		xsdUuid: [d.$uuid],
		id: "testxsdStorage"
	});
	d.deleteSelf(_);

	strictEqual(uuid != null, true, "result contains an uuid");
	var resStored = EdiEntity.getXmlPath(_, {
		uuid: uuid,
		startIndex: 1,
		count: 20
	});

	console.log("resStored " + JSON.stringify(resStored));
	strictEqual(JSON.stringify(resStored), '{"startIndex":1,"count":20,"elems":[{"id":1,"path":"shiporder.item[0..n].price.$value","type":"xs:decimal","restriction":{"base":"xs:decimal"}},{"id":2,"path":"shiporder.item[0..n].quantity.$value","type":"xs:positiveInteger","restriction":{"base":"xs:positiveInteger"}},{"id":3,"path":"shiporder.item[0..n].note.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":4,"path":"shiporder.item[0..n].title.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":5,"path":"shiporder.shipto.country.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":6,"path":"shiporder.shipto.city.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":7,"path":"shiporder.shipto.address.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":8,"path":"shiporder.shipto.name.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":9,"path":"shiporder.orderperson.$value","type":"xs:string","restriction":{"base":"xs:string"}},{"id":10,"path":"shiporder.$.orderid","type":"xs:string","restriction":{"base":"xs:string","pattern":"[0-9]{6}"}}],"totalResult":10}', "result ok");

	// remove document xml path
	EdiEntity.removeXmlPath(_, {
		uuid: uuid
	});


	var jsXsd = readFile("context/facturae.xsd", 'utf-8', _);

	var doc = sa.open(_, null);
	sa.write(_, doc, {
		description: "facturae",
		content: {
			contentType: "application/xml",
			fileName: "facturae.xsd",
		}
	}, new Buffer(jsXsd, "utf8"));
	var d = sa.close(_, doc, true);


	var uuid = EdiEntity.parseXsd(_, {
		xsdUuid: [d.$uuid],
		id: "facturae"
	});


	var resStored = EdiEntity.getXmlPath(_, {
		uuid: uuid,
		startIndex: 1,
		count: 20
	});
	strictEqual(resStored.totalResult, 458, " size of xml path ok");
	strictEqual(resStored.count, 20, " size of xml path ok");



	/*/ test with import xsd
     var jsXsd = readFile("context/xsdSample4.xsd", 'utf-8', _);
     var doc = sa.open(_, null);
     sa.write(_, doc, {
     description: "xsdSample4",
     content: {
     contentType: "application/xml",
     fileName: "xsdSample.xsd",
     }
     }, new Buffer(jsXsd, "utf8"));
     var d = sa.close(_, doc, true);


     var jsXsd = readFile("context/xsdSample4import.xsd", 'utf-8', _);

     var doc2 = sa.open(_, null);
     sa.write(_, doc2, {
     description: "xsdSample4import",
     content: {
     contentType: "application/xml",
     fileName: "xsdSample.xsd",
     }
     }, new Buffer(jsXsd, "utf8"));
     var d2 = sa.close(_, doc2, true);


     var uuid = EdiEntity.parseXsd(_, {
     xsdUuid: [d.$uuid, d2.$uuid],
     id: "testxsdStorage2"
     });

     strictEqual(uuid != null, true, "result contains an uuid");
     var resStored = EdiEntity.getXmlPath(_, {
     uuid: uuid,
     startIndex: 0,
     count: 20
     });

     var res = readFile("context/xsd4SampleStorage.json", 'utf-8', _);

     strictEqual(resStored.elems.length, 20, "result number page ok");
     console.log(JSON.stringify(resStored));

     strictEqual(JSON.stringify(resStored), '{"startIndex":0,"count":20,"elems":[{"id":0,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].orderOfPrecedence","type":"xs:decimal"},{"id":1,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].primacyIndicator","type":"xs:boolean"},{"id":2,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].valueText","type":"xs:string"},{"id":3,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].value","type":"xs:decimal"},{"id":4,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].taxationLocale","type":"xs:string"},{"id":5,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].taxationCountry","type":"xs:string"},{"id":6,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].type","type":"xs:string"},{"id":7,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].reference2","type":"xs:string"},{"id":8,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].reference","type":"xs:string"},{"id":9,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].label","type":"xs:string"},{"id":10,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].deleted","type":"xs:boolean"},{"id":11,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].active","type":"xs:boolean"},{"id":12,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.taxCodes.taxCode[0..n].applicationID","type":"xs:string"},{"id":13,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].accountingType","type":"xs:string"},{"id":14,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCommittedCostBalanceDate","type":"xs:date"},{"id":15,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCommittedCostBalance","type":"xs:decimal"},{"id":16,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentRevenueBudgetDate","type":"xs:date"},{"id":17,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentRevenueBudget","type":"xs:decimal"},{"id":18,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCostBudgetDate","type":"xs:date"},{"id":19,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCostBudget","type":"xs:decimal"}],"totalResult":96813}', "result first page ok");

     var resStored = EdiEntity.getXmlPath(_, {
     uuid: uuid,
     startIndex: 20,
     count: 20
     });
     strictEqual(resStored.elems.length, 20, "result number page ok");
     strictEqual(JSON.stringify(resStored), '{"startIndex":20,"count":20,"elems":[{"id":20,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCostBudget","type":"xs:decimal"},{"id":21,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].lastRevenueTransactionDate","type":"xs:date"},{"id":22,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentRevenueBalance","type":"xs:decimal"},{"id":23,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].lastCostTransactionDate","type":"xs:date"},{"id":24,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].currentCostBalance","type":"xs:decimal"},{"id":25,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].originatorDocument","type":"xs:string"},{"id":26,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].duration","type":"xs:duration"},{"id":27,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].forecastEndDate","type":"xs:date"},{"id":28,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].originalEndDate","type":"xs:date"},{"id":29,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].endDate","type":"xs:date"},{"id":30,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].startDate","type":"xs:date"},{"id":31,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].completionStatus","type":"xs:string"},{"id":32,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].status","type":"xs:string"},{"id":33,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].description","type":"xs:string"},{"id":34,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].shortName","type":"xs:string"},{"id":35,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].name","type":"xs:string"},{"id":36,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].type","type":"xs:string"},{"id":37,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].reference2","type":"xs:string"},{"id":38,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].reference","type":"xs:string"},{"id":39,"path":"tradingAccount.cases.case[0..n].interactions.interaction[0..n].project.contacts.contact[0..n].purchaseCredits.purchaseCredit[0..n].projectLines.projectLine[0..n].isGroupingflag","type":"xs:boolean"}],"totalResult":96813}', "result first page ok");

     // remove document xml path
     EdiEntity.removeXmlPath(_, {
     uuid: uuid
     });

     d.deleteSelf(_);
     d2.deleteSelf(_);
     */
	start();
});

asyncTest("test parsing xml file with storage area", function(_) {

	_initPrototypeCache(_, db);
	var xmlFile = JSON.parse(readFile("context/xmlFile.json", 'utf-8', _));

	var recOptions = {
		recMode: ediSadUnitConfig.online ? "REC" : "PLAY",
		fileName: "decodeXmlFile.json",
		path: "node_modules/syracuse-edi/test/server/data/sadrec"
	};
	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file

	// var messageMappingJson = readFile("context/messageMapping.json", 'utf-8', _);
	var protocolJson = JSON.parse(readFile("context/protocol.json", 'utf-8', _));

	var uuidXmlFile = EdiEntity.createEdiCacheEntity(_, {
		json: xmlFile,
		type: "xmlType",
		id: "testParsing xml",
		etag: "etagDummy",
		db: db
	});

	var uuidProtocol = EdiEntity.createEdiCacheEntity(_, {
		json: xmlFile,
		type: "xmlType",
		id: "testParsing xml",
		etag: "etagDummy",
		db: db
	});


	var option = {
		messageMapping: {},
		sequentialFile: uuidXmlFile,
		protocol: protocolJson,
		sadfsq: {
			recOptions: recOptions,
			user: "apisu",
			password: "apisu"
		},
		prototype: prototype_EDISIH1,
		repName: "EDISIH1",
		db: db,
		unittest: true

	};

	var uuid = EdiProcess.decodeEdiFiles(_, "idProcessNoCustomFolder", option);

	start();
});


asyncTest("clean edi entity mongodb", 0, function(_) {

	EdiEntity.dropAllEdiCacheEntity(_, {
		db: db
	});
	EdiProcess.removeAllEdiProcess(_, {
		db: db
	});

	start();
});

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});