<h1 class="title">Software Configuration Management</h1>

<link rel="stylesheet" href="/css/home.css">

<script type="text/javascript">

function track(trackerId, cb)
{
	var lastPhaseCount = 0;
	var currentTracker;
	var currentListItem;

	function loop(cb)
	{
		function setListItemClasses(li, phase)
		{
			if (li.hasClass(phase.status))
				return;			
			li.removeClass("done").removeClass("running").removeClass("error").addClass(phase.status);
			if (phase.result && phase.status == "done" || phase.status == "error")
			{
				li.text(phase.label + " : " + phase.result);
			}
		}

		function updateListItems(phases, phaseId)
		{
			var li = $("#phase_" + phaseId);
			var phase = phases[phaseId];
			if (li.length == 0)
			{
				$("#ul_update_operations").append("<li id='phase_" + phaseId + "'>" + phase.label + "</li>");
				li = $("#phase_" + phaseId);
			}
			setListItemClasses(li, phase);
		}

		$.ajax({
			type: 'GET',
			contentType: 'application/json',
			url: "/tracker/" + trackerId + "/getStatus",
			success: function(data) {
				var tracker = data;
				if (tracker && tracker.phases)
				{				
					for (var phaseId = lastPhaseCount; phaseId < tracker.phases.length; phaseId++) {
						updateListItems(tracker.phases, phaseId);
					};

					lastPhaseCount = tracker.phases.length - 1;

					if (tracker.status === "done")
					{
						cb();
						return;
					}
					else if (tracker.status === "error")
					{
						cb(tracker.error);
						return;
					}
					// Loop
					setTimeout(function() {loop(cb);}, 1000);
				}
				currentTracker = tracker;
			},
			error: function(err)
			{
				cb(err);
			},
		});
	}

	loop(cb);

}

function update()
{	

	$("#div_update")
		.removeClass("done")
		.removeClass("error")
		.addClass("running")
		.show();

	$("#ul_update_operations").empty();

	$("#btn_update").hide();
	$("#div_update_title").text("Update in progress ... please wait ...");

	var configId = $("#select_configs option:selected").val();
	var data = {configId:configId};

	// Send ajax request to update the selected configuration
	$.ajax({
		type: 'POST',
		data: JSON.stringify(data),
		contentType: 'application/json',
		url: "/actions/update",
		success: function(data) {
			track(data.trackerId, function(error) {
				$("#btn_update").show();
				if (error)
				{
					$("#div_update")
						.removeClass("running")
						.addClass("error");
					$("#div_update_title").text("Update failed");
				}
				else
				{
					$("#div_update")
						.removeClass("running")
						.addClass("done");
					$("#div_update_title").text("Update OK");
				}
			});
		},
		error: function(err)
		{
			// TODO
		},
	});

}

</script>

<div id="div_configs">
Choose a configuration
<select id="select_configs">
  {{#each scmConfigs}}
    <option value="{{id}}">{{label}} - {{gitFolder}} [{{gitBranch}}]</option>
  {{/each}}
</select>
</div>

<div id="div_actions" class="div_part">
<div class="div_part_title">Actions</div>
<div class="action">
Update the configuration : <button id="btn_update" onclick="update();return false;">Update</button>
</div>
</div>

<div id="div_update" class="div_part">
<div id="div_update_title" class="div_part_title"></div>
<ul id="ul_update_operations">
</ul>
</div>


</div>

