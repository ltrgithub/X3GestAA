"use strict";
var gitWrapper = require('etna-etl/lib/gitWrapper'),
	supervisor = require("etna-supervisor/lib/supervisor"),
	path = require("path");

function getGitWrapper(_, scmConfig) {
	var options = {
		folder: scmConfig.gitFolder(_),
		trace: console.log,
	};
	return new gitWrapper.git(options);
}

module.exports = {
	$titleTemplate: "SCM configuration {name}",
	$valueTemplate: "{name}",
	$summaryTemplate: "SCM configuration {name}",
	$descriptionTemplate: "SCM configuration",
	$className: "scmConfig",
	$canCreate: true,
	$isPersistent: false,

	$helpPage: "Workbench-SCM-service",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},

	},
	$relations: {
		endpoint: {
			$title: "EndPoint",
			$type: "endPoint",
		},
	},

	$services: {
		getSyncInfos: {
			$method: "POST",
			$isMethod: false,
			$title: "Get synchronization infos",
			$execute: function(_, context, instance) {
				console.log(">>> getLastSyncdGitSha1");
				var data = JSON.parse(context.request.readAll(_));
				var endPointName = data.endPoint;

				console.log(">>> endPoint = " + endPointName);

				var db = context.db;
				var endPoints = db.fetchInstances(_, db.getEntity(_, "endPoint"), {}).filter_(_, function(_, ep) {
					return ep.dataset(_) === endPointName;
				});

				if (endPoints.length != 1)
					throw new Error("Invalid endPoint name " + endPointName);

				var endPoint = endPoints[0];
				var settingsTableName = "_SETTINGS";
				var etnaConfig = endPoint.getEtnaConfig(_);
				var superv = supervisor.create(_, etnaConfig);

				try {
					// Make sure the settings table exists
					superv.sqlDriver.getTableDef(_, etnaConfig.folderName, settingsTableName);
				} catch (err) {
					var tableDef = {
						schemaName: etnaConfig.folderName,
						tableName: settingsTableName,
						columns: [{
							name: "ID",
							isNullable: false,
							type: "nvarchar",
							maxLength: 100
						}, {
							name: "VALUE",
							isNullable: true,
							type: "clob",
						}],
						indexes: [],
					};
					superv.sqlDriver.createTableFromTableDefinition(_, tableDef);
					console.log(">>> Settings table '" + tableDef.tableName + "' was created.");
				}

				var sha1;
				try {
					superv.sqlDriver.withConnection(_, function(_, cnx) {
						var row = superv.sqlDriver.reader(_, cnx, "select VALUE from " + settingsTableName + " where ID = " + superv.sqlDriver.param(0), ["PATCH.SYNC.LAST.GIT.HEAD"]).toArray(_)[0];
						if (row)
							sha1 = JSON.parse(row.VALUE).sha1;
						else
							sha1 = null;;
					});
				} catch (err) {
					console.log("ERROR : " + err.message);
					throw new Error("Could not retrieve last sync'd git sha1, reason = " + err.message);
				}

				return {
					solutionFolder: etnaConfig.solutionPath,
					lastSyncdSha1: sha1,
					syracuseFolder: __dirname.split(path.sep).slice(0, -4).join(path.sep), // Return the path to the root of syracuse
				};
			}
		},
		importPatch: {
			$method: "POST",
			$isMethod: false,
			$title: "import patch",
			$execute: function(_, context, instance) {
				console.log(">>>> IN");
				var data = JSON.parse(context.request.readAll(_));
				var patchFileName = data.patchFile;
				console.log("Patch filename to import = " + patchFileName);
				console.log("<<<< OUT");
			},
		},
		setLastSyncdGitHead: {
			$method: "POST",
			$isMethod: false,
			$title: "Set last sync'd git head",
			$execute: function(_, context, instance) {
				console.log(">>> getLastSyncdGitSha1");
				var data = JSON.parse(context.request.readAll(_));
				var sha1 = data.sha1;

				console.log(">>> endPoint = " + data.endPoint);

				var db = context.db;
				var endPoints = db.fetchInstances(_, db.getEntity(_, "endPoint"), {}).filter_(_, function(_, ep) {
					return ep.dataset(_) === data.endPoint;
				});

				if (endPoints.length != 1)
					throw new Error("Invalid endPoint name " + data.endPoint);

				var endPoint = endPoints[0];
				var settingsTableName = "_SETTINGS";
				var etnaConfig = endPoint.getEtnaConfig(_);
				var superv = supervisor.create(_, etnaConfig);

				try {
					superv.sqlDriver.withConnection(_, function(_, cnx) {
						superv.sqlDriver.execute(_, cnx, "delete from " + settingsTableName + " where ID = " + superv.sqlDriver.param(0), ["PATCH.SYNC.LAST.GIT.HEAD"]);
						var valueToWrite = JSON.stringify({
							sha1: sha1,
							date: new Date().toISOString()
						});
						superv.sqlDriver.execute(_, cnx, "insert into " + settingsTableName + " (ID, VALUE) values (" + superv.sqlDriver.param(0) + "," + superv.sqlDriver.param(1) + ")", ["PATCH.SYNC.LAST.GIT.HEAD", valueToWrite]);
					});
				} catch (err) {
					console.log("ERROR : " + err.message);
				}
			},
		},
	},
	$searchIndex: {
		$fields: ["name"]
	},
	$defaultOrder: [
		["name", true]
	]
};