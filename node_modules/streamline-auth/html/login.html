<!DOCTYPE html>
<html>
<meta http-equiv="X-UA-Compatible" content="IE=9">

<head>
	<meta charset="UTF-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=9">
	<title>Sage ERP X3</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="/streamline-auth/html/login.css" />
	<style type="text/css">
		.z-field {
			font-size: 0.3em;
			line-height: 0.8em;
			padding-bottom: 1em;
		}
		.z-action {
			font-size: 0.3em;
			line-height: 0.8em;
			padding-bottom: 1em;
		}
		.z-action a {
			text-decoration: underline;
		}
		.z-error {
			font-size: 0.3em;
			line-height: 0.8em;
			padding-bottom: 1em;
			color: red;
		}
	</style>
	<script type="text/javascript">
		function isTablet() {
			var agt = navigator.userAgent;
			return (document.documentElement.ontouchstart != null) || (agt.match(/(iphone|ipod|ipad)/) || agt.match(/(android)/i) || agt.match(/(iemobile)/) || agt.match(/iphone/i) || agt.match(/ipad/i) || agt.match(/ipod/i) || agt.match(/blackberry/i) || agt.match(/bada/i));
		}

		function init() {
			var pics = [
				'/streamline-auth/html/images/login/1.jpg',
				'/streamline-auth/html/images/login/2.jpg',
				'/streamline-auth/html/images/login/3.jpg',
				'/streamline-auth/html/images/login/4.jpg',
				'/streamline-auth/html/images/login/5.jpg',
				'/streamline-auth/html/images/login/6.jpg',
				'/streamline-auth/html/images/login/7.jpg',
				'/streamline-auth/html/images/login/8.jpg'
			];

			document.body.style.backgroundImage = 'url(' + pics[Math.floor(Math.random() * pics.length)] + ')';
			if (isTablet()) {
				var e = document.getElementById("mainlink");
				if (e) {
					var l = e.getAttribute("href");
					if (l) {
						e.setAttribute("href", l.replace("/main.html", "/main-tablet.html"));
					}
					e.innerHTML = "To start your experience on the tablet version, tap here";
				}
			}

			var oauth2s = {{js$oauth2s}};
			if (oauth2s.length > 0) {
				var div = document.getElementById("oauth2-0");
				var parent = div.parentNode;
				oauth2s.forEach(function(oauth2, i) {
					if (i > 0) {
						div = div.clone(true);
						div.id = "oauth2-" + i;
						parent.appendChild(div);
					}
					div.firstElementChild.href = oauth2.href;
					div.firstElementChild.textContent = oauth2.title;
				});
			}

		}
		window.addEventListener ? window.addEventListener('load', init, false) : window.attachEvent('onload', init);

		function authToken(type, username, password) {
			// !!! btoa not supported on IE??
			switch (type) {
				case 'basic':
					return 'Basic ' + btoa(username + ":" + password);
				case 'sageerpx3':
					return 'sageerpx3 ' + btoa(username + ":" + password);
				default:
					return null;
			}
		}

		function authenticate(type) {
			var username = document.getElementById('username').value;
			var password = document.getElementById('password').value;

			var auth = authToken(type, username, password);
			if (!auth) return alert("unsupported authentication method: " + auth);

			var request = new XMLHttpRequest();
			request.open("POST", "/auth/login/submit", true);
			request.setRequestHeader("authorization", auth);
			request.setRequestHeader("accept", "application/json");
			request.onreadystatechange = function(aEvt) {
				if (request.readyState == 4) {
					try {
						json = JSON.parse(request.responseText);
						window.location.href = json.$diagnoses[0].$links.redirect.$url;
					} catch (ex) {
						document.getElementById('error-msg').textContent = ex.message || request.statusText;
						document.getElementById('password').value = "";
						document.getElementById('username').focus();
					}
				}
			};
			request.send();
		}

		function redirect(url) {
			window.location = url;
		}
	</script>
</head>

<body>
	<div class="container">
		<div class="s-text-containt">
			<div class="s-text" style="float:left;padding-bottom:0.5em;">
				<div class="s-product" style="padding-bottom: 0.3em;">Sage ERP X3</div>
				<div class="z-error" style="float:left; width:100%;">
					<div id="error-msg" style="float:left;">{{errorMessage}}</div>
				</div>
				<div style="visibility:{{passwordVisibility}};float:left;width:100%;">
					<div class="z-field" style="float:left;width:100%;">
						<div style="float:left;width:30%;">{{loginLabel}}</div>
						<input id="username" type="text" style="float:left;width:200px;" autocomplete="off">
					</div>
					<div class="z-field" style="float:left; width:100%;">
						<div style="float:left;;width:30%;">{{passwordLabel}}</div>
						<input id="password" type="password" style="float:left;width:200px;" autocomplete="off">
					</div>
					<div class="z-action" style="float:left; width:100%;padding-bottom:0.5em;">
						<a style="visibility:{{basicVisibility}};" href="javascript:authenticate('basic')">{{dbGo}}</a>
						<a style="visibility:{{digestVisibility}};" href="javascript:authenticate('digest')">{{dbGo}}</a>
						<a style="visibility:{{ldapVisibility}};" href="javascript:authenticate('ldap')">{{ldapGo}}</a>
					</div>
				</div>
			</div>
			<div class="s-text" style="visibility:{{oauth2Visibility}};float:left;width:89%;padding-top:0;">
				<div class="s-product" style="font-size:0.5em;">{{oauth2Title}}</div>
				<div id="oauth2-0" class="z-action" style="float:left;width:100%;">
					<a href=""></a>
				</div>
			</div>
			<div class="s-text" style="visibility:{{sage-idVisibility}};float:left;width:89%;padding-top:0;">
				<div class="s-product" style="font-size:0.5em;">{{sageIdTitle}}</div>
				<div class="z-action" style="float:left;width:100%;">
					<a href="javascript:redirect('/auth/sage-id/signOnStart')">{{sageIdSignOn}}</a>
				</div>
				<div class="z-action" style="float:left;width:100%;">
					<a href="javascript:redirect('/auth/sage-id/registerStart')">{{sageIdRegister}}</a>
				</div>
			</div>
		</div>
	</div>
</body>

</html>
