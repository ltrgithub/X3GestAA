"use strict";

var helpers = require('syracuse-core/lib/helpers');
var sys = require("util");
var checkUser = require('streamline-auth/lib/checkUser');

var tracer; // = console.log;

function _error(request, response, status, message) {
	response.writeHead(status, {
		"Content-Type": "text/plain",
	});
	response.end(message);
	return false;
}

exports.authenticate = function(_, request, response, session) {
	// REVIEW: why do we test request.connection.authorized in dispatcher and 
	// request.client.authorized here??
	if (!request.client.authorized) return _error(request, response, 401, "Authentication error 1");
	var login = ((request.connection.getPeerCertificate() || {}).subject || {}).CN;
	if (!login) return _error(request, response, 401, "Authentication error 2");
	var user = checkUser.fromCertificate(_, request.session, login);

	tracer && tracer("User authenticated via certficate: " + login);
	session.authData = {
		user: login,
	};
	return true;
};