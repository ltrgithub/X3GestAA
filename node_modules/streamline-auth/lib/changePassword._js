"use strict";

var locale = require("syracuse-core/lib/locale");
var fs = require('streamline-fs');
var config = require('syracuse-main/lib/nodeconfig').config;
var authHelper = require('streamline-auth/lib/helpers');
var querystring = require('querystring');

exports.changePasswordError = function(_, request, response, user) {
	request.session.changePasswordUser = user;
	var err = new Error(locale.format(module, "explanation"));
	err.$httpStatus = 307;
	err.$httpLocation = "/auth/changePassword/page";
	return err;
};

var genPage = function(_, request, response) {
	var user = request.session.changePasswordUser;
	var params = {
		changePasswdHeader: locale.format(module, "changePasswdHeader", user.login(_)),
		newPwd: locale.format(module, "newPwd"),
		password: locale.format(module, "pwdPlaceholder"),
		explanation: locale.format(module, "explanation"),
		chgPasswd: locale.format(module, "chgPasswd"),
		newPwdAgain: locale.format(module, "newPwdAgain"),
		different: locale.format(module, "different"),
		empty: locale.format(module, "notEmpty"),
		invalid: locale.format(module, "invalidChar", "XXX"),
		// when you change "XXX", do this also in newPassword.html
		login: user.login(_),
		realm: config.session.realm,
		action: "/auth/changePassword/submit",
	};
	authHelper.genPage(_, response, __dirname + "/../html/changePassword.html", params);
	return false;
};

var submit = function(_, request, response) {
	var content = request.readAll(_);
	if (!content) throw authHelper.error(400, "internal error: no content");
	var user = request.session.changePasswordUser;
	if (!user) throw authHelper.error(500, "internal error: no user");

	var stringContent = content.toString("utf8");
	var query = querystring.parse(stringContent);
	if (user.login(_).toLowerCase() !== query.login.toLowerCase()) throw authHelper.error(400, "internal error: login mismatch");
	user.password(_, query.passwordHash);
	user.changePassword(_, false);
	user.save(_);
	authHelper.redirect(_, response, request.session.authTargetUrl || '/');
	return false;
};

exports.dispatch = authHelper.dispatcher(3, {
	page: genPage,
	submit: submit,
});