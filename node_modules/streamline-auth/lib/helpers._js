"use strict";

var config = require("syracuse-main/lib/nodeconfig").config;
var locale = require('syracuse-core/lib/locale');

var authMethods = (config.session && config.session.auth) || "basic";
if (!Array.isArray(authMethods)) authMethods = [authMethods];

var dbMethod;
if (authMethods.indexOf('basic') >= 0) dbMethod = 'basic';
if (authMethods.indexOf('digest') >= 0) {
	if (dbMethod) throw new Error("configuration error: session.auth cannot contain both basic and digest");
	dbMethod = 'digest';
}

exports.isAllowed = function(method) {
	return authMethods.indexOf(method) >= 0;
};

exports.getDbMethod = function() {
	if (!dbMethod) throw new Error("configuration error: no default for database authentication");
	return dbMethod;
};

exports.getAuthModule = function(name) {
	if (authMethods.indexOf(name) < 0) return null;
	return require('streamline-auth/lib/' + name);
};

// returns the enum of allowed auth values for global setting (glob === true) or user (glob === false)
exports.authEnum = function(glob) {
	var result = [];
	if (glob) {
		if (authMethods.indexOf('basic') >= 0) result.push({
			$value: "basic",
			$title: "Basic"
		});
		if (authMethods.indexOf('digest') >= 0) result.push({
			$value: "digest",
			$title: "Digest"

		});
	} else {
		result.push({
			$value: "",
			$title: "Standard"
		});
		// basic and digest are collapsed into a single 'db' method
		if (authMethods.indexOf('basic') >= 0 || authMethods.indexOf('digest') >= 0) result.push({
			$value: "db",
			$title: "DB"
		});
	};
	[{
		$value: "ldap",
		$title: "LDAP"
	}, {
		$value: "oauth2",
		$title: "OAuth2"
	}, {
		$value: "sage-id",
		$title: "Sage ID"
	}].forEach(function(elt) {
		if (authMethods.indexOf(elt.$value) >= 0) result.push(elt);
	});
	return result;
};

// standard setting computed from configuration file and instance of settings singleton.
// result has elements: 
//   - method: "basic", "digest", "ldap", "oauth2", "sage-id"
//   - source: "db" for database authentication, "ldap" for LDAP authentication, empty for OAuth2 authentication
//   - ldap:   data for standard LDAP server (only if source is "ldap")
//   - oauth2: data for standard OAuth2 server (only if method is "oauth2")	
// !!! caching possible, because function will be invoked many times?
exports.getStandardSetting = function(_) {
	var db = require('syracuse-collaboration/lib/helpers').AdminHelper.getCollaborationOrm(_);
	var setting = db.fetchInstance(_, db.model.getEntity(_, "setting"), {
		sdataWhere: ""
	});
	var method = setting ? setting.authentication(_) : authMethods[0];
	// fail the hard way if default auth is not enabled by config file.
	if (authMethods.indexOf(method) < 0) throw new Error("configuration error: default authentication " + method + " not enabled. Fix your nodelocal.js config file!");

	var result = {
		method: method,
		source: method,
	};
	switch (method) {
		case "basic":
		case "digest":
			result.source = "db";
			break;
		case "ldap":
			var ldap = setting ? setting.ldap(_) : config.session.ldap;
			if (!ldap) throw new Error("configuration error: ldap server missing");
			result.ldap = setting ? ldap._data : ldap;
			break;
		case "oauth2":
			var oauth2 = setting ? setting.oauth2(_) : config.session.oauth2;
			if (!oauth2) throw new Error("configuration error: oauth2 server missing");
			result.oauth2 = setting ? oauth2._data : oauth2;
			break;
	}
	return result;
};

exports.error = function(status, message, headers) {
	var err = new Error(message);
	err.$httpStatus = status;
	err.$httpHeaders = headers;
	return err;
};

exports.unauthorized = function(challenge) {
	return exports.error(401, locale.format(module, "unauth"), challenge && {
		'www-authenticate': challenge,
	});
};

exports.accessDenied = function(status, login) {
	return exports.error(status === "noLicense" ? 402 : 403, locale.format(module, status));
};