"use strict";

//var httpRequest = require('request');
var httpClient = require('syracuse-httpclient/lib/httpClient');
var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;

var linkedinId = "78ga4pt9dcu0zk";
var linkedinSecret = "RfJFMlDNQQ8ArkMs";
var finalTarget;

var _accessToken;
var _authInit = "http://localhost:8124/linkedin/auth";

exports.syncMap = {
	"rich.burns@sage.com": "http://www.linkedin.com/pub/richard-burns/29/a4b/303",
	"dominique.bopp@sage.com": "http://fr.linkedin.com/in/dbopp",
	"mathias.walz@sage.de": "http://de.linkedin.com/pub/mathias-walz/97/206/354",
	"norbert.butzke@sage.com": "http://de.linkedin.com/pub/norbert-butzke/85/b87/138",
	"sophie.rebeyrotte@sage.com": "http://fr.linkedin.com/in/sophierebeyrotte/de"
};

function linkedinDispatcher(_, request, response) {
	var segs = request.url.split("?")[0].split("/");
	var last = segs[segs.length - 1];
	var util = require('util');
	var _redirect = function(location) {
		var headers = {
			"content-type": "text/html; charset=utf8",
			"location": location,
		};
		response.writeHead(307, headers);
		response.end('<html><head><title>Redirecting...</title></head>' + //
			'<body><a href="' + location + '">click here to continue</a></body></html>', "utf8");
	};

	switch (last) {
		case "init":
			if (!exports.isAuthenticated()) {
				_redirect(exports.getAuthUrl());
			} else {
				console.log(exports.getUserByUrl(_, "http://fr.linkedin.com/in/dbopp"));
				response.end('<html><head><title>Got a token!</title></head>' +
					'<body>' + _accessToken + '</body></html>', "utf8");
			}
			break;

		case "auth":

			finalTarget = request.headers.referer;
			console.log("Success will go to:" + finalTarget);
			// get code
			_redirect(util.format("https://www.linkedin.com/uas/oauth2/authorization?response_type=code" +
				"&client_id=%s" +
				"&scope=%s" +
				"&state=%s" +
				"&redirect_uri=%s",
				linkedinId, ['r_basicprofile', 'r_fullprofile', 'r_emailaddress', 'r_network', 'r_contactinfo', 'rw_nus', 'rw_groups', 'w_messages'].join(' '),
				Math.random(),
				"http://localhost:8124/linkedin/code"
			));
			break;

		case "code":
			var a = request.url.indexOf("code=");
			var b = request.url.indexOf("&");
			var code = request.url.substr(a + 5, b - a - 5);

			var opt = {
				url: util.format("https://www.linkedin.com/uas/oauth2/accessToken?grant_type=authorization_code" +
				"&code=%s" +
				"&redirect_uri=%s" +
				"&client_id=%s" +
				"&client_secret=%s",
				code,
				"http://localhost:8124/linkedin/code",
				linkedinId,
				linkedinSecret),

				method: "POST",
				headers: {
					"accept-charset": "utf-8",
					'content-type': 'text/json',
				}
			};

			var req = httpClient.httpRequest(_, opt);
			var resp = req.end().response(_);

			resp.setEncoding("utf8");	
			var content = resp.readAll(_);

			if (resp.statusCode != 200) {
				console.log("bad response code: " + resp.statusCode);
			} else {
				console.log("good response code: " + resp.statusCode);
				
				_accessToken = JSON.parse(content).access_token;

				console.log("Got access token:" + _accessToken);

				_redirect(finalTarget || _authInit);
			}

			

			// httpClient.httpRequest(_, util.format("https://www.linkedin.com/uas/oauth2/accessToken?grant_type=authorization_code" +
			// 		"&code=%s" +
			// 		"&redirect_uri=%s" +
			// 		"&client_id=%s" +
			// 		"&client_secret=%s",
			// 		code,
			// 		"http://localhost:8124/linkedin/code",
			// 		linkedinId,
			// 		linkedinSecret),
			// 	function(err, res, body) {
			// 		console.log (JSON.stringify(err));
			// 		console.log (JSON.stringify(res));
			// 		console.log (JSON.stringify(body));
			// 		var data = JSON.parse(body);
			// 		_accessToken = data.access_token;

			// 		console.log("Got access token:" + _accessToken);

			// 		_redirect(finalTarget || _authInit);
			// 	});
			break;
	}
};


exports.isAuthenticated = function() {
	return _accessToken != null;
};

exports.getAuthUrl = function() {
	return _authInit;
};

/*
var res = exports.getUrl(_, 
		"https://api.linkedin.com/v1/people/vyNsFaK3jd" +
		":(id,first-name,last-name,headline,picture-url,industry,summary,specialties," +
		"positions:(id,title,summary,start-date,end-date,is-current," +
		"company:(id,name,type,size,industry,ticker))," +
		"educations:(id,school-name,field-of-study,start-date,end-date,degree,activities,notes)," +
		"associations,interests,num-recommenders,date-of-birth," +
		"publications:(id,title,publisher:(name),authors:(id,name),date,url,summary)," +
		"patents:(id,title,summary,number,status:(id,name),office:(name),inventors:(id,name),date,url)," +
		"languages:(id,language:(name),proficiency:(level,name))," +
		"skills:(id,skill:(name))," +
		"certifications:(id,name,authority:(name),number,start-date,end-date)," +
		"courses:(id,name,number)," +
		"recommendations-received:(id,recommendation-type,recommendation-text,recommender)," +
		"honors-awards,three-current-positions,three-past-positions,volunteer)?format=json");
		console.log(require("util").inspect(res, null, { depth: 5}));
console.log(res.body);
*/
exports.getUrl = function(_, url) {
	var headers = {
		"Authorization": "Bearer " + _accessToken
	};

	var req = httpClient.httpRequest(_, {
		url: url,
		headers: headers
	});

	var resp = req.end().response(_);
	console.log ("XXX: " + resp);

	resp.setEncoding("utf8");	
	var content = resp.readAll(_);


	return content; // resp;

	// return httpRequest({
	// 	url: url,
	// 	headers: headers
	// }, ~_);
	/*
httpRequest({
	 	url: url,
	 	headers: headers
	 }, function(err, httpResponse, body) {
	 	console.log(err)
console.log(httpResponse)
console.log(body)
  });*/
};

/*
test 
 * http://fr.linkedin.com/in/dbopp
 * http://de.linkedin.com/pub/mathias-walz/97/206/354
 * http://de.linkedin.com/pub/norbert-butzke/85/b87/138
 * http://fr.linkedin.com/in/sophierebeyrotte/de
 */
exports.getUserByUrlOnline = function(_, purl) {
	console.log("AAA " + purl);
	var res = exports.getUrl(_,
		"https://api.linkedin.com/v1/people/url=" + encodeURIComponent(purl) +
		":(id,first-name,last-name,headline,picture-url,industry,summary,specialties," +
		"positions:(id,title,summary,start-date,end-date,is-current," +
		"company:(id,name,type,size,industry,ticker))," +
		"educations:(id,school-name,field-of-study,start-date,end-date,degree,activities,notes)," +
		"associations,interests,num-recommenders,date-of-birth," +
		"publications:(id,title,publisher:(name),authors:(id,name),date,url,summary)," +
		"patents:(id,title,summary,number,status:(id,name),office:(name),inventors:(id,name),date,url)," +
		"languages:(id,language:(name),proficiency:(level,name))," +
		"skills:(id,skill:(name))," +
		"certifications:(id,name,authority:(name),number,start-date,end-date)," +
		"courses:(id,name,number)," +
		"recommendations-received:(id,recommendation-type,recommendation-text,recommender)," +
		"honors-awards,three-current-positions,three-past-positions,volunteer)?format=json");
	console.log("BBB " + res);
	return res; //.body;
};

exports.getUserByUrl = function(_, purl) {
	var db = adminHelper.getCollaborationOrm(_);

	var prof = db.fetchInstances(_, db.model.getEntity(_, "profileSync"), {
		jsonWhere: {
			id: purl
		}
	});

	if (prof && prof.length) {
		return prof[0].raw(_);
	}

	return null;
};

exports.dispatcher = linkedinDispatcher;