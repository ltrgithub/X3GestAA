var fs = require('fs');
var util = require('util');

// writes content into file and creates directory if necessary
// parameters: content may be buffer or string. If it is a string, encoding 'utf8' will be assumed 

function writeFile(targetFile, content, _) {
	console.log("WRITEFILE "+targetFile)
	try {
		fs.writeFile(targetFile, content, _);
	} catch (e) {
		console.log(e.code+"Exception... "+e)
		if (e.code === 'ENOENT') { // maybe directory does not exist
			mkdirs(targetFile, _);
			fs.writeFile(targetFile, content, _);
		} else 
			throw e;
	}
}

exports.writeFile = writeFile;

function createWriteStream(targetFile, _) {
	try {
		return fs.createWriteStream(targetFile);
	} catch (e) {
		if (e.code === 'ENOENT') { // maybe directory does not exist
			mkdirs(targetFile, _);
			return fs.createWriteStream(targetFile);
		} else 
			throw e;
	}
}

exports.createWriteStream = createWriteStream 
	
function open(targetFile, _) {
	try {
		return fs.open(targetFile, "w", _);
	} catch (e) {
		if (e.code === 'ENOENT') { // maybe directory does not exist
			mkdirs(targetFile, _);
			return fs.open(targetFile, "w", _);
		} else 
			throw e;
	}
}



exports.open = open; 

function mkdirs(targetFile, _) {
	console.log("Path   "+targetFile);
	var segs;
	 segs = targetFile.split('\/');
	 console.log("2222");
	console.log("Path parts1 "+util.format(segs))
	var p = '';
	console.log("ANZ "+(segs.length-1))
	var i = 0;
	while (i < segs.length-1) {
		console.log("Value "+i);
		var seg = segs[i];
		p += (i ? '/' : '') + seg;
		console.error("---------- Path "+p);
		if (!fs.existsSync(p))
			fs.mkdirSync(p);
		i++;
	}	
}

//writes content into file and creates directory if necessary
//parameters: content may be buffer or string. If it is a string, encoding 'utf8' will be assumed 
function writeFileAction(targetFile, action, _) {
	try {
		action(targetFile, _);
	} catch (e) {
		console.log(e.code+"Exception... "+e)
		if (e.code === 'ENOENT') { // maybe directory does not exist
			action(targetFile);
		} else 
			throw e;
	}
}
 
