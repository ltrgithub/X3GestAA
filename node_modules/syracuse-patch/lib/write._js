var fs = require('fs');
var util = require('util');

// writes content into file and creates directory if necessary
// parameters: content may be buffer or string. If it is a string, encoding 'utf8' will be assumed 

function writeFile(targetFile, content, _) {
	console.log("WRITEFILE "+targetFile)
	try {
		fs.writeFile(targetFile, content, _);
	} catch (e) {
		if (e.code === 'ENOENT') { // maybe directory does not exist
			mkdirs(targetFile);
			fs.writeFile(targetFile, content, _);
		} else 
			throw e;
	}
}

exports.writeFile = writeFile;

function createWriteStream(targetFile, _) {
	console.log("Create write"+targetFile)
	try {
		console.log("Create wri2te"+targetFile)
		return fs.createWriteStream(targetFile);
	} catch (e) {
		console.log("Error1 "+e);
		if (e.code === 'ENOENT') { // maybe directory does not exist
			console.log("Error2 ");
			mkdirs(targetFile);
			console.log("Error3 ");
			return fs.createWriteStream(targetFile);
		} else 
			throw e;
	}
}

exports.createWriteStream = createWriteStream 
	
function open(targetFile, _) {
	try {
		return fs.open(targetFile, "w", _);
	} catch (e) {
		if (e.code === 'ENOENT') { // maybe directory does not exist
			mkdirs(targetFile);
			return fs.open(targetFile, "w", _);
		} else 
			throw e;
	}
}



exports.open = open; 

function mkdirs(targetFile) {
	console.log("Path   "+targetFile);
	var segs = targetFile.split('\/');
	var p = '';
	var i = 0;
	while (i < segs.length-1) {
		var seg = segs[i];
		p += (i ? '/' : '') + seg;
		if (!fs.existsSync(p))
			fs.mkdirSync(p);
		i++;
	}	
}

//writes content into file and creates directory if necessary
//parameters: content may be buffer or string. If it is a string, encoding 'utf8' will be assumed 
function writeFileAction(targetFile, action, _) {
	try {
		action(targetFile, _);
	} catch (e) {
		console.log(e.code+"Exception... "+e)
		if (e.code === 'ENOENT') { // maybe directory does not exist
			action(targetFile);
		} else 
			throw e;
	}
}
 
