"use strict";
var url = require('url');

exports.dispatcher = function(config) {
	return function(_, request, response) {
		var path = url.parse(request.url).pathname;
		if (/^\/patchIntegration\//.test(path)) {
			var answer = "OK";
			path = path.substr("/patchIntegration".length); // remainder of the path
			request.setEncoding("utf8");
			console.log("patch integration");
			var patchdata = request.readAll(_);
			if (!patchdata) {
				response.writeHead(500, {
					"Content-Type": "text/plain"
				});
				response.end('No patch data');
				console.log("No patch data");
				return;
			}
			// batch integration
			if (path === "/batch") {
				try {
					var result = require('syracuse-collaboration/lib/entities/patch').batchIntegration(patchdata, _);
					answer = result;
				} catch (e) {
					response.writeHead(500, {
						"content-Type": "text/plain"
					});
					response.end("1;" + e);
				}
			} else if (path === "/unlock") {
				require('syracuse-collaboration/lib/entities/patch').setLock(_, false);
				answer = "Unlocked";
			} else {
				require('syracuse-patch/lib/integrate').clusterPatch(null, patchdata, {}, _);
				answer = "local patch integrated";
			}
			console.log("patch integrated");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end(answer);
		} else if (/^\/consitency\//.test(path)) {
			// check consistency of the installation
			var result = require('syracuse-patch/lib/patchtools').checkChecksumsAll(_);
			console.log("consistency test");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end(JSON.stringify(result));
		}
	};
};