"use strict";

var ga = require('syracuse-analytics/lib/gaClient');
var mongodb = require('streamline-mongodb');
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var endPoint = adminTestFixtures.modifyCollaborationEndpoint("mongodb_admin_test");

var baseUrl = "http://localhost:3004";
var port = 3004;
var cookie;

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endPoint.datasets.mongodb_admin_test.hostname, endPoint.datasets.mongodb_admin_test.port, {});
	var db = adminTestFixtures.newMongoDb(endPoint.datasets.mongodb_admin_test.database, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	ok(true, "mongodb initialized");
	start();
});

//start syracuse server
asyncTest("initialize syracuse test server", 1, function(_) {
	require('syracuse-main/lib/syracuse').startServers(_, port);
	ok(true, "server initialized");
	start();
});

var proxyOK;
asyncTest("Manage proxy", function(_) {
	var url = baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/";
	cookie = adminTestFixtures.getCookie(_, baseUrl);
	// Create Proxy configuration
	var name = "proxyTest";
	var confBody = adminTestFixtures.post(_, cookie, url + "proxyConfigurations", {
		name: name,
		host: "ecvmdevprod2", // This is Grenoble proxy server
		port: 80
	});
	var body = adminTestFixtures.get(_, cookie, url + "settings");
	var settingUuid = body.$resources[0].$uuid;
	adminTestFixtures.put(_, cookie, url + "settings('" + settingUuid + "')?representation=setting.$edit", {
		proxy: true,
		proxyConf: {
			$uuid: confBody.$uuid
		},
		$actions: {
			$save: {
				$isRequested: true
			}
		}
	});
	start();
});

asyncTest("pageview hits", function(_) {
	ga.collect.pageview({
		dh: "home.navigation2", // Document hostname.
		dp: "/home3"  , // Page.
		dt: "Syracuse Navigation Page3", // Title.
	}, {
		AppLinkTyp: "$fusion"
	}).send(_);
	
	ok(true, "ok");
	start();
});

test("stop  tests", 0, function() {
	doStop = true;
	start();
});