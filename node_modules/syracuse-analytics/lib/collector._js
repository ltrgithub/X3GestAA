"use strict";

var helpers = require('syracuse-core/lib/helpers');
var ez = require('ez-streams');
var ga = require('syracuse-analytics');
var querystring = require("querystring");

var tracer = require("syracuse-trace/lib/helper").getTracer("analytics");

var hitsQueue;
var createHitsQueue = function() {
	tracer.info && tracer.info("Create GA Hits queue");
	var errCount = 0;
	var writer = ga.writer();
	hitsQueue = ez.devices.queue({
		max: 10000,
	});
	hitsQueue.putErrCount = 0;
	hitsQueue.putErrTime = new Date().getTime();

	hitsQueue.reader.pipe(_ >> function(err) {
		if (err) {
			if (errCount++ < 3) tracer.error && tracer.error("Error in GA Hits queue: " + err.stack);
			setTimeout(function() {
				hitsQueue = null;
			}, 60000);
		}
	}, writer);
};


var Hit = helpers.defineClass(function(type, params, dim) {
	dim = dim || {};
	this.params = params || {};
	this.params.t = type;
	this.params.cd1 = dim.AppCustomer;
	this.params.cd2 = dim.AppName;
	this.params.cd3 = dim.AppInternal;
	this.params.cd4 = dim.AppUser;
	this.params.cd5 = dim.AppVersion;
	this.params.cd6 = dim.AppModule;
	this.params.cd7 = dim.AppPlatform;
	this.params.cd8 = dim.AppLinkTyp;
	this.params.cd9 = dim.AppCustomiz;
	this.params.cd10 = dim.AppFacet;
	this.params.cd11 = dim.AppOwner;

	if (!hitsQueue) {
		createHitsQueue();
	}
}, null, {
	store: function() {
		if (!hitsQueue.put(this.query())) {
			hitsQueue.putErrCount++;
			var t = new Date().getTime();
			if (t - hitsQueue.putErrTime > 60000) {
				tracer.error & tracer.error(hitsQueue.putErrCount + " hits have been lost");
				hitsQueue.putErrTime = t;
				hitsQueue.putErrCount = 0;
			}
		}
	},
	query: function() {
		return querystring.stringify(this.params);
	}
});

var Pageview = helpers.defineClass(function(params, dim) {
	Hit.call(this, "pageview", params, dim);
}, Hit, {});

var Event = helpers.defineClass(function(params, dim) {
	Hit.call(this, "event", params, dim);
}, Hit, {});

var Collector = helpers.defineClass(function() {}, null, {
	pageview: function(params, customDim) {
		return new Pageview(params, customDim);
	},
	event: function(category, action, label, value) {
		return new Event(category, action, label, value);
	},
});

exports.collect = new Collector();