"use strict";

var config = require('config');
var httpClient = require("syracuse-httpclient/lib/httpClient");
var ez = require('ez-streams');

var tracer = require("syracuse-trace/lib/helper").getTracer("analytics");
var debugMode = config.ga && config.ga.debug;
/**
 * POST /collect HTTP/1.1
 * Host: www.google-analytics.com
 * payload_data
 */
var gaHost = "www.google-analytics.com";
var dbgPath = "/debug/collect";
var path = "/collect";
var method = "POST";

var send = function(_, data, opt) {
	opt = opt || {};
	var dbg = opt.debug || debugMode;
	console.error("Debug mode active: " + dbg);
	var options = {
		method: method,
		url: "https://" + gaHost + (dbg ? dbgPath : path),
		headers: {},
		proxy: httpClient.getDefaultProxyConf(_)
	};

	var request = httpClient.httpRequest(_, options);
	tracer.debug && tracer.debug("GA parameters: " + JSON.stringify(data, null, 2));

	var resp = request.end(data).response(_);
	var res = resp.readAll(_);
	var result = {
		status: resp.statusCode,
		data: res && typeof res === "string" && res.indexOf('{') === 0 ? JSON.parse(res) : res
	};
	if (result.status >= 300) tracer.error && tracer.error("Failed to send statistics on GA.\n" + JSON.stringify(data));
	tracer.debug && tracer.debug("GA Result: " + JSON.stringify(result, null, 2));
	return result;
};

exports.writer = function() {
	return ez.devices.generic.writer(function(_, val) {
		send(_, val);
	});
};