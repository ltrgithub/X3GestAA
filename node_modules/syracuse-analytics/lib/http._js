"use strict";

var httpClient = require("syracuse-httpclient/lib/httpClient");

var tracer = require("syracuse-trace/lib/helper").getTracer("analytics");
var debugMode = false;
/**
 * POST /collect HTTP/1.1
 * Host: www.google-analytics.com
 * payload_data
 */
var gaHost = "www.google-analytics.com";
var path = debugMode ? "/debug/collect" : "/collect";
var method = "POST";

exports.send = function(_, context, data) {
	var options = {
		method: method,
		url: "https://" + gaHost + path,
		headers: {},
		proxy: httpClient.getDefaultProxyConf(_)
	};

	var request = httpClient.httpRequest(_, options);
	tracer.debug && tracer.debug("Sent parameters: " + JSON.stringify(data, null, 2));

	var resp = request.end(data).response(_);
	var res = resp.readAll(_);
	var result = {
		status: resp.statusCode,
		data: res && typeof res === "string" && res.indexOf('{') === 0 ? JSON.parse(res) : res
	};
	if (result.status >= 300) tracer.error && tracer.error("Failed to send statistics on GA.\n" + JSON.stringify(data));
	tracer.debug && tracer.debug("Result: " + JSON.stringify(result, null, 2));
	tracer.debug && tracer.debug("==================\n");
	return result;
};