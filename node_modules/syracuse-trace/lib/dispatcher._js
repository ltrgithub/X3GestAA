"use strict";
var syracuse;
var url = require('url');
var traceRecord = require('./entities/traceRecord');
var mock = require('@sage/syracuse-lib/src/load-balancer/mock');
var config = require('config');
var globals = require('streamline-runtime').globals;

var multiTenant = config.hosting && config.hosting.multiTenant;

exports.dispatcher = function(config) {
	var routes = {
		test: traceRecord.testExternal,
		start: traceRecord.startExternal,
		stop: traceRecord.stopExternal,
		flush: traceRecord.flushExternal,
		pause: traceRecord.pauseExternal,
		resume: traceRecord.resumeExternal,
		change: traceRecord.changeExternal,
		halt: require('syracuse-trace/lib/helper').haltRecording,
	};
	return function(_, request, response) {
		console.log("DISP " + request.url);
		syracuse = syracuse || require('syracuse-main/lib/syracuse');
		if (syracuse.server instanceof mock.MockStreamServer && !request.fromNanny && !request._request.fromNanny || !(syracuse.server instanceof mock.MockStreamServer) && (!config.system || !config.system.enableDevelopmentFeatures)) {
			response.writeHead("404", {});
			return response.end("Resource not found.");
		}
		var parsed = url.parse(request.url, true);
		var parts = parsed.pathname.split('/');
		var tenant = parsed.query.tenantId;
		if (multiTenant && tenant && !syracuse.initializedTenant(tenant)) {
			response.writeHead("200", {});
			console.log("Ignored");
			return response.end("Ignored");
		} else {
			globals.context.tenantId = tenant;
		}
		console.log("TENANT " + globals.context.tenantId);
		var route = routes[parsed.pathname.split('/')[2]];
		if (route) {
			route(_, parsed.query.seq, parsed.query.uuid);
			response.end("OK");
			return;
		} else {
			response.writeHead(200, {
				"Content-Type": "application/json"
			});
			var d = require("syracuse-trace/lib/dumpGlobals");
			response.end(JSON.stringify(d.dumpGlobals(_, 1, parsed.pathname), null, "\t"));
		}



	};
};