"use strict";
var syracuse;
var url = require('url');
var traceRecord = require('./entities/traceRecord');
var mock = require('syracuse-load/lib/mock');

exports.dispatcher = function(config) {
	var routes = {
		test: traceRecord.testExternal,
		start: traceRecord.startExternal,
		stop: traceRecord.stopExternal,
		flush: traceRecord.flushExternal,
		pause: traceRecord.pauseExternal,
		resume: traceRecord.resumeExternal,
		change: traceRecord.changeExternal,
		halt: require('syracuse-trace/lib/helper').haltRecording,
	};
	return function(_, request, response) {
		console.error("DISP " + request.url);
		syracuse = syracuse || require('syracuse-main/lib/syracuse');
		if (syracuse.server instanceof mock.MockStreamServer && !request.fromNanny && !request._request.fromNanny) {
			response.writeHead("404", {});
			return response.end("Resource not found.");
		}
		var parsed = url.parse(request.url, true);
		var route = routes[parsed.pathname.split('/')[2]];
		console.log("ROUTE " + route + " ");
		if (route) {
			route(_, parsed.query.seq, parsed.query.uuid);
			response.end("OK");
			return;
		} else {
			response.writeHead(200, {
				"Content-Type": "application/json"
			});
			var d = require("syracuse-trace/lib/dumpGlobals");
			response.end(JSON.stringify(d.dumpGlobals(_, 1, parsed.pathname), null, "\t"));
		}



	};
};