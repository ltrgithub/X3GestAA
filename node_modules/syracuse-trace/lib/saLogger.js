"use strict";
/// !doc
///
/// # Storage area logging  
/// 
var locale = require("syracuse-core/lib/locale");
var helpers = require('syracuse-core/lib/helpers');
var sa = require('syracuse-orm/lib/storageArea');
var defLogger = require('syracuse-trace/lib/defLogger').defLogger;
var datetime = require('syracuse-core/lib/types/datetime');

// internal traces
var _tracer = console.log;

// Standard callback replace _ callback to be able to use this transport in not streamlined functions
var cb = function(err, result) {
	if (err) throw err;
	return result;
};

exports.saLogger = helpers.defineClass(function(name, options) {
	this.name = name;

	this.filename = null;
	this.properties = {
		description: "Traces [" + this.name + "]",
		content: {
			contentType: "text/plain",
			append: true,
			fileName: ""
		}
	};
	this.filter = {
		jsonWhere: {
			fileName: ""
		}
	};
	this.type = "storagearea";
	this.dd = null;

	this.sid = options && options.sid;
	this.expiry = options && options.expiry;
}, defLogger, {
	_computeFileName: function() {

		var d = new Date();
		var date = d.getDate();
		var month = d.getMonth() + 1; //Months are zero based
		var year = d.getFullYear();
		this.fileName = "Trace_" + this.name + "_" + year + "-" + month + "-" + date;
		if (this.sid) {
			this.fileName += "_" + this.sid;
			this.properties.description = "Session " + this.properties.description;
		}

	},
	initialise: function() {
		this._computeFileName();
		if (this.dd && this.properties && this.properties.content && this.properties.content.fileName !== this.fileName) {
			this.close();
		}
		// Set file name
		this.properties.content.fileName = this.fileName;

		// for sessions
		if (this.sid) {
			this.properties.sid = this.sid;
		}
		if (this.expiry) {
			var dateExpire = new Date((new Date()).getTime() + this.expiry * 60 * 1000);
			this.properties.expiration = datetime.fromJsDate(dateExpire);
		}
		//

		this.dd = sa.open(cb, {
			jsonWhere: {
				fileName: this.fileName
			}
		}, null, "serverLog");
		if (!this.dd) {
			_tracer && _tracer("File [ " + this.fileName + "] doesn't exists. So create a new one...");
			this.dd = sa.open(cb, null, null, "serverLog");
		} else {
			_tracer && _tracer("File [ " + this.fileName + "] found and reused : " + this.dd);
		}
		if (!this.instance) {
			this.instance = sa.getDocumentInstanceByDD(cb, this.dd);
			this.instance.warnDiags(cb, [locale.format(module, "traceOpened")]);
		}

		_tracer && _tracer("Initialised - " + this.dd);
		sa.write(cb, this.dd, this.properties, "=== Trace Initialised ===\n", true);


		// Expires according to the parameter
		// Need to change this so that we expire according to the number of
		// days in the cycle
		// var dateExpire = new Date((new Date()).getTime() + this.expiry * 60 * 1000);
		// self.log.properties.expiration = datetime.fromJsDate(dateExpire);
	},
	// Can be overrided
	preprocess: function(data) {},
	trace: function(data, withoutRetry) {
		try {
			if (!this.dd) {
				this.initialise();
			}
			sa.write(cb, this.dd, this.properties, data.output + "\n", true);
		} catch (e) {
			console.error("Error in trace: " + e.stack);
			if (!withoutRetry) {
				this.initialise();
				this.trace(data);
			}
		}
	},
	trace: function(data) {
		this._doTrace(this.initialise(), data);
	},
	close: function() {
		_tracer && _tracer("Close sa transport");
		if (this.dd && this.instance) {
			sa.write(cb, this.dd, this.properties, "=== Trace Closed ===\n", true);
			this.instance.warnDiags(cb, []);
			this.instance.infoDiags(cb, [locale.format(module, "traceClosed")]);
			sa.close(cb, this.dd, true);
			this.dd = null;
			this.instance = null;
		}
	},
	toJSON: function() {
		return this.type;
	}
});