"use strict";
var locale = require('streamline-locale');
var traceHelper = require('../helper');

module.exports = {
	$extends: "setting",
	$events: {
		$beforeSave: [
			function(_, instance) {
				if (!instance.traceMaxSize(_)) instance.traceMaxSize(_, "10m");
				else if (traceHelper.computeSize(instance.traceMaxSize(_)) < 10000000) {
					instance.traceMaxSize(_, "10m");
					instance.$diagnoses.push({
						$severity: "warning",
						$message: locale.format(module, "maxSizeTooSmall")
					});
				}
				var traceMaxDaysChanged = instance.traceMaxDaysChanged(_);
				if (traceMaxDaysChanged) {
					var nbDeleted = traceHelper.removeOldAutoRecords(_, null, instance.traceMaxDays(_));
					instance.traceMaxDaysChanged(_, false);
					if (nbDeleted > 0) {
						instance.$diagnoses = instance.$diagnoses || [];

						instance.$diagnoses.push({
							$severity: "info",
							$message: locale.format(module, "autoRecDeleted", nbDeleted)
						});
					}
				} else if (traceMaxDaysChanged === undefined || traceMaxDaysChanged === null) {
					instance.traceMaxDaysChanged(_, false);
				}
			}
		]
	}
};