"use strict";

var traceHelper = require('syracuse-trace/lib/helper');
var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;


function createInstance(_, c) {
	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.model.getEntity(_, "traceSessionConfig");
	var modEntity = db.model.getEntity(_, "traceConfigModule");
	var inst = entity.createInstance(_, db, null);
	inst.name(_, c.name);
	inst.sid(_, c.sid);
	c.description && inst.description(_, c.description);
	c.enabled && inst.enabled(_, c.enabled);
	c.modularized && inst.modularized(_, c.modularized);
	c.level && inst.level(_, c.level);
	c.description && inst.description(_, c.description);

	if (c.modules) {
		c.modules.forEach_(_, function(_, m) {
			var mod = modEntity.createInstance(_, db, null);
			mod.name(_, m.name);
			m.description && mod.description(_, m.description);
			m.enabled && mod.enabled(_, m.enabled);
			m.level && mod.level(_, m.level);
			inst.modules(_).set(_, mod);
		});
	}
	return inst;
}

exports.entity = {
	$titleTemplate: "Session traces configuration for '{description}'",
	$descriptionTemplate: "Configure {name} session traces",
	$valueTemplate: "{name}",
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$canDelete: false,
	$canCreate: false,
	$key: "{name}",
	$properties: {
		name: {
			$isUnique: true,
			$linksToDetails: true,
			$title: "Name",
			$isReadOnly: true,
			$type: "string"
		},
		description: {
			$linksToDetails: false,
			$displayLength: 30,
			$title: "Description",
			$isReadOnly: true,
			$type: "string",
			$isLocalized: true
		},
		enabled: {
			$title: "Enabled",
			$type: "boolean",
			$default: false
		},
		modularized: {
			$type: "boolean",
			$default: false,
			$isDefined: function(_, instance) {
				return false;
			},
			$compute: function(_, instance) {
				return instance.modules(_).getLength() > 0;
			}
		},
		level: {
			$title: "Tracing level",
			$isDefined: function(_, instance) {
				return instance.enabled(_) && !instance.modularized(_);
			},
			$enum: [{
				$value: "error",
				$title: "Error"
			}, {
				$value: "warning",
				$title: "Warning"
			}, {
				$value: "info",
				$title: "Info"
			}, {
				$value: "debug",
				$title: "Debug"
			}],
			$default: "info"
		},
		sid: {
			$title: "Session id",
			$isReadOnly: true
		}
	},
	$relations: {
		modules: {
			$title: "Modules",
			$type: "traceConfigModules",
			$isReadOnly: true,
			$isChild: true,
			$inv: "traceConfigs",
			$isDefined: function(_, instance) {
				return instance.enabled(_) && instance.modularized(_);
			}
		}
	},
	$fetchInstances: function(_, context) {
		var list = [];
		var sid = context.httpSession.id;
		var configs = traceHelper.getSessionConfigs(sid);

		Object.keys(configs).forEach_(_, function(_, name) {
			var inst = createInstance(_, configs[name]);
			list.push(inst);
		});
		return list;
	},
	$functions: {
		$setId: function(_, context, id) {
			var sid = context.httpSession.id;
			var config = traceHelper.getSessionConfig(sid, id);
			var inst = createInstance(_, config);
			var self = this;
			this.name(_, inst.name(_));
			this.sid(_, inst.sid(_));
			this.description(_, inst.description(_));
			this.enabled(_, inst.enabled(_));
			this.modularized(_, inst.modularized(_));
			this.expiry(_, inst.expiry(_));
			inst.modules(_).toArray(_).forEach_(_, function(_, m) {
				self.modules(_).set(_, m);
			});

		},
		$save: function(_) {
			traceHelper.loadSessionConfig(_, this);
		}
	},

};