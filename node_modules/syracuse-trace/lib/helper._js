"use strict";

/// !doc
///
/// # Logging/tracing helper function  
///
/// Create a logger with default or existing configuration, making it simple for the applications to
/// specify the correct logger without having to know anything about
/// the options involved.

var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;
var genLogger = require('syracuse-trace/lib/genLogger').genLogger;

var tracers = {};

// called by each modules that use traces
exports.getTracer = function(name, description) {
	tracers[name] = tracers[name] || new genLogger({
		name: name,
		description: description
	});
	return tracers[name];
};

// called by syracuse module in initAsync function
exports.instanciateTracers = function(_) {
	Object.keys(tracers).forEach_(_, function(_, name) {
		var config = _getTracerConfig(_, tracers[name]);
		tracers[name]._loadConfig(config);
	});
};


var _getTracerConfig = function(_, tracer) {
	var config = getConfig(_, tracer.logType);
	// If no configuration exists, create a default one
	if (!config) {
		config = registerConfig(_, tracer.logType, tracer.logTitle);
	}
	return config.serializeInstance(_);
};

function getConfig(_, name) {
	var db = adminHelper.getCollaborationOrm(_);
	var inst = db.fetchInstance(_, db.model.getEntity(_, "traceConfig"), {
		sdataWhere: "name eq '" + name + "'"
	});
	return inst ? inst : null;
}

function registerConfig(_, name, description) {
	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.model.getEntity(_, "traceConfig");
	var inst = entity.createInstance(_, db, null);
	inst.name(_, name);
	inst.description(_, description);
	inst.save(_);
	return inst;
}