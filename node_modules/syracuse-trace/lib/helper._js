"use strict";

/// !doc
///
/// # Logging/tracing helper function  
///
/// Create a logger with default or existing configuration, making it simple for the applications to
/// specify the correct logger without having to know anything about the options involved.
/// 

var locale = require("syracuse-core/lib/locale");
var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;
var genLogger = require('syracuse-trace/lib/genLogger').genLogger;
var config = require('config');

var defaultTracesLevels = config.tracesLevels;

var tracers = exports.tracers = {};

exports.methods = ['debug', 'info', 'warn', 'error', 'fatal'];

// called by each modules that use traces
exports.getTracer = function(name) {
	if (!tracers[name]) {
		tracers[name] = new genLogger({
			name: name
		});
	}
	return tracers[name];
};

// TODO : Call this function from Syracuse server stop entry point...
exports.stopRunningRecords = function(_) {
	var db = adminHelper.getCollaborationOrm(_);
	var records = db.fetchInstances(_, db.model.getEntity(_, "traceRecord"));
	records.forEach_(_, function(_, record) {
		if (record.status(_) === "running" || record.status(_) === "paused") {
			record.stopRecording(_);
		}
	});
};

exports.launchAutoTraceRecord = function(_) {
	var db = adminHelper.getCollaborationOrm(_);
	var autoRecord = db.model.getEntity(_, "traceRecord").createInstance(_, db, null);
	autoRecord.name(_, "Auto_Record_" + autoRecord.stamp(_).toJsDate().toISOString() + "_" + process.pid);
	autoRecord.auto(_, true);
	autoRecord.save(_);
};

exports.initializeTracers = function(_) {
	var db = adminHelper.getCollaborationOrm(_);
	// Synchronize configurations
	syncConfigs(_, db);

	// Stop running records (if server crashed)
	exports.stopRunningRecords(_);

	// Launch auto trace record
	exports.launchAutoTraceRecord(_);
};

exports.resetConfigs = function(_, instance) {
	var db = adminHelper.getCollaborationOrm(_);
	instance.configs(_).reset(_);
	instance.save(_);
	return syncConfigs(_, db);
};

// syncConfigs create or update default trace settings configurations
var syncConfigs = function(_, db) {
	var entity = db.model.getEntity(_, "traceConfig");
	var modEntity = db.model.getEntity(_, "traceConfigModule");
	var setEntity = db.model.getEntity(_, "traceSetting");
	var processedConfigs = [];
	var settings = db.fetchInstances(_, setEntity)[0];
	if (!settings) {
		settings = setEntity.createInstance(_, db, null);
		settings.code(_, "settings");
		settings.description(_, "Traces settings");
	}

	var confs = settings && settings.configs(_);

	function _getConfig(_, name) {
		if (confs && confs.getLength() > 0) return confs.filter(_, {
			sdataWhere: "name eq '" + name + "'"
		})[0];
		return null;
	}

	function _updateModules(_, _conf, modName) {
		if (modName) {
			// Delete modules that exist but must not
			if (tracers[_conf.name(_)] && tracers[_conf.name(_)].modules && tracers[_conf.name(_)].modules.getLength() > 0) {
				_conf.modules(_).forEach_(_, function(_, m) {
					if (m.name(_) === modName) _conf.modules(_).deleteInstance(_, m.$uuid);
				});
			}

			var mod;
			// Create modules that do not exist
			if (!_conf.modules(_).toArray(_).some_(_, function(_, mod) {
				return mod.name(_) === modName;
			})) {
				mod = modEntity.createInstance(_, db, null);
				mod.name(_, modName);
				var defLevel = defaultTracesLevels && defaultTracesLevels[_conf.name(_)] && defaultTracesLevels[_conf.name(_)][modName];
				if (defLevel) mod.level(_, defLevel);
				_conf.modules(_).set(_, mod);
			}

			mod = mod || _conf.modules(_).filter(_, {
				sdataWhere: "name eq '" + modName + "'"
			})[0];

			var description;
			try {
				description = locale.format(module, _conf.name(_) + "." + modName);
			} catch (e) {
				throw new Error("Please add description for tracer's module [" + _conf.name(_) + "." + modName + "] in 'syracuse-trace/lib/resources/helper-en.json");
			}
			if (description !== mod.description(_)) {
				mod.description(_, description);
				_conf.modules(_).set(_, mod);
			}

		}
	}

	// Create or update configurations needed by tracers
	Object.keys(tracers).forEach_(_, function(_, name) {

		var tracerName, moduleName;
		if (name.indexOf('.') !== -1) {
			var parts = name.split('.');
			tracerName = parts[0];
			moduleName = parts[1];
		} else {
			tracerName = name;
		}

		var conf = _getConfig(_, tracerName);
		// If no configuration exists, create a default one
		if (!conf) {
			conf = entity.createInstance(_, db, null);
			conf.name(_, tracerName);
			var defLevel = defaultTracesLevels && defaultTracesLevels[conf.name(_)];
			if (defLevel && typeof defLevel === "string") conf.level(_, defLevel);
			settings.configs(_).set(_, conf);
		}
		var description;
		try {
			description = locale.format(module, tracerName);
		} catch (e) {
			throw new Error("Please add description for tracer [" + tracerName + "] in 'syracuse-trace/lib/resources/helper-en.json");
		}
		if (description !== conf.description(_)) {
			conf.description(_, description);
		}

		_updateModules(_, conf, moduleName);
		processedConfigs.push(conf.$uuid);
	});

	// Remove or update configurations not needed by tracers
	confs.refresh(_);
	confs.toArray(_).filter_(_, function(_, c) {
		return processedConfigs.indexOf(c.$uuid) === -1;
	}).forEach_(_, function(_, c) {
		var removed = false;
		if (!Object.keys(tracers).some_(_, function(_, name) {
			return name === c.name(_) || name.indexOf(c.name(_) + ".") !== -1;
		})) {
			removed = true;
			confs.deleteInstance(_, c.$uuid);
			//c.deleteSelf(_);
		}
		if (!removed && c.modularized(_)) {
			if (c.modules(_).getLength() > 0) {
				c.modules(_).forEach_(_, function(_, m) {
					_updateModules(_, c, m.name(_));
				});
			}
		}
		//if (!removed) c.save(_);
	});
	settings.save(_);
	return settings;
};