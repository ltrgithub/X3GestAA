"use strict";
(function($){
    $.proto = $.proto || {};
    var $proto = $.proto;
    var $helpers = $.helpers;
    var $sdata = $.sdata;
    var that = $proto.auth || {};
    // not null if mobile authoring page
    var $authParent = (window && window.parent && (window.parent != window) && window.parent.$ && window.parent.$.auth) ? window.parent.$.auth : null;
    $proto.auth = that;
    $proto.auth.designMode = $authParent != null;
    $proto.auth.apply
    $proto.auth.notifyParent = function(event, eventData, info){
        if ($authParent) {
            return $authParent.notify(event, eventData, info);
        }
        else {
            return eventData;
        }
    };
    $proto.auth.applyAuth = function(name, value, authorUrl){
        if ($sdata.config || ($sdata.config.id != page.application)) {
            $sdata.getAppConfig($sdata.config.id, function(config, error){
                $sdata.config = config;
                
                var design = $sdata.config.pages[name];
                if (authorUrl) 
                    design.$authorUrl = authorUrl;
                design.$article = value;
                $sdata.saveAppConfig($sdata.config, function(){
                	window.location.reload(true);
                	// FDB - Reloading the page in a DB transaction causes an Abort Error displayed on the console
                	// --> But data are saved (maybe not each time ?)
                	// I tried to use window.setTimeout(function(){ window.location.reload(true)},1000);
                	// --> In that case we have no error displayed but data are not saved ??
                	// I tried also to catch onabort event in db and transaction without success
                });
                
            });
        }
    };
    $proto.auth.createAuthWorhingCopy = function(url, name, data, cb){
        var cd = {
            $actions: {
                "$save": {
                    "$isRequested": true,
                    "$parameters": {
                        "isFactory": true,
                        "variantCode": "DEFAULT",
                        "variantTitle": "DEFAULT",
                        "variantDescription": "DEFAULT"
                    }
                }
            },
            content: {
                $article: data
            }
        
        };
        $sdata.post(url, cd, function(resdata){
            $helpers.pushDiagnoses(resdata);
            $.smobile.showErrors($.smobile.pageController($.mobile.activePage));
            if (!$helpers.hasErrors()) {
                window.setTimeout(function(){
                    if (resdata && resdata.$authorUrl && resdata.content && resdata.content.$article) {
                        $proto.auth.applyAuth(name, resdata.content.$article, resdata.$authorUrl);
                        if (cb) 
                            cb(resdata);
                    }
                }, 2000);
            }
        });
    };
    
    
})(jQuery);

