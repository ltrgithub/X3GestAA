"use strict";
(function($) {
	var $helpers = $.helpers;
	var $sdata = $.sdata;
	var that = $.smobile || {};
	that.staticui = that.staticui || {};
	var ui = that.staticui;
	var localeLoaded = false;

	var capabilities = $sdata.capabilities;
	capabilities.showSettings = true;

	function updLocale(value, next) {
		// number thousandSep && numberDecimalSeparator
		if (value.numberGroupSeparator != null) {
			$helpers.number.thousandSep = value.numberGroupSeparator;
		}
		if (value.numberDecimalSeparator != null) {
			$helpers.number.decimalSep = value.numberDecimalSeparator;
		}
		//
		$helpers.lang2DateSettings(value.shortDate, value.shortTime, value.longTime);
		if ($.scroller) {
			$.scroller.setDefaults($helpers.dateSettings);
		}
		localeLoaded = true;
		return next();
	}

	function activateLocale(sl, next) {
		var currentlang = $helpers.extractLang(sl);
		var setUserProfile = function() {
			that.userProfile.setLocale(sl, next);
		};
		if (!currentlang) {
			var cl = $helpers.extractLang($helpers.browserLanguage());
			// download and activate language
			return $sdata.downloadLocale(cl, function(bl) {
				if (bl) {
					// save last used language
					$helpers.setLanguage(bl + "-" + bl.toUpperCase());
					$helpers.lang2DateSettings();
					if ($.scroller) $.scroller.setDefaults($helpers.dateSettings);
				}
				return setUserProfile();
			});
		}
		var activelang = $helpers.currentLocale();
		if (currentlang !== activelang) {
			return $sdata.downloadLocale(currentlang, function(bl) {
				if (bl) {
					// save last used language
					$helpers.setLanguage(sl);
					$helpers.lang2DateSettings();
					if ($.scroller) $.scroller.setDefaults($helpers.dateSettings);

				}
				return setUserProfile();
			});
		}
		$helpers.setLanguage(sl);
		return next();
	};
	capabilities.installUrl = "/sdata/syracuse/collaboration/syracuse/dashboardDefs/$service/mobilePortlets";
	capabilities.authUrl = "/sdata/syracuse/collaboration/syracuse/userProfiles/$service/current";
	capabilities.loadLocale = true;
	capabilities.localeLoader = function(next, force) {
		// get saved language 
		if (localeLoaded && !force) return next();
		if (!localeLoaded && $helpers.online() && (!capabilities.authRequired || !capabilities.auth)) {
			return $sdata.GET($sdata.sdataHost + _auth.authurl, function(data, headers) {
				if (data) {
					if (data.versionInfo && data.versionInfo.versionMobile) {
						$sdata.checkVersionInCache(data.versionInfo.versionMobile);
					}

					var localeConfig = data.selectedLocale;
					return updLocale(localeConfig, function() {
						return activateLocale(localeConfig.code, next);
					});

				}
				activateLocale($helpers.language(), next);
			}, null, {
				timeout: 0
			});

		}
		//use last used language or browser language
		activateLocale($helpers.language(), next);
	};
	// Settings pages
	// There is a enhanceHandler in controller (that.PAGES.settings.enhanceHandler) that hide/show logonblock according to c1 checkbox value
	var _htmlFieldInfo = function(locale, key) {
		return '<div class="s-m-fieldinfo">' + $helpers.htmlEncode(locale.ui[key]) + '</div>';
	};
	ui.settings = function() {
		var locale = $helpers.locale();
		var res = {
			"$title": locale.administration.title,
			"content": {
				"cp": {
					"layout": "BlockBodyLayout",
					"data": {}
				},
				"offline": {
					"uiClass": "CheckBox",
					"data": {
						"label": locale.ui.offline,
						"bind": "offline",
						"action": "Offline"
					},
					"parent": "cp"
				},
				"c1": {
					"uiClass": "CheckBox",
					"data": {
						"label": locale.ui.saved_logon,
						"bind": "autoLogon",
						"action": "fixedLogin"
					},
					"parent": "cp"
				},
				'c11': {
					"uiClass": "Html",
					"data": {
						"html": _htmlFieldInfo(locale, "saved_logon_txt")
					},
					"parent": "cp"
				},
				"logonblock": {
					"layout": "Block",
					"data": {
						"$isHidden": false
					},
					"parent": "cp"
				},
				"c2": {
					"uiClass": "Combo",
					"data": {
						"label": locale.ui.auth_type,
						"bind": "authType",
						"value": "basic",
						"items": [{
							value: "basic",
							title: "Basic"
						}]
					},
					"parent": "logonblock"
				},
				"e1": {
					"uiClass": "Edit",
					"data": {
						"label": locale.ui.user,
						"bind": "user"
					},
					"parent": "logonblock"
				},
				"pass": {
					"uiClass": "Edit",
					"data": {
						"type": "password",
						"label": locale.ui.password,
						"bind": "password"
					},
					"parent": "logonblock"
				}
			},
			"hbuttons": [{
				"title": locale.ui.save_item,
				"action": "savesettings",
				"jmdata": {
					"data-icon": "s-ok",
					"data-transition": "back"
				}
			}],

			actions: {
				// Settings - Show hide authentication detail when check FixedLogon
				fixedLogin: function(checked) {
					var controller = this;
					var block = $('#' + controller.prefix + 'logonblock');
					if (block) {
						block.toggleClass("s-m-hidden");
					}
				},
				savesettings: function(after) {
					var controller = this;
					var cd = this.getValue();
					var settings = $helpers.settings();
					settings.sdata = settings.sdata || {};
					settings.connect = settings.connect || {};
					settings.connect.authType = cd.authType;
					settings.connect.autoLogon = cd.autoLogon;
					settings.connect.user = cd.user;
					settings.connect.password = cd.password;
					settings.offline = cd.offline;
					$helpers.settings("", settings);
					$helpers.setOfflineMode(settings.offline);
					// Force page to rebuilt -> Need it to refresh Synch counter in right panel if we switched from  offline to online
					$.smobile.removeAllPages([controller.pageInfo.pageId]);
					$.smobile.goHome(this);
					after(false);
				}
			}
		};
		if (!$.helpers.isOfflineAvail()) {
			delete res.content.offline;
		}
		return res;
	};

	/// Data sent to static pages - See smobile.parseURL
	ui.settings_data = function() {
		var cd = {};
		var settings = $helpers.settings();
		settings.sdata = settings.sdata || {};
		settings.connect = settings.connect || {};
		cd.autoLogon = settings.connect.autoLogon;
		cd.authType = settings.connect.authType || "basic";
		cd.user = settings.connect.user || "";
		cd.password = settings.connect.password || "";
		cd.offline = settings.offline || false;
		return cd;
	};
	ui.language = function() {
		var locale = $helpers.locale();
		return {
			"$title": locale.administration.title,
			"content": {
				"cp": {
					"layout": "BlockBodyLayout",
					"data": {}
				},
				"c11": {
					"uiClass": "Html",
					"data": {
						"html": locale.change_language_warning
					},
					"parent": "cp"
				},
				"locale": {
					"uiClass": "Combo",
					"data": {
						"label": locale.ui.locale,
						"bind": "locale",
						"items": []
					},
					"parent": "cp"
				}
			},
			"hbuttons": [{
				"title": locale.ui.save_item,
				"action": "savelanguage",
				"jmdata": {
					"data-icon": "s-ok",
					"data-transition": "back"
				}
			}],

			actions: {
				savelanguage: function(after) {
					var self = this;
					var currentApps = [];

					function installDone() {
						self && self.doRefresh(true);
						$.smobile.changePage("#langchanged", {
							allowSamePageTransition: true,
							reverse: true
						});
					}

					function removeApplication(app, cb) {
						currentApps.push($.extend(true, {}, app));
						$.sdata.removeFromDB(app.id, cb);
					}

					function installApplications() {
						$.smobile.doinstall(currentApps, {}, function(index, count, msg) {
							if ((index === 0) && count) {
								$.mobile.loading('show', {
									theme: "a",
									text: $helpers.locale().ui.installing
								});
							} else if (index === count) {
								$.mobile.loading('hide');
							}
						}, installDone);
					}

					function reinstallApplications() {
						$sdata.getInstalledApps(true, function(iapps) {
							function loop(idx) {
								idx++;
								if (idx === iapps.length) {
									installApplications();
								} else {
									removeApplication(iapps[idx], function() {
										loop(idx);
									});
								}
							}
							loop(-1);
						});
					}

					function changeLanguageSetting() {
						var cd = self.getValue();
						var locale = cd.locale;
						var settings = $helpers.settings();
						settings.locale = locale;
						$helpers.settings("", settings);

						activateLocale(locale, function() {
							reinstallApplications();
						});
					}

					var cd = self.getValue();
					var settings = $helpers.settings();
					if (cd.locale === settings.locale) {
						$helpers.pushInfoMessage($helpers.locale().langnotchanged);
						$.smobile.changePage("#home", {
							allowSamePageTransition: true,
							reverse: true
						});
					} else {
						// Changing language is not allowed if there are pending drafts!
						$sdata.getSyncCount(function(count) {
							if (count) {
								$helpers.pushInfoMessage($helpers.locale().ui.rmvdrafts_lang);
								self.doRefresh();
							} else {
								changeLanguageSetting();
							}
						});
					}
				}
			}
		};
	};
	ui.language_data = function() {
		var cd = {};
		var settings = $helpers.settings();
		cd.locale = settings.locale || 'en-US';
		return cd;
	};
	var _auth = {
		lastCheck: null,
		checkInterval: 0,
		authurl: capabilities.authUrl,
		detect: function(auth) {
			var res = "unknown";
			auth = auth || "";
			if (auth) auth = auth.toUpperCase();
			if (auth.indexOf("BASIC") === 0) res = "basic";
			else if (auth.indexOf("DIGEST") === 0) res = "digest";
			return res;
		},
		connect: function(next) {
			var settings = $helpers.settings();
			settings.connect = settings.connect || {};
			$helpers.clearErrors();
			if (capabilities.resetInterval) {
				_auth.lastCheck = null;
				capabilities.resetInterval = false;
			}
			if (_auth.lastCheck && ((new Date() - _auth.lastCheck) < _auth.checkInterval)) return;
			$sdata.GET($sdata.sdataHost + _auth.authurl, function(data, headers) {
				if (headers && (headers.status === 401)) {
					var sauth = _auth.detect(headers["WWW-Authenticate"]);
					if (sauth === "basic") {
						settings.connect = settings.connect || {};
						var user = settings.connect.user || "";
						var password = settings.connect.password || "";
						var aheaders = {
							Authorization: 'Basic ' + window.btoa(user + ":" + password)
						};
						$helpers.clearErrors();
						return $sdata.GET($sdata.sdataHost + _auth.authurl, function(data, headers) {
							_auth.lastCheck = ($helpers.hasErrors() ? null : new Date());
							if (data && !localeLoaded) {
								var localeConfig = data.selectedLocale;
								updLocale(localeConfig, function() {
									return activateLocale(localeConfig.code, function() {
										return next(data, $helpers.hasErrors());
									});
								});
							}
							activateLocale($helpers.language(), function() {
								return next(data, $helpers.hasErrors());
							});
						}, aheaders, {
							Authenticate: true
						});
					} else {
						_auth.lastCheck = null;
						return next(null, true);
					}
				}
				_auth.lastCheck = ($helpers.hasErrors() ? null : new Date());
				return next(null, $helpers.hasErrors());
			}, {}, {
				Authenticate: true
			});
		}
	};
	$sdata.capabilities.auth = function(next) {
		return _auth.connect(next);
	};
	$sdata.checkVersionInCache = function(versionMobile) {
		var clientVersion = $.helpers.buildDateString();
		var serverVersion = versionMobile.buildDateString;

		if (clientVersion && // Basic sanity checks to ensure we got some valid information
			clientVersion.length > 5 &&
			serverVersion &&
			serverVersion.length > 5) {
			if (clientVersion !== serverVersion) {
				// no automatic update yet, can be done manually in about page
			}
		}
	};

	$helpers.authHeaders = function(header, retry) {
		var settings = $helpers.settings();
		settings.connect = settings.connect || {};
		if (settings.connect.autoLogon) {
			if (settings.connect.authType === "basic") {
				header.Authorization = 'Basic ' + window.btoa((settings.connect.user || "") + ":" + (settings.connect.password || ""));
				if (retry) return true;
			}
		}
		return false;
	};
})(jQuery);