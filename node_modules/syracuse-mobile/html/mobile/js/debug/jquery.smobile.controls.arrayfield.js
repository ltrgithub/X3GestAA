"use strict";
(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	var $proto = $.proto;
	var $sdata = $.sdata;
	that.controls = that.controls || {};
	var _controls = that.controls;
	// move in  controls
	_controls.types = _controls.types || {};
	_controls.types._addArray = function(bind, parentbind, index) {
		return {
			value: $helpers.locale().ui.array_detail,
			action: "show_detail",
			actionParams: JSON.stringify({
				"action": "show_detail",
				"$bind": bind,
				"$parentbind": parentbind,
				"$index": index
			})
		};


	},
	_controls.types.addReference = function(proto, data, controller, field, dispTitleAndDesr) {
		var res = {};
		var cd = data,
			pp;
		proto = proto.$item || proto;

		if (data && Array.isArray(data)) {
			// [0] -> SITE - [1] -> SITE_REF
			pp = data[0];
			cd = data[data.length - 1];
		} else {
			pp = data;
		}
		var isuuid = $proto.useUuid(proto);
		if (isuuid && !cd) {
			res.value = "";
			return res;
		}
		if (cd && cd.hasOwnProperty("$value")) {
			res.value = cd.$value;
		} else if (proto.$value) {
			res.value = $proto.parseExpression(proto.$value, {
				data: controller.exprData(data),
				$prototype: proto
			}, "$value");
		} else {
			res.value = $proto.parseExpression(proto.$key, {
				data: controller.exprData(data),
				$prototype: proto
			}, "$key");
		}
		if (pp) {
			var ttl = pp.$title && pp.$title != res.value ? pp.$title : null;
			var desc = pp.$description && pp.$description != res.value ? pp.$description : null;
			if (ttl == desc) {
				ttl = null;
			}
			if (ttl == null && desc == null) {
				// #3448 -SAM 96184 - application/x-reference field - Display description/title even if it's equal to value
				ttl = pp.$title ? pp.$title : pp.$description ? pp.$description : "";
			}
			if (dispTitleAndDesr === true) {
				res.title = desc && ttl ? desc + " - " + ttl : desc || ttl || "";
			} else {
				if (ttl) {
					res.title = ttl;
				} else {
					res.title = desc;
				}
			}
		}
		if (proto.$links && proto.$links.$details) {
			var url = $proto.parseExpression(proto.$links.$details.$url, {
				data: controller.exprData(data),
				$prototype: proto
			}, "$url");
			var purl = $sdata.parseSdataUri(url);
			if ($sdata.url2proto(purl)) res.url = url;
		}
		return res;
	};
	_controls.types._table_refresh = function($parent, refresh) {
		var table = $parent.find("table.s-m-table");
		if (refresh) {
			// Force responsive (mode with largest width)
			table.addClass("ui-responsive");
			// Create table widget after html update
			$parent.trigger('create');
		}
		// Force responsive (stacked fields) if overflow (if large number of columns)
		// Responsive mode is automatically triggered regarding the width (see JQM css)
		// We want to force it if there an overflow (not static width dependent)
		// I tried to deal with overflow and overflowchanged event but it's not really cross browsers
		// ON a mobile user don't change the width (like on a desktop) except for portrait/landscape so it's not necessary to handle such events
		if (table.length > 0 && table.attr("data-mode") == "reflow") {
			// div.table
			var overflowDiv = table.parent().get(0);
			if (overflowDiv && parseInt(overflowDiv.offsetWidth) < parseInt(overflowDiv.scrollWidth)) {
				table.removeClass("ui-responsive");
			}
		}
	};
	_controls.types._table_header = function(html, $layout, $prototype, noDetailLink, edit) {
		var fields = $layout ? $layout.$items : null;
		if (!fields) return;
		var headHtml = [];
		headHtml.push('<thead><tr>');
		var prop = $prototype.$properties;
		var nbAdvanced = 0,
			priority = 0;
		var alternateStyle = true;
		fields.forEach(function(fieldArticle, index) {
			var field;
			if (fieldArticle && fieldArticle.$bind) {
				field = fieldArticle.$bind;
			} else {
				field = fieldArticle; // field's name
				fieldArticle = {};
			}
			var proto = prop[field];
			if (!proto) return;
			//  application/x-array -> We don't display More.. because in edit we have the edit detail icon
			if (proto.$isHidden || proto.$isExcluded || (edit && proto.$type === "application/x-array")) return;
			if (fieldArticle.$isAdvanced === true) {
				nbAdvanced++;
				return;
			}
			if (priority == 0) {
				headHtml.push('<th data-priority="persist">');
			} else {
				headHtml.push('<th data-priority="' + priority + '">');
			}
			priority++;
			if ($layout.$label) {
				headHtml.push('<div');
				var css = [];
				$proto.auth.mobileExtentionsLbl(css, $layout);
				if (css.length > 0) {
					headHtml.push(' class="s-m-style ' + css.join(' ') + '"');
					headHtml.push('>');
				}
			}
			//-> Display header for all types - even for More link
			headHtml.push($helpers.htmlEncode($proto.parseExpression(prop[field].$shortTitle || prop[field].$title, {
				data: null,
				$prototype: $prototype
			}, "$title")));
			if ($layout.$label) {
				headHtml.push('</div>');
			}
			headHtml.push('</th>');
		});
		var detailLink = noDetailLink !== true || nbAdvanced > 0;
		if (detailLink) {
			headHtml.push('<th  data-priority="' + priority + '" style="width:40px;padding: 0;"></th>');
			// Minimize the size of 'detail' icon
			//headHtml.push('<th data-priority="' + fields.length + '" class="link-detail" style="width:20px">' + '</th>');
		}
		headHtml.push('</tr></thead>');
		html.push('<div class="table" style="overflow: hidden; white-space: nowrap; width: 100%;">');
		html.push('<table data-role="table" data-mode="reflow" class="s-m-table ui-responsive');
		if (alternateStyle) {
			html.push(' table-stripe');
		}
		html.push('" ');
		if ($layout.$forceGrid === true) {
			// Prevent reflow mode - Force columns display
			html.push(' style="table-layout:fixed"');
		}
		html.push('>');
		html.push(headHtml.join(''));
		html.push('<tbody>');
	};
	_controls.types._table_row = function(html, $layout, $prototype, rowVal, controller, edit, index, noDetailLink, parentBind) {
		var fields = $layout ? $layout.$items : null;
		if (!fields) return;
		var prop = $prototype.$properties;
		var first = true;
		var props = rowVal.$properties;
		var nbAdvanced = 0,
			nbNotEmpty = 0;
		var htmlCells = [];
		fields.forEach(function(fieldArticle) {
			var field;
			if (fieldArticle && fieldArticle.$bind) {
				field = fieldArticle.$bind;
			} else {
				field = fieldArticle; // field's name
				fieldArticle = {};
			}
			var proto = prop[field];
			if (!proto) return;
			// We don't display More.. in edit mode because in edit we have the editdetail icon - see header	
			if (proto.$isHidden || proto.$isExcluded || (edit && proto.$type === "application/x-array")) return;
			if (fieldArticle.$isAdvanced === true) {
				nbAdvanced++;
				return;
			}
			// reference field - meta-data are given by rvalue field - ADEV_SITE meta-data for ADEV_SITE_REF (X3) 
			var rValue = proto.$rvalue ? proto.$rvalue : proto.$item ? proto.$item.$rvalue : null;
			var fieldMeta = props == null ? null : rValue == null ? props[field] : props[rValue];
			var fieldHidden = fieldMeta != null && fieldMeta.$isHidden === true;
			var fieldEmpty = false;
			var htmlVal = [];
			if (!fieldHidden) {
				var value = rowVal ? rowVal[field] : null;
				fieldEmpty = value == null;
				if (!fieldEmpty) {
					htmlVal.push('<div');
					// Styles come from field or from layout (global)
					var styles = {
						$theme: fieldArticle.$theme || $layout.$theme,
						$styles: fieldArticle.$styles || $layout.$styles
					};
					var css = ["s-m-style", "s-m-value"];
					$proto.auth.mobileExtentions(css, styles);
					htmlVal.push(' class="');
					htmlVal.push(css.join(' '));
					htmlVal.push('"');
					htmlVal.push('>');
					if (proto.$type === "application/x-reference") {
						//ok
						var refOpts = _controls.types.addReference(proto, [value, rowVal], controller, field, fieldArticle.$refDescription && fieldArticle.$refDescription.$withTitle);
						fieldEmpty = refOpts.value == null || refOpts.value.trim().length == 0;
						var before = false;
						var cssl = null;
						if (refOpts.title && fieldArticle.$isRrefDescrHidden !== true) {
							cssl = ["s-m-style", "s-m-linkdesc"];
							if (fieldArticle.$refDescription) {
								before = fieldArticle.$refDescription.$before === true;
								$proto.auth.mobileExtentions(cssl, fieldArticle.$refDescription);
							}
						}
						var rval = refOpts.value;
						refOpts.value = $helpers.htmlEncode(before ? refOpts.title : rval);
						var rttl = $helpers.htmlEncode(before ? rval : refOpts.title);
						delete refOpts.title;
						that._addLink(htmlVal, refOpts, controller);
						if (cssl && rttl) {
							htmlVal.push(' <span class="');
							htmlVal.push(cssl.join(' '));
							htmlVal.push('">');
							if (cssl.indexOf("stack") >= 0) {
								htmlVal.push(' ');
							}
							htmlVal.push(rttl);
							htmlVal.push('</span>');
						}
					} else if (proto.$type === "application/x-array") {
						if (!edit) {
							if (value.length) {
								var options = _controls.types._addArray(field, parentBind, index);
								fieldEmpty = !that._addLink(htmlVal, options, controller);
							} else {
								htmlVal.push(' ');
								fieldEmpty = true;
							}

						}
					} else {
						var v = ($proto.htmlValue(rowVal, $prototype, proto, {
							$type: proto.$type,
							$bind: field
						}) || "").trim();
						if (v.length == 0) {
							fieldEmpty = true;
						} else {
							htmlVal.push(v);
						}
					}
					htmlVal.push("</div>");
				}
				if (!fieldEmpty) {
					nbNotEmpty++;
				}
			}
			htmlCells.push('<');
			if (first) {
				htmlCells.push('th');
			} else {
				htmlCells.push('td');
			}
			if (fieldHidden) {
				// #3220 - We add this class to hide the label when the table switch to reflow mode 
				// http://api.jquerymobile.com/table-reflow/
				htmlCells.push(' class="hidden"');
			} else if (fieldEmpty) {
				// In reflow mode we don't' display empty field to save room
				htmlCells.push(' class="empty"');
			} else if ($layout.$label) {
				// For stack mode the title of column is added by JQM in the cell <b class="ui-table-cell-label">Title</b> and we can't modify it to add our styles
				// In order to apply the style for header in that case we add s-m-thead-style class and declare s-m-thead-style.medium > .ui-table-cell-label in css
				// -> Each style is applied on ui-table-cell-label by parent - USe of s-m-thead-style prevent to interract with value style s-m-style
				var css = ["s-m-thead-style"];
				$proto.auth.mobileExtentionsLbl(css, $layout);
				htmlCells.push(' class="' + css.join(' ') + '"');
			}
			htmlCells.push('>');
			htmlCells.push(htmlVal.join(''));
			if (first) {
				htmlCells.push('</th>');
				first = false;
			} else {
				htmlCells.push('</td>');
			}
		});
		if (edit || noDetailLink !== true || nbAdvanced > 0) {
			htmlCells.push('<td');
			if (edit) {
				htmlCells.push('>');
				htmlCells.push('<a href="#" data-role="button"  data-index="' + index + '" data-action="edit" data-iconpos="notext" data-theme="f" data-inline="true"  data-mini="true" data-icon="s-edit">');
				htmlCells.push($helpers.locale().ui.edit_item);
			} else {
				// Minimize the size of 'detail' icon
				htmlCells.push(' class="link-detail" style="padding-left:5px">');
				htmlCells.push('<a href="#" data-role="button"  data-index="' + index + '" data-action="detail" data-theme="f" data-inline="true"  data-mini="true" data-icon="false">');
				htmlCells.push("...");
			}
			htmlCells.push('</a></td>');
		}
		html.push('<tr  class="');
		if (rowVal.$nbFieldErrors > 0) {
			html.push('fieldError ');
		}
		if (nbNotEmpty == 0) {
			// Set empty on empty row -display:none - we coudl also skip these lines
			html.push('empty ');
		}
		html.push('">');
		html.push(htmlCells.join(''));
		html.push('</tr>');
		if (rowVal && rowVal.$nbFieldErrors > 0) {
			html.push('<tr><td colspan="' + (fields.length + 1) + '" class="fieldError"><div class="s-m-flderr">See detail</div></td></tr>');
		}
	};
	_controls.types._table_end = function(html, edit) {

		html.push('</tbody>');
		html.push('</table></div>');
	};
	_controls.ArrayField = {
		syncc: true,
		_cards: function(controller, id, options, html) {
			var ui = that.detailUiData(controller, options.cacheData.$proto, options.cacheData.data[options.$index], options.cacheData.layout, {
				inlinePrefix: options.$bind + "_",
				readOnly: true
			});
			var dhtml = {
				root: {
					before: "",
					after: "",
					childs: []
				}
			};
			var detailpagedata = {
				$prototype: ui.uiData.$prototype,
				$article: options.cacheData.layout
			};
			that.renderPageHTML(controller, ui.uiData.content, dhtml, {
				pageData: detailpagedata,
				prefix: options.$bind,
				data: options.cacheData.data[options.$index]
			});
			var dcontent = [];
			that.struct2html(dhtml.root, dcontent);
			html.push(dcontent.join(''));
		},
		handler: function(c, after) {
			var controller = this;
			var html = [];
			var options = c.data || {};
			var getTitle = function(fld, page, hidden) {
				return fld == null || hidden === true ? "" : $proto.execExpression(fld.$shortTitle || fld.$title, page.$prototype);
			};
			var field = options.field;
			delete options.field;
			var page = controller.getPageData();
			if (!page) return after({
				html: "",
				options: {}
			});
			var edit = (options.facet === "$edit") || (options.facet === "$create");
			var cpt = field.$proto.$rtype; //see $helpers.linkParents
			var protoProp = field.$proto.$protoparent;
			var fieldData = controller.getValue(field.$bind, null, cpt === ("application/x-reference") ? null : []);
			var cp = field.$proto.$item || field.$proto;
			var $article = options.$article || {};
			var isTitleHidden = $article && $article.$isTitleHidden;
			if (!isTitleHidden && protoProp.$isTitleHidden) isTitleHidden = true;
			if (edit) {
				var scc = {
					id: c.id + "_" + field.$bind,
					data: {
						inline: false,
						bind: field.$bind
					}
				};
				var opts = scc.data,
					cc;
				switch (cpt) {
					case "application/x-reference":
						opts.type = "text";
						opts.label = getTitle(protoProp, page, isTitleHidden);
						scc.id = c.id + "_" + field.$bind;
						if (cp.$links && cp.$links.$lookup && cp.$links.$lookup.$url) {
							opts.$lookupurlparsed = true;
							opts.$lookupurl = cp.$links.$lookup.$url;
							opts.$lookupurl = $proto.parseExpression(cp.$links.$lookup.$url, {
								data: controller.exprData(fieldData),
								$prototype: cp
							}, "$url");
						}
						if (cp.$isMandatory) opts.$isMandatory = true;
						cc = that.controls.Lookup.createLookup(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Lookup";
						cc.scid = "_" + field.$bind;
						break;
					case "application/x-array":
						switch (field.$proto.$type) {
							case "application/x-reference":
								opts.title = getTitle(protoProp, page, isTitleHidden);
								opts.jmdata = $proto.jqmDataArray();
								scc.id = c.id + "_" + field.$bind;
								//protoProp = field.$proto.$item || field.$proto;
								if (cp.$links && cp.$links.$lookup && cp.$links.$lookup.$url) {
									opts.$lookupurl = cp.$links.$lookup.$url;
								}
								cc = that.controls.ArrayRef.createArrayRef(controller, scc, fieldData);
								cc.id = scc.id;
								cc.uiClass = "ArrayRef";
								cc.scid = "_" + field.$bind;
								break;
							case "application/x-object":
							case "application/json":
								// for old compatibility
								opts.title = getTitle(field, page, isTitleHidden);
								opts.jmdata = $proto.jqmDataArray();
								var clayout, glayout = {};
								clayout = $proto.auth.compositionLayout($article, (field.$proto.$item || field.$proto), null, glayout);
								opts.$article = clayout;
								opts.$gridLayout = $.isEmptyObject(glayout) ? null : glayout;
								scc.id = c.id + "_" + field.$bind;
								cc = that.controls.ArrayObjectRef.createArrayObjectRef(controller, scc, fieldData);
								cc.id = scc.id;
								cc.uiClass = "ArrayObjectRef";
								cc.scid = "_" + field.$bind;
								break;
							default:
								opts.title = getTitle(field, page, isTitleHidden);
								opts.jmdata = $proto.jqmDataArray();
								scc.id = c.id + "_" + field.$bind;
								cc = that.controls.ArraySimpleType.createArraySimpleType(controller, scc, fieldData);
								cc.id = scc.id;
								cc.uiClass = "ArraySimpleType";
								cc.scid = "_" + field.$bind;
								break;
						}
						break;

				}
				if (cc) return after([cc]);
				else return after(null);

			} else {
				if (field) options.$bind = field.$bind;
				var layout = null;
				if ((cpt === "application/x-array") && ((field.$proto.$type === "application/x-object") || (field.$proto.$type === "application/json"))) {
					// Array of objects - Deatils facet 
					layout = $proto.auth.compositionLayout($article, (field.$proto.$item || field.$proto), null);
					options.div = true;

				}
				//options.div = false;
				options.$index = 0;
				options.$len = 0;
				if (options.div) {
					html.push('<div id="' + c.id + '" class="s-m-list">');
				} else {
					html.push('<ul id="' + c.id + '" data-role="listview" class="s-m-list"');
					$helpers.addJqmData(options, html);
					html.push('>');
				}
				var ct = "",
					toptions;
				switch (cpt) {
					case "application/x-reference":
						ct = getTitle(protoProp, page, isTitleHidden);
						if (ct) html.push('<li class = "s-m-arrayfld-ttl" data-role="list-divider">' + ct + '</li>');
						// lookup 
						toptions = _controls.types.addReference(field.$proto, fieldData, controller, field.$bind);
						html.push('<li>');
						that._addLink(html, toptions, controller);
						html.push('</li>');
						break;
					case "application/x-array":
						ct = getTitle(field, page, isTitleHidden);
						if (ct) {
							if (options.div) {
								html.push('<ul data-role="listview" data-role="listview" class="s-m-list nobottom s-m-arrayfld-ttl"');
								$helpers.addJqmData(options, html);
								html.push('>');
							}
							html.push('<li  class = "s-m-arrayfld-ttl" data-role="list-divider">' + ct + '</li>');
							if (options.div) html.push('</ul>');
						}
						if (fieldData) {
							options.$len = fieldData.length;
							// x-array
							switch (field.$proto.$type) {
								case "application/x-reference":
									if (fieldData.length) fieldData.forEach(function(value) {
										toptions = _controls.types.addReference(field.$proto.$item || field.$proto, value, controller);
										html.push('<li>');
										that._addLink(html, toptions, controller);
										html.push('</li>');
									});
									break;
								case "application/x-object":
								case "application/json":
									// array composition 
									if ((layout.$layout && !layout.$format) || (layout.$format === "grid")) {
										_controls.types._table_header(html, layout.$layout, field.$proto, layout.$cards ? false : true, false);
										fieldData.forEach(function(value, index) {
											_controls.types._table_row(html, layout.$layout, field.$proto, value, controller, false, index, layout.$cards ? false : true, field.$bind);
										});
										_controls.types._table_end(html);

									} else {
										if (layout.$format === "cards") {
											if (fieldData && fieldData.length) {
												options.$cards = true;
												options.cacheData = {
													$proto: field.$proto,
													data: fieldData,
													layout: (layout.$cards && layout.$cards.$layout) ? layout.$cards.$layout : layout.$layout
												};
												html.push('<div id="' + c.id + 'cards">');
												_controls.ArrayField._cards(controller, c.id, options, html);
												html.push('</div>');
												that.controls.navFooter(false, ((options.$index + 1) < options.cacheData.data.length), (options.$index > 0), c.id + '_nav', true, {
													"jmdata": {
														"data-role": "footer"
													}
												}, html);

											}
										}
									}
									break;
								case "application/x-choice":
									var map = {};
									cp.$value.$enum.forEach(function(value) {
										map[value.$value + ""] = $proto.execExpression(value.$title, page.$prototype);
									});
									fieldData.forEach(function(value) {
										html.push('<li>' + $helpers.htmlEncode(map[value + ""]) + '</li>');
									});

									break;

								default:
									fieldData.forEach(function(value) {
										html.push('<li>' + value || "" + '</li>');
									});
									break;
							}
						}
						break;
				}
				if (options.div)
					html.push('</div>');
				else
					html.push('</ul>');
				return after({
					html: html.join(''),
					bind: !edit,
					options: options
				});

			}

		},
		refresh: function(controller, options, $c, id) {
			// Refresh table - Adjust reflow mode
			_controls.types._table_refresh($c, true);
		},
		onWindowResize: function(controller, $c, c) {
			// Force ui-responsive est recreate the table to calculate the best display
			_controls.types._table_refresh($c, true);
		},
		events: function($c, c) {
			var controller = this;
			var edit = (c.options.facet === "$edit") || (c.options.facet === "$create");
			if (!edit) {
				if (c.options.$cards) {
					$c.on("swipeleft", function(event) {
						if ((c.options.$index + 1) < c.options.$len) {
							c.options.$index++;
							var html = [];
							_controls.ArrayField._cards(controller, c.id, c.options, html);
							var $ci = $('#' + c.id + "cards");
							$ci.html(html.join(''));
							$ci.trigger('create');
							controller.setHtmlEvents();
							that.controls.navFooter(false, ((c.options.$index + 1) < c.options.cacheData.data.length), (c.options.$index > 0), c.id + '_nav', false);


						}
						event.stopPropagation();
					});
					$c.on("swiperight", function(event) {
						if (c.options.$index > 0) {
							c.options.$index--;
							var html = [];
							_controls.ArrayField._cards(controller, c.id, c.options, html);
							var $ci = $('#' + c.id + "cards");
							$ci.html(html.join(''));
							$ci.trigger('create');
							controller.setHtmlEvents();
							that.controls.navFooter(false, ((c.options.$index + 1) < c.options.cacheData.data.length), (c.options.$index > 0), c.id + '_nav', false);

						}
						event.stopPropagation();
					});


				} else {
					$c.click(function(e) {
						var target = $helpers.getTarget(e);
						if (!target) return;
						var p = $(target).attr("data-action"),
							page, cp, cd, pp, $layout, ui, nd;
						if (p) {
							if (p === "detail") {
								p = parseInt($(target).attr("data-index"), 10);
								page = controller.getPageData();
								cp = $proto.getProto(page, c.options.$bind);
								cd = controller.getValue(c.options.$bind, null, []);
								if (cd && Array.isArray(cd) && (p >= 0)) {
									cd = cd[p];
									//TODO
									$layout = $proto.auth.findSlayout(c.options.$article, c.options.$bind, false, true);
									pp = cp;
									nd = cd;
									if (!$layout) $layout = $proto.auth.compositionLayout(null, pp, null);
									ui = that.detailUiData(controller, pp, nd, $layout, {
										readOnly: true
									});
									that.createDetail(ui.uiData, nd, controller);

								}
							} else {
								// Click on More link to see the detail of the row
								try {
									p = JSON.parse(p);
									page = controller.getPageData();
									cd = controller.getValue(p.$parentbind, null, []);
									if (cd) {
										cp = $proto.getProto(page, p.$parentbind);
										if (cd && Array.isArray(cd) && (p.$index >= 0)) {
											cd = cd[p.$index];
											if (cd) {
												nd = cd;
												nd[p.$bind] = cd[p.$bind];
												if (cd && cd[p.$bind]) {
													//cp = cp.$properties[p.$bind].$item;
													pp = cp;
													var $layout = $proto.auth.findSlayout(c.options.$article, p.$bind, true);
													$layout = $proto.auth.compositionLayout($layout, pp, [p.$bind]);
													ui = that.detailUiData(controller, pp, nd, $layout, {
														readOnly: true
													});
													that.createDetail(ui.uiData, nd, controller);
												}
											}
										}
									}
								} catch (ex) {}

							}
						}
					});
				}
			}
			// Refresh table - Adjust reflow mode
			_controls.types._table_refresh($c, false);
		}
	};
})(jQuery);