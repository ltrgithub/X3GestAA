"use strict";
(function($) {
	var that = $.helpers || {};
	$.helpers = that;
	that.language = function() {
		var value = that.settings("language");
		if (value && value.lang) return value.lang;
		return "";
	};
	that.setLanguage = function(lang) {
		that.settings("language", {
			lang: lang
		});
	};
	that.settings = function(key, value) {
		key = key || "mobile";
		var ssettings = $.sdata.localStorage.getItem("settings");
		try {
			ssettings = JSON.parse(ssettings || "{}");
		} catch (ex) {
			ssettings = {};
		}
		if (value) {
			ssettings[key] = value;
			$.sdata.localStorage.setItem("settings", JSON.stringify(ssettings));
		} else {
			ssettings = ssettings[key] || {};
			if ((key === "mobile") && !ssettings.preferences) {
				ssettings.preferences = {
					linkDescTheme: "A"
				};
			}
			return ssettings;
		}
	};
	that.extractLang = function(value) {
		if (value) {
			var values = value.split("-");
			return values[0];
		}
		return value;
	};
	that.browserLanguage = function() {
		return (window.navigator.language || window.navigator.browserLanguage || "en");
	};
	// Merge downloaded language file into local default texts
	that.translate = function(lang, value) {
		that.locale(); // to be sure that default translations are initialized in that._locale_flat_data
		if (value) {
			Object.keys(value).forEach(function(prop) {
				that._locale_flat_data[prop] = value[prop];
			});
			that._locale = that.translationStringPairsToObj(that._locale_flat_data);
			that._locale_lang = lang;
			var $scroller = $.scroller;
			if ($scroller) {
				$scroller.setDefaults(that.dateSettings);
			}
		}
	};
	/*
	 * convert
	 * {
	 *     "ui.label1": "text 1",
	 *     "ui.label2": "text 2",
	 *     "ui.arr.0": "text 1",
	 *     "ui.arr.1": "text 2"
	 * }
	 * to
	 * {
	 *     "ui": {
	 *         "label1": "text 1",
	 *         "label2": "text 2",
	 *         "ui.arr": ["text 1", "text 2"]
	 *     }
	 * }
	 *
	 */
	that.translationStringPairsToObj = function(objPairs) {
		var val;
		var levels;
		var obj;
		var objRoot = {};
		var cnt;
		var lastLevel;
		var isArray;
		Object.keys(objPairs).forEach(function(key) {
			val = objPairs[key];
			levels = key.split(".");
			obj = objRoot;

			cnt = 0;
			lastLevel = levels[levels.length - 1];
			isArray = !isNaN(lastLevel);
			// find or create sub objects
			levels.slice(0, levels.length - 1).forEach(function(level) {
				cnt = cnt + 1;
				if (obj[level] == null) {
					if (cnt === levels.length - 1 && isArray) { // Last level is an array
						obj[level] = [];
					} else {
						obj[level] = {};
					}
				}
				obj = obj[level];
			});
			if (isArray) {
				obj.push(val);
			} else {
				//$.helpers.logOnServer(lastLevel + ":" + val);
				obj[lastLevel] = val;
			}
		});
		return objRoot;
	};
	that.currentLocale = function() {
		that.locale();
		return that._locale_lang;

	};
	that.buildDate = function() {
		var cd =
		// do not delete #BUILDDATE_XXXX  is used in translate.js
		//#BUILDDATE_START
		Date.parseISO8601("2014-06-03T11:27:27.788Z");
		//#BUILDDATE_END
		return cd;
	};
	that.buildDateString = function() {
		var cd =
		// do not delete #BUILDDATE_XXXX  is used in translate.js
		//#BUILDDATE_STRING_START
		"2014-06-03T11:27:27.788Z";
		//#BUILDDATE_STRING_END
		return cd;
	};
	that.locale = function() {
		if (that._locale) return that._locale;
		that._locale_lang = "en";
		that._locale_flat_data =
		// do not delete next line  is used in translate.js
		// MAIN TRANSLATION FILE IS strings-en.json
		// This file will be copied to this code by the build process!!!
		// Do not modify anything between #START and #END
		// New texts must be added in strings-en.json
		//#START
		{
			"actions.syncronize": "Synchronize your application data.",
			"administration.title": "Sage ERP X3",
			"administration.welcome": "Welcome",
			"applicationmanager.available_apps": "Available applications",
			"applicationmanager.description": "Add Remove Applications",
			"applicationmanager.install": "Add",
			"applicationmanager.installed_apps": "Installed applications",
			"applicationmanager.title": "Add applications",
			"applicationmanager.uninstall": "Remove",
			"cancel": "Cancel",
			"confirmact": "Please confirm action {0}",
			"datetime.abbreviatedDayNames.0": "Sun",
			"datetime.abbreviatedDayNames.1": "Mon",
			"datetime.abbreviatedDayNames.2": "Tue",
			"datetime.abbreviatedDayNames.3": "Wed",
			"datetime.abbreviatedDayNames.4": "Thu",
			"datetime.abbreviatedDayNames.5": "Fri",
			"datetime.abbreviatedDayNames.6": "Sat",
			"datetime.abbreviatedMonthNames.0": "Jan",
			"datetime.abbreviatedMonthNames.1": "Feb",
			"datetime.abbreviatedMonthNames.10": "Nov",
			"datetime.abbreviatedMonthNames.11": "Dec",
			"datetime.abbreviatedMonthNames.2": "Mar",
			"datetime.abbreviatedMonthNames.3": "Apr",
			"datetime.abbreviatedMonthNames.4": "May",
			"datetime.abbreviatedMonthNames.5": "Jun",
			"datetime.abbreviatedMonthNames.6": "Jul",
			"datetime.abbreviatedMonthNames.7": "Aug",
			"datetime.abbreviatedMonthNames.8": "Sep",
			"datetime.abbreviatedMonthNames.9": "Oct",
			"datetime.amDesignator": "AM",
			"datetime.dateElementOrder": "mdy",
			"datetime.day": "Day",
			"datetime.dayNames.0": "Sunday",
			"datetime.dayNames.1": "Monday",
			"datetime.dayNames.2": "Tuesday",
			"datetime.dayNames.3": "Wednesday",
			"datetime.dayNames.4": "Thursday",
			"datetime.dayNames.5": "Friday",
			"datetime.dayNames.6": "Saturday",
			"datetime.hour": "Hour",
			"datetime.minutes": "Minutes",
			"datetime.month": "Month",
			"datetime.monthNames.0": "January",
			"datetime.monthNames.1": "February",
			"datetime.monthNames.10": "November",
			"datetime.monthNames.11": "December",
			"datetime.monthNames.2": "March",
			"datetime.monthNames.3": "April",
			"datetime.monthNames.4": "May",
			"datetime.monthNames.5": "June",
			"datetime.monthNames.6": "July",
			"datetime.monthNames.7": "August",
			"datetime.monthNames.8": "September",
			"datetime.monthNames.9": "October",
			"datetime.pmDesignator": "PM",
			"datetime.sec": "Seconds",
			"datetime.year": "Year",
			"dlog1": "Save as a draft?",
			"dlog2": "Keep data localy to retrieve them later",
			"draftmode": "Draft",
			"errmailsubject": "Sage X3 Mobile client error",
			"errorauth": "Authentication error\nPlease relogin or contact the administrator to check your configuration",
			"errorauth_title": "Authentication error!",
			"errorjs": "Javascript error\nPlease contact the administrator",
			"errorpagetitle": "Errors",
			"filters.between": "Between",
			"filters.eq": "Equal",
			"filters.ge": "Greater than or equal",
			"filters.gt": "Greater than",
			"filters.le": "Less than or equal",
			"filters.like": "Contains",
			"filters.like_s": "Starts with",
			"filters.lt": "Less than",
			"filters.ne": "Not equal",
			"filters.none": "All",
			"logoutmsg": "You have been disconnected from application",
			"maintoolbar.apps": "Applications",
			"maintoolbar.back": "Back",
			"maintoolbar.help": "About",
			"maintoolbar.home": "Home",
			"maintoolbar.language": "Change Language",
			"maintoolbar.logout": "Logout",
			"maintoolbar.next": "Next",
			"maintoolbar.previous": "Prev",
			"maintoolbar.settings": "Settings",
			"maintoolbar.setup": "Setup",
			"no": "No",
			"nomessage": "No message returned by server",
			"sdata.S404": "\"[{0}\" - Resource not found.",
			"sdata.S410": "Record deleted",
			"sdata.S412": "Update canceled",
			"sdata.S503": "Retry after ...",
			"sdata.SC_canceled": "create canceled",
			"sdata.SD412": "Delete canceled",
			"sdata.SD_canceled": "delete canceled",
			"sdata.SU500": "Update canceled",
			"sdata.invalid_response": "Invalid server response ($httpstatus)",
			"sdata.modify_before": "Modify the request before resubmitting",
			"sdata.post_ni": "Asynchronous POST - not implemented.",
			"sdata.unexpected_status": "Unexpected http status {0}",
			"sendpagetitle": "My Drafts",
			"ui.Actions": "Actions",
			"ui.actions_item": "More...",
			"ui.add_item": "Add ...",
			"ui.app_exception": "Application Exception",
			"ui.app_fatal": "Fatal error",
			"ui.app_success": "Success",
			"ui.app_warning": "Warning",
			"ui.array_detail": "More",
			"ui.array_nodetail": "Less",
			"ui.auth_type": "Authentication Type",
			"ui.buildDate": "Build date: ",
			"ui.cancel_create": "Undo Create",
			"ui.cancel_delete": "Undo Delete",
			"ui.cancel_item": "Cancel",
			"ui.cancel_sort": "Cancel sort",
			"ui.cancel_update": "Undo Changes",
			"ui.check_net": "Check your internet connection",
			"ui.connect": "Connect",
			"ui.db_exception": "Database Exception",
			"ui.delete_all_drafts": "Delete all",
			"ui.delete_draft": "Delete draft",
			"ui.dev_mode": "Development mode",
			"ui.edit_draft": "Edit draft",
			"ui.edit_item": "Edit",
			"ui.exception_offline": "The server is not responding or cannot be reached.\nFor help, contact your network administrator.",
			"ui.exception_timeout": "Connection timeout",
			"ui.filter": "Filter",
			"ui.filter_field": "Field",
			"ui.filter_op": "Operator",
			"ui.filter_val": "Value",
			"ui.filtersort": "Advanced",
			"ui.fpwIllegal": "Password contains illegal character: {0}",
			"ui.fpwReplFieldNotFound": "Field {0} not found for salting",
			"ui.incorrect_format": "Incorrect format",
			"ui.input_required": "Value is required",
			"ui.install_item": "Reinstall ...",
			"ui.installing": "Installing ...",
			"ui.invalid_number": "Invalid number \"{0}\"",
			"ui.links": "Links",
			"ui.loading": "Loading ...",
			"ui.locale": "Locale",
			"ui.login": "Sign In",
			"ui.mail": "Email",
			"ui.mandatory_field": "\"{0}\" is required.",
			"ui.messages": "Message(s)",
			"ui.minlength_field": "Please enter at least {0} characters.",
			"ui.misc": "Miscellaneous",
			"ui.msg_detail": "Detail",
			"ui.multilines": "Select line(s)",
			"ui.multinacts": "Actions",
			"ui.multinbsel": "{0} selected",
			"ui.multiselprocess": "Processing lines {0}/{1}",
			"ui.multiswitch": "Toggle multilines selection",
			"ui.nextDiagnose": "Next",
			"ui.no_db_support": "Your browser don't support HTML5 database. Please upgrade your browser to the most recent version.",
			"ui.no_db_support_sol": "Your browser don't support HTML5 database. Please upgrade your browser to the most recent version.",
			"ui.no_db_support_priv": "Your browser seems to not support any kind of HTML5 database. This error message also occurs of you use the browser in private browsing mode which is not supported.",
			"ui.no_fav_online": "No favorites picked in online mode",
			"ui.nodrafts": "No drafts to send/edit",
			"ui.notitle": "No title",
			"ui.number_precision_error": "Maximum number of decimals is {0}",
			"ui.offline": "Off-line mode",
			"ui.ok_item": "Ok",
			"ui.open_db_error": "Can't open/create local database",
			"ui.password": "Password",
			"ui.password_mismatch": "\"{0}\" password does not match.",
			"ui.picture_file": "Choose a file",
			"ui.picture_remove": "Remove picture",
			"ui.picture_nocamera": "No camera found.",
			"ui.picture_photo": "Take a photo",
			"ui.range_overflow_number": "Value should be >= {0} and <= {1}",
			"ui.remember": "Remember me",
			"ui.remove_item": "Remove",
			"ui.rmvdrafts": "Edit or remove your drafts before install.",
			"ui.rmvdrafts_lang": "Remove your drafts before changing language settings.",
			"ui.root_menu_tip": "Applications List",
			"ui.save_item": "Save",
			"ui.saved_logon": "Fixed login",
			"ui.saved_logon_txt": "This login will be used each time you log on",
			"ui.sdatahost": "Host name",
			"ui.search": "Search",
			"ui.selall": "Select all",
			"ui.selinv": "Invert selection",
			"ui.selendpoint": "Select at least one endpoint",
			"ui.send_all_drafts": "Send all",
			"ui.sending": "Sending ...",
			"ui.server": "Host name",
			"ui.services": "Services",
			"ui.sort": "Sort",
			"ui.sort_order": "Sort order",
			"ui.sync_cancel_all": "Undo All changes",
			"ui.sync_item": "Sync.",
			"ui.sync_resync_data": "Download",
			"ui.sync_send_all": "Send Changes",
			"ui.sync_sync_data": "Resynchronize local database",
			"ui.tobig_number": "Value greater than {0} is expected",
			"ui.unknownError": "Unknown error",
			"ui.unselall": "Unselect all",
			"ui.user": "User Name",
			"ui.validate_item": "Validate",
			"ui.validate_reset": "Reset",
			"ui.templateMngmtHeader": "Template Management",
			"ui.templateMngmt": "Templates",
			"ui.templateName": "Name",
			"ui.newTemplate": "Create new template",
			"ui.avTemplate": "Available templates",
			"ui.valueNewTemplate": "New template",
			"ui.templateDate": "Date:",
			"templateSaved": "Template '{0}' has been created.",
			"templateUpdated": "Template '{0}' has been updated.",
			"templateDeleted": "Template deleted.",
			"templateSelected": "Template '{0}' selected.",
			"templateReadError": "Template '{0}' could not be found.",
			"applyTemplate": "Apply",
			"unmodified": "Record unmodified",
			"resetinput": "This record has been reset. Your input has been lost",
			"yes": "Yes",
			"emptydraftkey": "Cannot save draft. Key is empty.",
			"saveasdraft": "Your record has been saved as a draft",
			"changelangonline": "Language can be changed in online mode only",
			"change_language_warning": "<b>Attention:</b><br>Changing the language will reinstall all applications and you will be disconnected from the application",
			"langchangedmsg": "Your language setting has been changed and you have been disconnected from the application.",
			"langchangehome": "Return to home page",
			"langnotchanged": "Your language setting has not been changed.",
			"success": "Succeedeed",
			"error": "Error(s)",
			"noofflineios": "Offline mode is disabled on IOS",
			"newVersion": "There is a newer version '{0}' available than the one that is currently in use: '{1}'\n\nPlease touch OK to upgrade your client.",
			"license.registrationNumber": "Company registration number:",
			"license.licensedTo": "License granted to:",
			"license.reference": "Sage Customer number:",
			"license.userLicense": "User License:",
			"license.installedBy": "Installed by:",
			"license.server": "Server:",
			"license.expiryDate": "Expiration date:",
			"license.expiryDateValue": "From {0} to {1}",
			"about.text": "<h3>Sage ERP X3 version 7.1</h3>",
			"about.license": "License",
			"about.legal": "Legal notice",
			"about.legaltext": "&copy; SAGE SAS au capital 6.750.000 euros -<br>RCS Paris 313 966 129 -<br>10, rue Fructidor 75017 PARIS\"<br>&copy; SAGE, a Société par Actions Simplifiée <br>(simplified joint stock company) incorporated under French law, With a shared capital of 6.750&nbsp;000&nbsp;€, having its registered office located at 10, rue Fructidor, 75017 Paris, -<br>Registered with the Trade and Companies Registry of Paris under number 313 966 129.",
			"about.clientVersion": "Build version: ",
			"about.serverVersion": "Update to {0}"
		};
		//#END	// do not delete this line  is used in translate.js
		that._locale = that.translationStringPairsToObj(that._locale_flat_data);
		return that._locale;

	};
})(jQuery);