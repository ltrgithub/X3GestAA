"use strict";
$(function() {
	var _errCatched = false;
	var cache = window.applicationCache;
	var that = $.smobile;

	that.docEvents = {
		"swipeleft": function(event) {
			var page = $.mobile.activePage;
			if (page) {
				var controller = that.pageController(page);
				if (controller) controller.actionnext({});
			}
		},
		"swiperight": function(event) {
			var page = $.mobile.activePage;
			if (page) {
				var controller = that.pageController(page);
				if (controller) controller.actionprevious({});
			}
		},
		"pagebeforechange": function(e, data) {
			var $helpers = $.helpers,
				hasErrors = false; //$helpers.hasErrors(); //false; ?????????????????
			var $sdata = $.sdata;
			var fromPage = data.options.fromPage && data.options.fromPage[0] || null;
			if (!window.location.hash) {
				e.preventDefault();
				return;
			}
			var force = false,
				newPage;
			// typeof data.toPage === "string"
			//  -> Hash= pageId
			//     http://host:8124/syracuse-mobile/html/mobile-debug.html#start	
			//	   pageIds $/mobile.PAGES -> start, errors, apperrors, home, about, settings, send, page, dialog, apps 
			//  -> Hash= page stored in DOM
			//     http://host:8124/syracuse-mobile/html/mobile-debug.html#page-a7e314e4-fc88-42bf-9bf4-ad176670d82b%3Furl%3Dhttp%253A%252F%252Fpc101329.sagefr.adinternal.com%253A8124%252Fsdata%252Fx3%252Ferp%252FSUPERV%252FAUTILIS(%252704040%2527)%253Frepresentation%253DAUTILISM.%2524details
			//  -> Action call
			//     http://host:8124/syracuse-mobile/html/mobile-debug.html#F16_filterpopupMenu			
			if (typeof data.toPage === "string") {
				// Page identified by a hash
				force = true;
				$.mobile.$start = false;
				$.mobile.hashListeningEnabled = true;
				newPage = data.toPage;
			} else if ($.mobile.$start) {
				// $start=true page has just been loaded (called once after by F5 or window.location.reload();
				force = true;
				$.mobile.$start = false;
				$.mobile.hashListeningEnabled = true;
				newPage = window.location.href;
				data = null;
			} // Else toPage contains be a DOM element

			if (!force) {
				// Page is in the DOM
				// Pages addressed by url are created in the DOM by the code below which create DOM elment and calls changePage
				if (data && data.toPage.length && (data.toPage[0].id == "page-template")) {
					//Bug jquery Mobile 1.2 back && forward with "page-template" - FDB can't repeat this case
					data = null;
					newPage = window.location.href;
					force = true;
				}
			}
			// We only want to handle changePage() calls where the caller is asking us to load a page by URL
			if (force) {
				// For authoring mode
				$.proto.auth.notifyParent("pagechange", null, {
					name: ""
				});
				// We are being asked to load a page by URL, but we only want to handle URLs that request the data for a specific category.
				var u = $.mobile.path.parseUrl(newPage),
					dataUrl;
				//hashFormat:   [#]pagename[-appid[-pageId]][encodeURIComponent(?query)]
				var page = $.smobile.pageName(u.hash);
				if (!page) {
					// An action that applied on current page has been called - Ex: Add a filter
					var action = $.smobile.actionName(u.hash);
					if (action) {
						// Process only known actions - see $.mobile.ACTIONS
						e.preventDefault();
						$.smobile.execAction(u.hash, action, function(refresh) {
							if (refresh) $.smobile.refreshPage();
						});
					} // Else Ex : Add a filter not processed here
				} else {
					// A page has been called
					if (page && page.page && page.page.isHome) {
						$.mobile.urlHistory.clearForward();
					}
					var activePage = $.mobile.activePage;
					var $foundPage = page.domid ? $("#" + page.domid) : false;
					if ($foundPage && $foundPage.length) {
						// Page found in DOM
						var controller = that.pageController($foundPage);
						var cpp = {
							transition: "none"
						};
						if ($sdata.config && page.application && (page.application != $sdata.config.id)) $sdata.config = null;
						if (!$sdata.config && !controller.parent) {
							// Appli ID as changed - FBD can't repeat
							e.preventDefault();
							$.mobile.changePage($foundPage, cpp);
							$.smobile.removeAllPages([$foundPage[0].id], true);
							return;
						} else {
							e.preventDefault();
							if (controller) {
								controller.notifyAuthoring('pageload');
								if (controller.needRefresh) {
									controller.needRefresh = false;
									if (controller.child) controller.doRefresh();
								}
								cpp.fromHashChange = true;
								if (controller.child) {
									cpp.reverse = true;
								}
								//  Issue #2592 Close panels if any to trigger onclosepanel event
								var panel = $('#' + controller.prefix + 'rpanel');
								if (panel) panel.panel("close");
								var panel = $('#' + controller.prefix + 'panel');
								if (panel) panel.panel("close");
							}
							//  Issue #2592 Close panels if any to trigger onbeforeclose panel event
							var panel = $('#' + controller.prefix + 'rpanel');
							if (panel) panel.panel("close");
							var panel = $('#' + controller.prefix + 'panel');
							if (panel) panel.panel("close");
							// Restore active buttons - #2579
							controller.activeBtnsRestore();
							// Call jqm changePage with DOM element
							$.mobile.changePage($foundPage, cpp);
							if (page.page.isHome) $.smobile.removeAllPages([$foundPage[0].id], true);
						}
						return;
					}
					// Page NOT found in DOM --> load page 
					var options = data ? data.options : {};
					options.allowSamePageTransition = true;
					options.showLoadMsg = true;
					$.mobile.loading('show', {
						theme: "a",
						text: $helpers.locale().ui.loading
					});
					e.preventDefault();
					// Read config (installed representation) and build page ui structure
					// afterdata -> handler called after read data (set contextual items in header)
					$.smobile.loadPage(u.hash, page, function(uiId, ui, error, afterdata) {
						//ui describe the Tree structure of the pages - Layouts and Controls 
						//uid : ex TABCOUNTRYM.$details
						if (!ui) {
							// unexpected case - No user interface - FDB should dispaly an error
							$.mobile.loading('hide');
							return $.smobile.doBack(null);
							if ((page.page.id != $.smobile.PAGES.errors.id)) {
								if ($helpers.hasErrors()) {
									$.smobile.showErrors(that.pageController(fromPage));
								} else { //TODO: Ã  enlever 
									if (error && (typeof error === "object") && error.action) {
										$.smobile.silentAction(error);
									} else {
										$.smobile.showError(options, error || "");
									}
								}
							}
							return;
						}
						$sdata.startLoad();
						if (hasErrors)
							$helpers.clearErrors();
						// Read Data -> resData
						$.smobile.parseURL(u, page, function(href, resData, error, info) {
							if (info && info.stop) {
								$.mobile.loading('hide');
								$sdata.endLoad();
								/*if ($helpers.hasErrors()) {
									$.smobile.showErrors(that.pageController(fromPage));
									data.toPage = null;
								}*/
								return;
							}
							if (error) {
								$sdata.endLoad();
								$.mobile.loading('hide');
								if ((page.page.id != $.smobile.PAGES.errors.id)) {
									if ($helpers.hasErrors()) {
										$.smobile.showErrors(that.pageController(fromPage));
									} else {
										if (resData) $.smobile.showError(options, resData || '');
										if (href) window.location.href = href;
									}
									return;
								}
							}
							// Set contextual items
							if (afterdata) afterdata(resData);
							options.dataUrl = href;
							// Create DOM jqm page from a template by clone (Header/Content/Footer)
							var cp = $.smobile.createPage(page);
							var $ptemplate = cp.$template,
								$page = cp.$page;
							// Build DOM page according to ui content and data
							// --> Page : <div id='pageid'> rightpanel, leftpanels, Header, content (layouts and controls)</div>
							$.smobile.buildPage(uiId, activePage, $page, ui, resData, info, page, $ptemplate, function() {
								var controller = that.pageController($page);
								var panel = cp.$page.children('#panel-template');
								panel.attr("id", controller.prefix + "panel");
								panel = cp.$page.children('#right-panel-template');
								panel.attr("id", controller.prefix + "rpanel");
								if ($helpers.hasErrors()) {
									$sdata.endLoad();
									controller.remove();
									$page.remove();
									return $.smobile.showErrors(that.pageController(fromPage));

								}
								if (ui.actions) {
									controller.pageActions = ui.actions;
									ui.actions = null;
								}
								if (!controller.pageOptions.dialog && options.dataUrl) {
									$page.attr('data-url', $.smobile.hashOfUrl(options.dataUrl));
								}
								var co = data ? data.options : {};
								if (controller.pageOptions.changeHash != null) co.changeHash = controller.pageOptions.changeHash;
								controller.notifyAuthoring('pageload');
								// Call jqm changePage with DOM element
								$.mobile.changePage($page, co);
								// Bind events to controls
								controller.bindData();
								$sdata.endLoad();
								if (controller.hasErrors())
									$.smobile.showErrors(controller);
								if (controller.hasMsgView && controller.errorViewHasInfo) {
									var msgctrl = controller.controlByClass("MsgView");
									if (msgctrl) {
										controller.errorInView($("#" + msgctrl.id));
									}
								}
							});
						});
					});
				}
			}
		},
		"pagehide": function(fromPage, data) {
			var $helpers = $.helpers;
			if (!window.location.hash) return;
			if (fromPage && fromPage.target != data.nextPage[0]) {
				var currentController = that.pageController(fromPage.target);
				var nextController = that.pageController(data.nextPage);
				if (currentController && currentController.pageInfo && currentController.pageInfo.page.cache) {
					//this page must be cached (home page by example) : don't  remove current page
					//$helpers.log("cache current page: this page can be cached");
					return;
				}
				var dialog = $.smobile.pageIsDialog(data.nextPage);
				var detail = (dialog ? false : $.smobile.pageIsDetail(data.nextPage));
				if (detail || dialog) {
					// next page is dialog/detail don't  remove current page
					if (nextController.child === currentController) {
						$.smobile.removePage(fromPage.target);
					} else {
						$helpers.log("cache current page: next page is  detail/dialog");
					}
					return;
				}
				if (currentController) {
					if (currentController.config && currentController.config.ui && (currentController.config.ui.indexOf(".$query") > 0)) return;
					if (currentController.pageActions && currentController.pageActions.close) {
						currentController.pageActions.close.apply(currentController);
					}
					$.smobile.removePage(fromPage.target);
				}

			}
		},
		"pageshow": function(event, ui) {
			if ($.helpers.hasFieldsErrors()) {
				that.ui.setErrorFocus($(event.target));
			} else if ($.helpers.hasErrors()) {
				$.smobile.showErrors();
			}

		},
		"enableSwipe": function() {
			$(document).on("swipeleft", that.docEvents.swipeleft);
			$(document).on("swiperight", that.docEvents.swiperight);
		},
		"disableSwipe": function() {
			$(document).off("swipeleft", that.docEvents.swipeleft);
			$(document).off("swiperight", that.docEvents.swiperight);
		}
	};


	function setJMobileEvents() {
		that.docEvents.enableSwipe();
		$(document).bind("pagebeforechange", that.docEvents.pagebeforechange);
		$(document).bind("pagehide", that.docEvents.pagehide);
		$(document).bind("pageshow", that.docEvents.pageshow);
	};

	function mobileStart() {
		// Set $start=true - initialize jqm
		// page has just been loaded (called after F5 or window.location.reload();
		setJMobileEvents();
		var setDefaultTransition = function() {
			$.mobile.defaultPageTransition = "none";
		};
		setDefaultTransition();
		$(window).bind("throttledresize", setDefaultTransition);
		if (window.location.hash) {
			$.mobile.$start = true;
			$.mobile.initializePage();
		} else {
			setTimeout(function() {
				var p = window.location.href.indexOf('?forcereload');
				if (p > 0) {
					window.location.href = window.location.href.substring(0, p);
				}
				window.location.hash = "#start";
				$.mobile.$start = true;
				$.mobile.initializePage();
			}, 0);
		}
	}
	window.onerror = function(errorMsg, url, lineNumber, error) {
		var $helpers = $ ? $.helpers : null;
		var msg = $helpers && $helpers.locale ? $helpers.locale().errorjs : "A javascript error occured\nPlease contact the administrator";
		msg += "\n" + errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		try {
			// _errCatched to avoid multiple calls if an error occurs in showErrors
			if (!_errCatched && $ && $.mobile && $.mobile.activePage) {
				_errCatched = true;
				$.helpers.pushException({
					message: msg
				});
				$.smobile.showErrors($.smobile.pageController($.mobile.activePage));
				$.mobile.loading('hide');
				return;
			}
		} catch (e) {
			alert(e);
		}
		if (!_errCatched) {
			alert(msg);
			var l = window.location;
			window.location = l.protocol + '//' + l.host + l.pathname + "#start";
		}
		_errCatched = false;
	};
	if ($.sdata.capabilities.loadLocale && $.sdata.capabilities.localeLoader) {
		// load locale
		var s = $.helpers.settings();
		$.helpers.setOffline(s && s.offline);
		$.helpers.clearErrors();
		$.sdata.capabilities.localeLoader(function() {
			mobileStart(false);
		}, true);
	} else {
		// Clear errors only if no localeLoader in order to display errors that occured during local loading
		// No clear is error page
		if (window.location.hash.indexOf("#apperrors") != 0 && window.location.hash.indexOf("#errors") != 0) {
			$.helpers.clearErrors();
		}
		mobileStart(true);
	}
});