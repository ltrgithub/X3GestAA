"use strict";
(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	var $scroller = $.scroller;
	var $proto = $.proto; // == require
	that.controls = that.controls || {};

	function decimalPlaces(n) {
		// Make sure it is a number and use the builtin number -> string.
		var s = "" + (+n);
		// Pull out the fraction and the exponent.
		var match = /(?:\.(\d+))?(?:[eE]([+\-]?\d+))?$/.exec(s);
		// NaN or Infinity or integer.
		// We arbitrarily decide that Infinity is integral.
		if (!match) {
			return 0;
		}
		// Count the number of digits in the fraction and subtract the
		// exponent to simulate moving the decimal point left by exponent places.
		// 1.234e+2 has 1 fraction digit and '234'.length -  2 == 1
		// 1.234e-2 has 5 fraction digit and '234'.length - -2 == 5
		return Math.max(
			0, // lower limit.
			(match[1] === '0' ? 0 : (match[1] || '').length) - (match[2] || 0)); // exponent

	}

	that.controls.Edit = {
		_nativeToString: function(value, type) {
			if (type === "range") {
				return (value || 0) + "";
			}
			if (type === "number") return (value || 0) + "";
			if (type === "date") {
				if (!value) return "";
				return $scroller.formatDate($helpers.dateSettings.dateFormat, value);
			} else if (type === "datetime") {
				if (!value) return "";
				return $scroller.formatDate($helpers.dateSettings.dateFormat + "  " + $helpers.dateSettings.timeFormat, value);
			} else if (type === "time") {
				if (!value) return "";
				return value.format();
			}
			return (value || "");
		},
		_getvalue: function(options, controller) {
			var cv = null;
			if (options.type === "date") {
				cv = controller.getValue(options.bind, null, null);

				if (cv != null) {
					var nullDate = /(0{4})-(0{2})-(0{2})([T\s]?)(0{2})?(:)?(0{2})?(:)?(0{2})?(\.(0{3}))?(Z)?(([+-])(0{2}))?(.*$)/.exec(cv);
					if (nullDate)
						cv = null;
					else {
						try {
							cv = Date.parseISO8601(cv);
						} catch (ex) {
							cv = new Date();
						}
					}
				} else {
					if (options.$isMandatory && controller.config.inCreate) {
						cv = new Date();
					}
				}
			} else if (options.type === "time") {
				cv = controller.getValue(options.bind, null, 0);
				try {
					cv = $helpers.Time.parse(cv);
				} catch (ex) {
					cv = new $helpers.Time(0);
				}
			} else if (options.type === "datetime") {
				cv = controller.getValue(options.bind, null, 0);
				if (cv != null) {
					var nullDate = /(0{4})-(0{2})-(0{2})([T\s]?)(0{2})?(:)?(0{2})?(:)?(0{2})?(\.(0{3}))?(Z)?(([+-])(0{2}))?(.*$)/.exec(cv);
					if (nullDate)
						cv = null;
					else {
						try {
							cv = Date.parseISO8601(cv);
						} catch (ex) {
							cv = new Date();
						}
					}
				} else {
					if (options.$isMandatory && controller.config.inCreate) {
						cv = new Date();
					}
				}
			} else if (options.type === "number") {
				cv = controller.getValue(options.bind, null, 0);
			} else if (options.type === "range") {
				cv = controller.getValue(options.bind, null, 0);
			} else {
				cv = controller.getValue(options.bind, null, "");
			}
			return that.controls.Edit._nativeToString(cv, options.type);
		},

		createEdit: function(controller, c) {
			var options = c.data || {};
			var html = [];
			var errors = that.ui.addFieldContainer(controller, html, c.id, options.bind);
			var valproto = controller.getProtoDataValue(options.bind);
			$proto.updproto(options, valproto);
			if (options.type === "range") {
				if (!options.$minimum && !options.$maximum) {
					options.type = "number";
				}
			}
			var itype = (options.type || "text");
			var cv = that.controls.Edit._getvalue(options, controller);
			html.push('<label class="ui-input-text" for="' + c.id + '_i">' + $helpers.htmlEncode(options.label) + (options.$isMandatory ? "*" : "") + '</label>');
			html.push('<div class="ui-input-text s-m-editfld ');
			if (options.$isDisabled || (valproto && valproto.$isDisabled)) {
				html.push('s-m-disabled ');
			}
			if (options.$isReadonly || (valproto && valproto.$isReadOnly)) {
				html.push('s-m-readonly ');
			}
			html.push('" ><input ');

			if ((itype === "string") || (itype === "date") || (itype === "time") || (itype === "datetime")) {
				itype = "text";
			}
			html.push('type="' + itype + '" name="' + c.id + '" id="' + c.id + '_i" ');
			if (options.$isReadOnly || (valproto && valproto.$isReadOnly)) {
				html.push('readonly="true" ');
			}
			if (options.$isDisabled || (valproto && valproto.$isDisabled)) {
				html.push('disabled="true" ');
			}
			html.push('value="' + $helpers.htmlEncode(cv) + '"');
			if (itype === "text" && options.$maxLength) {
				html.push(' maxlength="' + options.$maxLength + '"');
			}
			html.push('/>');
			that.ui.addErrors(errors, c.id, html);
			html.push('</div>');
			if (options.$confirm) {
				html.push('<label class="ui-input-text" for="' + c.id + '_i_c"> </label><input ');
				html.push('type="' + itype + '" name="' + c.id + '_i_c" id="' + c.id + '_i_c" ');
				if (options.$isReadOnly) {
					html.push('readonly="true" ');
				}
				html.push('value="');
				var cdata = controller.getValue();
				cv = cdata[options.bind + "_confirm"] || '';
				html.push($helpers.htmlEncode(cv));
				html.push('"');
				// Commented by Darina
				//if (options.$pattern) html.push(' pattern="' + options.$pattern + '"');
				//if (options.$isMandatory) html.push(' required="required"');
				if (itype === "text" && options.$maxLength) {
					html.push(' maxlength="' + options.$maxLength + '"');
				}
				html.push('/>');
			}
			html.push('</div>');
			return {
				html: html.join(''),
				bind: options.bind,
				options: options
			};
		},
		refresh: function(controller, options, $c, id) {
			var $input = $('#' + id + "_i");
			$input.val(that.controls.Edit._getvalue(options, controller));
			// FDB - Todo - Check error with checkValue (after factorization) and set error message if any - Error message is lot on refresh
			return that.ui.refreshErrors(controller, options.bind, id);
		},
		sync: true,
		handler: function(c, after) {
			return after(that.controls.Edit.createEdit(this, c));
		},
		checkValue: function($c, c) {
			var l = $helpers.locale();
			var controller = this;
			var $input = $c.find('#' + c.id + "_i");
			var nvalue = $input[0].value;
			var opts = c.options;
			var errKey;
			if (opts.$confirm) {
				var $confirm = $c.find('#' + c.id + "_i_c");
				var cvalue = $confirm[0].value;
				if (nvalue === cvalue) {
					if (nvalue === "") {
						var cdata = controller.getValue();
						delete cdata[opts.bind + '_confirm'];
						delete cdata[opts.bind];
					}
				} else {
					return $helpers.format(l.ui["password_mismatch"], [opts.label]);
				}
			}
			var err = that.controls.Edit._checkProtoRules(nvalue, opts);
			if (err) {
				return err;
			}
			if ((opts.type === "number") || (opts.type === "range")) {
				err = that.controls.Edit._checkNum(controller, nvalue, opts);
				if (err.error) {
					return err.error;
				}
			}
			if (opts.$salt) {
				return that.controls.Edit._computePasswordHash.apply(this, [$c, c]);
			}
			return null;
		},
		_computePasswordHash: function($c, c) {
			var l = $helpers.locale();
			var controller = this;
			var $input = $c.find('#' + c.id + "_i");
			var nvalue = $input[0].value;
			var opts = c.options;
			var errors = [];
			var salt = opts.$salt;
			if (salt) {
				var r = /[^ -\x7E\xA0-\xFF]/.exec(nvalue); // when you change regexp, also change it in newPassword.html
				if (r) {
					// "Password contains illegal character: {0}"
					errors.push($helpers.format(l.ui.fpwIllegal, [r[0]]));
				} else {
					var cdata = controller.getValue();
					salt = salt.replace(/\{(\w+)\}/g, function(d0, d1) {
						if (cdata[d1]) {
							return cdata[d1];
						}
						// Field {0} not found for salting
						errors.push($helpers.format(l.ui.fpwReplFieldNotFound, [d1]));
					});
					var md5result = md5(salt + ":" + nvalue);
					cdata[opts.bind + '_confirm'] = md5result;
					cdata[opts.bind] = md5result;
				}
				if (errors.length > 0) {
					return errors.join("\n");
				}
			}
			return null;
		},
		_checkDateTime: function(c, controller) {
			var $input = $('#' + c.id + "_i"),
				value, ovalue, nnvalue, _aftercchange = controller.afterChangeHnd(c);
			if (c.options.type === "date") {
				value = $input.val();
				if (!value) {
					return controller.checkChange(c.id, value, _aftercchange, null);
				}
				try {
					value = $scroller.parseDate($helpers.dateSettings.dateFormat, value);
				} catch (ex) {
					value = new Date();
				}
				value = value.toISOString();
				ovalue = controller.getValue(c.bind, null, "");
				nnvalue = $helpers.date.checkString(value, ovalue);
				if (value !== nnvalue) {
					var s = $scroller.formatDate($helpers.dateSettings.dateFormat, $helpers.date.isoToDate(value));
					$input.val(s);
				}
				if (ovalue !== nnvalue) controller.checkChange(c.id, nnvalue, _aftercchange, null);
			} else if (c.options.type === "time") {
				value = $input.val();
				ovalue = controller.getValue(c.bind, null, "");
				if (!value) value = $helpers.Time.parse(ovalue).format();
				try {
					value = $helpers.Time.parseTime(value);
				} catch (ex) {
					value = $helpers.Time.parse("00:00");
				}
				$input.val(value.format());
				value = value.toISO();
				if (value !== ovalue) {
					controller.checkChange(c.id, value, _aftercchange, null);
				}
			} else if (c.options.type === "datetime") {
				value = $input.val();
				if (!value) {
					return controller.checkChange(c.id, value, _aftercchange, null);
				}
				try {
					value = $scroller.parseDate($helpers.dateSettings.dateFormat + ' ' + $helpers.dateSettings.timeFormat, value);
				} catch (ex) {
					value = new Date();
				}
				value = value.toISOString();
				ovalue = controller.getValue(c.bind, null, "");
				var s = $scroller.formatDate($helpers.dateSettings.dateFormat + ' ' + $helpers.dateSettings.timeFormat, $helpers.date.isoToDate(value));
				$input.val(s);
				if (ovalue !== value) {
					controller.checkChange(c.id, value, _aftercchange, null);
				}
			}

		},
		_checkProtoRules: function(val, options) {
			var l = $helpers.locale();
			if (options.$isMandatory && (val == null || val.trim() === "")) {
				return l.ui.input_required;
			}
			if (options.$pattern && !options.$pattern.exec(val)) {
				return l.ui.incorrect_format;
			}
			if (options.$minLength != null && (val == null || val.length < options.$minLength)) {
				return l["minlength_field"];
			}
			return null;
		},
		_checkNum: function(controller, val, options) {
			try {
				var l = $helpers.locale();
				var nnvalue = parseFloat(val);
				if (isNaN(nnvalue)) {
					throw new Error($helpers.format(l.ui.invalid_number, [val]));
				}
				if (options && options.type === "range") {
					if (nnvalue < options.$minimum) {
						throw new Error($helpers.format(l.ui.range_overflow_number, [options.$minimum, options.$maximum]));
					} else if (nnvalue > options.$maximum) {
						throw new Error($helpers.format(l.ui.range_overflow_number, [options.$minimum, options.$maximum]));
					}
				}
				var expectedDecimals = options.decimals;
				if (options.decimals == null && options.bindDecimals) {
					expectedDecimals = controller.getValue(options.bindDecimals, null, 0);
				}
				if (expectedDecimals !== null) {
					var gotDecimals = decimalPlaces(nnvalue);
					if (gotDecimals > expectedDecimals) {
						throw new Error($helpers.format(l.ui.number_precision_error, [expectedDecimals]));
					} else {
						nnvalue = parseFloat(nnvalue.toFixed(expectedDecimals));
					}
				}
				return {
					value: nnvalue
				};
			} catch (e) {
				return {
					error: e.message
				};
			}
		},
		_updNumber: function(controller, $input, c) {
			var res = that.controls.Edit._checkNum(controller, $input[0].value, c.options);
			if (res.error) {
				throw new Error(res.error);
			} else {
				$input[0].value = res.value;
				controller.checkChange(c.id, res.value, controller.afterChangeHnd(c), null);
			}
		},
		events: function($c, c) {
			var controller = this;
			var $input = $c.find('#' + c.id + "_i");
			var $confirm = $c.find('#' + c.id + "_i_c");
			if (c.options.type === "date") {
				$input.scroller({
					preset: 'date'
				});
			} else if (c.options.type === "datetime") {
				$input.scroller({
					preset: 'datetime'
				});
			} else if (c.options.type === "time") {
				$input.scroller({
					preset: 'time'
				});
			}
			if (c.options.type === "range") {
				$input.slider({
					stop: function() {
						that.controls.Edit._updNumber(controller, $input, c);
					}
				});
			}
			$input.blur(function(evt) {
				var _aftercchange = controller.afterChangeHnd(c);
				try {
					if (c.bind) {
						var val = $input.val();
						var err = that.controls.Edit._checkProtoRules(val, c.options);
						if (err) {
							throw new Error(err);
						}
						if ((c.options.type === "number") || (c.options.type === "range")) {
							that.controls.Edit._updNumber(controller, $input, c);
						} else if (["datetime", "time", "date"].indexOf(c.options.type) >= 0) {
							window.setTimeout(function() {
								that.controls.Edit._checkDateTime(c, controller);
							}, 0);
						} else {
							controller.checkChange(c.id, $input.val(), _aftercchange, null);
						}
					}
				} catch (error) {
					that.ui.doOnblurKo(controller, c.id, error);
					// We set the dataset value in any case otherwise value is lost on refresh (go back from reference object -> page)
					controller.checkChange(c.id, $input.val(), _aftercchange, null);
					return;
				}
				that.ui.doOnblurOk(c.id);
			});

			$confirm.blur(function() {
				if (c.bind) {
					var cdata = controller.getValue();
					var ovalue = cdata[c.options.bind + "_confirm"] || '',
						nnvalue = $input.val();
					if (ovalue !== nnvalue) {
						cdata[c.options.bind + "_confirm"] = nnvalue;
						controller.notifyChange();
					}
				}
			});
		}
	};
})(jQuery);