"use strict";
(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	var $proto = $.proto;
	var $sdata = $.sdata;
	that.controls = that.controls || {};
	var _theme = 'g';
	var _typedItems = {
		sync: function(item) {
			item.title = $helpers.locale().ui.sync_item;
			item.action = "syncdrafts";
			item.icon = "drafts";
		},
		reinstall: function(item) {
			item.title = $helpers.locale().ui.install_item;
			item.action = "reinstall";
			item.icon = "sync";
		},
		templates: function(item) {
			item.title = $helpers.locale().ui.templateMngmt;
			item.action = "templates";
			item.icon = "templates";
		},
		help: function(item) {
			item.title = $helpers.locale().maintoolbar.help;
			item.hash = that.PAGES.about.id;
			item.icon = "info";
		},
		settings: function(item) {
			if (!$sdata.capabilities.showSettings) item.hidden = true;
			item.title = $helpers.locale().maintoolbar.settings;
			item.hash = that.PAGES.settings.id;
			item.icon = "gear";
		},
		language: function(item) {
			item.title = $helpers.locale().maintoolbar.language;
			item.icon = "chrome";
			item.action = "language";
		},
		next: function(item, controller) {
			item.title = $helpers.locale().maintoolbar.next;
			item.icon = "arrow-r";
			item.action = "next";
			var ccd = controller.getCurrentData();
			item.hidden = !(ccd && ccd.$links && ccd.$links.$next);
			item.refresh = true;

		},
		previous: function(item, controller) {
			item.title = $helpers.locale().maintoolbar.previous;
			item.icon = "arrow-l";
			item.action = "previous";
			var ccd = controller.getCurrentData();
			item.hidden = !(ccd && ccd.$links && ccd.$links.$previous);
			item.refresh = true;

		},
		home: function(item) {
			item.title = $helpers.locale().maintoolbar.home;
			item.hash = $.smobile.PAGES.home.id;
			item.icon = "home";
		},
		back: function(item) {
			item.title = $helpers.locale().maintoolbar.back;
			item.icon = "back";
			item.action = "back";
		},
		setup: function(item) {
			item.title = $helpers.locale().maintoolbar.setup;
			item.hash = $.smobile.PAGES.apps.id;
			item.icon = "setup";
		},
		mainmenu: function(item) {
			item.title = $helpers.locale().maintoolbar.home;
			item.hash = $.smobile.PAGES.start.id;
			item.icon = "home";
		},
		logout: function(item) {
			item.title = $helpers.locale().maintoolbar.logout;
			item.action = "logout";
			item.icon = "logout";
		}
	};
	that.controls.panelView = {
		sync: true,
		syncHandler: function(c, left) {
			var controller = this,
				inApp = false;
			if (left && controller && controller.config && controller.config.page && controller.config.page.page) {
				var pi = controller.config.page.page;
				if (!pi.useAppId) {
					var items = c.options.items[0].items;
					if (pi.isHome) {
						if (items[0].type == "mainmenu") items.splice(0, 1);
					}
				}
			}
			if (!c.options.loaded) {
				that.controls.panelView._create_items(c.options, controller);
			}
			if (left) return;
			if (c.options.links) {
				c.options.links.forEach(function(linkid) {

					controller.actionlink({
						success: function(data) {
							if (data && data.url) {
								$('#' + linkid).attr("href", that.ui.urlHref(data.url, controller));
							}
						}

					}, {
						id: linkid
					});
				});
			}
			that.controls.panelView._checkForTemplates(controller);

			return $sdata.getSyncCount(function(count) {
				var $c = $(".s-m-notify-sync");
				$c.html(count + "");
				if (count) $c.removeClass('s-m-hidden');
				else $c.addClass('s-m-hidden');
			});

		},

		/*
		 * Check for number of templates of the current page and display them as icon in the right panel
		 */
		_checkForTemplates: function(controller) {
			if (controller && controller.config && controller.config.page) {
				var $templateIcon = $(".s-m-notify-templates");
				if ($templateIcon && $templateIcon.length > 0) {
					var keys = {
						appid: controller.config.page.application,
						page: controller.page,
						user: '*'
					};
					$sdata.getSavedTemplates(keys, function(templates) {
						var html = [];
						if (templates && templates.length > 0) {
							$templateIcon.html(templates.length + "");
							$templateIcon.removeClass('s-m-hidden');
						} else {
							$templateIcon.addClass('s-m-hidden');
						}
					});
				}
			}
		},
		_create_items: function(options, controller) {
			var html = [];
			var items = options.items || [],
				links, page, proto, linksloaded;
			options.links = [];
			var edit = $sdata.representation2facet(controller.ui);
			edit = (edit === "$edit") || (edit === "$create");

			options.loaded = true;
			items.forEach(function(item, index) {
				if (item.code) {
					switch (item.code) {
						case "filtersort":
							var fsitems = controller.getFilterFields();
							if (fsitems) item.items.push({
								name: "filter",
								title: $helpers.locale().ui.filter,
								icon: "filter",
								action: "filter"
							});
							fsitems = controller.getSortFields();
							if (fsitems) {
								options.sortItems = fsitems;
								item.items.push({
									name: "sort",
									title: $helpers.locale().ui.sort,
									icon: "sort",
									action: "sort"
								});
							}
							break;
						case "actions":
							if (!linksloaded) {

								linksloaded = true;
								page = controller.getPageData();
								proto = $proto.getProto(page);
								links = $proto.extractLinks(proto, proto, controller.getCurrentData(), edit, page);
								if (edit) linksloaded = false;
							}
							if (links) {
								links.forEach(function(link) {
									//link
									if (edit || (link.$method === "POST")) {
										var cdid = controller.addAlink(link);
										item.items.push({
											name: link.name,
											$isHidden: link.$isHidden,
											title: link.$title,
											icon: link.icon,
											action: link.actionType || "service",
											actionData: '{"id":"' + cdid + '"}'
										});
									}

								});
							}
							break;

						case "links":
							if (!linksloaded) {
								linksloaded = true;
								page = controller.getPageData();
								proto = $proto.getProto(page);
								links = $proto.extractLinks(proto, proto, controller.getCurrentData(), false, page);
								if (edit) linksloaded = false;
							}
							if (links) {
								links.forEach(function(link) {
									if (link.$method === "GET") {
										var cdid = controller.addAlink(link);
										item.items.push({
											name: link.name,
											$isHidden: link.$isHidden,
											controlId: cdid,
											title: link.$title,
											icon: "link",
											action: "nolink",
											actionData: '{"id":"' + cdid + '"}'
										});
										options.links.push(cdid);
									}

								});
							}
							break;

					}
				}
				if (item.items && item.items.length) {
					var divider = item.code == "topactions" ? null : item.title ? item.title : null;
					if (divider != null) html.push('<li data-role="list-divider">' + divider + '</li>');
					var wasHidden;
					item.items.forEach(function(ii, index) {
						var count = null;
						if (ii.type === "sync") {
							options.syncHandler = that.controls.panelView.syncHandler;
							count = 0;
						}
						if (ii.type && _typedItems[ii.type]) _typedItems[ii.type](ii, controller);
						ii.jqData = ii.jqData || "";
						html.push('<li class="');
						html.push("ui-li-has-icon ");
						html.push($helpers.ui.consts.panel_icon);
						if (wasHidden = ii.$isHidden) {
							html.push(" s-m-hidden");
							ii.$isHidden = false; // No hidden class in link
						}
						html.push('"');
						if (ii.name) {
							html.push(' id="');
							// Same as header buttons
							html.push(controller.prefix);
							html.push(ii.name);
							html.push('"');
						}
						html.push(' data-corners="false" data-role="fieldcontain" data-shadow="false" data-iconshadow="true" data-icon="false" data-iconpos="right" data-theme="' + _theme + '">');
						that._addLink(html, ii, controller, function() {
							html.push(that.ui.panelItem(ii.title, ii.icon, ii.description, count, ii));

						});
						ii.$isHidden = wasHidden;
						html.push('</li>');
					});
				}
			});
			var $ul = $("#" + options.id);
			$ul.html(html.join(''));
			$ul.listview("refresh");

		},
		handler: function(c, after) {
			var controller = this;
			var html = [],
				options = c.data || [];
			html.push('<ul class="s-m-list"  id="' + c.id + '" data-role="listview"');
			html.push(' data-divider-theme="' + _theme + '"');
			html.push(' data-theme="' + _theme + '"');
			html.push(' data-inset="false"');
			html.push(' data-icon="false"');
			html.push('>');
			options.loaded = false;
			options.syncHandler = that.controls.panelView.syncHandler;
			options.id = c.id;
			html.push('</ul>');
			return after({
				html: html.join(''),
				bind: true,
				options: options
			});
		},
		refresh: function(controller, options, $c, id) {},
		events: function($c, c) {
			var controller = this;
			$c.click(function(e) {
				var options = c.options;
				if (controller.disabled) return;
				controller.disabled = true;
				// find parent by tag
				var target = $helpers.getTarget(e);
				if (target) {
					var act = $(target).attr("data-action"),
						actp;
					if (act === "filter") {
						if (that.openFilterDlg) { // declared in jquery.smobile.controls.sdataFilter.js
							that.openFilterDlg(controller, controller.extraData.filters);
							e.preventDefault();
						}
					} else if (act === "sort") {
						$.smobile.openSortDlg(controller);
						e.preventDefault();
					} else if (act) {
						var hnd = controller["action" + act];
						if (hnd) {
							e.preventDefault();
							$helpers.clearErrors();
							var actp = $(target).attr("data-action-param");
							if (actp) actp = JSON.parse(actp);
							return hnd.call(controller, {
								success: function(data, error, noback) {
									try {
										var $panel = $('#' + controller.prefix + 'rpanel');
										$panel.panel("close");
									} catch (ex) {}
									controller.disabled = false;
									if (!error && !noback) $.smobile.doBack(controller);
								}
							}, actp);
						}
					}

				}
				controller.disabled = false;
			});
		}

	};
})(jQuery);