"use strict";

(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	that.controls = that.controls || {};

	function _errorUi(title, diag, last, controller) {
		var res = {
			"$css": "dlogErrors",
			"$title": title,
			"content": {
				"Messages": {
					"uiClass": "Messages",
					"data": {
						"diagnoses": []
					}
				}
			},
			roptions: {
				nopanel: true
			}
		};
		// Error can occur in page loading with a null controller
		// -> In that case we display a left Panel with static link (home, setup...) instead of a back button
		if (controller == null) {
			// Force display of left panel instead of back button
			res.panel = {
				left_panel: that.getStaticUI("mainpanel")
			};
			res.roptions.nopanel = false;
		}
		res.hbuttons = [{
			title: $helpers.locale().ui.mail,
			url: 'mailto:?subject=' + encodeURIComponent($helpers.locale().errmailsubject) + '&body=' + that.controls.Messages.getBody(diag),
			linkType: "$external",
			"jmdata": {
				"data-icon": "s-mail",
				"data-transition": "none"
			}
		}, {
			title: $helpers.locale().ui.nextDiagnose,
			action: "nextDiagnose",
			$isHidden: last,
			"jmdata": {
				"data-icon": "arrow-r",
				"data-transition": "fade"
			}
		}];
		res.actions = {
			nextDiagnose: function(after) {
				_processDlog(this, false);
				// Mandatory - enable the controller
				if (after) after(true);
			}
		};
		return res;
	}

	// !! controller can be null

	function _processDlog(controller) {
		var idx;
		var allmsgs;
		// Page idx > 0
		if (controller != null) {
			var data = controller.getValue();
			if (data) {
				allmsgs = data.messages;
				idx = data.idx + 1;
			}
		}
		// First page 
		if (allmsgs == null) {
			allmsgs = $helpers.allMessages();
			if (allmsgs == null || allmsgs.length == 0) {
				// Display nothing - Could append in openErrorDlg called after a openErrorDlg
				return;
			}
			idx = 0;
			$helpers.clearErrors();
			if (controller && controller.disabled) controller.disabled = false;
		}
		var diag = allmsgs[idx];
		if (!diag) return;
		var ui = _errorUi((idx + 1) + '/' + allmsgs.length + " " + $helpers.locale().ui.messages + " ", diag, (idx + 1) == allmsgs.length, controller);
		that.createDetail(ui, {
			$title: "",
			diagnose: diag,
			messages: allmsgs,
			idx: idx
		}, controller, function(diagControler, $page) {
			diagControler.data.idx = idx;
			var h = $("#" + diagControler.prefix + "headerTab");
			var type = $helpers.error2Type(diag.type);
			h.addClass("diag_" + type);
		});
	}


	that.openErrorDlg = function(controller) {
		_processDlog(controller);
	};

	that.controls.Messages = {
		getBody: function(diag) {
			if (!diag) return;
			var data = diag && diag.data || {};
			var message = data.message || "";
			var body = diag.title + "\n";
			body += (diag.origin) ? "ORIGIN : " + $helpers.error2Origine(diag.origin).toUpperCase() + "\n" : "";
			body = body + message;
			if (data.stackTrace) {
				body += data.stackTrace;
			}
			body = body.substring(0, 2000);
			body = encodeURIComponent(body);

			return body;
		},
		createMessages: function(controller, c) {
			var options = c.data || {};
			var cd = controller.getValue();
			var html = [];
			var diagnose = cd.diagnose;
			var data = diagnose && diagnose.data || {};
			$helpers.addJqmData(options, html);
			html.push('<div class="s-m-error-bkg">');
			html.push('<div id="' + c.id + '">');
			// Display error title
			var ttl = "";
			diagnose.title.split('\n').forEach(function(h) {
				if (ttl.length != 0) ttl += "<br>";
				ttl += $helpers.htmlEncode(h);
			});

			html.push('<p class="s-error-ttl">' + ttl + '<\p>');
			var message = data.message || "";
			if (message.length > 0) {
				var msg = diagnose.origin ? ["ORIGIN : " + $helpers.error2Origine(diagnose.origin).toUpperCase()] : [];
				msg = msg.concat(message.replace(/\r\n/g, '\n').split("\n"));
				if (data.stackTrace) {
					msg = msg.concat(data.stackTrace.replace(/\r\n/g, '\n').split("\n"));
				}
				html.push('<div   data-role="collapsible" data-mini="true" data-iconpos="right" data-collapsed-icon="s-rpanel-alt" data-expanded-icon="s-rpanel-alt" data-theme="d">');
				html.push('<h3><span class="s-m-error-detail-r">' + $helpers.locale().ui.msg_detail + '</span></h3>');
				html.push('<p class="s-m-error-detail">');
				msg.forEach(function(m) {
					html.push($helpers.htmlEncode(m) + ("<br />"));
				});
				html.push('</p>');
			}
			html.push('</div>');
			html.push('</div>');
			return {
				html: html.join(''),
				bind: " ",
				action: options.action,
				options: options
			};
		},
		handler: function(c, after) {
			return after(that.controls.Messages.createMessages(this, c));
		},
		refresh: function(controller, options, $c, id) {},
		events: function($c, c) {}
	};

})(jQuery);