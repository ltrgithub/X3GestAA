"use strict";

(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;

	that.controls = that.controls || {};

	function _errorUi(controller, title, diag, delta) {
		var res = {
			"$title": title,

			"content": {
				"Messages": {
					"uiClass": "Messages",
					"data": {
						"diagnoses": []
					}
				}
			}
		};
		res.roptions = {
			nopanel: true
		};
		res.hbuttons = [{
				title: $helpers.locale().ui.mail,
				url: 'mailto:?subject=' + encodeURIComponent($helpers.locale().errmailsubject) + '&body=' + that.controls.Messages.getBody(diag),
				linkType: "$external",
				"jmdata": {
					"data-icon": "s-mail",
					"data-transition": "none"
				}
			}, {
				title: $helpers.locale().ui.nextDiagnose,
				action: "nextDiagnose",
				$isHidden: (delta === 0) ? true : false,
				"jmdata": {
					"data-icon": "arrow-r",
					"data-transition": "fade"
				}

			}

		];
		res.actions = {

			nextDiagnose: function(after) {
				var controller = this;
				if (controller) {

					var dd = controller.getValue();
					var msgs = dd.msgs;
					var allmsgs = dd.allmsgs;
					var diag = msgs.splice(0, 1);
					var delta = (allmsgs.length - msgs.length);
					var ui = _errorUi(controller, (delta) + '/' + allmsgs.length + " Messages ", diag, msgs.length);
					var pageData = {
						$title: "",
						isError: true,
						diagnose: diag,
						msgs: msgs,
						allmsgs: allmsgs
					};

					that.createDetail(ui, pageData, controller);
				}
				if (after) after(true);
			}
		};

		return res;
	}

	function _errorOpen(controller) {
		var msgs = $helpers.allMessages();
		if (msgs.length) {
			var allmsgs = msgs.slice(0);
			var diag = msgs.splice(0, 1);
			var ui = _errorUi(controller, (1) + '/' + allmsgs.length + " Messages ", diag, allmsgs.length);
			that.createDetail(ui, {
				$title: "",
				isError: true,
				diagnose: diag,
				msgs: msgs,
				allmsgs: allmsgs
			}, controller);
		}
	}

	var _error2Origine = function(value) {
		switch (value) {
			case $helpers.ERRORS.http:
				return "http";
			case $helpers.ERRORS.db:
				return "db";
			default:
				//case $helpers.ERRORS.exception:
				return "app";
		}
	};

	that.openErrorDlg = _errorOpen;


	that.controls.Messages = {
		getBody: function(diag) {
			var diagnose = diag[0];
			var data = diagnose && diagnose.data || {};
			var message = data.message || "";
			var body = message + ' - ' + diagnose.title;
			body += (diagnose.origin) ? "ORIGIN : " + _error2Origine(diagnose.origin).toUpperCase() + "\n" : "";

			if (data.stackTrace)
				body += data.stackTrace;
			body = body.substring(0, 2000);
			body = encodeURIComponent(body);

			return body;
		},
		createMessages: function(controller, c) {
			var options = c.data || {};
			var cd = controller.getValue();

			var html = [];
			var diagnose = cd.diagnose && cd.diagnose[0];

			var data = diagnose && diagnose.data || {};
			var message = data.message || "";

			$helpers.addJqmData(options, html);

			html.push('<div class="s-m-error-bkg">'); // id="' + c.id + '">';
			if (message.length > 0) {
				html.push('<div class="s-error-ttl" id="' + c.id + '">');
				html.push('<p class="s-error-ttl">' + message + ' - ' + diagnose.title + '<\p>');
				var msg = diagnose.origin ? ["ORIGIN : " + _error2Origine(diagnose.origin).toUpperCase()] : [];

				if (data.stackTrace)
					msg = msg.concat(data.stackTrace.replace(/\r\n/g, '\n').split("\n"));
				html.push('<div   data-role="collapsible" data-mini="true" data-iconpos="right" data-collapsed-icon="s-rpanel-alt" data-expanded-icon="s-rpanel-alt" data-theme="d">');
				html.push('<h3><span class="s-m-error-detail-r">' + $helpers.locale().ui.msg_detail + '</span></h3>');
				html.push('<p class="s-m-error-detail">');

				msg.forEach(function(m) {
					html.push($helpers.htmlEncode(m) + ("<br />"));
				});
				html.push('</p>');
				html.push('</div>');
			}


			html.push('</div>');


			return {
				html: html.join(''),
				bind: " ",
				action: options.action,
				options: options
			};
		},

		handler: function(c, after) {
			return after(that.controls.Messages.createMessages(this, c));
		},
		refresh: function(controller, options, $c, id) {

			var html = [];
			var data = $helpers.allMessages();

			var $ul = $('#' + id + '_items');
			var $items = $ul.children(".filter_item");
			$items.remove();
			var toolbar = $('#' + id + '_footer');
			toolbar.before(html.join(''));

			$ul.listview("refresh");

		},


		events: function($c, c) {}
	};

})(jQuery);