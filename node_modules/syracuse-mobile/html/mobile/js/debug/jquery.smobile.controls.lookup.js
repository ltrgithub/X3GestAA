"use strict";
(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	var $proto = $.proto;
	that.controls = that.controls || {};
	that.controls.Lookup = {
		_displayValue: function(controller, cv, cp) {
			var val = "";
			if (cv && typeof cv != "object") {
				// #2741 - Value (cv) is passed as a string for filter on x-reference objects (no prototype and value.$value is no more used)
				return cv;
			}
			var isuuid = $proto.useUuid(cp);
			if (isuuid && !cv) {
				//val = "";
			} else if (cv && cv.hasOwnProperty("$value")) {
				val = cv.$value;
			} else if (cp) {
				if (cp.$value) {
					val = $proto.parseExpression(cp.$value, {
						data: controller.exprData(cv),
						$prototype: cp
					}, "$value");
				} else {
					val = $proto.parseExpression(cp.$key, {
						data: controller.exprData(cv),
						$prototype: cp
					}, "$key");
				}
			}
			return val;
		},
		getFieldProto: function(controller, options, bind) {
			if (!bind) bind = options.bind;
			if (options.getFieldProto) {
				return options.getFieldProto(controller, options, bind);
			}
			var page = controller.getPageData();
			return $proto.getProto(page, options.bind);
		},
		createLookup: function(controller, c) {
			var options = c.data || {};
			var html = [];
			// var page = controller.getPageData();
			var cp = that.controls.Lookup.getFieldProto(controller, options); //$proto.getProto(page, options.bind);
			if (options.$lookupurl) {
				options.$lookupurl = options.$lookupurl + "&control=" + $helpers.encodeURIComponent(c.id);
				if (options.$filter) options.$lookupurl = options.$lookupurl + "&control=" + $helpers.encodeURIComponent(c.id) + "&nofilter=1";
			}
			//  Issue #2298 - referenceField is the field that contains the value (given by cp.$value) and the error
			//  In X3 CUR_REF is the lookup field and CUR the value field	
			var referenceField = cp.$rvalue ? cp.$rvalue : options.bind;
			var errors = that.ui.addFieldContainer(controller, html, c.id, referenceField);
			var $article = options.$article || {};
			var cssl = null;
			var labelAfter = false;
			var drawLabel = function() {
				if ($article.$isTitleHidden) return;
				html.push('<label id="');
				html.push(c.id);
				html.push('_l" class="');
				html.push(cssl.join(' '));
				html.push('">');
				var meta = controller.getProtoDataValue(referenceField);
				$proto.updproto(options, meta);
				if (options.$lookupurl && (!options.$isReadOnly && !options.$isDisabled && options.$isEditMode !== false)) {
					var cd = options.$lookupurlparsed ? {
						url: options.$lookupurl
					} : {
						action: "lookup",
						actionData: $helpers.encodeURIComponent(options.$lookupurl)
					};
					that._addLink(html, cd, controller, function() {
						html.push($helpers.htmlEncode(options.label) + (options.$isMandatory ? "*" : ""));
					});
				} else {
					html.push($helpers.htmlEncode(options.label) + (options.$isMandatory ? "*" : ""));
				}
				html.push('</label>');
			};
			if (!$article.$isTitleHidden) {
				cssl = ["s-m-style", "s-m-label"];
				labelAfter = $proto.auth.mobileExtentionsLbl(cssl, $article);
				if (labelAfter) {
					cssl.push("after");
				} else {
					drawLabel();
				}
			}
			var css = ["s-m-editfld s-m-style s-m-value"];
			var readOnly = options.$isReadOnly || options.$isEditMode === false;
			var disabled = options.$isDisabled || options.$isEditMode === false;
			if (readOnly) {
				css.push('s-m-readonly');
			}
			if (disabled) {
				css.push('s-m-disabled');
			}
			$proto.auth.mobileExtentions(css, $article);
			html.push('<div class="');
			html.push(css.join(' '));
			html.push('">');
			html.push('<input type="text" name="');
			html.push(c.id);
			html.push('" id="');
			html.push(c.id + '_i" ');
			if (readOnly) {
				html.push('readonly="true" ');
			}
			if (disabled) {
				html.push('disabled="true" ');
			}
			var cv = controller.getValue(options.bind, null, null);
			var val = that.controls.Lookup._displayValue(controller, cv, cp);
			html.push('value="' + $helpers.htmlEncode(val || "") + '"');
			var protoRef = $proto.getProto(controller.getPageData(), cp.$rvalue);
			if (protoRef && protoRef.$maxLength) {
				html.push('maxlength="' + protoRef.$maxLength + '"');
			}
			html.push('/>');
			that.ui.addErrors(errors, c.id, html);
			html.push('</div></div>');
			if (!$article.$isTitleHidden && labelAfter) {
				drawLabel();
			}
			options.$lookup = 1;
			return {
				html: html.join(''),
				bind: options.bind,
				action: options.action,
				options: options
			};
		},
		refresh: function(controller, options, $c, id) {
			var $input = $('#' + id + "_i");
			if (options.refreshHandler) return options.refreshHandler(controller, $input, options.bind);
			var cp = that.controls.Lookup.getFieldProto(controller, options);
			// value of reference
			var ivalue = $proto.parseExpression(cp.$value, {
				data: controller.exprData(controller.getValue(options.bind, null, null)),
				$prototype: cp
			}, "$value") || "";
			$input.val(ivalue);
			return that.ui.refreshErrors(controller, cp.$rvalue, id);
		},
		setValue: function(controller, c, value, next) {
			if (c.options.setValueHandler) return c.options.setValueHandler(controller, value, next);
			//value is the selected resource
			//var $input = $( '#'+ c.id + "_i");
			//var page = controller.getPageData();
			// proto of reference
			var cp = that.controls.Lookup.getFieldProto(controller, c.options);
			// value of reference
			var cv = $proto.getRefFromValue(value, cp);
			var vsetvalue = true;
			var newkey = "",
				oldkey = "";
			var isuuid = $proto.useUuid(cp);
			// calculate new $key
			if (isuuid) {
				newkey = cv.$key || cv.$uuid;
			} else {
				cp.noRef = true;
				newkey = $proto.parseExpression(cp.$key, {
					data: $proto.exprData(cv),
					$prototype: cp
				}, "$key");
				delete cp.noRef;
			}
			// calculate old $key
			var ov = controller.getValue(c.options.bind, null, null);
			if (isuuid) oldkey = (ov ? (ov.$key || ov.$uuid) : "");
			else oldkey = $proto.parseExpression(cp.$key, {
				data: controller.exprData(ov),
				$prototype: cp
			}, "$key");
			vsetvalue = (oldkey != newkey);
			if (vsetvalue) {
				if (value && value.$lookupdescr) {
					// Remove old diagnose because value changed
					var x = controller.data.$properties;
					if (x && x[cp.$rvalue] && x[cp.$rvalue].$diagnoses) {
						delete x[cp.$rvalue].$diagnoses;
					}
					cv["$description"] = value.$lookupdescr;
				}
				$proto.setRef(cv, cp, controller.exprData(), c.options.bind);
				controller.notifyChange();
				controller.setNeedRefresh();
				return next();
			}
			return next();
		},
		sync: true,
		handler: function(c, after, layoutClass) {
			return after(that.controls.Lookup.createLookup(this, c));
		},
		events: function($c, c) {
			var controller = this;
			var $input = $c.find('#' + c.id + "_i");
			var $label = $c.find('#' + c.id + "_l");
			// #4430 - do not display mandatory error if click on lookup link when the field has the focus
			var skipMandatory = false,
				hasFocus = false;
			$input.focusin(function(evt) {
				hasFocus = true;
			});
			$input.focusout(function(evt) {
				hasFocus = false;
			});
			$input.blur(function(evt) {
				if (c.options.exitHandler) {
					skipMandatory = false;
					return c.options.exitHandler(controller, $input.val());
				}
				var val = null,
					oldval = null;
				try {
					if (c.bind) {
						var _aftercchange = controller.afterChangeHnd(c);
						var cv = controller.getValue(c.options.bind, null, null);
						var cp = that.controls.Lookup.getFieldProto(controller, c.options);
						var oldval = that.controls.Lookup._displayValue(controller, cv, cp);
						var val = $input.val();
						if (oldval != val) {
							// value changed by key 
							controller.checkChange(c.id, val, _aftercchange, cp);
						}
						if (!skipMandatory && c.options.$isMandatory && (val == null || val.trim() === "")) {
							throw new Error($helpers.format($helpers.locale().ui.input_required));
						}
					}
				} catch (error) {
					that.ui.doOnblurKo(controller, c.id, error);
					return;
				} finally {
					skipMandatory = false;
				}
				that.ui.doOnblurOk(c.id);
			});
			$label.mousedown(function(e) {
				skipMandatory = hasFocus;
			});
			$label.click(function(e) {
				var target = $helpers.getTarget(e);
				var p = $(target).attr("data-action");
				if (p === "lookup") {
					p = $helpers.decodeURIComponent($(target).attr("data-action-param"));
					var cp = that.controls.Lookup.getFieldProto(controller, c.options);
					p = $proto.parseExpression(p, {
						data: controller.exprData(),
						$prototype: cp
					}, "$url");
					e.preventDefault();
					$.smobile.changePage(that.ui.urlHref(p, controller), {
						changeHash: true
					});
				}

			});
		}
	};
	that.controls.Lookup.checkValue = that.controls.Edit.checkValue;

})(jQuery);