"use strict";
(function($) {
	var that = $.smobile;
	var $helpers = $.helpers;
	that.controls = that.controls || {};
	that.controls.Combo = {
		createCombo: function(controller, c) {
			var options = c.data || {};
			var html = ['<div data-role="fieldcontain"  class="ui-icon-alt" id="' + c.id + '">'];
			that.ui.addErrors(controller, options.bind, c.id, html);
			html.push('<label class="ui-input-text" for="' + c.id + '_i">' + options.label + ': </label>');
			html.push('<select id="' + c.id + '_i"');
			$helpers.addJqmData(options, html);
			html.push('>');
			var cv = controller.getValue(options.bind, null, null);
			var key = cv || options.value;
			options.items = options.items || [];
			if ((cv == null) && options.items.length) {
				key = options.items[0].value;
				controller.setData(options.bind, key);
			}
			options.items.forEach(function(item) {
				html.push("<option value=\"" + item.value + "\"" + ((key == item.value) ? " selected=\"selected\"" : "") + ">" + item.title + "</option>");
			});
			html.push('</select>');
			html.push('</div>');
			return {
				html: html.join(''),
				bind: options.bind,
				options: options
			};
		},
		sync: true,
		handler: function(c, after) {
			after(that.controls.Combo.createCombo(this, c));
		},
		checkValue: function($c, c) {
			var controller = this;
			var $select = $c.find('#' + c.id + "_i");
			var value = $select.find('option:selected').val();
			var e = $c.find('#' + c.id + "_error");
			e.html("");
		},
		refresh: function(controller, options, $c, id) {
			return that.ui.refreshErrors(controller, options.bind, id);
		},
		events: function($c, c) {
			var controller = this;
			var $select = $c.find('#' + c.id + "_i");
			//OK
			$select.bind("change", function(event, ui) {
				var value = $select.find('option:selected').val();
				var _aftercchange = controller.afterChangeHnd(c);
				var oldValue = controller.getValue(c.bind, null, null);

				if (oldValue != value) {
					controller.setData(c.bind, value);
					controller.notifyChange();
					if (_aftercchange) _aftercchange();
					var hnd = (c.options.action && controller.pageActions) ? controller.pageActions["action" + c.options.action] : null;
					if (hnd) hnd.bind(controller)();

				}
			});
		}

	};
})(jQuery);