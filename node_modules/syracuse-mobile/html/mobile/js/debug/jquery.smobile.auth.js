"use strict";
(function($) {
	$.proto = $.proto || {};
	var $proto = $.proto;
	var $helpers = $.helpers;
	var that = $proto.auth || {};
	$proto.auth = that;
	$proto.auth.designMode = false;
	$proto.auth.notifyParent = function(event, eventData, info) {
		return eventData;
	};

	function _scanObj(obj, match, trace, continueOnMatch) {
		var i, len;
		if (Array.isArray(obj)) {
			for (i = 0, len = obj.length; i < len; i++) {
				var ci = obj[i];
				if (ci && (typeof ci === "object")) {
					if (trace) trace(ci, obj);
					ci = _scanObj(ci, match, trace, continueOnMatch);
					if (ci && !continueOnMatch) return ci;
				}

			}
			return null;
		}
		if (typeof obj !== "object") return null;
		var matchObj = match(obj);
		if (matchObj) return matchObj;
		var keys = Object.keys(obj);
		for (i = 0, len = keys.length; i < len; i++) {
			var p = keys[i];
			if (p.charAt(0) === "_") continue;
			var o = obj[keys[i]];
			if (o && (typeof o === "object")) {
				if (trace) trace(o, obj);
				o = _scanObj(o, match, trace, continueOnMatch);
				if (o) return o;

			}
		}
		return null;
	}
	// get default layout for details/edit/create
	function _defaultDetailArticle(proto, info) {
		var res = {
			$layout: {
				$layoutType: "stack",
				$items: []
			}
		};
		//$proto.$properties
		var items = res.$layout.$items;
		if (proto.$properties) Object.keys(proto.$properties).forEach(function(pn) {
			var pi = proto.$properties[pn];
			if (pi.$isHidden || pi.$isExcluded) return;
			items.push({
				$bind: pn
			});

		});
		return res;

	};
	that.defaultDetailArticle = _defaultDetailArticle;

	function _copyproto(proto, res) {
		if (!proto) return;
		if (Array.isArray(proto)) {
			proto.forEach(function(val) {
				if (typeof val === "object") {
					var cv = Array.isArray(val) ? [] : {};
					res.push(cv);
					_copyproto(val, cv);
				} else res.push(val);
			});
		} else {
			Object.keys(proto).forEach(function(pn) {
				if ((pn === "$rtype") || (pn === "$protoparent") || (pn === "$rprotoparent")) return;
				var val = proto[pn];
				if (typeof val === "object") {
					res[pn] = Array.isArray(val) ? [] : {};
					_copyproto(val, res[pn]);
				} else res[pn] = val;
			});
		}

	};
	that.copyProto = function(proto) {
		var res = {};
		_copyproto(proto, res);
		return res;
	};
	function _cardsLayout(o, detail) {
		var res = o.$layout || null;
		if (o.$format === "cards") {
			if (o.$cards && o.$cards.$layout)  {
				return o.$cards.$layout;
			}
		}
		if (detail && (o.$cards && o.$cards.$layout)) return o.$cards.$layout;
		return res;
	};
	// find sub layout by name 
	function _findLayout(article, name, parent) {
		if (!article) return null;
		article = _scanObj(article, function(o) {
			if (o.$bind === name) {
				//
				if (parent) return o;
				// cards
				var cards = _cardsLayout(o) ;
				return cards;
			}
			return null;
		});
		return article;
	};
	that.findSlayout = _findLayout;

	// get only the layout for $resources.$item
	function _filterItem(article, list) {
		article = _scanObj(article, function(o) {
			if (o.$bind === "$resources") {
				// only for $query || $facet
				var cards = _cardsLayout(o, true) ;
				return cards;
			}
			return null;
		});
		return article;
	};
	// get default layout for lists
	function _defaultListArticle(proto, imageProp, info) {
		if (!info.list) return null;
		var $title = '$title';
		var $description = '$description';
		if (!proto.$title && proto.$value) {
			$title = '$value';
		} else if (proto.$title && (proto.$title === proto.$description)) $description = "";

		var article = {
			$layout: {
				$layoutType: "stack",
				$items: [{
					$bind: "$resources",
					$format: "cards",
					$cards: {
						$layout: {
							$layoutType: "stack",
							$items: [{
								$bind: $title,
								$isTitle: true
							}]

						}
					}
				}]
			}
		};
		if ($description) article.$layout.$items[0].$cards.$layout.$items.push({
			$bind: $description,
			$lines: 2
		});
		if (imageProp) {
			if (info.design) {
				article.$layout.$items[0].$cards.$layout.$items.push({
					$bind: imageProp
				});
			} else {
				info.$image = imageProp;
				article.$image = imageProp;
			}
		}
		return article;

	};
	// scan check and correct $article (layout of lists) 
	function _checkListArticle(proto, article, info) {
		if (!info.list) return article;
		// check if exists an image property 
		var imageProp = null;
		Object.keys(proto.$properties).forEach(function(pn) {
			var p = proto.$properties[pn];
			if (!imageProp && (p.$type === "image")) {
				imageProp = pn;
			}
		});
		var filteredItem = null;
		if (article) {
			if (info.noCache) {
				// copy article don't modify it
				article = $.extend(true, {}, article);
			}
			filteredItem = _filterItem(article);
			if (!filteredItem) article = null; // $bind on $resources not found
		}
		if (!article) {
			// no layout / get default layout
			article = _defaultListArticle(proto, imageProp, info);
		} else {
			if (imageProp && !article.$image && !info.design) {
				// get out image from layout 
				// 
				var obj = _scanObj(article, function(o) {
					if (o.$bind === imageProp) return o;
					return null;
				}, function(child, parent) {
					if (Array.isArray(parent)) child._parent = parent._parent;
					else child._parent = parent;
				});
				if (obj) {
					info.$image = imageProp;
					article.$image = imageProp;
					// try to remove image from design : the image is 
					if (obj._parent) {
						var cl = obj._parent,
							remove = true;
						while (remove) {
							if (!cl.$items) {
								obj = cl;
								cl = cl._parent;
								if (!cl) break;
							} else {
								var ii = cl.$items.indexOf(obj);
								if (ii >= 0) {
									cl.$items.splice(ii, 1);
									if (!cl.$items.length) {
										obj = cl;
										cl = cl._parent;
										//go up
									} else {
										remove = false;
										if ((cl.$layoutType === "row") && cl.$widths) {
											// for row layout update widths 
											var widths = cl.$widths.split(",");
											var oldw = parseFloat(widths[ii]);
											widths.splice(ii, 1);
											var neww = parseFloat(widths[0]);
											neww = neww + oldw;
											widths[0] = neww + '%';
											cl.$widths = widths.join(",");

										}
									}

								} else remove = false; //never
							}
						}
					}
				} else {
					article.$image = "";
				}
				// remove circular references
				_scanObj(article, function(o) {
					return null;
				}, function(child, parent) {
					child._parent = null;
				});
			} else {
				info.$image = article.$image;
			}
			if (!article) article = _defaultListArticle(proto, imageProp, info);
		}
		if (!info.design) {
			if (filteredItem) article = filteredItem;
			else article = _filterItem(article);
		}
		return article;
	};
	that.checkQueryArticle = _checkListArticle;
	that.checkDesign = function(proto, article, info) {
		if (info.list) {
			var p = proto.$properties.$resources.$item;
			return that.checkQueryArticle(p, article, info);
		}
		return article;
	};

	function _checkWidths($layout) {
		var widths;
		if (!$layout.$widths) {
			if (!$layout.$items.length) return;
			var size = parseInt(10000 / $layout.$items.length, 10) / 100; //33.33
			var j = $layout.$items.length;
			widths = new Array(j);
			while (j--) widths[j] = size + '';
		} else widths = $layout.$widths.split(",");
		return widths;
	}

	function _execRowlayout($layout, html, options, controller, cp, cd, exprData, info) {
		var widths = _checkWidths($layout);
		var pclass = ["s-m-l-table"];
		if ($layout.$theme) pclass.push("theme" + $layout.$theme.toUpperCase());
		if ($layout.$styles) $layout.$styles.forEach(function(s) {
			pclass.push(s);
		});
		html.push('<div class="' + pclass.join(' ') + '">');
		var len = widths.length - 1;
		widths.forEach(function(width, index) {
			var cclass = ["s-m-l-row"];
			if ((index === 0) && (index !== len)) cclass.push("first");
			else if ((index !== 0) && (index === len)) cclass.push("last");
			if ((width.indexOf("%") < 0) && (width.indexOf("px") < 0)) width = width + '%';
			html.push('<div class="' + cclass.join(' ') + '" style="width:' + width + '">');
			info.root = false;
			_execLayoutItem($layout.$items[index], html, options, controller, cp, cd, exprData, info);
			html.push('</div>');

		});
		html.push('</div>');
	}

	function hasOnlyFields($layout) {
		var i = $layout.$items.length;
		while (i--) {
			if (!$layout.$items[i].$bind && !$layout.$items[i].$expression) {
				return false;
				break;
			}
		}
		return true;
	}

	function _execStackLayout($layout, html, options, controller, cp, cd, exprData, info) {
		var addContainer = !hasOnlyFields($layout);
		$layout.$items.forEach(function(item) {
			if (!addContainer) info.defContainer = "p";
			else html.push('<div class="s-m-l-stack">');

			_execLayoutItem(item, html, options, controller, cp, cd, exprData, info);
			if (!addContainer) info.defContainer = "";
			else html.push('</div>');
		});
	}

	function _execInlineLayout($layout, html, options, controller, cp, cd, exprData, info) {
		var addContainer = !hasOnlyFields($layout);
		var tag = (addContainer ? 'div' : 'p');
		tag = "div";
		html.push('<' + tag + ' class="s-m-l-inline">');

		$layout.$items.forEach(function(item, index) {
			if ($layout.$sep) {
				html.push($helpers.htmlEncode(" "));
			}
			_execLayoutItem(item, html, options, controller, cp, cd, exprData, info);
		});
		html.push('</' + tag + '>');
	};
	var _mobileProps = function(css, item) {
		if (item.$theme) css.push("theme" + item.$theme);
		if (item.$styles) item.$styles.forEach(function(style) {
			if (style === "aside") {
				style = "ui-li-aside";
				style = "s-m-aside";
			}
			css.push(style);
		});
		if (item.$lines) css.push("s-line-" + item.$lines);
		if (item.$cssPrefix) {
			css.push("s-hasprefix");
		}

	};
	that.mobileExtentions = _mobileProps;

	function _articleArrayComposition2Layout($article, cp, filter, list) {
		var res = {
			cards: false,
			$items: []
		};
		var fn = [],
			fp = {};
		if (cp && cp.$properties) {
			// get list of  fields using prototype
			Object.keys(cp.$properties).forEach(function(pn) {
				if (filter && (filter.indexOf(pn) < 0)) return;
				var pi = cp.$properties[pn];
				if (pi.$isHidden || pi.$isExcluded) return;
				// ignore array fields
				//if (!$proto.uiCanGroupField(pi)) return; 
				fn.push(pn);
			});
		}
		var isCard = false;
		var ff = [];
		if ($article && ($article.$cards || $article.$layout)) {
			var child = null,
				isCard = false;
			if (list) {
				// try to use firstly $article.$layout
				child = ($article.$layout || $article.$cards);
				if (!$article.$layout) isCard = true;
			} else {
				// try to use firstly $article.$cards
				child = ($article.$cards || $article.$layout);
				if ($article.$cards) isCard = true;
			}

			var ff = [];
			_scanObj(child, function(o) {
				if (o.$bind) {
					if (fn.indexOf(o.$bind) >= 0) ff.push(o.$bind);
					return true;
				}
				return false;
			}, null, true);
		} else {
			ff = fn;
			// No detail link because all fields are displayed
			res.noDetailLink = true;
		}
		if (!isCard && (ff.length > 5)) {
			// too much columns to show them in a grid
			isCard = true;
		}
		res.cards = isCard;
		ff.forEach(function(pn) {
			var pi = cp.$properties[pn];
			var o = {
				$bind: pn
			};
			res.$items.push(o);

		});
		return res;
	}
	that.compositionLayout = _articleArrayComposition2Layout;

	function _execField(item, html, options, controller, cp, cd, exprData, info) {
		var css = [],
			labelAfter = false;
		//$theme: A-Z
		//$styles: ["aside", "u", "i"]
		//$lines: 1-3
		//$isTitle -- is a title ?
		var tag = "span";
		if (info.defContainer) tag = info.defContainer;
		var defTag = tag;
		if (item.$isTitle || (item.$bind === "$title" && (item.$isTitle !== false))) {
			tag = "h3";
			css.push("title");
		}
		_mobileProps(css, item);
		if (css.length || info.defContainer) {
			css.push("s-m-style");
			html.push('<' + tag + ' class="' + css.join(' ') + '">');
		}
		var exp = item.$bind;
		if (item.$expression) exp = item.$expression;
		else {
			if (exp && (exp.charAt(0) === "$")) exp = '{' + exp + '}';
		}
		var title = "",
			cssl,
			pi;
		if ((item.$isTitleHidden === false) && item.$bind) {
			if (cp && cp.$properties && cp.$properties[item.$bind]) {
				pi = cp.$properties[item.$bind];
				title = $proto.parseExpression(pi.$shortTitle || pi.$title, {
					data: null,
					$prototype: cp
				}, "$title", {
					html: true
				});
			}
			if (title) {
				if (item.$label) {
					cssl = ["s-m-style", "s-m-label"],
					$proto.auth.mobileExtentions(cssl, item.$label);
					labelAfter = item.$label.$after;
					if (!labelAfter) {
						html.push('<label class="' + cssl.join(' ') + '">');
						html.push(title);
						html.push('</label>');
					}
				} else html.push(title + ": ");
			}
		}
		var ev = $proto.parseExpression(exp, exprData, item.$bind || "", {
			html: true,
			list: true,
			onlyValue: false,
			keepBrackets: true,
			cssPrefix: (item.$cssPrefix ? "s-prefix" : "")
		});
		if (item.$cssPrefix && (typeof ev === "object")) {
			var cv = ev.value;
			if (item.$cssMap) cv = item.$cssMap[cv + ""];
			else if (item.$cssFunc) {
				try {
					var f = new Function("value", item.$cssFunc);
					f = f.bind(cd);
					cv = f(cv);
				} catch (e) {
					console.log(e);
				}
			} else {
				var dm = {
					"true": "green",
					"false": "red"
				};
				if (dm[cv + ""]) cv = dm[cv + ""];
			}

			html.push('<span class="s-indicator s-prefix-' + cv + '"></span>');
			if (ev.title) {
				html.push(ev.title);
			} else {
				if (cp && cp.$properties && cp.$properties[item.$bind]) {
					pi = cp.$properties[item.$bind];
					html.push($proto.parseExpression(pi.$shortTitle || pi.$title, {
						data: null,
						$prototype: cp
					}, "$title", {
						html: true
					}));
				}

			}
		} else html.push(ev);
		if (title && labelAfter) {
			html.push('<label class="' + cssl.join(' ') + '">');
			html.push(title);
			html.push('</label>');

		}
		if (css.length) html.push('</' + tag + '>');
	}

	function _execLayoutItem(item, html, options, controller, cp, cd, exprData, info) {
		var np, info = info || {};
		var layoutType = item.$layoutType;
		if (!layoutType && item.$items) layoutType = "stack";
		if (layoutType) {
			switch (layoutType) {
				case "stack":
				case "tabs":
					info.root = false;
					_execStackLayout(item, html, options, controller, cp, cd, exprData, info);
					break;
				case "inline":
					// for inline stacks
					info.root = false;
					_execInlineLayout(item, html, options, controller, cp, cd, exprData, info);
					break;
				case "row":
					info.root = false;
					_execRowlayout(item, html, options, controller, cp, cd, exprData, info);
					break;
			}
		} else if (item.$bind || item.$expression) {
			if (item.$format == "cards") {
				var layout = item.$cards.$layout;
				info.root = false;
				_execLayoutItem(layout, html, options, controller, cp, cd, exprData, info);
			} else {
				_execField(item, html, options, controller, cp, cd, exprData, info);
			}
		}
	}

	function _execListArticle($article, html, options, controller, cp, cd, layoutInfo) {
		//$article -- is $layout of item
		var cl = null;
		var $layout = $article;
		var consts = $helpers.ui.consts;
		var expData = {
			data: controller.exprData(cd),
			$prototype: cp
		};
		if (layoutInfo.$image) {
			html.push('<div class="' + consts.normal_image_list + '"');
			var icon = cd[layoutInfo.$image];
			if (icon) {
				if (icon.$value) {
					icon = "data:" + (icon.$contentType || "image/jpeg") + ";base64," + icon.$value;
				} else {
					var curl = icon.$url;
					if (!curl && cp.$properties && cp.$properties[layoutInfo.$image]) curl = cp.$properties[layoutInfo.$image].$url;
					if (curl) icon = $proto.parseExpression(curl, expData, "$image");
					else icon = null;

				}
				if (icon) html.push(' style="background-image: url(\'' + icon.replace(/'/g, "\\'") + '\'),  url(\'./mobile/images/no-image.png\')"');
			}
			html.push('></div>');

		}
		_execLayoutItem($layout, html, options, controller, cp, cd, expData, {
			root: true,
			list: true
		});
	};

	function _genContainerId(options) {
		options.iid++;
		var s = options.iid + "";
		while (s.length < 3) s = '0' + s;
		return 'c_' + s;

	}

	function _showfieldsInParent(item, content, options, cp, exprData, info, parentId) {
		var edit = (info.facet === "$edit") || (info.facet === "$create");
		if (item.$items) {
			if (_showfieldsInParent) item.$items.forEach(function(item) {
				var pi = cp.$properties[item.$bind];
				if (pi) {
					var cid = _genContainerId(options);
					if ($proto.uiCanGroupField(pi)) {
						content[cid] = {
							parent: parentId,
							"uiClass": "SingleField",
							data: {
								facet: info.facet,
								$bind: item.$bind,
								$article: $.extend(true, {}, item)
							}
						};
					} else {
						if (pi.$type === "application/x-array") content[cid] = {
							parent: parentId,
							"uiClass": "ArrayField",
							data: {
								jmdata: $proto.jqmDataArray(),
								facet: info.facet,
								field: {
									$bind: item.$bind,
									$type: pi.$type,
									$title: pi.$shortTitle || pi.$title,
									$proto: pi.$item
								},
								$article: $.extend(true, {}, item)
							}
						};
					}
				};
			});
		}
	};

	function _detailArticle2Design($article, content, cp, layoutInfo) {
		var options = {
			iid: 0
		};
		var expData = {
			data: null,
			$prototype: cp
		};
		return _layoutItem($article, content, options, cp, expData, layoutInfo, "root", null);
	};

	function _layoutStackItem(item, content, options, cp, exprData, info, parentId) {
		if (!item.$bind && !item.$items && item.$layout) {
			return _layoutItem(item.$layout, content, options, cp, exprData, info, parentId, item);
		}
		if (item.$items && item.$items.length) {
			if (item.$items[0].$bind) {
				_showfieldsInParent(item, content, options, cp, exprData, info, parentId);
			} else {
				item.$items.forEach(function(ci) {
					return _layoutItem(ci, content, options, cp, exprData, info, parentId, item);
				});
			}
		}
	}

	function _layoutTabItem(item, content, options, cp, exprData, info, parentId) {
		var tabs = [];
		item.$items.forEach(function(ii) {
			tabs.push($proto.parseExpression(ii.$title || "", exprData, "$title", {
				html: true
			}));
		});
		var ncid = _genContainerId(options);
		content[ncid] = {
			parent: parentId,
			layout: "TabsLayout",
			data: {
				tabs: tabs
			}
		};
		info.root = false;
		item.$items.forEach(function(ci, index) {
			return _layoutItem(ci, content, options, cp, exprData, info, ncid + '_' + index, item);
		});
	}

	function _layoutRowItem(item, content, options, cp, exprData, info, parentId) {
		var widths = _checkWidths(item);
		var ncid = _genContainerId(options);
		content[ncid] = {
			parent: parentId,
			layout: "RowLayout",
			data: {
				widths: widths,
				responsive: item.$responsive,
				theme: item.$theme
			}
		};
		info.root = false;
		item.$items.forEach(function(ci, index) {
			return _layoutItem(ci, content, options, cp, exprData, info, ncid + '_' + index, item);
		});
	}

	function _layoutItem(item, content, options, cp, exprData, info, parentId, parent) {
		if (!item) return;

		var layoutType = item.$layoutType,
			dd, ncid;

		if (!layoutType && item.$items) layoutType = "stack";
		var category = item.$category;
		// section with only one block use the block
		if ((category === "section") && item.$layout && item.$layout.$items && (item.$layout.$items.length === 1) && (item.$layout.$items[0].$category === "block")) {
			return _layoutItem(item.$layout.$items[0], content, options, cp, exprData, info, parentId, item.$layout);
		}
		// default layout type is stack
		if (!layoutType && item.$items) layoutType = "stack";
		if (!item.$bind && !item.$items && item.$layout && !category) {
			return _layoutItem(item.$layout, content, options, cp, exprData, info, parentId, item);
		}
		if (item.$category && !item.$title) {
			return _layoutItem(item.$layout, content, options, cp, exprData, info, parentId, item);
		}
		if (item.$category) {
			// layout 
			dd = {
				size: 6
			};
			var layoutClass = "CollapsibleLayout";
			if (item.$isTitleHidden || item.$isHeader) {
				if (item.$isHeader) dd.$isHeader = true;
				layoutClass = "Block";
			} else {
				if (item.$isBoxCollapsable == null) item.$isBoxCollapsable = true;
				dd.notCollapsable = !item.$isBoxCollapsable;
			}

			dd.jmdata = $proto.settings.CollapsibleLayout.jmdata(info.root);
			dd.text = ((!item.$isTitleHidden) && (item.$title === "-")) ? "" : $proto.parseExpression(item.$title, exprData, "$title", {
				html: true
			});
			if (item.$opened === false) dd.collapsed = true;
			ncid = _genContainerId(options);
			content[ncid] = {
				parent: parentId,
				layout: layoutClass,
				data: dd
			};

			info.root = false;
			return _layoutItem(item.$layout, content, options, cp, exprData, info, ncid, item);
		} else if (layoutType) {
			switch (layoutType) {
				case "stack":
					_layoutStackItem(item, content, options, cp, exprData, info, parentId);
					break;
				case "tabs":
					_layoutTabItem(item, content, options, cp, exprData, info, parentId);
					break;
				case "row":
					if (item.$responsive == null) {
						//not defined
						if (item.$items[0] && !item.$items[0].$bind) {
							item.$responsive = true;
						}
					}
					_layoutRowItem(item, content, options, cp, exprData, info, parentId);
					break;
			}
		} else if (item.$bind != null) {
			//ar pp = cp.$properties[item.$bind];
			//if (pp) {
			//	if (parent) _showfieldsInParent(parent, content, options, cp, exprData, info, parentId)
			//}
		}
	}
	that.sdi = _execListArticle;
	that.detailArt2design = _detailArticle2Design;

})(jQuery);