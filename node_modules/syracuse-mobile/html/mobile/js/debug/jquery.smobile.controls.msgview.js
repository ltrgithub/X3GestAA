"use strict";

(function($) {
	var that = $.smobile || {};
	$.smobile = that;
	var $helpers = $.helpers;

	that.controls.MsgView = {
		_additem: function(cd, htmlMsgs) {
			var title = (cd.title || "").trim();
			var msg = ((cd.data && cd.data.message) || "").trim();
			if (title.length == 0) {
				title = msg;
			}
			if (title.length == 0) return 0;
			var html = [];
			html.push('<li');
			var css = [],
				type = $helpers.error2Type(cd.type);
			css.push("ui-li-has-icon");
			css.push($helpers.ui.consts.normal_icon);
			css.push('s-error-' + type);
			if (css.length)
				html.push(' class="' + css.join(" ") + '"');
			html.push('>');
			html.push('<div class="s-error-ttl">');
			html.push($helpers.htmlEncode(title));
			if (msg.length > 0) {
				// #3050 Mobile - Edit mode - Action (Save) do not works if error dialog has been opned in a previous try
				// We display also the message (returned by X3 Errors) - Title is a general message 'Application exception')
				html.push('<div>');
				html.push($helpers.htmlEncode(msg));
				html.push('</div>');
			}
			html.push('</div>');
			html.push("</li>");
			var item = html.join('');
			if (htmlMsgs.indexOf(item) == -1) {
				// Filter duplicated messages
				htmlMsgs.push(item);
				return title.length + msg.length;
			} else {
				return 0;
			}
		},
		_renderMessage: function(controller) {
			var html = [];
			var data = $helpers.allMessages() || [];
			var infos = 0;
			var errors = 0;
			data.forEach(function(msg) {
				if (msg.type === $helpers.ERRORS.info || msg.type === $helpers.ERRORS.success) {
					infos++;
				} else {
					errors++;
				}
			});
			if (!$helpers.displayErrorAsMessage() && (infos > 0 && errors == 0)) {
				// We force display as top message if info only if not already enabled
				$helpers.setDisplayErrorAsMessage();
			}
			var $err = controller.$page.find('div[data-role="errorview"]').children("ul");
			if ($helpers.displayErrorAsMessage()) {
				var nbChars = 0;
				data.forEach(function(cd) {
					nbChars += that.controls.MsgView._additem(cd, html);
				});
				var timeout = 2000;
				// increase timeout with text size
				timeout += Math.min(Math.round(nbChars / 20) * 500, 5000);
				window.setTimeout(function() {
					$err.empty();
				}, timeout);
			}
			$err.html(html.join(''));
			// Before clearInfos
			if ($helpers.displayErrorAsMessage()) {
				$helpers.clearErrors();
			}
			$helpers.clearInfos();
		},
		handler: function(c, after) {
			after({
				html: '',
				bind: true
			});
		},
		refresh: function(controller) {
			that.controls.MsgView._renderMessage(controller);
			// Return null - No error message because already handled by this control
			return null;
		},
		events: function($c, c) {
			that.controls.MsgView._renderMessage(this);
		}
	};
})(jQuery);