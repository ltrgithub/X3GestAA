"use strict";

(function($) {
	var that = $.smobile || {};
	$.smobile = that;
	var $helpers = $.helpers;

	that.controls.MsgView = {
		_additem: function(cd, html) {
			var msg = (cd.title || "").trim();
			if (msg.length == 0 && cd.data) msg = (cd.data.message || "").trim();
			if (msg.length == 0) return;
			html.push('<li');
			var css = [],
				type = $helpers.error2Type(cd.type);
			css.push("ui-li-has-icon");
			css.push($helpers.ui.consts.normal_icon);
			css.push('s-error-' + type);
			if (css.length)
				html.push(' class="' + css.join(" ") + '"');
			html.push('>');
			html.push('<div class="s-error-ttl">' + $helpers.htmlEncode(msg) + '</div>');
			html.push("</li>");
		},
		sync: true,
		_buildItems: function(controller, id) {
			var html = [];
			var data = $helpers.allMessages() || [];
			var infos = 0,
				errors = 0;
			data.forEach(function(msg) {
				if (msg.type === $helpers.ERRORS.info || msg.type === $helpers.ERRORS.success) {
					infos++;
				} else {
					errors++;
				}
			});
			if (!$helpers.displayErrorAsMessage() && (infos > 0 && errors == 0)) {
				// We force display as top message if info only
				$helpers.setDisplayErrorAsMessage();
			}
			if ($helpers.displayErrorAsMessage()) {
				data.forEach(function(cd) {
					that.controls.MsgView._additem(cd, html);
				});
				window.setTimeout(function() {
					$('#' + id).empty();
				}, 2000);
			}
			return html;
		},
		handler: function(c, after) {
			var controller = this;
			var html = [];
			html.push('<ul id="' + c.id + '" data-theme="g" data-role="listview"');
			html.push(' data-inset="true" class="s-m-msginfo">');
			html.push(that.controls.MsgView._buildItems(controller, c.id).join(''));
			html.push('</ul>');
			this.hasMsgView = true;
			after({
				html: html.join(''),
				bind: true
			});
		},
		refresh: function(controller, options, $c, id) {
			$c.html(that.controls.MsgView._buildItems(controller, id).join(''));
			$c.listview('refresh');
			$helpers.clearInfos();
			// Return null - No error message because already handled by this control
			return null;
		},
		events: function($c, c) {
			$c.click(function(e) {
				var target = $helpers.getTarget(e);
				if (target) {
					var p = $(target).attr("data-action");
					if (p === "closeerrors") {
						$c.empty();

					}
				}
			});
		}
	};
})(jQuery);