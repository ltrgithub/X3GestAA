"use strict";
var fs = require('fs');

/*
 * 
 * The purpose of this function is to update the build date in jquery.smobile.resources.js and to copy
 * the default english translations from ./resources/strings-en.json into jquery.smobile.resources.js to be available as default language
 * 
 */
function translate(params, after){
	var newContent = "", path = './js/debug/jquery.smobile.resources.js';
	fs.readFile(params.src+ path, function (err, data) {
		if (err) {
			console.log(err);
			return;
			
		}
		var startd = '//#BUILDDATE_START';
		var endd = '//#BUILDDATE_END';

		var cd = new Date().toISOString();
		// Add build date to jquery.smobile.resources.js
		var content = data.toString(); 
		var sid = content.indexOf(startd);
		var eid = content.indexOf(endd);
		if (sid && eid && (eid > sid)) {
			var befored= content.substring(0, sid+startd.length) + "\n\t\t";
			var afterd = content.substring(eid);
			newContent = befored + 'Date.parseISO8601("' + cd + '")' + ';\n\t\t' + afterd; 
			
		}
		
		var startd = '//#BUILDDATE_STRING_START';
		var endd = '//#BUILDDATE_STRING_END';
		var sid = newContent.indexOf(startd);
		var eid = newContent.indexOf(endd);
		if (sid && eid && (eid > sid)) {
			var befored= newContent.substring(0, sid+startd.length) + "\n\t\t";
			var afterd = newContent.substring(eid);
			newContent = befored + '"' + cd + '"' + ';\n\t\t' + afterd; 
			
		}
		
		var versionInfoFile = 
			"\"use strict\";\nexports.versionInfo = {\n" +
			"	buildDateString: \"" + cd + "\"\n" + 
			"}\n";
		
		fs.writeFile(params.src + '../../lib/mobileVersionInfo._js', versionInfoFile, function (err) {
		     if (err) {
		    	 console.log(err);
		     } else {
				// Copy ./resources/strings-en.json into jquery.smobile.resources.js as default translation
				var start = '//#START';
				var end = '//#END';
				var si = newContent.indexOf(start);
				var ei = newContent.indexOf(end);
				if (si && ei && (ei > si)) {
					var before= newContent.substring(0, si+start.length) + "\n\r";
					var afterjson = newContent.substring(ei);
					fs.readFile(params.src+ './js/resources/strings-en.json', function (err, data) {
						if (err) {
							console.log(err);
						}
						else
						{
							newContent = before + data +";\n" + afterjson;  
							fs.writeFile(params.src+ './js/debug/jquery.smobile.resources.js', newContent, function (err) {
								if (err) {
									console.log(err);
								}
								if (after) after();
							});
						}
					});
				}
		     }
		});
		
	});	
}

exports.translate = translate;