var fs = require('fs');
var async = require('./async');

function parseFile(data, path){
	try{
		return JSON.parse(data);
	}catch(e){
		var s=e.message;
		if (e.stackTrace) s+="\n" + e.stackTrace;
		throw new Error("Error parsing file\n" + path + "\n" + s + "\n" + data)
	}
	
}
function translate(params, after){
	var aFileList = [], newContent = "", path = './js/debug/jquery.smobile.resources.js';
	fs.readFile(params.src+ path, function (err, data) {
		if (err) {
			console.log(err);
			return;
			
		}
		var startd = '//#BUILDDATE_START';
		var endd = '//#BUILDDATE_END';

		var content = data.toString(); 
		var sid = content.indexOf(startd);
		var eid = content.indexOf(endd);
		if (sid && eid && (eid > sid)) {
			var befored= content.substring(0, sid+startd.length) + "\n\t\t";
			var afterd = content.substring(eid);
			var cd = new Date().toISOString();
			newContent = befored + 'Date.parseISO8601("' + cd + '")' + '\n\t\t' + afterd; 
			
		}
			
		var start = '//#START';
		var end = '//#END';
		var si = content.indexOf(start);
		var ei = content.indexOf(end);
		if (si && ei && (ei > si)) {
			var before= content.substring(0, si+start.length) + "\n\r";
			
			var jsonContent = content.substring(si+1+start.length, ei);
			var locale = parseFile(jsonContent, path);
			var afterjson = content.substring(ei);
			async.each(params.languages, function (lang, callback) {	
				var filename = params.src+ './js/locale/mobile-'+lang+".json";
				fs.exists(filename, function (exists) {
					if (exists) {
						fs.readFile(filename, function (err, data) {
							if (err) {
								console.log("Reading file " + filename);
								console.log(err);
								return callback(null, "");
							}
							try {
								var json = parseFile(data.toString(), filename);
								if (lang === "en") {
									fs.writeFile(filename, JSON.stringify(json, null, '\t'), function (err) {
										console.log('Writting file "/js/locale/mobile-'+lang+'.json" ... done.');
										callback(null, "");
									});
									
								} else {
									var nlocale = JSON.parse(JSON.stringify(locale));
									
									Object.keys(nlocale).forEach(function(key) {
										var eno = nlocale[key];
										var old = json[key];
										if (typeof old !== "undefined") {
											if ((typeof eno === "object") && (typeof old === "object")) {
												Object.keys(eno).forEach(function(prop) {
													var tv = old[prop];
													if (typeof tv !== "undefined") {
														eno[prop] = tv;
													}
												});
											} else 
												nlocale[key] = old;
										}
									});		
									fs.writeFile(filename, JSON.stringify(nlocale, null, '\t'), function (err) {
										console.log('Writting file "/js/locale/mobile-'+lang+'.json" ... done.');
										 callback(null, "");
									});
								}
							} catch (ex) {
								console.log(ex);
							}
						})
					} else  callback(null, "");
				});
				
			}, function(err, results){
				if (newContent)  {
					fs.writeFile(params.src+ './js/debug/jquery.smobile.resources.js', newContent, function (err, data) {
						if (err) {
							console.log(err);
						}
						if (after) after();
					});		
				} else 
					if (after) after();
			})			
		}
		//console.log(data.toString());
	  //console.log(data);
	  //after();
	});	

}

exports.translate = translate;