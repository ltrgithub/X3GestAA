var fs = require("fs");
var lib = require("./manifest.js");
var tt = require("./translate.js");
var cc = require("./ClosureCompiler.js");

var d =new Date();
console.log("Build date : " + d.toLocaleDateString() + " - " + d.toLocaleTimeString());

function ccompile (options, after) {
	try{
		cc.compile(
			options.files,
			options.options,
			function(error, result) {
				if (result) {
					console.log('Compiling file "' + options.output + '" ...');
					fs.writeFile(options.output, result, function (err) {
						console.log('Writting file "' +options.output+ '" ... done.');
						if (after) after();
					});
				} else {
					console.log("Compile error");
					console.log(error);
				 }
			}
		);
	}catch(e){
		console.log("Pre-Compile error");
		console.log(e);
	}	
};
var buildtime = new Date().toISOString();
tt.translate({src: "../../../", buildtime: buildtime}, function() {
	
	ccompile({
		files: ['../../debug/initialize.js'],
		options: { warning_level: "VERBOSE",externs: ["../jquery.js"]},
		output: '../../initialize.min.js'
	}, function() {
		ccompile({
			files: ['../../debug/jquery.smobile.resources.js'],
			options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js"]},
			output: '../../jquery.smobile.resources.min.js'
		}, function() {
			ccompile({
				files: ['../../jquery/mobiscroll/js/dev/mobiscroll.core.js',
					'../../jquery/mobiscroll/js/dev/mobiscroll.datetime.js'
				],
				options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js", "../console.js"]},
				output: '../../jquery/mobiscroll/js/mobiscroll.custom-2.5.0.min.js'
			}, function() {
				ccompile({
					files: ['../../debug/jquery.smobile.static.ui.syracuse.js'],
					options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js", "../console.js"]},
					output: '../../jquery.smobile.syracuse.min.js'
				}, function() {
					ccompile({
						files: ['../../debug/jquery.smobile.helpers.js',
							'../../debug/jquery.smobile.auth.js',
							'../../debug/jquery.smobile.sdata.js',
							'../../debug/jquery.smobile.sdata.where.js',
							'../../debug/jquery.smobile.sdata.db.js',
							'../../debug/jquery.smobile.page.js',
							'../../debug/jquery.smobile.controller.js',
							'../../debug/jquery.smobile.layout.js',
							'../../debug/jquery.smobile.controls.js',
							'../../debug/jquery.smobile.controls.menu.js',
							'../../debug/jquery.smobile.controls.combo.js',
							'../../debug/jquery.smobile.controls.syncview.js',
							'../../debug/jquery.smobile.controls.appsview.js',
							'../../debug/jquery.smobile.dlgerrors.js',
							'../../debug/jquery.smobile.controls.edit.js',
							'../../debug/jquery.smobile.controls.picture.js',
							'../../debug/jquery.smobile.controls.text.js',
							'../../debug/jquery.smobile.controls.gauge.js',
							'../../debug/jquery.smobile.controls.arrayfield.js',
							'../../debug/jquery.smobile.controls.button.js',
							'../../debug/jquery.smobile.controls.checkbox.js',
							'../../debug/jquery.smobile.controls.listview.js',
							'../../debug/jquery.smobile.controls.singlefield.js',
							'../../debug/jquery.smobile.static.ui.js',
							'../../debug/jquery.smobile.highcharts.theme.js',
							'../../debug/jquery.smobile.controls.sdatalist.js',
							'../../debug/jquery.smobile.controls.msgview.js',
							'../../debug/jquery.smobile.controls.navbar.js',
							'../../debug/jquery.smobile.controls.lookup.js',
							'../../debug/jquery.smobile.controls.arrayxref.js',
							'../../debug/jquery.smobile.controls.arrayxobject.js',
							'../../debug/jquery.smobile.controls.arraystype.js',
							'../../debug/jquery.smobile.controls.sdataSorter.js',
							'../../debug/jquery.smobile.controls.sdataFilter.js',
							'../../debug/jquery.smobile.controls.appDashboard.js',
                            '../../debug/jquery.smobile.controls.templatesView.js',
							'../../debug/jquery.smobile.userProfile.js',
							'../../debug/load.js'
							],
						options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js", "../console.js", "../md5.js", "../highcharts.js"]},
						output: '../../jquery.smobile.fw.js'
					}, function() {
						lib.mkmanifest({
							filename : "mobile"
							,path : "../../../"
							,dst : "../../../../"
							,prefix : "./mobile"
							,version : "v1.0"
							,content : "/favicon.ico\n./moffline.html\n"
							,exclude : ['.*/[.].*', '.*/dev/.*','.*/build/.*', '.*/auth/.*', '.*/debug/.*', '\.cache.manifest','.*/flot/.*']
							,network : ['mobile.appcache\nmobile.html\n*']
							//,fallback : ['./mobile.html ./moffline.html']
						});
					}); 

				});
			});		
		}); 
		
	}); 
}); 



