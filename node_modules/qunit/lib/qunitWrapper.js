var QUnit = require('../support/qunit/qunit/qunit.js');

module.exports = function(options) {
	require('coffee-script/lib/coffee-script/extensions');
	if (options.etna) require('@sage/etna/lib/engine/register'); // must be before streamline!
	require('streamline').register(options.streamline);
	var globals = require('streamline-runtime').globals;
	if (options.tenantId != null) globals.context.tenantId = options.tenantId;

	var oldAsyncTest = QUnit.asyncTest;
	QUnit.asyncTest = function(testName, expected, callback) {
		if (arguments.length === 2) {
			callback = expected;
			expected = null;
		}

		callback = function(cb) {
			return oldAsyncTest(testName, expected, callback(cb));
		};
	};

	var oldStart = QUnit.start;
	QUnit.start = function() {
		if (!QUnit.config.currentModule) return;
		console.log('======> UNIT TEST', QUnit.config.currentModule.split('node_modules/').pop());

		if (typeof global.MAIN === "function") {
			require("@sage/etna/lib/supervisor/supervisor").create(function(err, superv) {
				if (err) throw err;
				require("@sage/etna/lib/engine/runtime/variables").initStack(superv);
				globals.context.x3frame.loc.file = options.code;
				global.MAIN(function(err) {
					if (err) throw err;
					oldStart();
				});
			}, "SUPERV");
		} else {
			oldStart();
		}
	};
};
