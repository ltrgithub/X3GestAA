"use strict";
const fs = require('fs');
const fsp = require('path');

const root = fsp.join(__dirname, '../../..');

function restructureFile(file, mod, depth) {
	const oldText = fs.readFileSync(file, 'utf8');
	var newText;
	if (depth > 0) {
		newText = oldText.replace(new RegExp('require\\((.)syracuse-(' + mod + ')/lib/', 'g'), 
			'require($1' + '../'.repeat(depth) + 'src/$2/');
	} else {
		newText = oldText.replace(/require\((.)\.\.\/((?:\.\.\/)+)src\//g, 'require($1$2/src/');
	}
	if (newText !== oldText) {
		console.log("saving " + file);
		fs.writeFileSync(file, newText, 'utf8');
	}
}

function restructureDir(dir, mod, depth) {
	fs.readdirSync(dir).forEach(name => {
		if (name === '.git') return;
		const f = fsp.join(dir, name);
		if (fs.lstatSync(f).isDirectory()) {
			restructureDir(f, mod, depth > 0 ? depth + 1 : 0);
		} else {
			if (/\._?[jt]s$/.test(name)) restructureFile(f, mod, depth);
		}
	})
}

const pkgName = process.argv[2];

restructureDir(fsp.join(root, 'node_modules'), pkgName, 1);
restructureDir(fsp.join(root, 'src/' + pkgName), pkgName, 0);
restructureDir(fsp.join(root, 'src'), pkgName, 1);