"use strict";

var X3Lint = require("etna/lib/lint/X3Lint").X3Lint;
var fs = require('streamline-fs');
var path = require('path');

var trace ;//= console.log;

function main(_) {
	trace && trace(process.argv);

	var root = process.argv[2];

	if(fs.stat(root, _).isFile()) {
		var name = path.basename(root);
		root = path.dirname(root);
		var lint =  new X3Lint(root,{update:6});
		lint.check(_,name.substring(0,name.lastIndexOf('.')));
	} else {
		var lint =  new X3Lint(root,{update:6});
		fs.readdirSync(root).filter(function(name) {
		 	return /^[^WXYZ]\w*.src$/.test(name);
		}).forEach_(_,function(_,name) {
			lint.check(_,name.substring(0,name.length-4));
		});	
	}

	trace && trace("\n");

	var keys;
	var errors = lint.getDiagnoses().reduce(function(r,diagnose){
		if(!keys) {
			keys = Object.keys(diagnose);
			r.push(keys.join(';'));
		}
		r.push(keys.reduce(function(r,key) {
			r.push(diagnose[key]);
			return r;
		},[]).join(';'));
		return r;
	},[]).join('\n');

	fs.writeFileSync(process.argv[3], errors,"utf8");
}

main(_);

process.exit(0);