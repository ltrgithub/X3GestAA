"use strict";
// var exec = require('child_process').exec;
var rules = require('tools/git/pre-commit-rules');

// rootDir is the root of the git repo on disk, regardless of where git commit was run from.
var rootDir = process.cwd();
// use child_process.spawn directly because exec does not always work
exports.exec = function(cmdline, callback) {
	var out = "";
	var err = "";
	var called = false;
	var args = cmdline.split(/ +/);
	var cmd = args.shift();
	var child = require('child_process').spawn(cmd, args);
	child.stdout.on('data', function(data) {
		out += data;
	});
	child.stderr.on('data', function(data) {
		err += data;
	});
	child.on('close', function(code) {
		if (called) return;
		called = true;		
		return callback(null, out, err);
	});
	child.on('error', function(error) {
		if (called) return;
		called = true;
		return callback(error);
	});
	
};



exports.exec('git diff --cached --name-only', function(err, stdout, stderr) {   // 
	if (err) throw err;
	if (stderr) throw new Error(stderr);
	var files = stdout.split('\n');
	files.forEach(rules.processFileSync);
	rules.finish();
});
