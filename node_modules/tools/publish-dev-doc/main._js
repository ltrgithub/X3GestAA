"use strict";
var fs = require('streamline-fs');
var path = require('path');
var ghm = require('ghm');

try {
	var config = require('./config.json');
} catch (ex) {
	console.log("config.json not found: edit paths in config-template.json and save as config.json");
	config = {};
}

function publish(_) {
	var devDocRoot = config.devDocRoot || (__dirname + "/../../../../dev-doc.wiki");
	var onlineDocRoot = config.onlineDocRoot || (__dirname + "/../../../../online-doc");
	var dest = onlineDocRoot + "/en-US/V7DEV";
	var pubdir = onlineDocRoot + "/public";

	function mkdir(_, s) {
		if (!fs.exists(s, _)) fs.mkdir(s, _);
	}

	function rm(_, s) {
		if (!fs.exists(s, _)) return;
		var stat = fs.stat(s, _);
		if (stat.isDirectory()) {
			fs.readdir(s, _).forEach_(_, function(_, f) {
				rm(_, s + '/' + f);
			});
			fs.rmdir(s, _);
		} else {
			fs.unlink(s, _);
		}
	}

	var all = [],
		pubs = [];
	rm(_, dest);
	mkdir(_, dest);
	mkdir(_, dest + '/css');
	mkdir(_, pubdir);
	fs.writeFile(dest + '/css/doc.css', fs.readFile(__dirname + '/doc.css', _), _);

	function fixName(s) {
		return s.replace(/:/g, '');
	}

	function transform(f, str, images) {
		// pre-processing - encode # inside code blocks because ghm messes them up
		// also ghm kills first code line if there is no space in it (weird)
		var body = str.split("```").map(function(block, i) {
			return i % 2 ? '\nCODECODE CODE' + block.replace(/\#/g, "_ha$h_") : block;
		}).join('```');

		// remove private sections
		body = body.replace(/<!--\s*private\s*start\s*-->([\S\s]*?)<!--\s*private\s*end\s*-->/gi, "");

		body = ghm.parse(body);
		// take care of <a href="wiki-page"> links
		body = body.replace(/<a href="([^#][^:."]+)">/g, function(a, p) {
			p = p.split('#');
			return '<a href="' + fixName(p[0]) + '.html' + (p[1] ? '#' + p[1] : '') + '">';
		});
		// take care of [[wiki page]] links
		body = body.replace(/\[\[([^\]\|]*)\|?([^\]]*)]]/g, function(a, p1, p2) {
			var href = (p2 || p1).replace(/ /g, '-'),
				pair = href.split('#');
			href = pair[0] + '.html' + (pair[1] ? '#' + pair[1] : '');
			return '<a href="' + fixName(href) + '">' + p1 + '</a>';
		});
		// collect images
		body = body.replace(/<img\s+src="([^"]+)"/g, function(a, p1) {
			images.push(p1);
			return a;
		});
		// decode # inside code blocks
		body = body.replace(/_ha\$h_/g, '#').replace(/CODECODE CODE\n/g, '');
		var title = f.replace(/-/g, ' ').replace(/\.md$/, '');

		function nav(tb) {
			return '<div class="nav ' + tb + '"><a href="index.html">Index</a>' + //
			'&nbsp;&nbsp;<a href="home.html">Home</a></div>';
		}
		body = '<p class="title">' + title + '</p>\n' + body;
		return '<html><head>' + //
		'<title>' + title + '</title>' + //
		'<meta charset="utf-8">' + //
		'<meta name="description" content="' + title + '">' + //
		'<meta name="module" content="Platform">' + //
		'<link href="css/doc.css" rel="stylesheet" type="text/css"/>' + //
		'<script type="text/javascript">\nfunction onload(){' + //
		'\n\twindow.focus();' + //
		'\n\twindow[window.history.pushState ? "onpopstate" : "onhashchange"] = function(event){ windows.focus(); };' + //
		'\n}\n</script>' + //
		'</head><body onload="onload()">' + nav('top') + body + '<br/>' + nav('bottom') + '</body></html>';
	}

	function doIt(_, s, f) {
		var stat = fs.stat(s, _);
		if (stat.isDirectory()) {
			fs.readdir(s, _).forEach_(_, function(_, f) {
				doIt(_, s + '/' + f, f);
			});
		} else if (/\.md$/.test(f)) {
			var source = fs.readFile(s, 'utf8', _);
			// exclude private files
			if (/<!--\s*private\s*-->/i.test(source)) {
				console.log("exclude private file: " + f);
				return;
			}
			all.push(f);
			var pub = /<!--\s*public\s*-->/i.test(source);
			if (pub) pubs.push(f);
			var images = [];
			var transformed = transform(f, source, images);
			fs.writeFile(dest + '/' + fixName(f).replace(/\.md$/, '.html'), transformed, 'utf8', _);
			if (pub) {
				fs.writeFile(pubdir + '/' + fixName(f).replace(/\.md$/, '.html'), transformed, 'utf8', _);
				images.forEach_(_, function(_, image) {
					fs.writeFile(pubdir + '/' + image, fs.readFile(path.dirname(s) + '/' + image, _), _);
				});
			}
		} else if (/\.(png|jpeg|jpg|gif)$/.test(s)) {
			fs.writeFile(dest + '/' + f, fs.readFile(s, _), _);
		} else {
			if (!/\.git/.test(s)) console.log(s + ': ignored');
		}
	}
	var images = [];
	doIt(_, devDocRoot);
	fs.writeFile(dest + '/index.html', transform('index.md', all.map(function(f) {
		return '* [[' + f.substring(0, f.length - 3).replace(/-/g, ' ') + ']]';
	}).join('\n')));
	fs.writeFile(pubdir + '/index.html', transform('index.md', pubs.map(function(f) {
		return '* [[' + f.substring(0, f.length - 3).replace(/-/g, ' ') + ']]';
	}).join('\n')));
}

publish(_);