"use strict";
var _static = require('node-static');
var file = new _static.Server('F:\\Syracuse\\syracuse\\online-doc');
var config = {"port": 80, "unsafe": false};

try {
	config = require('./config');
	var secure = require('./secure.js');
}
catch (err) {
	console.log("running unsecure");
	config.unsafe=true;
}

var port = config.port || 80;
var unsafe = config.unsafe || false;

function refused(response, status, reason) {
	response.writeHead(status, {
		"content-type": "text/plain"
	});
	response.end(reason);
}

function authorize(request, response) {
	return secure.auth (request, response, config);
}

require('http').createServer(function(request, response) {
	request.addListener('end', function() {
		if (config.unsafe || /^\/public\//.test(request.url) || authorize(request, response)) file.serve(request, response, function(err, result) {
			if (err) return refused(response, err.status || 500, err.message);
			else return refused(response, result.status, result.message);
		});
	}).resume();
}).listen(port);

console.log("server started on port " + port);