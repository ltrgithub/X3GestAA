"use strict";

var fs = require('streamline-fs');

var config = require('../../../nodelocal').config;
if (!config.metadata) throw new Error("config.metadata missing");

function runExporter(_) {
	var t0 = Date.now();
	var	trace = config.metadata.trace,
		testEntity = config.metadata.testEntity;

	var exporter = require("tools/metadata/exporter").newExporter(config.metadata);
	exporter.clean(_);
	exporter.init(_);

	var entityExporter = require("tools/metadata/export-entity");

	var entitiesPath = __dirname + "/entities/";
	if (testEntity) entityExporter.run(_, exporter, require(entitiesPath + testEntity).entity);
	else {
		fs.readdir(entitiesPath, _).forEach_(_, function(_, filename) {
			if (/(.*)\.(_js)/.test(filename)) {
				var entity = require(entitiesPath + filename).entity;
				entityExporter.run(_, exporter, entity);
			}
		});
	}
	trace && trace("All resources exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}

function runImporter(_) {
	var importer = require("tools/metadata/importer").newImporter(config.metadata);
	importer.init(_);
}

switch (process.argv[2]) {
	case '-i':
	case '--import':
		runImporter(_);
		break;
	default:
		runExporter(_);
}
