"use strict";

var fs = require('streamline-fs');
var tableEntity = require("tools/metadata/entities/tables").entity;

var objectTypes = ["", "DICTIONARY", "SCREENS", "OBJECTS", "DOCUMENTS", "DATATYPES", "ACTIONS", //
  "PARAMETERS", "ACTIVITYCODES", "FUNCTIONS", "MISC", "WINDOWS", "INQUIRIES", "BATCHTASKS", //
  "DASHBOARD", "WINDOWS", "FREE", "FREE", "FREE", "FREE", "DIMENSIONS", "REPORTS", //
	"TRANSACTIONTYPES", "STYLES", "REPORTS", "REPORTS"];
var entities = [null, null, "screens", "objects", null, "datatypes", "actions", //
	"parameters", "activitycodes", "functions", null, "windows", "inquiries", null,  //
	null, "windows", null, null, null, null, null, "reports", //
	null, null, null, null];

exports.run = function(_, exporter, text) {
	var t0 = Date.now();
	var getTableColumns = exporter.getTableColumns,
		executeSql = exporter.executeSql,
		trace = exporter.trace;

	var mainColumns = getTableColumns(_, text.tableName);
	var mainKey = exporter.buildKey(text.distinctKey);

	trace && trace(text.title + ": loading list");
	var names = executeSql(_, "select distinct " + mainKey + " from " + text.tableName + " order by " + mainKey);
	if (text.tableName === "ATEXTRA") {
		names.filter(function(elt) {
			return elt.CODFIC && tableEntity.excludedInitials.indexOf(elt.CODFIC[0]) < 0;
		});
	}

	names.forEach_(_, exporter.config.parallel || 4, function(_, elt, i) {
		trace && trace((i + 1) + "/" + names.length + ": exporting " + text.title + ": " + text.distinctKey.map(function(k) {
			return (text.tableName === "ATEXTE" && objectTypes[elt[k]] ? objectTypes[elt[k]] : elt[k]);
		}).join(' '));

		var data = executeSql(_, exporter.buildSql(mainColumns, text.tableName, text.distinctKey, text.orderBy), //
			exporter.buildParams(elt, text.distinctKey));
		var meta = null, res;

		switch (text.tableName) {
		case 'ATEXTRA':
			meta = executeSql(_, "select MODULE_0,CODACT_0 from ATABLE where CODFIC_0=:1", [elt.CODFIC || ''])[0];
			if (!meta) return;
			res = {
				path: exporter.moduleNames[meta.MODULE] + "/TEXTS/",
				name: elt.CODFIC,
			};
			break;

		case 'ATEXTE':
			// query all the resources for a given obj
			if (entities[elt.TYPOBJ] && fs.exists("../entities/" + entities[elt.TYPOBJ] + "._js")) {
				var entity = require("../entities/" + entities[elt.TYPOBJ]).entity;
				meta = executeSql(_,"select " +
					(entities[elt.TYPOBJ] === "parameters" ? "CHAPITRE_0,CODACT_0" : "MODULE_0,CODACT_0") //
					+ " from " + entity.tableName + " where " + entity.primaryKey + "_0=:1", //
					[(elt.NOMOBJ ? elt.NOMOBJ.replace(/'/g, '') : '')])[0];
			}
			res = {
				path: (meta ? (moduleNames[meta.MODULE] || (meta.CHAPITRE ? "CHAPTERS/" + meta.CHAPITRE : "GLOBAL")) : "GLOBAL") //
				+ "/" + (elt.TYPOBJ ? objectTypes[elt.TYPOBJ] : "MISC") + "/",
				name: elt.NOMOBJ || "_ALL_",
			}
			break;

		case 'APLSTD':
			res = {
				path: "GLOBAL/MENUS/",
				name: elt.LANCHP,
			}
			break;
		}

		// group by language
		var bylan = data.reduce(function(r, d) {
			(r[d[text.lan]] = r[d[text.lan]] || []).push(d);
			return r;
		}, {});
		Object.keys(bylan).forEach_(_, function(_, lan) {
			exporter.writeResource(!_, {
				path: res.path + lan,
				name: res.name,
				data: bylan[lan]
			});
		});
	});
	trace && trace(text.title + ": " + names.length + " exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
