"use strict";

var mergeInto = function (o1, o2) {
	if (o1 == null || o2 == null)
		return o1;
	for (var i in o2)
		if (o2.hasOwnProperty(i))
			o1[i] = o2[i];
	return o1;
}

exports.run = function(_, exporter) {
	var t0 = Date.now();
	var executeSql = exporter.executeSql,
		trace = exporter.trace;

	var ATEXTE_COLUMNS = getTableColumns(_, "ATEXTE");

	var objectTypes = ["DICTIONARY", "SCREENS", "OBJECTS", "DOCUMENTS", "DATATYPES", //
		"ACTIONS", "PARAMETERS", "ACTIVITYCODES", "FUNCTIONS", "MISC", //
		"WINDOWS", "INQUIRIES", "BATCHTASKS", "DASHBOARD", "WINDOWS", //
		"FREE", "FREE", "FREE", "FREE", "DIMENSIONS", "REPORTS", //
		"TRANSACTIONTYPES", "STYLES", "REPORTS", "REPORTS"];
	var tableNames = [null, "AMSK", "AOBJET", null, "ATYPE", //
		"ACTION", "ADOPAR", "ACTIV", "AFONCTION", null, //
		"AWINDOW", "ACONSULT", null, null, "AWINDOW", //
		null, null, null, null, null, "AREPORT", //
		null, null, null, null];

	trace && trace("loading list of texts");
	var TEXT_ELTS = executeSql(_, "select NUMERO_0,LAN_0,TYPOBJ_0,NOMOBJ_0 from ATEXTE order by NUMERO_0,LAN_0");

	TEXT_ELTS.forEach_(_, exporter.config.parallel || 4, function(_, elts, i) {
		trace && trace((i + 1) + "/" + TEXT_ELTS.length + ": exporting text definition " + elts.NUMERO_0 + " " //
		 + elts.LAN_0 + " " + elts.TYPOBJ_0 + " " + elts.NOMOBJ_0);

		var data = executeSql(_, "select " + ATEXTE_COLUMNS + " from ATEXTE where NUMERO_0='" //
				+ elts.NUMERO_0 + "' and LAN_0='" + elts.LAN_0 + "'")[0];
		if (tableNames[elts.TYPOBJ_0])
			data.META = executeSql(_, "select MODULE_0,CODACT_0 from " + tableNames[elts.TYPOBJ_0] //
				+ " where CODFIC_0='" + elts.NOMOBJ_0 + "'")[0];
		
		exporter.writeResource(!_, {
			path: (exporter.moduleNames[data.META.MODULE_0] || "GLOBAL") + (data.META.CODACT_0 || "STD") + "/" //
				+ objectTypes[data.TYPOBJ_0] + "/" + elts.LAN_0,
			name: elts.NOMOBJ_0,
			data: data
		});
	});
	trace && trace(TEXT_ELTS.length + " texts exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
