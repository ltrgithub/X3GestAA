"use strict";

var fs = require('streamline-fs');

exports.run = function(_, exporter) {
	var t0 = Date.now();
	var executeSql = exporter.executeSql,
		trace = exporter.trace;

	var ATEXTE_COLUMNS = exporter.getTableColumns(_, "ATEXTE");

	var objectTypes = ["", "DICTIONARY", "SCREENS", "OBJECTS", "DOCUMENTS", "DATATYPES", "ACTIONS", //
	  "PARAMETERS", "ACTIVITYCODES", "FUNCTIONS", "MISC", "WINDOWS", "INQUIRIES", "BATCHTASKS", //
	  "DASHBOARD", "WINDOWS", "FREE", "FREE", "FREE", "FREE", "DIMENSIONS", "REPORTS", //
		"TRANSACTIONTYPES", "STYLES", "REPORTS", "REPORTS"];
	var entities = [null, null, "screens", "objects", null, "datatypes", "actions", //
		"parameters", "activitycodes", "functions", null, "windows", "inquiries", null,  //
		null, "windows", null, null, null, null, null, "reports", //
		null, null, null, null];

	trace && trace("loading list of atext");
	var TEXT_ELTS = executeSql(_, "select distinct TYPOBJ_0,NOMOBJ_0 from ATEXTE order by TYPOBJ_0,NOMOBJ_0");

	TEXT_ELTS.forEach_(_, exporter.config.parallel || 4, function(_, elt, i) {
		// trace && trace((i + 1) + "/" + TEXT_ELTS.length + ": exporting text definition " //
		// 	+ objectTypes[elt.TYPOBJ] + " " + elt.NOMOBJ);

		var meta = null;		
		if (entities[elt.TYPOBJ] && fs.exists("../entities/" + entities[elt.TYPOBJ] + "._js")) {
			var entity = require("../entities/" + entities[elt.TYPOBJ]).entity;
			meta = executeSql(_,"select " +
				(entities[elt.TYPOBJ] === "parameters" ? "CHAPITRE_0,CODACT_0" : "MODULE_0,CODACT_0") //
				+ " from " + entity.tableName + " where " + entity.primaryKey + "_0=:1", //
				[(elt.NOMOBJ ? elt.NOMOBJ.replace(/'/g, '') : '')])[0];
		}
		// query all the resources for a given obj
		var data = executeSql(_, "select " + ATEXTE_COLUMNS + " from ATEXTE where TYPOBJ_0=:1 " //
				+ " and NOMOBJ_0=:2 order by LAN_0", [elt.TYPOBJ || 0, elt.NOMOBJ || '']);

		// group them by language
		var bylan = data.reduce(function(r, d) {
			(r[d.LAN] = r[d.LAN] || []).push(d);
			return r;
		}, {});
		Object.keys(bylan).forEach_(_, function(_, lan) {
			exporter.writeResource(!_, {
				path: (meta ? (exporter.moduleNames[meta.MODULE] || (meta.CHAPITRE ? "CHAPTERS/" //
					+ meta.CHAPITRE : "GLOBAL")) : "GLOBAL") //
				 + "/" + (elt.TYPOBJ ? objectTypes[elt.TYPOBJ] : "MISC") + "/" + lan,
				name: elt.NOMOBJ || "_ALL_",
				data: bylan[lan]
			});
		})

	});
	trace && trace(TEXT_ELTS.length + " texts exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
