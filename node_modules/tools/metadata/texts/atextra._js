"use strict";

var tableEntity = require("tools/metadata/entities/tables").entity;

exports.run = function(_, exporter) {
	var t0 = Date.now();
	var executeSql = exporter.executeSql,
		trace = exporter.trace;

	var ATEXTRA_COLUMNS = exporter.getTableColumns(_, "ATEXTRA").filter(function(col) {
			return col !== 'CODFIC_0';
		});

	trace && trace("loading list of atextra");
	var TEXT_ELTS = executeSql(_, "select distinct CODFIC_0,LANGUE_0 from ATEXTRA").filter(function(elt) {
		return elt.CODFIC && tableEntity.excludedInitials.indexOf(elt.CODFIC[0]) < 0;
	});

	TEXT_ELTS.forEach_(_, exporter.config.parallel || 4, function(_, elt, i) {
		false && trace && trace((i + 1) + "/" + TEXT_ELTS.length + ": exporting text definition " + elt.CODFIC + " " + elt.LANGUE);

		var data = executeSql(_, "select CODFIC_0,MODULE_0,CODACT_0 from ATABLE where CODFIC_0=:1", [elt.CODFIC || ''])[0];
		if (!data) {
			trace && trace("WARNING! ATABLE record not found for " + elt.CODFIC + " (" + elt.LANGUE + ")");
			return;
		}
		data.TEXTS = executeSql(_, "select " + ATEXTRA_COLUMNS + " from ATEXTRA where CODFIC_0=:1 and" //
			+ " LANGUE_0=:2 order by ZONE_0,IDENT1_0,IDENT2_0", [elt.CODFIC || '', elt.LANGUE || '']);
		
		exporter.writeResource(!_, {
			path: exporter.moduleNames[data.MODULE] + "/TEXTS/" + elt.LANGUE,
			name: elt.CODFIC,
			data: data
		});
	});
	trace && trace(TEXT_ELTS.length + " texts exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
