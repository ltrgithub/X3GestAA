"use strict";

exports.run = function(_, exporter) {
	var t0 = Date.now();
	var executeSql = exporter.executeSql,
		trace = exporter.trace;

	var APLSTD_COLUMNS = exporter.getTableColumns(_, "APLSTD");

	trace && trace("loading list of aplstd");
	var TEXT_ELTS = executeSql(_, "select distinct LANCHP_0 from APLSTD order by LANCHP_0");

	TEXT_ELTS.forEach_(_, exporter.config.parallel || 4, function(_, elt, i) {
		 trace && trace((i + 1) + "/" + TEXT_ELTS.length + ": exporting aplstd definition " + elt.LANCHP_0);
		 var data = executeSql(_, "select " + APLSTD_COLUMNS + " from APLSTD where LANCHP_0=:1 order by LAN_0,LANNUM_0", [elt.LANCHP_0 || 0]);

		// group them by language
		var bylan = data.reduce(function(r, d) {
			(r[d.LAN_0] = r[d.LAN_0] || []).push(d);
			return r;
		}, {});
		Object.keys(bylan).forEach_(_, function(_, lan) {
			exporter.writeResource(!_, {
				path: "GLOBAL/STD/APLSTD/" + lan,
				name: elt.LANCHP_0,
				data: bylan[lan]
			});
		});
	});
	trace && trace(TEXT_ELTS.length + " resources exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
