"use strict";
var fs = require("streamline-fs");

exports.newImporter = function(config) {
	var trace = config.trace;
	var db = config.importDb;
	if (!db) throw new Error("config.importDb missing");
	var pool = require("./connectionPool").create(db, trace);

	var jsondir = config.output || __dirname + "/../../../../x3meta";

	function scanDirs(_, type, body) {
		fs.readdir(jsondir, _).forEach_(_, function(_, d) {
			var moduleDir = jsondir + "/" + d;
			if (fs.stat(moduleDir, _).isDirectory()) {
				fs.readdir(moduleDir, _).forEach_(_, function(_, d) {
					var actDir = moduleDir + "/" + d;
					var typeDir = actDir + "/" + type;
					if (fs.stat(actDir, _).isDirectory() && fs.exists(typeDir, _)) {
						fs.readdir(typeDir, _).filter(function(name) {
							return /\.json$/.test(name);
						}).forEach_(_, function(_, name) {
							body(_, name.substring(0, name.length - 5), typeDir + "/" + name);
						});
					}
				});
			}
		});
	}
	var tableFiles;
	return {
		init: function(_) {
			tableFiles = {};
			scanDirs(_, "TABLES", function(_, name, file) {
				tableFiles[name] = file;
			});
			console.log(tableFiles);
		}
	}
}
