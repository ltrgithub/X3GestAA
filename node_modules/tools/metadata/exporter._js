"use strict";

var fs = require('streamline-fs');
var flows = require('streamline/lib/util/flows');

exports.newExporter = function(config) {
	var db = config.db;
	if (!db) throw new Error("config.db missing");
	if (db.driver !== "oracle") throw new Error("unsupported db driver: " + db.driver);

	var outdir = config.output || __dirname + "/../../../../x3meta";

	var trace = config.trace;

	var fsFunnel = flows.funnel(1);

	function mkdir(_, s) {
		if (!fs.exists(s, _)) {
			fsFunnel(_, function(_) {
				if (!fs.exists(s, _)) fs.mkdir(s, _);
			});
		}
	}

	function rm(_, s) {
		if (!fs.exists(s, _)) return;
		var stat = fs.stat(s, _);
		if (stat.isDirectory()) {
			fs.readdir(s, _).forEach_(_, function(_, f) {
				rm(_, s + '/' + f);
			});
			fs.rmdir(s, _);
		} else {
			fs.unlink(s, _);
		}
	}

	var pool = [];

	function withConnection(_, body) {
		var cnx = pool.pop();
		if (!cnx) {
			trace && trace("connecting ...");
			cnx = require(db.driver).connect(db, _);
			cnx.setPrefetchRowCount(1000);
		}
		try {
			return body(_, cnx);
		} finally {
			pool.push(cnx);
		}
	}

	function trim(obj) {
		return Object.keys(obj).reduce(function(o, k) {
			var v = obj[k];
			if (v instanceof Date) {
				v = v.toISOString();
				if (/T00\:00\:00\.000Z$/.test(v)) {
					v = v.substring(0, v.length - 14);
					if (v === '1599-12-31') v = null;
				}
			}
			if (/^CAST\(AUUID_0/.test(k)) k = "AUUID_0";
			if (v && v !== ' ') o[k] = v;
			return o;
		}, {});
	}

	function executeSql(_, stmt, args) {
		//trace && trace("SQL: " + stmt);
		return withConnection(_, function(_, cnx) {
			return cnx.execute(stmt, args || [], _).map(trim);
		});
	}

	return {
		config: config,
		trace: trace,
		clean: function(_) {
			trace && trace("cleaning output");
			mkdir(_, outdir);
			fs.readdir(outdir, _).forEach_(_, function(_, name) {
				if (name !== '.git') rm(_, outdir + '/' + name);
			});
		},
		init: function(_) {

			function getFolderType(_) {
				trace && trace("getting folder type");
				return parseInt(executeSql(_, "select VALEUR_0 from ADOVAL where PARAM_0='TYPDOS'")[0].VALEUR_0, 10);
			}

			var isX3 = getFolderType(_) === 1;

			if (!config.force) throw new Error("Bad folder type: " + getFolderType(_));
		},
		moduleNames: ["UNKNOWN", "SUPERV", "FINANCE", "BP", "EXTERNAL", //
		"SALES", "PURCHASES", "STOCKS", "CAPM", "COMMON", //
		"DEV", "INTERNAL", "SUPPORT", "MARKETING", "FA", //
		"HR", "SPE1", "SPE2", "SPE3", "SPE4", //
		"TALENT"],
		getTableColumns: function(_, tableName) {
			trace && trace("loading columns for " + tableName);
			return executeSql(_, "select CODZONE_0, DIME_0 from ATABZON where CODFIC_0='" + tableName + "' order by CODZONE_0").map(function(elt) {
				var arr = [];
				for (var i = 0; i < elt.DIME_0; i++) {
					var s = elt.CODZONE_0 + '_' + i;
					if (s === "AUUID_0") s = "CAST(AUUID_0 as varchar2(32))"; // hack to get around unsupported datatype in driver
					arr.push(s);
				}
				return arr.join(',')
			}).join(',')
		},
		executeSql: executeSql,
		writeResource: function(_, res) {
			var d = outdir;
			res.path.split('/').forEach_(_, function(_, s) {
				mkdir(_, d = d + "/" + s);
			})
			fs.writeFile(d + "/" + res.name + ".json", JSON.stringify(res.data, null, '\t'), "utf8", _);
		}
	};
}