"use strict";

exports.run = function(_, exporter, entity) {
	var t0 = Date.now();
	var getTableColumns = exporter.getTableColumns,
		executeSql = exporter.executeSql,
		writeResource = exporter.writeResource,
		trace = exporter.trace;

	var mainColumns = getTableColumns(_, entity.tableName).join(',');
	var mainKey = entity.primaryKey;
	var childrenCols = Object.keys(entity.children).reduce_(_, function(_, r, childName) {
		var child = entity.children[childName];
		r[childName] = getTableColumns(_, child.tableName).filter(function(col) {
			return col !== (child.parentKey || mainKey);
		}).join(',');
		return r;
	}, {});

	trace && trace(entity.title + ": loading list");
	var names = executeSql(_, "select " + mainKey + " from " + entity.tableName + " order by " + mainKey).map(function(elt) {
		return elt[mainKey];
	}).filter(function(s) {
		return entity.excludedInitials.indexOf(s[0]) < 0;
	});

	names.forEach_(_, exporter.config.parallel || 4, function(_, name, i) {
		// trace && trace((i + 1) + "/" + names.length + ": exporting " + entity.title + ": " + name);
		var data = executeSql(_, "select " + mainColumns + " from " + entity.tableName + " where " + mainKey + "='" + name + "'")[0];
		Object.keys(entity.children).forEach_(_, function(_, childName) {
			var child = entity.children[childName];
			var parentKey = child.parentKey || mainKey;
			data[childName] = executeSql(_, "select " + childrenCols[childName] + //
				" from " + child.tableName + " where " + parentKey + "='" + name + "'" + //
				(child.orderBy ? " order by " + child.orderBy : ""));
		});
		exporter.writeResource(!_, {
			path: (exporter.moduleNames[data.MODULE_0] || data.CHAPITRE_0 ? "GLOBAL/" + data.CHAPITRE_0 : "GLOBAL") //
				+ "/" + (data.CODACT_0 || "STD") + "/" + entity.subdir,
			name: name,
			data: data
		});
	});
	trace && trace(entity.title + ": " + names.length + " resources exported in " + Math.round((Date.now() - t0) / 1000) + " seconds");
}
