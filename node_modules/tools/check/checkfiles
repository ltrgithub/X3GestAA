#!/usr/bin/env _node

"use strict";
var fs = require("fs");
var JSHINT = require("jshint").JSHINT;
var jsb = require('js-beautify').js_beautify;

var binExts = [".png", ".ico", ".msi", ".exe", ".xlsx", ".mdp", ".as", ".dll", ".pdb", ".cache", //
".jpg", ".jpeg", ".swf", ".doc", ".dfont", ".gif", ".pdf", ".zip", ".ttc", ".ttf", ".db", //
".ds_store", ".o", ".node", ".eot", ".woff", ".otf", ".ppt", ".xls", ".p12"];

var CR = '\r'.charCodeAt(0);
var LF = '\n'.charCodeAt(0);

var ignoreHeaders = ["var z = require('x3-engine/lib"];

function checkFile(_, path, buf) {
	if (/\/node_modules\/.*?\/(node_modules|deps)\//.test(path)) return;
	var source = buf.toString("utf8");
	if (ignoreHeaders.some(function(header) {
		return source.substring(0, header.length) === header;
	})) return;

    var buf1 = new Buffer(source, "utf8");
    if (buf1.length !== buf.length)
    	console.log(path + ": no UTF8");
	else
    for (var i = buf.length-1; i>= 0; i--) {
        if (buf[i] !== buf1[i]) {
        	console.log(path + ": No UTF8");
        	break;
        }
    }
	var bom = buf[0] === 0xEF && buf[1] == 0xBB && buf[2] === 0xBF;
	var line = 1;
	if (!bom) {
		// may enforce BOM later
		//console.log(path + ":" + line + ": BOM missing");
	}
	for (var i = 0, len = buf.length; i < len; i++) {
		var ch = buf[i];
		if (ch === CR) {
				console.log(path + ":" + line + ": CR");
			return;
		} else if (ch === LF) {
			line++;
		}
	}
	if (/._?js$/.test(path)) {
		var modified = false;
		if (!JSHINT(source, {
			es5: true,
			eqnull: true,
			expr: true,
		})) {
			var remain = [];
			var lines = source.split(/\r?\n/);
			JSHINT.data().errors.forEach(function(err) {
				if (!err) return;
				var line = lines[err.line - 1];
				if (/^Missing semicolon/.test(err.reason) && !/[;:\{]$/.test(line)) {
					lines[err.line - 1] += ';';
					modified = true;
				}
			});
			if (modified) {
				console.log(path + ": fixed semicolons");
				source = lines.join('\n');
			}
			remain = remain.map(function(err) {
				return '\t' + err.line + ':' + err.character + '\t' + err.reason;
			});
			if (remain.length) console.log(path + ': does not pass jshint\n' + errors.join('\n'));
		}
		var beautified = jsb(source, {
			'indent_size': 1,
			'indent_char': '\t'
		});
		beautified = beautified.replace(/(\n\t*\n)(\t*\n)*/g, function(all, keep) { return keep; });
		if (beautified !== source) {
			console.log(path + ": beautified");
			source = beautified;
			modified = true;
		}
		if (modified) fs.writeFile(path, source, 'utf8', _);
	}
}

function scan(_, f, force) {
	if (!force && !/node_modules\/(syracuse|streamline-|jsntlm|jsurl|jsx509|js-xml|msoffice)/.test(f)) return;
	if (f.indexOf('socket.io/support/expresso/deps/jscoverage/tests') >= 0 //
	|| f.indexOf('/JSCover/') >= 0 //
	|| f.indexOf('/dotnet/') >= 0 //
	|| f.indexOf('/jquery/') >= 0 //
	|| f.indexOf('/build/') >= 0 //
	|| f.indexOf('/syracuse-ui/themes/') >= 0 //
	|| f.indexOf('.min.js') >= 0 //
	|| f.indexOf('/jquery.smobile.fw.js') >= 0 //
	|| f.indexOf('/junk/') >= 0) return;
	var stat = fs.lstat(f, _);
	if (stat.isDirectory()) {
		fs.readdir(f, _).forEach_(_, function(_, n) {
			if (n !== '.git' && n !== '.svn') scan(_, f + "/" + n);
		});
	} else if (!stat.isSymbolicLink()) {
		var ext = f.substring(f.lastIndexOf('.')).toLowerCase();
		if (binExts.indexOf(ext) < 0) {
			var data = fs.readFile(f, _);
			checkFile(_, f, data);
		}
	}
}

var root = require('path').join(__dirname, '../..', process.argv[2] || '.');
try {
	scan(_, root, true);
} catch (ex) {
	console.error("ERROR: " + ex.stack);
}
