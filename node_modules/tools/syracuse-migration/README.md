# Syracuse server migration tool

The Syracuse server migration tool allows to duplicate Syracuse environment from a server to another with modification on the fly.  

This tool can be executed everywhere on the network (on source environment, on destination environment or equally on third party machine...).  

There are two main steps that would be applied when the tool will be run :
* The duplication of the source server database using mongodump and mongorestore commands.
* The modification of several entries in the destination mongodb database (X3 solutions configuration, Endpoints, Hosts entries and deletion of certificates.

**IMPORTANT**: This tools never modifies the source server database. It can be used safety in order to duplicate stable environment to a target server.

## Pre-requisites

* The destination Syracuse server should be stopped before running this tool.
* It is essential to generate certificates using the standard certificate generation tool provided with Syracuse, before or after using this tool on destination server.
* The passphrase of host certificate should be entered again on destination environment (using shell script provided with Syracuse) after running this tool.

## How to run the tool

To run the tool, execute inside bin directory of Syracuse folder the following command :

On Linux system :  

``` sh
   linux_x64/node node_modules/tools/syracuse-migration
```

On windows system :  
```cmd
   win32_x64\node.exe node_modules\tools\syracuse-migration
```

Configuration file can be parameterized :  

```
   node node_modules/tools/syracuse-migration [param]
   param can be:
        `--config` to specify yaml configuration file path
```

## Configuration file

A template configuration file is delivered in node_modules/tools/syracuse-migration named config-template.yml.  
The file format is YAML. Please see official [YAML specification](http://www.yaml.org/spec/1.2/spec.html) for more information.  

### Logs definition section

This section contains only one entry that allows to define where mongodump and mongorestore commands outputs would be stored.

```yaml
   # logsDir defines where dump and restore logs files will be stored. It can be relative or absolute path
   logsDir: ..\..\..\logs
```

### MongoDB section

This section is essentially used for mongodump and mongo restore commands, but not only ! The final connection used to modify entries is also based on the destination server parameters...

It is important to understand that all parameters usable with [mongodump](https://docs.mongodb.com/manual/reference/program/mongodump/) command can be set in `source` sub-section, and all parameters usable with [mongorestore](https://docs.mongodb.com/manual/reference/program/mongorestore/) command can be set in `destination` sub-section.  
For instance it is possible to define SSL parameters for the destination server but not for the source server.  

```yaml
  # mongodb section defines parameters use for dump and restore operations
  mongodb:
    # This `path` property is mandatory and indicates where mongodb client software is installed
    path: C:\mongodb-win32-x86_64-2008plus-2.6.0
    # This `out` property indicates where the dumps will be stored
    out: C:\dumps
    # The `dump` section accepts all mongodump standard parameters
    # See https://docs.mongodb.com/manual/reference/program/mongodump/
    source:
      host: my-source-server
      port: 27017
      db: syracuse
    # The `restore` section accepts all mongorestore standard parameters
    # See https://docs.mongodb.com/manual/reference/program/mongorestore/
    destination:
      host: my-destination-server
      port: 27017
      db: syracuse
      # the following ssl properties are mandatory only if your mongodb server is secured with ssl (same thing can be applied to source server)
      ssl: true
      sslCAFile: D:\keystore\ca.cacrt
      sslPEMKeyFile: D:\keystore\client.pem
      sslPEMKeyPassword: MyPassphrase
      #sslAllowInvalidCertificates: true
```


### X3 solution section

This section can be totally omitted if the destination environment has to be configured identically to the source server in term of X3 solutions / runtimes.  
If some adjustment are necessary, it is possible to redefine all or partially the X3 solutions configurations  that are set on source environment.  
If a new solution is defined, it is really mandatory to redefine all X3 runtimes explicitly for this solution.

Be careful with the `-` symbol that allow to defines arrays of entries...  

```yaml
  # x3solutions section defines the new X3 configuration solution
  x3solutions:
    # `-` character allows to declare multiple solutions
    - solutionToModify: SRC_X3SOLUTION # The solution `code` configured on source server you want to modify on destination server
      newSolution:
        code: NEW_CODE_FOR_SOLUTION
        description: SRC_X3SOLUTION modified with migration tool
        solutionName: DEST_SOLUTION
        serverHost: my-destination-x3-server
        serverPort: 17000
        serverTimeout: 60000
        webServer: '' # let empty if same as serverHost
        webServerPort: 80
        proxy: false
        runtimes:
          # `-` character allows to declare multiple runtimes
          # only serverHost and serverPort are mandatory !
          - serverHost: my-destination-x3-server.mydomain.com
            serverPort: 17000
            tag: MAIN
            exclusive: false
            banTimeout: 60
            banned: false
            disabled: false
          - serverHost: my-destination-x3-server-2.mydomain.com
            serverPort: 17001
            disabled: true
```

### Endpoints section

In the same way as for X3 solutions, it is possible to redefine endpoints configuration, for instance in order to change the name of the target X3 folder.  
Only `dataset`, `x3ServerFolder` and `description` properties can be modified.  

```yaml
  # endpoints section defines the new endpoints
  endpoints:
    # `-` character allows to declare multiple endpoints
    - endpointToModify: SEED # The endpoint `dataset` (name) configured on source server you want to modify on destination server
      newEndpoint:
        dataset: SEEDTEST
        x3ServerFolder: MYSEED
        description: SEED modified with migration tool
```


### Hosts section

This section defines the new destination server hostname used by Syracuse application that is essential to get correct behavior...  

```yaml
  # hosts section defines new host instances configuration changes. It will be also used to rename certificates.
  #   'hostnameToModify' and 'hostname' are mandatory !
  # WARNING about certificate: the new certificates on destination server have to be generated using the standard certificate tool.
  hosts:
    - hostnameToModify: my-source-server # The source server hostname will be used to find and replace host information
      hostname: my-destination-server # This is the destination server hostname
      children: 2 # Number of children processes
      wsChildren: 1 # Number of children processes dedicated for SOAP web services
```
