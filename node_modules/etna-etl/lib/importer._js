"use strict";
var fs = require("streamline-fs");

exports.newImporter = function(config) {
	var trace = config.trace;
	var jsondir = config.dir;

	function readFile(_, path) {
		return JSON.parse(fs.readFile(path, 'utf8', _));
	}

	return function init(_) {
		var files = {
			TEXTS: [],
			MENUS: []
		};
		fs.readdir(jsondir, _).forEach_(_, function(_, module) {
			var moduleDir = jsondir + "/" + module;
			if (fs.stat(moduleDir, _).isDirectory()) {
				fs.readdir(moduleDir, _).forEach_(_, function(_, type) {
					var typeDir = moduleDir + "/" + type;
					if (fs.stat(typeDir, _).isDirectory()) {
						var entries = fs.readdir(typeDir, _);
						entries.filter(function(name) {
							return (/\.json$/).test(name);
						}).forEach_(_, function(_, name) {
							files[type] = files[type] || {};
							files[type][name.substring(0, name.length - 5)] = typeDir + "/" + name;
						});
						entries.filter(function(name) {
							return (/^\w\w\w$/).test(name);
						}).forEach_(_, function(_, lan) {
							fs.readdir(typeDir + "/" + lan, _).filter(function(name) {
								return (/\.json$/).test(name);
							}).forEach_(_, function(_, name) {
								var dest = type === "MENUS" ? files.MENUS : files.TEXTS;
								dest.push(typeDir + "/" + lan + "/" + name);
							});
						});
					}
				});
			}
		});
		return require("./store-" + (config.store || "oracle")).newStore(config, files, readFile);
	};
};
