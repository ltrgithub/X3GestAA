"use strict";
QUnit.module(module.id);
var ez = require("ez-streams");
var fs = require("streamline-fs");

asyncTest("rss feed", 5, function(_) {
	var entries = ez.devices.file.text.reader(__dirname + '/../fixtures/rss-sample.xml') //
	.transform(ez.transforms.cut(2)) //
	.transform(ez.transforms.xml.parser("rss/channel/item")).toArray(_);
	strictEqual(entries.length, 10);
	strictEqual(entries[0].rss.channel.title, "Yahoo! Finance: Top Stories");
	strictEqual(entries[0].rss.channel.item.title, "Wall Street ends down on first trading day of 2014");
	strictEqual(entries[9].rss.channel.title, "Yahoo! Finance: Top Stories");
	strictEqual(entries[9].rss.channel.item.title, "2013's big winners abandoned 'safety' and bet on central bankers");
	start();
});

asyncTest("rss roundtrip", 1, function(_) {
	var expected = fs.readFile(__dirname + '/../fixtures/rss-sample.xml', 'utf8', _);
	var result = ez.devices.file.text.reader(__dirname + '/../fixtures/rss-sample.xml') //
	.transform(ez.transforms.cut(5)) //
	.transform(ez.transforms.xml.parser("rss/channel/item")) //
	.transform(ez.transforms.xml.formatter({ tags: "rss/channel/item", indent: "  "})) //
	.toArray(_).join('');
	expected = expected.replace(/\n */g, '').replace(/<\!--.*-->/g, '');
	result = result.replace(/\n */g, '');
	strictEqual(result, expected);
	start();
});
