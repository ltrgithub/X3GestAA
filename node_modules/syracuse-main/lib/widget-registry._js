"use strict";

var registry = require('syracuse-core').registry;
var urlParse = require('url').parse;

registry.scanExtensions(function(extensions) {
	if (extensions.widgets) extensions.widgets.forEach(function(widget) {
		registry.put('widgets', widget.type, 'module', widget.module);
	});
});


exports.dispatcher = function(config) {
	return function(_, request, response) {
		var types = urlParse(request.url, true).query.types;
		if (!types) throw new Error('types parameter missing');
		var result = types.split(',').map(function(type) {
			return {
				$type: type,
				$module: registry.get('widgets', type, 'module'),
			};
		});
		response.writeHead(200, {
			'content-type': 'application/json',
		});
		response.write(_, JSON.stringify(result));
		response.write(_);
	};
};