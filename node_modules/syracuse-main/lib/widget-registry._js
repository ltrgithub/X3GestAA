"use strict";

var registry = require('syracuse-core/lib/registry');
var urlParse = require('url').parse;

registry.scanPackages('package.json', function(pack) {
	var extensions = pack.sage && pack.sage.x3 && pack.sage.x3['ui-extensions'];
	if (extensions) extensions.forEach(function(ext) {
		registry.put('ui-extensions', ext.$type, 'module', ext.$module);
	});
});


exports.dispatcher = function(config) {
	return function(_, request, response) {
		var types = urlParse(request.url, true).query.types;
		if (!types) throw new Error('types parameter missing');
		var result = types.split(',').map(function(type) {
			return {
				$type: type,
				$module: registry.get('ui-extensions', type, 'module'),
			};
		});
		response.writeHead(200, {
			'content-type': 'application/json',
		});
		response.write(_, JSON.stringify(result));
		response.write(_);
	};
};