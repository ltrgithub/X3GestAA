"use strict";
// Note about circular references: nodeconfig.config contains all global configuration information. 
// Any information except config.sdata.endpoints is available in  
var config = {};
require('syracuse-trace/lib/helper'); // must be first require for syracuse, because it replaces the dummy function
// getTracer() of the new syracuse-core module.
//var sdataRegistry = require("@sage/syracuse-lib/src/sdata/sdataRegistry");
var helpers = require('@sage/syracuse-core').helpers;

var fs = require('fs'),
	path = require('path');

try {
	var nodelocal = require("../../../nodelocal") || {};
	config = nodelocal.config || {};
} catch (ex) {
	console.log(ex);
}

config.hosting = config.hosting || {};
//maybe set single tenant
for (var i = 2; i < process.argv.length; i++) {
	if (process.argv[i] === "tenantId=") {
		config.hosting.multiTenant = false;
		console.log("Switch to single tenant mode");
		break;
	}
}
config.system = config.system || {};
config.system.root = config.system.root || path.join(__dirname, "../../..");

// read git branch configuration
var gitHeadPath = path.join(__dirname, "../../..", ".git", "HEAD");
if (nodelocal.branch_configs && fs.existsSync(gitHeadPath)) {
	var parts = (fs.readFileSync(gitHeadPath).toString("utf8") || "").split(":");
	if ((parts[0] || "").trim() === "ref") {
		var branch = (parts[1] || "").split("/").pop().trim();
		nodelocal.branch_configs.some(function(it) {
			if (it.branch && branch.match(it.branch)) {
				helpers.object.extend(config, it.config, true, true);
				console.log("Using branch config '" + it.branch + "' for branch '" + branch + "'");
				return true;
			}
		});
	}
}
//

config.collaboration = config.collaboration || {};
config.collaboration.driver = config.collaboration.driver || "mongodb";
config.collaboration.port = config.collaboration.port || 27017;
config.collaboration.hostname = config.collaboration.hostname || "localhost";
config.collaboration.application = config.collaboration.application || "syracuse";
config.collaboration.contract = config.collaboration.contract || "collaboration";
config.collaboration.dataset = config.collaboration.dataset || "syracuse";
config.collaboration.databaseName = config.collaboration.databaseName || "syracuse";

config.sdata = config.sdata || {};
config.sdata.pubkeyName = config.sdata.pubkeyName || "SYRASVR1";
config.sdata.signAlgorithm = config.sdata.signAlgorithm || "RSA-SHA256";

config.system = config.system || {};

var security = config.security || (config.security = {});

// initialize profile security
security.profile = security.profile || {};
// Default is to reject all kind of MS Office, OpenOffice, LibreOffice, StarOffice documents
security.profile.officeDocumentBlackList = security.profile.officeDocumentBlackList || /(msword|ms-word|ms-excel|ms-powerpoint|openxmlformats-officedocument|oasis.opendocument|stardivision)/i;

// initialize sign in security
var signIn = security.signIn || (security.signIn = {});
var autoComplete = signIn.autoComplete || (signIn.autoComplete = {});
if (signIn.rememberMe == null) signIn.rememberMe = {};
if (signIn.rememberMe.lifetime == null) signIn.rememberMe.lifetime = 4 * 7; // 4 weeks
if (signIn.rememberMe.lifetime < 0) signIn.rememberMe.lifetime = 0;
if (autoComplete.login == null) autoComplete.login = signIn.rememberMe;
if (autoComplete.password == null) autoComplete.password = signIn.rememberMe;

// no circular references up to now. This object can be exported and used by other code
exports.config = config;

// the endpoints require a lot of other code and make circular references. Therefore this code will be loaded later
config.sdata.endpoints = [{
	contract: require.resolve('@sage/syracuse-lib/src/collaboration/contract'),
	datasets: {
		syracuse: {
			driver: config.collaboration.driver,
			port: config.collaboration.port,
			hostname: config.collaboration.hostname,
			connectionString: config.collaboration.connectionString,
			databaseName: config.collaboration.databaseName,
			localInitScript: config.collaboration.localInitScript,
			mongoX509Cert: config.collaboration.mongoX509Cert
		}
	}
}, {
	contract: "syracuse-search/lib/contract",
	datasets: {
		syracuse: {
			driver: config.collaboration.driver,
			port: config.collaboration.port,
			connectionString: config.collaboration.connectionString,
			hostname: config.collaboration.hostname,
			databaseName: config.collaboration.databaseName,
			localInitScript: config.collaboration.localInitScript,
			mongoX509Cert: config.collaboration.mongoX509Cert
		}
	}
}];

// register extra services without any dataset yet.
// they will be configured via admin UI
if (config.skyAutomation) {
	["sky-automation"].forEach(function(name) {
		config.sdata.endpoints.push({
			contract: name + '/lib/contract',
			datasets: [],
		});
	});
}

// Default studio config used for eclipse proxy
config.studio = config.studio || {};
config.studio.dbgp = config.studio.dbgp || {};
config.studio.dbgp.longPollingMillis = config.studio.dbgp.longPollingMillis || 60000;
config.studio.dbgp.trackingMillis = config.studio.dbgp.trackingMillis || 4000;