(function($) {
	var that = $.smobile || {};
	$.smobile = that;
	var layout = {
		GroupLayout:function(layoutData) {
			var  options= layoutData.data
			var b = ['<center><div id="'+layoutData.id+'" data-role="controlgroup"'];
			$.helpers.addJqmData(options,b); 
			b.push('">');
			return {
				before: b.join(''),
				after: "</div></center>",
				childs: []
			}
		},
		FieldContainer:function(layoutData) {
			var  options= layoutData.data
			var b = ['<div id="'+layoutData.id+'" data-role="fieldcontain"'];
			$.helpers.addJqmData(options,b); 
			b.push('">');
			return {
				before: b.join(''),
				after: "</div>",
				childs: []
			}
		},
		CollapsibleLayout:function(layoutData) {
			var  options= layoutData.data
			var b = ['<div id="'+layoutData.id+'" data-role="collapsible" data-collapsed="'+(options.collapsed?"true":"false")+'"'];
			$.helpers.addJqmData(options,b); 
			b.push('><h'+(layoutData.size || 3)+'>'+(options.text || "")+'</h'+(layoutData.size || 3)+'>');
			return {
				before: b.join(''),
				after: "</div>",
				childs: []
			}
			
		},
		CollapsibleSetsLayout:function(layoutData) {
			var  options= layoutData.data
			var b = ['<div id="'+layoutData.id+'" data-role="collapsible-set"'];
			$.helpers.addJqmData(options,b); 
			b.push('>');
			
			return {
				before: b.join(''),
				after: "</div>",
				childs: []
			}
			
		},
		Block:function(layoutData) {
			var  options= layoutData.data
			var b = ['<div id="'+layoutData.id+'" data-role="controlgroup"'];
			$.helpers.addJqmData(options,b); 
			b.push('">');
			return {
				before: b.join(''),
				after: "</div>",
				childs: []
			}
			
		},
		BlockLayout:function(layoutData) {
			var  options= layoutData.data
			var b = ['<div id="'+layoutData.id+'" class="ui-body'];
			$.helpers.addJqmData(options,b, ["data-theme"], true, "ui-body-"); 
			b.push('">');
			return {
				before: b.join(''),
				after: "</div>",
				childs: []
			}
			
		},
		GridLayout:function(layoutData) {
			var controller = this;
			var  options= layoutData.data;
			var cols = options.colCount || 2;
			if (cols > 5) cols = 5; 
			if (cols < 2) cols = 2;
			var rows = options.rowCount || 1;
			if (rows < 1) rows = 1;
			var types = ["a", "b", "c", "d", "e"];
			var b = ['<div id="'+layoutData.id+'"', ' class="ui-grid-'+types[cols-2]];
			$.helpers.addJqmData(options,b, ["data-theme"], true, "ui-body-"); 
			b.push('">');
			var cells = options.cells || [];
			
			var _findCell = function(c, r) {
				for(var i = 0, len = cells.length; i < len; i++) {	
					var cc = cells[i];
					if ((cc.col == c) && (cc.row == r)) {
						return cc;
					}	
				}
				return null;
			};
			var res = {
				childs: []
			};
			for (var i=0; i < rows; i++) {
				for (var j=0; j < cols; j++) {	
					var pcell = _findCell(j, i) || {};
					var cell = {id : layoutData.id.substring(controller.prefix.length) + "_"+i+"_"+j};
					$.extend(cell, pcell);
					var chtml = ['<div id="'+controller.prefix+cell.id+'"', ' class="ui-block-'+types[j]];
					chtml.push('">') 
					var l = {
						id: cell.id,
						before: chtml.join(""),
						after: "</div>",
						childs: []
					};
					res.childs.push(l);
				}
			}
			res.before= b.join('');
			res.after= "</div>";
			return res;
			
		}
		
	};
	
	
	that.addLayout = function(parentLayout, layoutData) {
		var controller = this;
		if (layout[layoutData.layout]) {
			var l = layout[layoutData.layout].apply(controller, [layoutData]);
			l.layoutClass = layoutData.layout;
			parentLayout.childs.push(l);
			return l;
		}
		return null
	};
})(jQuery);    
