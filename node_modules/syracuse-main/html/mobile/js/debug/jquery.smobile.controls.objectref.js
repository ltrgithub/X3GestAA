(function($) {
	'use strict';
	var that = $.smobile;
	that.controls = that.controls || {};
	var _controls = that.controls;
	_controls.ArrayObjectRef={
		_renderContent: function(controller, options, cp, id, html, fieldData, createList) {
			if (options.title) html.push('<li data-role="list-divider">'+ options.title + '</li>');
			html.push('<li');	
			if (createList) {
				var iid = $.helpers.uuid();
				html.push(' id="'+iid+'"');
				createList.push("#"+iid);
			}
			html.push('>');	
			if (!options.cards) {
				html.push('<div class="ui-body">');
				_controls.types._table_header(html, options.items,cp, true, createList);					
			}
			fieldData.forEach(function(value, index){
				if (options.cards)
					_controls.types._cards(html, options.items|| [], cp, value, controller,true,index, createList);
				else 
					_controls.types._table_row(html, options.items|| [], cp, value, controller, true,index, createList);
			});
			if (!options.cards) {
				_controls.types._table_end(html, true);
				html.push('</div>'); 
			}
			html.push('</li>'); 
		},
		_addLast: function(controller, options, cp, id, html, fieldData) {
			html.push('<li id="'+id + '_last">');
			html.push('<div class="ui-block">');
			html.push('<a id="'+id+'_new" data-role="button" data-action="new" data-mini="true" data-theme="d" data-icon="plus" data-iconpos="left" ');
			html.push('href="#">');
			html.push(that.locale().ui.add_item);
			html.push('</a>');
			html.push('</li>');
		},
		refresh: function(controller, options, $c, id) {	
			var fieldData = controller.getValue(options.bind, null, []);
			var page = controller.getPageData();
			var cp = $.proto.getProto(page, options.bind);
			var  html = [], cl= [];;
			_controls.ArrayObjectRef._renderContent(controller, options, cp, id, html, fieldData, cl);
			var save =$('#' +id +'_last').detach();
			$c.html(html.join(''));
			$c.append(save);
			cl.forEach(function(id) {
				$(id).trigger('create');
			});
			$c.listview("refresh");
		},

		createArrayObjectRef: function(controller, c, fieldData) {
			if (fieldData == null)  fieldData = controller.getValue(c.data.bind, null, []);
			var options= c.data || {};
			var page = controller.getPageData();
			var cp = $.proto.getProto(page, options.bind);
			var  html = [];
    		html.push('<ul id="'+c.id + '" data-role="listview"');
			html.push(' data-inset="true" data-split-icon="delete"');			
			$.helpers.addJqmData(options,html); 
			html.push('>');
			_controls.ArrayObjectRef._renderContent(controller, options, cp, c.id, html, fieldData, null);
			_controls.ArrayObjectRef._addLast(controller, options, cp, c.id, html, fieldData);
			html.push('</ul>');
			return { 
				html: html.join(''),
				bind: options.bind,
				action: options.action,
				options: options
			};
		},	
		

		setValue: function(controller, c, value, next) {
			var $ul = $( '#'+ c.id + "");
			return next();		
		},

		handler: function(c, after, layoutClass) {
			return after(_controls.ArrayRef.createArrayRef(this, c));
		},
		events: function($c, c) {
			var controller = this;
			var $ul = $c;
			$ul.click(function(e) {
				if (e && e.target) {
					var target = e.target, cp;
					// lift up 2 levels
					while (target && target.tagName && (target.tagName.toUpperCase() != 'A'))
						target = target.parentNode;
					var p = $(target).attr("data-action");
					if (p === "delete") {
						p = $(target).attr("data-index");
						p = parseInt(p, 10); 
						var fieldData = controller.getValue(c.options.bind, null, []);
						fieldData.splice(p,1);
						controller.notifyChange();
						var tag = (c.options.cards?"TABLE":"TR");
						while (target && (target.tagName.toUpperCase() != tag)) {
							target = target.parentNode;
						}
						if (target)  $(target).remove();
						 
					} else if (p === "edit") {
						p = $(target).attr("data-index");
						p = parseInt(p, 10); 
						var page = controller.getPageData();
						cp = $.proto.getProto(page, c.options.bind);
						var fieldData = controller.getValue(c.options.bind, null, []);
						var layout = {$items:[]};
						if (c.options.cards) {
							layout.$items = c.options.items || {};
						} else if (c.options.items) {
							c.options.items.forEach(function(item){
								layout.$items.push({$bind: item});
							});
						}
						var ui = that.detailUiData(controller, cp, fieldData[p], layout.$items);
						that.createDetail(ui.uiData, fieldData[p], controller);
						controller.setNeedRefresh();
						
					} else if (p === "new") {
						var page = controller.getPageData();
						cp = $.proto.getProto(page, c.options.bind);
						var nv = $.proto.proto2Instance(cp);
						var fieldData = controller.getValue(c.options.bind, null, []);
						fieldData.push(nv);
						controller.setData(c.options.bind, fieldData, null);
						controller.notifyChange();
						var layout = {$items:[]};
						if (c.options.cards) {
							layout.$items = c.options.items || {};
						} else if (c.options.items) {
							c.options.items.forEach(function(item){
								layout.$items.push({$bind: item});
							});
						}
						if (cp.$protoparent.$maxItems && fieldData.length >= cp.$protoparent.$maxItems) return;
						var ui = that.detailUiData(controller, cp,nv, layout.$items);
						that.createDetail(ui.uiData, nv, controller);
						controller.setNeedRefresh();
					}
				}
			});
		}
	};
	
})(jQuery);
