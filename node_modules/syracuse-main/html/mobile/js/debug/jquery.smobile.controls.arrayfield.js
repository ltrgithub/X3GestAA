(function($) {
	'use strict';
	var that = $.smobile;
	that.controls = that.controls || {};
	/* used for $query or $lookup */
	var _controls = that.controls;
	// move in  controls
	_controls.types = _controls.types || {};
	_controls.types.addReference = function($proto, data, controller) {
		var res = {};
		if (data.$value)
			res.value = data.$value;
		else
			res.value = $.helpers.htmlEncode($.proto.parseExpression($proto.$value, {data: controller.exprData(data), $prototype: $proto}, "$value"));
		if ($proto.$links && $proto.$links.$details) {
			var url= $.proto.parseExpression($proto.$links.$details.$url, {data: controller.exprData(data), $prototype: $proto},"$url");
			var purl = $.sdata.parseSdataUri(url);
			if (purl && purl.query && purl.query.representation && $.sdata.config.pages[purl.query.representation]) {
				res.url = url;
			}
		}
		return res;
	}
	var _table_header = function(html, fields, $prototype) {
		html.push('<table data-role="table" data-mode="reflow" class="ui-responsive table-stroke">');
		html.push('<thead><tr>');
		var prop = $prototype.$properties;
		fields.forEach(function(field, index){
			var $proto = prop[field];
			if (!index)
				html.push('<th data-priority="persist">'); 
			else
				html.push('<th data-priority="' + index +'">'); 
			html.push($.helpers.htmlEncode(prop[field].$title));
			html.push('</th>');
		});
		html.push('</tr></thead>');
		html.push('<tbody>');
	};	
	var _table_row = function(html, fields, $prototype, value, controller) {
		html.push('<tr>');
		var prop = $prototype.$properties;
		fields.forEach(function(field){
			var $proto = prop[field];
			html.push('<td>');
			if ($proto.$type === "application/x-reference") {
				//ok
				var options = _controls.types.addReference($proto, value[field], controller);
				that._addLink(html, options, controller);
			}  else {
				//TODO
				html.push(value[field]);
			}
			html.push('</td>');
		});
		html.push('</tr>');
	};
	var _table_end = function(html) {
	
		html.push('</tbody>');
		html.push('</table>');
	};
	var _cards = function(html, fields, $prototype, value, controller) {
		html.push('<table data-role="table" data-mode="reflow" class="ui-responsive table-stroke">');
		html.push('<thead><tr>');
		html.push('<th data-priority="1"></th>'); // title
		html.push('<th data-priority="persist"></th>'); // value
		html.push('</tr></thead>');
		html.push('<tbody>');
		var prop = $prototype.$properties;
		fields.forEach(function(field){
			var $proto = prop[field.$bind];
			html.push('<tr><td>');
			html.push($.helpers.htmlEncode($proto.$title));
			html.push('</td><td>');
			if ($proto.$type === "application/x-reference") {
				//ok
				var options = _controls.types.addReference($proto, value[field.$bind], controller);
				that._addLink(html, options, controller);
			}  else {
				//
				html.push(value[field.$bind]);
			}
			html.push('</td><tr>');
		});
		html.push('</tbody>');
		html.push('</table>');
	}
	//xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
	_controls.ArrayField={
		handler: function(c, after) {
			var controller = this;
			var  html = [], options= c.data || {};
			var field = options.field;
			var page = controller.getPageData();
			if (!page)  return after({ html: "",options: {}});
			var edit = (options.facet === "$edit") || (options.facet === "$create");
			var cpt = field.$proto.$rtype; //see $.helpers.linkParents
			var protoProp = field.$proto.$protoparent;
			var fieldData = controller.getValue(field.$bind, null, cpt===("application/x-reference")?null:[]);
			if (edit) {
				var scc ={id: c.id + "_" + field.$bind, data: {inline: false, bind: field.$bind}};
				var opts = scc.data, cc, cp = field.$item || field.$proto;
				switch (cpt) {
					case "application/x-reference":
						opts.type = "text";
						//opts.label = $.proto.parseExpression(protoProp.$title, {data: controller.exprData(fieldData), $prototype: cp},"$title");
						opts.label = protoProp.$title;
						scc.id = c.id + "_" + field.$bind;
						if (cp.$links && cp.$links.$lookup && cp.$links.$lookup.$url) {
							opts.$lookupurl = $.proto.parseExpression( cp.$links.$lookup.$url, {data: controller.exprData(fieldData), $prototype: cp},"$url");
							opts.$lookupurl = opts.$lookupurl + "&control="+encodeURIComponent(scc.id);
						}
							
						if (cp.$isMandatory) opts.$isMandatory = true;
						cc = that.controls.Lookup.createLookup(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Lookup";
						cc.scid = "_" + field.$bind;
						break;
					case "application/x-array": 
						switch (field.$proto.$type) {
							case "application/x-reference":
								opts.title = field.$title;
								opts.jmdata = $.proto.jqmDataArray();
								scc.id = c.id + "_" + field.$bind;
								protoProp = field.$proto.$item || field.$proto;
								if (protoProp.$links && protoProp.$links.$lookup && protoProp.$links.$lookup.$url) {
									opts.$lookupurl = $.proto.parseExpression( protoProp.$links.$lookup.$url, {data: controller.exprData(fieldData), $prototype: protoProp},"$url");
									opts.$lookupurl = opts.$lookupurl + "&control="+encodeURIComponent(scc.id);
								}
								cc = that.controls.ArrayRef.createArrayRef(controller, scc, fieldData);
								cc.id = scc.id;
								cc.uiClass = "ArrayRef";
								cc.scid = "_" + field.$bind;
								break;
							case "application/x-object":
							case "application/json": // for old compatibility
								debugger;
						}						
						break;
					
				}
				if (cc)
					return after([cc]);
				else
					return after(null);
				
			 } else {
				html.push('<ul id="'+c.id + '" data-role="listview"');
				$.helpers.addJqmData(options,html); 
				html.push('>');
				if (cpt === "application/x-reference") {
					html.push('<li data-role="list-divider">');
					html.push($.helpers.htmlEncode(protoProp.$title));
					html.push('</li>')
					if (fieldData) {
						// lookup 
						var options = _controls.types.addReference(field.$proto, fieldData, controller);
						html.push('<li>'); 
						that._addLink(html, options, controller);
						html.push('</li>');
					}
				} else if (cpt === "application/x-array") {
					html.push('<li data-role="list-divider">');
					html.push($.helpers.htmlEncode(field.$title));
					html.push('</li>')
					if (fieldData && fieldData.length) {
						// x-array
						if (field.$proto.$type === "application/x-reference") {
							fieldData.forEach(function(value){
								var options = _controls.types.addReference(field.$proto.$item || field.$proto, value, controller);
								html.push('<li>'); 
								that._addLink(html, options, controller);
								html.push('</li>');
							});
						} else if (field.$proto.$type === "application/x-object") {
							if (field.cards) {
								fieldData.forEach(function(value){
									html.push('<li>'); 
									if (field.items) 
										_cards(html, field.items, field.$proto, value, controller);
									html.push('</li>'); 
								});
							} else {
								if (field.items) {
									html.push('<li>'); 
									html.push('<div class="ui-body">'); 
									_table_header(html, field.items, field.$proto);
									fieldData.forEach(function(value){
										_table_row(html, field.items, field.$proto, value, controller);
										
									});
									_table_end(html);
									html.push('</div>'); 
									html.push('</li>'); 
								}
								
							}
							
						} else {
							fieldData.forEach(function(value){
								html.push('<li>' + value || "" + '</li>');
							});
						}
					}
				}
				html.push('</ul>');
				return after({ 
					html: html.join(''),
					bind: options.bind,
					options: options				
				});
				
			}
			
		}		
	};
})(jQuery);    
