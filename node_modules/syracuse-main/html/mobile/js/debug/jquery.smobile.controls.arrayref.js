(function($) {
	'use strict';
	var that = $.smobile;
	that.controls = that.controls || {};
	that.controls.ArrayRef={
		_createItem: function(html, cp, value, index, controller) {
			html.push('<li>'); 
			html.push('<a href="#">'); 
			var ioptions = that.controls.types.addReference(cp, value, controller);
			html.push($.helpers.htmlEncode(ioptions.value));
			html.push('</a>');
			html.push('<a href="#" ');
			html.push('data-action="'+index+ '"');				
			html.push('>');
			html.push('</a>'); 
			html.push('</li>');
		
		},
		refresh: function(controller, options, $c, id) {	
			var fieldData = controller.getValue(options.bind, null, []);
			var page = controller.getPageData();
			var cp = $.proto.getProto(page, options.bind);
			var  html = [];
			html.push('<li data-role="list-divider">'+ options.title + '</li>');
			fieldData.forEach(function(value, index){
				that.controls.ArrayRef._createItem(html, cp, value, index, controller)
			});
			var save =$('#' +id +'_last').detach();
			$c.html(html.join(''));
			$c.append(save);
			$c.listview("refresh");
			
		},
		
		createArrayRef: function(controller, c, fieldData) {
			if (fieldData == null)  fieldData = controller.getValue(c.data.bind, null, []);
			var options= c.data || {};
			var page = controller.getPageData();
			var cp = $.proto.getProto(page, options.bind);
			var  html = [];
    		html.push('<ul id="'+c.id + '" data-role="listview"');
			html.push(' data-inset="true" data-split-icon="delete"');			
			$.helpers.addJqmData(options,html); 
			html.push('>');
			html.push('<li data-role="list-divider">'+ options.title + '</li>');
			fieldData.forEach(function(value, index){
				that.controls.ArrayRef._createItem(html, cp, value, index, controller)
			});
			html.push('<li id="'+c.id + '_last">');
			html.push('<div class="ui-block">');
			html.push('<a id="'+c.id+'_new" data-role="button" data-mini="true" data-theme="d" data-icon="plus" data-iconpos="left" ');
			html.push('href="');
			html.push(that.ui.urlHref(options.$lookupurl, controller));
			html.push('">');
			html.push(that.locale().ui.add_item);
			html.push('</a>');
			html.push('</li>');
			html.push('</ul>');
			//html.push('</div>');
			options.$lookup = 1;
			return { 
				html: html.join(''),
				bind: options.bind,
				action: options.action,
				options: options
			};
		},	
		

		setValue: function(controller, c, value, next) {
			var $ul = $( '#'+ c.id + "");
			var page = controller.getPageData();
			// proto of reference
			var cp = $.proto.getProto(page, c.options.bind); 
			// value of reference
			var cv = $.proto.getRefFromValue(value, cp);
			var setvalue = true;
			var newkey = "", oldkey = "";
			var isuuid = $.proto.useUuid(cp);
			// calculate new $key
			if (isuuid) 
				newkey = cv.$key || cv.$uuid;
			else {	
				cp.noRef = true;
				newkey = $.proto.parseExpression(cp.$key, {data: $.proto.exprData(cv), $prototype: cp},"$key");
				delete cp.noRef;
			}
			var fieldData = controller.getValue(c.options.bind, null, []);
			var i = fieldData.length;
			while (i--) {
				var co = fieldData[i];
				if (isuuid) {
					oldkey = co.$key || co.$uuid;
					if (oldkey === newkey) return next();
				} else 	{
					oldkey = $.proto.parseExpression(cp.$key, {data: controller.exprData(co), $prototype: cp},"$key");
					if (oldkey === newkey) return next();
				}				
			}
			var nd = $.proto.setArrayRef(cv,cp,controller.exprData(), c.options.bind);
			fieldData.push(nd);
			controller.setData(c.options.bind, fieldData, null)
			controller.notifyChange();
			controller.setNeedRefresh();
			return next();	
		},

		handler: function(c, after, layoutClass) {
			return after(that.controls.ArrayRef.createArrayRef(this, c));
		},
		events: function($c, c) {
			var controller = this;
			var $ul = $c;
			$ul.click(function(e) {
				if (e && e.target) {
					var target = e.target;
					// lift up 2 levels
					while (target  && target.tagName && (target.tagName.toUpperCase() != 'A'))
						target = target.parentNode;
					var p = $(target).attr("data-action");
					if (p && (p != '')) {
						p = parseInt(p, 10); 
						var fieldData = controller.getValue(c.options.bind, null, []);
						fieldData.splice(p,1);
						controller.notifyChange();
						$($ul.children()[p+1]).remove();
					}
				}
			});
		}
	};
	
})(jQuery);