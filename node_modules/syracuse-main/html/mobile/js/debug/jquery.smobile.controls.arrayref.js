(function($) {
	'use strict';
	var that = $.smobile;
	that.controls = that.controls || {};
	that.controls.ArrayRef={
		createArrayRef: function(controller, c) {
			var options= c.data || {};
			var page = controller.getPageData();
			var cp = $.proto.getProto(page, options.bind);
			var  html = [];
			//html.push('<div class="ui-body">');
    		html.push('<ul id="'+c.id + '" data-role="listview"');
			html.push(' data-inset="true" data-split-icon="delete"');			
			$.helpers.addJqmData(options,html); 
			html.push('>');
			html.push('<li data-role="list-divider">'+ options.title + '</li>');
			
			
			html.push('<li>');
			html.push('<div class="ui-block">');
			html.push('<a id="'+c.id+'_new" data-role="button" data-shadow="false" data-corners="false" data-mini="true" data-theme="d" data-icon="plus" data-iconpos="left" ');
			html.push('href="');
			html.push(that._urlHref(options.$lookupurl, controller));
			html.push('">');
			html.push(that.locale().ui.add_item);
			html.push('</a>');
			html.push('</li>');
			html.push('</ul>');
			//html.push('</div>');
			options.$lookup = 1;
			return { 
				html: html.join(''),
				bind: options.bind,
				action: options.action,
				options: options
			};
		},	
		setValue: function(controller, c, value, next) {
			var $input = $( '#'+ c.id + "_i");
			$input.val(value.$value);
			controller.checkChange(c.id, value, next);
		},

		handler: function(c, after, layoutClass) {
			return after(that.controls.ArrayRef.createArrayRef(this, c));
		},
		events: function($c, c) {
			var controller = this;
			var $input = $c.find( '#'+ c.id + "_i");
			$input.blur(function() {
				if (c.bind) {
					var _aftercchange = controller.afterChangeHnd(c);
					controller.checkChange(c.id, {$value: $input.val()}, _aftercchange);
				}
			});
		}
	};
	
})(jQuery);