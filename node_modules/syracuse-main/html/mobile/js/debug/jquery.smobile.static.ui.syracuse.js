(function($) {
	var that = $.smobile || {};
	that.staticui = that.staticui || {};
	var ui = that.staticui;
	var capabilities = $.sdata.capabilities;
	capabilities.showSettings = true;
	capabilities.authRequired = true;
	capabilities.installUrl = "/sdata/syracuse/collaboration/syracuse/dashboardDefs/$service/mobilePortlets";
	capabilities.showSearch = false;
	capabilities.authUrlSearch = "/sdata/syracuse/collaboration/syracuse/dashboardDefs/$service/mobilePortlets";
	
	ui.settings = function() {	
		var locale = $.smobile.locale();
		return {
			"$title": locale.administration.title,
			"content": { 
				"cp": {"layout":"BlockBodyLayout", "data" : {}},
				"e0": {"uiClass":"Edit", "data" : { "label": locale.ui.sdatahost, "bind": "host" }, "parent": "cp" },
				"e1": {"uiClass":"Edit", "data" : { "label": locale.ui.user, "bind": "user" }, "parent": "cp" },
				"pass": {"uiClass":"Edit", "data" : { "type":"password", "label": locale.ui.password, "bind": "password" }, "parent": "cp" },
				"ok": {"uiClass":"Button", "data" : {  "value": locale.ui.save_item, "action":"savesettings", "jmdata": {"data-icon": "check","data-iconpos": "left"}}, "parent": "cp" },
				"errors" : {"uiClass":"ErrorView", "parent": "cp"}
			},
			actions: {
				savesettings: function(after) {
					var cd = this.data;
					var settings = $.helpers.settings();
					settings.sdata =  settings.sdata || {};
					settings.sdata.sdataHost = cd.host;
					$.sdata.sdataHost = that.sdataHost;
					settings.connect =  settings.connect || {};
					settings.connect.user = cd.user;
					settings.connect.password = cd.password;
					$.helpers.settings(settings);
					$.smobile.goHome(this);
					after(false);
				}
			
			}
		};
	};
	ui.settings_data = function() {
		var cd = {};
		var settings = $.helpers.settings();
		settings.sdata =  settings.sdata || {};
		cd.host = settings.sdata.sdataHost || "";
		settings.connect =  settings.connect || {};
		cd.user = settings.connect.user || "";
		cd.password = settings.connect.password || "";
		return cd;
	};
	var _auth = {
		authurl: capabilities.authUrlSearch,
		detect: function(auth) {
			var res = "unknown";
			auth = auth || "";
			if (auth) auth = auth.toUpperCase();
			if (auth.indexOf("BASIC")===0)
				res = "basic";
			else if (auth.indexOf("DIGEST")===0 )
				res = "digest";
			return res;
		},
		connect: function(next) {
			var settings = $.helpers.settings();	
			settings.connect =  settings.connect || {};
			$.helpers.clearErrors();
			$.sdata.GET($.sdata.sdataHost +  _auth.authurl, function(data, headers){
				if (headers && (headers.status === 401)) {
					var sauth = _auth.detect(headers["WWW-Authenticate"]);
					if (sauth === "basic") {
						settings.connect =  settings.connect || {};
						var user = settings.connect.user || "";
						var password = settings.connect.password || "";
						var aheaders = {Authorization: 'Basic '+ window.btoa(user+":"+password)};
						$.helpers.clearErrors();
						return $.sdata.GET($.sdata.sdataHost +  _auth.authurl, function(data, headers){
							return next(null, $.helpers.hasErrors());
						}, aheaders, {Authenticate: true});
					} else 
						return next(null, true);
				}
				return next(null, $.helpers.hasErrors());
			}, {}, {Authenticate: true});
		}
	};
	$.sdata.capabilities.auth = function(next) {
		return _auth.connect(next);
	}
})(jQuery);    

