(function($) {
	'use strict';
	var that = $.proto || {};
	$.proto = that;
	var _basicTypes = ["application/x-string", "application/x-password", "application/x-integer", "application/x-real", 
		"application/x-decimal", "application/x-boolean", "application/x-date", "application/x-time", 
		"application/x-datetime", "application/x-choice",
		"image"];
	that.isExpression = function(strValue) {
		return (strValue.indexOf("{") >= 0);
	};
	that.sdataKey = {
		"workingCopies": "$workingCopies"
	};
	that.htmlValue = function(data,proto,cp,field) {
		var value = data[field.$bind];
		if (cp.$isHidden) return "";
		switch (field.$type) {
			case "application/x-password": 
			case "application/x-string": 
				return $.helpers.htmlEncode(value);
			case "application/x-integer": 
				return $.helpers.htmlEncode(value + "");
			case "application/x-real": 
				return $.helpers.htmlEncode(value + "");
			case "application/x-decimal": 
				// todo
				return $.helpers.htmlEncode(value + "");
			case "application/x-date": 
				// todo
				return $.helpers.htmlEncode(value + "");
			case "application/x-datetime": 
				// todo
				return $.helpers.htmlEncode(value + "");
			case "application/x-time": 
				// todo
				return $.helpers.htmlEncode(value + "");
			case "application/x-boolean": 
				return '<div class="ui-icon ui-icon-shadow ui-icon-checkbox-' + (value?"on":"off") + '"></div>';
			case "application/x-choice": 
				var enums = that.getProto(proto,field.$bind).$value.$enum;
				for (var i = 0, len = enums.length; i<len; i++) 
					if (enums[i].$value === value)
						return $.helpers.htmlEncode(enums[i].$title);
			case "image":
				if (value) {
					if (value.$url) {
						var curl = value.$url;
						if (that.isExpression(value.$url)) {
							curl = that.parseExpression(value.$url, {data: data,  $prototype: proto}); 
						}
						return '<image class="s-image-detail" src="'+curl+'"/>';
					} else 	if (value.$value) {
						return '<image class="s-image-detail" src="'+"data:"+(value.$contentType || "image/jpeg")+";base64,"+value.$value+'"/>';

					}
					
				}
		}
		return null;
	};
	
	that.getArticle = function(data, bind) {
		var article = data.$article;
		if (article) return article;
		article =  data.$prototype; 
		return article.$article;
	};
	that.getProto = function(data, bind) {
		if (!bind) return data.$prototype || data.$; 
		var proto = data.$prototype;
		if (proto && proto.$properties)
			proto = proto.$properties;
		else
			proto = data.$properties;
		if (proto) {
			proto =  proto[bind]; 
			if (proto && (proto.$type == "application/x-array")) {
				proto = proto.$item;
			} else {
				
			}
			return proto;
		} else 
			return null;
	};
	that.linkParents = function(data, parent) {
		if (!data) return;
		var cd = data;
		var list = [];
		cd.$protoparent = parent;
		if (cd.$properties) {
			Object.keys(cd.$properties).forEach(function(property) {
				var pv = cd.$properties[property];
				if (pv.$type === "application/x-array") {
					list.push(pv.$item);
				} else  if (pv.$type === "application/x-reference") {
					if (pv.$item) list.push(pv.$item); else list.push(pv); 
				} else if ((pv.$type === "application/x-object") || (pv.$type === "application/json")) {
					if (pv.$item) list.push(pv.$item); else list.push(pv); 
				}

			});			
		}
		list.forEach(function(nd){
			that.linkParents(nd, cd);
		});
	};
	that.layoutParser = function(map, data, propname, protos, fields) {
		var cmap = map;
		if (data.$isHidden) return;
		var prototypes = protos.slice();
		var cp = prototypes[prototypes.length-1];
		if (data.$category && data.$title) {
			//add section 
			cmap.fields = cmap.fields || [];
			var obj = {$isSection: true, fields: []};
			obj.title = that.parseExpression(data.$title, {data:null, $prototype: cp}); 
			cmap.fields.push(obj);
			cmap = obj;
		}
		if (data.$bind) {
			cp = (cp && cp.$properties)?cp.$properties[data.$bind]:null;
			if (!cp || !cp.$type) return;
			if  (cp.$isHidden) return;
			if (cp.$type === "application/x-array") {
				if (data.$bind=="$resources") {
					prototypes.push(cp.$item);
				} else {
					if (!cp.$item) return;
					cmap.fields =  cmap.fields || [];
					var proto = {$type: cp.$type, $bind: data.$bind, $title: cp.$title, $proto: cp.$item};
					cmap.fields.push(proto);
					if (cp.$item.$type === "application/x-reference") {
					} else if ((cp.$item.$type === "application/x-object") || (cp.$item.$type === "application/json")) {
						var spmap = {}, cf = [];
						prototypes.push(cp.$item);
						var layoutData = data.$layout || data.$cards, cards=false;  
						// find list of items to show
						if (layoutData) 
							that.layoutParser(spmap, layoutData, '', prototypes, cf);
						if (!cf.length) {
							Object.keys(cp.$item.$properties).forEach(function(cpn){
								if (cpn.charAt(0) === "$") return;
								var cpv = cp.$item.$properties[cpn];
								if (cp.$isHidden) return;
								cf.push(cpn);
							});
						} else if (data.$cards) {
							cards=true;
						}
						proto.items = cf;
						proto.cards = cards;
						if (!cp.$item) return;
					} else if (_basicTypes.indexOf(cp.$item.$type) < 0) {
						return;
					} else {
						// basic type
					}
					return;
				}
			} else if ((cp.$type === "application/x-object") || (cp.$type === "application/json")) {
				if (!cp.$item) return;
				//TODO
				return;
			} else if (cp.$type === "application/x-reference") { 
				if (cp.$item) cp = cp.$item;
				cmap.fields =  cmap.fields || [];
				var proto = {$type: "application/x-reference", $bind: data.$bind, $title: cp.$title, $proto: cp };
				cmap.fields.push(proto);
				return;
			} else if (_basicTypes.indexOf(cp.$type) < 0) {
				//stop ?
				return; 
			} else {
				if (fields) fields.push(data);
				cmap.fields =  cmap.fields || [];
				var proto = {$type: cp.$type, $bind: data.$bind};
				cmap.fields.push(proto);
				return;
			}
		}
		Object.keys(data).forEach(function(pn) {
			var value = data[pn];
			if (!value) return;
			if (Array.isArray(value)) {
				value.forEach(function(item) {
					if (typeof item == "object") {
						that.layoutParser(cmap, item, pn, prototypes, fields);
					}
				});
				
			} else if (typeof value == "object") {
				that.layoutParser(cmap, value, pn, prototypes, fields);
				
			}
		});
	};
	
	
	that.getPropertyValue= function (prop, data) {
		if (data) {
			var value =  null;
			if (prop.charAt(0) == "@") {
				value =  prop;
				if (data.$prototype && data.$prototype.$localization) 
					value =  data.$prototype.$localization[prop];
				return value;
			}
			if (data.data)	value = data.data[prop]; 
			if ((value == null) && data.$prototype) {
				var cd =  data.$prototype;
				value = cd[prop];
				while (value == null) {
					cd = cd.$protoparent;
					if (!cd) break;
					value = cd[prop];
				}
			}
			//....	
			return value;
		}
		return null;
	};
	that.parseExpression = function(expression, data) { 
		if (expression &&  expression.indexOf("{") < 0) {
			return that.getPropertyValue(expression, data);
		}
		var result = expression && expression.replace(/\{(.*?)\}/g, function(match, prop) {
			var value = that.getPropertyValue(prop, data);
			// recursive
			if (value != null) {
				if (value && value.indexOf && value.indexOf("{") >= 0) 
					return that.parseExpression(value, data);
				else return (value + "");
			} else {
				return "";
			}
		});
		return result;
	};
	var _canGroup = function(element) {
		return (_basicTypes.indexOf(element.$type) >= 0);
	};
	that.generateForm = function(map, cid, content, parentId, root, facet) {
		var hasOnlySections = true;
		var cp = parentId, sections = [];
		var groupControl = null;
		if (root) {
			cp = "c" + cid;
			cid++;
			content[cp] = {layout:"BlockLayout", data: {jmdata: {"data-theme": "d"}}, parent: parentId};
		}
		if (map.fields) {
			map.fields.forEach(function(field) {
				if (field.$isSection) {
					groupControl = null;
					var o= null;
					if (field.title) 
						o = {layout:"CollapsibleLayout", data:{facet: facet, jmdata: {"data-inset": "false"}, text: field.title, collapsed: false, size: 6}};
					if (o) {
						if (cp) o.parent = cp;
						var np = "c"+cid;
						cid++;
						content[np] = o;
						if (field.fields && field.fields.length) 
							cid = that.generateForm(field, cid, content, np, false, facet);
						sections.push(o);
					}
				} else {
					hasOnlySections = false;
					var e = null;
					var canGroup = _canGroup(field);
					if (canGroup) {
						if (!groupControl) {
							e = {uiClass:"MultiField", data:{facet: facet, fields:[]}};
							if (cp) e.parent = cp;
							var eid = "e" + cid;
							cid++;
							content[eid] = e;
							groupControl = e;
						}
						groupControl.data.fields.push(field);
						
					} else  {
						groupControl = null;
						e = {uiClass:"ArrayField", data:{facet: facet, jmdata: {"data-inset": "true", "data-mini": "true", "data-theme":"d", "data-divider-theme":"e"}, field: field}};
						if (cp) e.parent = cp;
						var eid = "e" + cid;
						cid++;
						content[eid] = e;
					}
				}
			});
		}	
		if (root && hasOnlySections) {
			content[cp].layout = "CollapsibleSetsLayout";
			sections.forEach(function(section, index){
				section.data.collapsed = (index != 0);
			});
		}
		return cid;
	};
})(jQuery);


(function($) {
	'use strict';
	var that = $.helpers || {};
	var _compat = function() {
		if (!Array.isArray) 
			Array.isArray = function (arg) {  
				return ((arg != null) && (arg.splice != null));  
			};  
		if (!Function.prototype.bind) {  
		  Function.prototype.bind = function (oThis) {  
			if (typeof this !== "function") {  
			  // closest thing possible to the ECMAScript 5 internal IsCallable function  
			  throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");  
			}  
		  
			var aArgs = Array.prototype.slice.call(arguments, 1),   
				fToBind = this,   
				fNOP = function () {},  
				fBound = function () {  
				  return fToBind.apply(this instanceof fNOP  
										 ? this  
										 : oThis || window,  
									   aArgs.concat(Array.prototype.slice.call(arguments)));  
				};  
		  
			fNOP.prototype = this.prototype;  
			fBound.prototype = new fNOP();  
		  
			return fBound;  
		  };  
		} 	
		if(!Object.keys) Object.keys = function(o){  
			if (o !== Object(o))  
				throw new TypeError('Object.keys called on non-object');  
			var ret=[],p;  
			for(p in o) if(Object.prototype.hasOwnProperty.call(o,p)) ret.push(p);  
			return ret;  
		}	
		var supportISO = false;
		try {
			var d = new Date("2011-11-08T23:00:00.000Z");
			if (isNaN(d)) supportISO = false;
		} catch(e) {
			supportISO = false;
		}
		
		if (supportISO) {
			Date.parseISO8601 = function(s) {return new Date(s);};
		} else {
			Date.parseISO8601 = function (s){
				var m = /^(\d{4})(-(\d{2})(-(\d{2})(T(\d{2}):(\d{2})(:(\d{2})(\.(\d+))?)?(Z|((\+|-)(\d{2}):(\d{2}))))?)?)?$/.exec(s);
				if(m === null)
					throw new Error("Invalid ISO String");
				var d = new Date;
				d.setUTCFullYear(+m[1]);
				d.setUTCMonth(m[3] ? (m[3] >> 0) - 1 : 0);
				d.setUTCDate(m[5] >> 0);
				d.setUTCHours(m[7] >> 0);
				d.setUTCMinutes(m[8] >> 0);
				d.setUTCSeconds(m[10] >> 0);
				d.setUTCMilliseconds(m[12] >> 0);
				if(m[13] && m[13] !== "Z"){
					var h = m[16] >> 0,
						i = m[17] >> 0,
						s = m[15] === "+";
					d.setUTCHours((m[7] >> 0) + s ? -h : h);
					d.setUTCMinutes((m[8] >> 0) + s ? -i : i);
				};
				return d;
			};		
		};
	}
    _compat();
	if (!window.console) window.console = {
		log: function() {}
	};
	$.helpers = that;
	$.helpers.extend = function(proto, object) {
		for (var p in object) proto[p] = object[p];
	};
	var _errors = {
		http: 1,
		db: 2,
		exception: 3,
		sdata: 4
	};
	that.slashAtEnd=function(url) {
		if (url && (url.charAt(url.length-1) != "/")) url = url + "/";
		return url;
	};
	that.displayDateFormat =  "YYYY-MM-DD";
	that._diag = function(data, path , res) {
		if (!data) return;
		var $d = data.$diagnoses;
		if ($d && $d.length) {
			if (path) 
				res[path]= {message:  $d[0].message};
			else
				res.message = $d[0].message;
		}
		Object.keys(data).forEach(function(value) {
			var o = data[value];
			var $dd = o.$diagnoses;
			if ($dd && $dd.length) {
				res[value]= {message:  $dd[0].message};
				if (!res.message) res.message =  value +': ' +res[value].message;
			}
			if ((typeof o == "object") && (o.$ || o.$properties)) {
				that._diag((o.$ || o.$properties), (path?(path+"."+value):value), res);
			}
		});
	};
	that.http = {
		parseCookie: function(cookie) {
			var cookies = cookie || "";
			var res = {};
			cookies.split(";").forEach( function(cookie) {
				var parts = cookie.split("=");
				if ((parts.length >= 2) && parts[0] && parts[1]) {
					res[parts[0].trim()] = parts[1].trim();
				}
			});
			return res;
		},
		setCookie: function(name, value, path, expireDate) {
			if (!value && (value=="")) expireDate=new Date();
			try {
				window.document.cookie = name+"="+value+((expireDate != null)?("; expires="+expireDate.toGMTString()):"")+(path?("; path="+path):"/");
			} catch(e) {
			}
		}
	};
	that.extractErrors = function(data, defaultMsg) {
		var res = {message : defaultMsg};
		if (!data || (!data.$ && !data.$properties) ) return res;
		that._diag(data.$ || data.$properties, "", res);
		return res;
	};
	that.format = function (value, params) {
		value = value.replace(/\{([0-9]\})*/g, function($0, $1, $2 ) {
			return params[parseInt($1)];
		});
		return value;
		
	};	
	that.uuid = function() {
		return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
			var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
			return v.toString(16);
		});
	};
	that.htmlEncode=function(value){ return $('<div/>').text(value).html(); };
	that.htmlDecode=function(value){ return $('<div/>').html(value).text(); };
	
	//remove
	that.FUNCS = {
		H: function(value, before, after) {
			if (value) return before+value+after;
			return "";
		},
		ERROR: function(value) {
			return that.FUNCS.H(value,  "<p class=\"ui-m-margin-0 ui-m-error\"><strong>", "</strong><br/p>");
		},
		INFO: function(value) {
			return that.FUNCS.H(value,  "<p class=\"ui-m-margin-0 ui-m-ok\">", "</p>");
		},
		P: function(value) {
			return that.FUNCS.H(value,  "<p>", "</p>");
		},
		
		LW_HINT: function(value) {
			return that.FUNCS.H(value,  "<span class='ui-li-count ui-btn-up-c ui-btn-corner-all'>", "</span>");
		},
		TITLE_LW: function(value) {
			return that.FUNCS.H(value,  "<p class=\"ui-m-margin-0\"><strong>", "</strong></p>");
		},
		TEXT_LW: function(value) {
			return that.FUNCS.H(value,  "<p class=\"ui-m-margin-0\">", "</p>");
		}
	};
	//remove
	that.FUNCS["FORMAT_DATE"] =  function(value) { 
		var date = that.date.isoToDate(value);
		return that.date.dateTimeToLocalDate(date);
	};
	//remove
	that.FUNCS["MOUNTH_YEAR"] =  function(mm, yyyy) { 
		return that.date.dateMY2(mm, yyyy);
	};
	
	that.ERRORS = _errors;
	that.pushdbError = function(ex) {
		that.pushError({type: _errors.db, title: that.messages.db_exception, data: {message:ex.message}});
	},
	that.pushException = function(ex, solution) {
		that.pushError({
			type: _errors.exception, 
			title: that.messages.app_exception, data: {message:ex.message, solution: solution}
		});
		
	};
	that.pushAjaxError = function(jqXHR, textStatus, errorThrown, url, method) {
		var serror = errorThrown;
		method = method || "GET";
		var diag = null;
		if (jqXHR.responseText && (jqXHR.responseText.indexOf("$diagnoses") > 0)) {
			try {
				diag = JSON.parse(jqXHR.responseText);
			} catch(ex) {
			}
		}
		if (diag && diag.$diagnoses && diag.$diagnoses.length) {
			serror = diag.$diagnoses[0].message;
		} else if (errorThrown && errorThrown.message) {
			serror = errorThrown.message;
		} else if (jqXHR.statusText) {
			serror = jqXHR.statusText;
		}
		if (!serror) serror = $.smobile.locale().ui.unknownError;
		if ((jqXHR.status == 200) || (jqXHR.status == 201)) {
			that.pushError({type: _errors.exception, title: that.messages.app_exception, data: {message:serror}});
		} else 
			that.pushError({type: _errors.http, title: method + " " + url ,  data: { message: (jqXHR.status?(jqXHR.status+" - "):"")+serror }});
	};
	that._errkey=function(warning) {
		return (warning?"mobile_errors":"mobile_errors");
	};
	that._localStorage = true;
	try {
		if (!window.sessionStorage) that._localStorage = false;
	} catch (ex) {
		that._localStorage = false;
	}
	
	that._pushError = function(error, warning) {
		var key = that._errkey(warning);
		if (that._localStorage) {
			var errors = window.sessionStorage.getItem(key);
			if (!errors) 
				errors = []
			else
				errors = JSON.parse(errors);
			errors.push(error);
			window.sessionStorage.setItem(key,JSON.stringify(errors));
		} else  {
			if (!that[key]) that[key] = [];
			that[key].push(error);
		}
	};
	that._hasErrors=function(warning) {
		var key = that._errkey(warning);
		if (that._localStorage) {
			var errors = window.sessionStorage.getItem(key);
			if (errors)  {
				errors = JSON.parse(errors);
				return (errors.length > 0); 
			} 
			return false;
		} else	return (that[key] && that[key].length);
	};
	that._clearErrors=function(warning) {
		var key = that._errkey(warning);
		if (that._localStorage) 
			window.sessionStorage.removeItem(key);
		else
			delete that[key];
	};
	that._lastErrors=function(warning) {
		var key = that._errkey(warning);
		if (that._localStorage)  {
			var errors = window.sessionStorage.getItem(key);
			if (errors)  return JSON.parse(errors);
			return null;
		} else
			return that[key];
	};
	
	that.pushError = function(error) { that._pushError(error, false); };
	that.hasErrors = function() { return that._hasErrors(false); };
	that.clearErrors=function() { that._clearErrors(false); };
	that.lastErrors=function(warning) { return that._lastErrors(false);};
	that.pushWarn = function(error) { that._pushError(error, true); };
	that.hasWarns = function() { return that._hasErrors(true); };
	that.clearWarns=function() { that._clearErrors(true); };
	that.lastWarns=function(warning) { return that.lastErrors(true);};
	
	that.each=function(array, fn, next, parallel){
		array = array || [];
		if (!array.length)  return next();
		if (next == null) {
			return array.forEach(fn);
		}
		parallel = parallel || 1;
		var pending = 0;
		var i = 0, len= array.length;
		(function advance(){
			if (i == len && !pending) 
				return next();
			while (i < len && pending < parallel) {
				pending++;
				var j = i++;
				fn(array[j], j, function(){
					pending--;
					advance();
				})
			}
		})();
	};
	
	that.forEachKey=function(object, body, next, parallel){
		if (next) {
			if (object == null) 
				return next();
			return that.each(Object.keys(object), function(key, i, next){
				return body(key, object[key], next)
			}, next, parallel)
		}
		else {
			for (var key in object) 
				body(key, object[key]);
		}
	};
	
	that.sdataURL2key = function(uri) {
		var match = /^.*\(\'(.*)\'\)$/.exec(uri);
		if (match && (match.length==2)) return match[1];
		return "";
	};
	that.applySDataSort = function(sort, res) {
		var sh = function(a, b) {
			var v1, v2;
			for (var i= 0, len= sort.length; i<len; i++) {
				var so= sort[i];
				v1 = a[so.name];
				v2 = b[so.name];
				if (v1 == v2) continue;
				if (v1 > v2) {
				
					return (so.asc?1:-1);
				} else {
					return (so.asc?-1:1);
				}	
			}
			return 0
		};
		res.sort(sh);
	};	
	/**
	* @param {{jmdata: Object}} options
	*/	 
	
	that.addJqmData=function(options, html, filter, inline, inlinePrefix) {
		if (options.jmdata) Object.keys(options.jmdata).forEach(function(name) {
			if (filter && (filter.indexOf(name) < 0)) return;
			var value = options.jmdata[name];
			var qu = ((options.jmdata == "true") || (options.jmdata == "false"))?"":"\""; 
			if (inline) 
				html.push(' '+ inlinePrefix + value); 
			else
				html.push(' '+name+'='+qu +value +qu); 
		});			
	};
	that.encodeJsmQuery=function(query) {
		return encodeURIComponent(query);
			
	};
	that.decodeJsmQuery=function(query) {
		if (query.indexOf("=") > 0) return  query;
		return decodeURIComponent(query);
	};
	that.hashFirst=function() {
		return true;
	};
	
	
	/**
	* @param {{orderBy: string}} query
	*/	 
	that.sdataSort = function(query) {
		if (query && query.orderBy) {
			var orders = query.orderBy.split(',');
			orders.forEach(function(value, index) {
				value = value.trim(); 
				var s = value.split(' ');
				if (s.length == 2) {
					orders[index] = {name: s[0], asc: (s[1] != 'desc')};
				} else 
					orders[index] = {name: value, asc: true};
			});
			return orders;
		}
		return null;
	};
	
	that.number = {
		decimalSep: '',
		decimalSeparator: function() {
			if (that.decimalSep) return that.decimalSep; 
			var n = 1.1;
			n = n.toLocaleString().substring(1, 2);
			that.decimalSep = n;
			return n;
		}
		
	};
	var _pad2= function(i) {
		var res = "" + i;
		if (res.length==1) res = "0"+res;
		return res;
	};
	that.date = {
		isoToDate: function(diso) {return Date.parseISO8601(diso);},
		dateMY: function(dd) {
			return that.messages.monthsOfYear[dd.getMonth()] + ' '+ dd.getFullYear();
		},
		dateMY2: function(mm, yyyy) {
			return that.messages.monthsOfYear[mm] + ' '+ yyyy;
		},
		dateym: function(dd) {
			return dd.getFullYear() + '-' + _pad2(dd.getMonth()+1);
		},
		str2dateym: function(value) {
			var dd = that.date.isoToDate(value);
			return dd.getFullYear() + '-' + _pad2(dd.getMonth()+1);
		},
		str2dateYM: function(value) {
			var dd = that.date.isoToDate(value);
			return that.date.dateMY(dd);
		},
		
		dateTimeToLocalDate: function(dd) {
			return dd.getFullYear() + '-' + _pad2(dd.getMonth()+1)+ '-'+ _pad2(dd.getDate());
		},
		checkString: function(val, orig) {
			if (!orig) return  val;
			try {
				var cv = val.substring(0,10);
				var ov = orig.substring(0,10);
				if (ov == cv) return orig;
				return val;
			} catch(ex) {
				return orig;
			}
		},
		dateStringToIso: function(val) {
			var suffix = new Date().toISOString().substring(10);
			var date = Date.parseISO8601(val+suffix);
			return date.toISOString();
		}
		
	};
})(jQuery);    



(function($) {
	var that = $.helpers || {};
	$.helpers = that;
	$.helpers.Time = function(value) {
		value = (value + 86400 * 365 * 10000) % 86400;
		this._value = value;
	};
	var _pad2 = function(val) {
		var s = val.toString();
		return (s.length == 1) ? "0" + s : s;
	};
	
	$.helpers.Time.prototype = {
		hour: function(){ return Math.floor(this._value / 3600); },
		minute: function(){return Math.floor(this._value / 60) % 60;},
		second: function(){ return this._value % 60; },
		value: function(){ return this._value;},
		toISO: function(){ var self = this; return _pad2(self.hour()) + ":" + _pad2(self.minute()) + ":" + _pad2(self.second());},
		format: function() {
			var self = this;
			var hh= self.hour();
			var mm= self.minute();
			var sec= self.second();
			var format = that.dateSettings.timeFormat || "HH:ii"; 
			var  ms= mm + "", mms = _pad2(mm),  ss= sec + "", sss = _pad2(sec);
			var  Hs= hh + "", HHs = _pad2(hh);
			if (that.dateSettings.ampmText) {
				var ampm = "AM"
				if (hh > 13) {
					hh =  hh - 12;
					Hs= hh + "", HHs = _pad2(hh);
					ampm = "PM"
				}
				return format.replace(/ii/, mms).replace(/i/, ms).replace(/ss/, sss).replace(/s/, ss).replace(/hh/, HHs).replace(/h/, Hs).replace(/A/, ampm);
			} else 
				return format.replace(/ii/, mms).replace(/i/, ms).replace(/ss/, sss).replace(/s/, ss).replace(/HH/, HHs).replace(/H/, Hs);
		}
	};
	$.helpers.Time.parse = function(str) {
		str = str || "00:00";
		if (str.length != 5 && str.length != 8) 
			throw new Error("bad time format, expected hh:mm or hh:mm:ss, got " + str);
		var value = str.length == 8 ? parseInt(str.substring(0, 2), 10) * 3600 + parseInt(str.substring(3,5), 10) * 60 + 
			parseInt(str.substring(6.8), 10) : parseInt(str.substring(0, 2), 10) * 3600 + parseInt(str.substring(3, 5), 10) * 60;
		return new $.helpers.Time(value);
	};
	$.helpers.Time.parseTime = function(str) {
		var sd = $.scroller.formatDate($.helpers.dateSettings.dateFormat, new Date());
		var dd1 =  $.scroller.parseDate($.helpers.dateSettings.dateFormat + ' ' + $.helpers.dateSettings.timeFormat, sd + ' ' + str);
		var dd2 =  $.scroller.parseDate($.helpers.dateSettings.dateFormat + ' ' + $.helpers.dateSettings.timeFormat, sd + ' ' + new $.helpers.Time('00:00').format());
		var res = new $.helpers.Time((dd1- dd2)/1000);
		return res;
	};
	
	that.messages = {
		http_error : "Http Error",
		app_exception: "Application Exception",
		db_exception: "Database Exception",
		nothing_to_send: "No changes to send.",
		menu_apps: "Root Menu",
		
		datasets: "Societies",
		entities: "Entities",
		resources: "Resources"
	};
	that.lang2DateSettings = function(langDate) {	
		var date = new Date();
		if (!langDate) langDate = {
			"amDesignator": "AM",
			"pmDesignator": "PM",
			"dateElementOrder": "mdy",
			"dayNames": ["Sunday", "Monday", "Tuesday", "Wednesday","Thursday","Friday", "Saturday"],
			"abbreviatedDayNames": ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"],
			"monthNames": ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December" ],
			"abbreviatedMonthNames": ["Jan","Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"],
			"formatPatterns": { "shortDate": "M/d/yyyy","shortTime": "h:mm tt"}
		};
		var res = {
			ampmText: (langDate.amDesignator || langDate.pmDesignator)?'&nbsp;':'',
			dateFormat: langDate.formatPatterns.shortDate.toLowerCase().replace(/yyyy/,'yy'),
			dateOrder: langDate.dateElementOrder.replace(/m/, 'mm').replace(/y/, 'yy').replace(/d/, 'dd'),
			dayNames: langDate.dayNames,
			dayNamesShort: langDate.abbreviatedDayNames,
			monthNames: langDate.monthNames,
			monthNamesShort: langDate.abbreviatedMonthNames,
			timeFormat: langDate.formatPatterns.shortTime.replace(/tt/g,'A').replace(/m/g,'i'),
			yearText: $.smobile.locale().datetime.year,
			monthText: $.smobile.locale().datetime.month,
			dayText: $.smobile.locale().datetime.day,
			minuteText: $.smobile.locale().datetime.minutes,
			hourText: $.smobile.locale().datetime.hour,
			secText: $.smobile.locale().datetime.seconds
		
		};
		res.endYear = date.getFullYear() + 20;
		if (res.ampmText) 
			res.timeFormat = res.timeFormat.replace(/H/g, 'h')
		else
			res.timeFormat = res.timeFormat.replace(/h/, 'H');
		res.timeWheels = res.timeFormat.replace(/:/g,'').replace(/ /g,'')
		
		return res;
	};
	that.dateSettings =  that.lang2DateSettings(null);
	if ($.scroller) {
		$.scroller.setDefaults(that.dateSettings);
	}
	 
})(jQuery);



