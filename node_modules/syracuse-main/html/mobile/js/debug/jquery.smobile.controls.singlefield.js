"use strict";
(function($) {
	var that = $.smobile;
	that.controls = that.controls || {};
	var $helpers = $.helpers; // == require
	var $proto = $.proto; // == require
	/* used for $query or $lookup */
	that.controls.SingleField = {
		sync: true,
		handler: function(c, after) {
			var controller = this,
				protoProp, fieldData;
			var options = c.data || {};
			var page = controller.getPageData();
			if (!page) return after({
				html: "",
				options: {}
			});
			var html = [];
			var edit = (options.facet === "$edit") || (options.facet === "$create");
			var cp = $proto.getProto(page, options.$bind),
				pp = cp;
			var entityProto = $proto.getProto(page);
			if (cp.$rtype === "application/x-reference") pp = cp.$protoparent;
			var $article = options.$article;
			if (edit) {
				var $article = options.$article;
				options.$article = null;
				var controls = [];
				var cp = $proto.getProto(page, options.$bind),
					cc = null,
					ft = cp.$type || cp.$rtype;
				var scc = {
					id: c.id + "_" + options.$bind,
					data: {
						inline: false,
						bind: options.$bind
					}
				};
				var opts = scc.data;
				if (cp.$isReadOnly) opts.$isReadOnly = true;
				if (cp.$isDisabled) opts.$isDisabled = true;
				if (cp.$isHidden) return after(null);
				var title = $proto.parseExpression(pp.$shortTitle || pp.$title, {
					data: null,
					$prototype: pp
				}, "$title");
				switch (ft) {
					case "application/x-reference":
						opts.type = "text";
						protoProp = cp.$protoparent;
						fieldData = controller.getValue(options.$bind);
						opts.label = title;
						opts.$article = $article;
						scc.id = c.id + "_" + options.$bind;
						if (cp.$links && cp.$links.$lookup && cp.$links.$lookup.$url) {
							opts.$lookupurl = $proto.parseExpression(cp.$links.$lookup.$url, {
								data: controller.exprData(fieldData),
								$prototype: cp
							}, "$url");
						}

						if (cp.$isMandatory) opts.$isMandatory = true;
						cc = that.controls.Lookup.createLookup(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Lookup";
						cc.scid = "_" + options.$bind;
						break;

					case "application/x-string":
					case "application/x-password":
						opts.type = "text";
						opts.label = title;
						scc.id = c.id + "_" + options.$bind;
						opts.$minLength = cp.$minLength;
						opts.$maxLength = cp.$maxLength;
						opts.$article = $article;
						if (cp.$format == "$email") opts.type = "email";
						else if (cp.$format == "$url") opts.type = "url";
						else if (cp.$format == "$phone") opts.type = "tel";
						if (ft === "application/x-password") opts.type = "password";
						if (cp.$isMandatory) opts.$isMandatory = true;
						cc = that.controls.Edit.createEdit(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Edit";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-choice":
						var items = [];
						opts.items = items;
						opts.$isMandatory = true;
						opts.$article = $article;
						cp.$value.$enum.forEach(function(value) {
							items.push({
								value: value.$value,
								title: $proto.execExpression(value.$title, cp)
							});

						});
						opts.label = title;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Combo.createCombo(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Combo";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-integer":
					case "application/x-real":
					case "application/x-decimal":
						opts.type = "number";
						opts.decimals = 0;
						opts.$article = $article;
						if (cp.$format != null) opts.decimals = $helpers.format2decimals(cp.$format);
						else if (cp.$scale != null) opts.decimals = cp.$scale;
						opts.label = title;
						if (opts.$article.$minimum != null) opts.$minimum = opts.$article.$minimum;
						if (opts.$article.$maximum != null) opts.$maximum = opts.$article.$maximum;
						if (cp.$minimum != null) opts.$minimum = cp.$minimum;
						if (cp.$maximum != null) opts.$maximum = cp.$maximum;
						if ((opts.$minimum != null) && (opts.$maximum != null) && (opts.$minimum || opts.$maximum)) opts.type = "range";
						opts.$isMandatory = true;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Edit.createEdit(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Edit";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-boolean":
						opts.label = title;
						opts.$article = $article;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.CheckBox.createCheckBox(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "CheckBox";
						cc.scid = "_" + options.$bind;
						break;
					case "image":
						opts.label = title;
						opts.$article = $article;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Picture.createPicture(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Picture";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-date":
						opts.type = "date";
						opts.$article = $article;
						opts.label = title;
						opts.$isMandatory = cp.$isMandatory;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Edit.createEdit(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Edit";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-time":
						opts.type = "time";
						opts.$article = $article;
						opts.label = title;
						opts.$isMandatory = cp.$isMandatory;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Edit.createEdit(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Edit";
						cc.scid = "_" + options.$bind;
						break;
					case "application/x-datetime":
						opts.type = "datetime";
						opts.$article = $article;
						opts.label = title;
						opts.$isMandatory = cp.$isMandatory;
						scc.id = c.id + "_" + options.$bind;
						cc = that.controls.Edit.createEdit(controller, scc);
						cc.id = scc.id;
						cc.uiClass = "Edit";
						cc.scid = "_" + options.$bind;
						break;
				}
				if (cc) {
					controls.push(cc);
				}
				if (controls.length) return after(controls);
				else return after(null);
			} else {
				if (cp.$isHidden || $article.$isHidden) return after({
					html: "",
					bind: false
				});
				var labelAfter = false,
					cssl;

				html.push('<div>');
				cssl = ["s-m-style", "s-m-label"];
				if (!$article.$isTitleHidden) {
					if (cp.$type === "image") {
						$article.$label = $article.$label || {};
						$article.$label.$styles = $article.$label.$styles || [];
						$article.$label.$styles.push("top");
					}

					if ($article.$label) {
						$proto.auth.mobileExtentions(cssl, $article.$label);
						labelAfter = $article.$label.$after;
					}
					if (!labelAfter) {
						html.push('<label class="' + cssl.join(' ') + '">');
						html.push($proto.parseExpression(pp.$shortTitle || pp.$title || "", {
							data: null,
							$prototype: pp
						}, "$title", {
							html: true
						}));
						html.push('</label>');
					}
				} else {
					html.push('<label class="' + cssl.join(' ') + '"></label>');
				}
				var css = ["s-m-style s-m-value"];

				$proto.auth.mobileExtentions(css, $article);
				var _createparenDiv = function() {
					html.push('<div class="' + css.join(' ') + '"');
					if ($article.$style) html.push(' style="' + $article.$style + '"');
					html.push('>');
				};
				var valproto = controller.getProtoDataValue(options.$bind);
				if (cp.$rtype === "application/x-reference") {
					_createparenDiv();
					fieldData = controller.getValue(options.$bind);
					var toptions = that.controls.types.addReference(cp, fieldData, controller, options.$bind, true);
					that._addLink(html, toptions, controller);
				} else {
					var updproto = {}, added = false;
					$proto.updproto(updproto, cp);
					if ($proto.isNumeric(cp.$type)) {
						if ($article.$maximum != null) updproto.$maximum = $article.$maximum;
						if ($article.$minimum != null) updproto.$minimum = $article.$minimum;
						$proto.updproto(updproto, valproto);
						if ((updproto.$maximum != null) && (updproto.$minimum != null)) {
							var value = controller.data[options.$bind] || 0;
							if (value < $article.$minimum) value = $article.$minimum;
							if (value > $article.$maximum) value = $article.$maximum;
							added = true;
							var proc = 0;
							try {
								proc = parseInt(value * 10000 / ($article.$maximum - $article.$minimum)) / 100;

							} catch (ex) {}
							css.push("top");
							_createparenDiv();
							html.push('<div class= "s-m-slider"><div class="s-m-slider-ind" style="left:' + proc + '%"><center>');
							html.push($proto.htmlValue(controller.data, entityProto, updproto, {
								$bind: options.$bind,
								$type: cp.$type
							}, value, {
								useValue: true
							}));
							html.push('</center></div></div>');
							//
							//html.push("***");

						}

					}
					if (!added) {
						_createparenDiv();
						html.push($proto.htmlValue(controller.data, entityProto, updproto, {
							$bind: options.$bind,
							$type: cp.$type
						}));
					}
				}
				html.push('</div>');
				if (labelAfter) {
					html.push('<label class="' + cssl.join(' ') + '">');
					html.push($proto.parseExpression(pp.$shortTitle || pp.$title || "", {
						data: null,
						$prototype: pp
					}, "$title", {
						html: true
					}));
					html.push('</label>');
				}
				html.push('</div>');
				return after({
					html: html.join(''),
					bind: options.bind,
					options: options
				});
			}
		}
	};
})(jQuery);