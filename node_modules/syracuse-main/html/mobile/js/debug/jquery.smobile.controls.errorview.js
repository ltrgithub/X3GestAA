(function($) {
	var that = $.smobile || {};
	$.smobile = that;
	var _error2css = function(value) {
		switch (value) {
			case $.helpers.ERRORS.http: 
				return "http";
				break;
			case $.helpers.ERRORS.db:
				return "db";
				break;
			case $.helpers.ERRORS.exception:
				return "app";
				break;
			case $.helpers.ERRORS.sdata:
				return "sdata";
				break;
		}
	};
	
	that.controls.ErrorView = {
		_additem: function(cd, html) {
			html.push('<li');
			var css = [];
			css.push("ui-li-has-icon");
			css.push(that.ui.consts.normal_icon);
			if (css.length) html.push(' class="' + css.join(" ")+'"');
			html.push('>');
			html.push('<div class="'+that.ui.consts.normal_icon_size+ ' ' + 's-error '+ _error2css(cd.type) + '"></div>');
			
			html.push($.helpers.htmlEncode(cd.title));
			
			
			var msg = cd.data.message.replace(/\r\n/g,'\n').split("\n");
			if (msg.length > 1) {
				html.push('<div data-role="collapsible" data-mini="true">');
				html.push('<h3><span class="s-m-error">'+ $.helpers.htmlEncode(msg[0]) + '</span></h3>');
				msg.shift();
				html.push('<p class="s-m-error">')
				html.push(msg.join("<br />"));
				html.push('</p>')
				html.push('</div>');
			} else {
				html.push("<p class=\"s-m-error\"><strong>");
				html.push($.helpers.htmlEncode(msg[0]));
				html.push("</strong></p>");
			}
			
			html.push("<p class=\"s-m-info\">");
			html.push($.helpers.htmlEncode(cd.data.solution));
			html.push("</p>");
			
			
			html.push("</li>");
		},
		handler: function(c, after) {
			var controller = this, html = [], options= c.data || {};
			var data = $.helpers.lastErrors();
			html.push('<ul id="'+c.id + '" data-role="listview"');
			html.push(' data-inset="true"');
			html.push('>');
			if (data) {
				data.forEach(function(cd){
					that.controls.ErrorView._additem(cd, html);
				});
				$.helpers.clearErrors();
			}
			html.push('</ul>');
			controller.hasErrorView = true;
			after({ 
				html: html.join(''),
				bind: true
			});
		},
		refresh: function(controller, options, $c, id) {
			var data = $.helpers.lastErrors(), html=[];
			if (data) {
				data.forEach(function(cd){
					that.controls.ErrorView._additem(cd, html);
				});
				$c.html(html.join(''));	
			}
			
			$c.find("div:jqmData(role='collapsible')").each(function(index) {
				var $cc = $(this);
				$cc.collapsible();
			});
			$c.listview("refresh");
		}
	}
})(jQuery);    


