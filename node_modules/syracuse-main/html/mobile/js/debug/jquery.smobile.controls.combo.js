'use strict';
(function($) {
	var that = $.smobile;
	that.controls = that.controls || {};
	
    that.controls.Combo = {
		createCombo: function(controller, c) {
			var options= c.data || {};
			var html = ['<div data-role="fieldcontain" id="'+c.id+'">'];
			html.push('<div class="s-m-state-block s-m-error" data-role="none" id="'+c.id+'_error"></div>');
			html.push('<label class="ui-input-text" for="'+c.id+'_i">'+options.label+': </label>');
			html.push('<select id="'+c.id+'_i"');
			$.helpers.addJqmData(options,html); 
			html.push('>');
			var cv = controller.getValue(options.bind, null, null);
			var key = cv || options.value;
			options.items = options.items || [];
			if ((cv == null)  && options.items.length) {
				key = options.items[0].value;
				controller.setData(options.bind, key);
			}
			options.items.forEach(function(item) {
				html.push("<option value=\"" + item.value +"\""+ ((key == item.value)?" selected=\"selected\"":"") + ">" + item.title+ "</option>");
			});
			html.push('</select>');
			html.push('</div>');
			return{ 
				html: html.join(''),
				bind: options.bind,
				options: options				
			};
		},
		
		handler: function(c, after) {
			after(that.controls.Combo.createCombo(controller, c));
		},
		checkValue:  function($c, c) {
			var controller = this;
			var $select = $c.find( '#'+ c.id + "_i");
			var value = $select.find('option:selected').val();
			var e = $c.find('#'+ c.id + "_error");
			e.html("");
		},
		refresh: function(c, items, v, after) {
			var controller = this;
			var $select = $('#'+ c.id + "_i");
			$select.empty();
			var options= c.data || {};
			options.items = items || [];
			var key = v, html = [];
			options.items.forEach(function(item, index) {
				html.push("<option value=\"" + item.value +"\""+ ((key == item.value)?" selected=\"selected\"":"") + ">" + item.title+ "</option>");
			});
			$select.html(html.join(''));
			$select.selectmenu('refresh');
			if (after) after();
		},
		events: function($c, c) {
			var controller = this;
			var $select = $c.find( '#'+ c.id + "_i");
			//OK
			$select.bind( "change", function(event, ui) {
				var value = $select.find('option:selected').val();
				var _aftercchange = controller.afterChangeHnd(c);
				var oldValue =  controller.getValue(c.bind, null, null);
				if (oldValue != value) {
					controller.setData(c.bind, value);
					controller.notifyChange();
					if (_aftercchange) _aftercchange();
				}
			});		
		}
		
	};
})(jQuery);