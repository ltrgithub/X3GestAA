var fs = require("fs");
var lib = require("./manifest.js");
var tt = require("./translate.js");
var cc = require("./ClosureCompiler.js");

function ccompile (options, after) {
	cc.compile(
		options.files,
		options.options,
		function(error, result) {
			if (result) {
				console.log('Compiling file "' +options.output+ '" ...');
				fs.writeFile(options.output, result, function (err) {
					console.log('Writting file "' +options.output+ '" ... done.');
					if (after) after();
				});
			} else {
				console.log(error);
			 }
		}
	);
	
};

ccompile({
	files: ['../../debug/initialize.js'],
	options: { warning_level: "VERBOSE",externs: ["../jquery.js"]},
	output: '../../initialize.min.js'
}, function() {
	ccompile({
		files: ['../../debug/jquery.smobile.resources.js'],
		options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js"]},
		output: '../../jquery.smobile.resources.min.js'
	}, function() {
		ccompile({
			files: ['../../debug/jquery.smobile.static.ui.syracuse.js'],
			options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js", "../console.js"]},
			output: '../../jquery.smobile.syracuse.min.js'
		}, function() {
			ccompile({
				files: ['../../debug/jquery.smobile.helpers.js',
					'../../debug/jquery.smobile.auth.js',
					'../../debug/jquery.smobile.sdata.js',
					'../../debug/jquery.smobile.sdata.where.js',
					'../../debug/jquery.smobile.sdata.db.js',
					'../../debug/jquery.smobile.js',
					'../../debug/jquery.smobile.layout.js',
					'../../debug/jquery.smobile.controls.js',
					'../../debug/jquery.smobile.controls.menu.js',
					'../../debug/jquery.smobile.controls.combo.js',
					'../../debug/jquery.smobile.controls.syncview.js',
					'../../debug/jquery.smobile.controls.appsview.js',
					'../../debug/jquery.smobile.controls.errorview.js',
					'../../debug/jquery.smobile.controls.edit.js',
					'../../debug/jquery.smobile.controls.picture.js',
					'../../debug/jquery.smobile.controls.arrayfield.js',
					'../../debug/jquery.smobile.controls.button.js',
					'../../debug/jquery.smobile.controls.checkbox.js',
					'../../debug/jquery.smobile.controls.listview.js',
					'../../debug/jquery.smobile.controls.singlefield.js',
					'../../debug/jquery.smobile.static.ui.js',
					'../../debug/jquery.smobile.controls.sdatalist.js',
					'../../debug/jquery.smobile.controls.navbar.js',
					'../../debug/jquery.smobile.controls.lookup.js',
					'../../debug/jquery.smobile.controls.arrayref.js',
					'../../debug/jquery.smobile.controls.objectref.js',
					'../../debug/jquery.smobile.controls.arraystype.js',
					'../../debug/jquery.smobile.controls.filter.js',
					'../../debug/jquery.smobile.controls.appDashboard.js',
					'../../debug/load.js'
					],
				options: { warning_level: "VERBOSE",externs: ["../jquery.js", "../json.js", "../console.js"]},
				output: '../../jquery.smobile.fw.js'
			}, function() {
				tt.translate(
					{src: "../../../", languages: ["en", "fr"]},
					function() {
						lib.mkmanifest({
							filename : "mobile"
							,path : "../../../"
							,dst : "../../../../"
							,prefix : "./mobile"
							,version : "v1.0"
							,content : "/favicon.ico\n./moffline.html\n"
							,exclude : ['.*/[.].*', '.*/dev/.*','.*/build/.*', '.*/auth/.*', '.*/debug/.*', '\.cache.manifest','.*/flot/.*']
							,network : ['mobile.appcache\nmobile.html\n*']
							,fallback : ['./mobile.html ./moffline.html']
						});
				});


			}); 

		}); 
	}); 
	
}); 



