"use strict";
var fs = require('streamline-fs');
var fsp = require("path");
var sys = require("util");
var helpers = require('syracuse-core/lib/helpers');
var config = require('config'); // must be first syracuse require
var streams = require('streamline/lib/streams/streams');
var locale = require("syracuse-core/lib/locale");
var textTranslation = require("syracuse-translation/lib/translation");
//
var tracer = console.log;
var rootpath = fsp.dirname(process.cwd());

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

// asyncTest("init", function(_) {
// });

asyncTest("localizationKeys basic", function(_) {
	var json = {
		"$prototypes": {
			"localePreference": {
				"$key": "code"
			},
			"storageVolume": {
				"$key": "code",
				"$localized": ["description"]
			},
			"application": {
				"$key": ["application", "contract"],
				"$localized": ["description"]
			},
			"role": {
				"$key": "code",
				"$localized": ["description"],
				"securityProfile": {
					"$key": "code"
				}
			},
			"setting": {},
			"endPoint": {
				"$key": "description.fr-fr",
				"$localized": ["description"],
				"applicationRef": {
					"$key": ["application", "contract"]
				}
			},
			"notificationEvent": {
				"$key": "code",
				"$localized": ["description", "titleTemplate", "textTemplate"]
			},
			"group": {
				"$key": "description.en-us",
				"$localized": ["description"],
				"role": {
					"$key": "code"
				}
			},
			"user": {
				"$key": "lastName",
				"groups": {
					"$key": "description.en-us",
					"$localized": ["description"]
				}
			},
			"securityProfile": {
				"$key": "code",
				"$localized": ["description"],
				"profileItems": {
					"$key": "code",
					"$localized": ["description"]
				}
			},
			"securityProfileItem": {
				"$key": "code",
				"$localized": ["description"]
			}
		},
		"$items": [{
			"$type": "securityProfile",
			"code": "ADMIN",
			"description": "description_902f36d7-96d7-4211-8e49-9f2f7aa1cb29",
			"authoringLevel": "admin",
			"profileItems": [{
				"code": "myProfile",
				"description": "description_29cc9d96-4cbb-4baa-a126-30a890d7aac6",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "users",
				"description": "description_f575e4cd-3afa-4bc7-8e81-285d321b6c0c",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "technicalSettings",
				"description": "description_8d0bbe70-5104-4b8b-bf42-0e1ca26d2b69",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "authoring",
				"description": "description_5bc9b226-9224-434c-a241-80b70d8988bf",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "collaborationArea",
				"description": "description_42e3da25-7961-452d-9195-ec4c39b0a130",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "maintenanceAndStatus",
				"description": "description_91993d8a-1a61-4245-8b44-4e7c9612e224",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "importData",
				"description": "description_5cc4833f-9731-4aef-9c61-4d752bcfad09",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}, {
				"code": "exportData",
				"description": "description_3cda9ad1-fba3-42c9-b431-70c9d7d94a17",
				"canCreate": true,
				"canRead": true,
				"canWrite": true,
				"canDelete": true,
				"canExecute": true
			}]
		}, {
			"$type": "storageVolume",
			"code": "SI_REPORTS",
			"description": "description_80f24f88-88f3-485f-b65c-4f0ba4c34cfd",
			"storageType": "db_file"
		}, {
			"$type": "storageVolume",
			"code": "SI_TEMPLATES",
			"description": "description_22788243-a3df-4e87-8d6d-2c2fd3963ea4",
			"storageType": "db_file"
		}, {
			"$type": "storageVolume",
			"code": "STD",
			"description": "description_cd87a599-ed76-47f0-b1df-98b66cf2bb84",
			"storageType": "db_file"
		}, {
			"$type": "storageVolume",
			"code": "WORD_TEMPLATE_MAILMERGE",
			"description": "description_e7389c3d-c112-49f6-b5e0-909612726384",
			"storageType": "db_file"
		}, {
			"$type": "storageVolume",
			"code": "WORD_TEMPLATE_REPORT",
			"description": "description_7f4c8f18-f4d4-413d-9ec1-40d70ae8c947",
			"storageType": "db_file"
		}, {
			"$type": "storageVolume",
			"code": "PRINTS",
			"storageType": "db_file",
			"description": {
				"default": "Temporary volume for prints",
				"fr-FR": "Volume temporaire pour les impressions",
				"en-US": "Temporary volume for 	"
			}
		}]
	},
		proto = json.$prototypes;

	var keys = textTranslation.localizationKeys(json);
	ok(keys["description_902f36d7-96d7-4211-8e49-9f2f7aa1cb29"], "ADMIN securityProfile.description");
	ok(keys["description_29cc9d96-4cbb-4baa-a126-30a890d7aac6"], "ADMIN securityProfile.profileItems.description");
	ok(keys["description_7f4c8f18-f4d4-413d-9ec1-40d70ae8c947"], "WORD_TEMPLATE_REPORT storageVolume.description");

	tracer && tracer("keys=" + JSON.stringify(keys));
	// ok(true, "*** disabled ***")

	start();
});

asyncTest("localizationKeys dashboard user", function(_) {
	var content = fs.readFile(fsp.join(config.system.root, "import/x3-dashboards-user.json"), "utf8", _),
		json = JSON.parse(content);
	var keys = textTranslation.localizationKeys(json);
	ok(!keys["title_7645c9d3-e205-4b1b-b7b0-b4691299885c"], "'Test Bruno' unused title");
	ok(keys["title_d01a177f-89ea-41c9-a0e5-0829ccbc0a92"], "USR_X3REFV7_ADMIN_MFASM dashboardDef.title");
	ok(keys["description_333f2e1b-31d8-4711-83eb-f17ef883e82a"], "STD_GESFAS menuItem.description");

	tracer && tracer("dashboard user keys=" + JSON.stringify(keys));

	start();
});

// asyncTest("store", function(_) {
// 	var store = textTranslation.store();
// 	start();
// });
