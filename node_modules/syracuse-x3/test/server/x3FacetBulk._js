// JavaScript Document
"use strict";

var module = QUnit.module;
var assert = require( "assert" );
var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var types = require('syracuse-core/lib/types/allTypes');
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require("mongodb");
var streams = require('streamline/lib/streams/streams');
var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
//
var tracer = console.log;
//var tracer = null;
//
//force basic auth
config.session = config.session || {};
config.session.auth = "basic";
helpers.pageFileStorage = false;

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var endPoint = adminTestFixtures.modifyCollaborationEndpoint("mongodb_admin_test");

var requestCount = 0;
var MAX_REQUESTS = 11;

config.QLF = config.QLF || {
    dataset    : "x3_unit_test",
    user       : "qlf",
    folder     : "SUPERV",
    serverHost : "sodaix02",
    serverPort : 17001
  };

var port           = 3004;
var baseUrl        = "http://localhost:" + port
var contractUrl    = "/sdata/syracuse/collaboration/mongodb_admin_test/";
var acceptLanguage = "fr,fr-fr";

function getCookie(_, login, pass) {
	var response = new streams.httpRequest({
		url: baseUrl + "/syracuse-main/html/main.html",
		user: login || "admin",
		password: pass || "admin",
		headers: {
			"accept-language": "fr,fr-fr",
		}
	}).end().response(_);
	response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	tracer && tracer("Get cookie headers (46): "+sys.inspect(response.headers));
	acceptLanguage = response.headers["content-language"] || acceptLanguage;
	return response.headers["set-cookie"];
}

function post(_, cookie, url, data, statusCode, returnFullResponse) {
	var response = streams.httpRequest({
		method: "post",
		url: url.indexOf("http") == 0 ? url : baseUrl + contractUrl + url,
		headers: {
			"content-type": "application/json",
			"Accept-Language": acceptLanguage,
			cookie: cookie
		}
	}).end(JSON.stringify(data)).response(_);
	strictEqual(response.statusCode, statusCode || 201, "status verified");
	if(returnFullResponse)
		return {headers: response.headers, body: JSON.parse(response.readAll(_))};
	else
		return JSON.parse(response.readAll(_));
}

function put(_, cookie, url, data, statusCode, returnFullResponse) {
	var response = streams.httpRequest({
		method: "put",
		url: url.indexOf("http") == 0 ? url : baseUrl + contractUrl + url,
		headers: {
			"content-type": "application/json",
			"Accept-Language": acceptLanguage,
			cookie: cookie
		}
	}).end(JSON.stringify(data)).response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	if(returnFullResponse)
		return {headers: response.headers, body: JSON.parse(response.readAll(_))};
	else
		return JSON.parse(response.readAll(_));
}

function get(_, cookie, url, statusCode, facet) {
	var type = facet || "generic.$details";
	var response = streams.httpRequest({
		method: "get",
		url: url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/" + url,
		headers: {
			cookie: cookie,
			"Accept-Language": acceptLanguage,
			accept: "application/json;vnd.sage=syracuse"
		}
	}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

function del(_, cookie, url, statusCode) {
	var response = streams.httpRequest({
		method: "delete",
		url: baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/" + url,
		headers: {
			cookie: cookie
		}
	}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

function _getModel() {
	return dataModel.make(registry.applications.syracuse.contracts.collaboration, "mongodb_admin_test");
}

function _createDataContext() {
	return new DataContext(_getModel(), true);
}

var doStop = false;
module("x3PrototypesTest", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100)
		}
	}
});

var franceID = "";
var usID = "";

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endPoint.datasets["mongodb_admin_test"].hostname, endPoint.datasets["mongodb_admin_test"].port, {});
	var db = new mongodb.Db(config.collaboration.dataset, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	//
	ok(true, "mongodb initialized");

	start();
});

//start syracuse server
var syracuse;
// wait server initialization
asyncTest("initialize syracuse test server", 1, function(_) {
	syracuse = require('syracuse-main/lib/syracuse');
	syracuse.initializerStatus.on("initialized", function() {
		ok(true, "server initialized");
		syracuse.server.listen(null, port);
		start();
	});
});


function onlyInfo(diags) {
	return diags.every(function(diag) {
		return diag.severity == "info";
	});
}

function hasErrors(body) {
	var hasErr = body.$diagnoses && body.$diagnoses.some(function(diag) {
		return diag.severity == "error";
	});
	if(!hasErr) {
		for(var key in body) {
			if(typeof body[key] === "object")
				hasErr = hasErr || hasErrors(body[key]);
		};
	}
	//
	return hasErr;
}

var _data = {};
var _session = {
	setData: function(name, value) {
		var old = _data[name];
		if (old == value) return;

		if (old && old.onDestroy) {
			old.onDestroy();
		}
		if (typeof value == "undefined") delete _data[name];
		else _data[name] = value;
	},
	getData: function(name) {
		return _data[name];
	},
	_reset: function() {
		_data = {};
	}
}

function _resetSession() {
	_data = {};
}

function _createRequest(method, url, data, set) {
	var baseUrl = "http://localhost/sdata/syracuse/collaboration/mongodb_admin_test"
	return {
		session: _session,
		method: method,
		url: (set ? url : (baseUrl + url)).replace(/'/g, "%27"),
		context: {
			parseBody: function(_) {
				return data;
			}
		},
		headers: {
			cookie: "fake cookie"
		}
	}
}

var cookie = "";
var applicationId;
var applicationX3Id;

asyncTest("create objects", 18, function(_) {
	requestCount++;
	var body;
	console.log("get cookie; server started: "+syracuse.server.serverStarted);
	cookie = getCookie(_);
	// check init script
	var userNames = get(_, cookie, "users").$resources.map(function(item) {
		return item.login;
	});
	ok(userNames.indexOf("admin" ) >= 0, "Admin ok");
	ok(userNames.indexOf("guest")  >= 0, "Guest ok");
	ok(userNames.indexOf("import") >= 0, "Import ok");
	ok(userNames.length == 3, "Users count ok");
	
	// get main application
	var app = adminHelper.getApplication(_, "syracuse", "collaboration");
	ok(app != null, "Application fetch ok");
	applicationId = app.$uuid;
	var app = adminHelper.getApplication(_, "x3", "erp");
	ok(app != null, "Application X3 fetch ok");
	applicationX3Id = app.$uuid;
	// create an x3 endpoint, by step like in edit form
	// x3server    ("serverHost": "172.28.16.106",)
	body = post(_, cookie, "x3servers", {
		"description": "X3 Unit Test Server",
		"serverHost": config.QLF.serverHost,
		"serverPort": config.QLF.serverPort,
		"serverTimeout": 60000,
		$actions: {$save: {$isRequested:true}}
	}, 201);
	var srvrId = body.$uuid;
  // get super admin groups
  body = get(_, cookie, "groups(description eq 'Super administrators')?representation=group.$details", 200);
  var grpId = body.$uuid;
  strictEqual(body.description, "Super administrators", "Got group Super ok");
	body = post(_, cookie, "endPoints", {
    description: "X3 Unit Test Endpoint",
    applicationRef: { $uuid: applicationX3Id },
    dataset: config.QLF.dataset,
    x3server: { $uuid: srvrId },
    x3ServerFolder: config.QLF.folder,
    groups: [{ $uuid: grpId }]
  }, 201);
	ok(!hasErrors(body), "No errors ok");
	// should be able to save now
	console.log("create x3 endpoint body"+sys.inspect(body, null, 4));
	var epId = body.$uuid;
	// try to get it
	body = get(_, cookie, "endPoints('"+body.$uuid+"')",200);
	strictEqual(body.$uuid, epId, "Saved endPoint get ok");

  // put a X3 login for user
  body = put(_, cookie, "users(login eq 'admin')?representation=user.$edit", {
    endpoints: [{
      $index: 0,
      login: config.QLF.user,
      endpoint: { $uuid: epId }
    }]
  }, 200);	
  body = get(_, cookie, "users(login eq 'admin')?representation=user.$details", 200);
	console.log("user return body"+sys.inspect(body, null, 4));
  strictEqual(body.endpoints[0].login, config.QLF.user, "Endpoint added to user");

	start();
});


//******************************************************************************

function checkJSON(_,_representation){
  var cookie = getCookie(_, "admin", "admin");
  var name = _representation + ".$bulk";
  try {
    console.log("**** URL:","/sdata/x3/erp/"+config.QLF.dataset+"/"+_representation+"?representation=" + _representation+ ".$bulk");
  	var prototype = get(_, cookie, baseUrl + "/sdata/x3/erp/"+config.QLF.dataset+"/"+_representation+"?representation=" + _representation+ ".$bulk", 200);
    console.log("prototype=",prototype);
    strictEqual(true,true,"The JSON of "+ _representation + ".$bulk is well formed");
   } catch (e) {
    strictEqual(true,false,"The JSON of "+ _representation + ".$bulk isn't well formed");
    return test;
  }   
}

/*
TODO :
- utiliser le compareJson
*/
asyncTest("AUTILIS    JSON",3, function(_) {checkJSON(_,"AUTILIS") ;  start(); });


//******************************************************************************

asyncTest("stop server", 0, function(_) {
	syracuse.server.close();
	start();
});
asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
