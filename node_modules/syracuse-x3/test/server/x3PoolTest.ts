"use strict";

var config = require('config');
var apis = require('@sage/syracuse-core').apis;
var testAdmin = apis.get('test-admin');
var x3pool = require('../../lib/pool');
var ez = require('ez-streams');

var tracer = console.log;
var port = (config.unit_test && config.unit_test.serverPort) || 3004;
var serverUrl = "http://localhost:" + port;

import { assert } from 'chai';
Object.keys(assert).forEach(key => {
	if (key !== 'isNaN') global[key] = assert[key];
});

describe(module.id, () => {

	//
	function X3ClientStub(config) {
		this._busy = false;
		this._async = config.async;
	}
	var proto = X3ClientStub.prototype;
	proto.busy = function() {
		return this._busy || this._async;
	};
	proto.connect = function(_, params) {};
	proto.createSession = function(_, params) {};
	proto.sendRequest = function(_, req, res) {
		res.writeHead(200);
		res.end();
		return {
			statusCode: 200
		};
	};
	proto.disconnect = function(_) {};
	//
	var db, cookie;
	it('init database', function(_) {
		//
		db = testAdmin.initializeTestEnvironnement(_);
		ok(db != null, "Environnement initialized");
		testAdmin.createX3Endpoint(_, db, "X3");
		//
	});

	it('async connection test', function(_) {
		cookie = testAdmin.getCookie(_, serverUrl, "admin", "admin");
		//
		var _cb;
		var _callTimeout = 4000;

		var checkDisconnect;
		x3pool.injectClientStub({
			create: function(config) {
				var client = new X3ClientStub(config);
				var oldDisconnect = client.disconnect;
				client.disconnect = function(_) {
					oldDisconnect.apply_(_, client, arguments, 0);
					if (checkDisconnect) ok(true, "Client disconnected ok");
					_cb && _cb(null);
					_cb = null;
					clearTimeout(tt);
				};
				return client;
			}
		});
		//
		checkDisconnect = true;
		var body = testAdmin.get(_, cookie, serverUrl + "/sdata/x3/erp/X3/sample?representation=sample.$query&trackngId=test_track_1", 202);
		//tracer && tracer("body(56)", body);
		// check tracker
		strictEqual(body.location, "/sdata/$trackers('test_track_1')", "Tracker adress ok");
		// wait for disconnect to execute
		var tt = setTimeout(function() {
			_cb && _cb("disconnected timeout");
			_cb = null;
		}, _callTimeout);
		(function _wait(cb) {
			_cb = cb;
		})(_);
		checkDisconnect = false;
		body = testAdmin.get(_, cookie, serverUrl + body.location);
		//tracer && tracer("body(60)", body);
		strictEqual(body.phase, "Completed", "Completed ok");
		// test callback url
		var callBackPort = (config.unit_test && config.unit_test.callBackPort) || 3005;
		var callBackUrl = "http://localhost:" + callBackPort;

		var _cb2;
		var server = ez.devices.http.server(function(req, res, _) {
			if (req.method === "POST") {
				var body = JSON.parse(req.readAll(_));
				res.statusCode = 200;
				res.end();
				ok(body.ok, "Callback ok");
			}
			_cb2 && _cb2(null);
			_cb2 = null;
		});
		server.listen(_, callBackPort);
		var body = testAdmin.get(_, cookie, serverUrl + "/sdata/x3/erp/X3/sample?representation=sample.$query&trackngId=test_track_2&callbackUrl=" + encodeURIComponent(callBackUrl), 202, false, null, true);
		// wait for callback
		tt = setTimeout(function() {
			_cb2 && _cb2("disconnected timeout");
			_cb2 = null;
		}, _callTimeout);
		(function _wait(cb) {
			_cb2 = cb;
		})(_);
		server.close(_);
		//
	});
});