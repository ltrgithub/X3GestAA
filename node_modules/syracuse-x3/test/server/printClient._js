"use strict";
var helpers = require('syracuse-core/lib/helpers');
var locale = require('syracuse-core/lib/locale');
var module = QUnit.module;
var util = require('util');
var PrintClient = require('syracuse-x3/lib/print/client/PrintClient').PrintClient;

var done;
module("X3 - Print Client Tests", {
	setup: function(_) {},
	teardown: function(_) {
		if (done) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500)
		}
	}
});

asyncTest("Connection", 5, function(_) {
	var cli = new PrintClient(_, "ecchambard-001", 1890);
	strictEqual(cli.pid != null && cli.pid >= 0 , true, "pid: "+cli.pid);
	var comm = cli.communicator;
	strictEqual(comm.srvTechnoVers && comm.srvTechnoVers.UIAction, "SetTechnoVers", "UIAction: "+comm.srvTechnoVers.UIAction);
	strictEqual(comm.srvTechnoVers && comm.srvTechnoVers.Id, "3", "Id: "+comm.srvTechnoVers.Id);
	strictEqual(comm.srvTechnoVers && comm.srvTechnoVers.Version, "15i.012", "Version: "+comm.srvTechnoVers.Version);
	strictEqual(comm.srvTechnoVers && comm.srvTechnoVers.Protocol, "15000B", "Protocol: "+comm.srvTechnoVers.Protocol);
	cli._disconnect(_);
	start();
});

asyncTest("Get State and Result on unknow Job", 4, function(_) {
	var cli = new PrintClient(_, "ecchambard-001", 1890);
	var result = cli.communicator.send_ND_GETSTATEREPORT(_, "UnknowJob");
	strictEqual(result && result.state, 99, "State: "+result.state);
	strictEqual(result && result.message, "Job 0 - ERR 258 en provenance du serveur d'édition : Impossible de récupèrer une référence sur la demande d'impression.\nUnknowJob - ", "Message: "+result.message);
	var result = cli.communicator.send_ND_GETRESULTREPORT(_, "UnknowJob");
	strictEqual(result && result.length, 0, "Length: "+result.length);
	strictEqual(result && result.binary, "", "Binary: "+result.binary);
	cli._disconnect(_);
	start();
});

asyncTest("OuvImp; GetState; GetReport",  8, function(_) {
	
	var cli = new PrintClient(_, "ecchambard-001", 1890);
	//var cli = new PrintClient(_, "eccmichel", 1889);
	var jobId = helpers.uuid.generate();
	var properties = {
//		  "_ExportFile": "X3UserTempDir; : unsupported param\\TABCOUNTRY",
		  "__wJobID": jobId,
		  "_FormatExport": "29",
		  "__REPORT": "TABCOUNTRY.rpt",
		  "__DESTINATION": "3",
		  "__TYPDBA": "1",
		  "__DBDATABASE": "X3DVLP",
		  "__DBUSER": "SUPERV",
		  "__DBPASSWORD": "tiger",
		  "__WSTATION": "ecchambard-001.sagefr.adinternal.com",
		  "__CDUSER": "TC",
		  "__ADXSOL": "SOLSUPV6",
		  "__APPLICATION": "SUPERV;sodaix02;17000",
		  "__APPRPT": "SUPERV;sodaix02;17000",
		  "__RPTLAN": "FRA",
		  "X3DOS": "SUPERV;sodaix02;17000;150;FRA",
		  "__JOBLINKED": "",
		  "__REQUETE": "25561900",
		  "_Orientation": "0",
		  "_PaperSize": "44",
		  "X3CLI": "Superviseur 140",
		  "X3EDT": "Etat Sage X3 Entreprise Copyright Sage",
		  "X3ETA": "TABCOUNTRY",
		  "X3TIT": "Pays",
		  "X3OPE": "Teddy Chambard",
		  "X3USR": "TC",
		  "X3LAN": "FRA",
		  "X3SIT1": "*",
		  "X3SIT2": "z",
		  "X3PRF": "ADMIN",
		  "X3FCT": "",
		  "X3SIT": "",
		  "paysdeb": " ",
		  "paysfin": "zzzzzzzzzz",
		  "impselections": "0",
		  "año": ""
		}
	
	stop();
	var seqId = cli.launchPrint(_, properties);
	strictEqual(seqId != null && seqId > 0, true, "OuvImp OK");
	var count = 0;
	var intervalId = setInterval(function(_) {
		var result = cli.communicator.send_ND_GETSTATEREPORT(_, jobId);
		if (result.state === 5) {
			strictEqual(result && result.state, 5, "State: "+result.state);
			var result2 = cli.communicator.send_ND_GETRESULTREPORT(_, jobId);
			strictEqual(result2 && result2.length, result2 && result2.binary.length, "Binary OK");
			// uncomment to write pdf file in data directory
			/*
			var f = __dirname + "/../../lib/print/data/REPORT_"+jobId+".pdf";
			require('fs').writeFile(f, result2.binary, "binary", _);
			*/
			cli._disconnect(_);
			clearInterval(intervalId);
			start();
		}else if (count <= 4){
			count++;
			strictEqual(result && result.state, 0, "State: "+result.state);
		}

	}, 1000);
});



asyncTest("kill", 0, function(_) {
	stop();
	done = true;
	start()
});