"use strict";
var module = QUnit.module;
var assert = require("assert");
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var x3Helper = require("syracuse-x3/test/fixtures/x3Helper");
var helpers = require("syracuse-core/lib/helpers");

var tracer; // = console.log;
var doStop = false;

module(config.QLF.folder + ".x3Service", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

asyncTest("start", function(_) {
	ok(x3Helper.initDatabase(_), "syracuse mongodb database initialized");
	x3Helper.initialize(_);
	ok(x3Helper.createObjects(_), "createObjects");
	start();
});

var cookie = null;

function _getCookie(_) {
	cookie = cookie || x3Helper.getCookie(_);
	//!ok("cookie"   ,"cookie"   +JSON.stringify(cookie));
	return cookie;
}

asyncTest("About", function(_) {
	var about = x3Helper.get(_, _getCookie(_), x3Helper.x3Url("$service/ABOUT"), 200);
	ok(true, JSON.stringify(about));
	strictEqual(about.folder, config.QLF.folder, "folder:" + about.folder);
	strictEqual(about.applicationServer.substring(0, config.QLF.serverHost.length), config.QLF.serverHost, "serverHost:" + about.folder);
	strictEqual(parseInt(about.port), config.QLF.serverPort, "serverPort:" + about.port);

	start();
});

//******************************************************************************

asyncTest("stop server", 0, function(_) {
	x3Helper.stopServer();
	start();
});

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
// JavaScript Document