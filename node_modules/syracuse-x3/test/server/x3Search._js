// JavaScript Document
"use strict";
var module 	  	= QUnit.module;
var assert 	  	= require("assert" );
var dataModel 	= require("syracuse-orm/lib/dataModel");
var x3Helper   	= require("syracuse-x3/test/fixtures/x3Helper");

var tracer = console.log;
var doStop = false;

module("x3Search", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100)
		}
	}
});


asyncTest("start", function(_) {
	ok(x3Helper.initDatabase(_),"syracuse mongodb database initialized");

	x3Helper.initialize(_,function(_) {
		ok(x3Helper.createObjects(_),"createObjects");
		start();
	});
});

var cookie=null;
function _getCookie(_) {
  cookie = cookie || x3Helper.getCookie(_);
  return cookie;
}

//******************************************************************************

function _checkSearch(_,_representation){
  try {
  	var prototype = x3Helper.get(_, _getCookie(_), x3Helper.x3Url("$prototypes('"+_representation+".$search')"), 200);
    console.log("prototype=",prototype);
    ok(true,"JSON prototype");
  	var data = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(prototype.$url.replace("{$baseUrl}/","")), 200);
    ok(true,"JSON data");
    
   } catch (e) {
    ok(false,e);
    return test;
  }   
}

asyncTest("ABANK",5, function(_) {_checkSearch(_,"ABANK") ;  start(); });
asyncTest("ACLAIDX",4, function(_) {_checkSearch(_,"ACLAIDX") ;  start(); });
asyncTest("ADOPAR",4, function(_) {_checkSearch(_,"ADOPAR") ;  start(); });
asyncTest("AFCTFCT",4, function(_) {_checkSearch(_,"AFCTFCT") ;  start(); });
asyncTest("AOBJET",4, function(_) {_checkSearch(_,"AOBJET") ;  start(); });
asyncTest("AUTILIS",4, function(_) {_checkSearch(_,"AUTILIS") ;  start(); });
asyncTest("COMPANY",4, function(_) {_checkSearch(_,"COMPANY") ;  start(); });
asyncTest("FACILITY",4, function(_) {_checkSearch(_,"FACILITY") ;  start(); });
asyncTest("PARSTA1",4, function(_) {_checkSearch(_,"PARSTA1") ;  start(); });
asyncTest("PARSTA2",4, function(_) {_checkSearch(_,"PARSTA2") ;  start(); });
asyncTest("TABCOEFF",4, function(_) {_checkSearch(_,"TABCOEFF") ;  start(); });
asyncTest("TABCOUNTRY",4, function(_) {_checkSearch(_,"TABCOUNTRY") ;  start(); });
asyncTest("TABCUR",4, function(_) {_checkSearch(_,"TABCUR") ;  start(); });
asyncTest("TABFOR",4, function(_) {_checkSearch(_,"TABFOR") ;  start(); });
asyncTest("TABUNIT",4, function(_) {_checkSearch(_,"TABUNIT") ;  start(); });
asyncTest("TABUNIT2",4, function(_) {_checkSearch(_,"TABUNIT2") ;  start(); });
asyncTest("ZACTLDEV",4, function(_) {_checkSearch(_,"ZACTLDEV") ;  start(); });
//!asyncTest("ZQREQH",4, function(_) {_checkSearch(_,"ZQREQH") ;  start(); });

//******************************************************************************

asyncTest("stop server", 0, function(_) {
	x3Helper.stopServer();
	start();
});
asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});

