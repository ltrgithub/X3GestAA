"use strict";

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var x3pool = require("syracuse-x3/lib/pool");

var tracer = console.log;
var serverUrl = "http://localhost:3004";

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

//
function X3ClientStub(config) {
	this._busy = false;
	this._async = config.async;
}
var proto = X3ClientStub.prototype;
proto.busy = function() {
	return this._busy || this._async;
};
proto.connect = function(_, params) {};
proto.createSession = function(_, params) {};
proto.sendRequest = function(_, req, res) {
	res.writeHead(200);
	res.end();
	return {
		statusCode: 200
	};
};
proto.disconnect = function(_) {};
//
var db, cookie;
asyncTest("init database", 1, function(_) {
	//
	db = adminTestFixtures.initializeTestEnvironnement(_);
	ok(db != null, "Environnement initialized");
	adminTestFixtures.createX3Endpoint(_, db, "X3");
	//
	start();
});

asyncTest("async connection test", 6, function(_) {
	cookie = adminTestFixtures.getCookie(_, serverUrl, "admin", "admin");
	//
	var _cb;
	x3pool.injectClientStub({
		create: function(config) {
			var client = new X3ClientStub(config);
			var oldDisconnect = client.disconnect;
			client.disconnect = function(_) {
				oldDisconnect.apply(client, arguments);
				ok(true, "Client disconnected ok");
				_cb && _cb(null);
				_cb = null;
			};
			return client;
		}
	});
	//
	var body = adminTestFixtures.get(_, cookie, serverUrl + "/sdata/x3/erp/X3/sample?representation=sample.$query&trackngId=test_track_1", 202);
	//tracer && tracer("body(56)", body);
	// check tracker
	strictEqual(body.location, "/sdata/$trackers('test_track_1')", "Tracker adress ok");
	// wait for disconnect to execute
	(function _wait(cb) {
		_cb = cb;
	})(~_);
	body = adminTestFixtures.get(_, cookie, serverUrl + body.location);
	//tracer && tracer("body(60)", body);
	strictEqual(body.phase, "Completed", "Completed ok");

	start();
});