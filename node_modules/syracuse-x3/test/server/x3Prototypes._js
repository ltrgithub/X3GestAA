"use strict";

var module = QUnit.module;
var assert = require( "assert" );
var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var types = require('syracuse-core/lib/types/allTypes');
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require("mongodb");
var streams = require('streamline/lib/streams/streams');
var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
//
var tracer = console.log;
//var tracer = null;
//
//force basic auth
config.session = config.session || {};
config.session.auth = "basic";
helpers.pageFileStorage = false;

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var endPoint = adminTestFixtures.modifyCollaborationEndpoint("mongodb_admin_test");

var requestCount = 0;
var MAX_REQUESTS = 11;

config.QLF = config.QLF || {
    dataset    : "x3_unit_test",
    user       : "qlf",
    folder     : "SUPERV",
    serverHost : "sodaix02",
    serverPort : 17001
  };

var port           = 3004;
var baseUrl        = "http://localhost:" + port
var contractUrl    = "/sdata/syracuse/collaboration/mongodb_admin_test/";
var acceptLanguage = "fr,fr-fr";

function getCookie(_, login, pass) {
	var response = new streams.httpRequest({
		url: baseUrl + "/syracuse-main/html/main.html",
		user: login || "admin",
		password: pass || "admin",
		headers: {
			"accept-language": "fr,fr-fr",
		}
	}).end().response(_);
	response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	tracer && tracer("Get cookie headers (46): "+sys.inspect(response.headers));
	acceptLanguage = response.headers["content-language"] || acceptLanguage;
	return response.headers["set-cookie"];
}

function post(_, cookie, url, data, statusCode, returnFullResponse) {
	var response = streams.httpRequest({
		method: "post",
		url: url.indexOf("http") == 0 ? url : baseUrl + contractUrl + url,
		headers: {
			"content-type": "application/json",
			"Accept-Language": acceptLanguage,
			cookie: cookie
		}
	}).end(JSON.stringify(data)).response(_);
	strictEqual(response.statusCode, statusCode || 201, "status verified");
	if(returnFullResponse)
		return {headers: response.headers, body: JSON.parse(response.readAll(_))};
	else
		return JSON.parse(response.readAll(_));
}

function put(_, cookie, url, data, statusCode, returnFullResponse) {
	var response = streams.httpRequest({
		method: "put",
		url: url.indexOf("http") == 0 ? url : baseUrl + contractUrl + url,
		headers: {
			"content-type": "application/json",
			"Accept-Language": acceptLanguage,
			cookie: cookie
		}
	}).end(JSON.stringify(data)).response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	if(returnFullResponse)
		return {headers: response.headers, body: JSON.parse(response.readAll(_))};
	else
		return JSON.parse(response.readAll(_));
}

function get(_, cookie, url, statusCode, facet) {
	var type = facet || "generic.$details";
	var response = streams.httpRequest({
		method: "get",
		url: url.indexOf("http") == 0 ? url : baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/" + url,
		headers: {
			cookie: cookie,
			"Accept-Language": acceptLanguage,
			accept: "application/json;vnd.sage=syracuse"
		}
	}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

function del(_, cookie, url, statusCode) {
	var response = streams.httpRequest({
		method: "delete",
		url: baseUrl + "/sdata/syracuse/collaboration/mongodb_admin_test/" + url,
		headers: {
			cookie: cookie
		}
	}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

function _getModel() {
	return dataModel.make(registry.applications.syracuse.contracts.collaboration, "mongodb_admin_test");
}

function _createDataContext() {
	return new DataContext(_getModel(), true);
}

var doStop = false;
module("x3PrototypesTest", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100)
		}
	}
});

var franceID = "";
var usID = "";

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endPoint.datasets["mongodb_admin_test"].hostname, endPoint.datasets["mongodb_admin_test"].port, {});
	var db = new mongodb.Db(config.collaboration.dataset, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	//
	ok(true, "mongodb initialized");

	start();
});

//start syracuse server
var syracuse;
// wait server initialization
asyncTest("initialize syracuse test server", 1, function(_) {
	syracuse = require('syracuse-main/lib/syracuse');
	syracuse.initializerStatus.on("initialized", function() {
		ok(true, "server initialized");
		syracuse.server.listen(null, port);
		start();
	});
});


function onlyInfo(diags) {
	return diags.every(function(diag) {
		return diag.severity == "info";
	});
}

function hasErrors(body) {
	var hasErr = body.$diagnoses && body.$diagnoses.some(function(diag) {
		return diag.severity == "error";
	});
	if(!hasErr) {
		for(var key in body) {
			if(typeof body[key] === "object")
				hasErr = hasErr || hasErrors(body[key]);
		};
	}
	//
	return hasErr;
}

var _data = {};
var _session = {
	setData: function(name, value) {
		var old = _data[name];
		if (old == value) return;

		if (old && old.onDestroy) {
			old.onDestroy();
		}
		if (typeof value == "undefined") delete _data[name];
		else _data[name] = value;
	},
	getData: function(name) {
		return _data[name];
	},
	_reset: function() {
		_data = {};
	}
}

function _resetSession() {
	_data = {};
}

function _createRequest(method, url, data, set) {
	var baseUrl = "http://localhost/sdata/syracuse/collaboration/mongodb_admin_test"
	return {
		session: _session,
		method: method,
		url: (set ? url : (baseUrl + url)).replace(/'/g, "%27"),
		context: {
			parseBody: function(_) {
				return data;
			}
		},
		headers: {
			cookie: "fake cookie"
		}
	}
}

function _checkStatus(response, statusCode, message) {
	strictEqual(response.statusCode, statusCode, message);
	if (response.statusCode != statusCode) {
		console.log(response);
		doStop = true;
		throw new Error("aborting test");
	}
}

var cookie = "";
var applicationId;
var applicationX3Id;

asyncTest("create objects", 18, function(_) {
	requestCount++;
	var body;
	console.log("get cookie; server started: "+syracuse.server.serverStarted);
	cookie = getCookie(_);
	// check init script
	var userNames = get(_, cookie, "users").$resources.map(function(item) {
		return item.login;
	});
	ok(userNames.indexOf("admin" ) >= 0, "Admin ok");
	ok(userNames.indexOf("guest")  >= 0, "Guest ok");
	ok(userNames.indexOf("import") >= 0, "Import ok");
	ok(userNames.length == 3, "Users count ok");
	
	// get main application
	var app = adminHelper.getApplication(_, "syracuse", "collaboration");
	ok(app != null, "Application fetch ok");
	applicationId = app.$uuid;
	var app = adminHelper.getApplication(_, "x3", "erp");
	ok(app != null, "Application X3 fetch ok");
	applicationX3Id = app.$uuid;
	// create an x3 endpoint, by step like in edit form
	// x3server    ("serverHost": "172.28.16.106",)
	body = post(_, cookie, "x3servers", {
		"description": "X3 Unit Test Server",
		"serverHost": config.QLF.serverHost,
		"serverPort": config.QLF.serverPort,
		"serverTimeout": 60000,
		$actions: {$save: {$isRequested:true}}
	}, 201);
	var srvrId = body.$uuid;
  // get super admin groups
  body = get(_, cookie, "groups(description eq 'Super administrators')?representation=group.$details", 200);
  var grpId = body.$uuid;
  strictEqual(body.description, "Super administrators", "Got group Super ok");
	body = post(_, cookie, "endPoints", {
    description: "X3 Unit Test Endpoint",
    applicationRef: { $uuid: applicationX3Id },
    dataset: config.QLF.dataset,
    x3server: { $uuid: srvrId },
    x3ServerFolder: config.QLF.folder,
    groups: [{ $uuid: grpId }]
  }, 201);
	ok(!hasErrors(body), "No errors ok");
	// should be able to save now
	console.log("create x3 endpoint body"+sys.inspect(body, null, 4));
	var epId = body.$uuid;
	// try to get it
	body = get(_, cookie, "endPoints('"+body.$uuid+"')",200);
	strictEqual(body.$uuid, epId, "Saved endPoint get ok");

  // put a X3 login for user
  body = put(_, cookie, "users(login eq 'admin')?representation=user.$edit", {
    endpoints: [{
      $index: 0,
      login: config.QLF.user,
      endpoint: { $uuid: epId }
    }]
  }, 200);	
  body = get(_, cookie, "users(login eq 'admin')?representation=user.$details", 200);
	console.log("user return body"+sys.inspect(body, null, 4));
  strictEqual(body.endpoints[0].login, config.QLF.user, "Endpoint added to user");

	start();
});

function _findUuid(coll, searchProp, searchVal) {
	var uuid = null;
	coll.forEach(function(item) {
		if (item[searchProp] == searchVal) {
			console.log("found: " + sys.inspect(item));
			uuid = item.$uuid;
		}
	});
	return uuid;
}


//******************************************************************************
function _checkPrototype(_,_cookie,_representation,_facet){
  var urlKeys  = [];
  var proNames = [];
  
  
  var test = {done:0,ok:0,nok:0,success:false};
  
  function _ok( value, message ) {
    test.done++;
      
    try {
      assert.ok( value ); 
      test.ok++;
    } catch (err) {
      test.nok++;
      test.message = test.message || message;
      console.log("_ok NOK :'"+test.message+"'");
    }
    test.success = (test.done == test.ok);
  }; 
  
  function _strictEqual( actual, expected, message ) {
    test.done++;
             
    try {
      assert.strictEqual( actual, expected );
      test.ok++;
    } catch( err ) {
      test.nok++;
      test.message = test.message || message;
      console.log("_strictEqual NOK :'"+test.message+"'");
    }
    test.success = (test.done == test.ok);
  };  

  function _checkUrl(_url) {
    console.log("*** $url :",_url);
    var urlpart = _url.match(/('.+')/g);
    if(urlpart) {
      for(var i in urlpart){
        var keys = urlpart[i].match(/\{\w+}/g);
        for(var j in keys) {
          urlKeys.push(keys[j].substring(1,keys[j].length-1));
        }
      }
    }
  }
  
  function _checkLink(_link) {
    _ok("$title"  in _link ,"link.$title");
    _ok("$type"   in _link ,"link.$type");
    _ok("$url"    in _link ,"link.$url");
    _checkUrl(_link.$url);
  }
  
  function _checkLinks(_node) {
    if("$links" in _node) {
      for(var link in _node.$links) {
        _checkLink(_node.$links[link])
      }
    }
  }
  
  function _checkProperties(_properties) {
    for(var p in _properties) {
      proNames.push(p);
      
      _checkLinks(_properties[p]);
      _ok("$type"  in _properties[p],p+".$type");
      
      if(_properties[p].$type == "application/x-reference"){
        _ok("$item"        in _properties[p]        ,p+".$item");
/*
TODO : retirer les commentaires suivant
*/        
//!        _ok("$url"         in _properties[p].$item  ,p+".$item.$url");
//!        _ok("$value"       in _properties[p].$item  ,p+".$item.$value");
//!        _ok("$key"         in _properties[p].$item  ,p+".$item.$key");
//!        _ok("$properties"  in _properties[p].$item  ,p+".$item.$properties");
//!        for(var pr in _properties[p].$item.$properties) {
//!         _ok("$type"  in _properties[p].$item.$properties[pr],p+"."+pr+".$type");
//!         _ok(pr in _properties[p].$item,p+".$item."+pr);
//!        }
      }
      else if(_properties[p].$type == "application/x-choice"){
        _ok("$value"   in _properties[p]        ,p+".$value");
        _ok("$type"    in _properties[p].$value ,p+".$value.$type");
        _ok("$enum"    in _properties[p].$value ,p+".$value.$enum");
        _ok(toString.call(_properties[p].$value.$enum) == '[object Array]',p+".$value.$enum is an array");
        for(var e in _properties[p].$value.$enum) {
         _ok("$value"   in _properties[p].$value.$enum[e] ,p+".$value.$enum("+e+").$value");
         _ok("$title"   in _properties[p].$value.$enum[e] ,p+".$value.$enum("+e+").$title");
        } 
      }
      else if(_properties[p].$type == "application/x-array"){
        _ok("$item"        in _properties[p]             ,p+".$item");
        _ok("$type"        in _properties[p].$item       ,p+".$item.$type");
        
        if(_properties[p].$item.$type == "application/json"){
          _ok("$properties"  in _properties[p].$item ,p+".$item.$properties");
          _checkProperties(_properties[p].$item.$properties);
        }
      }
    }
  }

 
 var name = _representation + ".$" + _facet;
  try {
  	var prototype = get(_, _cookie, baseUrl + "/sdata/x3/erp/"+config.QLF.dataset+"/$prototypes('"+_representation+".$"+_facet+"')", 200);
    console.log("prototype=",prototype);
    _strictEqual(true,true,"The JSON is well formed");
   } catch (e) {
    //console.log(e);
    _strictEqual(true,false,"The JSON isn't well formed");
    return test;
  }   
    
  _strictEqual(prototype.$baseUrl,"/sdata/x3/erp/"+config.QLF.dataset,"$baseUrl");
  _strictEqual(prototype.$baseType,"application/json;vnd.sage=syracuse;vnd.sage.syracuse.representation=x3.erp.SUPERV","$baseType");
  if(_facet in {"details":"","edit":"","summary":""}) {
    _strictEqual(prototype.$url,"{$baseUrl}/"+_representation+"('{$key}')?representation="+_representation+".$"+_facet,"$url");
    } else {
    _strictEqual(prototype.$url,"{$baseUrl}/"+_representation+"?representation="+_representation+".$"+_facet,"$url");
  }
  _strictEqual(prototype.$prototype,"{$baseUrl}/$prototype('{$representation}.$thumb')","$prototype");
  _strictEqual(prototype.$representation,_representation,"$representation");
  _ok(prototype.$title,"$title");
  _strictEqual(prototype.$type,"{$baseType}."+_representation+".$"+_facet,"$type");
  _ok("$properties"   in prototype,"$properties");
  var properties;    
  properties  = prototype.$properties

  if(_facet in {"query":"","lookup":""}) {
    _ok("$itemsPerPage" in prototype,"$itemsPerPage");
    _ok("$resources"  in properties           ,"QUERY $resources");
    _ok("$type"       in properties.$resources,"QUERY $resources.$type");
    _strictEqual(properties.$resources.$type,"application/x-array","QUERY $resources.$type");
    _ok("$item"       in properties.$resources,"QUERY $resources.$item");
    _strictEqual(properties.$resources.$item.$url ,"{$baseUrl}/" +_representation+"('{$key}')?representation="+_representation+".$queryItem","QUERY $resources.$url");
    _strictEqual(properties.$resources.$item.$type,"{$baseType}."+_representation+".$queryItem","QUERY $resources.$type");
    _ok("$key"       in properties.$resources.$item,"QUERY $resources.$item.$key");
    _ok("$value"     in properties.$resources.$item,"QUERY $resources.$item.$value");
     
    _ok("$properties"   in properties.$resources.$item,"QUERY $resources.$item.$properties");
    properties  = properties.$resources.$item.$properties
  }
 
  _checkProperties(properties);

  
  _ok("$localization" in prototype,"$localization");
  
  console.log(urlKeys);
  console.log(proNames);
  for(var k in urlKeys) {
    _ok(proNames.indexOf(urlKeys[k]) != -1,"key:{"+urlKeys[k]+"}");
  }
  return test;
}

function _checkPrototypes(_,_representation){
	cookie = getCookie(_, "admin", "admin");
  var facets=["query","details","lookup","edit","summary"]; 
  //!var facets=["details"]; 
  
  for (var i in facets) {
     var test = _checkPrototype(_,cookie,_representation,facets[i]);
     ok(test.success,_representation + ".$" + facets[i] + " : " + (test.message || "OK"));
  }
}

function _checkJSON(_,_cookie,_representation,_facet){
 var name = _representation + ".$" + _facet;
  try {
  	var prototype = get(_, _cookie, baseUrl + "/sdata/x3/erp/"+config.QLF.dataset+"/$prototypes('"+_representation+".$"+_facet+"')", 200);
    console.log("prototype=",prototype);
    strictEqual(true,true,"The JSON of "+ _representation + ".$" + _facet + " is well formed");
   } catch (e) {
    strictEqual(true,false,"The JSON of "+ _representation + ".$" + _facet + " isn't well formed");
    return test;
  }   
}

function _checkJSONs(_,_representation){
	cookie = getCookie(_, "admin", "admin");
  var facets=["query","details","lookup","edit","summary"]; 
  //!var facets=["details"]; 
  
  for (var i in facets) {
     _checkJSON(_,cookie,_representation,facets[i]);
  }
}

function _compareJSON(_,_cookie,_representation,_facet){
  var name = _representation + ".$" + _facet;

  function _compareObjects(o1, o2){
    var test = {success:true};   
  
    function _compare(o1,o2,path,message){
      //!console.log("_compare(o1, o2)");
      for(var p in o1) {
         //!console.log("_compare:",p,toString.call(o1[p]))
         if(["$baseUrl","$localization","$shortTitle"].indexOf(p) < 0){
          //!console.log("_compare:",p,toString.call(o1[p]),toString.call(o2[p]))
          if(toString.call(o2[p]).indexOf("Undefined")>=0) {
            test.success = false;
            test.message = path+" : "+p + " "+ message;
            console.log("type undefined",test.message);
            return test;
          }
          try {
            //!console.log(toString.call(o1[p])," ? ",toString.call(o2[p]));
            assert.strictEqual(toString.call(o1[p]),toString.call(o2[p]));
            //!console.log("JSON type OK",toString.call(o1[p]));
          } catch( err ) {
            test.success = false;
            test.message = path+" : "+p + " "+ toString.call(o1[p])+" <> "+toString.call(o2[p]);
            console.log("not equal type",test.message);
            return test;
          }
          //!console.log("indexOf",toString.call(o1[p]).indexOf("Object"));
                
          if((toString.call(o1[p]).indexOf("Object")>=0) || (toString.call(o1[p]).indexOf("Array")>=0)) {
            test = _compare(o1[p],o2[p],path+(path?".":"")+p,message);
            if (!test.success) return test;
          } else {
            try {
              assert.strictEqual(o1[p],o2[p]);
              //!console.log("JSON value OK",o1[p]);
            } catch( err ) {
              test.success = false;
              test.message = path+" : "+p + " "+ o1[p]+" <> "+o2[p];
              console.log("not equal value",test.message);
              return test;
            }
        	}
        }
      } 
      return test;
    }
    test = _compare(o1,o2,"","should be present");
    if(! test.success) return test; 
    test = _compare(o2,o1,"","should not be present");
  	return test;
  }  
  
  var p1  = {};
  try {
    p1  = require("syracuse-x3/test/fixtures/"+_representation.toLowerCase()+"_"+_facet);
   } catch (e) {
    ok(false,"require failed with error "+e);
    return test;
  }
	var p2 = get(_, _cookie, baseUrl + "/sdata/x3/erp/"+config.QLF.dataset+"/$prototypes('"+_representation+".$"+_facet+"')", 200);
  var test  = _compareObjects(p1, p2);
  ok(test.success,_representation + ".$" + _facet + " : " + (test.message || "OK"));
     
}


function _compareJSONs(_,_representation){
	cookie = getCookie(_, "admin", "admin");
  var facets=["query","details","lookup","edit","summary"]; 
  
  for (var i in facets) {
     _compareJSON(_,cookie,_representation,facets[i]);
  }
}

/*
TODO :
- utiliser le compareJson
*/
asyncTest("ACLAIDX    JSON",11, function(_) {_checkJSONs(_,"ACLAIDX") ;  start(); });
asyncTest("AFCTIDX    JSON",11, function(_) {_checkJSONs(_,"AFCTIDX") ;  start(); });
asyncTest("AOBJET     JSON",11, function(_) {_checkJSONs(_,"AOBJET") ;  start(); });
asyncTest("APSADX     JSON",11, function(_) {_checkJSONs(_,"APSADX") ;  start(); });
asyncTest("AREPIDX    JSON",11, function(_) {_checkJSONs(_,"AREPIDX") ;  start(); });
asyncTest("ATABDIV    JSON",11, function(_) {_checkJSONs(_,"ATABDIV") ;  start(); });
asyncTest("ATABLE     JSON",11, function(_) {_checkJSONs(_,"ATABLE") ;  start();});
asyncTest("ATRACE     JSON",11, function(_) {_checkJSONs(_,"ATRACE") ;  start(); });
asyncTest("AUTILIS    JSON",11, function(_) {_checkJSONs(_,"AUTILIS") ;  start();}); 
asyncTest("AVOLUME    JSON",11, function(_) {_checkJSONs(_,"AVOLUME") ;  start();});
asyncTest("COMPANY    JSON",11, function(_) {_checkJSONs(_,"COMPANY") ;  start();});
asyncTest("FACILITY   JSON",11, function(_) {_checkJSONs(_,"FACILITY") ;  start(); });
asyncTest("POSCOD     JSON",11, function(_) {_checkJSONs(_,"POSCOD") ;  start(); });
asyncTest("TABCOUNTRY JSON",11, function(_) {_checkJSONs(_,"TABCOUNTRY") ; start();});
asyncTest("TABLAN     JSON",11, function(_) {_checkJSONs(_,"TABLAN") ;   start(); });
asyncTest("TABUNIT    JSON",11, function(_) {_checkJSONs(_,"TABUNIT") ;  start(); });
asyncTest("ZAPLCOM    JSON",11, function(_) {_checkJSONs(_,"ZAPLCOM") ;  start(); });
asyncTest("ZQREQH     JSON",11, function(_) {_checkJSONs(_,"ZQREQH") ;  start();});
asyncTest("ZTESTSUITE JSON",11, function(_) {_checkJSONs(_,"ZTESTSUITE") ;  start(); });
asyncTest("ZZJHA      JSON",11, function(_) {_checkJSONs(_,"ZZJHA") ;  start(); });
asyncTest("ZZSERVICE  JSON",11, function(_) {_checkJSONs(_,"ZZSERVICE") ;  start(); });
    
              
asyncTest("ACLAIDX    prototype", function(_) {_checkPrototypes(_,"ACLAIDX") ;  start(); });
asyncTest("AFCTIDX    prototype", function(_) {_checkPrototypes(_,"AFCTIDX") ;  start(); });
asyncTest("AOBJET     prototype", function(_) {_checkPrototypes(_,"AOBJET") ;  start(); });
asyncTest("APSADX     prototype", function(_) {_checkPrototypes(_,"APSADX") ;  start(); });
asyncTest("AREPIDX    prototype", function(_) {_checkPrototypes(_,"AREPIDX") ;  start(); });
asyncTest("ATABDIV    prototype", function(_) {_checkPrototypes(_,"ATABDIV") ;  start(); });
asyncTest("ATABLE     prototype", function(_) {_checkPrototypes(_,"ATABLE") ;  start();});
asyncTest("ATRACE     prototype", function(_) {_checkPrototypes(_,"ATRACE") ;  start(); });
asyncTest("AUTILIS    prototype", function(_) {_checkPrototypes(_,"AUTILIS") ;  start();}); 
asyncTest("AVOLUME    prototype", function(_) {_checkPrototypes(_,"AVOLUME") ;  start();});
asyncTest("COMPANY    prototype", function(_) {_checkPrototypes(_,"COMPANY") ;  start();});
asyncTest("FACILITY   prototype", function(_) {_checkPrototypes(_,"FACILITY") ;  start(); });
asyncTest("POSCOD     prototype", function(_) {_checkPrototypes(_,"POSCOD") ;  start(); });
asyncTest("TABCOUNTRY prototype", function(_) {_checkPrototypes(_,"TABCOUNTRY") ; start();});
asyncTest("TABLAN     prototype", function(_) {_checkPrototypes(_,"TABLAN") ;   start(); });
asyncTest("TABUNIT    prototype", function(_) {_checkPrototypes(_,"TABUNIT") ;  start(); });
asyncTest("ZAPLCOM    prototype", function(_) {_checkPrototypes(_,"ZAPLCOM") ;  start(); });
asyncTest("ZQREQH     prototype", function(_) {_checkPrototypes(_,"ZQREQH") ;  start();});
asyncTest("ZTESTSUITE prototype", function(_) {_checkPrototypes(_,"ZTESTSUITE") ;  start(); });
asyncTest("ZZJHA      prototype", function(_) {_checkPrototypes(_,"ZZJHA") ;  start(); });
asyncTest("ZZSERVICE  prototype", function(_) {_checkPrototypes(_,"ZZSERVICE") ;  start(); });

asyncTest("ACLAIDX    JSON",11, function(_) {_compareJSONs(_,"ACLAIDX") ;  start(); });
asyncTest("AFCTIDX    JSON",11, function(_) {_compareJSONs(_,"AFCTIDX") ;  start(); });
asyncTest("AOBJET     JSON",11, function(_) {_compareJSONs(_,"AOBJET") ;  start(); });
asyncTest("APSADX     JSON",11, function(_) {_compareJSONs(_,"APSADX") ;  start(); });
asyncTest("AREPIDX    JSON",11, function(_) {_compareJSONs(_,"AREPIDX") ;  start(); });
asyncTest("ATABDIV    JSON",11, function(_) {_compareJSONs(_,"ATABDIV") ;  start(); });
asyncTest("ATABLE     JSON",11, function(_) {_compareJSONs(_,"ATABLE") ;  start();});
asyncTest("ATRACE     JSON",11, function(_) {_compareJSONs(_,"ATRACE") ;  start(); });
asyncTest("AUTILIS    JSON",11, function(_) {_compareJSONs(_,"AUTILIS") ;  start();}); 
asyncTest("AVOLUME    JSON",11, function(_) {_compareJSONs(_,"AVOLUME") ;  start();});
asyncTest("COMPANY    JSON",11, function(_) {_compareJSONs(_,"COMPANY") ;  start();});
asyncTest("FACILITY   JSON",11, function(_) {_compareJSONs(_,"FACILITY") ;  start(); });
asyncTest("POSCOD     JSON",11, function(_) {_compareJSONs(_,"POSCOD") ;  start(); });
asyncTest("TABCOUNTRY JSON",11, function(_) {_compareJSONs(_,"TABCOUNTRY") ; start();});
asyncTest("TABLAN     JSON",11, function(_) {_compareJSONs(_,"TABLAN") ;   start(); });
asyncTest("TABUNIT    JSON",11, function(_) {_compareJSONs(_,"TABUNIT") ;  start(); });
asyncTest("ZAPLCOM    JSON",11, function(_) {_compareJSONs(_,"ZAPLCOM") ;  start(); });
asyncTest("ZQREQH     JSON",11, function(_) {_compareJSONs(_,"ZQREQH") ;  start();});
asyncTest("ZTESTSUITE JSON",11, function(_) {_compareJSONs(_,"ZTESTSUITE") ;  start(); });
asyncTest("ZZJHA      JSON",11, function(_) {_compareJSONs(_,"ZZJHA") ;  start(); });
asyncTest("ZZSERVICE  JSON",11, function(_) {_compareJSONs(_,"ZZSERVICE") ;  start(); });



//******************************************************************************

asyncTest("stop server", 0, function(_) {
	syracuse.server.close();
	start();
});
asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
