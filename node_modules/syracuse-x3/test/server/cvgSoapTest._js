"use strict";

var syracuse = require('syracuse-main/lib/syracuse');
var config = require('config');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var globals = require('streamline/lib/globals');
var CvgClientWS = require('syracuse-x3/lib/clients/soap/CvgClientWS').CvgClientWS;
var TechInfo = require('syracuse-soap/lib/generic/techInfo').TechInfo;
var jsxml = require('jsxml');
var done;
var clientWsUnit = config.soap && config.soap.generic && config.soap.generic.qunit || {};
var ufs = require('fs');
var path = process.mainModule.filename.substring(0, process.mainModule.filename.indexOf("node_modules")) + "node_modules/syracuse-x3/test/server/";

QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (done) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

var endpoints = {
	endpoint: function(_) {
		return {
			x3server: function(_) {
				return {
					serverHost: function(_) {
						return "aws-x3-devx3";
					},
					serverPort: function(_) {
						return 2050;
					},
					serverName: function(_) {
						return "aws-x3-devx3";
					}
				};
			},
			getWebServerBaseUrl: function(_) {
				return "http://aws-x3-devx3/Adonix_X3DVLP";
			},
			x3ServerFolder: function(_) {
				return "GX3APP";
			},
			dataset: function(_) {
				return "GX3APP";
			},
			x3SolutionName: function(_) {
				return "X3DVLP";
			}
		};
		/*return adminHelper.getEndpoint(_, {
		 jsonWhere: {
		 dataset: "SUPERV"
		 }
		 });*/
	},
	endpointSUPERV: function(_) {
		return {
			dataset: function(_) {
				return "SUPERV";
			},
			x3server: function(_) {
				return {
					serverHost: function(_) {
						return "aws-x3-devsup";
					},
					serverPort: function(_) {
						return 17000;
					},
					serverName: function(_) {
						return "aws-x3-devsup";
					}
				};
			},
			getWebServerBaseUrl: function(_) {
				return "http://aws-x3-devsup/Adonix_SUPDVLP";
			},
			x3ServerFolder: function(_) {
				return "SUPERV";
			},
			x3SolutionName: function(_) {
				return "SUPDVLP";
			}
		};
		/*return adminHelper.getEndpoint(_, {
		 jsonWhere: {
		 dataset: "SUPERV"
		 }
		 });*/
	},
	endpointBidon: function(_) {
		return {
			dataset: function(_) {
				return "BIDON";
			},
			x3server: function(_) {
				return {
					serverHost: function(_) {
						return "bidon";
					},
					serverPort: function(_) {
						return 2050;
					},
					serverName: function(_) {
						return "bidon";
					}
				};
			},
			getWebServerBaseUrl: function(_) {
				return "";
			},
			x3ServerFolder: function(_) {
				return "GX3APP";
			},
			x3SolutionName: function(_) {
				return "X3DVLP";
			}
		};
		/*return adminHelper.getEndpoint(_, {
		 jsonWhere: {
		 dataset: "SUPERV"
		 }
		 });*/
	},

};

var users = {
	user: function(_) {
		return {
			getEndpointLogin: function(_, uuid) {
				return "AP";
			},
			infov6: function(_) {
				return false;
			}
		};
	},
	user2: function(_) {
		return {
			getEndpointLogin: function(_, uuid) {
				return "TCA";
			},
			infov6: function(_) {
				return false;
			}
		};
	},
	userBidon: function(_) {
		return {
			getEndpointLogin: function(_, uuid) {
				return "BIDON";
			},
			infov6: function(_) {
				return false;
			}
		};
	},
};

var localePrefs = {};

var context = {
	session: {
		genericWsCtx: {}
	},
	request: {
		session: {
			host: "http:localhost:8124"
		}
	},
	httpSession: {
		getData: function(param) {
			return {};
		}
	},
	baseUrl: "http:localhost:8124"
};
var context2 = {
	session: {
		genericWsCtx: {}
	},
	request: {
		session: {
			host: "http:localhost:8124"
		}
	},
	httpSession: {
		getData: function(param) {
			return {};
		}
	},
	baseUrl: "http:localhost:8124"
};

asyncTest("locale Pref", function(_) {
	var db = adminHelper.getCollaborationOrm(_);
	localePrefs["fr-FR"] = db.fetchInstances(_, db.model.getEntity(_, "localePreference"), {
		jsonWhere: {
			code: "fr-FR"
		}
	})[0];
	localePrefs["en-US"] = db.fetchInstances(_, db.model.getEntity(_, "localePreference"), {
		jsonWhere: {
			code: "en-US"
		}
	})[0];
	start();
});

var recOptions = {
	recMode: clientWsUnit.online ? "REC" : "PLAY",
	path: "node_modules/syracuse-x3/lib/clients/soap/data"
};
asyncTest("Ws Classic Soap Client -  connect / disconnect ", function(_) {

	if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file
	//work connection fr-FR
	context.httpSession.genericWsCtx = {
		endpoint: endpoints.endpoint(_),
		user: users.user(_),
		localePref: localePrefs["fr-FR"]
	};
	recOptions.fileName = "cvgClientWS_connectdisconnect_1_.json";

	var cli = new CvgClientWS().init(_, context, recOptions);
	strictEqual(cli.stream !== null, true, "client connected ok");

	strictEqual(cli._x3SessionSettings.ADXLangIso, "fr-FR", "client langue ISO fr FR ok");
	strictEqual(cli._x3SessionSettings.cdLang, "FRA", "client langue FRA ok ");
	strictEqual(cli._x3SessionSettings.Userconnect, "true", "user connected ok");
	strictEqual(cli._x3SessionSettings.usrProfile, "ADMIN", "user profile used ADMIN ok");

	cli.disconnectClient(_);
	strictEqual(cli.stream !== null, false, "client disconnected ok");

	//work connection en-US
	context.httpSession.genericWsCtx.localePref = localePrefs["en-US"];
	recOptions.fileName = "cvgClientWS_connectdisconnect_2_.json";
	cli = new CvgClientWS().init(_, context, recOptions);
	strictEqual(cli.stream !== null, true, "client connected ok");

	strictEqual(cli._x3SessionSettings.ADXLangIso, "en-US", "client langue ISO en US ok");
	strictEqual(cli._x3SessionSettings.cdLang, "ENG", "client langue ENG ok");
	strictEqual(cli._x3SessionSettings.Userconnect, "true", "user connected ok");
	strictEqual(cli._x3SessionSettings.usrProfile, "ADMIN", "user profile used ADMIN ok");

	cli.disconnectClient(_);
	strictEqual(cli.stream !== null, false, "client disconnected ok");

	// failed bad endpoint
	try {
		context.httpSession.genericWsCtx.endpoint = endpoints.endpointBidon(_);
		cli = new CvgClientWS().init(_, context);
		ok(false, "bad endpoint client must raise an error");
	} catch (e) {
		ok(true, "bad endpoint client raised an error ok");
		strictEqual(e.message, "Cannot connect to server bidon:2050; Error getaddrinfo ENOTFOUND", "excpetion raised ok");
		cli.disconnectClient(_);
		strictEqual(cli.stream !== null, false, "bad endpoint client not connected ok");
	}

	// failed bad user
	context.httpSession.genericWsCtx.endpoint = endpoints.endpoint(_);
	context.httpSession.genericWsCtx.user = users.userBidon(_);
	recOptions.fileName = "cvgClientWS_connectdisconnect_4_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	cli.disconnectClient(_);
	strictEqual(cli.stream !== null, false, "bad user client not connected ok");


	start();
});

asyncTest("Ws Classic Soap Client -  call sub program", function(_) {
	context.httpSession.genericWsCtx.endpoint = endpoints.endpointSUPERV(_);
	context.httpSession.genericWsCtx.user = users.user(_);
	recOptions.fileName = "cvgClientWS_callsubprog_1_.json";

	var cli = new CvgClientWS().init(_, context, recOptions);

	var reply = cli.execAckCall(_, "QLFWSADD:ADDDECIMAL", 0, [{
		"dim": 1,
		"nb": 1,
		"size": 1,
		"typ": "DCB",
		"resu": 3.0
	}, {
		"dim": 1,
		"nb": 1,
		"size": 1,
		"typ": "DCB",
		"resu": 2.0
	}, {
		"dim": 1,
		"nb": 0,
		"size": 1,
		"typ": "DCB",
	}], new TechInfo());

	strictEqual(JSON.stringify(reply), '{"json":{"result":{"errp":"","errm":"","errn":0,"errt":0,"errl":0},"debugInfos":{"exceptiondetail":"","totalduration":0,"execduration":0,"trace":""},"return":{"typ":"NULL","resu":null},"params":[{"num":2,"poste":0,"typ":"DCB","resu":"5"}]}}', " reply QLFWSADD:ADDECIMAL ok");
	reply = cli.execAckCall(_, "QLFWSSLP:DOSLEEP", 0, [{
		"dim": 1,
		"nb": 1,
		"size": 1,
		"typ": "INT",
		"resu": 2
	}, {
		"dim": 1,
		"nb": 0,
		"size": 1,
		"typ": "INT",
	}], new TechInfo());

	strictEqual(JSON.stringify(reply), '{"json":{"result":{"errp":"","errm":"","errn":0,"errt":0,"errl":0},"debugInfos":{"exceptiondetail":"","totalduration":0,"execduration":0,"trace":""},"return":{"typ":"NULL","resu":null},"params":[{"num":1,"poste":0,"typ":"INT","resu":1}]}}', " reply QLFWSSLP:DOSLEEP ok");

	cli.disconnectClient(_);
	start();
});

asyncTest("Ws Classic Soap Client -  technical Subprogram", function(_) {
	context.httpSession.genericWsCtx = {
		endpoint: endpoints.endpointSUPERV(_),
		user: users.user(_),
		localePref: localePrefs["fr-FR"]
	};
	recOptions.fileName = "cvgClientWS_techsubprog_1_.json";

	var cli = new CvgClientWS().init(_, context, recOptions);
	try {
		var res = cli._flush(_, new TechInfo());
		strictEqual(res, true, "result flush ok");
	} catch (e) {
		ok(false, "result flush exception " + e.stack);
	} finally {
		cli.disconnectClient(_);

	}
	// change context with good value language
	recOptions.fileName = "cvgClientWS_techsubprog_2_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	try {
		var res = cli._changeLogin(_, "AP", "ENG", new TechInfo());
		strictEqual(res, true, "result change language ok");
	} catch (e) {
		ok(false, "result change language exception " + e.stack);
	} finally {
		cli.disconnectClient(_);
	}
	// change context with good user and good language
	recOptions.fileName = "cvgClientWS_techsubprog_3_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	try {
		var res = cli._changeLogin(_, "TCA", "ENG", new TechInfo());
		strictEqual(res, true, "result change login and language ok");
	} catch (e) {
		ok(false, "result change login and language exception " + e.stack);
	} finally {
		cli.disconnectClient(_);
	}
	// change context with bad language
	recOptions.fileName = "cvgClientWS_techsubprog_4_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	try {
		var res = cli._changeLogin(_, "AP", "FRI", new TechInfo());
		ok(false, "result change bad language ");
	} catch (e) {
		ok(true, "result change bad language exception " + e.stack);
		strictEqual(e.message, "X3 Error: FRI : Code langue incorrect", "excpetion raised ok");

	} finally {
		cli.disconnectClient(_);
	}
	// change context with bad user
	recOptions.fileName = "cvgClientWS_techsubprog_5_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	try {
		var res = cli._changeLogin(_, "BIDON", "FRA", new TechInfo());
		ok(false, "result change bad user ");
	} catch (e) {
		ok(true, "result change bad user exception " + e.stack);
		strictEqual(e.message, "X3 Error: Code utilisateur incorrect", 'exception raised ok');
	} finally {
		cli.disconnectClient(_);
	}

	// get hdat with good stamp
	recOptions.fileName = "cvgClientWS_techsubprog_6_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	var decription = jsxml.parse(cli._getDescription(_, "QLFWSADD", new TechInfo()));

	var stamp = decription.ADXDOC.$.TIM;
	try {
		var res = cli._recupHDAT(_, "QLFWSADD", stamp, new TechInfo());
		ok(true, "result recuphdat ");
	} catch (e) {
		ok(false, "result recuphdat exception " + e.stack);
	} finally {
		cli.disconnectClient(_);
	}

	// get hdat with bad stamp
	recOptions.fileName = "cvgClientWS_techsubprog_7_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	var techinfo = new TechInfo();
	var res = cli._recupHDAT(_, "QLFWSADD", "33333333333333", 0, techinfo);
	strictEqual(res, true, "bad timestamp, update description to check");
	strictEqual(techinfo.reloadWebs, true, "techinfo reload webs ok");
	cli.disconnectClient(_);

	// get hdat and not a timestamp that match the one in the description
	recOptions.fileName = "cvgClientWS_techsubprog_8_.json";

	cli = new CvgClientWS().init(_, context, recOptions);
	// override _getDescirption in order to simulate a bad timstamp
	cli._getDescription = function(_, wsName, techInfo, ignoreCache) {
		techInfo.loadWebsDuration.start();
		var res = '<?xml version="1.0" encoding="UTF-8" ?><ADXDOC TIM="11111111111111"></ADXDOC>';
		techInfo.loadWebsDuration.stop();
		return res;
	};

	var techinfo = new TechInfo();

	var res = cli._recupHDAT(_, "QLFWSADD", "33333333333333", 0, techinfo);
	strictEqual(res, false, "bad timestamp and not coherent with supervisor one ");
	strictEqual(techinfo.reloadWebs, true, "techinfo reload webs ok");


	cli.disconnectClient(_);


	start();
});
asyncTest("Ws Classic Soap Client -  execWs", function(_) {
	context.httpSession.genericWsCtx = {
		endpoint: endpoints.endpointSUPERV(_),
		user: users.user(_),
		localePref: localePrefs["fr-FR"]
	};
	recOptions.fileName = "cvgClientWS_execWs_1_.json";

	var cli = new CvgClientWS().init(_, context, recOptions);

	var techInfo = new TechInfo();
	var reply = cli.execWS(_, context, {
		name: "QLFWSADD",
		flow: '<?xml version="1.0" encoding="UTF-8"?><PARAM><GRP ID="G1" ><FLD NAME="A" >2.112</FLD><FLD NAME="B" >97.887</FLD><FLD NAME="R" >0</FLD></GRP></PARAM>', // ...xml
		action: "EXEC",
		trace: "",
		wkeys: "",
		nb: 0,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	strictEqual(JSON.stringify(jsxml.parse(reply)), '{"RESULT":{"GRP":{"$":{"ID":"G1"},"FLD":[{"$":{"NAME":"A","TYPE":"Decimal"},"$value":"2.112"},{"$":{"NAME":"B","TYPE":"Decimal"},"$value":"97.887"},{"$":{"NAME":"R","TYPE":"Decimal"},"$value":"99.999"}]}}}', "result ok");
	strictEqual(techInfo.changeLanguage, false, " no change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");


	context2.httpSession.genericWsCtx = {
		endpoint: endpoints.endpointSUPERV(_),
		user: users.user(_),
		localePref: localePrefs["en-US"]
	};

	techInfo = new TechInfo();



	// test change contet with onluy language
	var reply = cli.execWS(_, context2, {
		name: "QLFWSADD",
		flow: '<?xml version="1.0" encoding="UTF-8"?><PARAM><GRP ID="G1" ><FLD NAME="A" >2.112</FLD><FLD NAME="B" >97.887</FLD><FLD NAME="R" >0</FLD></GRP></PARAM>', // ...xml
		action: "EXEC",
		trace: "",
		wkeys: "",
		nb: 0,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	strictEqual(JSON.stringify(jsxml.parse(reply)), '{"RESULT":{"GRP":{"$":{"ID":"G1"},"FLD":[{"$":{"NAME":"A","TYPE":"Decimal"},"$value":"2.112"},{"$":{"NAME":"B","TYPE":"Decimal"},"$value":"97.887"},{"$":{"NAME":"R","TYPE":"Decimal"},"$value":"99.999"}]}}}', "result ok");
	strictEqual(techInfo.changeLanguage, true, "  change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");

	context.httpSession.genericWsCtx = {
		endpoint: endpoints.endpointSUPERV(_),
		user: users.user2(_),
		localePref: localePrefs["fr-FR"]
	};
	techInfo = new TechInfo();

	// test change contet with login and language
	var reply = cli.execWS(_, context, {
		name: "QLFWSADD",
		flow: '<?xml version="1.0" encoding="UTF-8"?><PARAM><GRP ID="G1" ><FLD NAME="A" >2.112</FLD><FLD NAME="B" >97.887</FLD><FLD NAME="R" >0</FLD></GRP></PARAM>', // ...xml
		action: "EXEC",
		trace: "",
		wkeys: "",
		nb: 0,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	strictEqual(JSON.stringify(jsxml.parse(reply)), '{"RESULT":{"GRP":{"$":{"ID":"G1"},"FLD":[{"$":{"NAME":"A","TYPE":"Decimal"},"$value":"2.112"},{"$":{"NAME":"B","TYPE":"Decimal"},"$value":"97.887"},{"$":{"NAME":"R","TYPE":"Decimal"},"$value":"99.999"}]}}}', "result ok");
	strictEqual(techInfo.changeLanguage, true, "  change language  ok ");
	strictEqual(techInfo.changeUserId, true, "  change  user ok ");


	techInfo = new TechInfo();

	// test change contet with login and language
	var reply = cli.execWS(_, context, {
		name: "OAUS",
		flow: '', // ...xml
		action: "READ",
		trace: "",
		wkeys: [{
			key: "USR",
			value: "AP"
		}, {
			key: "LOGIN",
			value: "AP"
		}],
		nb: 0,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	console.log("reply read " + reply);
	var xml = ufs.readFileSync(path + "data/soap/soapReadOaus.xml", 'utf8') || "";
	strictEqual(reply, xml, "reply read OAUS ok");
	strictEqual(techInfo.changeLanguage, false, " no change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");

	var reply = cli.execWS(_, context, {
		name: "OAUS",
		flow: '', // ...xml
		action: "LIST",
		trace: "",
		wkeys: [],
		nb: 10,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	xml = ufs.readFileSync(path + "data/soap/soapListOaus.xml", 'utf8').trim() || "";

	strictEqual(reply, xml, "reply list OAUS ok");
	strictEqual(techInfo.changeLanguage, false, " no change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");

	var reply = cli.execWS(_, context, {
		name: "OAUS",
		flow: '<?xml version="1.0" encoding="utf-8"?><PARAM><GRP ID="AUS1_0"><FLD NAME="INTUSR" >Aurelien</FLD></GRP></PARAM>', // ...xml
		action: "MODIFY",
		trace: "",
		wkeys: [{
			key: "USR",
			value: "AP"
		}],
		nb: 10,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	xml = ufs.readFileSync(path + "data/soap/soapUpdateOaus.xml", 'utf8').trim() || "";
	console.log(reply);

	strictEqual(reply, xml, "reply update OAUS ok");
	strictEqual(techInfo.changeLanguage, false, " no change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");

	// launch again to reset the old value
	var reply = cli.execWS(_, context, {
		name: "OAUS",
		flow: '<?xml version="1.0" encoding="utf-8"?><PARAM><GRP ID="AUS1_0"><FLD NAME="INTUSR" >Aurelien Pisu </FLD></GRP></PARAM>', // ...xml
		action: "MODIFY",
		trace: "",
		wkeys: [],
		nb: 10,
		debugInfo: 0,
		tab: "",
		par: "",
	}, techInfo);

	xml = ufs.readFileSync(path + "data/soap/soapReadOaus.xml", 'utf8').trim() || "";

	strictEqual(reply, xml, "reply reset old value - update OAUS ok");
	strictEqual(techInfo.changeLanguage, false, " no change language  ok ");
	strictEqual(techInfo.changeUserId, false, " no change  user ok ");

	cli.disconnectClient(_);

	start();
});


test("kill", function() {
	done = true;
	start();
});