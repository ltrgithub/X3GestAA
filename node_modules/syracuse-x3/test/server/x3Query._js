"use strict";
// JavaScript Document
var module = QUnit.module;
var assert = require("assert");
var dataModel = require("syracuse-orm/lib/dataModel");
var x3Helper = require("syracuse-x3/test/fixtures/x3Helper");
var helpers = require("syracuse-core/lib/helpers");
var config = require('config'); // must be first syracuse require

var tracer; // = console.log;
var doStop = false;

module(config.unit_test.QLF.folder + ".x3Query", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

asyncTest("start", function(_) {
	ok(x3Helper.initDatabase(_), "syracuse mongodb database initialized");
	x3Helper.initialize(_);
	ok(x3Helper.createObjects(_), "createObjects");
	start();
});

var cookie = null;

function _getCookie(_) {
	cookie = cookie || x3Helper.getCookie(_);
	return cookie;
}

var Representation = function(_class, _repName) {
	this.className = _class;
	this.repName = (typeof _repName == "undefined") ? _class : _repName;

	this.uuid = helpers.uuid.generate();

	this.setup = function(_) {

		var url = x3Helper.x3Url(this.className + "(%27%27)/$services/SETUP?representation=" + this.repName + ".$query&trackingId=" + this.uuid);
		var response = x3Helper.post(_, _getCookie(_), url, {}, 200);
		/*dbg*/
		ok(true, "response:" + JSON.stringify(response));
	};
	this.query = function(_, _param) {
		//!ok(true,"DBG _param:"+typeof(_param));
		if (typeof(_param) == 'undefined') {
			var data = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(this.className + "?representation=" + this.repName + ".$query"), 200);
		} else if (typeof(_param) == 'string') {
			var data = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(this.className + "?representation=" + this.repName + ".$query" + _param), 200);
		} else if (typeof(_param) == 'number') {
			var data = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(this.className + "?representation=" + this.repName + ".$query"), _param);
		}
		/*dbg*/
		ok(true, "DBG query:" + JSON.stringify(data));
		return data;
	};
};

var key;

function getkey(url) {
	ok(true, "url:" + url);
	return url.substring(url.indexOf('&key'));
}

//******************************************************************************

function testAQCQRY01() {

	asyncTest("AQCQRY01 - setup", function(_) {
		var representation = new Representation("AQCQRY01");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY01(FIELD01 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_001', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_020', "last");
		key = getkey(query.$links.$next.$url);
		//!ok(true,"key=>"+key);

		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_020&orderBy=FIELD01', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");
		start();
	});

	asyncTest("AQCQRY01(asc) - second page", function(_) {
		var representation = new Representation("AQCQRY01");
		//!ok(true,"key:"+key);

		var query = representation.query(_, key); //&key=gt.F1_020&orderBy=FIELD01
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_021', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_040', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_021&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_040&orderBy=FIELD01', query.$links.$next.$url);
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY01(FIELD01 asc) - back to the first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=lt.F1_021&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_001', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_020', "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_020&orderBy=FIELD01', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY01(FIELD01 asc) - last page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&key=lt&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_081', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_100', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_081&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY01(FIELD01 asc) - penultimate page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //!'&key=lt.F1_081&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_061', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_080', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_061&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_080&orderBy=FIELD01', query.$links.$next.$url);
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY01(FIELD01 asc) - back to the last page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=gt.F1_080&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_081', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_100', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_081&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY01(FIELD01 desc) - first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_100', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_081', "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_081&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY01(FIELD01 desc) - second page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=lt.F1_081&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_080', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_061', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_080&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_061&orderBy=FIELD01 desc', query.$links.$next.$url);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD01 desc) - back to the first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=lt.F1_021&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_100', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_081', "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_081&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY01(FIELD01 desc) - last page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&key=gt&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_020', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_001', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_020&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY01(FIELD01 desc) - penultimate page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=gt.F1_020&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_040', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_021', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_040&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=lt.F1_021&orderBy=FIELD01 desc', query.$links.$next.$url);
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY01(FIELD01 desc) - back to the last page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key); //'&key=lt.F1_021&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_020', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_001', "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY01.$query&key=gt.F1_020&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");

		start();
	});
	asyncTest("AQCQRY01(FIELD02 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&orderBy=FIELD02%20asc');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_001', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_001', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_092', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_002', "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD02 asc) - second page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_003', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_003', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_094', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_004', "FIELD02." + count);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD02 asc) - back to first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_001', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_001', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_092', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_002', "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD02 desc) - first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&orderBy=FIELD02%20desc');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_100', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_010', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_009', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_009', "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD02 asc) - second page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_098', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_008', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_007', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_007', "FIELD02." + count);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY01(FIELD02 asc) - back to first page", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_100', "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 'F2_010', "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_009', "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 'F2_009', "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY01 - (FIELD01 like 'F1_01%')", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, "&where=(FIELD01%20like%20%27F1_01%25%27)");
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_010', "FIELD01.1");
		strictEqual(query.$resources[9].FIELD01, 'F1_019', "FIELD01.9");
		//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY01 - (FIELD01 between 'F1_020' and 'F1_035')", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, "&where=(FIELD01%20between%20%27F1_020%27%20and%20%27F1_035%27)");

		strictEqual(query.$resources[0].FIELD01, 'F1_020', "FIELD01.1");
		strictEqual(query.$resources[15].FIELD01, 'F1_035', "FIELD01.15");
		//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY01 - $filer(FILTERA)=left$(FIELD01,5) = 'F1_01'", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, "&filter=FILTERA");
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_010', "FIELD01.1");
		strictEqual(query.$resources[9].FIELD01, 'F1_019', "FIELD01.9");
		//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY01 - $filer(FILTERB)=FIELD01 >= 'F1_020' and  FIELD01 <='F1_035'", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, "&filter=FILTERB");

		strictEqual(query.$resources[0].FIELD01, 'F1_020', "FIELD01.1");
		strictEqual(query.$resources[15].FIELD01, 'F1_035', "FIELD01.15");
		//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY01 - (FIELD01 like 'F%')", function(_) {
		var representation = new Representation("AQCQRY01");
		var query = representation.query(_, '&where=(FIELD01%20like%20%27F%25%27)');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 'F1_001', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_020', "last");
		strictEqual(true, ("$links" in query), "$links");
		start();
	});
}

function testAQCQRY02() {

	asyncTest("AQCQRY02 - setup", function(_) {
		var representation = new Representation("AQCQRY02");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY02(FIELD01 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 1, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 20, "last");
		key = getkey(query.$links.$next.$url);

		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.20&orderBy=FIELD01', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");
		start();
	});

	asyncTest("AQCQRY02(asc) - second page", function(_) {
		var representation = new Representation("AQCQRY02");
		//!ok(true,"key:"+key);

		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 21, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 40, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.21&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.40&orderBy=FIELD01', query.$links.$next.$url);
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY02(FIELD01 asc) - back to the first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 1, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 20, "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.20&orderBy=FIELD01', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY02(FIELD01 asc) - last page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, '&key=lt&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 81, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 100, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.81&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY02(FIELD01 asc) - penultimate page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 61, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 80, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.61&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.80&orderBy=FIELD01', query.$links.$next.$url);
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY02(FIELD01 asc) - back to the last page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key); //'&key=gt.F1_080&orderBy=FIELD01');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 81, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 100, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.81&orderBy=FIELD01', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY02(FIELD01 desc) - first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, '&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 100, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 81, "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.81&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY02(FIELD01 desc) - second page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key); //'&key=lt.F1_081&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 80, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 61, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.80&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.61&orderBy=FIELD01 desc', query.$links.$next.$url);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD01 desc) - back to the first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key); //'&key=lt.F1_021&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 100, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 81, "last");
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.81&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY02(FIELD01 desc) - last page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, '&key=gt&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 20, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 1, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.20&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");
		key = getkey(query.$links.$previous.$url);

		start();
	});
	asyncTest("AQCQRY02(FIELD01 desc) - penultimate page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key); //'&key=gt.F1_020&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 40, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 21, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.40&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=lt.21&orderBy=FIELD01 desc', query.$links.$next.$url);
		key = getkey(query.$links.$next.$url);

		start();
	});

	asyncTest("AQCQRY02(FIELD01 desc) - back to the last page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key); //'&key=lt.F1_021&orderBy=FIELD01%20desc');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 20, "first");
		strictEqual(query.$resources[count - 1].FIELD01, 1, "last");
		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY02?representation=AQCQRY02.$query&key=gt.20&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$previous");

		start();
	});
	asyncTest("AQCQRY02(FIELD02 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, '&orderBy=FIELD02%20asc');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 1, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 1, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 92, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 2, "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD02 asc) - second page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 3, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 3, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 94, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 4, "FIELD02." + count);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD02 asc) - back to first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 1, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 1, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 92, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 2, "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD02 desc) - first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, '&orderBy=FIELD02%20desc');
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 100, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 10, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 9, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 9, "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD02 asc) - second page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 98, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 8, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 7, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 7, "FIELD02." + count);
		key = getkey(query.$links.$previous.$url);
		start();
	});

	asyncTest("AQCQRY02(FIELD02 asc) - back to first page", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$resources[0].FIELD01, 100, "FIELD01.1");
		strictEqual(query.$resources[0].FIELD02, 10, "FIELD02.1");
		strictEqual(query.$resources[count - 1].FIELD01, 9, "FIELD01." + count);
		strictEqual(query.$resources[count - 1].FIELD02, 9, "FIELD02." + count);
		key = getkey(query.$links.$next.$url);
		start();
	});

	asyncTest("AQCQRY02 - (FIELD01 between 20 and 35)", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, "&where=(FIELD01%20between%2020%20and%2035)");

		strictEqual(query.$resources[0].FIELD01, 20, "FIELD01.1");
		strictEqual(query.$resources[15].FIELD01, 35, "FIELD01.15");
		//!//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY02 - $filer(FILTERA)=FIELD01 between 20 and 35", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, "&filter=FILTERA");

		strictEqual(query.$resources[0].FIELD01, 20, "FIELD01.1");
		strictEqual(query.$resources[15].FIELD01, 35, "FIELD01.15");
		//!//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY02 - FIELD02 eq 1", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, "&where=FIELD02%20eq%201");

		strictEqual(query.$resources.length, 10, "length");
		for (var i = 0; i < 10; i++) {
			strictEqual(query.$resources[i].FIELD01, 1 + (10 * i), "FIELD01." + i);
		}
		//!//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY02 - FIELD02 eq 5", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, "&where=FIELD02%20eq%205");

		strictEqual(query.$resources.length, 10, "length");
		for (var i = 0; i < 10; i++) {
			strictEqual(query.$resources[i].FIELD01, 5 + (10 * i), "FIELD01." + i + "=" + query.$resources[i].FIELD01);
		}
		//!//!strictEqual(false, ("$links" in query), "$links");
		start();
	});

	asyncTest("AQCQRY02 - $filer(FILTERB)=FIELD02 eq 1", function(_) {
		var representation = new Representation("AQCQRY02");
		var query = representation.query(_, "&filter=FILTERB");

		strictEqual(query.$resources.length, 10, "length");
		for (var i = 0; i < 10; i++) {
			strictEqual(query.$resources[i].FIELD01, 1 + (10 * i), "FIELD01." + i + "=" + query.$resources[i].FIELD01);
		}
		//!//!strictEqual(false, ("$links" in query), "$links");
		start();
	});
}

function testAQCQRY03() {

	asyncTest("AQCQRY03 - setup", function(_) {
		var representation = new Representation("AQCQRY03");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY03 (FIELD01 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY03");
		var count = 20;

		var today = new Date();
		var query = representation.query(_);
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < count; i++) {
			strictEqual(query.$resources[i].FIELD01, i + 1, "FIELD01." + i + "=" + query.$resources[i].FIELD01);
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - (i % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY03 (FIELD01 asc) - second page", function(_) {
		var representation = new Representation("AQCQRY03");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, key);
		key = getkey(query.$links.$previous.$url);
		for (var i = 0; i < count; i++) {
			strictEqual(query.$resources[i].FIELD01, i + count + 1, "FIELD01." + i + "=" + query.$resources[i].FIELD01);
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - (i % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY03 (FIELD01 asc) - back to the first page", function(_) {
		var representation = new Representation("AQCQRY03");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, key);

		for (var i = 0; i < count; i++) {
			strictEqual(query.$resources[i].FIELD01, i + 1, "FIELD01." + i + "=" + query.$resources[i].FIELD01);
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - (i % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY03 (FIELD02 desc) - first page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY03");
		var query = representation.query(_, '&orderBy=FIELD02%20desc') //&where=FIELD02%20lt%20'+date.toISOString());
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < count; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - Math.floor(i / 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY03 (FIELD02 desc) - second page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY03");
		var query = representation.query(_, key) //&where=FIELD02%20lt%20'+date.toISOString());
		key = getkey(query.$links.$previous.$url);

		for (var i = 0; i < count; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - Math.floor((count + i) / 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY03 (FIELD02 desc) - back to the first page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY03");
		var query = representation.query(_, key) //&where=FIELD02%20lt%20'+date.toISOString());
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < count; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - Math.floor(i / 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

}

function testAQCQRY04() {

	asyncTest("AQCQRY04 - setup", function(_) {
		var representation = new Representation("AQCQRY04");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY04 (FIELD01 asc) - first page", function(_) {
		var representation = new Representation("AQCQRY04");
		var count = 20;

		var today = new Date();
		var query = representation.query(_);
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < count; i++) {
			strictEqual(query.$resources[i].FIELD01, i + 1, "FIELD01." + i + "=" + query.$resources[i].FIELD01);
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - ((i + 1) % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 (FIELD02 desc) - second page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY04");
		var query = representation.query(_, key);
		key = getkey(query.$links.$previous.$url);

		for (var i = 0; i < count; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - ((i + 1) % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 (FIELD02 desc) - back to the first page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY04");
		var query = representation.query(_, key);
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < count; i++) {
			strictEqual(query.$resources[i].FIELD01, i + 1, "FIELD01." + i + "=" + query.$resources[i].FIELD01);
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - ((i + 1) % 10));
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 - $filer(FILTERA) FIELD02 = today", function(_) {
		var representation = new Representation("AQCQRY04");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, "&filter=FILTERA");

		for (var i = 0; i < query.$resources[i].length; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			strictEqual(date.toDateString(), today.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 - $filer(FILTERA) FIELD02 = yesterday", function(_) {
		var representation = new Representation("AQCQRY04");
		var count = 20;

		var today = new Date();
		var yesterday = new Date();
		yesterday.setDate(today.getDate() - 1);

		var query = representation.query(_, "&filter=FILTERB");

		for (var i = 0; i < query.$resources[i].length; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			strictEqual(date.toDateString(), yesterday.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 (FIELD02 desc) - first page", function(_) {
		var representation = new Representation("AQCQRY04");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, '&orderBy=FIELD02%20desc');
		key = getkey(query.$links.$next.$url);

		for (var i = 0; i < 10; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			strictEqual(date.toDateString(), today.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 (FIELD02 desc) - second page", function(_) {
		var representation = new Representation("AQCQRY04");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, key);
		key = getkey(query.$links.$previous.$url);

		for (var i = 0; i < 10; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			var expectedDate = new Date();
			expectedDate.setDate(today.getDate() - 2);
			strictEqual(date.toDateString(), expectedDate.toDateString(), date.toDateString());
		}
		start();
	});

	asyncTest("AQCQRY04 (FIELD02 desc) - back to the first page", function(_) {
		var count = 20;
		var today = new Date();

		var representation = new Representation("AQCQRY04");
		var query = representation.query(_, key);

		for (var i = 0; i < 10; i++) {
			var date = new Date(Date.parse(query.$resources[i].FIELD02));
			strictEqual(date.toDateString(), today.toDateString(), date.toDateString());
		}
		start();
	});
}

function testAQCQRY05() {

	asyncTest("AQCQRY05 - setup", function(_) {
		var representation = new Representation("AQCQRY05");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY05 - $filer(FILTERA) FIELD02 = Date", function(_) {
		var representation = new Representation("AQCQRY05");
		var count = 20;

		var today = new Date();
		var query = representation.query(_, "&filter=FILTERA");

		for (var i = 0; i < query.$resources[i].length; i++) {
			strictEqual(query.$resources[i].FIELD02, 8, "FIELD02." + i + "=" + query.$resources[i].FIELD02);
		}
		start();
	});
}

function testIssue1465() {
	asyncTest("Issue #1465 " + x3Helper.gitHubIssue(1465), function(_) {
		var representation = new Representation("ZZZ");
		representation.query(_, 404);
		start();
	});
}

/*
Unit tests for US 91235/2
*/

function testAQCQRY11() {

	asyncTest("AQCQRY11 - setup", function(_) {
		var representation = new Representation("AQCQRY01", "AQCQRY11");
		representation.setup(_);
		start();
	});

	asyncTest("AQCQRY11 - first page", function(_) {
		var representation = new Representation("AQCQRY01", "AQCQRY11");
		var query = representation.query(_);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_100', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_081', "last");
		key = getkey(query.$links.$next.$url);
		//!ok(true,"key=>"+key);

		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY11.$query&key=lt.F1_081&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");
		start();
	});

	asyncTest("AQCQRY11 - second page", function(_) {
		var representation = new Representation("AQCQRY01", "AQCQRY11");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_080', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_061', "last");
		key = getkey(query.$links.$next.$url);
		//!ok(true,"key=>"+key);

		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY11.$query&key=gt.F1_080&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY11.$query&key=lt.F1_061&orderBy=FIELD01 desc', query.$links.$next.$url);
		key = getkey(query.$links.$previous.$url);

		start();
	});

	asyncTest("AQCQRY11 - back to the first page", function(_) {
		var representation = new Representation("AQCQRY01", "AQCQRY11");
		var query = representation.query(_, key);
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_100', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_081', "last");
		key = getkey(query.$links.$next.$url);

		strictEqual(query.$links.$next.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY11.$query&key=lt.F1_081&orderBy=FIELD01 desc', query.$links.$next.$url);
		strictEqual(false, ("$previous" in query.$links), "$previous");

		start();
	});

	asyncTest("AQCQRY11 - last page", function(_) {
		var representation = new Representation("AQCQRY01", "AQCQRY11");
		var query = representation.query(_, '&key=gt');
		var count = 20;

		strictEqual(query.$itemsPerPage, count, "$itemsPerPage");
		strictEqual(query.$resources[0].FIELD01, 'F1_020', "first");
		strictEqual(query.$resources[count - 1].FIELD01, 'F1_001', "last");

		strictEqual(query.$links.$previous.$url, x3Helper.x3Url() + 'AQCQRY01?representation=AQCQRY11.$query&key=gt.F1_020&orderBy=FIELD01 desc', query.$links.$previous.$url);
		strictEqual(false, ("$next" in query.$links), "$next");

		start();
	});

}


testAQCQRY01();
testAQCQRY02();
testAQCQRY03();
testAQCQRY04();
testAQCQRY05();
testIssue1465();
testAQCQRY11();

//******************************************************************************

asyncTest("stop server", 0, function(_) {
	x3Helper.stopServer();
	start();
});

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
