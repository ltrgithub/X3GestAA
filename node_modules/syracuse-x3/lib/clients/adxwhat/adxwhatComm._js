"use strict";

var helpers = require('syracuse-core/lib/helpers');
var commonComm = require('syracuse-x3/lib/clients/common/commonComm');

var tracer = require("syracuse-trace/lib/helper").getTracer("x3Comm.adxwhat");
var WHAT_ID = 9;
var WHAT_SECURE_ID = 109;
/// !doc
/// 
/// # AdxWhatComm module
/// 
/// DO NOT USE THIS MODULE DIRECTLY !!!  
/// This documentation is only provided to understand the protocol layer !  
/// 
/// To interface with adxadmin server, please refer to [AdxWhatClient module API](https://github.com/Sage-ERP-X3/Syracuse/blob/master/node_modules/syracuse-x3/lib/clients/adxwhat/adxwhatClient.md "AdxWhatClient module API").
/// 
/// ---
exports.AdxWhatComm = helpers.defineClass(function(_, client) {
	commonComm.CommonComm.call(this, _, client && client.stream, tracer);
}, commonComm.CommonComm, {

	/// # Connection / Disconnection
	/// 
	/// This chapter describes connection and disconnection sequences with Safe X3 AdxAdmin server component.
	/// 
	/// 
	/// ##**Connection**
	/// 
	/// Opening classic TCP/IP socket on 'server:port' with AdxAdmin server.  
	/// 
	///   - **First step** : open session.  
	///   - Request :  
	///      - **1-byte** : The service ID : 9 by default and 109 for secure mode.  
	///      - **1-byte** : The length to follow.  
	///      - **1-byte** : The user string length.  
	///      - **N-bytes** : The user.
	///      - **1-byte** : The user string length.  
	///      - **N-bytes** : The user.  
	///      - **1-byte** : The password string length.  
	///      - **N-bytes** : The password
	///   - Reply :  
	///      - **4-bytes** : (integer LE) The adonix process PID or -1 if an error occurred.  
	///      - **[1-byte]** : Only if -1 : The message length.  
	///      - **[4-bytes]** : Only if -1 : (integer LE) The adonix error code.  
	///      - **[N-bytes]** : Only if -1 : The error message.  
	/// 
	/// ---
	/// 
	connect: function(_, user, password, secured) {
		var serviceId = secured ? WHAT_SECURE_ID : WHAT_ID;
		if (user == null && password == null && secured == null) {
			throw new Error("adxdwhat implementation does not support wire protocol yet. You must provide 'user/password' informations or set secure parameter to 'false'");
		}
		this._connect(_, serviceId, user, password, secured);
	},

	disconnect: function(_) {
		this._disconnect(_);
	},

	/// # Common operations
	/// 
	/// This chapter describes the unique operation provided by adxwhat that is ask for environment variable on adxadmin server.  
	/// 
	/// 
	/// ##**Ask**
	/// 
	/// Ask for environment variable on adxadmin server.  
	/// 
	///   - **First step** : open session.  
	///   - Request :  
	///      - **1-byte** : The length of the variable name asked + 1.  
	///      - **N-bytes** : The variable name.  
	///   - Reply :  
	///      - **4-bytes** : (integer BE) The response length.  
	///      - **N-bytes** : The value of the remote environment variable.  
	/// 
	/// ---
	/// 
	_writeBufAsk: function(infoId) {
		tracer.info && tracer.info("\n### Create buffer Ask for infoId: " + infoId + " ###");
		var lenInfo = 0;
		if (infoId != null) {
			lenInfo = infoId.length + 1;
		}
		var buf = new Buffer([lenInfo]);
		tracer.info && tracer.info(commonComm.traceBuffer(0, "InfoID length (" + lenInfo + ")", buf));
		if (lenInfo > 0) {
			var bufStr = new Buffer(infoId, "utf-8");
			tracer.info && tracer.info(commonComm.traceBuffer(1, "InfoID (" + infoId + ")", bufStr));
			var bufEnd = new Buffer([0]);
			buf = Buffer.concat([buf, bufStr, bufEnd]);
		}
		tracer.info && tracer.info(buf);
		return buf;
	},
	_readBufAsk: function(buf, id) {
		switch (id) {
			case 0:
				tracer.info && tracer.info(commonComm.traceBuffer(id, "Length of value", buf));
				return buf.readInt32BE(0);
			case 1:
				buf = buf.slice(0, buf.length - 1);
				tracer.info && tracer.info(commonComm.traceBuffer(id, "Value", buf));
				return buf.toString("utf-8");
			default:
				throw new Error("Can't read! Reply not expected!");
		}
	},
	processAsk: function(_, infoId) {
		this._checkStream();
		this.stream.write(_, this._writeBufAsk(infoId));
		tracer.info && tracer.info("\n### Read buffer Ask for infoId: " + infoId + " ###");
		var len = this._readBufAsk(this.stream.read(_, 4), 0);
		if (len > 0) {
			return this._readBufAsk(this.stream.read(_, len), 1);
		}
		return "";
	}
});