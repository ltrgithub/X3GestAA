"use strict";

var helpers = require('syracuse-core/lib/helpers');
var locale = require("syracuse-core/lib/locale");


var CommError = exports.CommError = helpers.defineClass(function(message) {
	Error.call(this);
	Error.captureStackTrace(this, this);
	this.message = message;
}, Error, {});


var traceBuffer = exports.traceBuffer = function(tracer, id, descr, buf) {
	if (buf)
		tracer.info && tracer.info("Buffer[" + id + "] (" + descr + ") = " + buf.toString('hex') + " [Length: " + buf.length + "]");
};


exports.CommonComm = helpers.defineClass(function(_, stream, tracer) {
	this.stream = stream;
	this.tracer = tracer;
}, null, {
	_checkStream: function() {
		if (!this.stream) throw new CommError(locale.format(module, "streamNull"));
	},

	_writeBufConnect: function(params) {
		this.tracer.info && this.tracer.info("\n### Create buffer for CONNECTION ###");
		var bufServiceId = new Buffer(1);
		bufServiceId.writeInt8(params.serviceId, 0);
		var buf;
		if (params.user && params.password) {
			var bufUser = new Buffer(params.user, "utf-8");
			var bufPass = new Buffer(params.password, "utf-8");
			var bufLenUser = new Buffer(1);
			bufLenUser.writeInt8(bufUser.length, 0);
			var bufLenPass = new Buffer(1);
			bufLenPass.writeInt8(bufPass.length, 0);
			var bufLenUtil = new Buffer(1);
			bufLenUtil.writeInt8(bufUser.length * 2 + bufPass.length + 3, 0);

			this.tracer.info && this.tracer.info("Buffer[0] (Service ID) " + bufServiceId.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[1] (Length to follow) " + bufLenUtil.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[2] (User length) " + bufLenUser.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[3] (User) " + bufUser.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[4] (User length) " + bufLenUser.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[5] (User) " + bufUser.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[6] (Password length) " + bufLenPass.toString("hex"));
			this.tracer.info && this.tracer.info("Buffer[7] (Password) " + bufPass.toString("hex"));
			buf = Buffer.concat([bufServiceId, bufLenUtil, bufLenUser, bufUser, bufLenUser, bufUser, bufLenPass, bufPass]);
		} else {
			buf = Buffer.concat([bufServiceId, new Buffer([0])]);
		}
		this.tracer.info && this.tracer.info(buf);
		return buf;
	},
	_connect: function(_, serviceId, user, password, secured) {

		this._checkStream();
		this.stream.write(_, this._writeBufConnect({
			serviceId: serviceId,
			secured: secured,
			user: user,
			password: password
		}));

		this.tracer.info && this.tracer.info("\n### Read buffer for order: CONNECT ###");
		var buf = this.stream.read(_, 4);
		var pid = buf.readInt32BE(0);
		if (pid > -1) {
			traceBuffer(this.tracer, 0, "PID", buf);
			this.tracer.info && this.tracer.info("Adonix process pid: " + pid);
			return pid;
		} else {
			buf = this.stream.read(_, 5);
			traceBuffer(this.tracer, 1, "Message length (1) and error code (4)", buf);
			var msgLen = buf.readInt8(0);
			var errCode = buf.readInt32BE(1);
			buf = this.stream.read(_, msgLen);
			traceBuffer(this.tracer, 2, "Error message", buf);
			var msg = buf.toString('utf-8');
			throw new CommError(locale.format(module, "connectionFailed", errCode, msg));
		}
	},
});