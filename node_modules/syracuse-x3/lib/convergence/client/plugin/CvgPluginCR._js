"use strict";
var helpers = require('@sage/syracuse-core').helpers;
var CvgPluginTarget = require('../../model/CvgPluginTarget').CvgPluginTarget;
var flows = require('streamline-runtime').flows;
var CvgObserver = require('../CvgObserver').CvgObserver;
var CvgSpecialAction = require('../CvgAction').SpecialActions;
var CvgServices = require('../CvgPluginServices');
var CvgResu = require('../../types/CvgResu').TDO;
var CvgResuTdo = require('../../types/CvgResu').CvgResu;
var CvgIst = require('../../types/CvgIst').CvgIst;
var CvgPlugin = require('./CvgPlugin').CvgPlugin;
var NAME_GANT = "gantt";
var NAME_SCALE = "scale";
var adminHelper = require("@sage/syracuse-lib/src/collaboration/helpers").AdminHelper;


//
var notBlindProp = ["UIAction"];
exports.CvgPluginCR = helpers.defineClass(function(client, id) {
	CvgPlugin.call(this, client, id);
	this.class = "CrystalReport";
	this.method = "new";
	this.name = "development";
	this.blindProperties = {};
	CvgPluginTarget.create(client, this);
	this.Folder = null;
	this.Solution = null;
}, CvgPlugin, {

	addBlindProperties: function(_, values) {
		var self = this;
		Object.keys(values).forEach(function(key) {
			if (notBlindProp.indexOf(key) === -1) {
				self.blindProperties[key] = values[key];
				if (key === 'Folder' || key === 'Solution') {
					self[key] = values[key];
				}
			}
		});
		// deduce endpoint and add endpointproxy url in property
		var db = adminHelper.getCollaborationOrm(_);
		// we can have multiple x3solution with the same solution name
		var solutions = db.fetchInstances(_, db.getEntity(_, "x3solution"), {
			jsonWhere: {
				solutionName: this.Solution
			}
		});
		if (!solutions) throw new Error("No solution found with name [" + this.Solution + "]");
		var endpoint = null;
		for (var i = 0; i < solutions.length && !endpoint; i++) {
			var solution = solutions[i];
			var endpoints = solution.endpoints(_).toArray(_).filter_(_, function(_, ep) {
				return ep.x3ServerFolder(_) === self.Folder;
			});
			endpoint = endpoints.length > 0 && endpoints[0] ? endpoints[0] : null;

		}
		if (!endpoint) throw new Error("No endpoint found for solution [" + this.Solution + "] and folder [" + this.Folder + "]");

		this.endpointProxy = "/sdata/" + endpoint.application(_) + "/" + endpoint.contract(_) + "/" + endpoint.dataset(_) + "/";
	},

	toJSON: function() {
		var self = this;
		var res = CvgPlugin.prototype.toJSON.call(this);
		Object.keys(this.blindProperties).forEach(function(key) {
			res.plugin[key] = self.blindProperties[key];
		});
		// add endpointProxy
		res.plugin.EndpointProxy = this.endpointProxy;
		return res;
	},

	specialAction532: function(_, context, body, tracker) {
		// no orchestration we have to wai the end of current processAction by call the funnalAction.
		this.writeAckReply(_, body && body.param && body.param.plugin);
		// delete plugin from plugin list in client
		var self = this;
		self.client.clientCrDeletePlugin();

		this.client.funnelAction(_, function(_) {
			// wait the end of current request in progress to delete the crystal report connector plugin

		});

	}

}); // Dummy comment to clean up rollout repository #6948