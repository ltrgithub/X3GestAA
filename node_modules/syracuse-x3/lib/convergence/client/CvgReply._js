"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CAdonixReply = Object; //require('syracuse-x3/lib/convergence/CAdonixReply').CAdonixReply;
var CvgMessage = require('syracuse-x3/lib/convergence/model/CvgMessage').CvgMessage;
var CvgInstance = require('syracuse-x3/lib/convergence/model/CvgInstance').CvgInstance;
var CvgInstances = require('syracuse-x3/lib/convergence/model/CvgInstances').CvgInstances;
var CvgEntity = require('syracuse-x3/lib/convergence/model/CvgEntity').CvgEntity;
var CvgMessages = require('syracuse-x3/lib/convergence/model/CvgMessages').CvgMessages;
var CvgMenuWin = require('syracuse-x3/lib/convergence/model/CvgMenuWin').CvgMenuWin;
var CvgWinMenuList = require('syracuse-x3/lib/convergence/model/CvgMenuWin').CvgWinMenuList;
var CvgStackedWindows = require('syracuse-x3/lib/convergence/model/CvgStackedWindows').CvgStackedWindows;
var CvgVariable = require('syracuse-x3/lib/convergence/model/CvgVariable').CvgVariable;
var CvgVariableDate = require('syracuse-x3/lib/convergence/model/CvgVariableDate').CvgVariableDate;


var util = require('util');

var WINDOW_NO_CHANGE = false;

/**
 * Structure publique de reponse a une requete fournie a l'application cliente.
 * */
var CvgReply = exports.CvgReply = helpers.defineClass(function(aClient, aOrderId, aSTAT, aReplyMessages) {
	aSTAT = aSTAT !== undefined ? aSTAT : 1;
	CAdonixReply.call(this, aOrderId, aSTAT, aReplyMessages);
	this.orderId = aOrderId;
	this.client = aClient;
	this.instances = null;
	this.targetEntity = null;
	this.targetIst = null;
	this.messages = [];
	this.callUiOpenFiles = null;
	this.changeWindow = new Boolean(WINDOW_NO_CHANGE);
	this.popedWindows = null;
	this.pusheddWindows = null;
	this.winMenus = null;
	this.stayInCommandMode = false;
	this.status = 1;
}, CAdonixReply, {
	addInstance: function(aInstance) {
		if (this.instances == null) this.instances = new CvgInstances();
		this.instances.add(aInstance);
		if (aInstance.hasException()) {
			this.setTargetAdxIdEntity(aInstance.ist, aInstance.entity);
		}
		return aInstance;
	},
	addLogicalErrorMess: function(aObject, aMethod, aIst, aMessage) {
		//throw new Error(aMessage); // for now
		if (this.client.isWithLogicalErrDetails()) {
			var wMessage = this.messages.getFirstMessageOfTtyp(CvgReply.WEBSERVER);
			if (wMessage == null) {
				var wMess = this.client.getMessage('ERROR_LOGICAL');
				wMessage = new CvgMessage(CvgReply.WEBSERVER, this.client, wMess, false);
				this.messages.addMessage(wMessage);
			}
			wMessage.addWebServerLogicalMess(buildLogicalErrorMess(aObject, aMethod, aIst, aMessage));
		}
	},
	addMessage: function(aMessage) {
		this.messages.push(aMessage);
		return aMessage;
	},
	/* TODO overload
	addMessage: function(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx) {
		return this.addMessage(new CvgMessage(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx, this.client));
	},
	*/
	addTargetInstance: function() {
		var wFormatString = null;
		var wFormattedValue = null;
		var wServerValue = null;
		var wInstance;
		try {
			var wVariable = this.getTargetEntity();
			if (this.getTargetEntity() instanceof CvgVariable) {
				if (wVariable.acceptEditFormat()) {
					wFormatString = this.validTargetFormat(wVariable.format);
					wFormattedValue = wVariable.formatX3ToEdit();
					wServerValue = wVariable.getServerValStr();
				}
			}
			wInstance = CvgInstance.newtarget(this.client, this.targetIst, wFormatString, wFormattedValue, this.stayInCommandMode);
			if (wVariable instanceof CvgVariableDate) {
				wInstance.rawValue = wVariable.getServerValStr();
			}
		} catch (e) {
			console.error(e);
			var wMessage = new CvgMessage(CvgReply.WEBSERVER, this.client, e.message, false);
			this.addMessage(wMessage);
			wInstance = CvgInstance.newtarget(this.client, this.targetIst, wFormatString, wServerValue, this.stayInCommandMode);
		}
		this.addInstance(wInstance);
		return wInstance;
	},
	findTargetEntity: function(aStructIst) {
		var wModifiable = this.client.findModifiable(aStructIst);

		if (wModifiable != null && wModifiable instanceof CvgEntity) {
			return wModifiable;
		} else {
			return null;
		}
	},
	getTargetEntity: function() {
		if (this.targetEntity == null) {
			var wTargetEntity = this.targetIst ? this.findTargetEntity(this.targetIst) : null;
			if (wTargetEntity == null) {
				var wMess = this.client.getMessage('ERROR_CURFORMAT_NOIST', this.targetIst == null ? "NULL" : this.targetIst.toString());
				this.client.addLogicalErrorMess(this, "getTargetFormat", this.targetIst == null ? "NULL" : this.targetIst.toString(), wMess);
			} else {
				setTargetEntity(wTargetEntity);
			}
		}
		return this.targetEntity;
	},
	hasTargetEntityField: function() {
		var wEntity = this.getTargetEntity();
		return wEntity != null && wEntity instanceof CvgVariable;
	},
	setTargetAdxIdEntity: function(aTargetIst, aEntity) {
		this.targetIst = aTargetIst;
		this.setTargetEntity(aEntity);
	},
	setTargetAdxId: function(aTargetIst, request) {
		this.setTargetAdxIdEntity(aTargetIst, this.findTargetEntity(aTargetIst));
		
		if (request != null){
		
			var instance = this.addTargetInstance();
			if (aTargetIst.isLeftListIst() && request.lefListLineSelected !== -1) {
				instance.nl = request.lefListLineSelected + 1;
			}
			this.client.setCurrentField(instance);
		}else {
			if (this.hasTargetEntityField()) {
				this.addTargetInstance();
			}
		}
	},
	setTargetEntity: function(aTargetEntity) {
		this.targetEntity = aTargetEntity;
	},
	traverseInstances: function(aTraverser) {
		if (this.instances != null) {
			this.instances.traverseChilds(aTraverser);
		}
	},
	validTargetFormat: function(aFormat) {
		if (aFormat == null || !aFormat.isValid()) {
			var wMess = this.client.getMessage('ERROR_CURFORMAT_NOFORMAT', this.targetIst.toString());
			this.client.addLogicalErrorMess(this, "getTargetFormat", this.targetIst.toString(), wMess);
			return wMess;
		} else {
			return aFormat.format;
		}
	},
	addAskOpenFile: function(askOpenFile) {
		if (this.callUiOpenFiles == null) {
			this.callUiOpenFiles = [];
		}
		return this.callUiOpenFiles.push(askOpenFile);
	},

	// AJOUT MENU FENETRE
	addMenuWin: function(flag, actionId, label, menuId, rank, adxId, accelerateur) {
		if (this.winMenus == null) {
			this.winMenus = new CvgWinMenuList();
		}
		var winMenu = menuId === 307 || this.winMenus.containsMenu(menuId);
		var menu = new CvgMenuWin(this.client, actionId, flag, label, menuId, rank, adxId, accelerateur, !winMenu);
		if (winMenu) {
			this.winMenus.addMenu(menu);
		}
	},
	addMessageAbort: function(e) {
		this.messages.addMessageAbort(e);
	},
	addPopedWindow: function(aRequesterWindow) {
		if (this.popedWindows == null) {
			this.popedWindows = new CvgStackedWindows();
		}
		this.popedWindows.push(aRequesterWindow);
		this.setChangeWindow();
	},
	addPushedWindow: function(aRequesterWindow) {
		if (this.pusheddWindows == null) {
			this.pusheddWindows = new CvgStackedWindows();
		}
		this.pusheddWindows.push(aRequesterWindow);
		aRequesterWindow.setMenuList(this.winMenus);
		this.winMenus = null;
	},
	getPopedWindowId: function(aIdx) {
		if (hasPopedWindow() && aIdx < this.popedWindows.length) {
			return this.popedWindows.get(aIdx).id;
		} else {
			return null;
		}
	},
	getPushedWindow: function(aIdx) {
		if (hasPushedWindow() && aIdx < this.pusheddWindows.length) {
			return this.pusheddWindows.get(aIdx);
		} else {
			return null;
		}
	},
	getPushedWindowId: function(aIdx) {
		var wRequesterWindow = getPushedWindow(aIdx);
		if (wRequesterWindow != null) {
			return wRequesterWindow.id;
		} else {
			return null;
		}
	},
	hasPopedWindow: function() {
		return this.popedWindows != null && this.popedWindows.length > 0;
	},
	hasPushedWindow: function() {
		return this.pusheddWindows != null && this.pusheddWindows.length > 0;
	},
	isWindowChanged: function() {
		return this.changeWindow.booleanValue();
	},
	setAskOpenHelpParam: function(aAskOpenHelpParam) {
		// TODO - Non utilisé  this.askOpenHelpParam = aAskOpenHelpParam;
	},
	setAskOpenSession: function(aOpenSessionParam) {
		// TODO - Non utilisé this.askOpenSessionParam = aOpenSessionParam;
	},
	setAskUiAction: function(aAskUiAction) {
		// TODO - Non utilisé this.askUiAction = aAskUiAction;
	},
	setChangeWindow: function() {
		this.changeWindow = new Boolean(true);
	},
	setStamp: function(aStamp) {
		// TODO - Non utilisé this.sTAMP = CvgReply.convReplyLong(aStamp);
	}
});

CvgReply.WEBSERVER = 98;

CvgReply.buildLogicalErrorMess = function(aObject, aMethod, aIst, aMessage) {
	var wSB = new StringBuilder();
	wSB.append(CStringFacilities.getClasseName(aObject.class));
	wSB.append('^');
	wSB.append(aMethod);
	wSB.append('^');
	wSB.append(aIst);
	wSB.append('^');
	wSB.append(aMessage);
	return wSB.toString();
}
