"use strict";
var globals = require('streamline/lib/globals');
var licenseCheck = require("syracuse-license/lib/check");
var locale = require("syracuse-core/lib/locale");

exports.$exported = true;

exports.getManifest = function(_, prod, vers) {
	var diags = [],
		manifest, i, err = [],
		mess = null,
		excpt = null;
	try {
		manifest = licenseCheck.getX3LicenseInfo(_, prod, vers, globals.context.session, diags);
		if (!manifest) {
			if (diags.length) {
				for (i = 0; i < diags.length; i++) {
					mess = diags.$message;
					if (mess && diags.$details) {
						mess += "(" + diags.$details + ").";
					}
					if (mess) {
						err.push(mess);
					}
				}
				mess = err.length ? err.join("\n") : null;
			}
			if (!mess) {
				mess = locale.format(module, "LIC_MANIFEST_CANTGET");
			}
		}
	} catch (e) {
		mess = null;
		excpt = e;
		excpt.message = locale.format(module, "LIC_MANIFEST_UNEXPECTED") + (excpt.message ? (" (" + e.message + ")") : "");
	} finally {
		if (mess) {
			throw new Error(mess);
		}
		if (excpt) {
			throw excpt;
		}

		return manifest;
	}
};