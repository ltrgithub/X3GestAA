"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CvgObservable = require('syracuse-x3/lib/convergence/model/CvgObservable').CvgObservable;
var CvgIst = require('syracuse-x3/lib/convergence/types/CvgIst').CvgIst;

var _lastTick = 0;

function _getTick() {
	// JavaScript number precision does not let us go beyond (fake) microsecond.
	var tick = Date.now() * 1000;
	if (tick <= _lastTick) {
		tick = _lastTick + 1;
	}
	_lastTick = tick;
	return tick;
}

var FusionEntityState = exports.FusionEntityState = helpers.defineClass(function(maskVal, maskAtt, maskNot) {
	this.maskVal = maskVal;
	this.maskAtt = maskAtt;
	this.maskNot = maskNot;
}, null, {
	isOn: function(status) {
		return (this.maskVal & status) > 0;
	},
	setBits: function(status, on) {
		var isOn = this.isOn(status);
		if (on && !isOn) {
			return status | this.maskVal | this.maskAtt;
		}
		if (!on && !isOn) {
			return status & this.maskNot | this.maskAtt;
		}
		return status;
	},
	isNotOn: function(status) {
		return !this.isOn(status) && ((status & this.maskAtt) > 0);
	},

});

FusionEntityState.razAtt = function(status) {
	return status & 0x0000FFFF;
};

FusionEntityState.ACTIF = new FusionEntityState(0x0001, 0x00010000, 0xFFFFFFFE);
FusionEntityState.READONLY = new FusionEntityState(0x0002, 0x00020000, 0xFFFFFFFD);
FusionEntityState.VISIBLE = new FusionEntityState(0x0004, 0x00040000, 0xFFFFFFFB);
FusionEntityState.SELECTED = new FusionEntityState(0x0008, 0x00080000, 0xFFFFFFF7);

function _readableState(state) {
	var r = "";
	if (FusionEntityState.VISIBLE.isNotOn(state)) r += "!V";
	if (FusionEntityState.VISIBLE.isOn(state)) r += "V";
	if (FusionEntityState.ACTIF.isNotOn(state)) r += "!E";
	if (FusionEntityState.ACTIF.isOn(state)) r += "E";
	if (FusionEntityState.SELECTED.isNotOn(state)) r += "!S";
	if (FusionEntityState.SELECTED.isOn(state)) r += "S";
	if (FusionEntityState.READONLY.isNotOn(state)) r += "!R";
	if (FusionEntityState.READONLY.isOn(state)) r += "R";
	return r;
}

var FusionMetaData = exports.FusionMetaData = {
	STY: 0,
	STT: 1,
	TIT: 2,
	FMT: 3
};

// Etats gere par ADAPI
/**
 * <pre>
 *  0  0  0  0  0  0  0
 *  ^  ^  ^  ^  ^  ^  ^
 *  |  |  |  |  |  |  |
 *  |  |  |  |  |  |  +- VISIBLE
 *  |  |  |  |  |  +- EDITABLE
 *  |  |  |  |  +- GRIZO
 *  |  |  |  +- DISZO
 *  |  |  +- SELECTED
 * </pre>
 */
var STATE_VISIBLE = 1;
var STATE_NOT_VISIBLE = 2;
var STATE_ENABLE = 4;
var STATE_NOT_ENABLE = 8;
var STATE_SELECT = 16;
var STATE_NOT_SELECT = 32;
var STATE_READONLY = 64;
var STATE_NOT_READONLY = 128;
var STATE_DEFAULT = 0;
//Bits    15 14 13 12 11 10 09 08 07 06 05 04 03 02 01 0
//|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  +-- Etat                 ==> 0 : inactif(Grizo)  - 1 : actif (actzo)
//|  |  |  |  |  |  |  |  |  |  |  |  |  |  +----- Lecture seule (Diszo)==> 0 : non             - 1 : oui
//|  |  |  |  |  |  |  |  |  |  |  |  |  +-------- Apparence            ==> 0 : invisible       - 1 : visible
//|  |  |  |  |  |  |  |  |  |  |  |  +----------- Statut               ==> 0 : deselectionne   - 1 : selectionne
//Bits    31 30 29 28 27 26 25 24 23 22 21 20 19 18 17 16
//|  |  |  |  |  |  |  |  |  |  |  |  |  |  |  +-- Notion Etat          ==> 0 : absente         - 1 : presente
//|  |  |  |  |  |  |  |  |  |  |  |  |  |  +----- Notion Lecture seule ==> 0 : absente         - 1 : presente
//|  |  |  |  |  |  |  |  |  |  |  |  |  +-------- Notion Apparence     ==> 0 : absente         - 1 : presente
//|  |  |  |  |  |  |  |  |  |  |  |  +----------- Notion Statut    ==> 0 : absente             - 1 : presente

function _calcJsonNewEntityState(curFusionState, stateToAdd) {
	var addActif = (stateToAdd & STATE_ENABLE) > 0;
	var addNotActif = (stateToAdd & STATE_NOT_ENABLE) > 0;
	var addVisible = (stateToAdd & STATE_VISIBLE) > 0;
	var addNotVisible = (stateToAdd & STATE_NOT_VISIBLE) > 0;
	var addReadOnly = (stateToAdd & STATE_READONLY) > 0;
	var addNotReadOnly = (stateToAdd & STATE_NOT_READONLY) > 0;
	var addSelect = (stateToAdd & STATE_SELECT) > 0;
	var addNotSelect = (stateToAdd & STATE_NOT_SELECT) > 0;
	var newFusionState = curFusionState;
	if (addActif) {
		newFusionState = FusionEntityState.ACTIF.setBits(newFusionState, true);
	}
	if (addNotActif) {
		newFusionState = FusionEntityState.ACTIF.setBits(newFusionState, false);
	}
	if (addVisible) {
		newFusionState = FusionEntityState.VISIBLE.setBits(newFusionState, true);
	}
	if (addNotVisible) {
		newFusionState = FusionEntityState.VISIBLE.setBits(newFusionState, false);
	}
	if (addReadOnly) {
		newFusionState = FusionEntityState.READONLY.setBits(newFusionState, true);
	}
	if (addNotReadOnly) {
		newFusionState = FusionEntityState.READONLY.setBits(newFusionState, false);
	}
	if (addSelect) {
		newFusionState = FusionEntityState.SELECTED.setBits(newFusionState, true);
	}
	if (addNotSelect) {
		newFusionState = FusionEntityState.SELECTED.setBits(newFusionState, false);
	}
	return newFusionState;
}

//var STATE_GRIZO = 4;
// Etats recu du serveur X3
var X3_SRV_GRIZO = 0;
var X3_SRV_ACTZO = 1;
var X3_SRV_DISZO = 2;
// Variables X3 - attribut MAF du xml
var X3VAR_MAF_AFFICHE = 2;
var X3VAR_MAF_INVISIBLE = 3;
var X3VAR_MAF_SAISI = 1;
var X3VAR_MAF_TECHNIQUE = 4;

var AT = '@'.charCodeAt(0);

var CvgEntity = exports.CvgEntity = helpers.defineClass(function(aClient, aId, aEntityIndexBaseOne, aEntityTyp) {
	CvgObservable.call(this, aClient);
	this.alternativeId = null;
	this.id = aId;
	this.state = STATE_DEFAULT;
	this.visible = STATE_VISIBLE;
	this.selected = false;
	this.actzo = X3_SRV_ACTZO;
	this.isTitleModified = false;
	this.format = null;
	this.formatStr = "";
	this.columnFormater = null;
	this.srvValueModified = false;
	this.formatModified = false;
	this.styleModified = false;
	this.stylePColorModified = false;
	this.serverValue = null;
	this.stateModified = false;
	this.style = "";
	this.stylePColor = "";
	// Label champ, titre fenetre
	this.title = null;
	this.titleStyle = null;
	this.lastStampModVisible = -1;
	this.lastStampModSelected = -1;
	this.lastStampModActzo = -1;
	this.lastStampModState = -1;
	this.lastStampModPCol = -1;
	this.kindStateChange = "";
	this.lastStampModSty = -1;
	this.lastStampModFmt = -1;
	this.lastStampModTit = -1;
	this.entityIdxAlpha = null;
	this.forceServerValueModification(true);
	this.client = aClient;
	this.entityIndexBaseOne = aEntityIndexBaseOne;
	this.pColor = -1;
	this.pColorList = {};
	this.optimChvl = -1;
	// AlphaNum
	var wSB = "";
	var w26E1 = Math.floor(this.entityIndexBaseOne / 26);
	if (w26E1 > 0) {
		wSB += String.fromCharCode(AT + w26E1);
		wSB += String.fromCharCode(AT + this.entityIndexBaseOne % 26);
	} else {
		wSB += String.fromCharCode(AT + this.entityIndexBaseOne);
	}
	//console.log("CREATE " + aEntityTyp + " entityIdxAlpha=" + wSB + ', index=' + aEntityIndexBaseOne);
	this.entityIdxAlpha = wSB;
	this.entityTyp = aEntityTyp;
	// force change, this method perform update if jsonType is sepcified else we need to forceChange again
	this.forceChange();
}, CvgObservable, {
	cloneValues: function(v) {
		v.style = this.style;
		v.formatStr = this.formatStr;
		if (this.formatStr != null && this.formatStr !== "") {}
		if (this.style !== "") {
			v.setLastStampMod(_getTick(), 'STY');
		}
		if (this.serverValue != null) {
			v.serverValue = this.serverValue.clone();
		}
	},
	calculateState: function() {
		this.state = 0;
		if (this.lastStampModVisible != -1) {
			this.state = _calcJsonNewEntityState(this.state, this.visible);
		}
		if (this.lastStampModSelected != -1) {
			this.state = _calcJsonNewEntityState(this.state, this.selected ? STATE_SELECT : STATE_NOT_SELECT);
		}
		if (this.lastStampModActzo != -1) this.state = _calcJsonNewEntityState(this.state, this.actzo);
		return this.lastStampModState;
	},
	setVisible: function(bool) {
		if (bool) {
			this.visible = STATE_VISIBLE;
		} else {
			this.visible = STATE_NOT_VISIBLE;
		}
		this.setLastStampMod(_getTick(), 'VIS');
	},
	setActGriDiszo: function(val) {
		this.actzo = val;
		this.setLastStampMod(_getTick(), 'ACT');
	},
	setSelected: function(val) {
		this.selected = val;
		this.setLastStampMod(_getTick(), 'SEL');
	},
	stateSet: function(aNewState, force) {
		var old = this.state;
		var niou = _calcJsonNewEntityState(this.state, aNewState);
		if (force || old !== niou) {
			this.setLastStampMod(_getTick(), 'STT');
		}
		if (force || this.state !== niou) {
			this.state = niou;
			this.stateModified = true;
		}
	},
	forceServerFormat: function(aServerFormat) {
		if (this.format == null || aServerFormat.format === this.format.format) {}
		this.format = aServerFormat;
	},
	storeFormat: function(aFormat) {
		this.format = aFormat;
	},
	updateFormatTick: function() {
		if (this.formatStr) this.setLastStampMod(_getTick(), 'FMT');
	},
	getPColor: function() {
		return this.pColor;
	},

	setPColor: function(color) {
		this.pColor = color;
		this.stylePColorModified = true;
		this.setLastStampMod(_getTick(), 'PCOL');
	},
	forceServerValueModification: function(count) {
		this.srvValueModified = count;
	},

	// WINID + SCREENID + BLOCID + FIELDID
	getObservableId: function() {
		var ist = this.getAdxIst();
		if (ist != null) {
			var fullId = "";
			fullId += ist.winAlphaId;
			if (this.entityTyp !== 'WINDOW') {
				fullId += ist.screenAlphaIdFusion;
				if (this.entityTyp !== 'SCREEN') {
					fullId += ist.blocAlphaId;
					if (this.entityTyp === 'FIELD') {
						fullId += ist.field;
					}
				}
			}
			return fullId;
		}
		return null;
	},

	//getAdxId: function();
	// Todo - Optimiser sur modif adxId
	getAdxIst: function() {
		return new CvgIst(this.getAdxId());
	},

	getFatherWindowId: function() {
		// using identity id to find the windows
		return this.getAdxId() == null ? null : this.getAdxIst().winAlphaId;
	},

	// Cle pour entree JSON fusion - ON supprime le code window
	// WIN      -> WINID                                - Ex B
	// SCREEN   -> SCREENID                             - Ex B
	// BLOC     -> SCREENID  + BLOCID                   - Ex BA
	// FIELD    -> SCREENID  + BLOCID +  FIELD ID       - Ex BA3
	getJsonKey: function() {
		var jsonKey = "";
		var ist = this.getAdxIst();
		if (this.alternativeId) {
			jsonKey = this.alternativeId;
		} else {
			if (ist == null) {
				return null;
			}
			if (this.entityTyp === 'WINDOW') {
				return ist.winAlphaId;
			}
			if (this.entityTyp === 'SCREEN') {
				return ist.screenAlphaIdFusion;
			}
			jsonKey += ist.screenAlphaIdFusion;
			jsonKey += ist.blocAlphaId;
		}
		if (this.entityTyp === 'FIELD') {
			jsonKey += ist.field;
		}
		return jsonKey;
	},
	getRsrcMess: function(id) {
		return this.client.getMessage(id);
	},
	getServerValInt: function() {
		return this.serverValue !== null && this.serverValue.value !== undefined ? this.serverValue.value : -1;
	},
	getServerValStr: function() {
		return this.serverValue != null ? this.serverValue.value : "";
	},
	hasColumnFormater: function() {
		return this.columnFormater != null;
	},
	hasModifState: function() {
		return this.stateModified;
	},
	hasModifStyle: function() {
		return this.styleModified;
	},
	hasModifTitle: function() {
		return this.isTitleModified;
	},
	// retourne vrai si la valeur a ete changee par le serveur
	hasServerValueModification: function() {
		return this.srvValueModified;
	},
	isDisposed: function() {
		return this.client == null;
	},
	isServerValueEquals: function(aValue) {
		return this.serverValue != null ? this.serverValue.equals(aValue) : aValue == null;
	},
	isStateEditable: function() {
		return FusionEntityState.ACTIF.isOn(this.state);
	},
	getReadableState: function() {
		return _readableState(this.state);
	},
	razModification: function() {
		CvgObservable.prototype.razModification.call(this);
		// #1046 - FDB - !!! DO NOT RAZ this.state
		this.formatModified = false;
		this.stateModified = false;
		this.styleModified = false;
		this.stylePColorModified = false;
		this.isTitleModified = false;
		this.lastStampModFmt = -1;
		this.lastStampModPCol = -1;
		this.lastStampModSty = -1;
		this.lastStampModState = -1;
		this.lastStampModVisible = -1;
		this.lastStampModSelected = -1;
		this.lastStampModActzo = -1;
		this.lastStampModTit = -1;
		this.pColorList = [];
		this.resetServerModified();
		if (this.hasColumnFormater()) this.columnFormater.optimChvl = -1;
	},
	resetServerModified: function() {
		this.srvValueModified = false;
	},
	// Pour une colonne on associe un 'format' commun pour toutes cellules - Ce format est le format d'une cellule d'une ligne dÃ©iÃ© Ã  la gestion des formats
	// formatRefCell - Cellule de reference pour toutes celles de la colonne
	setColumnFormater: function(formatRefCell) {
		if (formatRefCell == null) return;
		if (this.format == null || this.format.format === formatRefCell.format.format) {
			//this.setLastStampMod(_getTick(), 'FMT');
		}
		this.columnFormater = formatRefCell;
		// on appelle pas "forceServerFormat" pour ne pas incrementer le compteur de modification.
		this.format = this.columnFormater.format;
		this.formatStr = this.columnFormater.formatStr;
		//this.updateFormatTick();
		//console.log("\tsetColumnFormater" + this.getAdxId() +  " colFmt:" + this.columnFormater.getAdxId() +  " - Ref:" + formatRefCell.format.format + " - me:" + this.format.format)
	},
	setLastStampMod: function(lastStampMod, metadata) {
		switch (metadata) {
			case 'ACT':
				this.lastStampModActzo = lastStampMod;
				this.lastStampModState = lastStampMod;
				break;
			case 'PCOL':
				this.lastStampModPCol = lastStampMod;
				this.lastStampModVisible = lastStampMod;
				this.lastStampModState = lastStampMod;
				break;
			case 'VIS':
				this.lastStampModVisible = lastStampMod;
				this.lastStampModState = lastStampMod;
				break;
			case 'SEL':
				this.lastStampModSelected = lastStampMod;
				this.lastStampModState = lastStampMod;
				break;
			case 'STY':
				this.lastStampModSty = lastStampMod;
				break;
			case 'FMT':
				this.lastStampModFmt = lastStampMod;
				break;
			case 'TIT':
				this.lastStampModTit = lastStampMod;
				break;
		}
		if (lastStampMod !== -1) {
			this.forceChange();
		}
	},
	// State utilise aussi  pour selectionner une ligne
	setLeftListLineSelected: function(selected, force) {
		//this.stateSet(selected ? STATE_SELECT : STATE_NOT_SELECT, true);
		this.setSelected(selected);
	},
	setServerFormat: function(aFormat, fmt) {
		this.formatModified = true;
		var sendColumnFormat = this.formatStr == null || this.formatStr === "";
		this.storeFormat(aFormat);
		var isVisible = this.format != null && this.format.isVisible();
		this.formatStr = fmt;
		this.updateFormatTick();
		// console.log("\tisVisible:" + isVisible);
		this.setVisible(isVisible);

		if (this.hasColumnFormater()) {

			//GLUTE format -  disable optim change value
			this.columnFormater.storeFormat(aFormat);

			this.columnFormater.formatStr = fmt;
			if (sendColumnFormat) {
				this.columnFormater.updateFormatTick();
			}
			this.columnFormater.setVisible(isVisible);
			// si l'etat du formater n'a pas encore ete modifie => on le force
			if (!this.columnFormater.stateModified) {
				if (this.columnFormater.optimChvl === -1) { // GLUTE format management
					this.setOptimChvl();
				}
				this.columnFormater.stateModified = true;
			}
		}
	},
	setServerResu: function(aStructResu) {
		this.serverValue = aStructResu;
	},
	// Style pour les variables - Noeud NDCSTL
	setServerStyle: function(aStyle, applyOn) {
		// console.log("setServerStyle->" + this.getAdxId() + " - style=" + aStyle + " - applyOn=" + applyOn);
		if (applyOn != null && applyOn === 'TITLE') {
			// Style applies on title
			this.titleStyle = aStyle;
			this.isTitleModified = true;
		} else {
			// Style applies on entity
			this.setLastStampMod(_getTick(), 'STY');
			this.style = aStyle;
			this.styleModified = true;
		}
	},
	setServerTitle: function(aTitle) {
		// console.log("setServerStyle->" + this.getAdxId() + " - new:" + aTitle + " - old:" + this.title);
		if (aTitle != null && aTitle !== this.title) {
			this.title = aTitle;
			this.isTitleModified = true;
			this.setLastStampMod(_getTick(), 'TIT');
		}
		this.setJsonType('ENTITY');
	},
	isOptimChvl: function() {
		return true;
	},
	setOptimChvl: function() {
		// nothin
	},
	setServerValue: function(aResu) {
		if (this.hasColumnFormater() && this.isOptimChvl() ||  (!this.hasServerValueModification() && !this.isServerValueEquals(aResu))) {

			this.forceServerValueModification(true);
		}
		this.setServerResu(aResu);
		/*if (!this.formatModified && this.columnFormater != null && this.columnFormater !== this.format) {
			this.forceServerFormat(this.columnFormater.format);
		}*/
		this.forceChange();
	},

	// State  pour les variables - Attribut MAF
	setStateFromDescr: function(state) {
		this.state = _calcJsonNewEntityState(this.state, state);
	},
	// Style pour les variables - Attribut STX
	setStyleFromDescr: function(aStyle) {
		if (this.style == null || this.style !== aStyle) {
			this.setLastStampMod(_getTick(), 'STY');
		}
		this.style = aStyle;
	},
	setUnModifiableServerValue: function(aStructResu) {
		var wNewValue = (!aStructResu.equals(this.serverValue));
		if (wNewValue) {
			this.setServerValue(aStructResu);
		}
		return wNewValue;
	},
	toString: function() {
		return this.entityTyp + " " + this.entityIdxAlpha;
	}

	//toJSON: function();
});

// Variables - Mode d'affichage - Reprise Web126
CvgEntity.x3AffModeToEntityState = function(mode) {
	switch (mode) {
		case X3VAR_MAF_SAISI:
			return STATE_VISIBLE + STATE_ENABLE;
		case X3VAR_MAF_AFFICHE:
			return STATE_VISIBLE + CvgEntity.x3State2EntityState(X3_SRV_GRIZO);
			//case X3VAR_MAF_INVISIBLE:
			//case X3VAR_MAF_TECHNIQUE:
		default:
			return STATE_NOT_VISIBLE;
	}
};

// Teste avec CMichel
CvgEntity.x3State2EntityState = function(aX3State) {
	switch (aX3State) {
		case X3_SRV_GRIZO:
			return STATE_NOT_ENABLE;
		case X3_SRV_DISZO:
			return STATE_READONLY + STATE_ENABLE;
		case X3_SRV_ACTZO:
			return STATE_ENABLE + STATE_NOT_READONLY;
		default:
			throw new Error("Unknown X3 server state[" + aX3State + "]");
	}
};

CvgEntity.x3StateToString = function(aServerState) {
	switch (aServerState) {
		case X3_SRV_GRIZO:
			return "SRV_GRIZO";
		case X3_SRV_ACTZO:
			return "SRV_ACTZO";
		case X3_SRV_DISZO:
			return "SRV_DISZO";
		default:
			{
				return "Unknown serverState [" + aServerState + ']';
			}
	}
};