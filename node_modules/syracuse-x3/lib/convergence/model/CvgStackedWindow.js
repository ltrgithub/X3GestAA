"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CvgEntity = require('syracuse-x3/lib/convergence/model/CvgEntity').CvgEntity;
var CvgLeftList = require('syracuse-x3/lib/convergence/model/CvgLeftList').CvgLeftList;
var CvgListOfLocalMenus = require('syracuse-x3/lib/convergence/model/CvgListOfLocalMenusFactory').CvgListOfLocalMenus;
var CvgListOfLocalMenusFactory = require('syracuse-x3/lib/convergence/model/CvgListOfLocalMenusFactory').CvgListOfLocalMenusFactory;
var CvgListOfScreens = require('syracuse-x3/lib/convergence/model/CvgListOfScreens').CvgListOfScreens;
var CvgListOfDataSrcs = require('syracuse-x3/lib/convergence/model/CvgListOfDataSrcs').CvgListOfDataSrcs;
var CvgListOfDataSrcsFactory = require('syracuse-x3/lib/convergence/model/CvgListOfDataSrcsFactory').CvgListOfDataSrcsFactory;
var CvgListOfLeftLists = require('syracuse-x3/lib/convergence/model/CvgListOfLeftLists').CvgListOfLeftLists;
var CvgWindow = require('syracuse-x3/lib/convergence/model/CvgWindow').CvgWindow;
var CvgScreen = require('syracuse-x3/lib/convergence/model/CvgScreen').CvgScreen;
var CvgStackedWindow = require('syracuse-x3/lib/convergence/model/CvgStackedWindow').CvgStackedWindow;
var CvgListOfLeftListsFactory = require('syracuse-x3/lib/convergence/model/CvgListOfLeftListsFactory').CvgListOfLeftListsFactory;
var Cvg = require('syracuse-x3/lib/convergence/model/Cvg').Cvg;
var CvgStatusBar = require('syracuse-x3/lib/convergence/model/CvgStatusBar').CvgStatusBar;
CvgListOfLeftListsFactory

function instanciate(windowDescription) {
	var windowNode = windowDescription;
	var windowType = parseInt(windowNode.$.TYF, 10); // type de fenetre adonix : girl=1, own=2 (modal), comment=3 (fenetre sans bouton), dialogue=4
	var windowModel = parseInt(windowNode.$.WTY, 10);
	var nbLignes = parseInt(windowNode.$.NLI, 10); // nombre de ligne du premier ecran
	var nbColonnes = parseInt(windowNode.$.NCO, 10); // nombre de colonne du premier ecran
	return new CvgWindow(windowModel, windowType, nbLignes, nbColonnes);
}

var CvgStackedWindow = exports.CvgStackedWindow = helpers.defineClass(function(aClient, aWindowId, aFunctionId, aDescr, aStamp, aEnityIndexBaseOne) {
	CvgEntity.call(this, aClient, aWindowId, aEnityIndexBaseOne, 'WINDOW');
	this.statusBar = null;
	this.opened = false;
	this.window = null;

	this.menuList = null;
	this.ndOWinComplementDescr = null;
	// Identifiant Serveur de la DataSource "Liste Gauche" standard
	this.primaryLeftListId = null;
	this.screenToShow = -1;
	this.timeStamp = "";
	this.stackLevel = -1;

	// nom de la fonction ayant ouvert la fen�tre
	this.functionId = aFunctionId;
	this.setStamp(aStamp);
	this.localIndex = aEnityIndexBaseOne - 1;
	// Table des menus locaux associees au requester
	this.localMenus = new CvgListOfLocalMenus();
	this.screens = new CvgListOfScreens(this);
	this.listOfDataSrcs = new CvgListOfDataSrcs(this);
	this.listOfLeftLists = new CvgListOfLeftLists(this);
	this.descrDom = aDescr;
	if (aWindowId !== "&ROOT") {
		//this.loadDesrDom(aWindowId, false);
	}
	if (this.hasDescrDom()) {
		var timestamp = this.descrDom.$.TIM;
		if (timestamp == null || timestamp !== aStamp) {
			//reload description
			this.loadDesrDom(aWindowId, true);
			aStamp = this.descrDom.$.TIM;
		}
		this.window = instanciate(this.descrDom);
		CvgListOfLocalMenusFactory.instanciateLocalMenus(this, this.descrDom, this.localMenus);
		CvgStackedWindow.newScreens(this.client, this, this.descrDom, this.screens, this.listOfDataSrcs);
		CvgListOfLeftListsFactory.instanciateLeftLists(this, this.screens, this.descrDom, this.listOfLeftLists);
	}
}, CvgEntity, {
	addStatusIconDef: function(instance, aNumText, aTxt, aImgId, aActionId) {
		if (this.statusBar == null) {
			this.statusBar = new CvgStatusBar();
		}
		this.statusBar.addIconDef(aNumText, aTxt, aImgId, aActionId);
	},
	finLocalMenu: function(aLocalMenuId) {
		return this.localMenus[aLocalMenuId];
	},
	getObservableId: function() {
		return this.opened ? "Open-" + this.getAdxId() : "Close-" + this.getAdxId();
	},
	getAdxId: function() {
		return this.entityIdxAlpha;
	},
	hasDescrDom: function() {
		return this.descrDom != null;
	},
	isOpened: function() {
		return this.opened;
	},
	listenException: function(e) {
		return false;
	},
	listenSegment: function(aSegment) {
		return false;
	},
	loadDesrDom: function(aWindowId, forced) {
		/* TODO BRJOU
		var connectionLang = this.client.adonixContext.language;
		var folder = this.client.adonixContext.x3Folder;
		var subPathFile = folder + "/GEN/" + connectionLang + "/FENS/" + aWindowId;
		this.descrDom = ServiceAdapi.resourceManager.getFullPathDom(subPathFile, ".xml", this.client.httpX3ServerUrl, forced, this.client.adonixContext.x3ServerCnxHostname);
*/
	},
	razModification: function() {
		CvgEntity.prototype.razModification.call(this);
	},
	setMenuList: function(menuList) {
		this.menuList = menuList;
	},
	setNDOWinComplementDescr: function(aComplementDescr) {
		this.ndOWinComplementDescr = aComplementDescr;
		if (this.window != null && aComplementDescr.indexOf(';') > -1) {
			var wST = aComplementDescr.split(';');
			if (wST.length >= 3) {
				// wST[0]; // titre
				this.window.setNbLignes(wST[1]); // ligne
				this.window.setNbColonnes(wST[2]); // colonne
			}
		}
	},
	setOpened: function(opened) {
		this.opened = opened;
		// En dernier
		this.setJsonType('FUNC'); // catch close ou open fonction
	},
	setScreenToShow: function(aScreenToShow) {
		this.screenToShow = aScreenToShow;
	},
	setStackLevel: function(stackLevel) {
		this.stackLevel = stackLevel;

	},
	setStamp: function(aStamp) {
		try {
			this.timeStamp = Cvg.timeStampFormats(aStamp, this.client.formater.dateOrder);
		} catch (e) {
			console.error(e);
			this.timeStamp = "";
		}
	},
	toJSON: function() {
		// dump only for open of close function, the dump of entity is done by payloadWin objects
		var winO = {};
		if (this.isOpened()) {
			winO.name = this.id;
			winO.scrnNum = this.screenToShow >= 1 ? this.screenToShow : 1;
			winO.stamp = this.timeStamp;
			winO.extend = this.ndOWinComplementDescr;
			winO.func = this.functionId;
			winO.type = this.window.type;
			// check if the left list have change fmt and/or title to add appendModel
			var extModel = null;
			for (var it in this.listOfLeftLists) {
				var item = this.listOfLeftLists[it];
				if (item instanceof CvgLeftList) {
					var list = item;
					if (list.hasColumnTitleModified() || list.isColomnFormatChange()) {
						extModel = list;
					}
				}
			}
			if (extModel != null) {
				// Extension à apporter au modèle de données (càd au protototype généré). Utilisé notamment sur l'ouverture des fenêtres de type Choose,
				//  où la description des colonnes de la liste de sélection est fournie dynamiquement par le back-office.
				//  Le contenu de cet objet est donc variable; il doit simplement respecter la structure et la codification du modèle de données.
				// L'exemple ci-dessous illustre ce qui est attendu dans le cas de l'extention du modèle pour une fenêtre de type Choose.
				/**
				 * "bA": { "$item": { "$": { "bA1" : { "tit": "Devis",
				 * "fmt": "K:30X" }, "bA2" : { "tit": "Client", "fmt":
				 * "K:10X" } } }
				 */
				// create appendModel Node
				var appendModel = {};
				for (var it in extModel.entrySup.vars) {
					var item = extModel.entrySup.vars[it];
					var itemJs = {};
					if (item.title != null) itemJs.tit = item.title;
					itemJs.fmt = item.format != null ? item.format.format : "";
					appendModel[item.getJsonKey()] = itemJs;
				}
				var dolaritem = {};
				dolaritem.$properties = appendModel;
				var leftListApp = {};
				leftListApp.$item = dolaritem;
				var leftListId = {};
				leftListId[extModel.getJsonKey()] = leftListApp;
				winO.appendModel = leftListId;
			}
			winO.mnu = this.menuList == null ? [] : this.menuList.toJSON();
		}
		return winO;
	},
	traverseAll: function(aTraverser) {
		return this.screens.traverseAll(aTraverser);
	},
	traverseChilds: function(aTraverser) {
		return this.screens.traverseChilds(aTraverser);
	},
	traverseSettable: function(aStructIst, aSetter) {
		return this.screens.traverseSettable(aStructIst, aSetter);
	},
});

CvgStackedWindow.newScreens = function(client, requesterWindow, windowDescription, screens, listOfDataSrcs) {
	var screensNodes = windowDescription.DATASOURCES.SCRN;
	var max = Array.isArray(screensNodes) ? screensNodes.length : 1;
	var screenNode;
	var screen;
	// String wValue;
	var i = 0;
	while (i < max) {
		screenNode = max === 1 ? screensNodes : screensNodes[i];
		var id = screenNode.$.NAM;
		screen = new CvgScreen(requesterWindow, i + 1, id);
		screens.pushEntity(id, screen);
		CvgListOfDataSrcsFactory.newScreenDataSrcs(requesterWindow, screenNode, screen, listOfDataSrcs);
		i++;
	}
}