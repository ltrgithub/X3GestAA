"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CvgObservable = require('syracuse-x3/lib/convergence/model/CvgObservable').CvgObservable;

var _log = true;
var CvgDiagnose = exports.CvgDiagnose = helpers.defineClass(function(client, severity, appCode, message, details, error, origin, recovery, track, jsonT) {
	CvgObservable.call(this, client);
	this.severity = severity;
	var errMsg = error ? error.message || error : null;
	this.message = message ? message : errMsg;
	this.error = error;
	this.origin = origin;
	this.details = details && details.length > 0 ? details : errMsg && this.message != errMsg ? errMsg : null;
	// #1231 - Force abort if client no more alive
	var alive = client != null && client.isAlive();
	this.appCode = alive ? appCode : 500;
	this.recovery = recovery ? recovery : 'KILL';
	// En dernier
	if (track) {
		this.setJsonType(jsonT ? jsonT : 'DIAGNOSE');
	}
}, CvgObservable, {
	toJSON: function() {
		var diag = {
			"$message": this.message,
			"$severity": this.severity || 'ERROR',
			"appCode": this.appCode || 500,
			"$origin": "NodeJS: Convergence Server" + (this.origin ? (": " + this.origin) : ""),
			"$stackTrace": this.error ? this.error.stack : null,
			"$diagnoses": this.$diagnoses || null
		};
		if (this.details) {
			diag.$details = this.details;
		}
		if (this.recovery) {
			diag.$recoveryCode = this.recovery;
		}
		diag.$links = [{
			'$title': "Sage ERP X3 support web site",
			'$url': "http://www.sage.com/support"
		}];
		return diag;
	},
	// Filter same diagnoses - send only one (ex: bad format in lists)
	sendToClient: function(trackList) {
		if (trackList == null) {
			return true;
		}
		var i, d;
		for (i = 0; i < trackList.length; i++) {
			d = trackList[i];
			if (d.message == this.message && d.details == this.details && d.origin == this.origin) {
				if (d.error == null && this.error == null || (d.error != null && this.error != null && d.error.message != null && this.error.message != null)) {
					return false;
				}
			}
		}
		if (_log) {
			console.log("CvgDiagnose -> " + this.message + (this.error ? "\n\t" + this.error.message : "") + (this.details ? "\n\t" + this.details : ""));
		}
		return true;
	}

});