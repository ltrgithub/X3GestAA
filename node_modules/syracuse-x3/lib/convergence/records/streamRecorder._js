"use strict";
var helpers = require('syracuse-core/lib/helpers');
var util = require('util');
var ufs =require('fs');


var _recorder= function(_, stream, file, config) {
	var self = this;
	self._file = file;	
	self._config = config;	
	if (stream){
		var read = stream.read;
		stream.read = function(_, len) {
			var data = read.call(stream, _, len);
			if (data) self.dumpBytes(_, "READ", data);
			return data;
		};
		var write = stream.write;
		stream.write = function(_, data) {
			if (data) self.dumpBytes(_, "WRITE", data);
			write.call(stream, _, data);
		}
	}
}

exports.streamRecorder = helpers.defineClass(_recorder, null, {
	dumpBytes: function(_, action, data) {
		var line = action + "([0x" + data.toString('hex').match(/.{1,2}/g).join(', 0x') + "]);\n";
		ufs.appendFile(this._file, line, 'utf8', _);
	},
	dumpJSON: function(_, action, obj) {
		var line = action + "(" + JSON.stringify(obj) + ");\n";
		ufs.appendFile(this._file, line, 'utf8', _);
	},
	_log:function(txt){
		if (this._config.trace) this._config.trace(txt);
	},
	logerr:function(e, txt) {
		this._log(txt);	
		this._log(e.stack ? e.stack : e.message ? e.message : e);
	}
});
