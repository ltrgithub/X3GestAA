"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CAdonixReply = function() {};

var LIB_METHOD_GET_TARGET_FORMAT = "getTargetFormat";
/**
 * Structure publique de reponse a une requete fournie a l'application cliente.
 * */
var CAdapiReply = helpers.defineClass(function(aAdapiClient, aOrderId, aSTAT, aReplyMessages) {
	aSTAT = aSTAT !== undefined ? aSTAT : OK;
	TODO_SUPER(aAdapiClient.tracer, aOrderId, aSTAT, aReplyMessages);
	this.adapiClient = aAdapiClient;
	this.adapiInstances = null;
	this.targetEntity = null;
}, CAdonixReply, {
	addAdapiInstance: function(aAdapiInstance) {
		initAdapiInstances();
		this.adapiInstances.add(aAdapiInstance);
		if (aAdapiInstance.hasException()) {
			this.setTargetAdxId(aAdapiInstance.ist, aAdapiInstance.adapiEntity);
		}
		return aAdapiInstance;
	},
	addLogicalErrorMess: function(aObject, aMethod, aIst, aMessage) {
		if (this.adapiClient.isWithLogicalErrDetails()) {
			var wMessage = this.messages.getFirstMessageOfTtyp(CReplyMessage.WEBSERVER);
			if (wMessage == null) {
				var wMess = this.adapiClient.adapiResources.getMessage(CAdapiResources.KEYMESS_ERROR_LOGICAL);

				wMessage = new CAdapiMessage(CReplyMessage.WEBSERVER, this.adapiClient, wMess, false);

				this.messages.addMessage(wMessage);
			}
			wMessage.addWebServerLocicalMess(buildLogicalErrorMess(aObject, aMethod, aIst, aMessage));
		}
	},
	addMessage: function(aAdapiMessage) {
		this.messages.addMessage(aAdapiMessage);
		return aAdapiMessage;
	},
	/* TODO overload
	addMessage: function(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx) {
		return this.addMessage(new CAdapiMessage(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx, this.adapiClient));
	},
	*/
	addTargetInstance: function() {
		var wFormatString = null;
		var wFormatedValue = null;
		var wServerValue = null;
		var wAdapiInstance;
		try {
			if (getTarthis.entity instanceof CAdapiVariable) {
				var wAdapiVariable = this.targetVariable;
				if (wAdapiVariable.acceptEditFormat()) {
					wFormatString = validTargetFormat(getTarthis.entity.format);
					wFormatedValue = wAdapiVariable.formatX3ToEdit();
					wServerValue = wAdapiVariable.serverValStr;
				}
			}
			wAdapiInstance = CAdapiInstance.newtarget(this.adapiClient, getTarthis.ist, wFormatString, wFormatedValue, this.stayInCommandMode);
			if (getTarthis.entity instanceof CAdapiVariableDate) {
				wAdapiInstance.setRoughValue((getTarthis.entity).serverValStr);
			}
		} catch (e) {
			var wAdapiMessage = new CAdapiMessage(CReplyMessage.WEBSERVER, this.adapiClient, e.message, false);
			this.addMessage(wAdapiMessage);
			wAdapiInstance = CAdapiInstance.newtarget(this.adapiClient, getTarthis.ist, wFormatString, wServerValue, this.stayInCommandMode);
		}
		addAdapiInstance(wAdapiInstance);
		return wAdapiInstance;
	},
	findTargetEntity: function() {
		var wTargetEntity = null;
		if (hasTarthis.ist) {
			wTargetEntity = this.findTargetEntity(getTarthis.ist);
		}
		if (wTargetEntity == null) {
			var wMess = this.adapiClient.adapiResources.getMessage(CAdapiResources.KEYMESS_ERROR_CURFORMAT_NOIST);
			wMess = CStringFacilities.sprintf(wMess, getTarthis.ist == null ? "NULL" : getTarthis.ist.toStringDescr());
			this.adapiClient.addLogicalErrorMess(this, LIB_METHOD_GET_TARGET_FORMAT, getTarthis.ist == null ? "NULL" : getTarthis.ist.alphanumCodage, wMess);
		}
		return wTargetEntity;
	},
	/* TODO overload
	findTargetEntity: function(aStructIst) {

		var wModifiable = this.adapiClient.findModifiable(aStructIst);

		if (wModifiable != null && wModifiable instanceof CAdapiEntity) {
			return wModifiable;
		} else {
			return null;
		}
	},*/
	getTargetEntity: function() {
		if (this.targetEntity == null) {
			setTargetEntity(this.findTarthis.entity);
		}
		return this.targetEntity;
	},
	getTargetVariable: function() {
		return getTarthis.entity;
	},
	hasTargetEntityField: function() {
		var wAdapiEntity = getTarthis.entity;
		return wAdapiEntity != null && wAdapiEntity instanceof CAdapiVariable;
	},
	initAdapiInstances: function() {
		if (this.adapiInstances == null) {
			this.adapiInstances = new CAdapiInstances();
		}
	},
	insertFirstMessage: function(aAdapiMessage) {
		this.messages.insertFirstMessage(aAdapiMessage);
		return aAdapiMessage;
	},/* TODO overload
	insertFirstMessage: function(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx) {
		return this.insertFirstMessage(new CAdapiMessage(aType, aAction, aMessage, aTitre, aDefBtn, aSleep, aChx, this.adapiClient));
	},*/
	setOk: function(aSTAT) {
		TODO_SUPER.setStatus(aSTAT);
	},
	setStatusNOTOK: function(aCommExceptionWhy, wMess) {
		TODO_SUPER.setStatusNOTOK();
		setCommExceptionWhy(aCommExceptionWhy);
		this.insertFirstMessage(CAdonix.MSG_ERROR, 0, wMess, "", 0, 0, 0);
	},/* TODO overload
	setStatusNOTOK: function(e) {
		if (this.isOk() && e instanceof CAdapiException && e.isFormatException()) {
			TODO_SUPER.setStatusOK();
		} else if (e != null) {
			TODO_SUPER.setStatusNOTOK(e);
		} else {
			TODO_SUPER.setStatusNOTOK();
		}
	},*/
	setStatusOK: function(aInfoMessage) {
		this.setStatusOK();
		this.addMessage(CAdonix.MSG_INFORMATION, 0, aInfoMessage, "", 0, 0, 0);
	},
	setTargetAdxId: function(aTargetIst) {
		this.setTargetAdxId(aTargetIst, this.findTargetEntity(aTargetIst));
		if (hasTarthis.entityField) {
			addTarthis.instance;
		}
	},/* TODO overload
	setTargetAdxId: function(aTargetIst, aAdapiEntity) {
		TODO_SUPER.setTargetAdxId(aTargetIst);
		setTargetEntity(aAdapiEntity);
	},
	setTargetAdxId: function(aTargetIst, request) {
		this.setTargetAdxId(aTargetIst, this.findTargetEntity(aTargetIst));
		var instance = addTarthis.instance;
		if (aTargetIst.isLeftListIst() && request.lefListLineSelected != -1) {
			instance.setNl(request.lefListLineSelected + 1);
		}
		this.adapiClient.setCurrentField(instance);
	},*/
	setTargetEntity: function(aTargetEntity) {
		this.targetEntity = aTargetEntity;
	},
	traverseAdapiInstances: function(aTraverser) {
		if (this.adapiInstances != null) {
			this.adapiInstances.traverseChilds(aTraverser);
		}
	},
	validTargetFormat: function(aFormat) {
		if (aFormat == null || !aFormat.isValid()) {
			var wMess = this.adapiClient.adapiResources.getMessage(CAdapiResources.KEYMESS_ERROR_CURFORMAT_NOFORMAT);
			wMess = CStringFacilities.sprintf(wMess, getTarthis.ist.toStringDescr());
			this.adapiClient.addLogicalErrorMess(this, LIB_METHOD_GET_TARGET_FORMAT, getTarthis.ist.alphanumCodage, wMess);
			return wMess;
		} else {
			return aFormat.string;
		}
	}
});

CAdapiReply.buildLogicalErrorMess = function(aObject, aMethod, aIst, aMessage) {
	var wSB = new StringBuilder();
	wSB.append(CStringFacilities.getClasseName(aObject.class));
	wSB.append('^');
	wSB.append(aMethod);
	wSB.append('^');
	wSB.append(aIst);
	wSB.append('^');
	wSB.append(aMessage);
	return wSB.toString();
}