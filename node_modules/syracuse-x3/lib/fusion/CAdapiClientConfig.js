"use strict";
var helpers = require('syracuse-core/lib/helpers');
var CAdonixConfig = null; //require('syracuse-x3/lib/fusion/CAdonixConfig').CAdonixConfig;

/**
 * Collection de param�tres de configuration d'un client Adapi.
 * <p>
 * Cette collection est constitu� avant l'ouverture. Certain des param�tres
 * contenus sont mis � jour pendant la dur�e de vie du client.
 * </p>
 * <p>
 * Evolution majeur en 140: la classe "CAdapiConfig" devient une d�riv�e de la
 * classe "CAdonixConfig".
 *
 * @author Adonix Grenoble
 * @version 140_003
 */
var CONNECTNUM_KEY = "connection.number";
var DATE_FORMAT_SERVER_KEY = "date.format.server";
var FORMATER_KIND_JAVA = "JAVA";
var FORMATER_VON_KEY = "formater.von";
var PARAM_xCONNECTNUM = "xCONNECTNUM";
var SERV_PORT_KEY = "adapi.server.port";
var URL_SERVER_BASE_KEY = "url.server.base";
var URL_SERVER_BOB_KEY = "url.server.blob";
var URL_SERVER_REQUEST_KEY = "url.server.request";
var USERHOMEVIRTUALPATH = "webserver.virtualpath.userhome";
var VIRTUALPATHPAGES = "webserver.virtualpath.pages";
var X3SERVER_LEVEL_KEY = "x3server.level";
var X3SERVER_VERSION_KEY = "adonix.version";
var SYRA_PREFS_THOUSANDSEP = "thousandsSep";
var SYRA_PREFS_DECIMALSEP = "decimalSep";
var SYRA_PREFS_DATEORDER = "dateOrder";
var SYRA_PREFS_DATESEP = "dateSep";
var SYRA_PREFS_TIMESEP = "timeSep";
var UI_1_STIME = "STime";

var CAdapiClientConfig = exports.CAdapiClientConfig = helpers.defineClass(function() {
	CAdonixConfig.call(this, aParams);
	this.serverDebugActive = false;
	this.serverLongWorkActive = false;
	this.syraPreferences = null;
	initDefaultConfig();
}, CAdonixConfig, {
	buildaAdxCtxParams: function() {
		var wSB = new StringBuilder(250);
		CStringFacilities.addInStringParams(wSB, extractSubKey(ADONIX_HOST_KEY), getStrParam(ADONIX_HOST_KEY));
		CStringFacilities.addInStringParams(wSB, extractSubKey(ADONIX_PORT_KEY), getStrParam(ADONIX_PORT_KEY));
		wSB.append(TODO_SUPER.buildaAdxCtxParams());
		return wSB.toString();
	},
	fusionIsSameCtx: function(syraPrefs) {
		var syraCfg = new CAdapiClientConfig(new CConfigBase());
		syraCfg.fusionSetFormaterPrefs(syraPrefs);

		if (!get(UI_1_STHOUSAND).equals(syraCfg.get(UI_1_STHOUSAND))) {
			return false;
		}
		if (!get(UI_1_SEPDECIMAL).equals(syraCfg.get(UI_1_SEPDECIMAL))) {
			return false;
		}
		if (!get(UI_1_SEPDATE).equals(syraCfg.get(UI_1_SEPDATE))) {
			return false;
		}
		if (!get(UI_IDATE).equals(syraCfg.get(UI_IDATE))) {
			return false;
		}
		return true;
	},
	fusionPrefAdd: function(syraPrefs, syraId, cfgId, def) {
		var s = syraPrefs.optString(syraId);
		if (s.isEmpty()) {
			s = def;
			syraPrefs.put(syraId, s);
		}
		if (SYRA_PREFS_DATEORDER.equals(syraId)) {
			// 0	Month-Day-Year - 1	Day-Month-Year - 2	Year-Month-Day
			s.toLowerCase();
			if (s.charAt(0) == 'd') {
				s = "1";
			} else if (s.charAt(0) == 'm') {
				s = "0";
			} else if (s.charAt(0) == 'y') {
				s = "2";
			} else {
				s = "0";
			}
		}
		setParam(cfgId, s);
	},
	fusionSetFormaterPrefs: function(syraPrefs) {
		this.syraPreferences = syraPrefs == null ? {} : syraPrefs;
		fusionPrefAdd(syraPrefs, SYRA_PREFS_DATEORDER, UI_IDATE, "mdy");
		fusionPrefAdd(syraPrefs, SYRA_PREFS_DATESEP, UI_1_SEPDATE, "/");
		fusionPrefAdd(syraPrefs, SYRA_PREFS_DECIMALSEP, UI_1_SEPDECIMAL, ".");
		fusionPrefAdd(syraPrefs, SYRA_PREFS_THOUSANDSEP, UI_1_STHOUSAND, " ");
		fusionPrefAdd(syraPrefs, SYRA_PREFS_TIMESEP, UI_1_STIME, ":");
		setParam(FORMATER_VON_KEY, ON);
	},
	getFormaterVon: function() {
		return getBoolParam(FORMATER_VON_KEY);
	},
	getRequestServerUrl: function() {
		return getParam(URL_SERVER_REQUEST_KEY);
	},
	getServerDateFormat: function() {
		var wFormat = getStrParam(DATE_FORMAT_SERVER_KEY);

		return wFormat != null ? wFormat : CAdapiEntity.EMPTY;
	},
	getUrlServerBase: function() {
		var wUrl = getParam(URL_SERVER_BASE_KEY);
		if (wUrl == null) {
			wUrl = this.getRequestServerUrl();
			if (wUrl != null) {
				var wPos = wUrl.lastIndexOf('/');
				if (wPos > -1) {
					wUrl = wUrl.substring(0, wPos);
				}
			} else {
				wUrl = "";
			}
			this.setParam(URL_SERVER_BASE_KEY, wUrl);
		}
		return wUrl;
	},
	/* TODO: fix overload
	getUrlServerBase: function(aSvcId) {
		var wSB = new StringBuilder();

		wSB.append(this.getUrlServerBase());
		wSB.append('/');
		wSB.append(aSvcId);
		wSB.append('?');
		wSB.append(PARAM_xCONNECTNUM);
		wSB.append('=');
		wSB.append(getParam(CONNECTNUM_KEY));

		return wSB.toString();
	},
	*/
	getUrlServerBlob: function() {
		var wUrl = getParam(URL_SERVER_BOB_KEY);
		if (wUrl == null) {
			wUrl = this.getUrlServerBase(CAdapiVariableBlob.SVC_BLOB_ID);
			this.setParam(URL_SERVER_BOB_KEY, wUrl == null ? "" : wUrl);
			if (wUrl == null) {
				wUrl = "";
			}
			this.setParam(URL_SERVER_BOB_KEY, wUrl);
		}
		return wUrl;
	},
	initDefaultConfig: function() {
		TODO_SUPER.initDefaultConfig();
		if (!isParamExists(SESSION_WEIGHT_KEY)) {
			this.setParam(SESSION_WEIGHT_KEY, CAdonixClient.SESSION_NATIVE_PRIMARY);
		}
		setX3ServerLevel("140_xxx");
	},
	isFormaterJavaEnabled: function() {
		return FORMATER_KIND_JAVA.equalsIgnoreCase(getParam(this.formaterKind));
	},
	isParamBoolean: function(aParamKey) {
		return aParamKey.equals(DEBUG_ON) ||  aParamKey.equals(ADONIX_VIA_INTERNET_ON);
	},
	isParamExists: function(aParamKey) {
		return containsKey(aParamKey);
	},
	isParamInteger: function(aParamKey) {
		return aParamKey.equals(SERV_PORT_KEY) || aParamKey.equals(ADONIX_PORT_KEY) ||  aParamKey.equals(SESSION_WEIGHT_KEY) || aParamKey.equals(DATE_FORMAT_KEY) || aParamKey.equals(DATE_PIVOT_KEY) || aParamKey.equals(SESSION_WEIGHT_KEY);
	},
	isParamLong: function(aParamKey) {
		return aParamKey.equals(TIMEOUT_REPLY_KEY) || aParamKey.equals(TIMEOUT_SEQUENCE_KEY);
	},
	isParamString: function(aParamKey) {
		return !isParamBoolean(aParamKey) && !isParamInteger(aParamKey) && !isParamLong(aParamKey);
	},
	isServerDebugActive: function() {
		return this.serverDebugActive;
	},
	isServerLongWorkActive: function() {
		return this.serverLongWorkActive;
	},
	setParam: function(aParamKey, aValue) {
		if (testParamInteger(aParamKey)) {
			return TODO_SUPER.setParam(aParamKey, aValue);
		} else {
			return null;
		}
	},
	setServerDateFormat: function(aFormat) {
		return this.setParam(DATE_FORMAT_SERVER_KEY, aFormat);
	},
	setX3ServerLevel: function(aLevel) {
		this.setParam(X3SERVER_LEVEL_KEY, aLevel);
	},
	testParamBoolean: function(aParamKey) {
		var wTest = isParamBoolean(aParamKey);
		return wTest;
	},
	testParamInteger: function(aParamKey) {
		var wTest = isParamInteger(aParamKey);
		return wTest;
	},
	testParamLong: function(aParamKey) {
		var wTest = isParamLong(aParamKey);
		return wTest;
	},
	toString: function() {
		return toStringDescr();
	},
	toStringDescr: function() {
		var wSB = new StringBuilder(256);
		wSB.append(TODO_SUPER.toStringDescr());
		CStringFacilities.addInStringDescr(wSB, "ConfigHashCode", hashCode());
		return wSB.toString();
	}
});