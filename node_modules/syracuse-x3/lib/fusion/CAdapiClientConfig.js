"use strict";
var helpers = require('syracuse-core/lib/helpers');

/**
 * Collection de param�tres de configuration d'un client Adapi.
 * <p>
 * Cette collection est constitu� avant l'ouverture. Certain des param�tres
 * contenus sont mis � jour pendant la dur�e de vie du client.
 * </p>
 * <p>
 * Evolution majeur en 140: la classe "CAdapiConfig" devient une d�riv�e de la
 * classe "CAdonixConfig".
 *
 * @author Adonix Grenoble
 * @version 140_003
 */
var CONNECTNUM_KEY = "connection.number";
var DATE_FORMAT_SERVER_KEY = "date.format.server";
var SESSION_WEIGHT_KEY = "session.weight";
var FORMATER_VON_KEY = "formater.von";
var PARAM_xCONNECTNUM = "xCONNECTNUM";
var SERV_PORT_KEY = "adapi.server.port";
var URL_SERVER_BASE_KEY = "url.server.base";
var URL_SERVER_BOB_KEY = "url.server.blob";
var URL_SERVER_REQUEST_KEY = "url.server.request";
var USERHOMEVIRTUALPATH = "webserver.virtualpath.userhome";
var VIRTUALPATHPAGES = "webserver.virtualpath.pages";
var X3SERVER_LEVEL_KEY = "x3server.level";
var X3SERVER_VERSION_KEY = "adonix.version";
var SYRA_PREFS_THOUSANDSEP = "thousandsSep";
var SYRA_PREFS_DECIMALSEP = "decimalSep";
var SYRA_PREFS_DATEORDER = "dateOrder";
var SYRA_PREFS_DATESEP = "dateSep";
var SYRA_PREFS_TIMESEP = "timeSep";
var UI_1_STIME = "STime";

var CAdapiClientConfig = exports.CAdapiClientConfig = helpers.defineClass(function(params) {
	this.params = params || {};
	this.serverDebugActive = false;
	this.serverLongWorkActive = false;
	this.syraPreferences = params && params.syraPreferences || {};
	this.fusionSetFormaterPrefs();
	//this.initDefaultConfig();
}, null, {

	// TODO Sessions reuse
	fusionIsSameCtx: function(syraPrefs) {
		var syraCfg = new CAdapiClientConfig(new CConfigBase());
		syraCfg.fusionSetFormaterPrefs(syraPrefs);

		if (!get(UI_1_STHOUSAND).equals(syraCfg.get(UI_1_STHOUSAND))) {
			return false;
		}
		if (!get(UI_1_SEPDECIMAL).equals(syraCfg.get(UI_1_SEPDECIMAL))) {
			return false;
		}
		if (!get(UI_1_SEPDATE).equals(syraCfg.get(UI_1_SEPDATE))) {
			return false;
		}
		if (!get(UI_IDATE).equals(syraCfg.get(UI_IDATE))) {
			return false;
		}
		return true;
	},
	fusionPrefAdd: function(syraId, cfgId, def) {
		var s = this.syraPreferences[syraId];
		if (!s) {
			s = def;
			this.syraPreferences[syraId] = s;
		}
		if ("dateOrder" === syraId) {
			// 0	Month-Day-Year - 1	Day-Month-Year - 2	Year-Month-Day
			s.toLowerCase();
			if (s.charAt(0) === 'd') {
				s = "1";
			} else if (s.charAt(0) === 'm') {
				s = "0";
			} else if (s.charAt(0) === 'y') {
				s = "2";
			} else {
				s = "0";
			}
		}
		this.params[cfgId] = s.toString();
	},
	fusionSetFormaterPrefs: function() {
		this.fusionPrefAdd("dateOrder", "IDate", "mdy");
		this.fusionPrefAdd("dateSep", "SDate", "/");
		this.fusionPrefAdd("decimalSep", "SDecimal", ".");
		this.fusionPrefAdd("thousandsSep", "SThousand", " ");
		this.fusionPrefAdd("timeSep", "STime", ":");
		this.params[FORMATER_VON_KEY] = "false";
	},
	getFormaterVon: function() {
		return params[FORMATER_VON_KEY];
	},
	getRequestServerUrl: function() {
		return params[URL_SERVER_REQUEST_KEY];
	},
	getServerDateFormat: function() {
		var wFormat = params[DATE_FORMAT_SERVER_KEY];

		return wFormat != null ? wFormat : "";
	},


	getUrlServerBase: function(aSvcId) {

		function _getUrlServerBase() {
			var wUrl = getParam(URL_SERVER_BASE_KEY);
			if (wUrl == null) {
				wUrl = self.getRequestServerUrl();
				if (wUrl != null) {
					var wPos = wUrl.lastIndexOf('/');
					if (wPos > -1) {
						wUrl = wUrl.substring(0, wPos);
					}
				} else {
					wUrl = "";
				}
				this.params[URL_SERVER_BASE_KEY] = wUrl;
			}
			return wUrl;
		}

		var self = this;
		var wSB = "";

		wSB += _getUrlServerBase();
		wSB += '/';
		wSB += aSvcId;
		wSB += '?';
		wSB += PARAM_xCONNECTNUM;
		wSB += '=';
		wSB += getParam(CONNECTNUM_KEY);

		return wSB.toString();
	},

	getUrlServerBlob: function() {
		var wUrl = getParam(URL_SERVER_BOB_KEY);
		if (wUrl == null) {
			wUrl = this.getUrlServerBase(CAdapiVariableBlob.SVC_BLOB_ID);
			this.params[URL_SERVER_BOB_KEY] = wUrl == null ? "" : wUrl;
			if (wUrl == null) {
				wUrl = "";
			}
			this.params[URL_SERVER_BOB_KEY] = wUrl;
		}
		return wUrl;
	},
	initDefaultConfig: function() {
		TODO_SUPER.initDefaultConfig();
		if (!this.params[SESSION_WEIGHT_KEY]) {
			this.params[SESSION_WEIGHT_KEY] = "11"; // SESSION NATIVE PRIMARY
		}
		setX3ServerLevel("140_xxx");
	},
	setServerDateFormat: function(aFormat) {
		return this.params[DATE_FORMAT_SERVER_KEY] = aFormat.toString();
	},
	setX3ServerLevel: function(aLevel) {
		this.params[X3SERVER_LEVEL_KEY] = aLevel.toString();
	},
	toString: function() {
		var wSB = "";
		wSB += CAdonixConfig.prototype.toStringDescr.call(this);
		CStringFacilities.addInStringDescr(wSB, "ConfigHashCode", hashCode());
		return wSB;
	},
});