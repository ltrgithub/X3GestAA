"use strict";
var helpers = require('syracuse-core/lib/helpers');

var ATT_DIM = "DIM";
var ATT_NAM = "NAM";
var ATT_NBP = "NBP";
var ATT_NBZ = "NBZ";
var TAG_DS = "DS";
var TAG_FLD = "FLD";

var CAdapiListOfDataSrcsFactory = {

	newEmptyDataSrc: function(aStackedWindow, aAdapiScreen, aEntityIndexBaseOne, aId, aDataSourceNode) {

		var wDim = CDomFacilities.getAttributValueInt(aDataSourceNode, ATT_DIM);
		var wNbField = CDomFacilities.getAttributValueInt(aDataSourceNode, ATT_NBZ);
		var wBasPagName = CDomFacilities.getAttributValue(aDataSourceNode, ATT_NBP);
		var dataSrc = new CAdapiDataSrc(aStackedWindow, aAdapiScreen, aEntityIndexBaseOne, aId, wDim, wNbField, wBasPagName);
		var srcLine = newEmptyDataSrcLine(aStackedWindow, dataSrc, aId, aDataSourceNode);
		if (dataSrc.isBlocTableau()) {
			var wLineEntrySup = srcLine.clone();
			dataSrc.setEntrySup(wLineEntrySup);
			/*
			 * GLUTE: gestion des formats dans les colonnes des tableaux
			 *
			 * pour associer chacune des variables de la ligne a sa
			 * correspondante dans la ligne "wLineEntrySup" Note: sert ala
			 * propagation du format courant ï¿½ chaque modification de valeur
			 */
			srcLine.setFormaterEntity(wLineEntrySup);
		}

		dataSrc.appendFirstBlankLine(srcLine);
		return dataSrc;
	},
	newEmptyDataSrcLine: function(aStackedWindow, aAdapiDataSrc, aId, aDataSourceNode) {
		var wNbField = CDomFacilities.getAttributValueInt(aDataSourceNode, ATT_NBZ);
		var wAdapiDataSrcLine = new CAdapiDataSrcLine(aStackedWindow, aAdapiDataSrc, aId, wNbField);
		var wListOfX3Variables = aDataSourceNode.getElementsByTagName(TAG_FLD);
		var wMax = wListOfX3Variables.getLength();
		var wVariable;
		var wVariableNode;
		var wI = 0;
		while (wI < wMax) {
			wVariableNode = wListOfX3Variables.item(wI);
			wVariable = CAdapiVariableFactory.instanciateVariable(aStackedWindow, wAdapiDataSrcLine, wI + 1, aId, wVariableNode, 0);
			wAdapiDataSrcLine.addOneVar(wVariable);
			wI++;
		}
		return wAdapiDataSrcLine;
	},
	newScreenDataSrcs: function(aStackedWindow, aScreenNode, aAdapiScreen, aAdapiDataSrcs) {
		var wDataSourcesNodes = aScreenNode.getElementsByTagName(TAG_DS);
		var wMax = wDataSourcesNodes.getLength();
		var wDataSourceNode;
		var wAdapiDataSrc;
		var wDataSourceID;
		var wI = 0;
		while (wI < wMax) {
			wDataSourceNode = wDataSourcesNodes.item(wI);
			wDataSourceID = CDomFacilities.getAttributValue(wDataSourceNode, ATT_NAM);
			wAdapiDataSrc = newEmptyDataSrc(aStackedWindow, aAdapiScreen, wI + 1, wDataSourceID, wDataSourceNode);
			aAdapiScreen.pushDataSrc(wDataSourceID, wAdapiDataSrc);
			aAdapiDataSrcs.push(wDataSourceID, wAdapiDataSrc);
			wI++;
		}
	}
};