"use strict";
var helpers = require('syracuse-core/lib/helpers');
var AdapiObservable = function() {};

var EAdapiInstanceKind = {
	TARGET: 0,
	PREVIOUS: 1
};

var CAdapiInstance = helpers.defineClass(function(cli, aKind, aIst, format, aValue, modCmd) {
	TODO_SUPER(cli);
	this.nl = -1;
	this.exception = null;
	if (cli == null) {
		throw new RuntimeException("Unexpected null FusionClient");
	}
	this.ist = aIst;
	this.kind = aKind;
	this.roughValue = null;
	this.modCommande = modCmd;
	this.formatString = format == null || format.isEmpty() ? null : format;
	this.pvalue = aValue;
	var adapi = cli.findModifiable(aIst);
	if (adapi != null && adapi instanceof CAdapiEntity) {
		this.adapiEntity = adapi;
	}
	if (this.adapiEntity == null) {
		throw new RuntimeException("Entity " + aIst.toStringDescr() + " not found\nPlease check/update X3 Window description");
	}
	// !! En dernier car update du client et this.adapiEntity doit être valorisee
	if (aKind == EAdapiInstanceKind.PREVIOUS) {
		setTypeJsonNode('PREVIOUS');

	} else {
		setTypeJsonNode('TARGET');
	}
}, AdapiObservable, {
	getAdapiEntity: function() {
		return this.adapiEntity;
	},
	getFormat: function() {
		return this.formatString;
	}

	// TODO - Voir si utilisé
	,
	getInstanceKind: function() {
		return this.kind;
	},
	getIst: function() {
		return this.ist;
	},
	getModeEdit: function() {
		return !this.modCommande;
	},
	getNl: function() {
		if (this.nl != -1) {
			return this.nl;
		} else {
			var v = this.adapiEntity instanceof CAdapiVariable ? this.adapiEntity : null;
			if (v != null && !v.isDisposed()) {
				var line = v.getSrcLine();
				if (line != null && line.getDataSrc().isBlocGrid()) {
					return line.getOneBaseLineIdx();
				}
			}
		}
		return -1;
	}

	// TODO - Voir si utilisé
	,
	getRoughtValue: function() {
		return this.roughValue;
	},
	getValue: function() {
		return this.pvalue;
	},
	getWin: function() {
		return getIst().getWinAlphaId();
	},
	getXid: function() {
		var fullId = getIst().getScreenAlphaIdFusion();
		if (!this.adapiEntity.isDisposed() && !(this.adapiEntity instanceof CAdapiScreenDummy)) {
			fullId += getIst().getBlocAlphaId();
			if (this.adapiEntity.getEntityTyp() == EntityType.FIELD) {
				fullId += getIst().getField();
			}
		}
		return fullId;
	},
	hasException: function() {
		return this.exception != null;
	},
	hasFormat: function() {
		return this.formatString != null;
	},
	setException: function(e) {
		this.exception = e;
	},
	setNl: function(nl) {
		this.nl = nl;
	},
	setRoughValue: function(aValue) {
		this.roughValue = aValue;
	},
	toJson: function() {
		var object = new JSONObject();
		if (getIst().getWin() == 1) {
			// target portal
			object.put('type', 'portal');
		} else {
			object.put('type', 'ist');
			var ist = new JSONObject();
			ist.put('xid', getXid());
			if (getNl() != -1) {
				ist.put('nl', getNl());

			}
			if (this.formatString != null) {
				ist.put('fmt', this.formatString);
			}
			ist.put('win', getWin());
			ist.put('edit', getModeEdit());
			// Valeur pour champ en mode edit - TODO Vérifier si ok
			if (getModeEdit() && this.pvalue != null) {
				ist.put('v', this.pvalue);
				ist.put('raw', this.getRoughtValue());
			}
			object.put('ist', ist);
			ist.put('ctrlFailed', hasException());
			if (hasException()) {
				var diags = new CDiagnoses();
				var diag = new CDiagnosis();
				diag.setMessage(this.exception.getMessage());
				diags.addDiagnosis(diag);
				ist.put('$diagnoses', diags.toJSONArray());
			}
		}
		return object;
	}
});
CAdapiInstance.newprevious = function(aClient, aIst, aFormatString, aValue, modCommande) {
	return new CAdapiInstance(aClient, EAdapiInstanceKind.PREVIOUS, aIst, aFormatString, aValue, modCommande);
}

CAdapiInstance.newtarget = function(aClient, aIst, aFormatString, aValue, modCommande) {
	return new CAdapiInstance(aClient, EAdapiInstanceKind.TARGET, aIst, aFormatString, aValue, modCommande);
}