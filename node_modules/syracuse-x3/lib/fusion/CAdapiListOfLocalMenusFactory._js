"use strict";
var helpers = require('syracuse-core/lib/helpers');
var Hashtable = function() {};

var serialVersionUID = "3997312439574961005";
var CAdapiListOfLocalMenus = helpers.defineClass(function() {
	TODO_SUPER();
}, Hashtable, {
	addLocalMenu: function(aAdapiLocalMenu) {
		this.put(aAdapiLocalMenu.getNumId(), aAdapiLocalMenu);
	}
});

var MESS = "unknown choice=[%s] : menu [%s] has [%s] items";
var CAdapiLocalMenu = helpers.defineClass(function(aNumId, aId, aChoices) {
	this.numId = aNumId;
	this.id = aId;
	this.choices = aChoices;
}, null, {
	getLib: function(aChoice) {
		if (aChoice < 1 || aChoice > this.choices.length) {
			var wMess = CStringFacilities.sprintf(MESS, String.valueOf(aChoice), this.id, String.valueOf(this.choices.length));
			throw new Exception(wMess);
		}
		return this.choices[aChoice - 1]; // base 0 !
	},
	getNumId: function() {
		return this.numId;
	}
});

var ATT_NAM = "NAM";
var ATT_NBZ = "NBZ";
var TAG_MENL = "MENL";
var TAG_V = "V";

function extractIntLocalMenuId(aLocalMenuId) {
	aLocalMenuId = aLocalMenuId.substring(1); //pour enlever "M"
	return Integer.parseInt(aLocalMenuId);
}

function instanciateLocalMenu(aAdapiClient, aId, aLocalMenuID, aNbChoices, aLocalMenuNode) {
	var wLocalMenu;
	try {
		var wChoicesNodes = aLocalMenuNode.getElementsByTagName(TAG_V);
		var wChoiceNode;
		var wMax = wChoicesNodes.getLength();
		var wChoices = new String[wMax];
		var wI = 0;
		while (wI < wMax) {
			wChoiceNode = wChoicesNodes.item(wI);
			wChoices[wI] = CDomFacilities.getFirstTextValue(wChoiceNode);
			wI++;
		}
		wLocalMenu = new CAdapiLocalMenu(aId, aLocalMenuID, wChoices);
	} catch (e) {
		throw new CAdapiException(aAdapiClient, e, "CANT_ADD_LOCALMENU - instanciateLocalMenu");
	}
	return wLocalMenu;
}

var CAdapiListOfLocalMenusFactory = {

	instanciateLocalMenus: function(aAdapiRequesterWindow, aWindowDescription, aLocalMenus) {
		var wLocalMenusNodes = aWindowDescription.getElementsByTagName(TAG_MENL);
		var wMax = wLocalMenusNodes.getLength();
		var wI = 0;
		var wLocalMenuId;
		var wLocalMenuNode;
		var wNbChoices;
		while (wI < wMax) {
			wLocalMenuNode = wLocalMenusNodes.item(wI);
			wLocalMenuId = CDomFacilities.getAttributValue(wLocalMenuNode, ATT_NAM);
			wNbChoices = CDomFacilities.getAttributValueInt(wLocalMenuNode, ATT_NBZ);
			var wNumId = extractIntLocalMenuId(wLocalMenuId);
			if (aLocalMenus.get(wNumId) != null) {
				throw new CAdapiException(aAdapiRequesterWindow.getAdapiClient(), "CANT_ADD_LOCALMENU - AlreadyExist");
			}
			aLocalMenus.addLocalMenu(instanciateLocalMenu(aAdapiRequesterWindow.getAdapiClient(), wNumId, wLocalMenuId, wNbChoices, wLocalMenuNode));
			wI++;
		}
	}
}