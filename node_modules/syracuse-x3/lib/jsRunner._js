"use strict";

var streams = require("streamline/lib/streams/streams"),
	helpers = require('syracuse-core/lib/helpers'),
	jsxml = require('jsxml'),
	util = require('util');

var tracer = helpers.fusionProxyTracer != null ? helpers.fusionProxyTracer : false;

var Runner = helpers.defineClass(function() {

}, null, {
	execute: function(_, modul, body){

		 
		 
		function processArgs(){
			if (body.args != null){
				if (body.encodings != null && body.args.length !== body.encodings.length)
					throw new Error("Body elements 'args' and 'encodings' must have same length.");
				// Decode base64 if body.encodings is set to 1
				body.args.forEach(function(elt, idx){
					if (body.encodings != null && body.encodings[idx] === 1){
						args[idx] = new Buffer(elt, 'base64').toString('utf-8');
					}else{
						args[idx] = elt;
					}
				});
			}
		}
		
		function genErrorHead(status, message, exception){
			var result = '';
			var head = {
					  "statusCode": status.toString(),
					  "message": message,
					 // "exception": exception
					}
			return {
				header: head,
				body: result
			}
		}
		
		var head, result;
		var args = [];
		

		try{
			processArgs();
		}catch(e){
			return genErrorHead(500, e.message, e.stack);
		}
		
		try{
			if (body.mode == "sync" ){
				result = require(modul)[body.function].apply(null, args);
			}else if (body.mode == "wait"){
				if (body.callbackIndex == null){
					body.callbackIndex = -1;
				}
				result = require(modul)[body.function].apply_(_, null, args, body.callbackIndex);
			}else{
				return genErrorHead(500, "Invalid mode: Allowed modes are 'sync' or 'wait'.", 'no stack');
			}
		}catch(e){
			if (e.message == "Cannot call method 'apply_' of undefined"){
				return genErrorHead(404, "The method '" + body.function + "' doesn't exists.", e.stack);
			}else if ( e.message == "Cannot find module '" + modul + "'"){
				return genErrorHead(404, e.message, e.stack);
			}else{
				return genErrorHead(500, e.message, e.stack);
			}
		}
		
		if (body.return != null){
			try{
				result = eval('result.'+body.return);
			}catch(e){
				return genErrorHead(500, "Property " + body.return + " doesn't exists.", e.stack);
			}
			
		}
	
		try{
			result = JSON.stringify(result,null,0);
			head = {
					  "statusCode": "200",
					  "message": "OK",
					  "content-type": "application/json",
					  "content-length": result.length.toString()
					}
		}catch(e){
			return genErrorHead(500, "JSON.stringify error:"+e.message, e.stack);
		}

		return {
			header: head,
			body: result
		}
	},
	
	
	httpRequest: function(_, header, body){
		var request = streams.httpRequest(header);
		if (header.method == 'POST' || header.method == 'PUT'){
			request.write(_,body);
		}

		var resp = request.end().response(_);
		resp.setEncoding("utf8");
		var content = resp.readAll(_);
		
		resp.headers.statusCode = resp.statusCode
		return {
			header: resp.headers,
			body: content
		}
		
	}
});



exports.execute = function(_, modul, body){
	var runner = new Runner();
	return runner.execute(_, modul, body);
}

exports.httpRequest = function(_, header, body){
	var runner = new Runner();
	return runner.httpRequest(_, header, body);
}