"use strict";

var helpers = require('syracuse-core/lib/helpers');
var httpClient = require("syracuse-httpclient/lib/httpClient");
var boRestCli = exports.boRestCli = helpers.defineClass(function() {
	this.bosec = "secEnterprise";
	this.bouser = "administrator";
	this.bopwd = "Azerty1234!";
	this.boserv = "http://soexalid01:6405";
	this.token = null;
	this.fail = null;
	this.variable = null; // variable associate to bo
}, null, {
	/*
	 * return null if login has failed else the token value
	 */
	logon: function(_) {
		console.log("boClient logon");
		if (!this.token) {
			var header = {
				"Content-Type": "application/json",
				"Accept": "application/json"
			};
			var body = {
				"userName": this.bouser,
				"password": this.bopwd,
				"auth": this.bosec
			};
			var opt = {
				method: "POST",
				url: this.boserv + "/biprws/logon/long",
				headers: header
			};
			try {
				var request = httpClient.httpRequest(_, opt);
				request.write(_, JSON.stringify(body));
				var response = request.end().response(_);
				if (response.statusCode === 200) {
					this.token = response.headers["x-sap-logontoken"];
				} else {
					this.fail = response.statusCode + ": (url:" + opt.url + ") body " + response.readAll(_);
					this.token = null;
				}
			} catch (e) {
				throw new Error("can't logon on bo server " + e.stack);
			}
		}
		return this.token;
	},
	/*
	 * return true if logoff is successful else false
	 */
	logoff: function(_) {
		console.log("boClient logoff");
		var header = {
			"Accept": "application/json",
			"x-sap-logontoken": this.token
		};
		var opt = {
			method: "POST",
			url: this.boserv + "/biprws/logoff",
			headers: header
		};

		try {
			var request = httpClient.httpRequest(_, opt);
			var response = request.end().response(_);
			if (response.statusCode === 200) {
				this.token = null;
				this.variable = null;
				return true;
			} else {
				return false;
			}
		} catch (e) {
			throw new Error("can't logoff on bo server " + e.stack);
		}
	}

});