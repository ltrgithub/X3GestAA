"use strict";

var helpers = require('syracuse-core/lib/helpers');
var httpClient = require("syracuse-httpclient/lib/httpClient");
var httpProxy = require("http-proxy/lib/node-http-proxy");
var streams = require("streamline/lib/streams/streams");
var http = require("http");


var MapProxys = {};


exports.proxy = function(_, context, boServerPath, config) {
	var baseUrl = context.endpoint.getBoServerBaseUrl(_, false);
	var request = context.request;
	var params = Object.keys(context.parameters).map(function(key) {
		return key + "=" + encodeURIComponent(context.parameters[key]);
	}).join("&");
	var options = {
		url: baseUrl + boServerPath + (params ? ("?" + params) : ""),
		method: context.method,
		headers: request.headers
	};
	console.log(JSON.stringify(options));
	var clientReq = streams.httpRequest(options);
	var buf;
	while (buf = request.read(_)) clientReq.write(_, buf, "binary");
	var response = clientReq.end().response(_);
	response.setEncoding("binary");
	//
	context.response.writeHead(response.statusCode, response.headers);
	while (buf = response.read(_)) context.response.write(_, buf, "binary");
	context.response.end();


};


var boRestCli = exports.boRestCli = helpers.defineClass(function(_, endpoint) {
	this.bosec = "secEnterprise"; // default
	this.bouser = "Administrator"; // have to get this by user
	this.bopwd = "Azerty1234!"; // have to get this  by user 
	this.boserv = endpoint.getBoServer(_);
	console.log("bo serv " + this.boserv);
	this.boport = endpoint.getBoServerRestPort(_);
	this.solution = endpoint.x3SolutionName(_);



	this.token = null;
	this.fail = null;
	this.variable = null; // variable associate to bo
}, null, {
	/*
	 * return null if login has failed else the token value
	 */
	logon: function(_) {
		if (!this.token) {
			var header = {
				"Content-Type": "application/json",
				"Accept": "application/json"
			};
			var body = {
				"userName": this.bouser,
				"password": this.bopwd,
				"auth": this.bosec
			};
			var opt = {
				method: "POST",
				url: "http://" + this.boserv + ":" + this.boport + "/biprws/logon/long",
				headers: header
			};
			try {
				var request = httpClient.httpRequest(_, opt);
				request.write(_, JSON.stringify(body));
				var response = request.end().response(_);
				if (response.statusCode === 200) {
					this.token = response.headers["x-sap-logontoken"];
				} else {
					this.fail = response.statusCode + ": (url:" + opt.url + ") body " + response.readAll(_);
					this.token = null;
				}
			} catch (e) {
				throw new Error("can't logon on bo server " + e.stack);
			}
		}
		return this.token;
	},
	/*
	 * return true if logoff is successful else false
	 */
	logoff: function(_) {
		console.log("boClient logoff");
		var header = {
			"Accept": "application/json",
			"x-sap-logontoken": this.token
		};
		var opt = {
			method: "POST",
			url: "http://" + this.boserv + ":" + this.boport + "/biprws/logoff",
			headers: header
		};

		try {
			var request = httpClient.httpRequest(_, opt);
			var response = request.end().response(_);
			if (response.statusCode === 200) {
				this.token = null;
				this.variable = null;
				return true;
			} else {
				this.token = null;
				this.variable = null;
				return false;
			}
		} catch (e) {
			throw new Error("can't logoff on bo server " + e.stack);
		}
	}

});