"use strict";

var crypto = require('crypto');
var util = require('util');
var fs = require('fs');
var fsp = require("path");
var dateUtil = require('syracuse-core/lib/types/datetime');
var nodeconfig = require('syracuse-main/lib/nodeconfig');


exports.getSignature = function(_, challenge, userName) {
	var toSign = new Buffer(userName + "\0" + challenge, "utf8");
	var signer = crypto.createSign(nodeconfig.config.sdata.signAlgorithm);
	signer.update(toSign);
	return signer.sign(fs.readFile(fsp.join(__dirname, "../key.pem"), "ascii", _), "base64");
}
	
exports.dateFormatToX3Format = function(dateFormat) {
	if(!dateFormat) return "";
	var result = "D:";
	//
	dateUtil.walkFormat(dateFormat, {
		literal: function(literal) { result += "[" + literal + "]"; },
		d: function(repeat) {
			result += "DD";
		},
		M: function(repeat) {
			switch(repeat) {
				case 1:
				case 2:
					result += "MM";
					break;
				case 3:
					result += "MMM";
					break;
				case 4:
					result += "MMMMMMMMMM";
					break;
			}
		},
		y: function(repeat) {
			switch(repeat) {
				case 2:
					result += "YY";
					break;
				case 4:
					result += "YYYY";
					break;
			}
		},
		h: function(repeat) {
			result += "hh";
		},
		H: function(repeat) {
			result += "hh";
		},
		m: function(repeat) {
			result += "mm";
		},
		s: function(repeat) {
			result += "ss";
		},
		t: function(repeat) {
			
		}
	});
	//
	return result;
}

exports.dateFormatToX3Prefs = function(dateFormat) {
	var dateSep=null;
	var dateOrder=[];
	if(dateFormat){
		dateUtil.walkFormat(dateFormat, {
			// We assume that first literal is the date separator
			literal: function(literal) { if (dateSep==null) dateSep = literal; },
			d: function(repeat) {
				if (dateOrder.indexOf('d')==-1) dateOrder.push('d');
			},
			M: function(repeat) {
				if (dateOrder.indexOf('m')==-1) dateOrder.push('m');
			},
			y: function(repeat) {
				if (dateOrder.indexOf('y')==-1) dateOrder.push('y');
			}
		});
	}
	// X3 client don't need date format - only dateOrder and dateSep
	return {
			dateSep:dateSep,
			dateOrder: dateOrder.join('')
		};
}
