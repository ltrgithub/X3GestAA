"use strict";

var helpers = require('syracuse-core/lib/helpers');
var httpClient = require("syracuse-httpclient/lib/httpClient");
var proxy = require('syracuse-main/lib/proxy');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var locale = require("syracuse-core/lib/locale");
var globals = require('streamline/lib/globals');

var tracer = require("syracuse-trace/lib/helper").getTracer("businessObjects");
var proxies = {};

exports.forward = function(_, context, path) {
	var sid = proxy.getCookie(context.request.headers.cookie, "syracuse.sid." + context.request.connection.localPort);
	if (!sid) throw new Error("No Syracuse session context found !");
	var p = proxies[sid];
	if (!p) {
		var baseUrl = getBoBaseUrl(_, context);
		p = proxies[sid] = new proxy.Proxy(_, baseUrl, {
			trace: tracer
		});
	}
	var addRespHeaders = {
		"x-frame-options": "SAMEORIGIN"
	};
	return p.forward(_, context, path, addRespHeaders);
};

exports.BoRestClient = helpers.defineClass(function(_, profile, server, context) {
	this.context = context;
	this.profile = profile;
	this.boServer = server;

	this.token = null;
	this.fail = null;
	this.variable = null; // variable associate to bo
	this.lastLogonWithAdmin = null;

	this.syracuseSession = this.context.request.session.id;
}, null, {
	init: function(_) {
		// CvgClient case
		if (!this.boServer && !this.profile) {
			this.x3solution = this.x3solution || this.context.endpoint.x3solution(_);
			this.boServer = this.boServer || getBoServer(_, this.x3solution);
		}

		// Profile test case
		if (!this.boServer)
			this.boServer = this.profile.boServer(_);

		this.preferedSec = this.boServer.preferedSec(_) === true ? "secLdap" : "secEnterprise";
		this.bohost = this.bohost || this.boServer.host(_);
		this.boport = this.boport || this.boServer.portRest(_);

		var baseUrl = this.boServer.getBoServerBaseUrl(_, false);
		this.proxy = new proxy.Proxy(_, baseUrl, {
			trace: tracer
		});
		proxies[this.syracuseSession] = this.proxy;
	},
	/*
	 * return null if login has failed else the token value
	 */
	logon: function(_, withAdmin) {
		this.init(_);

		if (withAdmin && this.lastLogonWithAdmin === false) {
			if (this.token)
				this.logoff(_);
			this.lastLogonWithAdmin = true;
		} else if (!withAdmin && this.lastLogonWithAdmin === true) {
			if (this.token)
				this.logoff(_);
			this.lastLogonWithAdmin = false;
		}

		var forceSecEnterprise = false;
		// if BO server prefers LDAP but user is authenticated with something else
		if (!withAdmin && this.preferedSec === "secLdap" && globals.context.session.getData("authType") !== "ldap") {
			forceSecEnterprise = true;
		}

		if (withAdmin) {
			this.bosec = "secEnterprise";
			this.bouser = "administrator";
			var passwd = this.boServer.adminPassword(_);
			if (passwd == null) {
				return "";
			}
			this.bopwd = passwd;
		} else if (!forceSecEnterprise && this.preferedSec === "secLdap") {
			this.bosec = this.preferedSec;
			this.bouser = globals.context.session.authData.user;
			var b64 = globals.context.session.authData.authorization.split(' ')[1];
			this.bopwd = new Buffer(b64, 'base64').toString('utf8').split(':')[1];
		} else {
			this.profile = getBoProfile(_, this.x3solution, this.context);
			this.bosec = this.profile.security(_);
			this.bouser = this.profile.user(_);
			this.bopwd = this.profile.password(_);
		}

		if (!this.token) {
			var header = {
				"Content-Type": "application/json",
				"Accept": "application/json"
			};
			var body = {
				"userName": this.bouser,
				"password": this.bopwd || "",
				"auth": this.bosec
			};
			//console.log("Auth payload: "+JSON.stringify(body,null,2));
			var opt = {
				method: "POST",
				url: "http://" + this.bohost + ":" + this.boport + "/biprws/logon/long",
				headers: header
			};

			var request = httpClient.httpRequest(_, opt);
			var response = request.end(JSON.stringify(body)).response(_);
			var res = response.readAll(_); // really important !!!
			//console.log("Auth res: "+JSON.stringify(res,null,2));
			if (response.statusCode === 200) {
				this.token = response.headers["x-sap-logontoken"].replace("\"", "").replace("\"", "");
			} else {
				this.fail = response.statusCode + ": (url:" + opt.url + ") body " + res;
				this.token = null;
			}
		}
		if (!this.token) {
			tracer.error && tracer.error("BO logon failed on " + this.bohost + ":" + this.boport);
			throw new Error("Logon failed " + (this.fail ? "(" + this.fail + ")" : ""));
		}
		return this.token;
	},
	/*
	 * return true if logoff is successful else false
	 */
	logoff: function(_) {
		this.init(_);
		var header = {
			"Accept": "application/json",
			"x-sap-logontoken": this.token
		};
		var opt = {
			method: "POST",
			url: "http://" + this.bohost + ":" + this.boport + "/biprws/logoff",
			headers: header
		};

		try {
			var res;
			if (this.token) {
				var request = httpClient.httpRequest(_, opt);
				var response = request.end().response(_);
				response.readAll(_); // Really important !!!
				if (response.statusCode === 200) {
					this.token = null;
					this.variable = null;
					res = true;
				} else {
					this.token = null;
					this.variable = null;
					res = false;
				}
			}
			if (proxies[this.syracuseSession])
				delete proxies[this.syracuseSession];
			return res;
		} catch (e) {
			throw new Error("Can't logoff on bo server.\n" + e.safeStack);
		}
	}

});

var getBoBaseUrl = function(_, context) {
	var x3solution = context.endpoint.x3solution(_);
	var boServer = getBoServer(_, x3solution);
	return boServer.getBoServerBaseUrl(_, false);
};

var getBoServer = function(_, x3solution) {
	var boserver = x3solution.boServer(_);
	if (!boserver) throw new Error(locale.format(module, "noBoServer", x3solution.solutionName(_)));
	return boserver;
};

var getBoProfile = function(_, x3solution, context) {

	var profile;

	var boserver = getBoServer(_, x3solution);

	var roleUuid = context.getSelectedRoleId(_);
	if (!roleUuid) throw new Error(locale.format(module, "noRole"));

	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.getEntity(_, "role");
	var role = db.fetchInstance(_, entity, {
		sdataWhere: "$uuid eq '" + roleUuid + "'"
	});

	var profiles = role.boProfiles(_).toArray(_);
	for (var i in profiles) {
		var inst = profiles[i];
		if (inst.boServer(_).$uuid === boserver.$uuid) {
			profile = inst.profile(_);
		}
	}
	if (!profile) throw new Error(locale.format(module, "noBoProfile", role.description(_), x3solution.solutionName(_)));
	return profile;
};
