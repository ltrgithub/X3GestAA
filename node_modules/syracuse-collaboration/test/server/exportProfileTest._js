var module = QUnit.module;
var fs = require('fs');
var fsp = require("path");
var sys = require("util");
var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;

var types = require('syracuse-core/lib/types/allTypes');
var config = require('syracuse-main/lib/nodeconfig').config; // must be first
																// syracuse																// require
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require("mongodb");
var streams = require('streamline/lib/streams/streams');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var jsonExport = require("syracuse-import/lib/jsonExport");
var jsonImport = require("syracuse-import/lib/jsonImport");
var locale = require("syracuse-core/lib/locale");

//
var tracer = console.log;
// var tracer = null;
//
// force basic auth
config.session = config.session || {};
config.session.auth = "basic";
helpers.pageFileStorage = false;

var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var endPoint = adminTestFixtures.modifyCollaborationEndpoint("mongodb_admin_test");

var baseUrl = "http://localhost:3004"
var contractUrl = "/sdata/syracuse/collaboration/mongodb_admin_test/";
var port = 3004;
var acceptLanguage = "fr,fr-fr";

var profileId;

var cookie = "";

function onlyInfo(diags) {
	return diags.every(function(diag) {
		return diag.severity == "info";
	});
}

function _getModel() {
	return dataModel.make(
			registry.applications.syracuse.contracts.collaboration,
			"mongodb_admin_test");
}

function getCookie(_, login, pass) {
	var response = new streams.httpRequest({
		url : baseUrl + "/syracuse-main/html/main.html",
		user : login || "guest",
		password : pass || "guest"
	}).end().response(_);
	response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	return response.headers["set-cookie"];
}


function post(_, cookie, url, data, statusCode, adminUrl) {
	// console.log( "begin post url "+ url);
	
	var response = streams.httpRequest(
			{
				method : "post",
				url : url.indexOf("http") == 0 ? url : baseUrl
						+ "/sdata/syracuse/collaboration/mongodb_admin_test/"
						+ url,
				headers : {
					"content-type" : "application/json",
					cookie : cookie
				}
			}).end(JSON.stringify(data)).response(_);
	var responsetext=response.readAll(_) ;
	strictEqual(response.statusCode, statusCode || 201, "status verified: ");
	
	return JSON.parse(responsetext);

}

function put(_, cookie, url, data, statusCode) {
	var response = streams.httpRequest(
			{
				method : "put",
				url : url.indexOf("http") == 0 ? url : baseUrl
						+ "/sdata/syracuse/collaboration/mongodb_admin_test/"
						+ url,
				headers : {
					"content-type" : "application/json",
					cookie : cookie
				}
			}).end(JSON.stringify(data)).response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

function get(_, cookie, url, statusCode, facet) {

	var type = facet || "generic.$details";
	var response = streams.httpRequest(
			{
				method : "get",
				url : url.indexOf("http") == 0 ? url : baseUrl
						+ "/sdata/syracuse/collaboration/mongodb_admin_test/"
						+ url,
				// url: url.indexOf("http") == 0 ? url : baseUrl +
				// "sdata/syracuse/collaboration/syracuse/" + url,
				// url:
				// "http://localhost:3004/sdata/syracuse/collaboration/mongodb_admin_test/exportProfiles",
				headers : {
					cookie : cookie,
					"Accept-Language" : acceptLanguage,
					accept : "application/json;vnd.sage=syracuse"
				}
			}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified ");
	var resp = response.readAll(_);

	// console.log("Response : "+JSON.stringify(JSON.parse(resp),null,2));
	return JSON.parse(resp);
}

function del(_, cookie, url, statusCode) {
	var response = streams.httpRequest(
			{
				method : "delete",
				url : baseUrl
						+ "/sdata/syracuse/collaboration/mongodb_admin_test/"
						+ url,
				headers : {
					cookie : cookie
				}
			}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	return JSON.parse(response.readAll(_));
}

var doStop = false;
module("exportProfileTest", {
	setup : function() {
	},
	teardown : function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100)
		}
	}
});

function _findUuid(coll, searchProp, searchVal) {
	var uuid = null;
	coll.forEach(function(item) {
		if (item[searchProp] == searchVal) {
			console.log("found: " + sys.inspect(item));
			uuid = item.$uuid;
		}
	});
	return uuid;
}

asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(
			endPoint.datasets["mongodb_admin_test"].hostname,
			endPoint.datasets["mongodb_admin_test"].port, {});
	var db = new mongodb.Db(config.collaboration.dataset, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	//
	ok(true, "mongodb initialized");

	start();
});

// start syracuse server
var syracuse;
// wait server initialization
asyncTest("initialize syracuse test server", 1, function(_) {
	syracuse = require('syracuse-main/lib/syracuse');
	syracuse.initializerStatus.on("initialized", function() {
		ok(true, "server initialized");
		syracuse.server.listen(null, port);
		start();
	});
});

var x3sId;
var applicationId;
var adminEp;

asyncTest("create administration endpoint: ", 7, function(_) {

	cookie = getCookie(_);
	console.log("create administration endpoint");
	var appli = adminHelper.getApplication(_, "syracuse", "collaboration");
	ok(appli != null, "Application fetch ok");
	applicationId = appli.$uuid;
	console.log("applicationId "+appli.$uuid) ;
	var body = post(_, cookie, "x3servers/$template/$workingCopies?trackingId="+ uuid.generate(), {});
	var data = {
		description : "X3 S1",
		serverHost : "localhost",
		serverPort : 1,
		serverTimeout : 1
	};
	//console.log("create x3server  after post "+JSON.stringify(body,null,2) );
	

	data.$key = body.$uuid;
	data.$etag = body.$etag;

	data.$actions = {
		$save : {
			$isRequested : true
		}
	};
	body = put(_, cookie, body.$url, data);
	//console.log("create x3server  after put "+JSON.stringify(body,null,2) );
	/*post(_, cookie, "x3servers", {
		description : "X3 S1",
		serverHost : "localhost",
		serverPort : 1,
		serverTimeout : 1
	});*/

	// create endpoints
	x3sId = body.$uuid;

	//console.log("create administration endpoint before post");
	var body = post(_, cookie, "endPoints/$template/$workingCopies?trackingId="
			+ uuid.generate(), {});
	//console.log("create administration endpoint after post");
	var data = {
		description : "Administration",
		dataset : "mongodb_admin_test",
		enableSearch : false,
		protocol : "syracuse",
		databaseDriver : "mongodb",
		databaseHost : "localhost",
		databasePort : 27017
	};

	data.$key = body.$uuid;
	data.$etag = body.$etag;
	data.applicationRef = {
		$uuid : applicationId
	};

	data.$actions = {
		$save : {
			$isRequested : true
		}
	};
	body = put(_, cookie, body.$url, data);


	adminEp = get(_, cookie, "endPoints('" + body.$uuid + "')");
	// console.log("ADMIN ENDPOINT: "+ JSON.stringify(adminEp,null,2)) ;
	start();
});

asyncTest("very simple entity: entityAttribute", 16,	function(_) {
	try {
		cookie = getCookie(_);

		var testAttributes = [ {
			name : "test1"
		}, {
			name : "test2"
		}, {
			name : "test3"
		} ];

		var exportItems = [ {
			className : "entityAttributes",
			title : "entityAttributes",
			entityKeyAttribute : [ {
				name : "name"
			} ],
			entityAttribute : [ {
				name : "name"
			}

			]
		} ];

		testAttributes.forEach_(_, function(_, prop) {
			var body = post(_, cookie, "entityAttributes/$template/$workingCopies?trackingId="	+ uuid.generate(), {});
			var data = helpers.object.clone(prop);
			prop.$uuid = body.$uuid;
			data.$key = prop.$uuid;
			data.$etag = body.$etag;
			data.$actions = {
				$save : {
					$isRequested : true
				}
			};
			body = put(_, cookie, body.$url, data);
		});

		var item = exportItems[0];
		//console.log("ITEM CLASS NAME: " + item.className);
		var coll = get(_, cookie, item.className, 200);
		// console.log( "GET EXPORTED OBJECTS: "+
		// JSON.stringify(coll,null,2)) ;
		if (coll.$resources.length)
			item.exportedObjects = [];
		coll.$resources.forEach_(_, function(_, el) {
			//console.log("EL : " + el.$uuid);
			item.exportedObjects.push({
				$uuid : el.$uuid
			});
		});

		var body = post(_, cookie, "exportProfileItems", item);
		// console.log("exportProfileItem: "+
		// JSON.stringify(item,null,2)) ;

		var expProfile = {
			description : "Very Simple Export Profile",
			code : "VSEP",
			applicationName : "syracuse",
			endpoint : adminEp,
			application : {
				description : "Syracuse Application",
				application : "syracuse"
			},
			exportProfileItem : exportItems,
		};

		var profile = post(_, cookie, "exportProfiles", expProfile);
		// console.log("EXPORT PROFILE : "+
		// JSON.stringify(expProfile,null,2)) ;
		profileId = profile.$uuid;

		var db = dataModel.getOrm(_, _getModel(), endPoint.datasets.mongodb_admin_test);
		var model = db.model;
		var entity = model.getEntity("exportProfile");
		var profileInst = db.fetchInstance(_, entity, {
			jsonWhere : {
				code : "VSEP"
			}
		});
		var entityAttr = model.getEntity("entityAttribute");
		jsonExport.jsonExport(_, profileInst, {
				targetType : "file",
				path : "../node_modules/syracuse-collaboration/test/fixtures/very-simple-export-profile",
				//tracer: console.log
			});

		testAttributes.forEach_(_, function(_, prop) {
			// console.log("deleting " + prop.name + prop.$uuid) ;
			var body = del(_, cookie, "entityAttributes('" + prop.$uuid	+ "')", 200);
			// console.log("entity attribute: "+
			// JSON.stringify(body,null,2)) ;
			// var body = get(_, cookie, "entityAttributes('"+prop.$uuid
			// +"')", 200);

			var obj = db.fetchInstance(_, entityAttr, {
				jsonWhere : {
					name : prop.name
				}
			});
			strictEqual(obj, null, "record destroyed");

		});

		var diag = [];
		jsonImport.jsonImport(_, db, "../node_modules/syracuse-collaboration/test/fixtures/very-simple-export-profile.json", {});

		testAttributes.forEach_(_, function(_, prop) {
			//console.log("prop:" + prop.name);
			var obj = db.fetchInstance(_, entityAttr, {
				jsonWhere : {
					name : prop.name
				}
			});
			// notEqual(null, obj);
			// console.log("after fetch:" +obj.$uuid) ;
			// var body = get(_, cookie, "entityAttributes('"+prop.$uuid
			// +"')", 200);
			// console.log("After import: get entity attribute: "+
			// sys.inspect(obj)) ;
		});

	} catch (ex) {
		console.error(ex);
	}
	start();
});





	

var testSettings = [ {
	nbr : 7,
	profileDescr : "localized-property",
	profileCode : "LPEP",
	exportItems : [ {
		className : "portlets",
		title : "Portlets",
		entityKeyAttribute : [ {
			name : "title"
		} ],
		entityAttribute : [ {
			name : "type"
		} ]
	} ]
}, {
	nbr : 10,
	profileDescr : "single-ref-relation",
	profileCode : "SRREP",
	exportItems : [ {
		className : "roles",
		title : "Roles",
		entityKeyAttribute : [ {
			name : "description"
		} ]
	}, {
		className : "groups",
		title : "Groups",
		entityKeyAttribute : [ {
			name : "description"
		} ],
		entityAttribute : [ {
			name : "role"
		} ]
	} ]
}, {
	nbr : 17,
	profileDescr : "plural-ref-relation",
	profileCode : "PRREP",
	exportItems : [ {
		className : "groups",
		title : "Groups",
		entityKeyAttribute : [ {
			name : "description"
		} ],
		entityAttribute : [ {
			name : "description"
		} ]
	}, {
		className : "users",
		title : "Users",
		entityAttribute : [ {
			name : "login"
		}, {
			name : "password"
		}, {
			name : "title"
		}, {
			name : "firstName"
		}, {
			name : "lastName"
		}, {
			name : "groups"
		},
		{
			name : "autentication"
		} ],
		entityKeyAttribute : [ {
			name : "lastName"
		} ]
	} ]
},{
	nbr : 13,
	profileDescr : "spe-single-child-relation",
	profileCode : "SCREP",
	exportItems : [ {
		className : "automateTasks",
		title : "automateTasks",
		entityKeyAttribute : [ {
			name : "description"
		} ],
		entityAttribute : [ {
			name : "logLevel"
		}, {
			name : "process"
		} ]
	}, {
		className : "searchAdmins",
		title : "searchAdmins",
		entityKeyAttribute : [ {
			name : "differentialUpdate"
		} ],
		entityAttribute : [ {
			name : "debugMode"
		} ]
	} ]
},  {
	nbr : 27,
	profileDescr : "plural-child-relation",
	profileCode : "PCREP",
	exportItems : [ {
		className : "users",
		title : "Users",
		entityAttribute : [ {
			name : "login"
		}, {
			name : "password"
		}, {
			name : "title"
		}, {
			name : "firstName"
		}, {
			name : "lastName"
		}, {
			name : "locales"
		},
		{
			name : "autentication"
		} ],
		entityKeyAttribute : [ {
			name : "lastName"
		} ]
	}, {
		className : "localePreferences",
		title : "Locale Preferences",
		entityKeyAttribute : [ {
			name : "code"
		} ],
		entityAttribute : [ {
			name : "description"
		}, {
			name : "shortDate"
		}, {
			name : "shortTime"
		}, {
			name : "longTime"
		}, {
			name : "shortDatetime"
		}, {
			name : "longDatetime"
		}, {
			name : "longDate"
		}, {
			name : "firstDayOfWeek"
		}, {
			name : "numberDecimalSeparator"
		}, {
			name : "numberGroupSize"
		}, {
			name : "enabled"
		} ]
	} ]
}, {
	nbr : 25,
	profileDescr : "nested-child-relation",
	profileCode : "NCREP",
	exportItems : [ {
		className : "applications",
		title : "Applications",
		entityKeyAttribute : [ {
			name : "application"
		}, {
			name : "contract"
		} ]
	} 
	,{
		className : "portlets",
		title : "Portlets",
		entityKeyAttribute : [ {
			name : "title"
		} ],
		entityAttribute : [ {
			name : "type"
		} ]
	}, {
		className : "dashboardVariants",
		title : "DashboardVariants",
		entityKeyAttribute : [ {
			name : "title"
		} ],
		entityAttribute : [ {
			name : "allApplications"
		}, {
			name : "vignettes"
		}, {
			name : "application"
		}

		]
	}, {
		className : "dashboardVignettes",
		title : "DashboardVignettes",
		entityKeyAttribute : [ {
			name : "portlet"
		} ],
		entityAttribute : [ {
			name : "portlet",
		},
		{
			name : "allEndpoints",
		}
		]
	}, {
		className : "dashboardDefs",
		title : "DashboardDefs",
		entityKeyAttribute : [ {
			name : "dashboardName"
		} ],
		entityAttribute : [ {
			name : "variants"
		}

		]
	}
	]
},
{
	nbr : 10,
	profileDescr : "spe-mandatory-relation",
	profileCode : "MREP",
	exportItems : [{
		className : "teams",
		title : "Teams",
		entityAttribute : [ {
			name : "description"
		}],
		entityKeyAttribute : [ {
			name : "description"
		}]
		}, {
		className : "users",
		title : "Users",
		entityAttribute : [ {
			name : "login"
		}, {
			name : "password"
		}, {
			name : "title"
		}, {
			name : "firstName"
		}, {
			name : "lastName"
		},
		{
			name : "autentication"
		} ],
		entityKeyAttribute : [ {
			name : "lastName"
		} ]
	} ]
}
 ,{
	nbr : 7,
	profileDescr : "filter",
	profileCode : "FEP",
	exportItems : [ {
		className : "applications",
		title : "Applications",
		entityKeyAttribute : [ {
			name : "application"
		}, {
			name : "contract"
		}],
		entityAttribute :[
		{
			name : "description"
		}
		
		],
		filter: "description like '%UnitTest%'" 
	}]
},
 {
	nbr : 12,
	profileDescr : "null-child",
	profileCode : "NCEP",
	exportItems : [ {
		className : "automateTasks",
		title : "automateTasks",
		entityKeyAttribute : [ {
			name : "description"
		} ],
		entityAttribute : [ {
			name : "logLevel"
		}, {
			name : "process"
		} ]
	}, {
		className : "searchAdmins",
		title : "searchAdmins",
		entityKeyAttribute : [ {
			name : "differentialUpdate"
		} ],
		entityAttribute : [ {
			name : "debugMode"
		} ]
	} ]
},
{
	nbr : 7,
	profileDescr : "spe-null-single-key",
	profileCode : "NSKEP",
	exportItems : [ {
		className : "roles",
		title : "Roles",
		entityKeyAttribute : [ {
			name : "functionProfile"
		} ],
		entityAttribute : [ {
			name : "description"
		}
		 ]
	} ]
}/*,
{
	nbr : 8,
	profileDescr : "null-combined-key",
	profileCode : "NCKEP",
	exportItems : [ {
		className : "applications",
		title : "Roles",
		entityKeyAttribute : [ {
			name : "description"
		} ]
	} ]
}*/


];

testSettings.forEach_(_, function(_, test) {
	//console.log("TEST: " + JSON.stringify(test,null,2));
	var profileDescr = test.profileDescr;
	var importFile = "../node_modules/syracuse-collaboration/test/fixtures/" + test.profileDescr + "-import.json";
	var exportFile = "../node_modules/syracuse-collaboration/test/fixtures/" + test.profileDescr + "-export";
	var profileCode = test.profileCode;
	var exportItems = test.exportItems;
	function testFunc(_) {
		/*function sortfunction(a, b) {
			if (a.$type < b.$type)
				return -1;
			else if (a.$type > b.$type)
				return 1;
			else {// (a.$type==b.$type)

				var key = inproto[a.$type].$key;
				// console.log("****TYPE: "+a.$type+ "KEY:"+ key ) ;
				var keys = (typeof (key) === "object") ? key : [ key ];
				var i;
				for (i = 0; i < keys.length; i++)
					if (a[keys[i]] < b[keys[i]])
						return -1;
					else if (a[keys[i]] > b[keys[i]])
						return 1;
				// else continue ;
			}
			// return a.$type-b.$type ;
		}*/
		

		cookie = getCookie(_);
		var diag = [];
		var db = dataModel.getOrm(_, _getModel(), endPoint.datasets.mongodb_admin_test);

		var model = db.model;
		//console.log("importFile: " + importFile);

		jsonImport.jsonImport(_, db, importFile, {});// $diagnoses:diag, tracer:console.log

		//var body = get(_, cookie, "applications", 200);
		// console.log("exportProfileItem: "+ JSON.stringify(body,null,2)) ;
		//console.log("*********DASHBOARD DEFINITIONS: "	+ JSON.stringify(body, null, 2));

		exportItems.forEach_(_, function(_, item) {
			var coll = get(_, cookie, item.className, 200);
			// console.log( "GET EXPORTED OBJECTS: "+
			// JSON.stringify(coll,null,2)) ;
			//tracer && tracer("JsonExport: nb. objects to export for "+item.className+' ' + coll.$resources.length);
			if (coll.$resources.length)
				item.exportedObjects = [];
			coll.$resources.forEach_(_, function(_, el) {
				//console.log("EL : " + el.$uuid);
				item.exportedObjects.push({
					$uuid : el.$uuid
				});
			});

			var body = post(_, cookie, "exportProfileItems/$template/$workingCopies?trackingId=" + uuid.generate(), {});
			//console.log("exportProfileItem: " + item.className);
			var data = {};

			data.$key = body.$uuid;
			data.$etag = body.$etag;

			data.$actions = {
				$save : {
					$isRequested : true
				}
			};
			body = put(_, cookie, body.$url, data);
		});

		// console.log("exportProfileItem: "+ JSON.stringify(item,null,2)) ;

		var expProfile = {
			description : profileDescr,

			code : profileCode,
			applicationName : "syracuse",
			endpoint : adminEp,
			application : {
				description : "First Application",
				application : "syracuse"
			},
			exportProfileItem : exportItems,
		};

		var profile = post(_, cookie, "exportProfiles", expProfile);
		// console.log("Export profile"+ JSON.stringify(profile,null,2) ) ;

		var entity = model.getEntity("exportProfile");
		var profileInst = db.fetchInstance(_, entity, {
			jsonWhere : {
				code : profileCode
			}
		});
		//console.log("EXPORT NOW");
		jsonExport.jsonExport(_, profileInst, {
			targetType : "file",
			path : exportFile,
			$diagnoses : diag,
			//tracer : console.log
		});

		var input = JSON.parse(fs.readFile(fsp.join(__dirname, //
		"../../../../import", importFile), //
		"utf8", _));
		var inproto = input.$prototypes || {};
		var indata = input.$items || [];

		var output = JSON.parse(fs.readFile(fsp.join(__dirname, //
		"../../../../import", exportFile + ".json"), //
		"utf8", _));
		
		var diagnoses=[] ;
		profileInst.getAllDiagnoses(_, diagnoses);
		console.log(sys.inspect(diagnoses)) ;
		var raisedWarnings =false ;
		var raisedErrors =false ;
		var i ;
		for (i=0; i<diagnoses.length ; i++ ){
			if (diagnoses[i].severity == "warning") {
				raisedWarnings=true ;
			}
			if (diagnoses[i].severity == "error"){
				raisedErrors=true ;
			}
			console.log(diagnoses[i].message) ;
		} ;

		var outproto = output.$prototypes || {};
		var outdata = output.$items || [];

		//specific checks 
		if (expProfile.code==='SCREP') {
			
			ok (raisedWarnings,"warning raised ") ;
			delete inproto.searchAdmin.endpoint ;
			
			
			test.exportItems.forEach_(_, function (_, item) {
			if (item.$type==="endpoint") 
				return ;	
			item.entityAttribute && item.entityAttribute.forEach_(_, function (_, prop){
			strictEqual(indata[prop.name],outdata[prop.name],prop.name) ;
			});
		});
     	}

		if (expProfile.code==='MREP') {
			delete inproto.team.administrator ;
			ok (raisedWarnings,"warning raised ") ;
	    }
     	if (expProfile.code==='NSKEP') {
		
			ok (raisedErrors,"error raised ") ;
     	}

		same(inproto, outproto, "proto");

		test.exportItems.forEach_(_, function (_, item) {
			console.log(expProfile.description) ;
			if (expProfile.description.match(/^spe/)) {
				return ;
			}
			
			item.entityAttribute && item.entityAttribute.forEach_(_, function (_, prop){
				strictEqual(indata[prop.name],outdata[prop.name],prop.name) ;
			});
		});
		
		start();
	}
	asyncTest("test " + profileDescr, test.nbr, testFunc);
});



asyncTest("exportAll", 8,	function(_)  {
	cookie = getCookie(_);
	var importFile="../node_modules/syracuse-collaboration/test/fixtures/exportAll-import.json";
	var exportFile="../node_modules/syracuse-collaboration/test/fixtures/exportAll-export" ;
	try {

		var input = JSON.parse(fs.readFile(fsp.join(__dirname, //
		"../../../../import", importFile), //
		"utf8", _));
		var expProfile = {
			description : "exportAll",
			code : "EAEP",
			applicationName : "syracuse",
			endpoint : adminEp,
			application : {
				description : "Syracuse Application",
				application : "syracuse"
			},
			exportProfileItem  : [ {
			className : "applications",
			title : "Applications",
			entityKeyAttribute : [ {
				name : "application"
			}, {
				name : "contract"
			}],
			entityAttribute :[
			{
				name : "description"
			}
			
			],
			exportAll: true
		}]
	};


		var item = expProfile.exportProfileItem[0];
		//console.log("ITEM CLASS NAME: " + item.className);
		var coll = get(_, cookie, item.className, 200);
	
		if (coll.$resources.length >=2)
			item.exportedObjects = [];
		for (var j=0;j<2;j++){
			var el=coll.$resources[j];
			item.exportedObjects.push({
				$uuid : el.$uuid
			});
		};	
		
		var body = post(_, cookie, "exportProfiles/$template/$workingCopies?trackingId=" + uuid.generate(), {});
		
		expProfile.$key = body.$uuid;
		expProfile.$etag = body.$etag;

		expProfile.$actions = {
			$save : {
				$isRequested : true
			}
		};

		profile = put(_, cookie, body.$url, expProfile);
		profileId = body.$uuid;

		var db = dataModel.getOrm(_, _getModel(), endPoint.datasets.mongodb_admin_test);
		var model = db.model;
		var entity = model.getEntity("exportProfile");
		var profileInst = db.fetchInstance(_, entity, {
			jsonWhere : {
				code : "EAEP"
			}
		});
	
	
		jsonExport.jsonExport(_, profileInst,{
				targetType : "file",
				path : exportFile,
				//tracer: console.log
			});

			var output = JSON.parse(fs.readFile(fsp.join(__dirname, //
			"../../../../import", exportFile+".json" ), //
			"utf8", _));
		
		//console.log("output "+JSON.stringify(output,null,2)) ;
			var outitems=output.$items ;

			strictEqual(outitems.length , 5 ,"allItems is true") ;
			//fs.unlinkSync(exportFile+".json") ;
			// 2nd part

			expProfile.code="EAEP2" ;
			expProfile.description="exportAll 2" ;
			expProfile.exportProfileItem[0].exportAll= false ;
			console.log("EXPORT PROFILE: "+ JSON.stringify(expProfile,null,2));
			var body = post(_, cookie, "exportProfiles/$template/$workingCopies?trackingId=" + uuid.generate(), {});
		
			expProfile.$key = body.$uuid;
			expProfile.$etag = body.$etag;

			expProfile.$actions = {
				$save : {
					$isRequested : true
				}
			};
			body = put(_, cookie, body.$url, expProfile);
			
			profileInst = db.fetchInstance(_, entity, {
			jsonWhere : {
				code : "EAEP2"
			}
			});


	
			jsonExport.jsonExport(_, profileInst,{
				targetType : "file",
				path : exportFile+"2",
				//tracer: console.log
			});

			output = JSON.parse(fs.readFile(fsp.join(__dirname, //
			"../../../../import", exportFile+"2.json"), //
			"utf8", _));
		
			outitems=output.$items ;
			strictEqual(outitems.length , 2 ,"allItems is false") ;
	

	} catch (ex) {
		console.error(ex);
	}
	start();
});




	

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});
