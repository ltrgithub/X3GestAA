"use strict";

var module = QUnit.module;
var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var mongodb = require("mongodb");
var sys = require("util");
var factory = require("syracuse-orm/lib/factory");
var jsonExport = require("syracuse-import/lib/jsonExport") ;
var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

//force basic auth
config.session = config.session || {};
config.session.auth = "basic";

var endPoint = null;
config.sdata.endpoints.forEach(function(endp) {
	if ((endp.contract.application == "syracuse") && (endp.contract.contract == "collaboration")) {
		endPoint = endp;
	}
});
if (!endPoint) {
	//add model
	endPoint = {
		contract: require("syracuse-collaboration/lib/contract").contract,
	};
	config.sdata.endpoints.push(endPoint);
}
endPoint.datasets.mongodb_demo = {
	driver: "mongodb",
	port: 27017
}
//
var requestCount = 0;
var MAX_REQUESTS = 11;

var baseUrl = "http://localhost:3004"
var contractUrl = "/sdata/syracuse/collaboration/mongodb_demo/";
var port = 3004;
var syracuse = require('syracuse-main/lib/syracuse');
var streams = require('streamline/lib/streams/streams');
//start syracuse server
//syracuse.server.listen(null, port);

function getCookie(_) {
	var response = new streams.httpRequest({
		url: baseUrl + "/syracuse-main/html/main.html",
		user: "guest",
		password: "guest"
	}).end().response(_);
	response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	return response.headers["set-cookie"];
}

function _getModel() {
	return dataModel.make(registry.applications.syracuse.contracts.collaboration, "mongodb_demo");
}

var doStop = false;
module("syracuseDemoImportTest", {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			//			syracuse.server.close();
			setTimeout(function() {
				process.kill(process.pid);
			}, 0)
		}
	}
});

var franceID = "";
var usID = "";

/*asyncTest("init database", 1, function(_) {
	var server = new mongodb.Server(endPoint.datasets["mongodb_demo"].hostname, endPoint.datasets["mongodb_demo"].port, {});
	var db = new mongodb.Db(endPoint.datasets["mongodb_demo"].database, server, {});
	db = db.open(_);
	db.dropDatabase(_);
	ok(true, "mongodb initialized");
	start();
});*/

function onlyInfo(diags) {
	return diags.every(function(diag) {
		return diag.severity == "info";
	});
}

asyncTest("export Profile", 12, function(_) {
	//var db = dataModel.getOrm(_, _getModel(), endPoint.datasets.mongodb_demo);
	var db=adminHelper.getCollaborationOrm(_) ;
	var model=db.model ;
	
	var entity=model.getEntity("exportProfile") ;
	var instance=db.fetchInstance(_,entity, {jsonWhere: {code: "demoExport"}});
	console.error("instance export profile code: "+instance.description(_)) ;
	
	
	jsonExport.jsonExport(_,instance,"demoexport") ;

	/*var role = db.fetchInstance(_, db.model.getEntity("role"), {jsonWhere:{description:"Sales manager"}});
	strictEqual(role.description(_), "Sales manager", "role fetch ok");
	var count = db.count(_, db.model.getEntity("role"), {});
	strictEqual(count, 8, "roles count ok");*/
	// check endpoints
	
	start();
});

asyncTest("stop  tests", 0, function(_) {
	doStop = true;
	start();
});