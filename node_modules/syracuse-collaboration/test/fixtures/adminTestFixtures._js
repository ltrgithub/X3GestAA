"use strict";

var streams = require('streamline/lib/streams/streams');
var nodeconfig = require('syracuse-main/lib/nodeconfig'); // must be first syracuse require
var config = nodeconfig.config; // must be first syracuse require

exports.modifyCollaborationEndpoint = function(datasetName) {
//	nodeconfig.initEndpointsConfiguration();
	var endPoint = null;
	config.sdata.endpoints.forEach(function(endp) {
		if ((endp.contract.application == "syracuse") && (endp.contract.contract == "collaboration")) {
			endPoint = endp;
		}
	});
	if (!endPoint) {
		//add model
		endPoint = {
			contract: require("syracuse-collaboration/lib/contract").contract,
		};
		config.sdata.endpoints.push(endPoint);
	}
	endPoint.datasets[datasetName] = {
		driver: "mongodb",
		hostname: "localhost",
		database: datasetName,
		port: 27017
	}
	config.collaboration.dataset = datasetName;
	//
	return endPoint;
}

exports.onlyInfo = function(diags) {
	return (diags || []).every(function(diag) {
		return (diag.severity == "info" || diag.severity == "success");
	});
}

exports.getCookie = function(_, baseUrl, login, pass, fullResponseReturn) {
	var response = new streams.httpRequest({
		url: baseUrl + "/syracuse-main/html/main.html",
		user: login || "guest",
		password: pass || "guest",
		headers: {
			"accept-language": "fr,fr-fr",
		}
	}).end().response(_);
	var body = response.readAll(_);
	strictEqual(response.statusCode, 200, "user authenticated");
	if(fullResponseReturn)
		return {
			statusCode: response.statusCode,
			headers: response.headers,
			body: body
		};
	else
		return response.headers["set-cookie"];
}

exports.get = function(_, cookie, url, statusCode, fullResponseReturn) {
	var response = streams.httpRequest({
		method: "get",
		url: url,
		headers: {
			cookie: cookie,
			"Accept-Language": "en-us",
			accept: "application/json;vnd.sage=syracuse"
		}
	}).end().response(_);
	strictEqual(response.statusCode, statusCode || 200, "status verified");
	var body = JSON.parse(response.readAll(_));
	if(fullResponseReturn)
		return {
			statusCode: response.statusCode,
			headers: response.headers,
			body: body
		};
	else
		return body;
}

