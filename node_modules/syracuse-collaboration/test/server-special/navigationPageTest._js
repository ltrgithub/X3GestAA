"use strict";

var helpers = require('syracuse-core/lib/helpers');
var uuid = helpers.uuid;
var forEachKey = helpers.object.forEachKey;
var config = require('config'); // must be first syracuse require
var sys = require("util");
var jsonImport = require("syracuse-import/lib/jsonImport");
var jsonExport = require("syracuse-import/lib/jsonExport");

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");

helpers.pageFileStorage = false;

var tracer; // = console.log;
var serverUrl = "http://localhost:3004";
var admBaseUrl = serverUrl + "/sdata/syracuse/collaboration/unit_test";

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				//process.stdout.end();
				console.error("Finished");
				process.kill(process.pid);
			}, 1000);
		}
	}
});

var db;
var moduleCount;
var cookie;
asyncTest("init database", 1, function(_) {
	//
	db = adminTestFixtures.initializeTestEnvironnement(_, "unit_test", 3004, true);
	ok(db != null, "Environnement initialized");
	//
	start();
});

function onlyInfo(diags) {
	return adminTestFixtures.onlyInfo(diags);
}

asyncTest("import sample navigation page", 4, function(_) {
	// get navigation page test points
	var nav = db.fetchInstance(_, db.getEntity(_, "navigationPage"), {
		pageName: "home"
	});
	var diag = [];
	if (!nav) {
		// import
		jsonImport.jsonImport(_, db, "../node_modules/syracuse-collaboration/test/server-special/x3-erp-init.json", {
			$diagnoses: diag
		});
		//tracer && tracer("import demo db diags (52): " + sys.inspect(diag));
	}
	ok(onlyInfo(diag), "Demo database init import ok");
	var diag = [];
	if (!nav) {
		jsonImport.jsonImport(_, db, "../node_modules/syracuse-collaboration/test/server-special/x3-erp-sitemap.json", {
			$diagnoses: diag
		});
		//tracer && tracer("import demo db diags (58): " + sys.inspect(diag));
	}
	ok(onlyInfo(diag), "Demo database page import ok");

	// get navigation page test points
	var nav = db.fetchInstance(_, db.getEntity(_, "navigationPage"), {
		pageName: "home"
	});
	moduleCount = nav.modules(_).getLength();
	strictEqual(moduleCount, 19, "Modules count on load ok");
	strictEqual(nav.modules(_).toArray(_).length, 19, "Modules count from toArray ok");

	start();
});

asyncTest("syracuse navigation page get in edit mode test", 3, function(_) {
	cookie = adminTestFixtures.getCookie(_, serverUrl, "admin", "admin");
	var body = adminTestFixtures.get(_, cookie, admBaseUrl + "/pages('syracuse.collaboration.unit_test.home.$navigation_edit,$page,')", 200);
	tracer && tracer("page body (69): " + sys.inspect(body, null, 4));
	strictEqual(body.modules.length, 19, "Modules count ok");

	start();
});

asyncTest("stop  tests", 0, function(_) {
	console.log("Stopping here");
	doStop = true;

	start();
});