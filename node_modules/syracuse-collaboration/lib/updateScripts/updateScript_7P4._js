"use strict";

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var helpers = require("syracuse-core/lib/helpers");
var sys = require("util");

exports.tracer = null;

var _scripts = [];

_scripts[1] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 1; remove forcedExecution parameter");
	//
	var miColl = db.db.collection("MenuItem", _);
	var menus = miColl.find({
		isFactory: true,
		"parameters.name": "forcedExecution"
	}).toArray(_);
	menus.forEach_(_, function(_, menu) {
		miColl.update({
			_id: menu._id
		}, {
			$set: {
				parameters: menu.parameters.filter(function(pp) {
					return pp.name !== "forcedExecution";
				})
			}
		}, {
			safe: true,
			multi: true
		}, _);
	});
	//
	exports.tracer && exports.tracer("Update script to version: 1 executed");
};

_scripts[2] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 2; remove old dashboard menus from sitemap");
	//
	var miColl = db.db.collection("MenuItem", _);
	var blockColl = db.db.collection("MenuBlock",_);
	var menus = miColl.find({
		code: {
			$in: ["S_DASHBOARDS", "S_VIGNETTES"]
		}
	}).toArray(_);
	menus.forEach_(_, function(_, menu) {
		var blocks = blockColl.find({
			"items._uuid": menu._id
		}).toArray(_);
		exports.tracer && exports.tracer("Removing entry: " + menu.code + "; found " + blocks.length + " submodules");
		blocks.forEach_(_, function(_, bk) {
			blockColl.update({
				_id: bk._id
			}, {
				$set: {
					items: bk.items.filter(function(it) {
						return it._uuid !== menu._id;
					}),
					_updDate: new Date()
				}
			}, {
				safe: true,
				multi: true
			}, _);
		});
	});
	//
	exports.tracer && exports.tracer("Update script to version: 2 executed");
};

exports.dataUpdate = function(_, db, actualVersion, targetVersion) {
	// force log: always
	exports.tracer = console.log;
	//
	_scripts.slice(actualVersion + 1, targetVersion + 1).forEach_(_, function(_, sequence) {
		sequence && sequence(_, db);
	});
};

exports.metadata = {
	fileId: "2r731d8925fd", // this id MUST never change and MUST be unique over all update scripts
	description: "7 patch 4 branch update script" // !important, some description, optional and can change
};