"use strict";

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var helpers = require("syracuse-core/lib/helpers");
var sys = require("util");

exports.tracer = null;

var _scripts = [];

_scripts[1] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 1; force security profile on roles");
	// 
	var cnt = 0;
	var spAdmin = db.db.collection("SecurityProfile", _).find({
		code: "ADMIN"
	}).toArray(_)[0];
	if (spAdmin && spAdmin._id) {
		var rolesColl = db.db.collection("Role", _);
		cnt = rolesColl.update({
			"securityProfile._uuid": null
		}, {
			$set: {
				"securityProfile._uuid": spAdmin._id
			}
		}, {
			safe: true,
			multi: true
		}, _);
	}
	//
	exports.tracer && exports.tracer("Update script to version: 1 executed; " + cnt + " roles updated");
};

_scripts[2] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 2; initialize security level on security profile");
	//
	var cnt = db.db.collection("SecurityProfile").update({
		securityLevel: null
	}, {
		$set: {
			securityLevel: 0
		}
	}, {
		safe: true,
		multi: true
	}, _);
	//
	exports.tracer && exports.tracer("Update script to version: 2 executed; " + cnt + " security profiles updated");
};


_scripts[3] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 3; Customer admin import");
	require("syracuse-import/lib/jsonImport").jsonImport(_, db, "syracuse-sky-init.json", {
		tracer: exports.tracer
	});
	exports.tracer && exports.tracer("Update script to version: 3 executed");
};

//_scripts[3] = function(_, db) {
//	exports.tracer && exports.tracer("Executing update script to version: 3; initialize customer admin group, role, security profile");
//	//
//	var code = 'CADMIN';
//	var desc = 'Customer admin';
//	//
//	var sp = db.model.getEntity(_, "securityProfile").factory.createInstance(_, null, db);
//	sp.code(_, code);
//	sp.description(_, desc);
//	sp.profileItems(_).filter(function(pitem) {
//		return ('authoring', 'collaborationArea', 'maintenanceAndStatus').indexOf(pitem.code) > -1;
//	}).forEach_(_, function(_, pitem) {
//		pitem.canCreate(_, true);
//		pitem.canRead(_, true);
//		pitem.canWrite(_, true);
//		pitem.canExecute(_, true);
//		pitem.canDelete(_, true);
//	});
//	sp.save(_);
//
//	var role = db.model.getEntity(_, "role").factory.createInstance(_, null, db);
//	role.code(_, code);
//	role.description(_, desc);
//	//
//	exports.tracer && exports.tracer("Update script to version: 3 executed");
//};

exports.dataUpdate = function(_, db, actualVersion, targetVersion) {
	// force log: always
	exports.tracer = console.log;
	//
	_scripts.slice(actualVersion + 1, targetVersion + 1).forEach_(_, function(_, sequence) {
		sequence && sequence(_, db);
	});
};

exports.metadata = {
	fileId: "5dfrhd8925fd", // this id MUST never change and MUST be unique over all update scripts
	description: "7 sky branch update script" // !important, some description, optional and can change
};