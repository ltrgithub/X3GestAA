"use strict";

exports.tracer = null;
exports.importHandler = null;

var _scripts = [];
var appUuid;
_scripts[0] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [0]; find collaboration application");

	var coll = db.db.collection("Application", _);
	var elts = coll.find({
		"$and": [{
			"application": "syracuse"
		}, {
			"contract": "collaboration"
		}]
	}).toArray(_);
	if (!elts[0]) throw new Error("Syracuse collaboration application not found");
	appUuid = elts[0]._id;
	exports.tracer && exports.tracer("Pre script [0] executed");
};

_scripts[1] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [1]; remove $factory submodules");

	var coll = db.db.collection("MenuBlock", _);
	var filter = {
		"$and": [{
			"_factory": true
		}, {
			"application._uuid": appUuid
		}]
	};
	var res = coll.remove(filter);
	exports.tracer && exports.tracer("Nb submodules removed: " + res);
	exports.tracer && exports.tracer("Pre script [1] executed");
};

_scripts[2] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [2]; remove $factory modules");
	var coll = db.db.collection("MenuModule", _);
	var filter = {
		"$and": [{
			"_factory": true
		}, {
			"application._uuid": appUuid
		}]
	};
	var res = coll.remove(filter);
	exports.tracer && exports.tracer("Nb modules removed: " + res);

	// re import modules
	exports.importHandler && exports.importHandler.jsonImport(_, db, "syracuse-collaboration-init.json", {
		importMode: "insert",
		$diagnoses: []
	});
	exports.tracer && exports.tracer("Pre script [2] executed");
};

exports.dataUpdate = function(_, db) {
	// force log: always
	exports.tracer = console.log;
	//
	exports.tracer && exports.tracer("Begin pre script 'pre-syracuse-collaboration-sitemap'");
	_scripts.forEach_(_, function(_, sequence) {
		sequence && sequence(_, db);
	});
	exports.tracer && exports.tracer("End pre script 'pre-syracuse-collaboration-sitemap'");
};