"use strict";

exports.tracer = null;

var _scripts = [];
var appUuid;
_scripts[0] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [0]; find X3 hrm application");

	var coll = db.db.collection("Application", _);
	var elts = coll.find({
		"$and": [{
			"application": "x3"
		}, {
			"contract": "hrm"
		}]
	}).toArray(_);
	if (!elts[0]) throw new Error("X3 erp application not found");
	appUuid = elts[0]._id;
	exports.tracer && exports.tracer("Pre script [0] executed");
};

_scripts[1] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [1]; remove $factory submodules");

	var coll = db.db.collection("MenuBlock", _);
	var filter = {
		"$and": [{
			"_factory": true
		}, {
			"application._uuid": appUuid
		}]
	};
	var res = coll.remove(filter);
	exports.tracer && exports.tracer("Nb submodules removed: " + res);
	exports.tracer && exports.tracer("Pre script [1] executed");
};

_scripts[2] = function(_, db) {
	exports.tracer && exports.tracer("Executing pre script [2]; remove $factory modules");
	var coll = db.db.collection("MenuModule", _);
	var filter = {
		"$and": [{
			"_factory": true
		}, {
			"application._uuid": appUuid
		}]
	};
	// store modules uuids
	var modsUuids = [];
	var elts = coll.find(filter).toArray(_);
	elts.forEach(function(n) {
		modsUuids.push(n._id);
	});

	// remove modules references in navigation page
	var collNav = db.db.collection("NavigationPage", _);
	var home = collNav.find({
		"pageName": "home"
	}).toArray(_)[0];
	var keep = [];
	home.modules && home.modules.forEach(function(m) {
		if (modsUuids.indexOf(m._uuid) === -1) {
			keep.push(m);
		}
	});

	collNav.update({
		_id: home._id
	}, {
		$set: {
			modules: keep
		}
	}, {
		safe: true,
		multi: true
	}, _);

	// remove modules
	var res = coll.remove(filter);
	exports.tracer && exports.tracer("Nb modules removed: " + res);

	var importHandler = require("syracuse-import/lib/jsonImport");
	// re import modules
	importHandler.jsonImport(_, db, "x3-hrm-init.json", {
		importMode: "insert",
		$diagnoses: []
	});
	exports.tracer && exports.tracer("Pre script [2] executed");
};

exports.dataUpdate = function(_, db) {
	// force log: always
	exports.tracer = console.log;
	//
	exports.tracer && exports.tracer("Begin pre script 'pre-x3-hrm-sitemap'");
	_scripts.forEach_(_, function(_, sequence) {
		sequence && sequence(_, db);
	});
	exports.tracer && exports.tracer("End pre script 'pre-x3-hrm-sitemap'");
};