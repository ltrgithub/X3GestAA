"use strict";

var traceHelper = require('syracuse-trace/lib/helper');

exports.entity = {
	$titleTemplate: "Traces configuration for '{description}'",
	$descriptionTemplate: "Configure {name} traces",
	$valueTemplate: "{name}",
	$canDelete: false,
	$canCreate: false,
	$properties: {
		name: {
			$isUnique: true,
			$linksToDetails: true,
			$title: "Name",
			$isReadOnly: true,
			$type: "string"
		},
		description: {
			$linksToDetails: false,
			$displayLength: 30,
			$title: "Description",
			$isReadOnly: true,
			$type: "string",
			$isLocalized: true
		},
		enabled: {
			$title: "Enabled",
			$type: "boolean",
			$default: false
		},
		modularized: {
			$type: "boolean",
			$default: false,
			$isDefined: function(_, instance) {
				return false;
			},
			$compute: function(_, instance) {
				return instance.modules(_).getLength() > 0;
			}
		},
		transport: {
			$title: "Log type",
			$displayLength: 15,
			$enum: [{
				$value: "console",
				$title: "Console"
			}, {
				$value: "storagearea",
				$title: "Storage Area"
			}, {
				$value: "mongo",
				$title: "MongoDB"
			}],
			$default: "storagearea"
		},
		expiry: {
			$title: "Expiration (minutes)",
			$type: "integer",
			$default: 120,
			$isDefined: function(_, instance) {
				return instance.enabled(_) && instance.transport(_) === "storagearea";
			},
			$isDisable: function(_, instance) {
				return instance.enabled(_) && instance.transport(_) !== "storagearea";
			},
			$isMandatory: function(_, instance) {
				return instance.enabled(_) && instance.transport(_) === "storagearea";
			}
		},
		level: {
			$title: "Tracing level",
			$isDefined: function(_, instance) {
				return instance.enabled(_) && !instance.modularized(_);
			},
			$enum: [{
				$value: "error",
				$title: "Error"
			}, {
				$value: "warning",
				$title: "Warning"
			}, {
				$value: "info",
				$title: "Info"
			}, {
				$value: "debug",
				$title: "Debug"
			}],
			$default: "info"
		}
	},
	$relations: {
		modules: {
			$title: "Modules",
			$type: "traceConfigModules",
			$isReadOnly: true,
			$isChild: true,
			$inv: "traceConfigs",
			$isDefined: function(_, instance) {
				return instance.modularized(_);
			},
			$isDisable: function(_, instance) {
				return !instance.modularized(_);
			}
		}
	},
	$functions: {},
	$events: {
		$afterSave: [

			function(_, instance) {

				if (instance.modules(_).getLength() > 0) {
					instance.modules(_).toArray(_).forEach_(_, function(_, mod) {
						traceHelper.loadTracerConfig(_, instance, instance.name(_), mod.name(_));
					});
				} else {
					traceHelper.loadTracerConfig(_, instance, instance.name(_));
				}
			}
		]
	}
};