"use strict"

var helpers = require("syracuse-core/lib/helpers");
var dataModel = require("syracuse-orm/lib/dataModel");
var sdataRegistry = require("syracuse-sdata/lib/sdataRegistry");
var streams = require("streamline/lib/streams/streams");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

exports.template_storage_volume = "WORD_TEMPLATE_MAILMERGE";
exports.entity = {
	$titleTemplate: "Create word document",
	$descriptionTemplate: " ",
	$valueTemplate: " ",
	
	$isPersistent: false,
	
	$properties: {
        creationMode: {
            $title: "Create document by",
            $enum: [{
				$value: "use_tpl",
				$title: "Use existing template"
			},{
				$value: "new_empty_doc",
				$title: "New empty document"
			},{
				$value: "new_word_tpl",
				$title: "New document by word template"
			}],
            $default: "use_tpl"
        }
	},
    $relations: {
    	document: {
			$title: "Document",
			$type: "document",
			$isDisabled: function(_, instance) {
                return instance.creationMode(_) !== "use_tpl";
			},
			$isMandatory: function(_, instance) {
				return instance.creationMode(_) === "use_tpl";
			},
			// Only show documents stored in predefined storage area
			$lookupFilter: function(_) {
				var db = adminHelper.getCollaborationOrm(_);
				var entity = db.model.getEntity("storageVolume");
			    var instance = db.fetchInstance(_, entity, { "jsonWhere": { "code": exports.template_storage_volume }});
			    if (instance)
			    	return { volume: instance.$uuid };
			} 
    	}
	}
}
