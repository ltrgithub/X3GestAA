"use strict";

var sys = require("util");
var x3pool = require("syracuse-x3/lib/pool");
var locale = require("syracuse-core/lib/locale");
var dataModel = require("syracuse-orm/lib/dataModel");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var streams = require("streamline/lib/streams/streams");

function _makeDataset(_, ep) {
	return {
		driver: ep.databaseDriver(_),
		hostname: ep.databaseHost(_) || "localhost",
		port: ep.databasePort(_),
		database: ep.dataset(_)
	}
}

var _modelMap = {
		"syracuse": function(_, ep, failIfNull) {
			//
			var contract = registry.getContract(ep.applicationRef(_).application(_), ep.applicationRef(_).contract(_), failIfNull);
			if(!contract) return null;
//			var ds = registry.getDataset(_, contract, ep.dataset(_));
//			if (!ds) return null;
			return dataModel.make(contract, ep.dataset(_));
		},
		"x3": function(_, ep) {
			return require("syracuse-orm/lib/dbHandles/x3").makeModel(_, ep);
		}
	}

var _ormMap = {
		"syracuse": function(_, ep, failIfNull) {
			//
			var model = ep.getModel(_, failIfNull);
			//
			return model && dataModel.getOrm(_, model, _makeDataset(_, ep));
		},
		"x3": function(_, ep) {
			return require("syracuse-orm/lib/dbHandles/x3").create(_, ep);
		}
	}

function _getSolutionDescriptor(_, endpoint, silent) {
	if(endpoint._solutionDescriptor) return endpoint._solutionDescriptor;
	if(endpoint.x3SolutionName(_)) {
		var options = {
			url: endpoint.getWebServerBaseUrl(_) + "/solution.json",
			method: "GET"
		}
		var req = streams.httpRequest(options);
		var resp = req.end().response(_);
		if(resp.statusCode === 200) {
			return (endpoint._solutionDescriptor = JSON.parse(resp.readAll(_)));
		}
	}
	// if we're here, no solution descriptor was found
	if(silent) return null;
	throw new Error(locale.format(module, "solutionDescriptorNotFound", endpoint.description(_)));
//	if(endpoint._solutionDescriptor) return endpoint._solutionDescriptor;
	//
//	var config = require("syracuse-main/lib/nodeconfig").config;
//	console.log("config.x3: " +sys.inspect(config));
//	return config && config.x3 && config.x3.solutions && (endpoint._solutionDescriptor = config.x3.solutions[endpoint.x3server(_).serverHost(_)]);
}

exports.entity = {
	$titleTemplate: "Endpoint",
	$descriptionTemplate: "Endpoints describes services locations",
	$valueTemplate: "{description}",
	$properties: {
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isMandatory: true
		},
		application: {
			$title: "Application",
			$isMandatory: true,
			$isHidden: true
		},
		contract: {
			$title: "Contract",
			$isMandatory: true,
			$isHidden: true
		},
		protocol: {
			$title: "Protocol",
			$isMandatory: true,
			$isHidden: true
		},
		dataset: {
			$title: "Name",
			$isMandatory: true,
			
				$isUnique: true
			},
		enableSearch: {
			$title: "Enable search",
			$type: "boolean",
			$default: false
		},
		databaseDriver: {
			$title: "Database driver",
			$enum: [{
				$value: "mongodb",
				$title: "Mongodb"
			}],
			$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			},
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			},
			$default: "mongodb"
		},
		databaseHost: {
			$title: "Database host",
			$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			},
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			}
		},
		databasePort: {
			$title: "Database port",
			$type: "integer",
			$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			},
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "syracuse");
			}
		},
		x3ServerFolder: {
			$title: "Server folder",
			$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "x3");
			},
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "x3");
			},
			$default: "superv",
			$lookup: {
				entity: "lookupX3Folder",
				field: "name"
			}
		},
		x3SolutionName: {
			$title: "Solution name",
			/*$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "x3");
			},*/
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "x3");
			}
		},
		lastIndexDate: {
			$title: "Last search index update",
			$type: "datetime",
			$isDisabled: true,
			
				$isNullable: true
			},
		transitionWebServer: {
			$title: "Transition web server",
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "x3");
			},
			$isDeveloppementFeature: true
		}
	},
	$relations: {
		groups: {
			$title: "Groups",
			$type: "groups",
			$inv: "endPoints",
			isComputed: true
		},
		// should rename as application
		applicationRef:{
			$title: "Application",
			$type: "application",
			$inv: "endpoints",
			$isMandatory: true,
			$propagate: function(_, instance, val) {
				instance.application(_, val.application(_));
				instance.contract(_, val.contract(_));
				instance.protocol(_, val.protocol(_));
			}
		},
		x3server: {
			$title: "X3 server",
			$type: "x3server",
			$inv: "endpoints",
			$isMandatory: function(_, instance) {
				return (instance.protocol(_) === "x3");
			},
			$isDefined: function(_, instance) {
				return (instance.protocol(_) === "x3");
			}
		}
	},
	$functions: {
		isSame: function(_, application, contract, dataset, host, port) {
			// TODO: host and port
			return ((application === this.application(_)) && (contract === this.contract(_)) && (dataset === this.dataset(_)));
		},
		getBaseUrl: function(_) {
			return ["/sdata",this.application(_),this.contract(_),this.dataset(_)].join("/");
		},
		getIndexName: function(_, localeCode) {
			// TODO : does we need to provide an index name or we just concatenate keys ?
			var parts = [this.application(_),this.contract(_),this.dataset(_)];
			if(localeCode)
				parts.push(localeCode);
			return (parts.join(".")).toLowerCase();
		},
		//
		getModel: function(_, failIfNull) {
			var p = this.protocol(_);
			return p && _modelMap[p](_, this, failIfNull);
		},
		getOrm: function(_, failIfNull) {
			var p = this.protocol(_);
			return p && _ormMap[p](_, this, failIfNull);
		},
		// X3 stuff
		getSolutionName: function(_) {
			if(this.x3SolutionName(_))
				return this.x3SolutionName(_);
			throw new Error(locale.format(module, "solutionNameNotFound", endpoint.description(_)));
			// COMPATIBILITY: load the solution descriptor
//			var solutionDesc = _getSolutionDescriptor(_, this);
//			return solutionDesc && solutionDesc.solution && solutionDesc.solution.name;
		},
		getX3FolderName: function(_) {
			return this.x3ServerFolder(_) || "";
		},
		getApplicationServerName: function(_) {
			var solutionDesc = _getSolutionDescriptor(_, this);
			return solutionDesc && solutionDesc.application && solutionDesc.application.server;
		},
		getApplicationServerBaseUrl: function(_, withFolder, secure) {
			var solutionDesc = _getSolutionDescriptor(_, this, true);
			var application = solutionDesc && solutionDesc.application;
			var x3server = this.x3server(_);
			var server = (application && application.server) || x3server.serverHost(_);
			var port = (application && application.mainPort) || x3server.webServerPort(_);
			return (secure?"https://":"http://")+[server+":"+port, "Adonix_"+this.getSolutionName(_)].join("/") + (withFolder ? "/" + this.x3ServerFolder(_) : "");
		},
		getWebServerBaseUrl: function(_, withFolder, secure) {
			var x3server = this.x3server(_);
			return (secure?"https://":"http://")+[(x3server.webServer(_) || x3server.serverHost(_))+":"+x3server.webServerPort(_), "Adonix_"+this.getSolutionName(_)].join("/") + (withFolder ? "/" + this.x3ServerFolder(_) : "");
		},
		getFusionPrototypeBaseUrl: function(_, secure) {
			var x3server = this.x3server(_);
			if(!locale.isoLanguageMap[locale.current.toLowerCase()])
				throw new Error(locale.format(module, "isoLanguageUndefined", locale.current));
			return (secure?"https://":"http://")+[(x3server.webServer(_) || x3server.serverHost(_))+":"+x3server.webServerPort(_), "Adonix_"+this.getSolutionName(_), this.x3ServerFolder(_), "GEN", locale.isoLanguageMap[locale.current.toLowerCase()], "FENW"].join("/");
		},
		getFusionDataServerBaseUrl: function(_, secure) {
			var x3server = this.x3server(_);
			var solutionWebServer;
			if(!this.transitionWebServer || !this.transitionWebServer(_)) {
				var solutionDesc = _getSolutionDescriptor(_, this);
				solutionWebServer = this.transitionWebServer(_) || (solutionDesc && solutionDesc.webServers[0] && (solutionDesc.webServers[0].server + ":" + solutionDesc.webServers[0].mainPort)) ||
					((x3server.webServer(_) || x3server.serverHost(_))+":"+x3server.webServerPort(_));
			} else
				solutionWebServer = this.transitionWebServer(_);
			//
			return (secure?"https://":"http://")+[solutionWebServer, "sdata", "x3", "trans", "-"].join("/");
		}
	},
	$searchIndex: {
		$fields: ["description", "applicationRef", "dataset", "groups", "x3server", "x3ServerFolder", "databaseDriver", "databaseHost"]
	}
};
