"use strict";

var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var translation = require("syracuse-translation/lib/translation");
var jsurl = require("jsurl");
var helpers = require("syracuse-core/lib/helpers");

exports.entity = {
	$properties: {
		code: {
			$title: "Code",
			$isMandatory: true,
			$isUnique: true,
			/*$propagate: function(_, instance, val) {
				var ap = adminHelper.getCollaborationApplication(_);
				instance.application(_, ap);

			}*/
		},
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isMandatory: true,
				$isUnique: true
			},
		applicationName: {
			//$isHidden: true,
			/*$compute: function(_, instance) {
				return (instance.application(_) && instance.application(_).application(_)) || "X3";
			}*/
		},
		contractName: {
			//$isHidden: true,
			/*$compute: function(_, instance) {
				return (instance.application(_) && instance.application(_).contract(_)) || "erp";
			}*/
		},
		endpointName: {
			//$isHidden: true,
			/*$compute: function(_, instance) {
				return (instance.endpoint(_) && instance.endpoint(_).dataset(_)) || "erp/X3";
			}*/
		},
		
		
	},
	$titleTemplate: "Translation",
	$descriptionTemplate: "translation syracuse messages",
	$valueTemplate: "{description}",
	$relations: {
		application: {
			$title: "Application",
			$type: "application",
			$isDefined: true,
			$isMandatory: true,
			/*defaultValue:  function(_) {
				return adminHelper.getCollaborationApplication(_);
			}*/
		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true,
			$isDefined: true,
			/*defaultValue:  function(_) {
				return adminHelper.getCollaborationEndpoint(_);
			}*/
		}
	},
	$services: {
	    fromSyracuseToX3: {
			$method : "GET",
			$isMethod : true,
			$title : "Syracuse -> X3",
			$invocationMode: "async",
//			$type: "application/x-translation",
			/*$parameters: {
				$url: "{$baseUrl}/selectExportTargets/$template/$workingCopies?representation=selectExportTarget.$edit&role={$role}",
				$method: "POST",
				$properties: {
					parameters: {
						$type: "application/x-string"
					}
				}
			},*/
			$execute : function(_, context, instance) {
				//if (!instance) return?????????
				var opt = context.parameters.parameters && jsurl.parse(context.parameters.parameters);
				//console.log("**********texts translation:" +sys.inspect(instance.endpoint(_))) ;
				/*instance.$diagnoses = instance.$diagnoses || [];
				opt.$diagnoses = instance.$diagnoses;*/
				translation.extractResources(_, instance, opt ,context);
			}
		},
	    fromX3toSyracuse: {
			$method : "GET",
			$isMethod : true,
			$title : "X3 -> Syracuse",
			$type: "application/x-translation",
			$invocationMode: "async",
			$execute : function(_, context, instance) {
				var opt = context.parameters.parameters && jsurl.parse(context.parameters.parameters);
				translation.updateResources(_, instance, opt ,context);
			}
		},
		deleteAll: {
			$method : "GET",
			$isMethod : true,
			$title : "Delete All",
			$type: "application/x-translation",
			$execute : function(_, context, instance) {
				var opt = context.parameters.parameters && jsurl.parse(context.parameters.parameters);
				translation.deleteAll(_, instance, opt ,context);
			}
		},
		testCreate: {
			$method: "POST",
			$isMethod: true,
			$title: "TEMP test creation",
			$execute: function(_, context, instance) {
				console.log("test create") ;
				var db = instance.endpoint(_).getOrm(_);
				var ent = db.getEntity(_, "APLSTD", "$edit");
				var inst = ent.createInstance(_, db);
				console.log("test create ddd") ;
//				inst.AUUID(_, helpers.uuid.generate());
				inst.LANCHP(_, 10030);
				inst.LANNUM(_, 100);
				inst.LANMES(_, "Test message from crnit");
				inst.LAN(_, "ENG");
				inst.save(_);
				// copy diags
				instance.$diagnoses = instance.$diagnoses || [];
				inst.getAllDiagnoses(_, instance.$diagnoses, {
					addPropName: true,
					addEntityName: true
				});
				console.log("diags: "+sys.inspect(instance.$diagnoses)) ;
			}
		}

	},
	$searchIndex: {
		$fields: ["description"]
	}
};