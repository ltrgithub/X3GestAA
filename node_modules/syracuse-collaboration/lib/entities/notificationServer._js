"use strict";

var locale = require("syracuse-core/lib/locale");
var config = require('syracuse-main/lib/nodeconfig').config;
var mail = require("syracuse-email/lib/mail");
var tracer; // = console.log

exports.entity = {
	$titleTemplate: "Notification server",
	$valueTemplate: "{code}",
	$properties: {
		code: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		},
		type: {
			$title: "Type",
			$enum: [{
				$value: "SMTP",
				$title: "SMTP"
			}],
			$default: "SMTP"
		},
		service: {
			$title: "Service",
		},
		host: {
			$title: "Mail server",
			$isMandatory: true
		},
		port: {
			$title: "Port",
			$type: "integer",
			$default: 0
		},
		secureConnection: {
			$title: "Secure connection",
			$type: "boolean",
			$default: false
		},
		clientHost: {
			$title: "Client server name",
		},
		authentication: {
			$title: "Authentication",
			$default: "none",
			$enum: [{
				$value: "none",
				$title: "No authentication"
			}, {
				$value: "password",
				$title: "Authentication with user and password"
			}]
		},
		user: {
			$title: "User",
			$isHidden: function(_, instance) {
				return instance.authentication(_) !== "password";
			}
		},
		password: {
			$title: "Password",
			$isHidden: function(_, instance) {
				return instance.authentication(_) !== "password";
			},
			$type: "password",
			$capabilities: "confirm",
		},
		sender: {
			$title: "Sender email",
			$format: "$email",
			$isMandatory: true
		},
		idleTime: {
			$title: "Idle time",
			$type: "integer",
			$default: 10000
		}
	},
	$relations: {},
	$functions: {
		notify: function(_, user, title, text) {
			var email = user.email(_);
			if (!email) throw new Error(locale.format(module, "noRecipient"));
			var emailOptions = {
				from: this.sender(_),
				to: email,
				subject: title,
				text: text
			};
			tracer && tracer("Notify server " + this.code(_) + " subject " + title);
			mail.sendMail(_, this, emailOptions);
			return;
		},
		// returns SMTP options in the format expected by nodemailer
		mailerOptions: function(_) {
			var secure = this.secureConnection(_);
			var service = this.service(_);
			var options = service ? {
				service: service,
				authMethod: 'LOGIN', // FOR NOW - needs to be configured
			} : {
				name: this.clientHost(_),
				host: this.host(_),
				port: this.port(_) || (secure ? 465 : 25),
				secureConnection: secure,
			};
			var auth = options.auth = {};
			switch (this.authentication(_)) {
				case 'none':
					break;
				case 'password':
					auth.user = this.user(_);
					auth.pass = this.password(_);
					break;
			}
			return options;
		},
	},
};