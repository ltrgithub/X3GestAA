"use strict";
var locale = require("syracuse-core/lib/locale");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
exports.entity = {
	$withCache: true,
	$titleTemplate: "Applications",
	$descriptionTemplate: "Application and contract names identifies a service",
	$helpPage: "Administration-reference_Applications",
	$valueTemplate: "{description}",
	$createActionTitle: "New application",
	$listTitle: "List of applications",
	$allowFactory: true,
	$factoryExcludes: ["description", "endpoints", "defaultEndpoint"],
	$properties: {
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isLocalized: true,
			$isMandatory: true,
			$isUnique: true
		},
		protocol: {
			$title: "Type",
			$enum: [{
				$value: "syracuse",
				$title: "Syracuse"
			}, {
				$value: "x3",
				$title: "X3"
			}],
			$isMandatory: true,
			$default: "syracuse",
			$control: function(_, instance, val) {
				// can change only if there are no endpoints associated
				if (val && !instance.endpoints(_).isEmpty()) throw new Error(locale.format(module, "protocolChange", instance.code(_)));
			},
			$isDisabled: function(_, instance) {
				// can change only if there are no endpoints associated
				return !instance.endpoints(_).isEmpty();
			}
		},
		application: {
			$title: "Name",
			$isMandatory: true
		},
		contract: {
			$title: "Contract",
			$isMandatory: true
		}
	},
	$relations: {
		endpoints: {
			$title: "Endpoints",
			$type: "endPoints",
			$inv: "applicationRef",
			$capabilities: "sort,filter",
			$isDisabled: true,
			$isComputed: true,
		},
		defaultEndpoint: {
			$title: "Default endpoint",
			$type: "endPoint",
			$nullOnDelete: true,
			$lookup: function(_, instance) {
				var eps = [];
				instance.endpoints(_).toArray(_).forEach(function(ep) {
					eps.push("'" + ep.$uuid + "'");
				});
				return {
					$type: "application/json",
					$url: "/sdata/syracuse/collaboration/syracuse/endPoints?representation=endPoint.$lookup&binding=selectedEndpoint&count=50&where=($uuid in (" + eps.join(',') + "))"
				};
			}
		}
	},
	$searchIndex: {
		$fields: ["description", "application", "contract", "menuItems", "portlets", "endpoints"]
	},
	$uniqueConstraints: [
		["description"],
		["application", "contract"]
	]
};