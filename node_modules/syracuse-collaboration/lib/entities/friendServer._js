"use strict"

var streams = require('streamline/lib/streams/streams');
var fs = require("fs");
var fsp = require("path");
var https = require("https");

exports.entity = {
	$titleTemplate: "Collaboration friend server",
	$valueTemplate: "{description}",
	$properties: {
		description: {
			$title: "Description",
			$isMandatory: true,
			$linksToDetails: true
		},
		endpointUrl: {
			$title: "Collaboration endpoint url",
			$isMandatory: true
		}
	},
	$functions: {
		createWritableStream: function(_, service) {
			// open a session with trusted server and returns a http writable stream
			var certPath = fsp.join(__dirname, "../../../syracuse-import/lib/ssl");
			var opt = {
				agent: false,
//				key: fs.readFileSync(fsp.join(certPath, "import.key")),
//				cert: fs.readFileSync(fsp.join(certPath, "import.crt")),
				key: fs.readFileSync(fsp.join(__dirname, "../../../syracuse-main/lib/ssl", "guest.key")),
				cert: fs.readFileSync(fsp.join(__dirname, "../../../syracuse-main/lib/ssl", "guest.crt")),
				// use our server ca, should be the same
				ca: fs.readFileSync(fsp.join(__dirname, "../../../syracuse-main/lib/ssl", "ca.crt")),	
				//
				url: this.endpointUrl(_) + "/" + service,
				method: "PUT"
			}
//			opt.agent = new https.Agent(opt);
			return streams.httpRequest(opt);
		}
	}
}