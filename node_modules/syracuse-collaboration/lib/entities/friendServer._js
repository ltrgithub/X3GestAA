"use strict";

var streams = require('streamline/lib/streams/streams');
var fs = require('streamline-fs');
var fsp = require("path");
var https = require("https");

exports.entity = {
	$titleTemplate: "Collaboration friend server",
	$valueTemplate: "{description}",
	$properties: {
		description: {
			$title: "Description",
			$isMandatory: true,
			$linksToDetails: true
		},
		endpointUrl: {
			$title: "Collaboration endpoint url",
			$isMandatory: true
		}
	},
	$functions: {
		createWritableStream: function(_, options) {
			var service = options.service;
			var certPath = options.certificatesPath;
			var certName = options.certificateName;
			// open a session with trusted server and returns a http writable stream
			var opt = {
				agent: false,
				key: fs.readFileSync(fsp.join(certPath, certName + ".key")),
				cert: fs.readFileSync(fsp.join(certPath, certName + ".crt")),
				// use our server ca, should be the same
				ca: fs.readFileSync(fsp.join(__dirname, "../../../syracuse-main/lib/ssl", "ca.crt")),
				//
				url: this.endpointUrl(_) + "/" + service,
				method: options.method || "POST"
			}
			return streams.httpRequest(opt);
		}
	}
}