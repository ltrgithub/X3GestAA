"use strict"

var streams = require('streamline/lib/streams/streams');
var fs = require("fs");
var fsp = require("path");

exports.entity = {
	$titleTemplate: "Collaboration friend server",
	$valueTemplate: "{description}",
	$properties: {
		description: {
			$title: "Description",
			$isMandatory: true,
			$linksToDetails: true
		},
		endpointUrl: {
			$title: "Collaboration endpoint url",
			$isMandatory: true
		}
	},
	$functions: {
		createWritableStream: function(_, service) {
			// open a session with trusted server and returns a http writable stream
			var certPath = fsp.join(__dirname, "../../syracuse-import/lib/ssl");
			var opt = {
				secure: true,
				key: fs.readFileSync(fsp.join(certPath, "import.key")),
				cert: fs.readFileSync(fsp.join(certPath, "import.crt")),
				// use our server ca, should be the same
				ca: fs.readFileSync(fsp.join("../../syracuse-main/lib/ssl", "ca.crt")),		
				//
				url: this.endpointUrl(_) + "/$import",
				method: "PUT"
			}
			return streams.httpRequest(opt);
		}
	}
}