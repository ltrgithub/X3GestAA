"use strict";
var locale = require("syracuse-core/lib/locale");
var util = require('util');
var cert = require('./certificate');
var config = require('syracuse-main/lib/nodeconfig').config;

exports.entity = {
		$properties: {
			name: {
				$title: "Name",
				$isMandatory: true,
				$isUnique: true,
				$isReadOnly: function(_, instance) {
					return !instance.$created;
				},
				$pattern: /^[a-z_.]+$/
			},
			internal: {
				$title: "internal",
				$isReadOnly: true,
				$type: "boolean"				
			},
			certificate: {
				$title: "CA Certificate",
				$type: "binary",
				$storage: "db_file",
				$isMandatory: function(_, instance) {
					return instance.$created;
				}
			},
			subjectDn: {
				$title: "Distinguished name",
				$isReadOnly: true
			},
			issuerDn: {
				$title: "Issuer distinguished name",
				$isReadOnly: true
			},
			notBefore: {
				$title: "Valid from",
				$isReadOnly: true,
				$type: "datetime"
			},
			notAfter: {
				$title: "Valid until",
				$isReadOnly: true,
				$type: "datetime"
			},
			certificateHash: {
				$title: "Hash of certificate",
				$isReadOnly: true,
				$isHidden: true
			}
		},
		$titleTemplate: "Certificates of Certification Authorities",
		$valueTemplate: "{name}",
		$events: {
			$beforeSave: [function(_, instance) {
				cert.fillInstance(instance, true, _);
			}],
			$afterSave: [function(_, instance) { // update nanny processes unless special marker property has been set
				if (config.mockServer) {
					var options = { path: "/nannyCommand/notifyNannies/update", method: "PUT", hostname: "", port: 0};
					try {
						console.log(mock.simpleRequest(config.mockServer.mockClient, options, null, _));			
					} catch (e) {
						console.log("Error "+e);
					}
				}
			}]
		},
		$actions: {
			$save: function(_, instance) {
				var r = {};
				if (config.mockServer && instance.$snapshot && !instance.$created) r.$confirm = locale.format(module, "maybeRestart")
				return r;
			}
		},
		$searchIndex: {
			$fields: ["name"]
		},
		$functions: {
			$onDelete: function(_) {
				// delete contents in file system
				cert.deleteData(this, true, _);
			}
		},
		$defaultOrder: [["name", true]],
		$services: {
		}
}