"use strict";

var jsurl = require("jsurl");
var streams = require("streamline/lib/streams/streams");
var httpHelper = require("syracuse-sdata/lib/httpHelper");

function _deleteDocument(_, docUrl, headers) {
	var par = {
		url: docUrl,
		method: "DELETE",
		headers: headers
	};
	var resp = streams.httpRequest(par).end().response(_);
	try {
		var content = JSON.parse(resp.readAll(_));
		return {
			statusCode: resp.statusCode,
			$diagnoses: content && content.$diagnoses
		};
	} catch (e) {
		return {
			statusCode: 500,
			$diagnoses: [{
				$severity: "error",
				$message: e.message
			}]
		};
	}
}

var whatToExt = {
	"V6WORD": "doc",
	"V6EXCEL": "xls",
	"V7WORD": "docx"
}

var whatToMime = {
	"V6WORD": httpHelper.mediaTypes.doc,
	"V6EXCEL": httpHelper.mediaTypes.xls,
	"V7WORD": httpHelper.mediaTypes.docx
}

function _getMime(what) {
	if (!what) return "";
	return whatToMime[what] || "";
}

function _addParam(url, param) {
	if (url.indexOf("?") >= 0) return url + "&" + param;
	else return url + "?" + param;
}

exports.entity = {
	$titleTemplate: "Document",
	$descriptionTemplate: "{fileName}",
	$isPersistent: false,
	$canEdit: false,
	$canDelete: false,
	$capabilities: "",
	$properties: {
		content: {
			$title: " ",
			$type: "binary",
			$storage: "proxy",
			$url: function(_, instance) {
				return instance.documentUrl(_);
			}
		},
		documentUrl: {
			$isHidden: true
		},
		fileName: {
			$isHidden: true
		}
	},
	$functions: {
		$setParameters: function(_, context) {},
		$setId: function(_, context, id) {
			var self = this;
			var params = (context && context.parameters) || {};
			params.fileName = (id || "").split("~Â¨~").join("_") + "." + (whatToExt[params.what] || ""); // x3keys
			self.fileName(_, params.fileName);
			switch (params.what) {
				case "V6WORD":
				case "V6EXCEL":
					params.docUrl = _addParam(params.v6DocUrl, "buildevenlope=true");
					delete params.v6DocUrl;
					break;
				case "V7WORD":
					// find V7 document
					var d = self._db.fetchInstance(_, self._db.getEntity(_, "document"), {
						jsonWhere: {
							className: params.className,
							x3Keys: id,
							representationName: params.reprName
						}
					});
					params.docUrl = d && d.computeUrl();
					break;
			}
			var mime = _getMime(params.what);
			if (mime) params.docUrl = _addParam(params.docUrl, "mime=" + mime);
			params.docUrl = _addParam(params.docUrl, "filename="+params.fileName);
			self.documentUrl(_, params.docUrl);
			self._properties = params;
		}
	},
	$services: {
		deleteDocument: {
			$title: "Delete document",
			$method: "POST",
			$isMethod: true,
			$confirm: "The document will be deleted. Do you want to continue ?",
			$urlParameters: "documentUrl={documentUrl}",
			$execute: function(_, context) {
				var url = context.parameters && context.parameters.documentUrl;
				//
				return _deleteDocument(_, url, context.request.headers);
			}
		}
	}
};