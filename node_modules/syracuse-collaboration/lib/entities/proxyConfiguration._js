"use strict";

var http = require('http');
var httpClient = require('syracuse-httpclient/lib/httpClient');
var proxyAuthenticator = require('syracuse-httpclient/lib/proxyAuthenticator');
var os = require("os");

var defaultExcludes = [os.hostname(), "localhost"];
var interfaces = os.networkInterfaces();
for (var i in interfaces) {
	for (var j in interfaces[i]) {
		if (interfaces[i][j].family === "IPv4")
			defaultExcludes.push(interfaces[i][j].address);
	}
}

exports.entity = {
	$titleTemplate: "Proxy server configuration",
	$descriptionTemplate: "Configure proxy for HTTP clients",
	$valueTemplate: "{name}",
	$helpPage: "Administration-reference-proxy-configuration",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$linksToDetails: true,
			$isUnique: true
		},
		host: {
			$title: "Host",
			$isMandatory: true,
		},
		port: {
			$title: "Port",
			$isMandatory: true,
		},
		auth: {
			$title: "Authentication",
			$enum: [{
					$value: "none",
					$title: "None"
				}, {
					$value: "basic",
					$title: "Basic"
				},
				//				{
				//					$value: "digest",
				//					$title: "Digest"
				//				},
				{
					$value: "ntlm",
					$title: "NTLM"
				}
			],
			$default: "none"
		},
		user: {
			$title: "User",
			$isHidden: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth === "none";
			},
			$isMandatory: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth !== "none";
			}
		},
		password: {
			$title: "Password",
			$type: "password",
			$encrypt: true,
			$salt: "",
			$capabilities: "confirm",
			$isHidden: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth === "none";
			},
			$isMandatory: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth !== "none";
			}
		},
		domain: {
			$title: "Domain",
			$isHidden: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth !== "ntlm";
			},
			$isMandatory: function(_, instance) {
				var auth = instance.auth(_) || "";
				return auth === "ntlm";
			}
		}
	},
	$relations: {
		excludes: {
			$title: "Excludes",
			$type: "proxyConfigurationExcludes",
			$inv: "proxyConfiguration",
			isChild: true
		}
	},
	$functions: {
		toJSON: function(_) {
			var conf = {
				host: this.host(_),
				port: this.port(_)
			};
			var ex = this.excludes(_).toArray(_);
			conf.excludes = [
				os.hostname().toLowerCase(),
				"localhost",
				"127.0.0.1"
			];
			for (var i in ex) {
				conf.excludes.push(ex[i].host(_));
			}
			var auth = this.auth(_);
			if (auth !== "none") {
				conf.auth = auth;
				conf.user = this.user(_);
				conf.password = this.password(_);
				// TODO: Digest authentications
				if (auth === "ntlm") {
					conf.domain = this.domain(_);
					conf.proxyAuthenticator = proxyAuthenticator;
				}
			}

			return conf;
		},
	},
	$services: {
		test: {
			$method: "GET",
			$isMethod: true,
			$title: "Test connection",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || [];
				try {
					var proxy = instance.toJSON(_);
					proxy.force = true;
					var opt = {
						method: "GET",
						url: context.baseUrl,
						proxy: proxy,
						headers: {
							cookie: context.httpSession.cookie
						}
					};
					var request = httpClient.httpRequest(_, opt);
					var response = request.end().response(_);
					var statusCode = response.statusCode;

					var data = response.readAll(_);
					if (statusCode === 200) {
						instance.$diagnoses.push({
							$severity: "info",
							$message: "OK"
						});
					} else {
						instance.$diagnoses.push({
							$severity: "error",
							$message: statusCode + ": " + http.STATUS_CODES[statusCode] + "\n " + data
						});
					}

				} catch (e) {
					instance.$diagnoses.push({
						$severity: "error",
						$message: "" + e.message,
						$stackTrace: e.safeStack
					});
				}
			}
		},
	}
};