"use strict"

var Template = require("syracuse-core/lib/resource/resourceProxy").Template;
var fsp = require("path");
var fs = require("fs");

function _resolvePath(_, context, volume) {
	var path = volume.path(_).replace(/\\/g, "/");
	path = (new Template(path)).resolve({
		syracuse: "../../../..",
		user: (context.getUser(_) && context.getUser(_).login(_))
	});
	//
	return fsp.join(__dirname, path);
}

var _listSolverMap = {
	syracuse_file: function(_, context, entity, volume) {
		//
		var res = [];
//		var path = _resolvePath(_, context, volume);
		var path = volume.resolvePath(_);
		var fileList = fs.readdir(path, _);
		fileList.forEach_(_, function(_, file) {
			var inst = entity.factory.createInstance(_, null, volume._db);
			inst.fileId(_, file);
			inst.fileName(_, file);
			inst.volume(_, volume);
			inst.content(_)._store.fileName = fsp.join(path, file);
			res.push(inst);
		});
		return res;
	},
	syracuse_db_file: function(_, context, entity, volume) {
		return context.db.fetchInstances(_, context.db.model.getEntity("document"), context.parameters).map_(_, function(_, doc) {
			var inst = entity.factory.createInstance(_, null, volume._db);
			inst.fileId(_, doc.content(_).$uuid);
			inst.fileName(_, doc.fileName(_));
			inst.volume(_, volume);
			inst.content(_)._store.fileName = doc.content(_)._store.fileName;
			return inst;
		});
	}
}

exports.entity = {
	$titleTemplate: "Storage volume details",
	$isPersistent: false,
	$canEdit: false,
	$listTitle: "List of volume items",
	$key: "{volume.$uuid}~{fileId}",
	$properties: {
		fileId: {
			$isHidden: true
		},
		fileName: {
			$title: "File name",
			$linksToDetails: true
		},
		content: {
			$title: "Content",
			$type: "binary",
			$storage: function(_, instance) { return ((instance.volume(_) && instance.volume(_).storageType(_)) || "db_file"); }
		}
	},
	$relations: {
		volume: {
			$title: "Volume",
			$type: "storageVolume"
		}
	},
	$fetchInstances: function(_, context, parameters) {
		var self = this;
		//
		if(!context.parameters.volume) return [];
		//
		var volume = context.db.fetchInstance(_, context.db.model.getEntity("storageVolume"), context.parameters.volume);
		if(!volume) return [];
		//
		var solver = _listSolverMap["syracuse_" + volume.storageType(_)];
		return (solver && solver(_, context, self, volume)) || [];
	},
	$functions: {
		$setId: function(_, context, id) {
			var ids = id.split("~");
			var volumeId = ids.shift();
			var fileId = ids.join("~");
			//
			this.volume(_, this.createChild(_, "volume", volumeId));
			this.fileId(_, fileId);
			this.content(_).init(_, this.volume(_).resolvePath(_, fileId));
			this.fileName(_, this.content(_).getProperties(_).fileName);
			//
		}
	},
	$defaultOrder: [["fileName", true]]
}