"use strict";

var sys = require("util");
var lic = require("syracuse-license")
var l = lic.load("license")
var check = require('syracuse-license/lib/check')
var fs = require('fs');

exports.entity = {
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		path: {
			$title: "Path",
			$default: "license.json"
			}
	},
	$titleTemplate: "License",
    $valueTemplate: "License",
    $descriptionTemplate: "License",
    $functions: {
    },
	$services: {
	    $loadLicense: {
			$method: "PUT",
			$isMethod: true,
			$title: "Load license",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(instance.path(_))) {
					instance.$diagnoses.push({severity: "error", message: "License file does not exist"})
					return;
				}
				var content = fs.readFile(instance.path(_), _).toString("utf8");
				if (!l.license("", content))
					instance.$diagnoses.push({severity: "error", message: "Incorrect license file"})
				else {
					
					try {
						check.licenseChange("", content, context.request.session, _);
						instance.$diagnoses.push({severity: "info", message: "OK"})
					} catch (e) {
						instance.$diagnoses.push({severity: "error", message: ""+e})						
					}
				}
			}
		}
	}
};
