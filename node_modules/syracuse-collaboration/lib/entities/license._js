"use strict";

var sys = require("util");
var check = require('syracuse-license/lib/check');
var fs = require('streamline-fs');
var locale = require("syracuse-core/lib/locale");

exports.entity = {
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$canDelete: false,
	$canSave: false,
	$properties: {
		path: {
			$title: "Path",
			$default: "license.json"
		},
		content: {
			$title: "Content"
		}

	},
	$titleTemplate: "License",
	$valueTemplate: "License",
	$descriptionTemplate: "License",
	$helpPage: "Administration-reference-License-data",
	$functions: {},
	$services: {
		testFunction: {
			$method: "PUT",
			$isMethod: true,
			$title: "Test function",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				// var attr = getLdapAttributes(instance, _);
				// console.log(util.format(attr));
				console.log("Test1");
				check.pS(_, "hugo", "get", "/licensetest", null);
				console.log("Nach test");
				/*
				var lic = require('syracuse-license').load('license')
				if (lic) {
					lic.register();
					instance.$diagnoses.push({severity: "info", message: locale.format(module, "OK")});
				}
				else instance.$diagnoses.push({severity: "error", message: "No license module found"}); 
				*/
				instance.$diagnoses.push({
					severity: "info",
					message: locale.format(module, "OK")
				});
			}
		},
		$loadLicense: {
			$method: "PUT",
			$isMethod: true,
			$title: "Load license",
			$execute: function(_, context, instance) {
				console.log("LOAD LICENSE");
				instance.$diagnoses = instance.$diagnoses || {};
				var content = instance.content(_);
				if (!content) {
					if (!fs.existsSync(instance.path(_))) {
						instance.$diagnoses.push({
							severity: "error",
							message: locale.format(module, "noLicense")
						});
						return;
					}
					content = fs.readFile(instance.path(_), _).toString("utf8");
				} else {
					content = content.trim();
				}
				try {
					check.licenseChange(content, context.request.session, instance.$diagnoses, _);
					if (instance.$diagnoses.length === 0) instance.$diagnoses.push({
						severity: "info",
						message: locale.format(module, "OK")
					});
				} catch (e) {
					console.log(e.stack);
					instance.$diagnoses.push({
						severity: "error",
						message: "" + e
					});
				}
			}
		}
	}
};