"use strict"

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var AuthoringHelper = require("./authoringHelpers").AuthoringHelper;

var tracer = console.log;
var tracer = null;

// TODO: inherit
exports.entity = {
	$isPersistent: false,
	$properties: {
		content: {
			$title: "Content",
			$type: "json"
		},
		$authorUrl: {
			$title: "Authoring url",
			$isHidden: true
		}
	},
	$functions: {
		$setId: function(_, context, id) {
			
		},
		$setParameters: function(_, context) {
			AuthoringHelper.prototype.$setParameters.call(this, _, context);
		},
		$save: function(_, saveRes, parameters) {
			AuthoringHelper.prototype.$save.call(this, _, saveRes, parameters);
		},
		getVariant: function(_, saveAsOption) {
			return AuthoringHelper.prototype.getVariant.call(this, _, saveAsOption);
		},
		createPageDef: function(_, pageContext) {
			var pageEntity = this.getPageEntity();
			//
			var pageDef = pageEntity.factory.createInstance(_, null, this._db);
			// pageContext is application.contract.representation.facet[.variant]
			var parts = pageContext.split(".");
			pageDef.facet(_, parts[3]);
			pageDef.application(_, adminHelper.getApplication(_, parts[0], parts[1]));
			pageDef.representation(_, parts[2]);
			pageDef.title(_, pageContext);
			return pageDef;
		},
		getPageEntity: function() {
			return this._db.model.getEntity("pageDef");
		},
		makeAuthorUrl: function(_, variant) {
			return [this._baseUrl, "pageAuths('" + variant.$uuid + "')/$workingCopies?representation=pageAuth.$edit"].join("/");
		}
	},
	$actions: {
		$save: function(_, instance) {
			return {
				$parameters: {
					$url: "{$baseUrl}/authoringSaveParams/$template/$workingCopies?representation=authoringSaveParam.$edit&role={$role}"+(instance._pageId ? "&variantId=" + instance._pageId : ""),
					$method: "POST",
					$properties: {
						parameters: {
							$type: "application/x-string"
						}
					}
				}
			}
		}
	}
}