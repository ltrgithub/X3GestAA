"use strict"

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

var tracer = console.log;
var tracer = null;

exports.entity = {
	$isPersistent: false,
	$properties: {
		content: {
			$title: "Content",
			$type: "json"
		}
	},
	$functions: {
		$setId: function(_, context, id) {
			
		},
		$setParameters: function(_, context) {
			this._initialize(_, context);
			//
			this._pageId = context.instanceId;
			this._pageContext = context.parameters && context.parameters.pageContext;
		},
		$save: function(_, saveRes, parameters) {
			function _setRel(_, variant, relName) {
				var r = variant[relName](_);
				r.reset(_);
				(parameters[relName] || []).forEach_(_, function(_, itId) {
					r.setUuid(_, itId);
				});
			}
			var pageData;
			var pageDef;
			var variant;
			var pageEntity;
			//
			pageEntity = this._db.model.getEntity("pageDef");
			//
			if(this._pageId) {
				variant = this.getVariant(_, parameters && parameters.saveAsOption);
				pageDef = variant && variant._parent;
			} else {
				if(this._pageContext) {
					pageDef = pageEntity.factory.createInstance(_, null, this._db);
					// pageContext is application.contract.representation.facet[.variant]
					var parts = this._pageContext.split(".");
					pageDef.facet(_, parts[3]);
					pageDef.application(_, adminHelper.getApplication(_, parts[0], parts[1]));
					pageDef.representation(_, parts[2]);
					pageDef.title(_, this._pageContext);
					// create a variant
					variant = pageDef.variants(_).add(_);
				} else
					return;
			}
			// apply params
			if(parameters) {
				variant.code(_, parameters.variantCode);
				variant.title(_, parameters.variantTitle);
				variant.description(_, parameters.variantDescription);
				variant.isFactory(_, parameters.isFactory);
				//
				if(!variant.isFactory(_)) {
					_setRel(_, variant, "roles");
					_setRel(_, variant, "users");
					_setRel(_, variant, "endpoints");
				} else {
					variant.roles(_).reset(_);
					variant.users(_).reset(_);
					variant.endpoints(_).reset(_);
				}
			}
			//
			pageData = variant.pageData(_);
			if(!pageData) {
				// create
				pageData = variant.createChild(_, "pageData");
				variant.pageData(_, pageData);
			}
			pageData.content(_, JSON.stringify(this.content(_)));
			pageDef.addRelatedInstance(pageData);
			//
			pageDef.save(_);
		},
		getVariant: function(_, saveAsOption) {
			var pageDef;
			var variant;
			var pageEntity;
			//
			if(this._pageId) {
				pageEntity = this._db.model.getEntity("pageDef");
				var where = {};
				where["variants"] = this._pageId;
				pageDef = this._db.fetchInstance(_, pageEntity, {
					jsonWhere: where
				});
				if(!pageDef) return null;
				//
				switch(saveAsOption) {
				case "personal_copy":
				case "shared_copy":
					return pageDef.variants(_).add(_);
				default:
					//
					return pageDef.variants(_).get(_, this._pageId);
				}
			}
			return null;
		}
	},
	$actions: {
		$save: function(_, instance) {
			return {
				$parameters: {
					$url: "{$baseUrl}/authoringSaveParams/$template/$workingCopies?representation=authoringSaveParam.$edit&role={$role}"+(instance._pageId ? "&variantId=" + instance._pageId : ""),
					$method: "POST",
					$properties: {
						parameters: {
							$type: "application/x-string"
						}
					}
				}
			}
		}
	}
}