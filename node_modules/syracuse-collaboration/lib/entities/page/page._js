"use strict";

var fs = require('fs');
var fsp = require('path');
var sdataRegistry = require("syracuse-sdata/lib/sdataRegistry");
var dataModel = require("syracuse-orm/lib/dataModel")
var helpers = require("syracuse-core/lib/helpers");
var pluralize = helpers.string.pluralize;
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var locale = require("syracuse-core/lib/locale");

function _exists(callback, fname) {
	(fs.exists || fspath.exists)(fname, function(result) {
		callback(null, result);
	})
}

function _getPath(presentation) {
	var path = presentation.split(",");
	path = path[0].split(".");
	// temp page hack
	if (path[4] === "$dashboard") {
		path = "syracuse-main/html/default/" + path[3] + "-" + path.pop() + ".json";
	} else
		if (path[0] === "syracuse" && path[1] === "content") {
			var type = path.pop();
			path = path.slice(2);
			path = "syracuse-main/html/" + path.join("/") + "-" + type + ".json";
		} else {
			path[2] = "uiviews"; //replace dataset.
			path.splice(1, 0, "lib"); // insert lib
			//		path = path.join("/") + "-" + type + ".json";
			path = path.slice(0, 4).join("/") + "/" + path.slice(4).join("-") + ".json";
		}
		var x = fsp.join(__dirname, "../../../..") + "/" + path;
		//console.log(x);
	return x;
}

function _getUrlPrototype(baseUrl, mediaType, x3fusion) {
	//Il faudra trouver un moyen d'associer un media type avec une url de serveur.
	//Pour l'instant, pointe sur le serveur syracuse
	var url = baseUrl.split("/");
	url = url[0] + "//" + url[2] + "/" + (x3fusion?"trans":url[3]) + "/";
//	url = url[0] + "//" + url[2] + "/" + (x3fusion?"x3":url[3]) + "/";
	mediaType = mediaType.split(".");
	url += mediaType.slice(0, 3).join("/");
	url += "/$prototypes('";
	url += mediaType.slice(3, 5).join(".").split(',')[0];
	url += "')";

	return url;
}

function _getCurrentConfig(_, context) {
	// TODO : optimize - use a cache for currentConfig
	var config = require("syracuse-main/lib/nodeconfig").config; // do not put this require in header as would be circular reference
	var currentConfig;
	if (config && config.currentConfigVersion) var currentConfig = context.db.fetchInstance(_, context.model.getEntity("configuration"), {
		jsonWhere: {
			version: config.currentConfigVersion
		}
	});
	if (!currentConfig)
	// get the biggest config enabled
	var currentConfig = context.db.fetchInstance(_, context.model.getEntity("configuration"), {
		jsonWhere: {
			enable: true
		},
		orderBy: [{
			binding: "version",
			descending: true
		}],
		count: 1
	});
	//
	return currentConfig;
}

function _getAllConfigFilter(_, context) {
	var crtConfig = _getCurrentConfig(_, context);
	//
	var parents = crtConfig && crtConfig.allParents(_).toUuidArray(_);
	// add crtConfig
	parents && parents.push(crtConfig.$uuid);
	// add "none"
	parents && parents.push(null);
	//
	return (parents && {
		$in: parents
	}) || null;
}

exports.entity = {
	$isPersistent: false,
	$events: {},
	$functions: {
		$setId: function(_, context, id) {
			// find page; id respects variables defined in main.js
			var path = id.split(",");
			var variantId = path[1];
			if(variantId === "{variant}") variantId= null;
			var x3fusion = (path[1] === "trans");
			var role = context.getSelectedRoleId(_);
			path = path[0].split(".");
			var facet = path[4];
			var reprName = path[3];
			// pageContext is application.contract.representation.facet[.variant]
			var pageContext = path.slice(0);
			// remove dataset segment
			pageContext.splice(2, 1);
			// find the application
			var app = adminHelper.getApplication(_, path[0], path[1]);
			var page = null;
			var pageData = null;
			var variants = null;
			// new algorithm !!!!!!!!!!
			if(facet === "$dashboard") {
				// look for dashboard by representation
				var dashEntity = context.model.getEntity("dashboardDef");
				var dashboard = context.db.fetchInstance(_, dashEntity, {
					jsonWhere: {
						dashboardName: reprName
					}
				});
				variants = dashboard && dashboard.selectAllVariants(_, context.getUserProfile(_), app, variantId);
				pageData = variants && variants[0];
				page = (pageData && pageData.pageData(_) && pageData.pageData(_).content(_)) || {};
				page.$authorUrl = context.baseUrl + "/dashboardAuths" +
						((pageData && pageData.$uuid) ? "('" + (pageData && pageData.$uuid) + "')" : "/$template") + 
						"/$workingCopies?representation=dashboardAuth.$edit" +
						((pageData && pageData.$uuid) ? "" : "&pageContext="+pageContext.join("."));
			} else {
				var pageEntity = context.model.getEntity("pageDef");
				var pageDef = context.db.fetchInstance(_, pageEntity, {
					jsonWhere: {
						representation: reprName,
						facet: facet,
						application: app && app.$uuid
					}
				});
				var pageData = pageDef && pageDef.selectVariant(_, context.getUserProfile(_), context.getSelectedRoleId(_));
				page = (pageData && pageData.pageData(_) && pageData.pageData(_).content(_)) || {};
				page.$authorUrl = context.baseUrl + "/pageAuths" +
					((pageData && pageData.$uuid) ? "('" + (pageData && pageData.$uuid) + "')" : "/$template") + 
					"/$workingCopies?representation=pageAuth.$edit" +
					((pageData && pageData.$uuid) ? "" : "&pageContext="+pageContext.join("."));
			}
			//
			var fromFile = false;
			if (!pageData) {
				var p = _getPath(id);
				if(_exists(_, p))
					try {
						var data = fs.readFile(p, "utf8", _);
						var c = JSON.parse(data);
						page = c;
						page.$authorUrl = context.baseUrl + "/" + (facet === "$dashboard" ? "dashboardAuths" : "pageAuths") +
							"/$template/$workingCopies?representation=" + (facet === "$dashboard" ? "dashboardAuth" : "pageAuth") + 
							".$edit&pageContext="+pageContext.join(".");
						fromFile = true;
					} catch (e) {
					}
			} 

			page.$url = page.$url || id;
			//
			if((facet === "$dashboard") && !fromFile) {
				if(pageData) {
					page.$prototype = pageData.getPrototype(_, context.getUserProfile(_));
					if(Object.keys(page.$prototype.$properties).length === 0) {
						page.$prototype.$properties = {
								thisPage: {
									$title: "Dashboards",
									$type: "application/x-portlet",
					                $format: "$menu",
									$links: {
										$create: {
											$title: locale.format(module, "editDashboardLabel", path[3]),
											$url: context.baseUrl + "/dashboardDefs('" + pageData._parent.$uuid + "')/$workingCopies?representation=dashboardDef.$edit",
											$method: "POST"
										},
										legacy: {
											$title: "Samples/SOS dashboard",
											$url: "?representation=samples.$dashboard"
										}
									},
									$properties:{}
								}
							}
					}
					// add alternate variants links
					if(variants && (variants.length > 1)) {
						var l = page.$prototype.$links = (page.$prototype.$links || {});
						variants.forEach_(_, function(_, v) {
							// ignore selected variant
							if(v.$uuid === pageData.$uuid) return;
							//
							l[v.$uuid] = l[v.$uuid] || {
								$title: v.title(_) || v.$uuid,
								$url: "?representation=" + pageData._parent.dashboardName(_) + ".$dashboard&variant=" + v.$uuid
							}
						});						
					};
				} else {
					// make a vignette allowing the creation of this dashboard
					page.$prototype = {
						$title: locale.format(module, "dashboardNotFoundTitle", path[3]), 
						$properties: {
							thisPage: {
								$title: "Dashboards",
								$type: "application/x-portlet",
				                $format: "$menu",
								$links: {
									$create: {
										$title: locale.format(module, "createDashboardLabel", path[3]),
										$url: context.baseUrl + "/dashboardDefs/$template/$workingCopies?representation=dashboardDef.$edit",
										$method: "POST"
									},
									legacy: {
										$title: "Samples/SOS dashboard",
										$url: "?representation=samples.$dashboard"
									}
								},
								$properties:{}
							}
						}
					}
				}
				// TODO: for now we remove the article from the response as new vignettes do not apear. Remove next line after proper 
				// management of dashboards authoring client side.
//				page.$article = null;
			}
			var protoIds = (id.split(",")[0] || "").split(".");
			page.$prototype = page.$prototype || (!x3fusion && context.getPrototypeResource(_, protoIds.slice(3,5).join("."), (pageData == null), protoIds[0], protoIds[1], protoIds[2])) || _getUrlPrototype(context.baseUrl, context.instanceId, x3fusion);
			//
			if (typeof page.$prototype === "object") {
				var ep = context.httpSession["userProfile"] && context.httpSession["userProfile"].selectedEndpoint(_);
				if (ep) page.$prototype.$baseUrl = "/sdata/" + ep.application(_) + "/" + ep.contract(_) + "/" + ep.dataset(_);
			}
			//
			this.$resource = page || {};
			this.$resource.$uuid = helpers.uuid.generate();
			this.$resource.$key = this.$resource.$uuid;
		},
		$serialize: function(_) {
			return this.$resource;
		},
		$save: function(_) {

		}
	}
};
