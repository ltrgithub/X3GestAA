"use strict"

exports.entity = {
	$isPersistent: false,
	$titleTemplate: "Fusion similar vignettes",
	$properties: {
		explorer: {
			$title: "Explorer",
			$type: "graph",
			$includeSelf: false,
			$format: "d3.nodeChart",
			$relations: {
				vignettes: {
					items: {}
				}
			}
		}
	},
	$relations: {
		vignette: {
			$title: "Original vignette",
			$type: "portlet"
		},
		vignettes: {
			$title: "Selected vignettes",
			$type: "portlets"
		}
	},
	$functions: {
		$setParameters: function(_, context) {
			var self = this;
			if (context.parameters && context.parameters.vignette) {
				self.vignette(_, self._db.fetchInstance(_, self._db.getEntity(_, "portlet"), context.parameters.vignette));
				self.fetchVignettes(_);
			}
		},
		fetchVignettes: function(_) {
			var self = this;
			if (!self.vignette(_)) return;
			//
			self._db.fetchInstances(_, self._db.getEntity(_, "portlet"), {
				jsonWhere: {
					description: self.vignette(_).description(_)
				}
			}).forEach_(_, function(_, vv) {
				self.vignettes(_).set(_, vv);
			});
		}
	}
}