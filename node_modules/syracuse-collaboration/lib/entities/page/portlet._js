"use strict";

var locale = require("syracuse-core/lib/locale");
var helpers = require('syracuse-core/lib/helpers');
var forEachKey = helpers.object.forEachKey;
var globals = require('streamline/lib/globals');


var _contentSolverMap = {
	$menu: function(_, portlet, endpoint, options) {
		var links = {};
		var hasLinks = false;
		var items = portlet.items(_).toArray(_);
		items.forEach_(_, function(_, item) {
			if(item.application(_) && (endpoint.applicationRef(_).$uuid !== item.application(_).$uuid)) {
				if(options && (options.itemIgnoredCount != null))
					options.itemIgnoredCount++;
				return;
			}
			//
			var itemKey = item.code(_) || item.$uuid;
			var link = links[itemKey] = item.getLink(_, endpoint);
			link.$vignette = portlet.code(_) || portlet.$uuid;
/*			if(!item.application(_)) {
				// add it just once
				if(!links[itemKey])
					links[itemKey] = item.getLink(_, endpoint);
			} else {
				var link = links[itemKey] = item.getLink(_, endpoint);
			}*/
			hasLinks = true;
		});
		//
		return hasLinks ? {
				$format: "$menu",
				$links: links,
				//$article: portlet.article(_)
			} : null;
	},
	$page: function(_, portlet, endpoint) {
		if(endpoint && portlet.pageItem(_)) {
			return {
				$location: portlet.pageItem(_).getLink(_, endpoint)
			}
		}
		return null;
	}
}


function _addReflookup(ci, proto, list, added) {
	var rep = "representation=";
	ci = ci.$item || ci;
	if (ci && ci.$links && ci.$links.$lookup) {
		var ir = ci.$links.$lookup.$url.indexOf(rep);
		if (ir >= 0) {
			var representation=ci.$links.$lookup.$url.substring(ir+rep.length);
			ir = representation.indexOf("&");
			if (ir>0) representation = representation.substring(0, ir);
			representation = representation && representation.replace(/\{(.*?)\}/g, function(match, prop) {
				var value = proto[prop];
				return value || "";
			});
			if ((list.indexOf(representation) < 0) && (added.indexOf(representation) < 0))
				list.push(representation);
			
		}
		
	}

}
function _scanPageForRepresentations(facet, page, list, added) {
	//don't scan lookup facet
	if (facet === "$lookup") return;
	// add links and lookups
	var prototypes = [];
	if (!page.$prototype || (typeof page.$prototype != "object")) return;
	prototypes.push({proto: page.$prototype});
	if (page.$prototype.$properties.$resources) 
		prototypes.push({proto: page.$prototype.$properties.$resources.$item});
	var rep = "representation=";
	prototypes.forEach(function(protodata){
		//add links 
		var proto= protodata.proto;
		if (proto.$links) {
			forEachKey(proto.$links, function(linkName, link) {
				if (link.$isHidden) return;
				var ir = link.$url.indexOf(rep);
				if (ir >= 0) {
					var representation=link.$url.substring(ir+rep.length);
					ir = representation.indexOf("&");
					if (ir>0) representation = representation.substring(0, ir);
					representation = representation && representation.replace(/\{(.*?)\}/g, function(match, prop) {
						var value = proto[prop];
						return value || "";
					});
					if ((list.indexOf(representation) < 0) && (added.indexOf(representation) < 0))
						list.push(representation);
				}
			});
		}
		
	});
	if ((facet === "$edit") || (facet === "$create")) {
		//scan for lookups
		var cl = [{proto: page.$prototype}];
		while (cl.length) {
			var cp = cl.shift();
			forEachKey(cp.proto.$properties, function(propName, propValue) {
				var ci;
				switch (propValue.$type) {
					case "application/x-array":
						if (propValue.$item.$type === "application/x-reference") {
							ci = propValue.$item;
							_addReflookup(ci, propValue.$item, list, added);
						} else
							cl.push({proto: propValue.$item});
						break;
					case "application/x-reference": 
						ci = propValue;
						_addReflookup(ci, cp.proto, list, added);
						break;
					case "applcation/x-object": 
						break;
					case "application/json": 
						break;
					default:
						break;
				}
			});
		}
	}
};


exports.entity = {
	$titleTemplate: "Vignette",
	$descriptionTemplate: "{description}",
	$valueTemplate: "{title}",
	$listTitle: "List of vignettes",
	$properties: {
		code: {
			$title: "Code"
		},
		title: {
			$title: "Title",
			$isMandatory: true,
			$linksToDetails: true,
			$isLocalized: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		},
		type: {
			$title: "Type",
			$enum: [{
				$value: "$menu",
				$title: "Menu"
			},{
				$value: "$page",
				$title: "Page"
			},],
			$isMandatory: true,
			$default: "$menu"
		}
	},
	$relations: {
		application: {
			$title: "Application",
			$type: "application",
			$inv: "portlets",
			$propagate: function(_, instance, val) {
/*				var appUuid = val && val.$uuid;
				if(instance.endpoint(_) && (instance.endpoint(_).applicationRef(_).$uuid !== appUuid))
					instance.endpoint(_, null);
				instance.items(_).toArray(_).forEach_(_, function(_, item) {
					if(item.application(_) && (item.application(_).$uuid !== appUuid))
						instance.items(_).deleteInstance(_, item.$uuid);
				});
				if(instance.pageItem(_) && instance.pageItem(_).application(_) && (instance.pageItem(_).application(_).$uuid !== appUuid))
					instance.pageItem(_, null);
					*/
			}
		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$lookupFilter: {
				applicationRef: "{application}"
			}
		},
		items: {
			$title: "Items",
			$type: "menuItems",
			$inv: "menus",
			$nullOnDelete: true,
			$capabilities: "append,delete,insert,filter,reorder",
			$lookupFilter: {
				application: "{application}",
				endpoint: "{endpoint}"
			},
			$isDefined: function(_, instance) {
				return (instance.type(_) === "$menu");
			}
		},
		pageItem: {
			$title: "Page content",
			$type: "menuItem",
			$lookupFilter: {
				application: "{application}",
				endpoint: "{endpoint}"
			},
			$isDefined: function(_, instance) {
				return (instance.type(_) === "$page");
			}
		},
		categories: {
			$title: "Categories",
			$type: "menuCategories"
		}
	},
	$services: {
		representation : {
			// get mobile application structure (list of representations used by this portlet)
			$method : "POST",
			$isHidden : true,
			$isMethod : true,
			$title : "Mobile Application Structure",
			$execute : function(_, context, instance) {
				
				if (!instance) context.reply(_, 404, locale.format(module, "noInstance"));
				var params = JSON.parse(context.request.readAll(_));
				var key = instance.computeKey();
				var res = {
					home: instance.computeKey(), // home dashboard 
					entities: {},                // list of entities used by this application
					representations: [],         // list of representations used by this application
					pages: {},     				 // pages used by this mobile application
					dashboards: {}, 			 // dashboards used by this mobile application
					footer: []					 // footer items
				};
				// add default page home 
				res.dashboards[key] = []; 
				instance.getMobileStruct(_, context, params, res);
				var pageEntity = context.model.getEntity("page");
				var list = res.representations;
				delete res.representations;
				res.pages = {};
				while (list.length) {
					var cl = [];
					list.forEach_(_, function(_, representation) {
						if (!res.pages[representation]) {
							var rep = representation.split(".");
							var opts = {
								application: params.applicationName, 
								contract: params.contractName,
								endpoint: params.endpointName,
								representation: rep[0],
								facet: rep[1],
								device: (context && context.query && context.query.device)?context.query.device:"desktop",
								protoInPage: true
							}
							res.pages[representation] = pageEntity.pageContent(_, context, opts);
							_scanPageForRepresentations(opts.facet, res.pages[representation], cl, list);
						}
					});
					list = cl;
      			}
				res.entities = {};
				Object.keys(res.pages).forEach(function(page) {
					var o = res.pages[page];
					if (o.$prototype &&  o.$prototype.$url) {
						var i = page.indexOf(".");
						if (i > 0) {
							var rep = page.substr(0,i);
							if (!res.entities[rep]) {
								var pn = o.$prototype.$pluralType;
								if (!pn) {
									i=o.$prototype.$url.lastIndexOf("/");
									pn = o.$prototype.$url.substring(i+1);
									i= pn.indexOf("(");
									if (i>0) pn = pn.substr(0, i);
									i= pn.indexOf("?");
									if (i>0) pn = pn.substr(0, i);
								}
								var ce = {sync: false, cache:false, pluralType: pn};
								res.entities[rep] = ce;
							}
						}
					}

					
					
				});				
				delete res.representations;
				if (!res.entities || Object.keys(res.entities).length == 0 || !res.pages || Object.keys(res.pages).length ==0){
					context.reply(_, 404, locale.format(module, "noRepresentation", instance.title(_), params.endpointName));					
				}else{
					context.reply(_, 200, res);					
				}
			}
		}	
	},
	$functions: {
		$onDelete: function(_) {
			// fetch dashboards
			var self = this;
			var db = self._db;
			var dList = db.fetchInstances(_, db.getEntity(_, "dashboardDef"), {
				jsonWhere: {
					"variants.vignettes.portlet": self.$uuid
				}
			});
			// delete vignette from variant
			dList.forEach_(_, function(_, d) {
				d.variants(_).toArray(_, true).forEach_(_, function(_, vr) {
					var vigns = vr.vignettes(_);
					vigns.toArray(_, true).forEach_(_, function(_, v) {
						if(v.portlet(_) && (v.portlet(_).$uuid === self.$uuid)) {
							vigns.deleteInstance(_, v.$uuid);
							self.addRelatedInstance(d);
						}
					});
				});
			});
		},
		getContent: function(_, endpoints, options) {
			var p = _contentSolverMap[this.type(_)] && _contentSolverMap[this.type(_)](_, this, endpoints, options);
			if(p) {
				p.$type = "application/x-vignette";
				p.$title = this.title(_);
				p.$description = this.description(_);
				p.$properties = {};	
			}
			//
			return p;
		},
		getMobileStruct: function(_, context, params, res) {
			var instance = this;
			if (instance.type(_) === "$menu") {
				var key = instance.computeKey();
				var items = instance.items(_).toArray(_);
				items.forEach_(_, function(_, item) {
					if (item.linkType(_) === "$representation") {
						var app = item.applicationName(_),
							contract = item.contractName(_),
							endpoint = item.endpointName(_);
						if ((!app || (app == params.applicationName)) && 
							(!contract || (contract == params.contractName)) && 
							(!endpoint || (endpoint == params.endpointName))) {
							var data = {};
							data.title = item.title(_); 
							data.description = item.description(_); 
							data.icon = item.icon(_); 
							data.linkType = "$representation";
							data.entity = item.entity(_);
							data.representation = item.representation(_);
							data.facet  = item.facet(_);
							data.params = item.getItemParams(_);
							res.dashboards[key] = res.dashboards[key] || [];
							if (!res.entities[data.entity]) {
								res.entities[data.entity] = {cache: false, sync: false};
							}
							var entity = res.entities[data.entity];
							
							if (!res.pages[data.representation + "."+ data.facet]) {
								res.representations.push(data.representation + "."+ data.facet);
								res.pages[data.representation + "."+ data.facet] = true;
							}
							if (item.applicationMenu(_)) 
								res.footer.push(data); 
							else
								res.dashboards[key].push(data);
						}		
					} else if (item.linkType(_) === "$dashboard") {
						var dn = item.dashboard(_);
						if (dn) {
							var dashboardEntity = context.model.getEntity("dashboardDef");
							var dashboard = context.db.fetchInstance(_, dashboardEntity, {
								jsonWhere: {
									dashboardName: dn
								}
							});
							var variants = dashboard.variants(_).toArray(_);
							variants.forEach_(_, function(_, variant) {
								if (!variant.allApplications(_)) {
									var ca = variant.application(_);
									if (ca.application(_) = params.applicationName) {
										var vignettes = variant.vignettes(_).toArray(_);
										vignettes.forEach_(_, function(_, vignette) {	
											var portlet = vignette.portlet(_);
											if (portlet.type(_) === "$menu") {
												var nk = portlet.computeKey();
												if (!res.dashboards[nk]) { 
													res.dashboards[key] = res.dashboards[key] || [];
													portlet.getMobileStruct(_, context, params, res); 
													if (res.dashboards[nk]) {
														var cd = {linkType:  "$dashboard"};
														cd.title = item.title(_); 
														cd.description = item.description(_); 
														cd.icon = item.icon(_); 
														cd.facet="$dashboard";
														cd.dashboard = nk;
														res.dashboards[key].push(cd);
													}
												}
											}
											
										});	
									}
									
								}
							})
						}
					}
				});
			}
			return res;
		}
	},
	$searchIndex: {
		$fields: ["code", "title", "description", "application", "endpoint", "type", "items", "pageItem", "categories"]
	},
	$defaultOrder: [["title", true]]
}