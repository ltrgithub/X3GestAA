"use strict"

exports.entity = {
	$properties: {
		description: {
			$title: "Description",
			$isLocalized: true
		},
		allApplications: {
			$title: "Applies to all applications",
			$type: "boolean",
			$constraints: {
				$isNullable: true
			},
			$propagate: function(_, instance, val) {
				if(val) instance.application(_, null);
			}
		}
	},
	$relations: {
		roles: {
			$title: "Applies to roles",
			$type: "roles",
		},
		users: {
			$title: "Applies to users",
			$type: "users",
		},
		vignettes: {
			$title: "Vignettes",
			$type: "dashboardVignettes",
			isChild: true,
			$select: {
				$title: "Vignettes",
				$type: "portlet",
				$fieldMap: { portlet: "$uuid" }
			}
		},
		application: {
			$title: "Application",
			$type: "application",
			$inv: "pages",
			$isMandatory: function(_, instance) {
				return !instance.allApplications(_);
			},
			$isDefined: function(_, instance) {
				return !instance.allApplications(_);
			},
			$propagate: function(_, instance, val) {
				val && instance.portlets(_).toArray(_).forEach_(_, function(_, pagePortlet) {
					if(pagePortlet.endpoint(_) && (pagePortlet.endpoint(_).applicationRef(_).$uuid !== val.$uuid))
						instance.portlets(_).deleteInstance(_, pagePortlet.$uuid);
				});
			}
		},
		endpoints: {
			$title: "Applies to endpoints",
			$type: "endPoints"
		}
	}
}