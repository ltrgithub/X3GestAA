"use strict";

exports.entity = {
	$isPersistent: false,
	$properties: {
		content: {
			$title: "Content",
			$type: "json"
		}
	},
	$functions: {
		getLayout: function(_, id, withCreate) {
			var self = this;
			var db = self._db;
			//
			var ids = id.split(",");
			var pIds = ids[0].split(".");
			var pageVariant = pIds[0];
			var pageId = pIds[1];
			//
			var bIds = (ids[1] && ids[1].split(".")) || [];
			var bindVariant = bIds[0];
			var bindId = bIds[1];
			//
			var layoutEnt = db.getEntity(_, "pageLayout");
			var layout = db.fetchInstance(_, layoutEnt, {
				page: pageId,
				binding: bindId
			});
			if (!layout && withCreate) {
				var pageEnt = layoutEnt.$relations.page.getTargetEntity(pageVariant);
				var page = db.fetchInstance(_, pageEnt, pageId);
				var bindEnt = layoutEnt.$relations.page.getTargetEntity(bindVariant);
				var bind = db.fetchInstance(_, bindEnt, bindId);
				layout = layoutEnt.createInstance(_, db);
				layout.page(_, page, pageVariant);
				if (bind) layout.binding(_, bind, bindVariant);
			}
		},
		$setId: function(_, context, id) {
			var self = this;
			// id is a composed of: "pageVariant.pageUuid[,bindVariant.bindUuid]
			self._layoutId = id;
			var layout = self.getLayout(_, id);
			//
			if (layout) self.content(_, JSON.parse(layout.content(_) || "{}"));
			else self.content(_, null);
		},
		$save: function(_, saveRes) {
			var self = this;
			//
			var layout = self.getLayout(_, self._layoutId, true);
			layout.content(_, self.content(_));
			layout.save(_, null, {
				shallowSerialize: true
			});
			saveRes.$diagnoses = saveRes.$diagnoses || [];
			layout.getAllDiagnoses(_, saveRes.$diagnoses, {
				addEntityName: true,
				addPropName: true
			});
		}
	}
}