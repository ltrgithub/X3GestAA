"use strict"

var userScore = 100000;
var roleScore = 10000;
var unaffUserScore = 1000;
var unaffRoleScore = 1000;
var endpointScore = 100;
var unaffEPScore = 10;
var applicationScore = 1;

exports.entity = {
	$titleTemplate: "Dashboard",
	$descriptionTemplate: "Dashboard definition",
	$valueTemplate: "{title}",
	$properties: {
		title: {
			$title: "Title",
			$linksToDetails: true,
			$isLocalized: true,
			$isMandatory: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		},
		dashboardName: {
			$title: "Dashboard name",
			$isMandatory: true,
			$isUnique: true,
			$propagate: function(_, instance, val) {
				// modify related menu items
				var items = instance._db.fetchInstances(_, instance._db.getEntity(_, "menuItem"), {
					dashboard: val
				});
				items.forEach_(_, function(_, i) {
					i.dashboard(_, val);
					instance.addRelatedInstance(i);
				});
			}
		},
		mobile: {
			$title: "Mobile dashboard",
			$type: "boolean",
			$default: false,
			$isNullable: true			
		}
	},
	$services: {
	    mobilePortlets : {
			$isHidden : true,
			$method: "GET",
			$isMethod : false,
			$title : "Mobile Applications",
			$execute : function(_, context, instance) {
				var res = {$resources:[]};
				var dashboards = context.db.fetchInstances(_, context.model.getEntity("dashboardDef"), {
					jsonWhere: {
						mobile: true
					},
					orderBy: [{
						binding: "title",
						descending: false
					}]
					
				});	
				// a dashboard "mobile" has only one application
				dashboards.forEach_(_, function(_, dashboard) {
					var variants = dashboard.variants(_).toArray(_);
					var application = null;
					variants.forEach_(_, function(_, variant) {
						// portlets for all applications are ignored
						if (!variant.allApplications(_)) {
							var ca = variant.application(_);
							var appName = "", appDesc = "", contract="", datasets = [];; 
							if (!application) {
								application = ca;
								if (application) {
									appName = application.application(_);
									appDesc = application.description(_);
									contract= application.contract(_);
									// get endpoints for application
									var endpoints = application.endpoints(_).toArray(_);
									endpoints.forEach_(_, function(_, endpoint) {
										var ep = {}; 
										ep.dataset = endpoint.dataset(_);
										ep.description = endpoint.description(_);
										datasets.push(ep);
									});
									
								}
							}
							if (ca && application && (appName === ca.application(_))) {
								var vignettes = variant.vignettes(_).toArray(_);
								vignettes.forEach_(_, function(_, vignette) {
									var portlet = vignette.portlet(_);
									if (portlet.type(_) === "$menu") {
										var mobApp = {};
										mobApp.endpoints=datasets;
										mobApp.icon = portlet.code(_);
										mobApp.title = portlet.title(_);
										mobApp.contract = contract;
										mobApp.description = portlet.description(_);
										mobApp.applicationName = appName;
										mobApp.applicationDescription = appDesc;
										mobApp.installUrl = portlet.getUrl(_) + "/$service/representation";
										res.$resources.push(mobApp);
									} else if (portlet.type(_) === "$menu") {
										
									}
								});
							}
						}
					});
				});
				context.reply(_, 200, res);
			}
		}
	},
	$relations: {
		variants: {
			$type: "dashboardVariants",
			$title: "Variants",
			$isChild: true
		}
	},
	$functions: {
		selectVariant: function(_, userProfile, application) {
			if(!userProfile) return null;
			//
			var self = this;
			//
			var userId = userProfile.user(_).$uuid;
			var roleId = userProfile.selectedRole(_) && userProfile.selectedRole(_).$uuid;
			var epId = userProfile.selectedEndpoint(_) && userProfile.selectedEndpoint(_).$uuid;
			var appId = epId && userProfile.selectedEndpoint(_).applicationRef(_).$uuid;
			//
			var variants = self.variants(_).toArray(_);
			var scores = [];
			variants.forEach_(_, function(_, v) {
				var score = 0;
				// application: 
				//   if no endpoint selected, best score if "allApplications", no bonus otherwise
				//   if an endpoint is selected best score if application fits, second best if "allApplications", ignore if different
				if(appId) {
					if(v.application(_)) {
						if(v.application(_).$uuid === appId)
							score += 2*applicationScore;
						else
							return;
					} else
						score += applicationScore;
				} else
					if(v.allApplications(_))
						score += applicationScore;
				//
				if(v.users(_).isEmpty())
					score += unaffUserScore;
				else
					if(v.users(_).get(_, userId))
						score += userScore;
				//
				if(v.roles(_).isEmpty())
					score += unaffRoleScore;
				else
					if(roleId && v.roles(_).get(_, roleId)) 
						score += roleScore;
				//
				if(v.endpoints(_).isEmpty())
					score += unaffEPScore;
				else
					if(epId && v.endpoints(_).get(_, epId)) 
						score += endpointScore;
				//
				scores.push({
					$uuid: v.$uuid,
					score: score
				});
			});
			//
			var best = scores.sort(function(a,b) {
				return b.score - a.score;
			})[0];
			return best && self.variants(_).get(_, best.$uuid);
		}
	},
	$searchIndex: {
		$fields: ["title", "description", "dashboardName"]
	}
}