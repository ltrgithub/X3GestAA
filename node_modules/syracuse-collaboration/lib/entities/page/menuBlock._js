"use strict";

exports.entity = {
	$titleTemplate: "Menu block",
	$valueTemplate: "{title}",
	$properties: {
		code: {
			$title: "Code",
			$isUnique: true,
			$isMandatory: true
		},
		title: {
			$title: "Title",
			$isLocalized: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		}
	},
	$relations: {
		items: {
			$isPlural: true,
			$title: "Items",
			$capabilities: "sort,reorder,delete",
			$variants: {
				menuItem: {
					$title: "Menu items",
					$type: "menuItem"
				},
				menuBlock: {
					$title: "Blocks",
					$type: "menuBlock",
					$isChild: true
				}
			}
		},
		application: {
			$title: "Application",
			$type: "application",
			$isMandatory: function(_, instance) {
				return !instance._parent || (instance._parent.getEntity(_).name !== "menuBlock");
			}
		},
		endpoints: {
			$title: "Endpoints",
			$type: "endPoints"
		}
	},
	$functions: {
		getNavigationPageResource: function(_, baseUrlProp) {
			var sm = this;
			return {
				$uuid: sm.$uuid,
				title: sm.title(_),
				description: sm.description(_),
				items: sm.items(_).toArray(_).map_(_, function(_, it) {
					return it.getNavigationPageResource(_, baseUrlProp);
				})
			};
		}
	},
	$events: {
		$afterSave: [function(_, instance, params) {
			// add module to origin page
			if (params && params.originModule) {
				var mod = instance._db.fetchInstance(_, instance._db.getEntity(_, "menuModule"), params.originModule);
				if (mod) {
					mod.submodules(_).set(_, instance.$uuid);
					mod.save(_, null, {
						shallowSerialize: true
					});
				}
			}
		}]
	}
};