"use strict";

var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var jsonExport = require("syracuse-import/lib/jsonExport");

exports.entity = {
	$properties: {
		code: {
			$title: "Code",
			$isMandatory: true,
			$isUnique: true,
			/*$propagate: function(_, instance, val) {
				var ap = adminHelper.getCollaborationApplication(_);
				instance.application(_, ap);

			}*/
		},
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isMandatory: true,
				$isUnique: true
			},
		applicationName: {
			//$isHidden: true,
			$compute: function(_, instance) {
				return (instance.application(_) && instance.application(_).application(_)) || "syracuse";
			}
		},
		contractName: {
			//$isHidden: true,
			$compute: function(_, instance) {
				return (instance.application(_) && instance.application(_).contract(_)) || "collaboration";
			}
		},
		endpointName: {
			//$isHidden: true,
			$compute: function(_, instance) {
				return (instance.endpoint(_) && instance.endpoint(_).dataset(_)) || "syracuse";
			}
		},
		
	},
	$titleTemplate: "Export",
	$descriptionTemplate: "Administration data export",
	$valueTemplate: "{description}",
	$relations: {
		application: {
			$title: "Application",
			$type: "application",
			$isDefined: true,
			$isMandatory: true,
			defaultValue:  function(_) {
				var app = adminHelper.getCollaborationApplication(_);
				return {
					$key: app.$key,
					$uuid: app.$uuid,
					description: app.description(_)
				};
				
			}
		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true,
			$isDefined: true,
			defaultValue:  function(_) {
				var ep = adminHelper.getCollaborationEndpoint(_);
				return {
					$key: ep.$key,
					$uuid: ep.$uuid,
					description: ep.description(_)
				};
				
			}
		},
		exportProfileItem: {
			$title: "Profile Item",
			$type: "exportProfileItems",
			$isMandatory: true,
			$isChild: true,
			$select: {
				$title: "Entities",
				$type: "lookupEntity",
				$fieldMap: { className: "name", title: "title"},
				$parameters: "application={applicationName}&contract={contractName}&dataset={endpointName}"
			},
		},
	},
	$services: {
	    $export : {
			$method : "PUT",
			$isMethod : true,
			$title : "Export",
			$execute : function(_, context, instance) {
				jsonExport.hello(instance.code(_));
				var res = instance.serializeInstance(_);
				context.reply(_, 200, res);
			}
		}
	},
	$searchIndex: {
		$fields: ["description"]
	}
};