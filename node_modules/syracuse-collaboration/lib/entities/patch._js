"use strict";

var sys = require("util");
var patchcreate = require("syracuse-patch/lib/patchcreate");
var integrate = require("syracuse-patch/lib/patch");
var fs = require('fs');
var os = require('os');
// semaphore file
var sem = os.tmpDir()+"/semaphore.txt"


			
exports.entity = {
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		newPatch: {
			$type: "boolean",
			$title: "Make new patch",
			$default: true
		},
		newRelease: {
			$type: "boolean",
			$title: "Create new release",
			$default: true // false
		},
		startFromRelease: {
			$type: "boolean",
			$title: "Start from release",
			$default: false			
		},
		newReleaseNumber: {
			$title: "Number of new release",
            $default: "1" // ""
		},
		comment: {
			$title: "Description",
			$default: "Desc" // ""
		},
		baseRelease: {
			$title: "Number of base release"
		},
		patchFile: {
			$title: "Patch file name",
			$default: os.tmpDir()+"/patch.dat"
		},		
		customerImage: {
			$title: "Customer image directory",
			$default: "c:/patching/image"
		}
	},
	$titleTemplate: "Patch",
    $valueTemplate: "Patch",
    $descriptionTemplate: "Patch",
    $functions: {
    },
	$services: {
		$deleteSemaphore: {
			$method : "PUT",
			$isMethod : true,
			$title : "Delete Semaphore",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				try {
					fs.unlink(sem, _);
					instance.$diagnoses.push({severity: "info", message: "OK"});					
				} catch (e) {
					instance.$diagnoses.push({severity: "error", message: e})
					console.log("Error when deleting semaphore "+e)
				}
				console.log("Deleted");
			}
		},
	    $createPatch: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create patch",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						console.log("Before");
						var config = require('syracuse-main/lib/nodeconfig').config;
						patchcreate.patch(instance.newPatch(_), instance.startFromRelease(_), instance.newRelease(_), instance.newReleaseNumber(_), instance.comment(_), instance.baseRelease(_), instance.patchFile(_), config.patch, _);
						console.log("After");
						instance.$diagnoses.push({severity: "info", message: "OK"});
						} catch (e) {
							console.log("Error2 "+e);
						instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						fs.unlink(sem, _);
					}
					console.log("End");
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
	    $integratePatch: {
			$method : "PUT",
			$isMethod : true,
			$title : "Integrate patch",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						integrate.patch(".", instance.patchFile(_), _);
						instance.$diagnoses.push({severity: "info", message: "OK"});
					} catch (e) {
						console.log("Error "+e);
						instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						fs.unlink(sem, _);
					}
					console.log("End");
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
	    $customerDir: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create customer image",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						var config = require('syracuse-main/lib/nodeconfig').config;
						console.log("CONFIG "+JSON.stringify(config.patch))
						patchcreate.createCustomerImage(config.patch, _, instance.baseRelease(_));
						instance.$diagnoses.push({severity: "info", message: "OK"});
						} catch (e) {
							instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						fs.unlink(sem, _);
					}
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		}
	},
};