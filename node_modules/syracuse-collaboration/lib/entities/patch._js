"use strict";

var sys = require("util");
var patchcreate = require("syracuse-patch/lib/patchcreate");
var write = require("syracuse-patch/lib/write");
var fs = require('fs');
var os = require('os');
// semaphore file
var sem = os.tmpDir()+"/semaphore.txt"


			
exports.entity = {
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		newPatch: {
			$type: "boolean",
			$title: "Make new patch",
			$default: true,
			$isDisabled: function(_, instance) { 
				return instance.newRelease(_)
			}
		},
		newRelease: {
			$type: "boolean",
			$title: "Create new release",
			$default: true // false
		},
		startFromRelease: {
			$type: "boolean",
			$title: "Start from release",
			$default: false			
		},
		sha1Old: {
			$title: "Commit hash of start version",
			$default: "",
			$isDisabled: function(_, instance) {
				return instance.newRelease(_) || instance.newPatch(_);
			}
		},
		sha1New: {
			$title: "Commit hash of end version",
			$default: "", 
			$isDisabled: function(_, instance) {
				return instance.newRelease(_) || instance.newPatch(_);
			}
		},
		newReleaseNumber: {
			$title: "Number of new release",
            $default: "1", // ""
    		$isDisabled: function(_, instance) { 
    			return !instance.newRelease(_)
    		},
			$isMandatory: function(_, instance) { 
    			return instance.newRelease(_)
    		} 
		},
		comment: {
			$title: "Description",
			$default: "",
			$isDisabled: function(_, instance) {
				return !instance.newRelease(_) && !instance.newPatch(_);
			}
		},
		baseRelease: {
			$title: "Number of base release"
		},
		patchFile: {
			$title: "Patch file name",
			$default: os.tmpDir()+"/patch.dat",
		},		
		customerImage: {
			$title: "Customer image directory",
			$default: "c:/patching/image"
		}
	},
	$titleTemplate: "Patch",
    $valueTemplate: "Patch",
    $descriptionTemplate: "Patch",
    $functions: {
    },
	$services: {
	    $createPatch: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create patch",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						console.log("Before");
						var config = require('syracuse-main/lib/nodeconfig').config;
						patchcreate.patch(instance.newPatch(_), instance.startFromRelease(_), instance.newRelease(_), instance.newReleaseNumber(_), instance.comment(_), instance.baseRelease(_), instance.patchFile(_), instance.sha1Old(_), instance.sha1New(_), config.patch, _);
						console.log("After");
						instance.$diagnoses.push({severity: "info", message: "OK"});
						} catch (e) {
							console.log("Error2 "+e);
						instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						write.unlink(sem, _);
					}
					console.log("End");
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
	    $customerDir: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create customer image",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						var config = require('syracuse-main/lib/nodeconfig').config;
						console.log("CONFIG "+JSON.stringify(config.patch))
						patchcreate.createCustomerImage(config.patch, _, instance.baseRelease(_));
						instance.$diagnoses.push({severity: "info", message: "OK"});
						} catch (e) {
							instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						write.unlink(sem, _);
					}
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
		$deleteSemaphore: {
			$method : "PUT",
			$isMethod : true,
			$title : "Delete Semaphore",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!write.exists(sem, _))
					instance.$diagnoses.push({severity: "warning", message: "No semaphore"});
				else {
					try {
						write.unlink(sem, _);
						instance.$diagnoses.push({severity: "info", message: "OK"});					
					} catch (e) {
						instance.$diagnoses.push({severity: "error", message: e})
						console.log("Error when deleting semaphore "+e)
					}					
				}
				console.log("Deleted2");
			}
		}		
	},
};