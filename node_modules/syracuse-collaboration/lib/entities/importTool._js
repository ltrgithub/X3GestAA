"use strict";

var importTool = require("syracuse-import/lib/jsonImport");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

exports.entity = {
	$isPersistent: false,
	$titleTemplate: "Data import assistant",
	$descriptionTemplate: "Generic import interface. Choose a file name is based in \"import\" folder.",
	$properties: {
		fileName: {
			$title: "File name"
		}
	},
	$relations: {
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true
		}
	},
	$init: function(_, instance) {
		instance.fileName(_, "syracuse-admin-init.json");
		// init to admin endpoint
		var ep = adminHelper.getEndpoint(_, { application: "syracuse", contract: "collaboration", dataset: "syracuse" });
		if(ep) instance.endpoint(_, ep);
	},
	$functions: {
		$setParameters: function(_, context) {
			if (!this.$uuid) {
				this.$uuid = this.$key = helpers.uuid.generate();
				this.$created = true;
			}
		},
		$save: function(_, saveRes) {
			importTool.jsonImport(_, this.endpoint(_).getOrm(_), this.fileName(_), {importMode:"update", $diagnoses:saveRes.$diagnoses});
		}
	}
}