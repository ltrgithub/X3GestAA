"use strict";

var BoRestClient = require("syracuse-x3/lib/boRestClient").BoRestClient;

exports.entity = {
	$titleTemplate: "Business Objects profile",
	$descriptionTemplate: "Configure Business Objects profile",
	$valueTemplate: "{name}",
	$helpPage: "Administration-reference-Business-Objects-profiles",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		security: {
			$title: "Security",
			$enum: [{
				$value: "secEnterprise",
				$title: "secEnterprise"
			}],
			$default: "secEnterprise"
		},
		user: {
			$title: "User",
			$isMandatory: true
		},
		password: {
			$title: "Password",
			$type: "password",
			$salt: "",
			$capabilities: "confirm",
			$encrypt: true
		}
	},
	$relations: {
		boServer: {
			$title: "BO Server",
			$type: "boServer",
			$isMandatory: true
		}
	},
	$functions: {},
	$services: {
		test: {
			$method: "GET",
			$isMethod: true,
			$title: "Test account",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || [];
				try {


					var boClient = new BoRestClient(_, instance, null, context);

					var valid = true;
					if (boClient.logon(_) == null) {
						valid = false;
						instance.$diagnoses.push({
							$severity: "error",
							$message: "Logon failed ; Get token failed"
						});
					}
					if (valid) {
						if (boClient.logoff(_) == null) {
							valid = false;
							instance.$diagnoses.push({
								$severity: "error",
								$message: "Logoff failed."
							});
						}
					}
					if (valid)
						instance.$diagnoses.push({
							$severity: "info",
							$message: instance.user(_) + "'s account is valid."
						});

				} catch (e) {
					console.error(e.stack);
					instance.$diagnoses.push({
						$severity: "error",
						$message: "" + e
					});
				}
			}
		},
	}
};