"use strict";

var http = require('http');
var httpClient = require('syracuse-httpclient/lib/httpClient');
var locale = require("syracuse-core/lib/locale");
var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;
var hrmHelper = require('syracuse-hrm/lib/hrmHelper');

var GLOBAL_PREFIX = "STD_X3_HRM";
var PREFIX_MENU_ITM = GLOBAL_PREFIX + "_SITE_";
var MENU_BLOCK_NAME = GLOBAL_PREFIX + "_SITE";
var MODULE_NAME = GLOBAL_PREFIX + "_SITES";

exports.entity = {
	$titleTemplate: "HRM Site",
	$descriptionTemplate: "Configure HRM site",
	$valueTemplate: "{name}",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$linksToDetails: true,
			$isUnique: true,
			$pattern: /^[A-Za-z_\-][A-Za-z_\-0-9]*$/
		},
		devmode: {
			$title: "Development mode",
			$type: "boolean",
			$default: false
		}
	},
	$relations: {
		application: {
			$title: "Application",
			$type: "application",
			$isExcluded: true,
			$isDefined: true,
			$compute: function(_, instance) {
				return adminHelper.getApplication(_, "x3", "hrm");
			},
			$isMandatory: true
		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true,
			$isDefined: true,
			$lookupFilter: {
				applicationRef: "{application}"
			}
		},
		servers: {
			$title: "XTend Web Servers",
			$type: "hrmServers"
		}
	},
	$functions: {
		install: function(_) {
			function getHomeNavigationPage(_) {
				var filter = {
					sdataWhere: "pageName eq 'home'"
				};
				var entity = db.getEntity(_, "navigationPage");
				return db.fetchInstance(_, entity, filter);
			}

			function setMenuItem(_) {

				function createMenuItemParameter(_, name, title, value) {
					var inst = pentity.createInstance(_, db, null);
					inst.name(_, name);
					inst.title(_, title);
					inst.value(_, value);
					return inst;
				}

				function createMenuItem(_, code, name, params) {
					var inst = entity.createInstance(_, db, null);
					updateMenuItem(_, inst, code, name, params);
					return inst;
				}

				function updateMenuItem(_, inst, code, name, params) {
					inst.code(_, code);
					inst.title(_, name);
					inst.linkType(_, "$hrm");
					inst.application(_, app);
					inst.endpoint(_, ep);
					inst.hrmSite(_, self);
					// Add menuItem parameters to be able to force web server usage (devmode)
					if (params) {
						inst.description(_, site + " (" + solution + "/" + folder + ") - Devmode (" + params.host + ":" + params.port + ")");
						inst.parameters(_).set(_, createMenuItemParameter(_, "SRVHOST", locale.format(module, "miParamHost"), params.host));
						inst.parameters(_).set(_, createMenuItemParameter(_, "SRVPORT", locale.format(module, "miParamPort"), params.port));
					} else {
						inst.description(_, site + " (" + solution + "/" + folder + ")");
					}
					hrmHelper.saveAndCheckErrors(_, inst);
				}

				function removeDevMenuItems(_, name) {
					var items = hrmHelper.getInstances(_, db, entity, "code", name + "_DEV");
					for (var i in items) {
						items[i].deleteSelf(_);
					}
				}
				//
				var entity = db.getEntity(_, "menuItem");
				var pentity = db.getEntity(_, "menuItemParameter");
				var menuItemCode = PREFIX_MENU_ITM + solution + "_" + folder + "_" + site;

				var menuItems = [];

				var menuItem = hrmHelper.getInstance(_, db, entity, "code", menuItemCode);
				if (!menuItem) {
					menuItem = createMenuItem(_, menuItemCode, site);
				} else {
					updateMenuItem(_, menuItem, menuItemCode, site);
				}
				menuItems.push(menuItem);

				removeDevMenuItems(_, menuItemCode);
				if (self.devmode(_)) {
					var arr = self.servers(_).toArray(_);
					for (var i in arr) {
						var mName = menuItemCode + "_DEV" + i;
						var sName = site + " (" + arr[i].host(_) + ":" + arr[i].port(_) + ")";
						menuItem = createMenuItem(_, mName, sName, {
							host: arr[i].host(_),
							port: arr[i].port(_)
						});
						menuItems.push(menuItem);
					}
				}
				return menuItems;
			}

			function setMenuBlock(_, itemsToAdd) {
				function createMenuBlock(_) {
					var inst = entity.createInstance(_, db, null);
					updateMenuBlock(_, inst);
					return inst;
				}

				function updateMenuBlock(_, inst) {
					inst.code(_, MENU_BLOCK_NAME);
					inst.title(_, "Sites");
					inst.description(_, "HRM Sites");
					inst.application(_, app);

					// Add menu item in Menu block if it's not already setted
					for (var i in itemsToAdd) {
						if (!hrmHelper.isItemInProp(_, inst, itemsToAdd[i], "items"))
							inst.items(_).set(_, itemsToAdd[i]);
					}
					if (!hrmHelper.isItemInProp(_, inst, ep, "endpoints"))
						inst.endpoints(_).set(_, ep);

					hrmHelper.saveAndCheckErrors(_, inst);
				}
				//
				var entity = db.getEntity(_, "menuBlock");
				var menuBlock = hrmHelper.getInstance(_, db, entity, "code", MENU_BLOCK_NAME);
				if (!menuBlock) {
					menuBlock = createMenuBlock(_);
				} else {
					updateMenuBlock(_, menuBlock);
				}
				return menuBlock;
			}

			function setMenuModule(_, submoduleToAdd) {
				function createMenuModule(_) {
					var inst = entity.createInstance(_, db, null);
					updateMenuModule(_, inst);
					return inst;
				}

				function updateMenuModule(_, inst) {
					inst.code(_, MODULE_NAME);
					inst.title(_, "HRM Sites");
					inst.description(_, "HRM Sites");
					inst.application(_, app);

					// Add menu item in Menu block if it's not already setted
					for (var i in submoduleToAdd) {
						if (!hrmHelper.isItemInProp(_, inst, submoduleToAdd[i], "submodules"))
							inst.submodules(_).set(_, submoduleToAdd[i]);
					}
					if (!hrmHelper.isItemInProp(_, inst, ep, "endpoints"))
						inst.endpoints(_).set(_, ep);

					homePage = getHomeNavigationPage(_);
					if (homePage && !hrmHelper.isItemInProp(_, inst, homePage, "navigationPages"))
						inst.navigationPages(_).set(_, homePage);

					hrmHelper.saveAndCheckErrors(_, inst);
				}
				//
				var entity = db.getEntity(_, "menuModule");
				var menuModule = hrmHelper.getInstance(_, db, entity, "code", MODULE_NAME);
				if (!menuModule) {
					menuModule = createMenuModule(_);
				} else {
					updateMenuModule(_, menuModule);
				}
				return menuModule;
			}

			var self = this;
			var solution = self.endpoint(_).x3SolutionName(_);
			var folder = self.endpoint(_).x3ServerFolder(_);
			var site = self.name(_);

			var db = adminHelper.getCollaborationOrm(_);
			var app = adminHelper.getApplication(_, "x3", "hrm");
			var ep = self.endpoint(_);
			var homePage;
			var _diagnoses = [],
				_menuItems, _menuBlock, _menuModule;
			//
			_menuItems = setMenuItem(_);
			var ids = _menuItems.map_(_, function(_, it) {
				return it.code(_);
			}).join(',');
			_diagnoses.push({
				$severity: "info",
				$message: locale.format(module, "menuItemsAdded", _menuItems.length, ids)
			});
			//
			_menuBlock = setMenuBlock(_, _menuItems);
			_diagnoses.push({
				$severity: "info",
				$message: locale.format(module, "menuBlockAdded", _menuBlock.code(_))
			});
			//
			_menuModule = setMenuModule(_, [_menuBlock]);
			_diagnoses.push({
				$severity: "info",
				$message: locale.format(module, "menuModuleAdded", _menuModule.code(_))
			});
			if (!homePage) {
				_diagnoses.push({
					$severity: "warning",
					$message: locale.format(module, "homePageMissing")
				});
			} else {
				_diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "installOk")
				});
			}
			return {
				nbItems: ids.length,
				$diagnoses: _diagnoses
			};
		},
		uninstall: function(_) {
			function removeAllMenuItems(_, name) {

				var entity = db.getEntity(_, "menuItem");
				var mainItem = hrmHelper.getInstance(_, db, entity, "code", name);
				var items = hrmHelper.getInstances(_, db, entity, "code", name + "_");

				var ids = items.map_(_, function(_, it) {
					return it.code(_);
				}) || [];
				if (mainItem) {
					mainItem.deleteSelf(_);
					ids.splice(0, 0, mainItem.code(_));
				}
				for (var i in items) {
					// deleteSelf is sufficient to remove relations in menuBlock
					items[i].deleteSelf(_);
				}
				return ids;
			}

			function mustRemoveEpFromBlock(_, menuBlock) {
				if (menuBlock) {
					var items = menuBlock.items(_);
					if (items.getLength() > 0) {
						var arr = items.toArray(_);
						for (var i in arr) {
							if (arr[i].endpoint(_).$uuid === ep.$uuid) {
								return false;
							}
						}
						// If no items are linked to the same endpint, the ep is removed from the instance
						return true;
					} else if (!menuBlock.endpoints(_).isEmpty()) {
						return false;
					}
				}
				return false;
			}

			function mustRemoveEpFromModule(_, menuModule) {
				if (menuModule) {
					var submodules = menuModule.submodules(_);
					if (submodules.getLength() > 0) {
						var arr = submodules.toArray(_);
						for (var i in arr) {
							if (arr[i].endpoints(_).toUuidArray(_).indexOf(ep.$uuid) !== -1) {
								return false;
							}
						}
						// If no submodule (block) are linked to the same endpint, the ep is removed from the instance
						return true;
					} else if (!menuModule.endpoints(_).isEmpty()) {
						return false;
					}
				}
				return false;
			}
			// BEGIN UNPUBLISH CLOSURE
			var self = this;
			var db = adminHelper.getCollaborationOrm(_);
			var ep = self.endpoint(_);
			var solution = ep.x3SolutionName(_);
			var folder = ep.x3ServerFolder(_);
			var site = self.name(_);
			var menuItemCode = PREFIX_MENU_ITM + solution + "_" + folder + "_" + site;

			var _diagnoses = [];
			var itemsRemoved = removeAllMenuItems(_, menuItemCode);
			if (itemsRemoved.length > 0)
				_diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "menuItemsRemoved", itemsRemoved.length, itemsRemoved.join(','))
				});

			var entity = db.getEntity(_, "menuBlock");
			var b = hrmHelper.getInstance(_, db, entity, "code", MENU_BLOCK_NAME);
			if (mustRemoveEpFromBlock(_, b)) {
				b.endpoints(_).deleteInstance(_, ep.$uuid);
				hrmHelper.saveAndCheckErrors(_, b);
				_diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "epRemovedFromBlock", ep.description(_), MENU_BLOCK_NAME)
				});
			}

			entity = db.getEntity(_, "menuModule");
			var m = hrmHelper.getInstance(_, db, entity, "code", MODULE_NAME);
			if (mustRemoveEpFromModule(_, m)) {
				m.endpoints(_).deleteInstance(_, ep.$uuid);
				hrmHelper.saveAndCheckErrors(_, m);
				_diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "epRemovedFromModule", ep.description(_), MODULE_NAME)
				});
			}
			return {
				nbItems: itemsRemoved.length,
				$diagnoses: _diagnoses
			};
		},
		ping: function(_, context) {
			var _diagnoses = [];

			var db = adminHelper.getCollaborationOrm(_);
			var entity = db.getEntity(_, "menuItem");

			var ep = this.endpoint(_);
			var solution = ep.x3SolutionName(_);
			var folder = ep.x3ServerFolder(_);
			var site = this.name(_);

			var menuItemCode = PREFIX_MENU_ITM + solution + "_" + folder + "_" + site;
			var menuItem = hrmHelper.getInstance(_, db, entity, "code", menuItemCode);
			if (!menuItem) {
				_diagnoses.push({
					$severity: "error",
					$message: locale.format(module, "notPublished")
				});
				return _diagnoses;
			}
			var host = context.httpSession && context.httpSession.host;


			if (this.servers(_).getLength() > 0) {
				this.servers(_).toArray(_).forEach_(_, function(_, item) {

					var banned = item.banned(_);

					if (item.isServerRunning(_)) {

						_diagnoses.push({
							$severity: "info",
							$message: locale.format(module, "pingOk", item.toString(_))
						});

					} else {
						_diagnoses.push({
							$severity: "error",
							$message: locale.format(module, "pingFailed", item.toString(_))
						});
					}
				});
			} else {
				_diagnoses.push({
					$severity: "error",
					$message: locale.format(module, "noServers")
				});
			}
			return _diagnoses;
		},
	},
	$services: {
		install: {
			$method: "GET",
			$isMethod: true,
			$title: "Install site",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || [];
				try {
					instance.$diagnoses = instance.$diagnoses.concat(instance.install(_).$diagnoses);
				} catch (e) {
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message,
						$stackTrace: e.stack
					});
				}
			}
		},
		uninstall: {
			$method: "GET",
			$isMethod: true,
			$title: "Uninstall site",
			$execute: function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || [];
				try {
					instance.$diagnoses = instance.$diagnoses.concat(instance.uninstall(_).$diagnoses);
				} catch (e) {
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message,
						$stackTrace: e.stack
					});
				}
			}
		},
		ping: {
			$method: "GET",
			$isMethod: true,
			$title: "Ping",
			$execute: function(_, context, instance) {

				instance.$diagnoses = instance.$diagnoses || [];
				try {
					instance.$diagnoses = instance.$diagnoses.concat(instance.ping(_, context));
				} catch (e) {
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message,
						$stackTrace: e.stack
					});
				}
			}
		},
	},

	$uniqueConstraints: [
		["name", "endpoint"]
	]
};