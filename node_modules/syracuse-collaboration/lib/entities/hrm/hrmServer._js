"use strict";

var httpClient = require('syracuse-httpclient/lib/httpClient');
var flows = require("streamline/lib/util/flows");
var hrmHelper = require('syracuse-hrm/lib/hrmHelper');
var nodeconfig = require('syracuse-main/lib/nodeconfig');

//var locale = require("syracuse-core/lib/locale");

var trace = nodeconfig.config && nodeconfig.config.hrm && nodeconfig.config.hrm.proxy && nodeconfig.config.hrm.proxy.trace;

exports.entity = {
	$valueTemplate: "{host}:{port}",
	$properties: {
		host: {
			$title: "HRM server host",
			$description: "Physical server name or IP address",
			$isMandatory: true
		},
		port: {
			$title: "HRM server port",
			$description: "Tomcat server port",
			$isMandatory: true
		},
		banTimeout: {
			$title: "Banishment timeout",
			$isMandatory: true,
			$type: "integer",
			$default: 60
		},
		banned: {
			$title: "Banned",
			$description: "Banned because unavailable (Duration: 1 hour)",
			$type: "boolean",
			$default: false,
			$propagate: function(_, instance, val) {
				if (val) {
					flows.setTimeout(function(_) {
						instance.banned(_, false);
						var s = instance.save(_);
						var err = hrmHelper.hasErrors(s);
						if (err) {
							throw new Error(err);
						}
						//console.log("Server is not banned anymore");
					}, instance.banTimeout(_) * 60000 || 3600000);
				}
			}
		}
	},
	$relations: {},
	$functions: {
		toString: function(_) {
			return this.host(_) + ":" + this.port(_);
		},
		isServerRunning: function(_) {
			try {
				var options = {
					method: "GET",
					url: "http://" + this.host(_) + ":" + this.port(_),
					headers: {}
				};

				trace && trace('Check if running : ' + JSON.stringify(options, null, 2));
				var request = httpClient.httpRequest(_, options);
				request.setTimeout(500, ~_);
				var resp = request.end().response(_);

				trace && trace("isServerRunning:" + JSON.stringify({
					status: resp.statusCode,
					headers: resp.headers
				}, null, 2));

				if (resp.statusCode === 200) return true;
				// if !== 200 --> the server will be banned (by default for 1 hour)
				this.bannish(_);
				return false;
			} catch (e) {
				this.bannish(_);
				return false;
			}
		},
		bannish: function(_) {
			var self = this;
			self.banned(_, true);
			var s = self.save(_);
			var err = hrmHelper.hasErrors(s);
			if (err) {
				throw new Error(err);
			}
			//console.log("Server is banned");
		}
	},
	$uniqueConstraints: [
		["host", "port"]
	]
};