"use strict";

exports.entity = {
	$titleTemplate: "X3 server",
	$descriptionTemplate: "X3 server settings",
	$valueTemplate: "{description} {serverHost}",
	$properties: {
		description: {
			$title: "Description",
			$description: "Friendly name",
			$isMandatory: true,
			$linksToDetails: true,
			$isUnique: true
		},
		serverHost: {
			$title: "Server host",
			$description: "Physical server name or IP address",
			$isMandatory: true
		},
		serverPort: {
			$title: "Server port",
			$type: "integer",
			$isMandatory: true
		},
		serverName: {
			$title: "Application server",
			$description: "If different from \"Server host\"",
			$isMandatory: false
		},
		serverTimeout: {
			$title: "Server timeout (ms)",
			$type: "integer",
			$isMandatory: true
		},
		webServer: {
			$title: "Web server host",
			$description: "If different from \"Server host\""
		},
		webServerPort: {
			$title: "Web server port",
			$type: "integer",
			$default: 80
		}
	},
	$relations: {
		endpoints: {
			$title: "Endpoints",
			$description: "Associated endpoints",
			$type: "endPoints",
			$inv: "x3server",
			$isComputed: true,
			$capabilities: "sort,filter",
			$isReadOnly: true
		}
	},
	$services: {
		checkServer: {
			$title: "Check server settings",
			$description: "Attempts to connect to the server",
			$method: "GET",
			$isMethod: true,
			$execute : function(_, context, instance) {
				try {
					instance.$diagnoses = require("syracuse-x3/lib/pool").checkServerSettings(_, {
						address: instance.serverHost(_),
						port: instance.serverPort(_),
						applicationServer: instance.serverName(_)
					});
				} catch(e) {
					(instance.$diagnoses = instance.$diagnoses || []).push({
						severity: "error",
						message: e.message
					});
				}
			}
		}
	},
	$searchIndex: {
		$fields: ["description", "serverName", "serverHost", "serverPort", "webServer", "endpoints"]
	}
}