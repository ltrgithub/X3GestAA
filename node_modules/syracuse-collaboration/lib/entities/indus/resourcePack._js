"use strict";

var zip = require("streamline-zip");
var WritableBufferStream = require("syracuse-core/lib/streamBuffer").WritableBufferStream;


exports.entity = {
	$titleTemplate: "Resources pack",
	$valueTemplate: "{code}",
	$properties: {
		code: {
			$title: "Code",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		}
	},
	$relations: {
		items: {
			$title: "Items",
			$type: "resourcePackItems",
			$isChild: true
		}
	},
	$functions: {
		generatePack: function(_, context, options) {
			var self = this;
			var wbs = new WritableBufferStream();
			var zp = new zip.Zip(wbs);
			self.items(_).toArray(_).forEach_(_, function(_, it) {
				if (!it.fileName(_)) return;
				var tg = it.target(_).toArray(_)[0];
				if (!tg || !tg.generateContent) return;
				options.path = it.fileName(_);
				var dd = JSON.stringify(tg.generateContent(_, options), null, 2);
				zp.add(_, {
					name: it.fileName(_),
					data: new Buffer(dd, "utf8")
				});
			});
			zp.finish(_);
			return wbs.getBuffer();
		}
	},
	$services: {
		downloadContent: {
			$title: "Download content",
			$method: "GET",
			$isMethod: true,
			$type: "application/x-export",
			$invocationMode: "async",
			$execute: function(_, context, instance) {
				var opt = {
					targetType: "download",
					beautify: true
				};
				var t = context.tracker;
				t.$diagnoses = t.$diagnoses || [];
				opt.$diagnoses = t.$diagnoses;
				opt.tracker = t;
				t.replyLink = "$download";

				var pack = instance.generatePack(_, context, opt);

				t.$links = t.$links || {};
				t.$links.$download = {
					$title: "Download",
					$url: t.location + "?reply=true",
					$method: "GET",
					$type: "application/zip",
					$filename: instance.code(_) + ".zip"
				};
				return pack;
			}
		}
	}
};