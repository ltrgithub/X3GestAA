"use strict";

var locale = require('streamline-locale');
var IndexHelper = require("syracuse-search/lib/elasticIndex").IndexHelper;
var AdminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

exports.entity = {
	$titleTemplate: "Task",
	$valueTemplate: "{description}",
	$properties: {
		description: {
			$title: "Description",
			$isMandatory: true
		},
		suspended: {
			$title: "Suspended",
			$type: "boolean",
			$default: false
		},
		logLevel: {
			$title: "Log level",
			$enum: [{
				$value: "error",
				$title: "Errors only"
			}, {
				$value: "warning",
				$title: "Errors and Warnings"
			}, {
				$value: "all",
				$title: "All"
			}],
			$default: "error"
		},
		processSummary: {
			$title: "Task",
			$compute: function(_, instance) {
				var proc = instance.process(_);
				if (!proc) return;
				return proc.$getSummary(_);
			}
		}
	},
	$init: function(_, instance) {
		//instance.process(_, instance._db.getEntity(_, "searchAdmin").createInstance(_, instance._db));
	},
	$relations: {
		process: {
			$title: "Settings",
			$variants: {
				searchAdmin: {
					$type: "searchAdmin"
				},
				exportPersonalization: {
					$type: "exportPersonalization"
				},
				profileMenuImport: {
					$type: "profileMenuImport"
				},
				update: {
					$type: "update"
				}
			},
			$isDynamicType: true, // TODO: remove, should be replaced by $variants
			$isChild: true,
			$isHidden: true
		}
	},
	$functions: {
		run: function(_, diagnoses) {
			var p = this.process(_);
			if (!p) throw new Error(locale.format(module, "taskProcessUndefined", this.description(_)));
			if (!p.scheduledExecute) throw new Error(locale.format(module, "taskProcessExecuteUndefined", this.description(_)));
			var diags = diagnoses || [];
			p.scheduledExecute(_, diags);
			// logs
			var task = this;
			AdminHelper.logServerMessage(_, task.description(_), (task.logLevel(_) === "all") ? diags : diags.filter_(_, function(_, d) {
				if (d.severity === "error") return true;
				if ((task.logLevel(_) === "warning") && (d.severity === "warning")) return true;
				return false;
			}));
		}
	}
};