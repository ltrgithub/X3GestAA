"use strict";

var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var locale = require("syracuse-core/lib/locale");

exports.entity = {
	$titleTemplate: "Export",
	$descriptionTemplate: "Administration data export",
	$valueTemplate: "{description}",
	$properties: {
		className: {
			$title: "Class Name",
			$isMandatory: true,
			$isUnique: true
		},
		title: {
			$title: "Title",
			$isMandatory: true
		},
		representation: {
			$title: "Representation",
			$isMandatory: true
		},
		exportAll: {
			$title: "Export all",
			$type: "boolean"
		}
	},
	$relations: {
		exportedObjects: {
			$title: "Exported objects",
			// for now we must provide a type (might change later) but the real type is dynamicaly defined in className propagate
			$type: "exportProfileItems",
			$isDynamicType: true
		},	
	},
	$functions: {
		$serialize: function(_) {
			// dynamicaly define the $select link
			var self = this;
			var res = self._internalSerialize(_);
			console.log("parent is: "+require("util").inspect(self._parent));
			if(self._parent.endpoint(_) && self.className(_) && self.representation(_)) {
				// get "exportedObjects" $properties node
				res.$properties = res.$properties || {};
				res.$properties.exportedObjects = res.$properties.exportedObjects || {};
				var l = res.$properties.exportedObjects.$links = res.$properties.exportedObjects.$links || {};
				l.$select = {
					$type: "application/json; vnd-sage=syracuse",
					$url: [self._parent.endpoint(_).getBaseUrl(_), self.className(_)].join("/") + "?representation=" + self.representation(_) + ".$select"
				}
			}
			// 
			return res;
		}
	},
	$searchIndex: {
		$fields: ["description"]
	}
};