"use strict";

var date = require("syracuse-core/lib/types/date");
var globals = require('streamline/lib/globals');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var locale = require("syracuse-core/lib/locale");

var templatePresetValues = {
	"msoReportTemplate.$edit": {
		"templateType": "report",
		"templateClass": "{templateClass}",
		"localeCode": "{templateLocale}"
	},
	"msoMailMergeTemplate.$edit": {
		"templateType": "mailmerge",
		"templateClass": "{templateClass}",
		"localeCode": "{templateLocale}"
	}
};

function _getProperties(_, instance) {
	var prop = instance.content(_);
	return (prop && prop.fileExists(_) && prop.getProperties(_)) || {};
}

exports.entity = {
	$titleTemplate: "Document template",
	$valueTemplate: "{description}",
	$descriptionTemplate: "Word template management",
	$listTitle: "List of templates",

	$properties: {
		code: {
			$title: "Code",
			$linksToDetails: true
		},
		description: {
			$title: "Description",
			$isMandatory: true,
			$isLocalized: true,
			$linksToDetails: true
		},
		documentType: {
			$title: "Document type",
			/*$compute: function(_, instance, propName) {
				return _getProperties(_, instance).contentType;
			},*/
			$isReadOnly: true
		},
		documentDate: {
			$title: "Upload date",
			$type: "date",
			/*$compute: function(_, instance, propName) {
				var upDate = _getProperties(_, instance).uploadDate;
				return upDate && date.fromJsDate(upDate);
			},*/
			$isReadOnly: true,
			$isNullable: true
		},
		fileName: {
			$title: "Filename",
			/*$compute: function(_, instance, propName) {
				return _getProperties(_, instance).fileName;
			},*/
			$isReadOnly: true
		},
		templateType: {
			$title: "Template type",
			$type: "string",
			$isDisabled: true,
			$isHidden: true,
			$enum: [{
				$title: "Report",
				$value: "report"
			}, {
				$title: "Mail merge",
				$value: "mailmerge"
			}],
			$default: "report"
		},
		templateClass: {
			$type: "string",
			$title: "Template class",
			$isHidden: true,
			$isDisabled: true
		},
		uri: {
			$title: "Uri",
			$isDisabled: function(_, instance) {
				return (instance.content(_) && instance.content(_).fileExists(_));
			},
			$isDefined: function(_, instance) {
				return false;
			}
		},
		isReadOnly: {
			$title: "Read only",
			$type: "boolean",
			$default: false
		},
		content: {
			$title: "Content",
			$type: "binary",
			$storage: function(_, instance) {
				return "db_file";
			},
			$propagate: function(_, instance, val) {
				if (!instance.description(_) && val && val.fileName) instance.description(_, val.fileName);
				instance.documentType(_, val.contentType);
				instance.documentDate(_, date.today());
				instance.fileName(_, val.fileName);
			}
		},
		templatePurpose: {
			$type: "string",
			$title: "Purpose",
			$isMandatory: false,
			$isDisabled: false,
			$lookup: {
				entity: "lookupTemplatePurposes",
				field: "name",
				parameters: "templateClass={templateClass}&templateType={templateType}"
			}
		},
		localeCode: {
			$title: "Locale code",
			$isMandatory: false,
			$isDisabled: true,
			$isHidden: true,
			$lookup: {
				entity: "localePreference",
				field: "name"
			}
		},
		cpy: {
			$type: "string",
			$isMandatory: false,
			$isDisabled: function(_, instance) {
				return !instance.endpoint(_);
			},
			$isHidden: function(_, instance) {
				return !instance.endpoint(_);
			},
			/*			$lookup: {
				entity: "lookupX3Company",
				field: "CPY",
				parameters: "application={application}&contract={contract}&dataset={dataset}"
			},*/
			$lookup: function(_, instance) {
				if (!instance.endpoint(_)) return null;
				var baseUrl = instance.endpoint(_).getBaseUrl(_);
				return {
					$url: baseUrl + "/COMPANY?representation=COMPANY.$lookup",
					$result: "CPY"
				};
			},
			$control: function(_, instance, val) {
				if (!instance.endpoint(_)) return;
				var db = instance.endpoint(_).getOrm(_);
				var cpy = db.fetchInstance(_, db.getEntity(_, "COMPANY", "$query"), {
					jsonWhere: {
						CPY: val
					}
				});
				if (!cpy) instance.$addError(locale.format(module, "companyMissing", val, instance.endpoint(_).description(_)), "cpy");
			}
		},
		leg: {
			$type: "string",
			$isMandatory: false,
			$isDisabled: function(_, instance) {
				return !instance.endpoint(_);
			},
			$isHidden: function(_, instance) {
				return !instance.endpoint(_);
			},
			$lookup: {
				entity: "lookupX3Legislation",
				field: "LEG",
				parameters: "application={application}&contract={contract}&dataset={dataset}"
			},
			$propagate: function(_, instance, val) {
				_checkX3Values(_, instance, "lookupX3Legislation", "LEG", instance.leg(_), "leg");
			}
		},
		activ: {
			$type: "string",
			$isMandatory: false,
			$isDisabled: function(_, instance) {
				return !instance.endpoint(_);
			},
			$isHidden: function(_, instance) {
				return !instance.endpoint(_);
			},
			$lookup: {
				entity: "lookupX3ActivityCode",
				field: "CODACT",
				parameters: "application={application}&contract={contract}&dataset={dataset}"
			},
			$propagate: function(_, instance, val) {
				_checkX3Values(_, instance, "lookupX3ActivityCode", "CODACT", instance.activ(_), "activ");
			}
		},
		application: {
			$isHidden: true
		},
		contract: {
			$isHidden: true
		},
		dataset: {
			$isHidden: true
		},

	},
	$relations: {
		teams: {
			$title: "Teams",
			$type: "teams",
			$inv: "templateDocuments"
		},
		owner: {
			$title: "Owner",
			$type: "user",
			$isMandatory: false
		},
		tags: {
			$title: "Tags",
			$type: "documentTags",
			$inv: "templateDocuments"
		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: false,
			$propagate: function(_, instance, val) {
				if (val) {
					instance.application(_, val.applicationRef(_).application(_));
					instance.contract(_, val.applicationRef(_).contract(_));
					instance.dataset(_, val.dataset(_));
				} else {
					instance.application(_, "");
					instance.contract(_, "");
					instance.dataset(_, "");
				}
			},
			$lookupFilter: {
				protocol: "x3"
			}
		}
	},
	$init: function(_, instance) {
		var self = this;
		var up = globals.context && globals.context.session && globals.context.session.getUserProfile(_);
		up && instance.owner(_, up.user(_));

		var params = (((globals.context && globals.context.request && globals.context.request.context) || {}).parameters || {});
		if (params.representation) {
			var values = templatePresetValues[params.representation];
			if (values) {
				Object.keys(values).forEach_(_, function(_, key) {
					var value = values[key];
					var setter = instance[key];
					var val = value && value.replace(/\{(.*?)\}/g, function(match, p1) {
						return params[p1] || "";
					});
					if (val) instance[key](_, val);
				});
			}
		}
	},
	$events: {
		$beforeSave: [

			function(_, instance) {
				if (instance.endpoint(_)) {
					_checkX3Values(_, instance, "lookupX3Company", "CPY", instance.cpy(_), "cpy");
					_checkX3Values(_, instance, "lookupX3Legislation", "LEG", instance.leg(_), "leg");
					_checkX3Values(_, instance, "lookupX3ActivityCode", "CODACT", instance.activ(_), "activ");
				}
			}
		]
	}
};

function _checkX3Values(_, instance, entName, property, value, diagProperty) {
	if (!value || value == "") return;

	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.model.getEntity(_, entName);
	var ep = instance.endpoint(_);

	var instances = entity.$fetchInstances(_, {}, {
		"application": ep.application(_),
		"contract": ep.contract(_),
		"dataset": ep.dataset(_)
	});
	var matched = false;
	instances.forEach_(_, function(_, match) {
		if (match[property](_) == value) matched = true;
	});

	if (matched == false) {
		instance.$properties = instance.$properties || {};
		instance.$properties[diagProperty] = instance.$properties[diagProperty] || {};
		var diag = instance.$properties[diagProperty].$diagnoses = instance.$properties[diagProperty].$diagnoses || [];
		diag.push({
			severity: "error",
			message: locale.format(module, "invalidValue", value)
		});
	}
}