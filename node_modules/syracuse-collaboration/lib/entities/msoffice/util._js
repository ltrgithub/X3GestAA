"use strict";

var globals = require('streamline/lib/globals');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var flows = require('streamline/lib/util/flows');

exports.query = function(_, context, parameters, entity, facet, func) {
	var ep = _getX3EntitiesEndpoint(_, context, parameters);
	if (!ep)
		return false; 
	var handle = ep.getOrm(_);
	var entity = handle.getEntity(_, entity, facet);
	var instances = handle.fetchInstances(_, entity, {});
	flows.eachKey(_, instances, function(_, key, e) { func(_, e); });
};

function _getX3EntitiesEndpoint(_, context, parameters) {
	var up = globals.context.session.getUserProfile(_);
	var ep = up.selectedEndpoint(_);
	var application = adminHelper.getApplication(_, ep.application(_), ep.contract(_));
	if (application.protocol(_) !== "x3")
		return null;
	
	return ep;
};
