"use strict";

var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var flows = require('streamline/lib/util/flows');

exports.query = function(_, context, parameters, entity, facet, func) {
	var ep = _getX3EntitiesEndpoint(_, context, parameters);
	if (!ep)
		return false; 
	var handle = ep.getOrm(_);
	var entity = handle.getEntity(_, entity, facet);
	var instances = handle.fetchInstances(_, entity, {});
	flows.eachKey(_, instances, function(_, key, e) { func(_, e); });
};

function _getX3EntitiesEndpoint(_, context, parameters) {
	var epMatch;
	var eps = adminHelper.getEndpoints(_, {});
	epMatch = eps.filter_(_, function(_, ep) {
		return (ep.application(_) === parameters.application &&
				ep.contract(_) === parameters.contract &&
				ep.dataset(_) === parameters.dataset);
	});
	return epMatch && epMatch[0];
};
