"use strict";

var sys = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
// var translation = require("syracuse-translation/lib/translation");
// var TranslationProcess = require("syracuse-translation/lib/csvTool").TranslationProcess;
var t9n = require("syracuse-translation/lib/translation");
var TranslationProcess = t9n.TranslationProcess;
var jsurl = require("jsurl");
var helpers = require("syracuse-core/lib/helpers");

var fs = require('streamline-fs');
var fsp = require("path");
var flows = require('streamline/lib/util/flows');

var locked = false;

exports.entity = {
	$isPersistent: false,
	$canSave: false,

	$titleTemplate: "Translation",
	$descriptionTemplate: "Translation of syracuse messages and administration data",
	$valueTemplate: "{description}",
	$properties: {
		// conflictPolicy: {
		// 	$title: "Conflict policy",
		// 	$enum: [{
		// 		$value: "none",
		// 		$title: "None"
		// 	}, {
		// 		$value: "source",
		// 		$title: "Resolve using source"
		// 	}, {
		// 		$value: "target",
		// 		$title: "Resolve using target"
		// 	}, {
		// 		$value: "index",
		// 		$title: "Resolve using index"
		// 	}],
		// 	$default: "none"
		// },
		resetIndex: {
			$title: "Reset index",
			$type: "boolean"
		},
		verify: {
			$title: "Verify",
			$type: "boolean"
		},
		// log: {
		// 	$title: "Log",
		// 	// $type: "binary",
		// 	// $storage: "file",
		// 	// $isReadOnly: true,
		// 	$default: "...",
		// 	$compute: function(_, instance) {
		// 		console.log("$compute: " + instance.__data);
		// 		return instance.__data || "...";
		// 	}
		// }
	},
	$relations: {
		endpoint: {
			$title: "Production environnement endpoint",
			$description: "Select the endpoint used as reference for translation teams",
			$type: "endPoint",
			$isMandatory: true,
			$isDefined: true,
			$lookupFilter: {
				// for testing purposes, comment filter
				//protocol: "x3"
			}
		}
	},
	$services: {
		downloadLog: {
			$method: "GET",
			$isMethod: true,
			$title: "Download log",
			$type: "application/x-file",
			$execute: function(_, context, instance) {
				return {
					headers: {
						"content-type": "text/plain"
					},
					body: fs.readFile(t9n.getLogFile(), "utf8", _)
				};
			}
		},

		fromSyracuseToX3: {
			$method: "POST",
			$isMethod: true,
			$title: "Syracuse -> X3",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				try {
					instance.$diagnoses = instance.$diagnoses || [];
					if (locked) {
						throw new Error("Translation process is in progress on another session");
					}
					locked = true;
					var t = context && context.tracker,
						options = parameters || {};
					options.$diagnoses = t ? (t.$diagnoses = t.$diagnoses || []) : null;
					options.endpoint = instance.endpoint(_);

					var translation = new TranslationProcess(_, instance, options, context);
					translation.extractAll(_);
					// p.init(_, fsp.join(__dirname, "../../../translation-indexes", "translation.log"));
				} catch (e) {
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message || e
					});
				}
				locked = false;
			}
		},

		fromX3toSyracuse: {
			$method: "POST",
			$isMethod: true,
			$title: "X3 -> Syracuse",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				try {
					instance.$diagnoses = instance.$diagnoses || [];
					if (locked) {
						throw new Error("Translation process is in progress on another session");
					}
					locked = true;
					var t = context && context.tracker,
						options = parameters || {};
					options.$diagnoses = t ? (t.$diagnoses = t.$diagnoses || []) : null;
					options.endpoint = instance.endpoint(_);

					var translation = new TranslationProcess(_, instance, options, context);
					translation.updateAll(_);
				} catch (e) {
					console.log("exception: " + (e.message || e) + "\n" + e.stack);
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message || e,
						$stackTrace: e.stack
					});
				}
				locked = false;
			}
		},

		deleteAll: {
			$method: "POST",
			$isMethod: true,
			$title: "Delete all messages",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				t9n.deleteAll(_, instance);
			}
		},

		transformResourceFile: {

			$method: "POST",
			$isMethod: true,
			$title: "transformResourceFile",
			$execute: function(_) {
				var fpath = fsp.join(__dirname, "../../../syracuse-mobile/html/mobile/js/resources", "mobile-en.json");
				var newfpath = fsp.join(__dirname, "../../../syracuse-mobile/html/mobile/js/resources", "mobile1-en.json");

				function addEl(_, key, content) {
					console.log("addEl key: " + key + " content: " + content);

					keys.push(key);

					console.log("keys*********: " + JSON.stringify(keys, null, 2));

					if (typeof content === "string") {
						var newkey = keys.join('.');
						result[newkey] = content;
					} else if (typeof content === "object" && !content.length) {
						flows.eachKey(_, content, addEl);
					} else if (typeof content === "object" && content.length) {
						content.forEach_(_, function(_, el, idx) {
							addEl(_, el, el);
						});
					}

					keys.pop();
				}

				var input, parsed;
				try {
					input = fs.readFile(fpath, "utf8", _);
				} catch (ex) {
					console.log("can not read file:  " + fpath);
				}

				var result = {};
				try {
					parsed = JSON.parse(input);
				} catch (e) {
					console.log("incorrectJsonFormat ");
					return;
				}
				var keys = [];
				flows.eachKey(_, parsed, addEl);


				fs.writeFile(newfpath, JSON.stringify(result, null, 2), "utf8", _);
			}
		}
		/*,
		fromSyracuseToX3Admin: {
			$method: "POST",
			$isMethod: true,
			$title: "Admin resources, Syracuse -> X3",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				try {

					instance.$diagnoses = instance.$diagnoses || [];

					var t = context && context.tracker;
					var d = t ? (t.$diagnoses = t.$diagnoses || []) : null;
					var options = parameters || {};
					options.$diagnoses = d;
					options.endpoint = instance.endpoint(_);
					options.longMessagesStrategy = "truncate";
					options.extractAllLanguages = true;
					translation.extractAdminResources(_, instance, options, t);
					delete options.longMessagesStrategy;
					delete options.extractAllLanguages;
				} catch (e) {
					console.log("fromSyracuseToX3Admin ERROR\n" + e.stack);
				}
			}
		},
		fromX3toSyracuseAdmin: {
			$method: "POST",
			$isMethod: true,
			$title: "Admin resources, X3 -> Syracuse",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				translation.updateAdminResources(_, instance, parameters, context);
			}
		},
		fromSyracuseToX3Dotnet: {
			$method: "POST",
			$isMethod: true,
			$title: "Dotnet resources, Syracuse -> X3",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				try {

					instance.$diagnoses = instance.$diagnoses || [];

					var t = context && context.tracker;
					var d = t ? (t.$diagnoses = t.$diagnoses || []) : null;
					var options = parameters || {};
					options.$diagnoses = d;

					translation.extractDotnetResources(_, instance, options, context);
				} catch (e) {
					console.log("fromSyracuseToX3Dotnet ERROR\n" + e.stack);
				}
			}
		},
		fromX3toSyracuseDotnet: {
			$method: "POST",
			$isMethod: true,
			$title: "Dotnet resources, X3 -> Syracuse",
			$invocationMode: "async",
			$execute: function(_, context, instance, parameters) {
				try {

					instance.$diagnoses = instance.$diagnoses || [];

					var t = context && context.tracker;
					var d = t ? (t.$diagnoses = t.$diagnoses || []) : null;
					var options = parameters || {};
					options.$diagnoses = d;

					translation.updateDotnetResources(_, instance, options, context);
				} catch (e) {
					console.log("fromX3toSyracuseDotnet  ERROR\n" + e.stack);
				}
			}
		}*/
	}
};