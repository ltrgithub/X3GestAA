"use strict";
var locale = require("syracuse-core/lib/locale");

// This entity is not persistent
exports.entity = {
	$titleTemplate: "runtime log activation",
	$isPersistent: false,
	$canDelete: false,
	$canSave: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		enableLog: {
			$title: "Enable Logging",
			$type: "boolean",
			$default: false
		},
		logFlag: {
			$title: "Flags",
			$type: "integer",
			$default: 0,
			$displayLength: 10,
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			}
		},
		directory: {
			$title: "log directory",
			$type: "string",
			$default: "",
			$displayLength: 10,
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			}
		},
		dataset: {
			$title: "Dataset",
			$isExcluded: true
		}
	},
	$relations: {
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			},
			$propagate: function(_, instance, val) {
				if (val) instance.dataset(_, val.dataset(_));
				else instance.dataset(_, "");
			}
		}
	},
	$init: function(_, instance, context) {
		var runtimeCfg = context.httpSession["x3SessionConfig"] || {};
		instance.enableLog(_, !! runtimeCfg.enableLog);
		instance.logFlag(_, runtimeCfg.logFlag || 0);
	},

	$functions: {},
	$services: {
		submit: {
			$method: "POST",
			// $confirm: "This operation will change the X3 runtime configuration of all subsequent sessions.\n\nDo you want to continue ?",
			$isMethod: true,
			$title: "Submit",
			$execute: function(_, context, instance) {
				try {
					if (instance.enableLog(_)) {
						var runtimeCfg = context.httpSession["x3SessionConfig"] = (context.httpSession["x3SessionConfig"] || {});
						runtimeCfg.enableLog = instance.enableLog(_);
						runtimeCfg.logFlag = instance.logFlag(_);
						runtimeCfg.dataset = instance.endpoint(_) ? instance.endpoint(_).dataset(_) : null;
						runtimeCfg.logDir = instance.directory(_);

					} else {
						context.httpSession["x3SessionConfig"] = {};
					}
				} catch (e) {
					return {
						$diagnoses: [{
							severity: "error",
							message: e.message
						}]
					};
				}
			}
		}
	},
	$fetchInstances: function(_, context, parameters) {
		return [];
	}
};