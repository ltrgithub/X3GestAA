"use strict";
/// !doc
///
/// # Session configuration entity
///
/// This entity is not persistent.
/// Information managed by it are attached to the http session.
///
var locale = require("syracuse-core/lib/locale");

exports.entity = {
	$titleTemplate: "Runtime log activation",
	$isPersistent: false,
	$canDelete: false,
	$canSave: false,
	$autoRecreateWorkingCopy: true,
	/// ## Properties
	$properties: {
		/// * **enableLog** - *boolean*: Activates the logging for this session
		enableLog: {
			$title: "Enable Logging",
			$type: "boolean",
			$default: false
		},
		/// * **logFlag** - *integer*: Bit mask to enable various logging options
		logFlag: {
			$title: "Flags",
			$type: "integer",
			$default: 0,
			$displayLength: 10,
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			}
		},
		/// * **directory** - *string*: Directory used to store logging information
		directory: {
			$title: "Log directory",
			$type: "string",
			$default: "",
			$displayLength: 10,
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			}
		},
		dataset: {
			$title: "Dataset",
			$isExcluded: true
		}
	},
	/// ## Relations
	$relations: {
		/// * **endPoint** - Endpoint: Endpoint for which the log is activated (all endpoints if none is specified)
		///
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isHidden: function(_, instance) {
				return !instance.enableLog(_);
			},
			$propagate: function(_, instance, val) {
				if (val) instance.dataset(_, val.dataset(_));
				else instance.dataset(_, "");
			}
		}
	},
	$init: function(_, instance, context) {
		var runtimeCfg = context.httpSession["x3SessionConfig"] || {};
		instance.enableLog(_, !! runtimeCfg.enableLog);
		instance.logFlag(_, runtimeCfg.logFlag || 0);
	},

	$functions: {},
	/// ## Services
	$services: {
		/// * **submit**: Apply changes
		submit: {
			$method: "POST",
			// $confirm: "This operation will change the X3 runtime configuration of all subsequent sessions.\n\nDo you want to continue ?",
			$isMethod: true,
			$title: "Submit",
			$execute: function(_, context, instance) {
				try {
					if (instance.enableLog(_)) {
						var runtimeCfg = context.httpSession["x3SessionConfig"] = (context.httpSession["x3SessionConfig"] || {});
						runtimeCfg.enableLog = instance.enableLog(_);
						runtimeCfg.logFlag = instance.logFlag(_);
						runtimeCfg.dataset = instance.endpoint(_) ? instance.endpoint(_).dataset(_) : null;
						runtimeCfg.logDir = instance.directory(_);
						// close current syracuse session if it opened

					} else {
						context.httpSession["x3SessionConfig"] = {};
					}
				} catch (e) {
					return {
						$diagnoses: [{
							severity: "error",
							message: e.message
						}]
					};
				}
			}
		}
	},
	$fetchInstances: function(_, context, parameters) {
		return [];
	}
};