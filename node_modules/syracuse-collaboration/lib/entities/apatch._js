"use strict";

var sys = require("util");
var integrate = require("syracuse-patch/lib/integrate");
var write = require("syracuse-patch/lib/write");
var fs = require('fs');
var os = require('os');
// semaphore file
var sem = "semaphore.bbb"


			
exports.entity = {
	$isPersistent: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		data: {
			$title: "Patch data",
		},
		patchFile: {
			$title: "Patch file name",
			$default: os.tmpDir()+"/patch.dat"
		},		
		restart: {
			$title: "Automatically restart",
			$type: "boolean",
			$default: false
		}		
	},
	$titleTemplate: "Patch integration",
    $valueTemplate: "Patch integration",
    $descriptionTemplate: "Patch integration",
    $functions: {
    },
	$services: {
	    $integratePatch: {
			$method : "PUT",
			$isMethod : true,
			$title : "Integrate patch",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					var kill = true;
					fs.appendFile(sem, "A", _);
					try {
						var status = integrate.patch(".", instance.patchFile(_), {restart: instance.restart(_)}, _);
						if (status === 1) {
							instance.$diagnoses.push({severity: "info", message: "Patch already applied"});
							kill = false;							
						} else
							instance.$diagnoses.push({severity: "info", message: "OK"});
					} catch (e) {
						console.log("Error "+e);
						kill = false;
						instance.$diagnoses.push({severity: "error", message: ""+e})
					} finally {
						write.unlink(sem, _);
					}
					if (kill) {
						// kill node process		
						console.log("kill");
						process.kill(process.pid);
					}
					console.log("End");
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
	    $integrityCheck: {
			$method : "PUT",
			$isMethod : true,
			$title : "Check integrity",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						var errors = write.checkChecksumsV(".", _);
						if (errors.length > 0) {
							instance.$diagnoses.push({severity: "error", message: "Inconsistencies in working directory"});
							for (var i = 0; i < errors.length; i++) {
								instance.$diagnoses.push({severity: "error", message: errors[i]});
							}
						} else
							instance.$diagnoses.push({severity: "info", message: "Working directory OK"});
						if (write.exists(write.RELEASE_DIRECTORY, _)) {
							var errors = write.checkChecksumsV(write.RELEASE_DIRECTORY, _);
							if (errors.length > 0) {
								instance.$diagnoses.push({severity: "error", message: "Inconsistencies in release directory"});
								for (var i = 0; i < errors.length; i++) {
									instance.$diagnoses.push({severity: "error", message: errors[i]});
								}
							} else
								instance.$diagnoses.push({severity: "info", message: "Release directory OK"});							
						} else {
							instance.$diagnoses.push({severity: "info", message: "Release directory does not exist"});														
						}
					} finally {
						write.unlink(sem, _);
					}
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
	    $metaData: {
			$method : "PUT",
			$isMethod : true,
			$title : "Get version metadata",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!fs.existsSync(sem)) {
					fs.appendFile(sem, "A", _);
					try {
						var version = write.readVersionFile(".", _);
						for (var key in version)
							instance.$diagnoses.push({severity: "info", message: key+": "+version[key]});
						try {
							var relVersion = write.readVersionFile(write.RELEASE_DIRECTORY, _);
							instance.$diagnoses.push({severity: "info", message: "Release directory version: "+relVersion["relNumber"]});							
						} catch (e) {
							instance.$diagnoses.push({severity: "warning", message: "No version file in release directory"});							
						}
					} catch (e) {
						kill = false;
						instance.$diagnoses.push({severity: "error", message: "Cannot read version information "+e});						
					} finally {
						write.unlink(sem, _);
					}
				} else {
					instance.$diagnoses.push({severity: "error", message: "Semaphore exists - parallel invocation"});
					console.log("Parallel");
				}
			}
		},
		$deleteSemaphore: {
			$method : "PUT",
			$isMethod : true,
			$title : "Delete Semaphore",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				if (!write.exists(sem, _))
					instance.$diagnoses.push({severity: "warning", message: "No semaphore"});
				else {
					try {
						write.unlink(sem, _);
						instance.$diagnoses.push({severity: "info", message: "OK"});					
					} catch (e) {
						instance.$diagnoses.push({severity: "error", message: e})
						console.log("Error when deleting semaphore "+e)
					}					
				}
				console.log("Deleted2");
			}
		}
	},
};