"use strict";

var sys = require("util");
var patchcreate = require("syracuse-patch/lib/patchcreate");
var patchtools = require("syracuse-patch/lib/patchtools");
var fs = require('streamline-fs');
var os = require('os');
var config = require('syracuse-main/lib/nodeconfig').config;
var setLock = require('./patch').setLock;
var rolloutRepoValue = config.patch ? config.patch.rolloutRepo : "";
var customerImageValue = config.patch ? config.patch.customerImage : "";
var defaultPatchFile = os.tmpDir()+"/patch.dat"

function _getSha1(version, _) {
	return version ? version.rollout(_) : "";
}
			
exports.entity = {
	$isPersistent: false,
	$canDelete: false,
	$canSave: false,
	$autoRecreateWorkingCopy: true,
	$properties: {
		newPatch: {
			$type: "boolean",
			$title: "Make new patch",
			$default: true,
			$isDisabled: function(_, instance) { 
				return instance.newRelease(_)
			}
		},
		rolloutRepo: {
			$title: "Roll-out repository",
			$default: rolloutRepoValue, 
			$isReadOnly: true
		},
		customerImage: {
			$title: "CustomerImage",
			$default: customerImageValue,
			$isReadOnly: true
		},
		newRelease: {
			$type: "boolean",
			$title: "Create new release",
			$default: false
		},
		startFromRelease: {
			$type: "boolean",
			$title: "Start from release",
			$default: false			
		},
		x3Information: {
			$type: "boolean",
			$title: "Include X3 patch information",
			$default: true
		},
		newReleaseNumber: {
			$title: "New release",
            $default: "1", // ""
    		$isDisabled: function(_, instance) { 
    			return !instance.newRelease(_)
    		},
			$isMandatory: function(_, instance) { 
    			return instance.newRelease(_)
    		} 
		},
		comment: {
			$title: "Description",
			$default: "",
			$isDisabled: function(_, instance) {
				return !instance.newRelease(_) && !instance.newPatch(_);
			},
			$isLocalized: true
		},
		baseRelease: {
			$title: "Base release",
			$isDisabled: function(_, instance) {
				return instance.newRelease(_);
			}
		},
		patchFile: {
			$title: "Patch file name",
			$default: defaultPatchFile,
		},
		checkSource: {
			$title: "Check source repository",
			$type: "boolean",
			$default: true,
			$isDisabled: function(_, instance) {
				return !instance.newRelease(_) && !instance.newPatch(_);
			}
		}
	},
	$titleTemplate: "Patch creation",
    $valueTemplate: "Patch creation",
    $descriptionTemplate: "Patch creation",
    $relations: {
		versionOld: {
			$title: "Start version",
			$isDisabled: function(_, instance) {
				return instance.newRelease(_) || instance.newPatch(_) || instance.baseRelease(_) || instance.startFromRelease(_);
			},
			$type: "patchLevel",
			$inv: "patches"
		},
		versionNew: {
			$title: "End version",
			$isDisabled: function(_, instance) {
				return instance.newRelease(_) || instance.newPatch(_);
			},
			$type: "patchLevel",
			$inv: "patches"
		}
    },
    $functions: {
    },
	$services: {
	    $createPatch: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create patch",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				var setting = setLock(_, true);
				try {
					console.log("Before");
					var sha1Old = _getSha1(instance.versionOld(_), _);
					var sha1New = _getSha1(instance.versionNew(_), _);
					patchcreate.createPatch(instance.newPatch(_), instance.startFromRelease(_), instance.newRelease(_), instance.newReleaseNumber(_), instance.comment(_), instance.baseRelease(_), instance.patchFile(_), sha1Old, sha1New, instance.x3Information(_), instance.checkSource(_), _);
					console.log("After");
					instance.$diagnoses.push({severity: "info", message: "OK"});
					} catch (e) {
						console.log("Error2 "+e);
						instance.$diagnoses.push({severity: "error", message: ""+e})
				} finally {
					if (setting) setLock(_, false, setting);
				}
				console.log("End");
			}
		},
	    $customerDir: {
			$method : "PUT",
			$isMethod : true,
			$title : "Create customer image",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				var setting = setLock(_, true);
				try {
					patchcreate.createCustomerImage(config.patch, _, instance.baseRelease(_));
					instance.$diagnoses.push({severity: "info", message: "OK"});
					} catch (e) {
						instance.$diagnoses.push({severity: "error", message: ""+e})
				} finally {
					if (setting) setLock(_, false, setting);
				}
			}
		},
		$deleteSemaphore: {
			$method : "PUT",
			$isMethod : true,
			$title : "Unlock system",
			$execute : function(_, context, instance) {
				instance.$diagnoses = instance.$diagnoses || {};
				setLock(_, false);
				console.log("Unlocked");
				instance.$diagnoses.push({severity: "info", message: "OK"});
			}
		}		
	},
};
