"use strict";

var helpers = require("syracuse-core/lib/helpers");
var sys = require("util");
var factory = require("syracuse-orm/lib/factory");
var sessionManager = require('syracuse-session/lib/sessionManager').sessionManager;
var locale = require("syracuse-core/lib/locale");
var check = require('syracuse-license/lib/check');
var globals = require('streamline/lib/globals');
var depend = require("streamline-require/lib/server/depend");
var jsurl = require("jsurl");
var syracuse;


function _fromCookie() {
	try {
		var cookie = globals.context && globals.context.request && globals.context.request.headers.cookie;
		if (cookie) cookie = helpers.http.parseCookie(cookie)["user.profile"];
		return (cookie && jsurl.parse(cookie)) || {};
	} catch (e) {
		return {};
	}
}

function _pickFirst(_, candidates, validateList, force) {
	var res = null;
	candidates.some_(_, function(_, cId) {
		return cId && (res = validateList.get(_, cId));
	});
	if (!res && force) res = validateList && validateList.toArray(_)[0];
	return res;
}

function _setEndpoints(_, userProfile, role, cookieEpId) {
	var user = userProfile.user(_);
	if (!user) return;
	var userPrefs = user.preferences(_);
	//
	userProfile.endpoints(_).reset(_);
	user.getUserEndpointsList(_, role && role.$uuid).forEach_(_, function(_, ep) {
		userProfile.endpoints(_).set(_, ep);
	});
	// set selected ep
	var selEp = userProfile.selectedEndpoint(_);
	if (cookieEpId && selEp && (cookieEpId !== selEp.$uuid)) selEp = null;
	var endpoints = userProfile.endpoints(_);
	if (selEp && endpoints.get(_, selEp.$uuid)) {
		// selected endpoint is valid, leave it there
	} else {
		//userProfile.selectedEndpoint(_, null);
		userProfile.selectedEndpoint(_, _pickFirst(_, [cookieEpId, userPrefs && userPrefs.lastEndpoint(_) && userPrefs.lastEndpoint(_).$uuid], endpoints));
	}
	if (!userProfile.selectedEndpoint(_) && (endpoints.getLength() === 1)) userProfile.selectedEndpoint(_, endpoints.toArray(_)[0]);
}

exports.entity = {
	$isPersistent: false,
	$properties: {
		developpementMode: {
			$title: "Developpement mode active",
			$type: "boolean",
			$isDeveloppementFeature: true,
			$compute: function(_, instance) {
				return ((globals.context.config || {}).system || {}).enableDevelopmentFeatures || helpers.enableDeveloppementFeatures;
			}
		},
		enableTestRobot: {
			$title: "Test robot is enabled",
			$type: "boolean",
			$compute: function(_, instance) {
				return ((globals.context.config || {}).system || {}).enableTestRobot;
			}
		},
		sessionTimeout: {
			$title: "Session timeout (minutes)",
			$type: "integer",
			$isHidden: true
		},
		serverETag: {
			$title: "Server's current ETag",
			$isHidden: true,
			$compute: function(_, instance) {
				return depend.etag();
			}
		},
		authoringLevel: {
			$title: "Authoring level",
			$isHidden: true,
			$compute: function(_, instance) {
				var sp = (globals.context && globals.context.session && globals.context.session.getSecurityProfile && globals.context.session.getSecurityProfile(_));
				return (sp && sp.authoringLevel(_)) || ((((globals.context.config || {}).system || {}).enableDevelopmentFeatures || helpers.enableDeveloppementFeatures) ? "sage" : "none");
			}
		},
		sitePreferences: {
			$title: "Site preferences",
			$type: "json",
			$isHidden: true
		}
		/*		photo: {
			$title: "Photo",
			$type: "image",
			$capabilities: ""
		}*/
	},
	$relations: {
		selectedRole: {
			$title: "Role",
			$type: "role",
			$lookupFilter: {
				"$uuid": {
					"$in": "{roles}"
				}
			},
			$propagate: function(_, instance, val) {
				// refresh endpoint list / selected endpoint
				//				console.log("user profile propagate role: "+sys.inspect(val));
				_setEndpoints(_, instance, val);
				if (val && globals.context.session) globals.context.session.setSecurityProfile(val.securityProfile(_));
			},
			$serializeAll: true
		},
		roles: {
			$title: "Roles",
			$type: "roles"
		},
		selectedEndpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$lookupFilter: {
				"$uuid": {
					"$in": "{endpoints}"
				}
			},
			$serializeAll: true,
			$propagate: function(_, instance, val) {
				globals.context.session && globals.context.session.resetCache && globals.context.session.resetCache("dashboardPrototype");
			}
		},
		endpoints: {
			$title: "Endpoints",
			$type: "endPoints"
		},
		selectedLocale: {
			$title: "Locale",
			$type: "localePreference",
			$serializeAll: true,
			$lookupFilter: {
				"enabled": true
			}
		},
		user: {
			$title: "User",
			$type: "user",
			$serializeAll: true
		}
	},
	$functions: {
		toCookie: function(_) {
			var self = this;
			var ck = {};
			if (self.selectedRole(_)) ck.role = self.selectedRole(_).$uuid;
			if (self.selectedEndpoint(_)) ck.ep = self.selectedEndpoint(_).$uuid;
			if (self.selectedLocale(_)) ck.loc = self.selectedLocale(_).code(_);
			return jsurl.stringify(ck);
		},
		loadUserProfile: function(_, user, defaultLocale) {
			var self = this;
			var userPrefs = user.getPreferences(_);
			this.user(_, user);
			// load struct from cookie
			var cookieParams = _fromCookie();
			// set roles
			user.getUserRolesList(_).forEach_(_, function(_, role) {
				self.roles(_).set(_, role);
			});
			// set selected role
			self.selectedRole(_, _pickFirst(_, [cookieParams.role, userPrefs && userPrefs.lastRole(_) && userPrefs.lastRole(_).$uuid], self.roles(_), true));
			// set endpoints
			_setEndpoints(_, this, this.selectedRole(_), cookieParams.ep);
			// locales
			var localeCode = cookieParams.loc || (userPrefs && userPrefs.lastLocaleCode(_)) || defaultLocale;
			if (localeCode) this.selectedLocale(_, user.getUserLocaleByCode(_, localeCode) || user.getUserLocaleByCode(_, "en-US"));
			// Issue #2379
			if (this.selectedLocale(_) == null) {
				var locals = this._db.fetchInstances(_, this._db.model.getEntity(_, "localePreference"));
				if (locals && locals.length > 0) {
					this.selectedLocale(_, locals[0]);
				} else {
					throw new Error("No local found - localePreference entity list is empty.");
				}
			}
			this.sessionTimeout(_, sessionManager.sessionTimeout);
			this.sitePreferences(_, userPrefs && userPrefs.sitePreferences(_));
		},
		getDefaultX3Endpoints: function(_) {
			var self = this;
			if (!self.user(_) || !self.selectedRole(_)) return [];
			return self.user(_) && self.user(_).groups(_).toArray(_).filter_(_, function(_, g) {
				return (g.defaultX3Endpoint(_) && (g.role(_).$uuid === self.selectedRole(_).$uuid));
			}).map_(_, function(_, g) {
				return g.defaultX3Endpoint(_);
			});
		},
		getRepresentationPrefs: function(_, reprName, facetName) {
			var db = this._db;
			return db.fetchInstance(_, db.getEntity(_, "userRepresentationPref"), {
				jsonWhere: {
					representation: reprName,
					facet: facetName,
					user: this.user(_).$uuid
				}
			});
		},
		createRepresentationPrefs: function(_, reprName, facetName) {
			var db = this._db;
			var pref = db.getEntity(_, "userRepresentationPref").createInstance(_, db);
			pref.user(_, this.user(_));
			pref.representation(_, reprName);
			pref.facet(_, facetName);
			return pref;
		},
		$setParameters: function(_, context) {
			var self = this;
			// loads the current user profile
			this._initialize(_, context);
			// affect current user
			var user = context.getUser(_);
			if (!user) return;
			//
			this.loadUserProfile(_, user, (context.request.headers["accept-language"] || "").split(",")[0]);
			// session management
			context.setUserProfile(_, this);
			//
			if (globals.context.session) globals.context.session.userProfileCookie = self.toCookie(_);
		},
		$save: function(_, saveRes) {
			var self = this;
			var user = this.user(_);
			if (!user) return;
			// license considerations
			this.$diagnoses = this.$diagnoses || [];
			var userPrefs = user.getPreferences(_, true); //withCreate
			syracuse = syracuse || require("syracuse-main/lib/syracuse");
			var liz = check.checkConcurrent(globals.context.session, this.selectedRole(_), null, _, syracuse.getDevice(), this.$diagnoses);
			if (!liz) {
				if (userPrefs) this.selectedRole(_, userPrefs.lastRole(_)) // restore old role;
				this.$addError("No concurrent licenses left for this role");
				return;
			}
			userPrefs.lastRole(_, this.selectedRole(_));
			userPrefs.lastEndpoint(_, this.selectedEndpoint(_));
			userPrefs.sitePreferences(_, this.sitePreferences(_));
			var selLocale = this.selectedLocale(_);
			selLocale && userPrefs.lastLocaleCode(_, selLocale.code(_));
			// change locale
			locale.setCurrent(_, selLocale.code(_));
			userPrefs.save(_);
			// location
			saveRes.$links.$location = saveRes.$links.$location || {
				$title: "Menu",
				$method: "GET",
				$isHidden: true
			};
			//			var epParam = (this.selectedEndpoint(_) ? "endpoint=" + this.selectedEndpoint(_).application(_) + "." + this.selectedEndpoint(_).contract(_) + "." + this.selectedEndpoint(_).dataset(_) + "&" : "");
			//			saveRes.$links.$location.$url = "?" + epParam + "representation=home.$dashboard&role={$role}";
			saveRes.$links.$location.$url = "?representation=home.$dashboard&role={$role}";
			//
			if (globals.context.session) globals.context.session.userProfileCookie = self.toCookie(_);
			// diags
			user.getAllDiagnoses(_, saveRes.$diagnoses, {
				addEntityName: true,
				addPropName: true,
				filter: ["error", "warning"]
			});
			userPrefs.getAllDiagnoses(_, saveRes.$diagnoses, {
				addEntityName: true,
				addPropName: true,
				filter: ["error", "warning"]
			});
		},
		getAccessRightAuthorizations: function(_, endpoint) {
			var up = this;
			var selEp = endpoint || up.selectedEndpoint(_);
			if (!selEp) return null;
			// cache management
			if (up._fctRights && up._fctRights[selEp.dataset(_)]) return up._fctRights[selEp.dataset(_)];
			up._fctRights = up._fctRights || {};
			return up._fctRights[selEp.dataset(_)] = selEp.getAuthorizedAccessRight(_, up.user(_), up.selectedRole(_));
		},
		getFunctionAuthorizations: function(_, endpoint) {
			var up = this;
			var selEp = endpoint || up.selectedEndpoint(_);
			if (!selEp) return null;
			// cache management
			if (up._fctRights && up._fctRights[selEp.dataset(_)]) return up._fctRights[selEp.dataset(_)];
			up._fctRights = up._fctRights || {};
			return up._fctRights[selEp.dataset(_)] = selEp.getAuthorizedAccessRight(_, up.user(_), up.selectedRole(_));
		}

	},
	$links: function(_, instance) {
		return {
			$bookmarks: {
				$url: "{$baseUrl}/userBookmarkProxies('" + instance.user(_).$uuid + "')?representation=userBookmarkProxy.$details",
				$method: "GET"
			}
		};
	},
	$services: {
		current: {
			$isHidden: true,
			$method: "GET",
			$isMethod: false,
			$title: "Current User Profile",
			$execute: function(_, context, instance) {
				var res = {};
				var up = globals.context.session.getUserProfile(_);
				//console.log(context.session);
				if (!up) return context.reply(_, 200, res);
				res = up.serializeInstance(_);
				context.reply(_, 200, res);
			}
		},
		$logout: {
			$method: "PUT",
			$isMethod: true,
			$title: "Logout",
			$execute: function(_, context, instance) {
				sessionManager.logout(_, context.request, context.response);
				var res = instance.serializeInstance(_);
				res.$actions = res.$actions || {};
				res.$actions.$logout = {
					$isRequested: false,
					$isDisabled: true,
					$links: {
						$location: {
							// retourner a la page par d�faut du serveur
							$url: "/"
						}
					}
				};
				context.reply(_, 200, res);
			}
		}
	}
};