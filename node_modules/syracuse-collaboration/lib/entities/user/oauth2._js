"use strict";

var locale = require("syracuse-core/lib/locale");
var util = require("util");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;


exports.entity = {
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$default: "OAuth2",
			$linksToDetails: true,
			$isUnique: true,
			$pattern: "^[a-zA-Z]\\w*$",
		},
		displayName: {
			$title: "Display Name",
			$isLocalized: true
		},
		active: {
			$title: "Active",
			$type: "boolean",
			$default: true
		},
		baseSite: {
			$title: "OAuth2 server URL without path",
			$isMandatory: true
		},
		authorizePath: {
			$title: "Path for authorization",
			$default: "/oauth/authorize",
			$isMandatory: true
		},
		accessTokenPath: {
			$title: "Path to get access token",
			$isMandatory: true,
			$default: "/oauth/access_token"
		},
		clientId: {
			$title: "OAuth2 client ID",
			$isMandatory: true
		},
		clientSecret: {
			$title: "OAuth2 client secret",
			$type: "password",
			$encrypt: true,
			$isMandatory: true
		},
		scope: {
			$title: "Scope for OAuth2 requests"
		},
		batchAuthentication: {
			$title: "Batch authentication",
			$type: "boolean",
			$default: false
		},
		redirectPath: {
			$title: "Redirect path for OAuth2 server",
			$compute: function(_, instance) {
				return "/auth/oauth2/" + instance.name(_) + "/loginCallback";
			}
		},
		dataRequestURL: {
			$title: "URL for requesting user data",
			$isMandatory: true
		},
		userField: {
			$title: "User field in user name answer",
			$isMandatory: true,
			$default: "user"
		},
		image: {
			$title: "Image",
			$type: "image",
			$storage: "db_file",
			$capabilities: ""
		}
	},
	$titleTemplate: "OAuth2",
	$valueTemplate: "{name} {baseSite}",
	$descriptionTemplate: "OAuth2 server {name}",
	$helpPage: "Administration-reference_OAuth2",
	$relations: {
		users: {
			$title: "Users",
			$type: "users",
			$inv: "oauth2",
			$isComputed: true
		}
	},
	$events: {
		$canSave: [

			function(_, instance) {
				if (instance.batchAuthentication(_)) {
					// look for other instances with batch authentication: only 1 instance allowed!
					var db = adminHelper.getCollaborationOrm(_);
					// fetch OAuth2 server data
					var server = db.fetchInstance(_, db.model.getEntity(_, "oauth2"), {
						sdataWhere: 'name ne "' + instance.name(_) + '" and batchAuthentication eq true'
					});
					if (server) {
						instance.$addError(locale.format(module, "uniqueBatchAuthentication"));
						return false;
					}
				}
				return true;
			}
		],
	},
	$searchIndex: {
		$fields: ["name", "displayName", "baseSite"]
	},
	$defaultOrder: [
		["name", true]
	]
};