"use strict";

var sys = require("util");
var check = require("syracuse-license/lib/check");

exports.entity = {
	$properties: {
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isMandatory: true,
			
				$isUnique: true
			},
		explorer: {
			$title: "Explorer",
			$type: "graph",
			$format: "d3.nodeChart",
			$relations: {
				endPoints: {
					applicationRef: { $selected: false }
				},
				role: {},
				users: {}
			}
		}
	},
	$titleTemplate: "Group",
	$descriptionTemplate: "Access administration, groups associates users with roles and endpoints",
	$valueTemplate: "{description}",
	$relations: {
		endPoints: {
			$title: "Endpoints",
			$type: "endPoints",
			$inv: "groups",
			$nullOnDelete: true
		},
		parent: {
			$title: "Parent",
			$type: "group",
			$inv: "children"
		},
		children: {
			$title: "Children",
			$type: "groups",
			$inv: "parent",
			isComputed: true
		},
		users: {
			$title: "Users",
			$type: "users",
			$inv: "groups",
			isComputed: true
		},
		role: {
			$title: "Role",
			$type: "role",
			$inv: "groups"
		}
	},
	$events: {
		$beforeSave: [function(_, instance) { // named user check
			instance.$diagnoses = instance.$diagnoses || [];
		
			if (check.checkNamed(_, instance, instance.$diagnoses)) {
				// tell other servers about this change after saving
				instance.tmpLicenseChangeMarker = true;
			} else {
				if (instance.tmpLicenseChangeMarker) instance.tmpLicenseChangeMarker = null;
			}
		}],

		$afterSave: [function(_, instance) { // named user check
			if (instance.tmpLicenseChangeMarker) {
				check.propagateChange(_);
				instance.tmpLicenseChangeMarker = null;
			}
		}]
	},
	$searchIndex: {
		$fields: ["description", "endPoints", "users", "role"]
	}
};