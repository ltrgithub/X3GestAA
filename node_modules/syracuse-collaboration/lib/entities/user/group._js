"use strict";

var sys = require("util");
var check = require("syracuse-license/lib/check");

exports.entity = {
	$properties: {
		description: {
			$title: "Description",
			$linksToDetails: true,
			$isLocalized: true,
			$isMandatory: true,

			$isUnique: true
		},
		explorer: {
			$title: "Explorer",
			$type: "graph",
			$format: "d3.nodeChart",
			$relations: {
				endPoints: {
					$selected: false,
					applicationRef: {
						$selected: false
					}
				},
				role: {},
				users: {}
			}
		}
	},
	$titleTemplate: "Group",
	$descriptionTemplate: "Access administration, groups associates users with roles and endpoints",
	$helpPage: "Administration-reference-Groups",
	$valueTemplate: "{description}",
	$relations: {
		endPoints: {
			$title: "Endpoints",
			$type: "endPoints",
			$inv: "groups",
			$nullOnDelete: true
		},
		/*		parent: {
			$title: "Parent",
			$type: "group",
			$inv: "children"
		},
		children: {
			$title: "Children",
			$type: "groups",
			$inv: "parent",
			isComputed: true
		},*/
		users: {
			$title: "Users",
			$type: "users",
			$inv: "groups",
			isComputed: true
		},
		role: {
			$title: "Role",
			$type: "role",
			$inv: "groups"
		},
		defaultX3Endpoint: {
			$title: "Default X3 endpoint",
			$description: "Reference endpoint for model browse",
			$type: "endPoint",
			$nullOnDelete: true,
			$lookupFilter: {
				protocol: "x3"
			}
		}
	},
	$events: {
		$beforeSave: [
			function(_, instance) { // named user check
				instance.$diagnoses = instance.$diagnoses || [];

				if (check.checkNamed(_, instance, instance.$diagnoses)) {
					// tell other servers about this change after saving
					instance.tmpLicenseChangeMarker = true;
				} else {
					if (instance.tmpLicenseChangeMarker) instance.tmpLicenseChangeMarker = null;
				}
			}
		],

		$afterSave: [
			function(_, instance) { // named user check
				if (instance.tmpLicenseChangeMarker) {
					check.propagateChange(_);
					instance.tmpLicenseChangeMarker = null;
				}
			}
		]
	},
	$searchIndex: {
		$fields: ["description", "endPoints", "users", "role"]
	}
};