"use strict";

var locale = require('streamline-locale');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var config = require('config');

function _disabled(_, instance) {
	var endp = instance.endpoint(_);
	if (!endp) return true;
	return (endp.protocol(_) !== "x3");
}

exports.entity = {
	//	$signed: ["login", "endpoint"],
	$properties: {
		login: {
			$title: "User Login",
			$isMandatory: true,
			$displayLength: 10,
			$pattern: function(_, instance) {
				var db = adminHelper.getCollaborationOrm(_);
				var entity = db.model.getEntity(_, "user");
				var users = entity.fetchInstances(_, db, {
					jsonWhere: {
						"$factory": true,
						"$factoryOwner": "SAGE"
					}
				});
				var regexParts = [];
				users.forEach_(_, function(_, u) {
					regexParts.push(u.login(_));
				});
				return config.adminUserRestrict ? "^((?!" + regexParts.join('|') + "$).)([A-Za-z0-9_])*$" : "^[A-Za-z0-9_]*$";
			},
			$patternModifiers: "i",
			$patternMessage: !config.adminUserRestrict ? "X3 login name can only contain A to Z and 0 to 9 and underscore" : "X3 login name can only contain A to Z and 0 to 9 and underscore, and Sage factory users are protected"
		}
	},
	$titleTemplate: "{user.login}",
	$relations: {
		user: {
			$type: "user",
			$inv: "endpoints"
		},
		endpoint: {
			$type: "endPoint",
			$title: "Endpoint",
			$isMandatory: true,
			$displayLength: 15
		}
	},
	$links: function(_, instance) {
		var endpoint = instance.endpoint(_);
		if (_disabled(_, instance)) {
			return {};
		}
		var login = instance.login(_);
		if (login) login = login.toUpperCase();
		var url = endpoint.getBaseUrl(_).replace("/sdata/", "/trans/") + "/$sessions?f=GESAUS/2//M/" + login;
		var result = {
			"x3user": {
				"$url": url,
				"$method": "GET",
				"$target": "blank",
				"$title": locale.format(module, "x3user")
			}
		};
		return result;
	},
	$events: {
		$beforeSave: [

			function(_, instance) {
				// convert user login to upper case
				var login = instance.login(_);
				if (login) instance.login(_, login.toUpperCase());
			}
		],
	},

	$services: {
		createUser: {
			// $isDisabled: _disabled(_, instance),
			$method: "POST",
			$isMethod: true,
			"$parameters": {
				"$actions": {
					"$lookup": {
						"$url": "{$baseUrl}/professionCodes?representation=professionCode.$lookup&data={endpoint}~{$parent_uuid}~{$trackingId}"
					}
				},
				$properties: {
					$select: {}
				}
			},
			$title: "Create X3 user",
			$execute: function(_, context, instance, parameters) {
				// selection of the profession code is done in $fetchInstances of professionCode entity
				if (!parameters || !parameters.$select) {
					instance.$addError(locale.format(module, "noFitRoles"));
					return;
				}
				var endpoint = instance.endpoint(_);
				if (_disabled(_, instance)) {
					instance.$addError(locale.format(module, "noX3Endpoint"));
					return;
				}
				var professionCode = parameters.$select;
				instance.$diagnoses = instance.$diagnoses || [];
				var login = instance.login(_);
				if (login) login = login.toUpperCase();
				var orm = endpoint.getOrm(_);
				var ent = orm.getEntity(_, "ASYRAUS");
				// not necessary
				//var inst = orm.fetchInstance(_, ent, {
				//	jsonWhere: { "USR": login}

				// });
				// if (inst){
				//		instance.$addError(locale.format(module, "userExists", login));
				//		return;											
				//}
				var newUser = ent.createInstance(_, orm, null);
				newUser.USR(_, login);
				newUser.ENAFLG(_, instance._parent.active(_));
				newUser.ADDEML(_, instance._parent.email(_));
				var firstName = instance._parent.firstName(_);
				newUser.FIRSTNAME(_, firstName);
				var lastName = instance._parent.lastName(_);
				newUser.LASTNAME(_, lastName);
				newUser.USRCONNECT(_, true);
				newUser.CODMET(_, professionCode);
				newUser.save(_);
				newUser.getAllDiagnoses(_, instance.$diagnoses);
			}
		}
	}
};