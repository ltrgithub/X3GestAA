"use strict";
var proxy = require('syracuse-studio/lib/dbgp/proxy');

var tracer = console.log;
tracer && tracer('proxyLauncher is waiting for config');

process.on('uncaughtException', function(err) {
	tracer && tracer('proxyLauncher exception: ' + err.message + " at " + err.stack);
});
process.on('exit', function() {
	tracer && tracer('proxyLauncher exiting...');
});

process.on('message', function(m) {
	tracer && tracer('proxyLauncher got message:', JSON.stringify(m));
	if (m && m.$start) {
		try {
			tracer && tracer('proxyLauncher receive config');
			proxy.startServer(function(err, res) {
				if (err) return console.error(err);
				process.send({
					$status: "listening",
					$port: res
				});
			}, m.$start);
		} catch (e) {
			console.error(e.message);
			process.exit(1);
		}
	}
});