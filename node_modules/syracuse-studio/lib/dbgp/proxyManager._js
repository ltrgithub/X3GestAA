"use strict";
var sys = require("util");
var crypto = require('crypto');
var net = require('net');
var child_proc = require('child_process');
var streams = require('streamline/lib/streams/streams');
var helpers = require('syracuse-core/lib/helpers');
var datetime = require("syracuse-core/lib/types/datetime");
var uuid = require('syracuse-core/lib/uuid');
var jsxml = require("jsxml/lib/jsxml");
var config = require('syracuse-main/lib/nodeconfig').config;
var proxyClient = require('syracuse-studio/lib/dbgp/proxyClient');

var studioConfig = config.studio || {};
var dbgpConfig = studioConfig.dbgp || {};
var uuid = helpers.uuid;
var tracer = studioConfig.trace;

var dbgpProxy;

var oky = dbgpConfig.key || (dbgpConfig.key = "da85538b-c44c-4864-96aa-5ab5263fbf89");

var secret = (function() {
	var o = {
		k: oky
	};
	var x = 0;
	return o.k.replace(/./g, function(c) {
		return String.fromCharCode(0x21 + ((x += c.charCodeAt(0)) & 0x3f));
	});

})();

function getToken(key) {
	var md5sum = crypto.createHash('md5'),
		token = {
			"key": key,
			"date": datetime.now().toString(),
			"once": uuid.generate()
		};
	md5sum.update(token.key + '/' + token.date + '/' + token.once + '/' + secret, "ascii");
	token.signature = md5sum.digest("hex");
	return new Buffer(JSON.stringify(token)).toString('base64');
}

exports.startDbgpProxy = function _startDbgpProxy(_) {
	if (dbgpProxy && dbgpProxy.connected) {
		return {
			pid: dbgpProxy.pid,
			status: "alreadyStarted"
		};
	} else {
		// try connecting is the server has been launched by another node process
		try {
			var proxyState = _createClient().getState(_);
			if (proxyState.info.$.status === "running") {
				return proxyState.info.$;
			}
		} catch (e) {
			if (e.code != "ECONNREFUSED")
				throw e;
		}
		return _launchDbgpProxy();
	}
};

function _launchDbgpProxy() {
	dbgpProxy = child_proc.fork(
		__dirname + '/proxyLauncher.js', null, {
			env: process.env,
			// execArgv:["--debug-brk"]
		}
	);
	tracer && tracer('Start dbgp server: connected=', dbgpProxy.connected);
	dbgpProxy.on('message', function(m) {
		tracer && tracer('Syracuse server got message:', JSON.stringify(m));
	});
	dbgpProxy.send({
		$start: dbgpConfig
	});
	return {
		pid: dbgpProxy.pid,
		status: "running"
	};
}

function _createClient(port, host, token) {
	port = port || dbgpConfig.port;
	host = host || dbgpConfig.host;
	token = token || getToken(uuid.generate());
	return proxyClient.create(port, host, token);
}

exports.createClient = _createClient;