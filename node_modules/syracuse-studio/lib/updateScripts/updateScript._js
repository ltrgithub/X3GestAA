"use strict";

var helpers = require('syracuse-core').helpers;

exports.tracer = null;

var _scripts = [];
// script index MUST be target version number for this script

_scripts[1] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 1; Update security profiles");

	var coll = db.db.collection("SecurityProfile", _);
	var elts = coll.find({
		profileItems: {
			$not: {
				$elemMatch: {
					code: "development"
				}
			}
		}
	}).toArray(_);
	if (elts && elts.length > 0) {
		elts.forEach_(_, function(_, e) {
			// UPDATE
			coll.update({
				_id: e._id
			}, {
				$push: {
					profileItems: {
						"code": "development",
						"description": {
							"en-us": "Development tools",
							"de-de": "Entwicklungswerkzeuge",
							"default": "Development tools",
							"en-gb": "Development tools",
							"es-es": "Herramientas de desarrollo",
							"fr-fr": "Outils de développement",
							"it-it": "Strumenti di sviluppo",
							"pl-pl": "Narzędzia programistyczne",
							"pt-pt": "Ferramentas de desenvolvimento",
							"ru-ru": "Средства разработки",
							"zh-cn": "开发工具",
							"ar-sa": "أدوات التطوير"
						},
						"canCreate": false,
						"canRead": false,
						"canWrite": false,
						"canDelete": false,
						"canExecute": false,
						"_uuid": helpers.uuid.generate()
					}
				}
			}, {
				safe: true,
				multi: true
			}, _);
		});
	}
	exports.tracer && exports.tracer("Update script to version: 1; Update security profiles, done");
};

_scripts[2] = function(_, db) {
	exports.tracer && exports.tracer("Executing update script to version: 2; Update ADMIN profile");

	var coll = db.db.collection("SecurityProfile", _);
	var elts = coll.find({
		code: "ADMIN"
	}).toArray(_);
	if (elts && elts.length > 0) {
		elts.forEach_(_, function(_, e) {
			coll.update({
				_id: e._id,
				"profileItems.code": "development"
			}, {
				$set: {
					"profileItems.$.canCreate": true,
					"profileItems.$.canRead": true,
					"profileItems.$.canWrite": true,
					"profileItems.$.canDelete": true,
					"profileItems.$.canExecute": true
				}
			}, {
				safe: true,
				multi: true
			}, _);
		});
	}
	exports.tracer && exports.tracer("Update script to version: 2; Update ADMIN profile, done");
};

exports.initData = function(_, db) {
	exports.tracer && exports.tracer("Initializing database");
	// more if needed
};

exports.dataUpdate = function(_, db, actualVersion, targetVersion) {
	//console.log("actual=" + actualVersion + ", target=" + targetVersion);
	// force log: always
	exports.tracer = console.error;
	//
	_scripts.slice(actualVersion + 1, targetVersion + 1).forEach_(_, function(_, sequence) {
		sequence && sequence(_, db);
	});
};

// syracuse-studio/lib/updateScripts/updateScript._js
// sha1=ae9a67caeab3187223c4920a3eb73aa1161be84d
exports.metadata = {
	fileId: "ae9a67caeab3",
	// this id MUST never change and MUST be unique over all update scripts
	description: "Studio initialization" // !important, some description, optional and can change
};