"use strict";
var helpers = require('syracuse-core').helpers;
var jsxml = require('js-xml');
var uuid = require('syracuse-core').uuid;
var dbgpHelper = require('syracuse-studio/lib/pub/dbgpHelper');
var $uuid = require('./eclipseClientMock').$uuid;
var ez = require('ez-streams');

var dbgpMessageQueue = initMessageQueue();
var trace; // = console.log;

function X3ProcessMock() {}

exports.X3ProcessMock = helpers.defineClass(X3ProcessMock, null, {
	startDebug: function(_) {
		var address = dbgpHelper.getDbgpProxyAddress(_).split(":");
		this.stream = ez.devices.net.tcpClient(parseInt(address[1], 10), address[0]).connect(_);
		var q = dbgpMessageQueue,
			m;
		while ( !! (m = q.shift())) {
			this._sendPayload(_, m);
			if (q.length > 0)
				this._waitForCommand(_);
		}
		return true;
	},

	endDebug: function(_) {
		this.stream && this.stream.close(_);
		this.stream && this.stream.destroy();
		this.stream = null;
	},

	_sendPayload: function(_, data) {
		if (typeof(data) === "object")
			data = jsxml.stringify(data);
		data = [Buffer.byteLength(data, 'utf8'), data, ""].join("\0");
		try {
			trace && trace("X3 Mock send: " + data);
			this.stream.write(_, data);
		} catch (e) {
			trace && trace("X3 Mock send error: " + e.message + "\nat " + e.stack);
			this.stream && this.stream.destroy();
			this.stream = null;
			throw e;
		}
	},

	_waitForCommand: function(_) {
		try {
			var cmd = "",
				c = 0;
			while ((c = this.stream.read(_, 1, false)) && c[0] !== 0) {
				cmd += c;
			}
			trace && trace("X3 Mock receive: " + cmd);
			return cmd + "\0";
		} catch (e) {
			trace && trace("X3 Mock receive error: " + e.message + "\nat " + e.stack);
			this.stream && this.stream.destroy();
			this.stream = null;
			throw e;
		}
	}
});

function initMessageQueue() {
	return [{
			init: {
				$: {
					idekey: $uuid,
					session: $uuid,
					fileuri: "",
					thread: 1234,
					parent: "/Sage/sagedev/SUPDVLP/runtime",
					server: "AWS-X3-DEVSUP.sagefr.adinternal.com:17000/SUPERV/erbou/101007375",
					language: "X3",
					protocol_version: "1.0"
				},
				engine: {
					$: {
						version: "17r.219"
					}
				},
				author: {
					$value: "Sage"
				},
				url: {
					$cdata: "http://www.sage.com"
				},
				copyright: {
					$cdata: "Copyright (c) 2000-2014 Sage"
				},
			}
		}, {
			response: {
				$: {
					command: "feature_set",
					feature_name: "max_children",
					transaction_id: "1",
					success: "1"
				}
			}
		}, '<response command="xcmd_x3_tables_get" transaction_id="2">' + //
		'<table name="@SUPERV.FIL/APLLCK" abbreviation="ALK" file="6" key="LCKCLE" comment="Table des verrous" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ANAVIG" abbreviation="ANG" file="6" key="ANG1" comment="Navigation" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOVAL" abbreviation="ADW" file="2" key="ADW0" comment="Valeurs paramètres" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABLE" abbreviation="ATB" file="6" key="CODFIC" comment="Dictionnaire des tables" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/APLLCK" abbreviation="lck_" file="0" key="CODFIC" comment="Table des verrous" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/APLSTD" abbreviation="lan_" file="0" key="CODFIC" comment="Messages applicatif" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABZON" abbreviation="ATZ" file="6" key="NUMLIG" comment="Dictionnaire des champs" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AFONCTION" abbreviation="AFC" file="3" key="CODINT" comment="Dictionnaire des fonctions" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMENUSER" abbreviation="AMU" file="3" key="MENFCT" comment="Menu profil utilisateur" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABIND" abbreviation="ATI" file="6" key="CODIND" comment="Dictionnaire des index" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATYPE" abbreviation="ATY" file="6" key="CODTYP" comment="Types de données" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ACTIV" abbreviation="ACV" file="6" key="CODACT" comment="Codes activité" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMENLOC" abbreviation="AML" file="6" key="MENLOC" comment="Entête messages" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOSSIER" abbreviation="ADS" file="2" key="DOSSIER" comment="Table des dossiers" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AINDEX" abbreviation="ANX" file="6" key="ANX0" comment="Index spécifiques" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ACTION" abbreviation="ACT" file="6" key="ACTION" comment="Dictionnaire des actions" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOVALAUS" abbreviation="ADU" file="2" key="ADU0" comment="Valeurs paramètres utilisateur" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMSKPAR" abbreviation="AMP" file="6" key="CODPAR" comment="Paramètres action-objet" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/APLLCK" abbreviation="ALK" file="6" key="LCKCLE" comment="Table des verrous" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ANAVIG" abbreviation="ANG" file="6" key="ANG1" comment="Navigation" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOVAL" abbreviation="ADW" file="2" key="ADW0" comment="Valeurs paramètres" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABLE" abbreviation="ATB" file="6" key="CODFIC" comment="Dictionnaire des tables" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/APLLCK" abbreviation="lck_" file="0" key="CODFIC" comment="Table des verrous" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/APLSTD" abbreviation="lan_" file="0" key="CODFIC" comment="Messages applicatif" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABZON" abbreviation="ATZ" file="6" key="NUMLIG" comment="Dictionnaire des champs" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AFONCTION" abbreviation="AFC" file="3" key="CODINT" comment="Dictionnaire des fonctions" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMENUSER" abbreviation="AMU" file="3" key="MENFCT" comment="Menu profil utilisateur" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATABIND" abbreviation="ATI" file="6" key="CODIND" comment="Dictionnaire des index" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ATYPE" abbreviation="ATY" file="6" key="CODTYP" comment="Types de données" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ACTIV" abbreviation="ACV" file="6" key="CODACT" comment="Codes activité" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMENLOC" abbreviation="AML" file="6" key="MENLOC" comment="Entête messages" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOSSIER" abbreviation="ADS" file="2" key="DOSSIER" comment="Table des dossiers" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AINDEX" abbreviation="ANX" file="6" key="ANX0" comment="Index spécifiques" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ACTION" abbreviation="ACT" file="6" key="ACTION" comment="Dictionnaire des actions" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/ADOVALAUS" abbreviation="ADU" file="2" key="ADU0" comment="Valeurs paramètres utilisateur" type="ORACLE" />' + //
		'<table name="@SUPERV.FIL/AMSKPAR" abbreviation="AMP" file="6" key="CODPAR" comment="Paramètres action-objet" type="ORACLE" />' + //
		'</response>' //
	];
}