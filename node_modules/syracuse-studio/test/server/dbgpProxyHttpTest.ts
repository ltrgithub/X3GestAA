"use strict";

var os = require('os');
var dns = require('dns');
var EclipseClientMock = require('../fixtures/eclipseClientMock').EclipseClientMock;
var X3ProcessMock = require('../fixtures/x3ProcessMock').X3ProcessMock;
var config = require('config'); // must be first syracuse require
var proxyManager = require('../../lib/dbgp/proxyManager');
var dbgpHelper = require('../../lib/pub/dbgpHelper');
var apis = require('@sage/syracuse-core').apis;
var testAdmin = apis.get('test-admin');

var dbgpConfig = (config.studio || {}).dbgp || {};

import { assert } from 'chai';
Object.keys(assert).forEach(key => {
	if (key !== 'isNaN') global[key] = assert[key];
});

describe(module.id, () => {

	var port = (config.unit_test && config.unit_test.serverPort) || 3004;
	var baseurl = "http://localhost:" + port;
	var eclipse = new EclipseClientMock(baseurl, "admin", "admin");
	var x3Process = new X3ProcessMock();

	dbgpConfig.key = dbgpConfig.key || "da85538b-c44c-4864-96aa-5ab5263fbf89";
	dbgpConfig.resolveIP = true;
	dbgpConfig.resolveName = true;
	dbgpConfig.reverseIP = false;

	testAdmin.modifyCollaborationEndpoint("mongodb_admin_test");

	it('init database', function(_) {
		testAdmin.initializeTestEnvironnement(_);
		ok(true, "mongodb initialized");
	});

	it('initialize syracuse test server', function(_) {
		apis.get('test-runner').startServers(_, port);
		ok(true, "server initialized");
	});

	it('Get config', function(_) {

		var hostname = os.hostname();
		var dbgpConfigHost = dbgpConfig.host;
		var dbgpHostname = dbgpConfig.host;
		var dbgpPort = dbgpConfig.port || 9514;
		var ip4;
		var eth0 = proxyManager.networkInterfaces()[0];
		if (/\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}/.test(dbgpConfigHost))
			ip4 = dbgpConfigHost;
		else
			ip4 = proxyManager.networkInterfaces()[dbgpConfig.netInterface || 0].address || dns.lookup(dbgpConfigHost || hostname, 4, _);

		var proxyAddr = dbgpHelper.getDbgpProxyAddress(_);

		strictEqual(proxyAddr, ip4 + ":" + dbgpPort, "Proxy address: " + proxyAddr);

		var cfg = proxyManager.getConfig(_);
		strictEqual(proxyAddr, ip4 + ":" + dbgpPort, "Proxy address default config: " + proxyAddr);

		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: false
		});
		strictEqual(cfg.hostname, dbgpHostname, "Hostname after getConfig without ip resolving");

		dbgpConfig.host = "";
		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: false
		});
		strictEqual(cfg.hostname, "", "getConfig with empty host");

		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: true
		});
		strictEqual(cfg.hostname, hostname, "getConfig with empty host resolved");

		cfg = proxyManager.getConfig(_, {
			resolveIP: true,
			resolveName: false
		});
		strictEqual(cfg.hostname, "", "Hostname getConfig with empty host unresolved, ip resolved: " + JSON.stringify(cfg));
		strictEqual(cfg.ip, eth0.address, "IP after getConfig with ip resolving");

		dbgpConfig.host = "localhost";
		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: false
		});
		strictEqual(cfg.hostname, "localhost", "getConfig with localhost");

		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: true
		});
		strictEqual(cfg.hostname, hostname, "getConfig with localhost resolved");

		cfg = proxyManager.getConfig(_, {
			resolveIP: true,
			resolveName: false
		});
		strictEqual(cfg.hostname, "localhost", "Hostname getConfig with empty localhost unresolved, ip resolved");
		strictEqual(cfg.ip, eth0.address, "IP after getConfig with ip resolving");

		dbgpConfig.host = hostname;
		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: false
		});
		strictEqual(cfg.hostname, hostname, "getConfig with actual host");

		cfg = proxyManager.getConfig(_, {
			resolveIP: false,
			resolveName: true
		});
		strictEqual(cfg.hostname, hostname, "getConfig with actual host resolved");

		dbgpConfig.host = dbgpConfigHost;
	});

	it('Eclipse registering', function(_) {

		var data = eclipse.register(_);
		ok(data != null, "Registering Eclipse client");
		ok(/(already)?registered/i.exec(data.$status), "status ok");
		strictEqual(data.$uuid, eclipse.$uuid, "uuid matches");
		ok(data.$diagnoses == null, "No diagnoses");

		data = eclipse.register(_);
		ok(data != null, "Registering twice should be ok");
		ok(data.$diagnoses == null, "Still no diagnoses");

	});

	it('Eclipse get proxy state', function(_) {
		var data = eclipse.getProxyState(_);
		ok(data != null, "Getting proxy state");
		ok(data.$diagnoses == null, "No diagnoses");

	});

	it('Eclipse send proxyinit', function(_) {
		var data = eclipse.connect(_);
		console.error("eclipse.$sid=" + eclipse.$sid + ", data=" + JSON.stringify(data));
		strictEqual(eclipse.$sid, data.$sid, "same sid");
		var t = Date.now();
		data = eclipse.proxyinit(_);
		var elapse = Date.now() - t,
			m = /(\d+)\0(<proxyinit[^\0]+)\0/.exec(data);
		ok(m && m.length === 3, "proxyinit valid response format");
		ok(elapse < 100, "Response time < 100ms: " + elapse);

	});

	function log(s) {
		console.error("TEST: " + s.replace(/\0/g, "[NULL]"));
	}

	it('Start debug session', function(_) {
		var res = poll(!_);
		var loop = x3Process.startDebug(!_);
		var data = res(_),
			m = /(\d+)\0(<init[^\0]+)\0/.exec(data),
			i = 1;
		ok(m && m.length === 3, "init valid response format: " + m);

		data = eclipse.sendCommand(_, "feature_set", ["-i", i++, "-n", "max_children", "-v", "32"]);
		m = /(\d+)\0(<response command="feature_set" [^\0]+)\0/.exec(data);
		ok(m && m.length === 3, "feature_set valid response format: " + m[1] + "[NULL]" + m[2]);
		strictEqual(~~m[1], Buffer.byteLength(m[2], 'utf8'), "feature_set valid length: " + m[1]);

		data = eclipse.sendCommand(_, "xcmd_x3_tables_get", ["-i", i++]);
		m = /(\d+)\0(<response command="xcmd_x3_tables_get" [^\0]+)\0/.exec(data);
		ok(m && m.length === 3, "xcmd_x3_tables_get valid response format: " + m[1] + "[NULL]" + m[2]);
		strictEqual(~~m[1], Buffer.byteLength(m[2], 'utf8'), "xcmd_x3_tables_get valid length: " + m[1]);

		ok(loop(_), "Debug end");

		x3Process.endDebug(_);

	});

	function poll(_) {
		return eclipse.poll(_);
	}
});