"use strict";

var registry = require("syracuse-sdata/lib/sdataRegistry");

var getEndpoint = exports.getEndpoint = function(_, dataset) {
	return require('syracuse-collaboration/lib/util').getEndpoint(_, {
		application: 'syracuse',
		contract: 'support',
		dataset: dataset || "support",
	});
};
exports.getModel = function() {
	var contract = registry.getContract('syracuse', 'support');
	return contract.models.all;
};

exports.getOrm = function(_, dataset) {
	dataset = dataset || "support";	
	var ep = getEndpoint(_, dataset);
	if (!ep) throw new Error("support endpoint not found: dataset=" + dataset);
	return ep.getOrm(_);
};


exports.registerTraceEntities = function(_) {
	var db = exports.getOrm(_);
	var imports = db.fetchInstances(_, db.model.getEntity(_, "traceImport"));
	imports.forEach_(_, function(_, i) {
		if (i.analysed(_)) {
			i.registerEntity(_);
		}
	});
	
};