"use strict";

var helpers = require("syracuse-core/lib/helpers");
var locale = require("syracuse-core/lib/locale");
var ezmailer = require('ez-mailer');
var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;
var tracer = require("syracuse-trace/lib/helper").getTracer("email");

exports.entity = {
	$titleTemplate: "Notification server",
	$valueTemplate: "{code}",
	$properties: {
		code: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		},
		type: {
			$title: "Type",
			$enum: [{
				$value: "SMTP",
				$title: "SMTP"
			}],
			$default: "SMTP"
		},
		service: {
			$title: "Service",
			$isHidden: true // waiting avenger to reactivate this feature
		},
		host: {
			$title: "Mail server",
			$isMandatory: true
		},
		port: {
			$title: "Port",
			$type: "integer",
			$default: 0
		},
		secureConnection: {
			$title: "Secure connection",
			$type: "boolean",
			$default: false
		},
		clientHost: {
			$title: "Client server name",
		},
		authentication: {
			$title: "Authentication",
			$default: "none",
			$enum: [{
				$value: "none",
				$title: "No authentication"
			}, {
				$value: "password",
				$title: "Authentication with user and password"
			}]
		},
		user: {
			$title: "User",
			$isHidden: function(_, instance) {
				return instance.authentication(_) !== "password";
			}
		},
		password: {
			$title: "Password",
			$isHidden: function(_, instance) {
				return instance.authentication(_) !== "password";
			},
			$type: "password",
			$salt: "",
			$capabilities: "confirm",
			$encrypt: true
		},
		sender: {
			$title: "Sender email",
			$format: "$email",
			$isMandatory: true
		},
		idleTime: {
			$title: "Idle time",
			$type: "integer",
			$default: 10000
		},
	},
	$relations: {
		options: {
			$title: "More options",
			$type: "notificationServerOptions",
			$isChild: true
		},
		mailerTheme: {
			$title: "Default theme",
			$type: "notificationTheme"
		}
	},
	$functions: {
		notify: function(_, options) {
			if (!options.to) throw new Error(locale.format(module, "noRecipient"));

			var emailOptions = {
				from: options.from || this.sender(_),
				to: options.to,
				subject: options.subject
			};

			var themeInst, theme;
			if (!options.theme) {
				// get default theme
				themeInst = this.mailerTheme(_);
			} else {
				var db = adminHelper.getCollaborationOrm(_);
				var entity = db.getEntity(_, "notificationTheme");
				themeInst = db.fetchInstance(_, entity, {
					sdataWhere: '(name eq "' + options.theme + '")'
				});
			}

			var view = {
				title: options.subject,
				content: options.body,
				signature: options.signature || this.code(_)
			};
			if (themeInst) {
				theme = this.buildTheme(_, themeInst, view);
			}
			// merge theme properties with email options properties
			if (theme && theme.options) {
				helpers.object.merge(theme.options, emailOptions);
			}
			// set property if html is not defined
			if (!emailOptions.html) {
				emailOptions.html = options.body || options.text;
			}
			tracer.debug && tracer.debug("Notify action on '" + this.code(_) + "' configuration: " + JSON.stringify(emailOptions, null, 2));
			var mailer = ezmailer.writer(this.mailerOptions(_));
			var formatter = ezmailer.messageFormatter(emailOptions);
			mailer.writeAll(_, formatter(_, {
				view: view,
				attachments: theme && theme.attachments
			}));

			return;
		},
		// returns SMTP options in the format expected by nodemailer
		mailerOptions: function(_) {
			var secure = this.secureConnection(_);
			var service = this.service(_);
			var options = service ? {
				service: service,
				authMethod: 'LOGIN', // FOR NOW - needs to be configured
			} : {
				//name: this.clientHost(_),
				host: this.host(_),
				port: this.port(_) || (secure ? 465 : 25),
				secure: secure
			};
			var auth = options.auth = {};
			switch (this.authentication(_)) {
				case 'none':
					break;
				case 'password':
					auth.user = this.user(_);
					auth.pass = this.password(_);
					break;
			}

			var moreOpt = this.options(_).toArray(_);
			moreOpt.forEach_(_, function(_, o) {
				var val = o.value(_);
				if (val.indexOf('{') === 0 || val.indexOf('[') === 0) {
					try {
						val = JSON.parse(val);
					} catch (e) {
						console.error("Can't parse JSON for value of '" + o.key(_) + "': " + e.safeStack);
					}
				}
				options[o.key(_)] = val;
			});

			//console.error("Options: " + JSON.stringify(options, null, 2));
			return options;
		},
		buildTheme: function(_, theme, view) {

			var result = {
				view: view
			};

			result.options = {
				html: theme.html(_)
			};

			theme.images(_).toArray(_).forEach_(_, function(_, img) {
				var fName = img.name(_);
				var fContent = img.file(_);
				if (fContent.fileExists(_)) {
					var b64 = fContent.createReadableStream(_).readAll(_);
					result.options.attachments = result.options.attachments || [];
					result.options.attachments.push({
						filename: fName,
						content: b64.toString("base64"),
						encoding: 'base64',
						cid: fName + '@img'
					});
				}
			});
			return result;
		}
	},
	$services: {
		test: {
			$method: "post",
			$title: "Test configuration",
			$isMethod: true,
			$parameters: {
				$properties: {
					"email": {
						$title: "Recipient Email address",
						$description: "Address which should be used to send test email",
						$type: "application/x-string",
						$value: "",
						$isMandatory: true,
					}
				}
			},
			$execute: function(_, context, instance, parameters) {
				if (!parameters) {
					parameters = context.parameters;
				}
				if (!parameters.email) {
					instance.$addError(locale.format(module, "noRecipient"));
					return;
				}
				instance.$diagnoses = instance.$diagnoses || [];
				try {
					var title = locale.format(module, "testMailTitle");
					var text = "The notification server configuration is OK";
					var sig = "Notification server tester";

					instance.notify(_, {
						to: parameters.email,
						subject: title,
						body: text,
						signature: sig
					});

					instance.$diagnoses = instance.$diagnoses || [];
					instance.$diagnoses.push({
						$severity: "info",
						$message: "Test Mail sent successfully",
					});
				} catch (e) {
					console.error("Sending mail error: " + e.stack);
					instance.$diagnoses.push({
						$severity: "error",
						$message: e.message + (e.response ? " - " + e.response : ""),
						$stackTrace: e.safeStack
					});
				}
			}
		}
	}
};

exports.optEntity = {
	$titleTemplate: "Notification server options",
	$valueTemplate: "{key}:{value}",
	$properties: {
		key: {
			$title: "Key",
			$isMandatory: true,
			$isUnique: true
		},
		value: {
			$title: "Value",
			$isMandatory: true,
			$isUnique: true
		},
	}
};