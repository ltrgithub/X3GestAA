
# Syracuse Mail API  
This API module allows to send email through notification server configured on Syracuse environment.  
To use this module do `var mailer = require('syracuse-email/lib/mailer')`.  
All the methods are asynchronous.  


-------------
## send :
``` javascript
mailer.send(_, data, options);  
```
It allows to send email using (or not) notification themes defined into Syracuse.  

* **data** defines the mail content (see [e-mail message fields](#e-mail-message-fields) below)
* **options** allows to use specific notification server and/or theme.  
`options` can contain the following properties :  
    * server : `String`. The notification server code. If not set, the notification server set on global settings will be used.  
    * noTheme : `Boolean`. Must be set to true if no theme is wanted.  
    * theme : `String`. The notification theme's name to use.  
    * view : `JSON object`. This object represents the data that would be used to replace the theme's mustache variables.  

Example 1: To send an email without theme  

``` javascript
   var options = {  
        server: "GmailConf",  // Needs that `GmailConf` configuration exists in notification servers
        noTheme: true // with this flag raw email will be sent with `text` or `html` content set into `data` 
   }
```  

Example 2:  

``` javascript
   var options = {  
        server: "Office365Conf",  // Needs that `Office365Conf` configuration exists in notification servers
        theme: "MyCustomTheme" // to use the custom theme 'MyCustomTheme' defined in notification themes
        // view is used to replace Mustache variables set in the template
        view: {
           var1: "Value 1 to display in email", // Mustache variable {{var1}} must be defined in the template 'MyCustomTheme'
           var2: "Value 2 to display in email" // Mustache variable {{var2}} must be defined in the template 'MyCustomTheme'
        }
   }
```    

### E-mail message fields

The following are the possible fields of an e-mail message:

  - **from** - The e-mail address of the sender. All e-mail addresses can be plain `'sender@server.com'` or formatted `'Sender Name <sender@server.com>'`, see [here](#address-formatting) for details
  - **sender** - An e-mail address that will appear on the *Sender:* field
  - **to** - Comma separated list or an array of recipients e-mail addresses that will appear on the *To:* field
  - **cc** - Comma separated list or an array of recipients e-mail addresses that will appear on the *Cc:* field
  - **bcc** - Comma separated list or an array of recipients e-mail addresses that will appear on the *Bcc:* field
  - **replyTo** - An e-mail address that will appear on the *Reply-To:* field
  - **inReplyTo** - The message-id this message is replying
  - **references** - Message-id list (an array or space separated string)
  - **subject** - The subject of the e-mail
  - **text** - The plaintext version of the message as an Unicode string, Buffer, Stream or an object *{path: '...'}*
  - **html** - The HTML version of the message as an Unicode string, Buffer, Stream or an object *{path: '...'}*
  - **watchHtml** - Apple Watch specific HTML version of the message (*experimental*)
  - **headers** - An object or array of additional header fields (e.g. *{"X-Key-Name": "key value"}* or *[{key: "X-Key-Name", value: "val1"}, {key: "X-Key-Name", value: "val2"}]*)
  - **attachments** - An array of attachment objects  (see [below](#attachments) for details)
  - **alternatives** - An array of alternative text contents (in addition to text and html parts)  (see [below](#alternatives) for details)
  - **envelope** - optional SMTP envelope, if auto generated envelope is not suitable (see [below](#smtp-envelope) for details)
  - **messageId** - optional Message-Id value, random value will be generated if not set
  - **date** - optional Date value, current UTC string will be used if not set
  - **encoding** - optional transfer encoding for the textual parts

All text fields (e-mail addresses, plaintext body, html body) use UTF-8 as the encoding.
Attachments are streamed as binary.

### Attachments

Attachment object consists of the following properties:

  * **filename** - filename to be reported as the name of the attached file, use of unicode is allowed
  * **cid** - optional content id for using inline images in HTML message source
  * **content** - String, Buffer or a Stream contents for the attachment
  * **encoding** - If set and `content` is string, then encodes the content to a Buffer using the specified encoding. Example values: `base64`, `hex`, 'binary' etc. Useful if you want to use binary attachments in a JSON formatted e-mail object.
  * **path** - path to a file or an URL (data uris are allowed as well) if you want to stream the file instead of including it (better for larger attachments)
  * **contentType** - optional content type for the attachment, if not set will be derived from the `filename` property
  * **contentDisposition** - optional content disposition type for the attachment, defaults to 'attachment'

Attachments can be added as many as you want.

```javascript
var mailOptions = {
    ...
    attachments: [
        {   // utf-8 string as an attachment
            filename: 'text1.txt',
            content: 'hello world!'
        },
        {   // binary buffer as an attachment
            filename: 'text2.txt',
            content: new Buffer('hello world!','utf-8')
        },
        {   // file on disk as an attachment
            filename: 'text3.txt',
            path: '/path/to/file.txt' // stream this file
        },
        {   // filename and content type is derived from path
            path: '/path/to/file.txt'
        },
        {   // stream as an attachment
            filename: 'text4.txt',
            content: fs.createReadStream('file.txt')
        },
        {   // define custom content type for the attachment
            filename: 'text.bin',
            content: 'hello world!',
            contentType: 'text/plain'
        },
        {   // use URL as an attachment (!!!does not work if http proxy is necessary !!!)
            filename: 'license.txt',
            path: 'https://raw.github.com/andris9/Nodemailer/master/LICENSE'
        },
        {   // encoded string as an attachment
            filename: 'text1.txt',
            content: 'aGVsbG8gd29ybGQh',
            encoding: 'base64'
        },
        {   // data uri as an attachment
            path: 'data:text/plain;base64,aGVsbG8gd29ybGQ='
        }
    ]
}
```

### Alternatives

In addition to text and HTML, any kind of data can be inserted as an alternative content of the main body - for example a word processing document with the same text as in the HTML field. It is the job of the e-mail client to select and show the best fitting alternative to the reader. Usually this field is used for calendar events and such.

Alternative objects use the same options as [attachment objects](#attachments). The difference between an attachment and an alternative is the fact that attachments are placed into *multipart/mixed* or *multipart/related* parts of the message white alternatives are placed into *multipart/alternative* part.

**Usage example:**

```javascript
var mailOptions = {
    ...
    html: '<b>Hello world!</b>',
    alternatives: [
        {
            contentType: 'text/x-web-markdown',
            content: '**Hello world!**'
        }
    ]
}
```

Alternatives can be added as many as you want.

### Address Formatting

All the e-mail addresses can be plain e-mail addresses

```
foobar@blurdybloop.com
```

or with formatted name (includes unicode support)

```
"Ноде Майлер" <foobar@blurdybloop.com>
```

> Notice that all address fields (even `from`) are comma separated lists, so if you want to use a comma in the name part, make sure you enclose the name in double quotes: `"Майлер, Ноде" <foobar@blurdybloop.com>`

or as an address object (in this case you do not need to worry about the formatting, no need to use quotes etc.)

```
{
    name: 'Майлер, Ноде',
    address: 'foobar@blurdybloop.com'
}
```

All address fields accept comma separated list of e-mails or an array of
e-mails or an array of comma separated list of e-mails or address objects - use it as you like.
Formatting can be mixed.

```
...,
to: 'foobar@blurdybloop.com, "Ноде Майлер" <bar@blurdybloop.com>, "Name, User" <baz@blurdybloop.com>',
cc: ['foobar@blurdybloop.com', '"Ноде Майлер" <bar@blurdybloop.com>, "Name, User" <baz@blurdybloop.com>'],
bcc: ['foobar@blurdybloop.com', {name: 'Майлер, Ноде', address: 'foobar@blurdybloop.com'}]
...
```

You can even use unicode domains, these are automatically converted to punycode

```

'"Unicode Domain" <info@müriaad-polüteism.info>'
```

### SMTP envelope

SMTP envelope is usually auto generated from `from`, `to`, `cc` and `bcc` fields but
if for some reason you want to specify it yourself, you can do it with `envelope` property.

`envelope` is an object with the following params: `from`, `to`, `cc` and `bcc` just like
with regular mail options. You can also use the regular address format, unicode domains etc.

```javascript
mailOptions = {
    ...,
    from: 'mailer@kreata.ee',
    to: 'daemon@kreata.ee',
    envelope: {
        from: 'Daemon <deamon@kreata.ee>',
        to: 'mailer@kreata.ee, Mailer <mailer2@kreata.ee>'
    }
}
```

> Not all transports can use the `envelope` object, for example SES ignores it and uses the data from the From:, To: etc. headers.

### Using Embedded Images

Attachments can be used as embedded images in the HTML body. To use this feature, you need to set additional property of the attachment - `cid` (unique identifier of the file) which is a reference to the attachment file. The same `cid` value must be used as the image URL in HTML (using `cid:` as the URL protocol, see example below).

**NB!** the cid value should be as unique as possible!

```javascript
var mailOptions = {
    ...
    html: 'Embedded image: <img src="cid:unique@kreata.ee"/>',
    attachments: [{
        filename: 'image.png',
        path: '/path/to/file',
        cid: 'unique@kreata.ee' //same cid value as in the html img src
    }]
}
```


## Full Examples

### With theme

``` javascript
require("syracuse-email/lib/mailer").send(_, {
	to: "someone@yourcompany.com",
	from: "someoneelse@yourcompany.com",
	subject: "Test sending email",
	attachments: [{
	      "filename": "sage.jpg",
	      "content": "/9j/4QAYRXhpZgAASUkqAAgAAAAAAAAAAAAAAP/sABFEdWNreQABAAQAAABGAAD/4QMpaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLwA8P3hwYWNrZXQgYmVnaW49Iu+7vyIgaWQ9Ilc1TTBNcENlaGlIenJlU3pOVGN6a2M5ZCI/PiA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJBZG9iZSBYTVAgQ29yZSA1LjAtYzA2MCA2MS4xMzQ3NzcsIDIwMTAvMDIvMTItMTc6MzI6MDAgICAgICAgICI+IDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+IDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiIHhtbG5zOnhtcD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wLyIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bXA6Q3JlYXRvclRvb2w9IkFkb2JlIFBob3Rvc2hvcCBDUzUgV2luZG93cyIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDoxQTk1NTZCQjlEMzcxMUUyQjQ4QkZCRTZCRDQ1MzdGNiIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDoxQTk1NTZCQzlEMzcxMUUyQjQ4QkZCRTZCRDQ1MzdGNiI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjFBOTU1NkI5OUQzNzExRTJCNDhCRkJFNkJENDUzN0Y2IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjFBOTU1NkJBOUQzNzExRTJCNDhCRkJFNkJENDUzN0Y2Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+/+4ADkFkb2JlAGTAAAAAAf/bAIQABAMDAwMDBAMDBAYEAwQGBwUEBAUH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",
	      "encoding": "base64",
     }]
}, {
	view: {
		title: "Test Syracuse email API",
		content: "Hello,<br>This is a test email.",
		signature: "Syracuse system",
		info: {
			date: {
				label: "Date",
				value: new Date()
			}
		}
	}
});
```

### Without theme

``` javascript
require("syracuse-email/lib/mailer").send(_, {
	to: "someone@yourcompany.com",
	from: "someoneelse@yourcompany.com",
	subject: "Test sending email",
    html: "<div>Hello</div>"
}, {
    noTheme: true
});
```
