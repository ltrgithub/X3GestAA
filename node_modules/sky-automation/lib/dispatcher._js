'use strict';

var adminHelper = require('syracuse-collaboration/lib/helpers').AdminHelper;
var ez = require('ez-streams');
var ezmongo = require('ez-mongodb');

// dispatcher for health log requests sent to /healthLogs/dataset
// where dataset identifies the sky-automation endpoint / mongo database
exports.dispatcher = function(_, request, response) {
	if (request.method !== 'POST') throw new Error('invalid method: ' + request.method);
	var dataset = request.url.split('/')[2];

	var ep = adminHelper.getEndpoint(_, {
		jsonWhere: {
			application: 'sky',
			contract: 'automation',
			dataset: dataset
		}
	});
	if (ep === null) throw new Error('invalid dataset: ' + dataset);
	var orm = ep.getOrm(_);
	orm.connect(_);
	var collection = orm.db.collection('healthLogs', _);
	ez.reader.decorate(request).transform(ez.transforms.json.parser()).pipe(_, ezmongo.writer(collection));
	response.writeHead(200, {
		'content-type': 'application/json'
	});
	response.end('{}', 'utf8');
};
