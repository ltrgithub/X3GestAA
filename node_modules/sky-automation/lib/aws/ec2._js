'use strict';

var config = require('config');
var AWS = require ('aws-sdk');
var ec2 = new AWS.EC2();

AWS.config.update(config.aws);
var ec2 = new AWS.EC2({apiVersion: '2014-06-15'});

exports.getInstanceTagsFromIP = function(_, instanceIP) {
  var params = {
    Filters: [
      {
        Name: 'private-ip-address',
        Values: [
          instanceIP,
        ]
      },
    ],
  };
  if(config.skyAutomation.vpcId) {
      params.Filters.push({
        Name: 'vpc-id',
        Values: [
          config.skyAutomation.vpcId,
        ]
    });
  }
  var data = ec2.describeInstances(params, ~_);
  if (data && data.Reservations[0])
  	return data.Reservations[0].Instances[0].Tags;
  else
  	throw Error("Instance not found, please check IP address");
};

exports.getInstanceNameFromTags = function(_, tags) {
	var filtered = tags.filter(filterByName);
	if (filtered.length > 0)
		return filtered[0].Value;
	else
		throw Error("Instance does not contain tag key 'Name'")
};

function filterByName(tag) {
	if (tag.Key === 'Name')
		return tag;
}