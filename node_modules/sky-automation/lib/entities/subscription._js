'use strict';

var check = require('syracuse-license/lib/check');
var helpers = require('../helpers');
var hibernate = require('../../scripts/hibernate');

module.exports = {
	$titleTemplate: 'Subscription {site}',
	$helpPage: 'SKY-reference-subscription',
	$createActionTitle: 'New subscription',
	$listTitle: 'List of Subscriptions',
	$properties: {
		valid: {
			$title: 'Valid',
			$isReadOnly: true,
			$type: 'boolean'
		},
		current: {
			$title: 'Current',
			$isReadOnly: true,
			$type: 'boolean'
		},
		license: {
			$title: 'License',
			$type: 'object'
		},
		hibernate: {
			$title: 'Hibernate',
			$type: 'object'
		},
	},
	$relations: {
		site: {
			$title: 'Site',
			$type: 'site',
			$inv: 'subscriptions',
			$isMandatory: true,
		},
	},
	$events: {
		$beforeSave: [

			function(_, instance) {
				check._preParseLicenses([JSON.stringify(instance.license(_))]);
				instance.valid(_, true);
			}
		],
		$afterSave: [

			function(_, instance) {
				if (instance.site(_).status === "active") {
					this.upload(_);
				}
				if (instance.hibernate(_) && instance.hibernate(_).enabled) {
					var instanceTags = instance.hibernate(_).tags;
					hibernate.validateTags(instanceTags);
					hibernate.updateToGMT(instanceTags);
					var ipX3 = instance.site(_).ipX3(_);
					hibernate.getInstanceIdFromIP(ipX3, function(instanceID) {
						hibernate.createInstanceTags(instanceID, instanceTags);
					});
					var ipORA = instance.site(_).ipORA(_);
					hibernate.getInstanceIdFromIP(ipORA, function(instanceID) {
						hibernate.createInstanceTags(instanceID, instanceTags);
					});
				}
			}
		],
	},
	$functions: {
		upload: function(_) {
			var self = this;
			helpers.client(_, self.site(_).uri(_) + '/nannyCommand/notifyOne/license/set', self.license(_), 'PUT');
			self.current(_, true);
		}
	},
};
