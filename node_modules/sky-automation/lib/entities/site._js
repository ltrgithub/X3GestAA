'use strict';

var fs = require('streamline-fs');
var fsp = require('path');
var helpers = require('../helpers');
var health = require('syracuse-health/lib/check');
var alerts = require('syracuse-health/lib/alerts');
var sei = require('../services/activateSEI');
var patch = require('../services/patch');
var ez = require('ez-streams');
var mongo = require('streamline-mongodb');
var config = require('config');
var hibernate = require('../../scripts/hibernate');

module.exports = {
	$titleTemplate: 'Site {customer} {site}',
	$helpPage: 'SKY-reference-site',
	$createActionTitle: 'New site',
	$listTitle: 'List of Sites',
	$properties: {
		site: {
			$title: 'Site',
			$isMandatory: true,
			$linksToDetails: true,
		},
		shortName: {
			$title: 'Short Name',
			$isMandatory: true,
		},
		accountNumber: {
			$title: 'Account Number'
		},
		isDefault: {
			$title: 'Default site',
			$type: 'boolean',
			$default: false,
		},
		status: {
			$title: 'Status',
			$isReadOnly: true,
			$default: 'created',
		},
		uri: {
			$title: 'Site URI',
			$isReadOnly: true,
		},
		ipX3: {
			$title: 'IP of X3 instance',
			$isReadOnly: true,
		},
		ipORA: {
			$title: 'IP of Oracle instance',
			$isReadOnly: true,
		},
		isTest: {
			$title: 'Test site',
			$type: 'boolean',
			$default: false,
			$isHidden: true,
		},
		country: {
			$title: 'Country',
		},
		hibEnabled: {
			$title: 'Enabled',
			$type: 'boolean'
		},
		hibStart: {
			$title: 'Start'
		},
		hibStop: {
			$title: 'Stop'
		},
		hibDaysToLive: {
			$title: 'Days to live'
		},
		hibOffset: {
			$title: 'Time Offset'
		},
		opa: {
			$title: 'OPA',
			$type: 'boolean',
			$default: false,
		},
	},
	$relations: {
		customer: {
			$title: 'Customer',
			$type: 'customer',
			$inv: 'sites',
			$isMandatory: true,
		},
		subscriptions: {
			$title: 'Subscriptions',
			$type: 'subscriptions',
			$inv: 'site',
			$isComputed: true,
		},
		contacts: {
			$title: 'Contacts',
			$type: 'contacts',
			$inv: 'sites',
			$isComputed: true
		},
	},
	$searchIndex: {
		$fields: ['site']
	},
	$uniqueConstraints: [
		['customer', 'site']
	],
	$functions: {},
	$services: {
		provision: {
			$title: 'Provision',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'provision';
				setStatus(_, context, instance, service);
			},
		},
		activate: {
			$title: 'Activate',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'activate';
				setStatus(_, context, instance, service);
			}
		},
		createAlerts: {
			$title: 'Create Alerts',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				alerts.createAlerts(_, instance);
			},
		},
		suspend: {
			$title: 'Suspend',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'suspend';
				setStatus(_, context, instance, service);
			}
		},
		shelve: {
			$title: 'Shelve',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'shelve';
				setStatus(_, context, instance, service);
			}
		},
		restore: {
			$title: 'Restore',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'restore';
				setStatus(_, context, instance, service);
			}
		},
		'delete': {
			$title: 'Delete',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'delete';
				setStatus(_, context, instance, service);
			}
		},
		activateSEI: {
			$title: 'SEI Site Activation',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				sei.activate(_, context, instance);
			},
		},
		siteHealth: {
			$title: 'Check site health',
			$method: 'GET',
			$isMethod: true,
			$isHidden: true,
			$execute: function(_, context, instance) {
				return health.getSiteHealth(_, context, instance);
			},
		},
		health: {
			$title: 'Health all sites',
			$method: 'GET',
			$isHidden: true,
			$execute: function(_, context) {
				return health.getHealth(_, context);
			},
		},
		siteX3Usage: {
			$title: 'Check site usage metrics',
			$method: 'GET',
			$isMethod: true,
			$isHidden: true,
			$execute: function(_, context, instance) {
				return health.getSiteUsage(_, context, instance, 'x3');
			},
		},
		x3Usage: {
			$title: 'Usage Metrics all sites',
			$method: 'GET',
			$isHidden: true,
			$execute: function(_, context) {
				return health.getUsage(_, context, 'x3');
			},
		},
		siteDbUsage: {
			$title: 'Check site usage metrics',
			$method: 'GET',
			$isMethod: true,
			$isHidden: true,
			$execute: function(_, context, instance) {
				return health.getSiteUsage(_, context, instance, 'db');
			},
		},
		dbUsage: {
			$title: 'Usage Metrics all sites',
			$method: 'GET',
			$isHidden: true,
			$execute: function(_, context) {
				return health.getUsage(_, context, 'db');
			},
		},
		update: {
			$title: 'Update',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				updateHibernate(_, context, instance);
			},
		},
		patch: {
			$title: 'Apply X3 patch',
			$method: 'GET',
			$isMethod: true,
			$execute: function(_, context, instance) {
				return patch.applyPatch(_, context, instance);
			},
		},
		siteList: {
			$title: 'Get list of sites',
			$method: 'GET',
			$isHidden: true,
			$execute: function(_, context) {
				return getSites(_, context);
			},
		},
		maintenance: {
			$title: 'Maintenance',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'maintenance';
				setStatus(_, context, instance, service);
			}
		},
		interruption: {
			$title: 'Interruption',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'interruption';
				setStatus(_, context, instance, service);
			}
		},
		resume: {
			$title: 'Resume',
			$method: 'POST',
			$invocationMode: 'async',
			$capabilities: 'abort',
			$isMethod: true,
			$execute: function(_, context, instance) {
				var service = 'resume';
				setStatus(_, context, instance, service);
			}
		},
	},
	$events: {
		$beforeSave: [
			function(_, instance) {
				if (instance.country(_)) {
					var siteCountries = config.siteCountries || {};
					var listOfCountries = siteCountries.list || [];

					if (listOfCountries.indexOf(instance.country(_)) === -1)
						throw new Error('Country does not exist. Please enter one of the following:\n' + listOfCountries);
				}
				instance.site(_, codify(instance.site(_)));
				instance.shortName(_, codify(instance.shortName(_).toLowerCase()));

				if (instance.hibEnabled(_)) {
					var instanceTags = [];
					instanceTags.push(instance.hibStart(_));
					instanceTags.push(instance.hibStop(_));
					instanceTags.push(instance.hibDaysToLive(_));
					instanceTags.push(instance.hibOffset(_));
					hibernate.validateTags(instanceTags);
					hibernate.updateToGMT(instanceTags);
				} else {
					instance.hibEnabled(_, false);
					instance.hibStart(_, '');
					instance.hibStop(_, '');
					instance.hibDaysToLive(_, '');
					instance.hibOffset(_, '');
				}
			}
		],
		$afterSave: [
			function(_, instance) {
				if (instance.hibEnabled(_) && instance.status(_) === 'active') {
					var hib = {
						start: instance.hibStart(_),
						stop: instance.hibStop(_),
						daystolive: instance.hibDaysToLive(_)
					};
					var ipX3 = instance.ipX3(_);
					hibernate.getInstanceIdFromIP(ipX3, function(instanceID) {
						hibernate.createInstanceTags(instanceID, hib);
					});
					var ipORA = instance.ipORA(_);
					hibernate.getInstanceIdFromIP(ipORA, function(instanceID) {
						hibernate.createInstanceTags(instanceID, hib);
					});
				}
			}
		],
	},
};

function codify(str) {
	return str.replace(/[^\w]/gi, '').toLowerCase();
}

function setStatus(_, context, instance, service) {
	helpers.tracker = context.tracker;
	helpers.log('I-phase: Service process started:', service);
	var site = codify(instance.site(_));
	var customer = codify(instance.customer(_).customer(_));
	var shortName = codify(instance.shortName(_).replace(/ /g,'').toLowerCase());

	/**
	 * provision: changes the status from created to provisioned.
	 * activate: changes the status from provisioned, hibernating or suspended to active.
	 * suspend: changes the status from active, hibernating or provisioned to suspended.
	 * shelve: changes the status from suspended to shelved.
	 * restore: changes the status from shelved to suspended.
	 * delete: changes the status from suspended, shelved, created, provisioned to deleted.
	 */
	var statusMap = {
		'provision': {
			curr: ['created'],
			next: 'provisioned',
			params: {
				customer: customer,
				site: site,
				stack: shortName,
			},
			postOp: function(_, context, instance) {
				var collection = context.db.db.collection('Site', _);
				//Thought we needed a regular expression expecting instance.site(_) to be all lower case.
				//However, that is not the case at this point so going to a straight find on mongodb.
				//var cursor = collection.find(  {site: { $regex: new RegExp('^' + instance.site(_) + '$', 'i') }} ).toArray(_);
				var cursor = collection.find( {site:instance.site(_)} ).toArray(_);
				instance.uri(_, cursor[0].uri);
				instance.ipX3(_, cursor[0].ipX3);
				instance.ipORA(_, cursor[0].ipORA);
			},
		},
		'activate': {
			curr: ['provisioned', 'hibernating', 'suspended'],
			next: 'active',
			params: instance.status(_) === 'provisioned' ? null : {
				stack: shortName,
			},
			postOp: require('../services/activate'),
		},
		'suspend': {
			curr: ['active', 'hibernating', 'provisioned'],
			next: 'suspended',
			params: {
				stack: shortName,
			},
		},
		'shelve': {
			curr: ['suspended'],
			next: 'shelved',
			params: {
				stack: shortName,
			},
			postOp: require('../services/delete'),
		},
		'restore': {
			curr: ['suspended'],
			next: 'active',
			params: {
				stack: shortName,
			},
		},
		'delete': {
			curr: ['suspended', 'shelved', 'created', 'provisioned'],
			next: 'deleted',
			postOp: require('../services/delete'),
		},
		'maintenance': {
			curr: ['active'],
			next: 'maintenance',
		},
		'interruption': {
			curr: ['active'],
			next: 'interruption',
		},
		'resume': {
			curr: ['maintenance', 'interruption'],
			next: 'active',
		},
	};

	if (!statusMap[service] || statusMap[service].curr.indexOf(instance.status(_)) === -1)
		throw new Error('Invalid status change!');

	// call to ops for service
	if (statusMap[service].params && !instance.isTest(_)) helpers.ops(_, service, statusMap[service].params);

	if (statusMap[service].postOp) statusMap[service].postOp(_, context, instance);

	instance.status(_, statusMap[service].next);
	instance.save(_);
	helpers.log('I-phase: Service process completed:', service);
	if (service === 'provision' && instance.opa(_)) {
	    // Activate site after completing provisioning
	    console.log("INSTANCE PROVISIONED");
	    setStatus(_, context, instance, 'activate');
	}
}

var temp = 0;
function updateHibernate(_, context, instance) {
	var baseHost = "http://localhost:8124";
	var path = context.request.url.substring(0, context.request.url.indexOf('sites'));

	var listOfSubs = instance.subscriptions(_)._array;
	var filtered = listOfSubs.filter(filterArrayByDate);
	var mostRecentSub = filtered[0].$key;

	var collabUrl = baseHost + path + "subscriptions(\'" + mostRecentSub + "\')";
	var hibernateData = context.request.readAll(_);

	var resp = ez.devices.http.client({
		rejectUnauthorized: false,
		url: collabUrl,
		method: 'PUT',
		headers: {
			Authorization: 'Basic YWRtaW46YWRtaW4=',
			'content-type': 'application/json',
		}
	}).end(hibernateData).response(_);

	if (resp.statusCode !== 200){
		helpers.error('Error managing subscription');
		return;
	}
}

function filterArrayByDate(element, index, array) {
	if (array.length === 1)
		temp = element;
	
	if(index !== 0) {
		if (element.$creDate > array[index-1].$creDate)
			temp = element;
	}

	if (index === (array.length-1))
		return temp;
}

function getSites(_, context){
	var collection = context.db.db.collection('Site', _);
	var cursor = collection.find( {} ).toArray(_);
	var sites = [];
	var siteList = {};
	var site = '';
	siteList.sites = sites;
	for (var i = 0; i < cursor.length; i++) {
		var site = {
			'id': cursor[i]._id,
			'site': cursor[i].site,
			'status': cursor[i].status
		}
		siteList.sites.push(site);
	}
	return siteList;
}