'use strict';

var child_process = require('child_process');
var ez = require('ez-streams');
var datetime = require('syracuse-core/lib/types/datetime');
var config = require('config');
var fsp = require('path');

exports.tracker = null;

function track(line) {
	var m = /^([A-Z])-(\w+):\s*(.*)$/.exec(line);
	if (!m) m = [line, 'T', 'misc', line];
	if (exports.tracker) exports.tracker.emit(m[2], m[3], m[1]);
	return [m[1], datetime.now(), m[2], m[3]].join('\t');
}

function serialize(obj) {
	return Object.keys(obj).reduce(function(a, k) {
		a.push(k + '=' + encodeURIComponent(obj[k]));
		return a;
	}, []).join('&');
}

exports.executeScript = function(_, path, args) {
	if (exports.tracker) exports.tracker.phase = 'executing ' + path.split('/').pop();
	var child = child_process.execFile(path, args);
	var reader = ez.devices.child_process.reader(child, {
		encoding: 'utf8',
		errorPrefix: 'STDERR: ',
	}).transform(ez.transforms.lines.parser()).map(function(_, line) {
		return track(line);
	}).pipe(_, ez.devices.console.log);
};

exports.client = function(_, url, data) {
	var method = data ? 'POST' : 'GET';
	exports.log(method, 'url:', url);
	var response = ez.devices.http.client({
		rejectUnauthorized: false,
		url: url,
		method: method,
		headers: {
			Authorization: 'Basic YWRtaW46YWRtaW4=',
			'content-type': 'text/json',
		}
	}).end(JSON.stringify(data)).response(_);
	var body = response.readAll(_) || {};
	try {
		body = JSON.parse(body);
	} catch (ex) {}
	var result = {
		statusCode: response.statusCode,
		headers: response.headers,
		body: body,
		resource0: body.$resources ? body.$resources[0] : null,
	};
	if (result.body.$diagnoses) exports.error('diagnoses:', result.body.$diagnoses);
	return result;
};

exports.ops = function(_, service, params) {
	exports.client(_, config.hosting.chefUrl + '/api/' + service + '?' + serialize(params), {});
};

exports.log = function() {
	var str = Array.prototype.slice.call(arguments).join(' ');
	console.log(track(str));
};
exports.error = function(detail, result) {
	exports.log('I-detail : ', detail + ': ', result.statusCode + ': ', result.body);
};
