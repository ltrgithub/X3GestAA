var client = require('./client.js');
var zone = require('./zone.js');
var config = require('../../../../config');
var options = config.cloudflare.options;
var zoneName = config.cloudflare.zoneName;
var content = config.cloudflare.content;

function getRecordByName(name,callback){
	name =name + "."+ zoneName;
    	zone.getZoneIdByName(zoneName,function(err,zoneID){
        reqOptions=options;
        reqOptions.path = config.cloudflare.paths.getRecord.replace(":zoneID",zoneID) + name;
        reqOptions.method = 'GET';
        client.sendRequest(reqOptions, function(err,data){
            if (err)
                callback(err);
            else
                callback(null, JSON.parse(data).result[0]);
        });
    });
    
}


function deleteRecordById(id, callback){
      zone.getZoneIdByName(zoneName,function(err,zoneID){
        reqOptions=options;
        reqOptions.path = config.cloudflare.paths.deleteRecord.replace(":zoneID",zoneID)+ id;
        reqOptions.method = 'DELETE';
        
        client.sendRequest(reqOptions,function(err,result){
           if (err)
                callback(err);
            else
                callback(null, JSON.parse(result));
        });
      });
}

function deleteRecordByName(name, callback){
    getRecordByName(name,function(err, record){
        reqOptions=options;
        reqOptions.path = config.cloudflare.paths.deleteRecord.replace(":zoneID", record.zone_id)+ record.id;
        reqOptions.method = 'DELETE';
        client.sendRequest(reqOptions,function(errReq, result) {
            if (errReq)
                callback(errReq);
            else
                callback(null, JSON.parse(result));
        });
    });  
}

function addRecordByName(name, callback){
    zone.getZoneIdByName(zoneName,function(err,zoneID){
        var post_data = JSON.stringify({
            "type": "CNAME",
            "name" : name ,
            "content" : content,
            "ttl" : 1
        });
        reqOptions= options;
        reqOptions.path = config.cloudflare.paths.addRecord.replace(":zoneID",zoneID);
        reqOptions.method = 'POST';
        reqOptions.headers["Content-Type"] = 'application/json';
        reqOptions.headers['Content-Length'] = post_data.length;
        reqOptions.post_data = post_data;
        client.sendRequest(reqOptions,function(err,result){
            if (err)
                callback(err);
            else
                callback(null, JSON.parse(result))
        });
    })
}

// test to see if whole record is neccessary.
function updateRecordByName(name, newFields,callback){

    zone.getZoneIdByName(zoneName,function(err,zoneID){
        getRecordByName(name,function(err,record){
            
            var keys = Object.keys(newFields).forEach(function(data){
                record[data] = newFields[data];
            });
            

            var post_data = JSON.stringify(record);
            reqOptions= options;
            reqOptions.path = config.cloudflare.paths.updateRecord.replace(":zoneID",zoneID) + record.id;
            reqOptions.method = 'PUT';
            reqOptions.headers["Content-Type"] = 'application/json';
            reqOptions.headers['Content-Length'] = post_data.length;
            reqOptions.post_data = post_data;
            client.sendRequest(reqOptions,function(err,result){
				callback(err,JSON.parse(result));
            });

        });
    })
}

exports.getRecordByName = getRecordByName;
exports.deleteRecordById = deleteRecordById
exports.deleteRecordByName = deleteRecordByName
exports.addRecordByName = addRecordByName
exports.updateRecordByName = updateRecordByName
