'use strict';

var helpers = require('../helpers');

module.exports = function(_, context, instance) {
	if (instance.status(_) !== 'provisioned' || instance.isTest(_)) return;

	var collabUrl = instance.uri(_) + '/sdata/syracuse/collaboration/syracuse/';

	// get the list of applications
	var result = helpers.client(_, collabUrl + 'applications');
	if (result.statusCode !== 200) return helpers.error('get applications', result);
	var application = result.body.$resources ? result.body.$resources.filter(function(res) {
		return res.application === 'x3';
	})[0] : {};

	// get the list of groups
	result = helpers.client(_, collabUrl + 'groups');
	if (result.statusCode !== 200) return helpers.error('get groups', result);
	var adminGroup = result.resource0;

	// create X3Servers and endpoints
	var x3server = {
		description: instance.ipX3(_),
		serverHost: instance.ipX3(_),
		serverPort: 1807
	};
	result = helpers.client(_, collabUrl + 'x3servers', x3server);
	if (result.statusCode !== 201) return helpers.error('init x3servers', result);
	x3server = result.body;

	var epSeed = {
		'description': 'SEED',
		'x3server': {
			'$uuid': x3server.$uuid
		},
		'x3ServerFolder': 'SEED',
		'x3SolutionName': 'X3V7',
		'application': 'x3',
		'applicationRef': {
			'$uuid': application.$uuid
		},
		'groups': [{
			'$uuid': adminGroup.$uuid
		}],
		'dataset': 'SEED'
	};
	result = helpers.client(_, collabUrl + 'endPoints', epSeed);
	if (result.statusCode !== 201) return helpers.error('init endpoints', result);
	epSeed = result.body;

	// push license to site
	var subscriptions = instance.subscriptions(_)._array;
	var license = Array.isArray(subscriptions) && subscriptions.length ? subscriptions[0].license(_) : null;
	result = license ? helpers.client(_, instance.uri(_) + '/nannyCommand/notifyOne/license/set', license, 'PUT') : {};
	if (result.statusCode !== 201) return helpers.error('init license', result);

	// kick off the Search Index
	//	var index = {//		endpoint: {
	//			'$uuid': epSeed.$uuid
	//		}
	//	};
	//	result = helpers.client(_, collabUrl + '/$services/updateDataIndex', index);
	//	if (result.statusCode !== 200) return helpers.error('update search index', result);
};
