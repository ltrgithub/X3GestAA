"use strict";
var fs = require('fs');
var fsp = require('path');


module.exports = function(options) {
	// don't transform files that we don't own!
	// ignore dependencies but not shadow-modules 
	function ignore(path) {
		if (/\._(js|coffee)/.test(path)) return false;
		if (/[\\\/]node_modules[\\\/].*[\\\/]node_modules[\\\/]/.test(path)) return true;
		if (/[\\\/]deps[\\\/]/.test(path)) return true;
		if (/[\\\/]shadow-modules[\\\/]/.test(path)) return true;
		return false;
	}

	require("babel-plugin-streamline");
	require("babel-plugin-flow-comments");
	var babelOptions = {
		plugins: ['flow-comments', 'streamline'],
	};
	if (options.runtime !== "callbacks") babelOptions.blacklist = ['regenerator'];
	require("streamline").register({
		cache: options.cache,
		cacheDir: options.cacheDir,
		quiet: options.quiet,
		runtime: options.runtime || "fibers",
		sourceMaps: true,
		babel: babelOptions,
		extensions: [".js", "._js"],
		ignore: ignore,
	});

	// register .es5 extension to be able to test customer image before encryption
	require.extensions['.es5'] = function(module, filename, code) {
		if (!code) code = fs.readFileSync(filename, "utf8");
		module._compile(code, filename);
	};
};