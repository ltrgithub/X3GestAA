'use strict';
var config = require('config');
var ez = require('ez-streams');
var https = require('https');
var fs = require('fs');
var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer("session.trace");
var httpClient = require('syracuse-httpclient/lib/httpClient').httpRequest;
var site = "";

tracer = tracer || console.log;

function getSiteStatus(request, response, _) {
	site = 'https://' + request.headers.host;
	//site = "https://mondaysite1.sky.peach.com";
	var syrPath = config.root;
	var sslPath = syrPath + '/node_modules/syracuse-main/lib/ssl/';
	var apiBox = config.health.apiBox || "api2.sky.peach.com";

	var options = {
		host: apiBox,
		path: '/api/sky/automation/production/sites',
		rejectUnauthorized: false,
		method: 'GET',
		key: fs.readFileSync(sslPath + 'seos.key'),
		cert: fs.readFileSync(sslPath + 'seos.crt')
	};

	var req = https.request(options, function(res) {
		var data = "";
		res.setEncoding('utf8');
		res.on('data', function(d) {
	 		data += d;
	 	});

	 	res.on('end', function() {
	 		var json = JSON.parse(data);
	 		var filtered = json.$resources.filter(findSite);
	 		if (filtered.length > 0) {
	 			if (filtered[0].status == "suspended") {
	 				tracer && tracer("Site suspended: " + site);
	 				response.writeHead("303", {
	 					"Content-Type": "text/html",
						"Location":  "http://" + site + "/suspend.html"
					});
					return response.end();
	 			} 
	 		}
			response.writeHead("301", {
				Location: request.url.replace(/\/$|(\/default)\.(html|htm)/, "/index.html")
			});
			return response.end();
	 	});
	});

	req.end();

	req.on('error', function(e) {
	 	console.error(e);
	});
}
exports.getSiteStatus = getSiteStatus;

function findSite(resource) {
	return resource.uri == site;
}