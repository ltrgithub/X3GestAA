"use strict";
//used for  init database
// usee node  ./lib/sprint1/initDBjs
var config = require('config'); // must be first syracuse require
var dataModel = require("syracuse-orm/lib/dataModel");
var helpers = require("syracuse-core/lib/helpers");
var registry = require("syracuse-sdata/lib/sdataRegistry");
var syracuse = require('syracuse-main/lib/syracuse');
var each = helpers.array.each;
var mongodb = require('streamline-mongodb');
var sys = require("util");
var factory = require("syracuse-orm/lib/factory");

var countries = [{
	code: "AD",
	description: "Andorra"
}, {
	code: "AE",
	description: "United Arab Emirates"
}, {
	code: "AF",
	description: "Afghanistan"
}, {
	code: "AL",
	description: "Albania"
}, {
	code: "AM",
	description: "Armenia"
}, {
	code: "AO",
	description: "Angola"
}, {
	code: "AQ",
	description: "Antarctica"
}, {
	code: "AR",
	description: "Argentina"
}, {
	code: "AT",
	description: "Austria"
}, {
	code: "AU",
	description: "Australia"
}, {
	code: "AZ",
	description: "Azerbaijan"
}, {
	code: "BA",
	description: "Bosnia and Herzegovina"
}, {
	code: "BB",
	description: "Barbados"
}, {
	code: "BD",
	description: "Bangladesh"
}, {
	code: "BE",
	description: "Belgium"
}, {
	code: "BF",
	description: "Burkina Faso"
}, {
	code: "BG",
	description: "Bulgaria"
}, {
	code: "BH",
	description: "Bahrain"
}, {
	code: "BI",
	description: "Burundi"
}, {
	code: "BJ",
	description: "Benin"
}, {
	code: "BM",
	description: "Bermuda"
}, {
	code: "BN",
	description: "Brunei Darussalam"
}, {
	code: "BO",
	description: "Bolivia"
}, {
	code: "BR",
	description: "Brazil"
}, {
	code: "BS",
	description: "Bahamas"
}, {
	code: "BT",
	description: "Bhutan"
}, {
	code: "BW",
	description: "Botswana"
}, {
	code: "BY",
	description: "Belarus"
}, {
	code: "BZ",
	description: "Belize"
}, {
	code: "CA",
	description: "Canada"
}, {
	code: "CD",
	description: "Congo(Democratic Republic of the)"
}, {
	code: "CF",
	description: "Central African Republic"
}, {
	code: "CG",
	description: "Congo"
}, {
	code: "CH",
	description: "Switzerland"
}, {
	code: "CI",
	description: "C�te d'Ivoire"
}, {
	code: "CL",
	description: "Chile"
}, {
	code: "CM",
	description: "Cameroon"
}, {
	code: "CN",
	description: "China"
}, {
	code: "CO",
	description: "Colombia"
}, {
	code: "CR",
	description: "Costa Rica"
}, {
	code: "CS",
	description: "Serbia and Montenegro"
}, {
	code: "CU",
	description: "Cuba"
}, {
	code: "CV",
	description: "Cape Verde"
}, {
	code: "CY",
	description: "Cyprus"
}, {
	code: "CZ",
	description: "Czech Republic"
}, {
	code: "DD",
	description: "German Democratic Republic [GDR] (1949-1990)"
}, {
	code: "DE",
	description: "Germany"
}, {
	code: "DJ",
	description: "Djibouti"
}, {
	code: "DK",
	description: "Denmark"
}, {
	code: "DO",
	description: "Dominican Republic"
}, {
	code: "DZ",
	description: "Algeria"
}, {
	code: "EC",
	description: "Ecuador"
}, {
	code: "EE",
	description: "Estonia"
}, {
	code: "EG",
	description: "Egypt"
}, {
	code: "ES",
	description: "Spain"
}, {
	code: "ET",
	description: "Ethiopia"
}, {
	code: "FI",
	description: "Finland"
}, {
	code: "F�",
	description: "Faroe Islands"
}, {
	code: "FR",
	description: "France"
}, {
	code: "GA",
	description: "Gabon"
}, {
	code: "GB",
	description: "United Kingdom"
}, {
	code: "GE",
	description: "Georgia"
}, {
	code: "GF",
	description: "French Guiana"
}, {
	code: "GH",
	description: "Ghana"
}, {
	code: "GI",
	description: "Gibraltar"
}, {
	code: "GL",
	description: "Greenland"
}, {
	code: "GM",
	description: "Gambia"
}, {
	code: "GN",
	description: "Guinea"
}, {
	code: "GP",
	description: "Guadeloupe"
}, {
	code: "GQ",
	description: "Equatorial Guinea"
}, {
	code: "GR",
	description: "Greece"
}, {
	code: "GT",
	description: "Guatemala"
}, {
	code: "GW",
	description: "Guinea-Bissau"
}, {
	code: "GY",
	description: "Guyana"
}, {
	code: "HK",
	description: "Hong Kong"
}, {
	code: "HN",
	description: "Honduras"
}, {
	code: "HR",
	description: "Croatia"
}, {
	code: "HT",
	description: "Haiti"
}, {
	code: "HU",
	description: "Hungary"
}, {
	code: "ID",
	description: "Indonesia"
}, {
	code: "IE",
	description: "Ireland"
}, {
	code: "IL",
	description: "Israel"
}, {
	code: "IN",
	description: "India"
}, {
	code: "IQ",
	description: "Iraq"
}, {
	code: "IR",
	description: "Iran(Islamic Republic of)"
}, {
	code: "IS",
	description: "Iceland"
}, {
	code: "IT",
	description: "Italy"
}, {
	code: "JM",
	description: "Jamaica"
}, {
	code: "JO",
	description: "Jordan"
}, {
	code: "JP",
	description: "Japan"
}, {
	code: "KE",
	description: "Kenya"
}, {
	code: "KG",
	description: "Kyrgyzstan"
}, {
	code: "KH",
	description: "Cambodia"
}, {
	code: "KM",
	description: "Comoros"
}, {
	code: "KP",
	description: "Korea(Democratic People's Republic of)"
}, {
	code: "KR",
	description: "Korea (Republic of)"
}, {
	code: "KW",
	description: "Kuwait"
}, {
	code: "KZ",
	description: "Kazakhstan"
}, {
	code: "LA",
	description: "Lao People's Democratic Republic"
}, {
	code: "LB",
	description: "Lebanon"
}, {
	code: "LI",
	description: "Liechtenstein"
}, {
	code: "LK",
	description: "Sri Lanka"
}, {
	code: "LR",
	description: "Liberia"
}, {
	code: "LS",
	description: "Lesotho"
}, {
	code: "LT",
	description: "Lithuania"
}, {
	code: "LU",
	description: "Luxembourg"
}, {
	code: "LV",
	description: "Latvia"
}, {
	code: "MA",
	description: "Morocco"
}, {
	code: "MC",
	description: "Monaco"
}, {
	code: "MD",
	description: "Moldova (Republic of)"
}, {
	code: "ME",
	description: "Montenegro"
}, {
	code: "MG",
	description: "Madagascar"
}, {
	code: "MK",
	description: "The Former Yugoslav Republic of Macedonia"
}, {
	code: "ML",
	description: "Mali"
}, {
	code: "MN",
	description: "Mongolia"
}, {
	code: "MO",
	description: "Macao"
}, {
	code: "MQ",
	description: "Martinique"
}, {
	code: "MR",
	description: "Mauritania"
}, {
	code: "MT",
	description: "Malta"
}, {
	code: "MU",
	description: "Mauritius"
}, {
	code: "MV",
	description: "Maldives"
}, {
	code: "MW",
	description: "Malawi"
}, {
	code: "MX",
	description: "Mexico"
}, {
	code: "MY",
	description: "Malaysia"
}, {
	code: "MZ",
	description: "Mozambique"
}, {
	code: "NA",
	description: "Namibia"
}, {
	code: "NC",
	description: "New Caledonia"
}, {
	code: "NE",
	description: "Niger"
}, {
	code: "NG",
	description: "Nigeria"
}, {
	code: "NI",
	description: "Nicaragua"
}, {
	code: "NL",
	description: "Netherlands"
}, {
	code: "NO",
	description: "Norway"
}, {
	code: "NP",
	description: "Nepal"
}, {
	code: "NZ",
	description: "New Zealand"
}, {
	code: "PA",
	description: "Panama"
}, {
	code: "PE",
	description: "Peru"
}, {
	code: "PF",
	description: "French Polynesia"
}, {
	code: "PG",
	description: "Papua New Guinea"
}, {
	code: "PH",
	description: "Philippines"
}, {
	code: "PK",
	description: "Pakistan"
}, {
	code: "PL",
	description: "Poland"
}, {
	code: "PR",
	description: "Puerto Rico"
}, {
	code: "PS",
	description: "Palestinian Territories"
}, {
	code: "PT",
	description: "Portugal"
}, {
	code: "PY",
	description: "Paraguay"
}, {
	code: "QC",
	description: "Quebec (Canadian province)"
}, {
	code: "RO",
	description: "Romania"
}, {
	code: "RS",
	description: "Serbia"
}, {
	code: "RU",
	description: "Russian Federation"
}, {
	code: "RW",
	description: "Rwanda"
}, {
	code: "SA",
	description: "Saudi Arabia"
}, {
	code: "SB",
	description: "Solomon Islands"
}, {
	code: "SC",
	description: "Seychelles"
}, {
	code: "SD",
	description: "Sudan"
}, {
	code: "SE",
	description: "Sweden"
}, {
	code: "SG",
	description: "Singapore"
}, {
	code: "SI",
	description: "Slovenia"
}, {
	code: "SK",
	description: "Slovakia"
}, {
	code: "SL",
	description: "Sierra Leone"
}, {
	code: "SM",
	description: "San Marino"
}, {
	code: "SN",
	description: "Senegal"
}, {
	code: "SO",
	description: "Somalia"
}, {
	code: "SR",
	description: "Suriname"
}, {
	code: "SU",
	description: "Union of Soviet Socialist Republics(until December 1991)"
}, {
	code: "SV",
	description: "El Salvador"
}, {
	code: "SY",
	description: "Syria(Syrian Arab Republic)"
}, {
	code: "SZ",
	description: "Swaziland"
}, {
	code: "TD",
	description: "Chad"
}, {
	code: "TJ",
	description: "Tajikistan"
}, {
	code: "TG",
	description: "Togo"
}, {
	code: "TH",
	description: "Thailand"
}, {
	code: "TM",
	description: "Turkmenistan"
}, {
	code: "TN",
	description: "Tunisia"
}, {
	code: "TR",
	description: "Turkey"
}, {
	code: "TT",
	description: "Trinidad and Tobago"
}, {
	code: "TW",
	description: "Taiwan"
}, {
	code: "TZ",
	description: "Tanzania(United Republic of)"
}, {
	code: "UA",
	description: "Ukraine"
}, {
	code: "UG",
	description: "Uganda"
}, {
	code: "US",
	description: "United States"
}, {
	code: "UY",
	description: "Uruguay"
}, {
	code: "UZ",
	description: "Uzbekistan"
}, {
	code: "VA",
	description: "Holy See (Vatican City State)"
}, {
	code: "VE",
	description: "Venezuela"
}, {
	code: "VN",
	description: "Viet Nam"
}, {
	code: "YE",
	description: "Yemen"
}, {
	code: "YU",
	description: "Yugoslavia"
}, {
	code: "ZA",
	description: "South Africa"
}, {
	code: "ZM",
	description: "Zambia"
}, {
	code: "ZR",
	description: "Zaire(see CD - Congo, the Democratic Republic of the)"
}, {
	code: "ZW",
	description: "Zimbabwe"
}];

var companies = [{
	code: "Apple",
	description: "Apple Inc."
}, {
	code: "IBM",
	description: "IBM"
}, {
	code: "Microsoft",
	description: "Microsoft"
}, {
	code: "Google",
	description: "Google"
}, {
	code: "Accenture",
	description: "Accenture"
}, {
	code: "SAP",
	description: "SAP AG"
}, {
	code: "HP",
	description: "Hewlett Packard"
}, {
	code: "CSC",
	description: "Computer Sciences Corporation"
}, {
	code: "Yahoo",
	description: "Yahoo!"
}, {
	code: "CA",
	description: "CA"
}];
var endPoint = null;
config.sdata.endpoints.forEach(function(ep) {
	if (ep.contract.application == "sprint1") {
		endPoint = ep;
	}
});

function _stop() {
	setTimeout(function() {
		process.kill(process.pid);
	}, 100);
}

var model = dataModel.make(registry.applications.sprint1.contracts.settings, "sprint1");
//
endPoint.datasets.sprint1.port = 27017;
endPoint.datasets.sprint1.driver = "mongodb";

function createDatabase(_) {
	console.log("Create database sprint1 ...");
	try {
		var server = new mongodb.Server(endPoint.datasets.sprint1.hostname, endPoint.datasets.sprint1.port, {});
		var db = new mongodb.Db(endPoint.datasets.sprint1.database, server, {});
		db = db.open(_);
		db.dropDatabase(_);
		console.log("Database sprint1 created.");
	} catch (e) {
		console.error(e.message);
		console.error(e.message + "\n" + e.stack);
		throw e;
	}
}

function importCompanies(_) {
	var db = dataModel.getOrm(_, model, endPoint.datasets.sprint1);
	companies.forEach_(_, function(_, company, index) {
		var elt = (new factory.Factory(model.getEntity(_, "company"))).createInstance(_, company, db);
		//    elt.$uuid = helpers.uuid.generate();
		elt.save(_);
	});
	console.log("Import companies OK");
}

function importCountries(_) {
	try {
		var db = dataModel.getOrm(_, model, endPoint.datasets.sprint1);
		countries.forEach_(_, function(_, country, index) {
			var elt = (new factory.Factory(model.getEntity(_, "country"))).createInstance(_, country, db);
			//      elt.$uuid = helpers.uuid.generate();
			elt.save(_);
		});
		console.log("Import  countries OK");

	} catch (e) {
		console.log("importCountries error: " + e.message);
		throw (e);
	}

}

try {
	createDatabase(_);
	importCountries(_);
	importCompanies(_);

} finally {
	_stop();
}