"use strict";

// / !doc
// /
// / # Server-side requirejs handler
// /
// / Handles requireJS requests coming from the tablet client and transforms
// commonJS modules to AMD modules by wrapping them with a define
// /
var fs = require('streamline-fs');
var path = require('path');
var util = require('util');
var uurl = require('url');
var querystring = require('querystring');
var sessionManager = require('syracuse-session/lib/sessionManager').sessionManager;
var streams = require('streamline/lib/streams/streams');
var globals = require('streamline/lib/globals');

exports.dispatcher = function(config) {
	var root = path.join(__dirname, "../../../node_modules/");
	return function(_, request, response) {
		var url = uurl.parse(request.url);
		var segs = url.pathname.split("/");
		var service = segs.length > 1 ? segs[2] : null;
		var file = path.join(root, segs.slice(2).join("/"));
		if (!fs.exists(file, _)) {
			response.writeHead(404, {});
		} else {
			response.writeHead(200, {
				'content-type': 'application/javascript'
			});
			var content = fs.readFile(file, 'utf8', _);
			if (segs.indexOf("deps") < 0) { // do not pack dependencies in
				// an AMD format (jQuery e.g.
				// would not work)
				content = "define(function(require, exports, module) {\n" + content + "\n});";
			}
			response.write(_, content);
		}
		response.end();
	};
};