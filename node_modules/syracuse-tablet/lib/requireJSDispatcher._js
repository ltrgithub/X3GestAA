"use strict";

// / !doc
// /
// / # Server-side requirejs handler
// /
// / Handles requireJS requests coming from the tablet client and transforms
// commonJS modules to AMD modules by wrapping them with a define
// /
var fs = require('streamline-fs');
var path = require('path');
var util = require('util');
var uurl = require('url');
var querystring = require('querystring');
var sessionManager = require('syracuse-session/lib/sessionManager').sessionManager;
var streams = require('streamline/lib/streams/streams');
var globals = require('streamline/lib/globals');
var helpers = require('syracuse-core/lib/helpers');


function _getSessionCookieName(request) {
	return helpers.http.checkIfIE(request.headers['user-agent']) ? "client.id" : "syracuse.sid" + "." + request.connection.localPort;
}

function _getSessionCookie(request) {
	var cookies = helpers.http.parseCookie(request.headers.cookie);
	var cookieName = _getSessionCookieName(request);
	var cookie = cookies[cookieName];
	return cookie ? cookieName + "=" + cookie : null;
}

function _secureCookie(secure, value) {
	var prefix = (value[value.length - 1] === ";") ? "" : ";";
	if (secure) value += prefix + 'Secure;';
	value += prefix + 'HttpOnly;';
	return value;
}
/**
 * Temporary reconnect process
 * Win 10 - US 110849-10 - Fast application resume
 * Allows reconnection without login if browser is closed and Syracuse session is still alive
 */
function _processReconnectSvc(_, service, request, response) {
	var log = console.log;
	if (service === "reconnectGetToken") {
		// Return a token (syra cookie)
		// This token can be stored (by the native wrapper) and sent when mobile application is launched to try to avoid login
		var syraCookie = _getSessionCookie(request);
		if (syraCookie) {
			response.writeHead(200, {
				'x-reconnect-token': syraCookie
			});
		} else {
			response.writeHead(404, {});
		}
		return true;
	}
	if (service === "reconnectSetToken") {
		// Process the reconnect token
		// If no session cookie is found in headers and reconnect token provided -> Set the session cookie given by reconnect token
		// The mobile client will read the profile after having called reconnectSetToken
		// If the cookie has expired or session is destroyed user will be forced to login (regular process)
		// If not no login is needed
		var syraCookie = _getSessionCookie(request);
		var headers = {};
		if (!syraCookie) {
			var reconnectToken = request.headers['x-reconnect-token'];
			log && log("reconnectSetToken", "Session id not provided");
			if (reconnectToken) {
				log && log("reconnectSetToken", "reconnectToken", reconnectToken);
				var cookie = headers["set-cookie"];
				cookie = cookie || [];
				var expireGMTString = (new Date(+new Date + 200 * 86400 * 1000)).toUTCString(); // 200 days
				var secure = (request.hosting && request.hosting.https) || ('authorized' in request.connection);
				var syraCookie = _secureCookie(secure, reconnectToken + '; path=/');
				log && log("syraCookie", syraCookie);
				cookie.push(syraCookie);
				headers['set-cookie'] = cookie;
			}
		} else {
			log && log("reconnectSetToken", "Session id provided");
		}
		response.writeHead(200, headers);
		return true;
	}
	return false;
}
exports.dispatcher = function(config) {
	var root = path.join(__dirname, "../../../node_modules/");
	return function(_, request, response) {
		var url = uurl.parse(request.url);
		var segs = url.pathname.split("/");
		var service = segs.length > 1 ? segs[2] : null;
		if (!_processReconnectSvc(_, service, request, response)) {
			var file = path.join(root, segs.slice(2).join("/"));
			if (!fs.exists(file, _)) {
				response.writeHead(404, {});
			} else {
				response.writeHead(200, {
					'content-type': 'application/javascript'
				});
				var content = fs.readFile(file, 'utf8', _);
				if (segs.indexOf("deps") < 0) { // do not pack dependencies in
					// an AMD format (jQuery e.g.
					// would not work)
					content = "define(function(require, exports, module) {\n" + content + "\n});";
				}
				response.write(_, content);
			}
		}
		response.end();
	};
};