<!DOCTYPE html>
<!-- dir attribute specifies the text direction of the element's content - ltr=left to right  -->
<html dir="ltr">
<head>
<title>Sage X3 Mobile - Debug</title>
<script id="IOSWRAPPER">
	// TEMPORARY - DOM Logger
	var _$$logIos
	var _logIos = function(msg){
		if (!_$$logIos) _$$logIos = document.querySelector("#logios")
		if (!_$$logIos) return;
		var args = Array.prototype.concat.apply([], arguments);
		var h = _$$logIos.innerHTML
		_$$logIos.innerHTML = h + "<br>" + args.join(' - ')
	}
	window.logIos = _logIos

	// NATIVE IOS LOGGER
	var _IOSNativeLogger = function(){
		this.log = function(msg){
			var args = []
			for (var i = 0; i < arguments.length; i++){
				// IOS logger doesn't accept null value - Only Strings
				if (arguments[i] != null){
					args[i] = arguments[i] + ""
				} else {
					args[i] = ""
				}
			}
			webkit.messageHandlers.log.postMessage(args)
		}
		this.logError = function(where, e){
			this.log (where, e.message, e.stack)
		}
	}
	
	// NATIVE IOS WRAPPER
	var _IOSNativeInterface = function(){
		//window.logIos("_IOSNativeInterface", "START");
		this._promiseCpt = 0
		this._promisesMap = {}
		
		/*
		* Returns an IOS NSDictionary 
		*/
		this._serializeToIOSDictionnary = function(names, args){
			var res = {}, data
			names.forEach(function(name, idx){
				res[name] = args != null ? args[idx] : null
				if (res[name] != null && typeof res[name] != "string"){
					throw new Error("IOS Callback - Unexpected parameter type [" + typeof res[name] + "]- Expected string - Name[" + name + "]" )
				}	
			})
			//window.smNativeLogger.log(JSON.stringify(res, null, 2))
			return res
		}
		/*
		* Creates/Stored a deferred and returns the promise
		*/
		this._createPromise = function(domain, method){
			var deferred = $.Deferred()
			var promiseID = domain + "-" + method + "-" + this._promiseCpt++
			var promise = deferred.promise()
			this._promisesMap[promiseID] = deferred
			// ID to retreive it later
			promise.sageX3MobleID = promiseID
			//window.smNativeLogger.log("promiseID = " + promise.sageX3MobleID)
			return promise
		}
		/*
		* Resolve/Reject the promise given by promiseID which has been stored previoulsy
		*	action reject/resolve
		*/
		this._processPromise= function(promiseID, action, result){
			var deferred = this._promisesMap[promiseID]
			if (!deferred){
				throw new Error("IOS - Promise not found[" + promiseID + "]")
			}
			delete this._promisesMap[promiseID]
			//	window.smNativeLogger.log("IOS - processPromise", promiseID, action)
			deferred[action](result)
		}
		/**
		* Safari doesn't support webSQL in a WKWebView
		*/
		this.getSupportedDB = function(){
			return $.smResolve("indexedDB")
		}
		/*
		* Notify the wrapper that all the resources have been loaded and that the application is starting
		*/
		this.appStartsRunning = function(){
			window.smNativeLogger.log("appStartsRunning")
			webkit.messageHandlers.appStartsRunning.postMessage([])
		}
		/*
		* Calls the regular isSupported wrappers's method
		* 	The wrapper's response is sent asynchronously (see prosessResponse/prosessException)
		*/
		this.isSupported = function(domain, method){
			var promise = this._createPromise(domain, method);
			var args = [promise.sageX3MobleID, domain, method];
			//window.smNativeLogger.log("isSupported args = " + args.join('-'))
			webkit.messageHandlers.isSupported.postMessage(this._serializeToIOSDictionnary(["promiseID", "domain", "method"], args));
			return promise;
		}
		/*
		* Call the regular callMethod wrappers's method
		* 	The wrapper's response is sent asynchronously (see prosessResponse/prosessException)
		*/
		this.callMethod = function(domain, method, param){
			var promise = this._createPromise(domain, method);
			var args = [promise.sageX3MobleID, domain, method, param];
			//window.smNativeLogger.log("callMethod args = " + args.join('-'))
			webkit.messageHandlers.callMethod.postMessage(this._serializeToIOSDictionnary(["promiseID", "domain", "method", "params"], args));
			return promise;
		}
		/*
		* Call the regular fireMethod wrappers's method
		* 	No response is expected from the wrapper
		*/
		this.fireMethod = function(domain, method, param){
			var args = [domain, method, param];
			window.smNativeLogger.log("fireMethod args = " + args.join('-'))
			webkit.messageHandlers.fireMethod.postMessage(this._serializeToIOSDictionnary(["domain", "method", "params"], args))
		}
		/*
		* Process the result of callMethod
		* 	promiseID ID of the promise to resolve
		*	type type of data returned by wrapper
		*	responseStr stringified result
		*/
		this.prosessResponse = function(promiseID, type, responseStr){
			try{
				type = decodeURIComponent(type);
				promiseID = decodeURIComponent(promiseID);
				var result = this.convertIOSData(type, decodeURIComponent(responseStr));
				this._processPromise(promiseID, "resolve", result)
				window.smNativeLogger.log("IOS - RESPONSE PROCESSED", promiseID, type, responseStr);
				return null
			} catch(e) {
				window.smNativeLogger.logError("Native call iosServiceResponse", e);
				// ISO Wrapper will recieve and log the error + the stack
				return this.convertErrorForIOS(e)
			}	
		}
		/*
		* Process an IOS exception of callMethod
		* 	promiseID ID of the promise to reject
		*	serializedError stringified error
		*/
		this.prosessException = function(promiseID, serializedError){
			try{
				promiseID = decodeURIComponent(promiseID)
				serializedError = decodeURIComponent(serializedError)
				window.smNativeLogger.log("IOS Wrapper prosessException", serializedError);
				var error = new Error("IOS wrapper exception");
				error.stack = serializedError;
				this._processPromise(promiseID, "reject", error);
			} catch(e) {
				window.smNativeLogger.logError("Native call iosServiceException", e.message)
				// ISO Wrapper will recieve and log the error + the stack
				return this.convertErrorForIOS(e)
			}
		}
		/*
		* Returns the JS typed data according to the type
		*/
		this.convertIOSData = function(type, dataStr){
			if (type == null || dataStr == null){
				return null;
			}
			switch (type){
				case  "boolean":
					return "true" === dataStr;
				case "string":
					return dataStr;
				default:
					try{
						return dataStr.trim().length === 0 ? null : JSON.parse(dataStr);
					}catch(e){
						throw new Error ("BAD JSON STRING - " + type + " - " + dataStr)
					}
			}
		}
		
		/*
		* Serialize a JAVASCRIPT error in a NSDictionary
		*/
		this.convertErrorForIOS = function(error){
			var res = {
				type: "error"
			}
			if (error == null){
				res.message = "No error message";
			} else if (typeof error == "string"){
				res.message = error;
			} else if (typeof error == "object"){
				res.message = error.message;
				if(error.stack){
					res.stack = error.stack.replace (new RegExp(window.location.href.substring(0, window.location.href.lastIndexOf('/')), "g"), "  ");
					res.stack = res.stack.split("\n");
				}
			} else {
				res = null
			} 
			return res	
		}
		// Returns a type + a string
		this.convertResultForIOS = function(result){
			if (result == null) return null;
			var res = {}
			var type = typeof result
			switch(type){
				case "boolean":
					res.type = "boolean";
					res.data =  result ? "true" : "false";
					return res;
				case "number":
				case "string":
					res.type = type;
					res.data =  result;
					return res;
				case "object":
					try{
						res.type = "json";
						res.data =  JSON.stringify(result, null, 2);
						return res;
					}catch(e){
						throw new Error("convertResultForIOS - Error Stringifying result")
					}
				default:
				return null;
			} 
		}
	}
	/*
	* Called by IOSWrapper to initialize the native object when the document has been loaded (WKUserScriptInjectionTime.AtDocumentEnd)
	*	Must be declared in html page (not in a require)
	*	Crates all the needed object
	*/
	function initIOSWrapper (promiseID, responseJSON){
		window.smNativeLogger = new _IOSNativeLogger()
		window.smNativeInterface = new _IOSNativeInterface()
		window.smNativeLogger.log("IOS Wrapper initialized")
	};
	/*
	* Called by IOS Wrapper to send the response to callMethod/isSuppported services
	*/
	function iosServiceResponse (promiseID, type, responseStr){
		// window.smNativeLogger.log("JS CALLBACK iosServiceResponse")
		if (!window.smNativeInterface) return;
		window.smNativeInterface.prosessResponse(promiseID, type, responseStr);
	};
	/*
	* Called by IOS Wrapper to send an exception if callMethod/isSuppported failed
	*/
	function iosServiceException (promiseID, serializedError){
		// window.smNativeLogger.log("JS CALLBACK iosServiceException")
		if (!window.smNativeInterface) return;
		window.smNativeInterface.prosessException(promiseID, serializedError);
	};
	/*
	* Called by IOS wrapped to invoke the given objectName/methodName javascript service
	*	The response is returned synchronously
	*/
	function iosJavascriptServiceCall(objectName, methodName, type, params){
		try{
			if(!window.smJSCall || !window.smNativeInterface){
				throw new Error("window.smJSCall not initialized");
			}
			var res = window.smJSCall(objectName, methodName, window.smNativeInterface.convertIOSData (type, params))
			
			window.smNativeLogger.log("iosJavascriptServiceCall", objectName, methodName, type, params, JSON.stringify(res));
			return window.smNativeInterface.convertResultForIOS(res);
		} catch(e){
			return window.smNativeInterface.convertErrorForIOS (e);
		}
	}
</script>
<meta content="text/html; charset=UTF-8" http-equiv="content-type">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"/>
<link rel="icon" href="img/favicon.ico">

<script src="deps/requirejs/require.js"></script>
<script src="deps/requirejs/xrayquire.js"></script>
<script>
	var _log = function() {
		var text;
		for (var i = 0; i < arguments.length; i++) {
			var a = arguments[i];
			if (a != null) {
				if (Error.prototype.toString === a.toString){
					console.log(a.message, "\n", a.stack);
				}else{
					if (!text) text = ["[index]: "];
					text.push(a);
				}
			}
		}
		console.log(text.join(text, " "));
	};
	if (window.smNativeLogger && window.smNativeLogger.log) {
		window.smNativeLogger.log("Index: Webapp loading");
	}
	require.config({
		'waitSeconds': 0,
		'baseUrl' : "/requireJS",
		'paths' : {
			'textPlugin' : '/syracuse-tablet/html/deps/requirejs/text',
			
			'jquery' : '/syracuse-tablet/html/deps/jquery-2.1.1/jquery',
			'jquery-waiting' : '/syracuse-tablet/html/deps/jquery-waiting/waiting',
			'jquery-ui' : '/syracuse-tablet/html/deps/jquery-ui-1.11.2/jquery-ui',
			
			'bootstrap' : '/syracuse-tablet/html/deps/bootstrap/js/bootstrap',
			'bootstrap-select' : '/syracuse-tablet/html/deps/bootstrap-select/js/bootstrap-select',
			'bootstrap-switch' : '/syracuse-tablet/html/deps/bootstrap-switch/js/bootstrap-switch',
			'jquery-minicolors' : '/syracuse-tablet/html/deps/jquery-minicolors/jquery.minicolors',
			'bootstrap-slider' : '/syracuse-tablet/html/deps/bootstrap-slider/js/bootstrap-slider',
			'nativePrototypes': '/syracuse-tablet/html/js/helpers/nativePrototypes',
			'jqueryPlugins': '/syracuse-tablet/html/js/helpers/jqueryPlugins',
			
			'highcharts': '/syracuse-tablet/html/deps/highcharts-3.0.2/highcharts.src',
			'highcharts-more': '/syracuse-tablet/html/deps/highcharts-3.0.2/highcharts-more.src',
			'highcharts-exporting': '/syracuse-tablet/html/deps/highcharts-3.0.2/modules/exporting.src',
			'mobile-detect': '/syracuse-tablet/html/deps/mobile-detect/mobile-detect',
			'main': 'syracuse-tablet/html/js/main'
		},
		'shim' : {
			'jquery-waiting': {
				'deps' : [ 'jquery' ]
			},
			'jquery-ui': {
				'deps' : [ 'jquery' ]
			},
			'jqueryPlugins': {
				'deps' : [ 'jquery' ]
			},
			'bootstrap' : {
				'deps' : [ 'jquery' ]
			},
			'bootstrap-select': {
				'deps' : [ 'bootstrap' ]
			},
			'bootstrap-switch': {
				'deps' : [ 'bootstrap' ]
			},
			'jquery-minicolors': {
				'deps' : [ 'bootstrap' ]
			},
			'highcharts': {
				'deps' : [ 'jquery' ]
			}, 
			'highcharts-more': {
				'deps' : [ 'highcharts' ]
			}, 
			'highcharts-exporting': {
				'deps' : [ 'highcharts-more' ]
			}, 
			'main': { 
				'deps': [
					"jquery", 
					"bootstrap", 
					"bootstrap-select", 
					"bootstrap-switch", 
					"jquery-minicolors", 
					"bootstrap-slider", 
					"jquery-waiting",
					"jquery-ui",
					"nativePrototypes",
					"jqueryPlugins",
					"highcharts",
					"highcharts-more",
					"highcharts-exporting",
					"mobile-detect"
				]
			}
		}
	});
	require(['mobile-detect'], function (md) {
		window.MobileDetect = md;	 
	});
	
	require(["main"], function() {
		console.log("Debug startup ok");
	});
</script>
</head>
<body>
	<div id="s-m-site-all">
		<section id="s-m-auth-panel-left-id" style="display: none"></section>
		<splitter id="s-m-auth-splitter-left-id" style="display: none;"></splitter>
		<section id="s-m-auth-panel-header-id" style="display: none;"></section>
		<section id="s-m-app-container-id">		
			<section id="s-m-app-id" style="display: none"></section>
		</section>
		<section id="s-m-auth-panel-footer-id" style="display: none;"></section>
		<splitter id="s-m-auth-splitter-right-id" style="display: none;"></splitter>		
		<section id="s-m-auth-panel-right-id" style="display: none"></section>
	</div>
	<div style="height:300px;overflow-y:auto;color:red;z-index:2000000;right:0;position:absolute;background-color:black;" id="logios"></div>
</body>
</html>
