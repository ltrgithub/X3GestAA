<!DOCTYPE html>
<!-- dir attribute specifies the text direction of the element's content - ltr=left to right  -->
<html dir="ltr">
<head>
<title>Sage X3 Mobile - Debug</title>
<script id="IOSWRAPPER">
	// TEMPORARY - DOM Logger
	var _$$logIos
	var _logIos = function(msg){
		if (!_$$logIos) _$$logIos = document.querySelector("#logios")
		if (!_$$logIos) return;
		var args = Array.prototype.concat.apply([], arguments);
		var h = _$$logIos.innerHTML
		_$$logIos.innerHTML = h + "<br>" + args.join(' - ')
	}
	window.logIos = _logIos

	// NATIVE IOS LOGGER
	var _IOSNativeLogger = function(){
		this.log = function(msg){
			var args = Array.prototype.concat.apply([], arguments);
			webkit.messageHandlers.log.postMessage(args)
		}
		this.logError = function(where, e){
			this.log (where, e.message, e.stack)
		}
	}
	
	// NATIVE IOS WRAPPER
	var _IOSNativeInterface = function(){
		//window.logIos("_IOSNativeInterface", "START");
		this._promiseCpt = 0
		this._promisesMap = {}
		
		this._serialize = function(names, args){
			var res = {}, data
			names.forEach(function(name, idx){
				res[name] = args != null ? args[idx] : null
				if (res[name] != null && typeof res[name] != "string"){
					throw new Error("IOS Callback - Unexpected parameter type [" + typeof res[name] + "]- Expected string - Name[" + name + "]" )
				}	
			})
			//window.smNativeLogger.log(JSON.stringify(res, null, 2))
			return res
		}
		
		this._storePromise = function(domain, method){
			var deferred = $.Deferred()
			var promiseID = domain + "-" + method + "-" + this._promiseCpt++
			var promise = deferred.promise()
			this._promisesMap[promiseID] = deferred
			promise.sageX3MobleID = promiseID
			//window.smNativeLogger.log("promiseID = " + promise.sageX3MobleID)
			return promise
		}
		this._readPromise= function(promiseID){
			var deferred = this._promisesMap[promiseID]
			if (!deferred){
				throw new Error("IOS - Promise not found[" + promiseID + "]")
			}
			delete this._promisesMap[promiseID]
		//	window.smNativeLogger.log("IOS - Promise found [" + promiseID + "]")
			return deferred
		}
		this.getSupportedDB = function(){
			return $.smResolve("indexedDB")
		}
		this.isSupported = function(domain, method){
			try{
				var promise = this._storePromise(domain, method)
				var args = [promise.sageX3MobleID, domain, method]
			//	window.smNativeLogger.log("isSupported args = " + args.join('-'))
				var res = webkit.messageHandlers.isSupported.postMessage(this._serialize(["promiseID", "domain", "method"], args))
				window.smNativeLogger.log("isSupported result = " + res === true)
				window.smNativeLogger.log("promise?", promise.then != null, promise.fail != null)
				return promise;
			}catch(e){
				window.smNativeLogger.logError("Native call isSupported", e)
				throw e;
			}
		}
		this.callMethod = function(domain, method, param){
			try{
				//window.logIos("_IOSNativeInterface.callMethod")
				var res = webkit.messageHandlers.callMethod.postMessage(this._serialize(["domain", "method", "params"], arguments))
				window.smNativeLogger.log("callMethod result = "+ res)
				return res;
			}catch(e){
				window.smNativeLogger.logError("Native call callMethod", e)
			}
		}
		this.fireMethod = function(domain, method, param){
			try{
				//window.logIos("_IOSNativeInterface.fireMethod")
				var res = webkit.messageHandlers.fireMethod.postMessage(this._serialize(["domain", "method", "params"], arguments))
				window.smNativeLogger.log("fireMethod result = "+ res)
				return res;
			}catch(e){
				window.smNativeLogger.logError("Native call fireMethod", e)
			}
		}
		this.prosessResponse = function(promiseID, result){
		//	window.smNativeLogger.log("IOS Wrapper prosessResponse", promiseID)
			this._readPromise(promiseID).resolve(result)
		}
		this.prosessException = function(promiseID, serializedError){
			window.smNativeLogger.log("IOS Wrapper prosessException", serializedError);
			var error = new Error("IOS wrapper exception")
			error.stack = serializedError
			this._readPromise.reject(error)
		}
	}
	function initIOSWrapper (promiseID, responseJSON){
		window.smNativeLogger = new _IOSNativeLogger()
		window.smNativeInterface = new _IOSNativeInterface()
		window.smNativeLogger.log("IOS Wrapper initialized")
	};
	function responseIOSWrapper (promiseID, type, responseStr){
		try{
			var result
			type = decodeURIComponent(type)
			promiseID = decodeURIComponent(promiseID)
			responseStr = decodeURIComponent(responseStr)
			switch (type){
			case  "boolean":
				result = "true" === responseStr
				break;
			case "string":
				result = responseStr 
				break;
			default:
				try{
					result = JSON.parse(responseStr)
				}catch(e){
					window.smNativeLogger.logError("responseIOSWrapper - BAD JSON STRING", responseStr)
				}
				break;
			}
			if (!window.smNativeInterface) return;
			window.smNativeInterface.prosessResponse(promiseID, result);
			window.smNativeLogger.log("IOS - RESPONSE PROCESSED", promiseID, type, responseStr);
		} catch(e) {
			window.smNativeLogger.logError("Native call responseIOSWrapper", e)
		}
	};
	function exceptionIOSWrapper (promiseID, serializedError){
		try{
			promiseID = decodeURIComponent(promiseID)
			serializedError = decodeURIComponent(serializedError)
			window.smNativeLogger.log("exceptionIOSWrapper");
			if (!window.smNativeInterface) return;
			window.smNativeInterface.prosessException(promiseID, responseJSON);
		} catch(e) {
			window.smNativeLogger.logError("Native call exceptionIOSWrapper", e)
		}
	};
</script>
<meta content="text/html; charset=UTF-8" http-equiv="content-type">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge;chrome=1"/>
<link rel="icon" href="img/favicon.ico">

<script src="deps/requirejs/require.js"></script>
<script src="deps/requirejs/xrayquire.js"></script>
<script>
	var _log = function() {
		var text;
		for (var i = 0; i < arguments.length; i++) {
			var a = arguments[i];
			if (a != null) {
				if (Error.prototype.toString === a.toString){
					console.log(a.message, "\n", a.stack);
				}else{
					if (!text) text = ["[index]: "];
					text.push(a);
				}
			}
		}
		console.log(text.join(text, " "));
	};
	if (window.smNativeLogger && window.smNativeLogger.log) {
		window.smNativeLogger.log("Index: Webapp loading");
	}
	require.config({
		'waitSeconds': 0,
		'baseUrl' : "/requireJS",
		'paths' : {
			'textPlugin' : '/syracuse-tablet/html/deps/requirejs/text',
			
			'jquery' : '/syracuse-tablet/html/deps/jquery-2.1.1/jquery',
			'jquery-waiting' : '/syracuse-tablet/html/deps/jquery-waiting/waiting',
			'jquery-ui' : '/syracuse-tablet/html/deps/jquery-ui-1.11.2/jquery-ui',
			
			'bootstrap' : '/syracuse-tablet/html/deps/bootstrap/js/bootstrap',
			'bootstrap-select' : '/syracuse-tablet/html/deps/bootstrap-select/js/bootstrap-select',
			'bootstrap-switch' : '/syracuse-tablet/html/deps/bootstrap-switch/js/bootstrap-switch',
			'jquery-minicolors' : '/syracuse-tablet/html/deps/jquery-minicolors/jquery.minicolors',
			'bootstrap-slider' : '/syracuse-tablet/html/deps/bootstrap-slider/js/bootstrap-slider',
			'nativePrototypes': '/syracuse-tablet/html/js/helpers/nativePrototypes',
			'jqueryPlugins': '/syracuse-tablet/html/js/helpers/jqueryPlugins',
			
			'highcharts': '/syracuse-tablet/html/deps/highcharts-3.0.2/highcharts.src',
			'highcharts-more': '/syracuse-tablet/html/deps/highcharts-3.0.2/highcharts-more.src',
			'highcharts-exporting': '/syracuse-tablet/html/deps/highcharts-3.0.2/modules/exporting.src',
			'mobile-detect': '/syracuse-tablet/html/deps/mobile-detect/mobile-detect',
			'main': 'syracuse-tablet/html/js/main'
		},
		'shim' : {
			'jquery-waiting': {
				'deps' : [ 'jquery' ]
			},
			'jquery-ui': {
				'deps' : [ 'jquery' ]
			},
			'jqueryPlugins': {
				'deps' : [ 'jquery' ]
			},
			'bootstrap' : {
				'deps' : [ 'jquery' ]
			},
			'bootstrap-select': {
				'deps' : [ 'bootstrap' ]
			},
			'bootstrap-switch': {
				'deps' : [ 'bootstrap' ]
			},
			'jquery-minicolors': {
				'deps' : [ 'bootstrap' ]
			},
			'highcharts': {
				'deps' : [ 'jquery' ]
			}, 
			'highcharts-more': {
				'deps' : [ 'highcharts' ]
			}, 
			'highcharts-exporting': {
				'deps' : [ 'highcharts-more' ]
			}, 
			'main': { 
				'deps': [
					"jquery", 
					"bootstrap", 
					"bootstrap-select", 
					"bootstrap-switch", 
					"jquery-minicolors", 
					"bootstrap-slider", 
					"jquery-waiting",
					"jquery-ui",
					"nativePrototypes",
					"jqueryPlugins",
					"highcharts",
					"highcharts-more",
					"highcharts-exporting",
					"mobile-detect"
				]
			}
		}
	});
	require(['mobile-detect'], function (md) {
		window.MobileDetect = md;	 
	});
	
	require(["main"], function() {
		console.log("Debug startup ok");
	});
</script>
</head>
<body>
	<div id="s-m-site-all">
		<section id="s-m-auth-panel-left-id" style="display: none"></section>
		<splitter id="s-m-auth-splitter-left-id" style="display: none;"></splitter>
		<section id="s-m-auth-panel-header-id" style="display: none;"></section>
		<section id="s-m-app-container-id">		
			<section id="s-m-app-id" style="display: none"></section>
		</section>
		<section id="s-m-auth-panel-footer-id" style="display: none;"></section>
		<splitter id="s-m-auth-splitter-right-id" style="display: none;"></splitter>		
		<section id="s-m-auth-panel-right-id" style="display: none"></section>
	</div>
	<div style="height:300px;overflow-y:auto;color:red;z-index:2000000;right:0;position:absolute;background-color:black;" id="logios"></div>
</body>
</html>
