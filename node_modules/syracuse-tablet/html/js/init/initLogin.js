"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var auth = require('syracuse-tablet/html/js/application/authentication');

var modal = require('syracuse-tablet/html/js/ui/modal');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var sdataCommonRes = require('syracuse-tablet/html/js/sdata/sdataCommonResources');

var initContext = require('syracuse-tablet/html/js/init/initContext');

var _gotoLogin = function(reason) {
	var app = globals.getApplication();
	if (app) {
		app.changePage("login", {
			reason: reason
		});
	}
};

var _loginHandler = {
	notifLogin: function(userProfile) {
		var userCtx = {
			"$user": userProfile.user.$value,
			"$role": userProfile.selectedRole.code,
			"$lang": userProfile.selectedLocale.code
		};

		globals.setUserCtx(userCtx);
		globals.setUserProfile(userProfile);
		locale.setUserLocales(userProfile && userProfile.user && userProfile.user.locales);

		initContext.init(false, false)
			.then(function(context) {});
	}
};


exports.init = function() {
	notifications.subscribe(_loginHandler, ["sm.login"], 1);

	try {
		uiutils.waitWheelStart();
		return auth.check()
			.then(function(status) {
				if (status.authenticated === true) {
					return sdataCommonRes.getUserProfile();
				} else {
					return null;
				}
			})
			.then(function(profile) {
				uiutils.waitWheelStop();
				if (profile) {
					notifications.publish("sm.login", profile);
				} else {
					_gotoLogin("Please enter your credentials");
				}
				return $.smResolve();
			}, function(e) {
				uiutils.waitWheelStop();
				auth.logout().then(function() {
					_gotoLogin("Please try login again");
				});
			});
	} catch (e) {
		_gotoLogin("Javascript exception");
		return $.smResolve();
	}
};