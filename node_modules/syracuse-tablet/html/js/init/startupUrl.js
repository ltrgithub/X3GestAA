"use strict";

var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("startupUrl", true);

var _startupUrl;
var _pageInfo;

exports.initStartupUrl = function() {
	try {
		var parsedUrl = jsutils.parseURL(window.location.href);
		_startupUrl = parsedUrl && parsedUrl.query && parsedUrl.query.url;
		_ensureValidUrl();
	} catch (e) {}
}

// Check if urlFromCaller is something the client could understand, set null if not
function _ensureValidUrl() {
	if (!_startupUrl) return;
	try {
		var parsedUrl = jsutils.parseURL(_startupUrl);
		var app = parsedUrl.query.$mobileApplication;
		var repr = parsedUrl.query.representation;
		var ep = parsedUrl.path.split("/").slice(2, 5).join(".");

		_startupUrl = _startupUrl.replace("/sdata/", "/mobile1/");
		_pageInfo = {
			pageName: [ep, repr].join("."),
			pageOptions: {
				"sdata-url": _startupUrl,
				"applicationName": app
			}
		}

	} catch (e) {
		_startupUrl = null;
		_pageInfo = null;
	}
}

// Return only once the attributes to navigate to on startup
exports.getPageInfo = function() {
	var pageInfo = _pageInfo;
	_startupUrl = null;
	_pageInfo = null;
	return pageInfo;
}