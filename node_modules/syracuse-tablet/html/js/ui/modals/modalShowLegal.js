"use strict";

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var modalDialog = require('syracuse-tablet/html/js/ui/modals/modalDialog');
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');
var date = require('syracuse-tablet/html/js/helpers/types/date');

var _templateAll = {
	header: '\
			<buttons> \
				<button type="button" class="btn btn-default s-m-modal-btn-cancel pull-right" data-action="$cancel"></button> \
			</buttons> \
			<div class="modal-title">{{title}}</div> \
			',
	content: ' \
			<div class="s-m-scroll-wrapper s-m-scroll-wrapper-v">\
			<div class="s-m-scroll-element"> \
				<div class="form-group"> \
					<div class="s-m-header-brand"> \
						<span class="s-m-brand">{{label_brand}}</span> \
						<span class="s-m-product">{{label_product}}</span> \
					</div> \
					<span class="s-m-product-update-label">{{label_update}}</span><span class="s-m-product-update-value">{{update}}</span> \
				</div> \
				<div class="form-group"> \
					<h3>{{label_legal}}</h3> \
					<label>{{text1}}</label> \
					<label>{{text2}}</label> \
					<label>{{text3}}</label> \
					<label>{{text4}}</label> \
					<label>{{text5}}</label> \
					<label>{{text6}}</label> \
				</div> \
				<div class="form-group"> \
					<h3>{{label_license}}</h3> \
					{{#each licenses}} \
						<div class="s-m-field"><div class="s-m-title">{{../label_registrationNumber}}</div><div class="s-m-value">{{toRegNum}}</div></div> \
						<div class="s-m-field"><div class="s-m-title">{{../label_licensedTo}}</div><div class="s-m-value">{{toName}}</div></div> \
						<div class="s-m-field"><div class="s-m-title">{{../label_reference}}</div><div class="s-m-value">{{toRefNum}}</div></div> \
						<div class="s-m-field"><div class="s-m-title">{{../label_installedBy}}</div><div class="s-m-value">{{installedBy}}</div></div> \
						<div class="s-m-field"><div class="s-m-title">{{../label_expiryDate}}</div><div class="s-m-value">{{expiryDate}}</div></div> \
					{{/each}} \
				</div> \
			</div> \
			</div>',
	footer: ''
};

var _Klass = utils.defineClass(
	function ContextSelectionDialog() {
		var self = this;
		modalDialog.ModalBase.call(self);
	}, modalDialog.ModalBase, {
		_getTemplates: function() {
			var self = this;
			return {
				std: _templateAll
			};
		},

		getDisplayFlags: function() {
			var self = this;
			var displayFlags = self.displayFlags || {};
			if (self.deviceType === "tablet") {
				displayFlags.modalClass = "show-legal half_right";
			} else {
				displayFlags.modalClass = "show-legal full";
			}
			return displayFlags;
		},

		_getDataContext: function() {
			var self = this;
			return sdataHttp.send({
				method: "GET",
				url: "/sdata/syracuse/collaboration/syracuse/licenses/$service/current"
			}).
			then(function(data) {
				var version = null;
				var licenses = [];
				if (data && data.responseJSON)
					data.responseJSON.forEach(function(lic) {
						var l = {};
						l.expiryDate = locale.text("modal.legal.license.expiryDateValue", [date.getLocalShortDate(lic.validFrom), date.getLocalShortDate(lic.expiryDate)]);
						l.toName = lic.licensedTo.name;
						l.toRegNum = lic.licensedTo.registrationNumber;
						l.toRefNum = lic.licensedTo.reference;
						l.installedBy = lic.reseller.name;

						licenses.push(l);
						if (!version) {
							version = lic.productVersion;
						}
					});

				var data = {
					title: locale.text("modal.legal.title"),
					label_brand: locale.text("modal.legal.title_brand"),
					label_product: locale.text("modal.legal.title_x3"),
					label_update: locale.text("modal.legal.update"),
					label_license: locale.text("modal.legal.about.license"),
					label_legal: locale.text("modal.legal.about.legal"),
					update: version,
					licenses: licenses,
					builddate: locale.text("modal.legal.builddate", [globals.getBuildTimeStamp()]),
					text1: locale.text("modal.legal.text1"),
					text2: locale.text("modal.legal.text2"),
					text3: locale.text("modal.legal.text3"),
					text4: locale.text("modal.legal.text4"),
					text5: locale.text("modal.legal.text5"),
					text6: locale.text("modal.legal.text6"),
					label_registrationNumber: locale.text("modal.legal.license.registrationNumber"),
					label_licensedTo: locale.text("modal.legal.license.licensedTo"),
					label_reference: locale.text("modal.legal.license.reference"),
					label_userLicense: locale.text("modal.legal.license.userLicense"),
					label_installedBy: locale.text("modal.legal.license.installedBy"),
					label_server: locale.text("modal.legal.license.server"),
					label_expiryDate: locale.text("modal.legal.license.expiryDate")
				};

				return data;
			});
		},

		_onValidate: function() {},

		_onCancel: function() {},

		_getResult: function() {}
	}
);

exports.Modal = _Klass;