"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');

/*
 * add complements to utils.parseURL
 * {
   	"representation": "AQTCRUDM",
	"facet": "edit",

  	// for sdataDispatcher id "sdata" or "local"
  	"dispatch": "sdata",
  	"application": "x3",
  	"contract": "erp",
  	"dataset": "SUPERV",
  	"entity": "AQTCRUD",
  	
  	// entity id
  	"id": null,
}
 */
var _rID = /^(.*)\(\'(.*)\'\)$/i;
var _parseSDataURL = function(url) {
	var res = utils.parseURL(url);
	if (res.query && res.query.representation) {
		res.representation = res.query.representation;
		res.facet = null;
		var p = res.representation.indexOf('.');
		if (p != -1) {
			res.facet = res.representation.substr(p + 1);
			if (res.facet.charAt(0) == '$') res.facet = res.facet.substr(1);
			res.representation = res.representation.substr(0, p);
		}
	}
	var a = res.directory.split('/');
	if (a.length <= 4) {
		throw new Error("Bad sdata url:" + url);
	}
	res.dispatch = a[1];
	res.application = a[2];
	res.contract = a[3];
	res.dataset = a[4];
	if (a.length === 4) return res;
	var match = _rID.exec(a[5]);
	if (match && (match.length == 3)) {
		res.entity = match[1];
		res.id = match[2];
		if (res.id && res.id.trim().Length === 0) res.id = null;
	} else {
		res.entity = a[5];
		res.id = null;
	}
	if (a.length === 5) return res;
	return res;
};

/**
 * Resolve sdataurl and return navigation info to generate the <a>/<button> link
 */
var _getLinkInfo = function(sDataUrl, dao) {
	if (dao) { // dao is optional since a link can be a link without dataset (e.g. prev/next)
		sDataUrl = dao.parseExpression(sDataUrl);
	}
	var url = _parseSDataURL(sDataUrl);
	if (url.query.representation) {
		var ep = url.application + "." + url.contract + "." + url.dataset;
		return {
			type: 'navig',
			page: ep + "." + url.query.representation,
			sDataUrl: sDataUrl
		};
	} else {
		throw new Error("getLink - not implemented\n" + sDataUrl);
	}
};
/**
 * Returns attributes for link tag
 * 	linkInfo: 	object returned by _getLinkInfo
 * 				or sdataUrl
 * dao:			mandatory if linkInfo is a sdataUrl
 */
var _getLinkAttrs = function(linkInfo, dao) {
	if (typeof linkInfo === "string") {
		// We assume that linkInfo is the url - we need dao
		linkInfo = _getLinkInfo(linkInfo, dao);
	}
	if (linkInfo.type === "navig") {
		return 'data-nav="' + linkInfo.page + '" data-sdata-url="' + encodeURIComponent(linkInfo.sDataUrl) + '"';
	} else if (linkInfo.type === "act") {
		return 'data-action="' + linkInfo.action + '" data-params="' + encodeURIComponent((linkInfo.params || "")) + '"';
	} else {
		throw new Error("_getLinkAttrs - unknonwn type\n" + linkInfo.type);
	}
};

exports.parseSDataURL = _parseSDataURL;
exports.getLinkInfo = _getLinkInfo;
exports.getLinkAttrs = _getLinkAttrs;