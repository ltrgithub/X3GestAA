"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');

/*
 * add complements to utils.parseURL
 * {
   	"representation": "AQTCRUDM",
	"facet": "edit",

  	// for sdataDispatcher id "sdata" or "local"
  	"dispatch": "sdata",
  	"application": "x3",
  	"contract": "erp",
  	"dataset": "SUPERV",
  	"entity": "AQTCRUD",
  	
  	// entity id
  	"id": null,
  	"editActivity": false,
  	"createActivity": true
}
 */
var _rID = /^(.*)\(\'(.*)\'\)$/i;
var _parseSDataURL = function(url) {
	var res = utils.parseURL(url);
	if (res.query && res.query.representation) {
		res.representation = res.query.representation;
		res.facet = null;
		var p = res.representation.indexOf('.');
		if (p != -1) {
			res.facet = res.representation.substr(p + 1);
			if (res.facet.charAt(0) == '$') res.facet = res.facet.substr(1);
			res.representation = res.representation.substr(0, p);
		}
	}
	var a = res.directory.split('/');
	if (a.length <= 4) throw new Error("Bad sdata url\n" + url);
	res.dispatch = a[1];
	res.application = a[2];
	res.contract = a[3];
	res.dataset = a[4];
	if (a.length === 4) return res;
	var match = _rID.exec(a[5]);
	if (match && (match.length == 3)) {
		res.entity = match[1];
		res.id = match[2];
		if (res.id && res.id.trim().Length === 0) res.id = null;
	} else {
		res.entity = a[5];
		res.id = null;
	}
	if (a.length === 5) return res;
	var p = a[6];
	res.editActivity = p === "$workingCopies" && res.id != null;
	res.createActivity = p === '$template' || (p === "$workingCopies" && res.id == null);
	JSON.stringify(res, null, 2);
	return res;
};


exports.parseSDataURL = _parseSDataURL;