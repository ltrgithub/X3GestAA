"use strict";

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var globals = require('syracuse-tablet/html/js/helpers/globals');

var _welcomeApplication = {
	"$application": {
		"$uuid": "$welcomeApplication",

		"applicationName": "$welcomeApplication",
		"title": "Welcome",
		"description": "Welcome",
		"iconName": "gears",

		"$homeDashboard": {
			"$uuid": "$welcomeDashboard",
			"dashboardName": "$welcomeDashboard"
		},
	},
	"$dashboards": {
		"$welcomeDashboard": {
			"$pageInfo": {
				// Don't remove it - used to identify application welcome page
				"isWelcomePage": true,
				"disableAuthoring": true
			},
			"$update": function(dashboard, appMetaData) {
				return _updateWelcomeDashboard(dashboard, appMetaData);
			},
			"$dashboardName": "$welcomeDashboard",
			/* It's the first page, no need to explain that using title or description */
			"$title": "",
			"$description": "",
		}
	},
	"$gadgets": {}
};

/* we pass appMetaData as parameter to allow $update to refresh it (original appMetaData has been cloned) - see getAppDetail*/
function _updateWelcomeDashboard(dashboard, appMetaData) {
	dashboard.$vignettes = {};

	appMetaData.$gadgets = {};
	dashboard.$vignettes = {};
	dashboard.$article = {
		"$layoutType": "hub",
		"$items": [{
			"$layoutType": "hubGroup",
			"$title": "Applications",
			"$items": []
		}]
	};
	var meta = globals.getMetaData();
	return meta.getApplications().then(function(apps) {
		apps.forEach(function(app) {
			var name = app.applicationName;
			var appInfo = app;
			if (appInfo.applicationName !== appMetaData.$application.applicationName) {
				var name = "$welcome_" + appInfo.applicationName;
				var gadget = {
					"$type": "$application",
					"$title": appInfo.title,
					"applicationName": appInfo.applicationName
				};

				var vignette = {
					"$uuid": name
				};
				appMetaData.$gadgets[name] = gadget;
				dashboard.$vignettes[name] = vignette;
				dashboard.$article.$items[0].$items.push({
					$layoutType: "tile",
					$items: [{
						$bind: name
					}],
					$size: "medium"
				});
			}
		});
		return dashboard;
	});
}

exports.register = function() {
	clientContract.registerApp(_welcomeApplication);
};