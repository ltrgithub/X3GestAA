"use strict";

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var settings = require('syracuse-tablet/html/js/application/settings');

var _welcomeApplication = {
	"$application": {
		"$uuid": "$welcomeApplication",

		"applicationName": "$welcomeApplication",
		"title": "Welcome",
		"description": "Welcome",
		"iconName": "gears",

		"$homeDashboard": {
			"$uuid": "$welcomeDashboard",
			"dashboardName": "$welcomeDashboard"
		},
	},
	"$dashboards": {
		"$welcomeDashboard": {
			"$update": function(dashboard) {
				return _updateWelcomeDashboard(dashboard);
			},
			"$dashboardName": "$welcomeDashboard",
			"$title": "Welcome",
			"$description": "Welcome, this is your personal dashboard",
		}
	},
	"$gadgets": {
		"testLayoutsDashboard": {
			"$type": "$representation",
			"$title": "Query facet",
			"entity": "testDataTypes",
			"action": "$query",
			"representation": "testDataTypes",
			"facet": "$query",
			"keyParameter": "5"
		}
	}
};

function _updateWelcomeDashboard(dashboard) {

	dashboard.$vignettes = {
		"testLayoutsDashboard": {
			"$uuid": "testLayoutsDashboard",
			"$displayStyle": "$link"
		}
	};
	dashboard.$article = {
		"$layoutType": "stack",
		"$items": [{
			"$layoutType": "row",
			"displayOptions": {
				"rowHeight": "150px"
			},
			"$widthXs": "1",
			"$items": [{
				"$bind": "testLayoutsDashboard"
			}]
		}]
	};

	return settings.getMyApplications().then(function(apps) {
		dashboard.$vignettes = {};
		_welcomeApplication.$gadgets = {};

		dashboard.$article = {
			"$layoutType": "hub",
			"$items": [
				/* {
				"$layoutType": "hubGroup",
				"$title": "Gadgets",
				"$items": []
			}, */
				{
					"$layoutType": "hubGroup",
					"$title": "Applications",
					"$items": []
				}
			]
		};

		apps.forEach(function(app) {
			if (app.applicationName !== _welcomeApplication.$application.applicationName) {
				var name = "$welcome_" + app.applicationName;
				var gadget = {
					"$type": "$application",
					"$title": app.title,
					"applicationName": app.applicationName
				};

				var vignette = {
					"$uuid": name
				};
				_welcomeApplication.$gadgets[name] = gadget;
				dashboard.$vignettes[name] = vignette;

				dashboard.$article.$items[0].$items.push({
					$bind: name,
					$size: "wide"
				});
			}
		});
		return dashboard;
	});
}

exports.register = function() {
	clientContract.registerApp(_welcomeApplication);
};