"use strict";

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var settings = require('syracuse-tablet/html/js/application/settings');

var _welcomeApplication = {
	"$application": {
		"$uuid": "$welcomeApplication",

		"applicationName": "$welcomeApplication",
		"title": "Welcome",
		"description": "Welcome",
		"iconName": "gears",

		"$homeDashboard": {
			"$uuid": "$welcomeDashboard",
			"dashboardName": "$welcomeDashboard"
		},
	},
	"$dashboards": {
		"$welcomeDashboard": {
			"$pageInfo": {
				// Don't remove it - used to identify application welcome page
				"isWelcomePage": true,
				"disableAuthoring": true
			},
			"$update": function(dashboard, appMetaData) {
				return _updateWelcomeDashboard(dashboard, appMetaData);
			},
			"$dashboardName": "$welcomeDashboard",
			/* It's the first page, no need to explain that using title or description */
			"$title": "",
			"$description": "",
		}
	}
};

function _buildGadget(page) {
	if (page.dashboardName) {
		return _buildDashboardGadget(page);
	} else {
		return _buildRepresentationGadget(page);
	}
}

function _buildRepresentationGadget(page) {
	return {
		"$type": "$representation",
		"$title": page.title,
		"entity": page.entity,
		"action": page.action,
		"representation": page.representation,
		"facet": page.facet,
		"keyParameter": page.key
	};
}

function _buildDashboardGadget(page) {
	return {
		"$type": "$dashboard",
		"$title": page.title,
		"$dashboardName": page.dashboardName
	};
}

function _addPinnedPages(dashboard, appMetaData) {
	var grp;
	var pageId = 1;
	return settings.getPinnedPages()
		.then(function(pp) {
			if (pp.length <= 0) {
				return;
			}
			grp = {
				"$layoutType": "hubGroup",
				"$title": "Gadgets",
				"$items": []
			};
			pp.forEach(function(page) {
				var gadgetName = "$$$" + pageId;
				pageId++;
				var vignetteName = gadgetName;
				var gadget = _buildGadget(page);

				appMetaData.$gadgets[gadgetName] = gadget;

				dashboard.$vignettes[vignetteName] = {
					"$uuid": gadgetName,
					"$displayStyle": "$link"
				};

				grp.$items.push({
					$layoutType: "tile",
					$items: [{
						$bind: vignetteName
					}],
					$size: "small"
				});
			});
		})
		.then(function() {
			if (grp) {
				dashboard.$article.$items.push(grp);
			}
		});

}
/* we pass appMetaData as parameter to allow $update to refresh it (original appMetaData has been cloned) - see getAppDetail*/
function _updateWelcomeDashboard(dashboard, appMetaData) {
	appMetaData.$gadgets = {};
	dashboard.$vignettes = {};
	dashboard.$article = {
		"$layoutType": "hub",
		"$items": [{
			"$layoutType": "hubGroup",
			"$title": "Applications",
			"$items": []
		}]
	};

	return _addPinnedPages(dashboard, appMetaData)
		.then(function() {
			var meta = globals.getMetaData();
			return meta.getApplications();
		})
		.then(function(apps) {
			apps.forEach(function(app) {
				var name = app.applicationName;
				var appInfo = app;
				if (appInfo.applicationName !== appMetaData.$application.applicationName) {
					var name = "$welcome_" + appInfo.applicationName;
					var gadget = {
						"$type": "$application",
						"$title": appInfo.title,
						"applicationName": appInfo.applicationName
					};

					var vignette = {
						"$uuid": name
					};
					appMetaData.$gadgets[name] = gadget;
					dashboard.$vignettes[name] = vignette;
					dashboard.$article.$items[0].$items.push({
						$layoutType: "tile",
						$items: [{
							$bind: name
						}],
						$size: "medium"
					});
				}
			});
			return dashboard;
		});
}

exports.register = function() {
	clientContract.registerApp(_welcomeApplication);
};