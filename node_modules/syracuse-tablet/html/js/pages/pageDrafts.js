"use strict";

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiRect = require('syracuse-tablet/html/js/ui/rect');
var Base = require('syracuse-tablet/html/js/pages/pageHtml').Page;
var locale = require('syracuse-tablet/html/js/helpers/locale');
var eventListener = require('syracuse-tablet/html/js/application/eventListener');
var factory = require('syracuse-tablet/html/js/application/appFactory');
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var fontUtils = require('syracuse-tablet/html/js/ui/fontUtils');
var HammerScroller = require('syracuse-tablet/html/js/helpers/hammerScroller').Klass;
var formatApi = require('syracuse-tablet/html/js/helpers/formatApi');


var _templates = {
	error: '<section class="draft-error"><h1>{{error}}<h1><h2>{{contact}}<h2></section>',
	spinner: '\
		<div id="draftSpinner">\
   			<div>\
				<div class="spinner-loader"></div>\
			</div>\
		</div>',
	record: '\
			<section id="{{id}}" data-action="selectRecord" class="list-group-item s-m-draft-item {{status}}">\
				<div>\
					<div>\
						<div class="draft-title">{{title}}</div>\
						<div class="draft-date">{{creation_date}}</div>\
					</div>\
					<div>\
						<div class="draft-endpoint">{{endpoint}}</div>\
						<div class="draft-reason"><b>{{reason}}</b></div>\
					</div>\
					<div>\
						<div class="draft-comment"><i class="fa fa-comment-o"></i>{{comment}}</div>\
						<div class="draft-actions">\
							<span data-action="editDraft" class="fa fa-edit"></span>\
						</div>\
					</div>\
				</div>\
				<span class="badge checked fa fa-check">&nbsp;</span>\
			</section>',
	content: '\
			<div class="s-m-draft-header" style="display:none">\
				<div>\
					{{{selectMenu}}}\
				</div>\
				<div>\
					{{{filtersMenu}}}\
				</div>\
			</div>\
			<div id="draftInfo"  style="display:none">{{info}}</div>\
			<div id="draftPageWrapper" class="s-m-scroll-wrapper">\
				<div class="list-group s-m-draft-list">\
				</div>\
			</div>\
		</div>',
	selectMenu: '\
		<div id="draftSelectMenuId" class="btn-group">\
			<div class="{{dropDirection}}">\
				<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">\
					<span class="badge"></span>{{title}}<span class="caret"></span>\
				</button>\
				<ul class="dropdown-menu dropdown-menu-left" role="menu">\
					{{#each links}}\
						<li><a  {{#if $isHidden}}style="display:none"{{/if}} draggable="false"  data-action="selectMenu" data-params="{{params}}" href="#">{{title}}</a></li>\
					{{/each}}\
				</ul>\
			</div>\
		</div>',
	filtersMenu: '\
		<select id="draftFiltersMenu" data-action="filter">\
		{{#each filterOptions}}\
			<option value="{{value}}" {{#if selected}}selected{{/if}}>{{title}}</option>\
		{{/each}}\
		<select>'
};
//http://www.css-spinners.com/	
var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[name];
		tmpl = _templates[key] = Handlebars.compile(tmpl);
	}
	return tmpl(ctx);
};

var _selectOptionsList = ["unselectall", "selectall", "hideunselected", "showunselected"];
var _toolbarLinks = [{
	name: "stop",
	$isHidden: true
}, {
	name: "synch",
	$isDisabled: true,
	$confirm: true
}, {
	name: "remove",
	$isDisabled: true,
	$confirm: true
}];

var _Page = utils.defineClass(
	function DraftsPage($parent, state, options) {
		options.header = true;
		options.breadcrumbs = true;
		options.footer = true;
		Base.call(this, $parent, state, options);
		this._selectedFilter = "creation_date:dsc";
		this._initLabels();
		notifications.subscribe(this, ["sm.action.link"]);
		this.dateFormatter = formatApi.getFormatter("application/x-datetime");
	}, Base, {
		scrollAllowed: function() {
			return false;
		},
		_initLabels: function() {
			this._filterOptions = [{
				value: "creation_date:asc",
				title: locale.text("drafts.filters.dateasc")
			}, {
				value: "creation_date:dsc",
				title: locale.text("drafts.filters.datedsc")
			}];
		},
		destroy: function() {
			Base.prototype.destroy.call(this);
			if (this._myGestureMgr) {
				this._myGestureMgr.destroy();
				this._myGestureMgr = null;
			}
		},
		appendHtml: function($$parent, loadOpts) {
			var self = this;
			self.$$elmt.addClass("drafts");
			self.$$htmlRoot.html(_getHtml("content", {
				"filtersMenu": self._buildSortMenu(),
				"selectMenu": self._buildSelectMenu()
			}));
			self._$$selectMenu = self.$$htmlRoot.find("#draftSelectMenuId");
			self.$$info = self.$$htmlRoot.find("#draftInfo");
			self.$$listHeader = self.$$htmlRoot.find(".s-m-draft-header");
			self._$$list = self.$$htmlRoot.find(".s-m-draft-list");
			self.$$myScrollWrapper = self.$$elmt.find("#draftPageWrapper");
			self.$$myScrollWrapper.css({
				height: "auto"
			});
			self._myGestureMgr = new HammerScroller(self._$$list, {
				isPageScroller: true,
				direction: "v"
			});
			self._updateList();
		},
		/**
		 * Update the content of the list
		 */
		_updateList: function() {
			var self = this;
			self._$$list.empty();
			self._$$spinner = null;
			self.$$info.hide();
			self.$$listHeader.hide();
			globals.getStorage().draftOperation("draftReadList").then(function(resources) {
				resources = self._applyFilters(resources || []);
				var content;
				if (resources.length > 0) {
					var recordsHtml = [];
					resources.forEach(function(rsrc) {
						recordsHtml.push(self._getRecordHtml(rsrc));
					});
					content = recordsHtml.join('\n');
				}
				self._$$list.html(content);
				self._$$spinner = $(_getHtml("spinner")).appendTo(self._$$list);
				self._updateUI();
			}).fail(function(e) {
				globals.getModal().error(locale.text("drafts.error.loading"), e, function() {
					self._$$list.html(_getHtml("error", {
						error: locale.text("error"),
						contact: locale.text("contact.admin")
					}));
					self._updateMyGesture();
				});
			});
		},
		/**
		 * Update gesture manager on page resize
		 */
		onMainPageResize: function(info, orientation, deviceClass) {
			var self = this;
			if (self.destroyed) return;
			Base.prototype.onMainPageResize.call(self, info, orientation, deviceClass);
			setTimeout(function() {
				self._updateMyGesture(info ? info.preserveScroll : false);
			});
		},
		/**
		 * Update gesture manager
		 */
		_updateMyGesture: function(preserveScroll) {
			if (!this._myGestureMgr) return;
			var mainRect = uiRect.elmtRect(this.$$contentElmt, "outer");
			var viewRect = uiRect.elmtRect(this.$$myScrollWrapper, "outer");
			var scrollRect = mainRect.intersectRect(viewRect);
			if (scrollRect && scrollRect.height < this._myGestureMgr.$$elmt.height()) {
				this._myGestureMgr.init(scrollRect, null, null, preserveScroll);
			} else {
				this._myGestureMgr.reset();
			}
		},
		/**
		 * Returns the html of a record
		 */
		_getRecordHtml: function(rsrc) {
			rsrc = $.extend({}, rsrc);
			var date = rsrc["creation_date"];
			if (date) {
				rsrc["creation_date"] = this.dateFormatter.formatValue(date);
			}
			rsrc["reason"] = locale.text("drafts.status." + rsrc.status);
			return _getHtml("record", rsrc);
		},
		_buildSelectMenu: function() {
			var links = [];
			_selectOptionsList.forEach(function(id) {
				links.push({
					title: locale.text("multiselect.action." + id),
					params: id,
					$isHidden: false
				});
			});
			return _getHtml("selectMenu", {
				links: links,
				title: locale.text("multiselect.selected"),
				dropDirection: "dropdown"
			});
		},
		_buildSortMenu: function() {
			var self = this;
			self._selectedFilter = self._selectedFilter || "creation_date:asc";
			var opts = [];
			self._filterOptions.forEach(function(item) {
				item = $.extend({}, item);
				item.selected = item.value === self._selectedFilter;
				opts.push(item);
			});
			return _getHtml("filtersMenu", {
				"filterOptions": opts
			});
		},
		/**
		 * Update select menu according to the status of the records
		 * Update eth number of selected records
		 */
		_updateUI: function() {
			var allRecords = this._selectRecords("all").length;
			var selectedRecords = this._selectRecords(".selected").length;
			this._$$selectMenu.find('a[data-action]').toggle(selectedRecords > 0);
			this._$$selectMenu.find('a[data-params="selectall"]').toggle(allRecords !== selectedRecords);
			var hiddenUnselRecords = this._selectRecords(":not(.selected):not(:visible)").length;
			this._$$selectMenu.find('a[data-params="hideunselected"]').toggle(selectedRecords > 0 && selectedRecords < allRecords && hiddenUnselRecords == 0);
			this._$$selectMenu.find('a[data-params="showunselected"]').toggle(selectedRecords > 0 && hiddenUnselRecords > 0);
			this._$$selectMenu.find('.badge').text(selectedRecords);
			this.$$elmt.find(".draft-synch, .draft-remove").toggleClass("disabled", selectedRecords == 0);
			// Update draft counter
			this.$$info.text(locale.text("drafts.info", [allRecords]));
			// update header and info
			var isEmpty = allRecords == 0;
			if (isEmpty) {
				this._$$list.html(locale.text("drafts.emptyList"));
			}
			this._$$list.toggleClass("empty", isEmpty);
			this.$$info.toggle(!isEmpty);
			this.$$listHeader.toggle(!isEmpty);
			this._updateMyGesture();
		},
		/**
		 * Select records accordinbt to cssSelector
		 */
		_selectRecords: function(cssSelector) {
			var selector = "";
			if (cssSelector != "all") {
				selector += cssSelector;
			}
			return this._$$list.find("section.s-m-draft-item" + selector);
		},
		/**
		 * Edit draft - Switch endpoint if needed
		 */
		_actEditDraft: function(params, $$e, evt) {
			if (this._busy === true) {
				return;
			}
			var id = $$e.closest("section.s-m-draft-item").attr("id");
			if (!id) {
				return;
			}
			// Get the id and triggers application.openDraft
			eventListener.triggerAction(this.$$elmt, "openDraft", id);
		},
		/**
		 * Filter records
		 */
		_actFilter: function() {
			if (this._busy === true) {
				return;
			}
			var val = $(arguments[1]).val();
			if (val == this._selectedFilter) {
				return;
			}
			this._selectedFilter = val;
			this._updateList();
		},
		_applyFilters: function(resources) {
			if (!this._selectedFilter) {
				return resources;
			}
			var f = this._selectedFilter.split(":");
			if (f.length != 2) {
				return resources;
			}
			var property = f[0];
			var order = f[1];
			resources.sort(function(a, b) {
				a = a[property];
				b = b[property];
				if (a == b) return 0;
				if (a > b) return order == "asc" ? +1 : -1;
				if (a < b) return order == "asc" ? -1 : +1;
			});
			return resources;
		},
		/**
		 * Secltion/Unselection of records
		 */
		_actSelectMenu: function(action) {
			var self = this;
			switch (action) {
				case "selectall":
				case "unselectall":
					// First show all
					var elmts = self._selectRecords("all").show();
					if (action == "unselectall") {
						elmts = self._selectRecords(".selected");
					}
					elmts.each(function() {
						self._toggleRecordSelection($(this), action === "selectall");
					});
					break;
				case "hideunselected":
					self._selectRecords(":not(.selected)").hide();
					break;
				case "showunselected":
					self._selectRecords(":not(.selected)").show();
					break;
			}
			this._updateUI();
		},
		/**
		 * Toggle record's selection
		 */
		_actSelectRecord: function(params, $$elmt, force) {
			var $$rec = $$elmt.closest(".s-m-draft-item");
			this._toggleRecordSelection($$elmt.closest(".s-m-draft-item"));
			this._updateUI();
		},
		/**
		 * force true/false/undefined
		 */
		_toggleRecordSelection: function($$rec, force) {
			if (!$$rec || $$rec.length == 0) return;
			$$rec.toggleClass("selected", force);
		},
		/**
		 * Start upload/remove
		 */
		_mainProcessBegin: function(name, ids) {
			this._stop = false;
			this._busy = true;
			this._logData = {
				nbSuccess: 0,
				nbErrors: 0
			};
			this.$$elmt.find(".draft-stop").removeClass("disabled").show();
			this._selectRecords(":not(.selected)").hide();
		},
		/**
		 * End upload/remove
		 */
		_mainProcessEnd: function(name) {
			this._busy = false;
			this.$$elmt.find(".draft-stop").hide();
			this._updateUI();
			this.$$elmt.find(".synchronized").removeClass("synchronized");
			this._selectRecords(":not(.selected)").show();
		},
		/**
		 * Upload alld the records given by ids array and resolve like _uploadPop
		 * Resolves stoppewith stopped/completed
		 */
		_upload: function(ids) {
			var self = this;
			self._mainProcessBegin("upload", ids);
			var join = $.Deferred();
			self._uploadPop(ids).then(function(status) {
				self._mainProcessEnd("upload");
				join.resolve(status);
			}).fail(function(e) {
				self._mainProcessEnd("upload", ids);
				join.reject(e);
			});
			return join.promise();
		},
		/**
		 * Pop the ids ids array and upload them
		 * Returns the promise that will be resolve when:
		 * 	- upload succeeded (status = completed)
		 * 	- upload failed with an exception
		 * 	- upload stopped (status = stopped)
		 * _mainDeferred is null when we call _uploadPop outside the method
		 */
		_uploadPop: function(ids, _mainDeferred) {
			var first = _mainDeferred == null;
			if (first) {
				_mainDeferred = $.Deferred();
			}
			try {
				if (this._stop === true) {
					_mainDeferred.resolve("stopped");
					return;
				}
				if (!ids || ids.length == 0) {
					_mainDeferred.resolve("completed");
					return;
				}
				var self = this;
				self._uploadOne(ids.pop()).then(function() {
					setTimeout(function() {
						self._uploadPop(ids, _mainDeferred);
					});
				}).fail(function(e) {
					_mainDeferred.reject(e);
				});
			} catch (e) {
				_mainDeferred.reject(e);
			}
			return first ? _mainDeferred.promise() : null;
		},
		/**
		 * Upload the record given by id
		 * Resolve if no exception
		 * If upload succeeds 		-> Remove the draft and resolve
		 * If upload not succeeds 	-> Update the draft with new error and resolve
		 * If exception --> Reject
		 */
		_uploadOne: function(id) {
			var self = this;
			var deferred = $.Deferred();
			self._uploadOneBegin(id).then(function(ctx) {
				if (!ctx || !ctx.restoredContext) {
					throw new Error("unexpected null draft context");
				}
				if (!ctx.saveLink || !ctx.saveLink.sDataUrl) {
					throw new Error("unexpected null save link info");
				}
				return globals.getMetaData().getPageDetails(ctx.restoredContext.currentState).then(function(info) {
					return $.smResolve(ctx, info);
				}).fail(function(e) {
					return $.smReject(e);
				});
			}).then(function(draftCtx, info) {
				var dao = factory.createDaoSdata(draftCtx.dataSet, info.prototype);
				var payload = dao.getActionPayload(draftCtx.saveLink, true);
				return dispatcher.dispatch({
					$url: draftCtx.saveLink.sDataUrl,
					$method: draftCtx.saveLink.$method
				}, payload).then(function(result) {
					if (!result) {
						throw new Error("unexpected null http response");
					}
					var responseJSON = result.responseJSON || {};
					var next;
					if (!result.isSuccess) {
						if (result.status === 401) {
							// KO - Reject to display a dialog and stop process
							next = $.smReject(locale.text("drafts.error.unauthorized"));
						} else if (result.responseJSON && result.responseJSON.$noConnectionError === true) {
							// KO - Reject to display a dialog and stop process
							next = $.smReject(locale.text("drafts.error.noconnection"));
						} else {
							// KO - Set up draft with new error and date
							dao.updateMeta(responseJSON);
							draftCtx.status = "error";
							draftCtx["creation_date"] = utils.getCurISODateTime(new Date());
							next = self._uploadOneEnd(id, "saveFailed", {
								draftCtx: draftCtx
							});
						}
					} else {
						// OK
						next = self._uploadOneEnd(id, "saveSucceeded");
					}
					return next;
				});
			}).then(function() {
				deferred.resolve();
			}).fail(function(e) {
				if (typeof e === "string") {
					e = {
						$diagnoses: [{
							$message: e
						}]
					};
				}
				// Exception expected
				return self._uploadOneEnd(id, "exception", {
					exception: e
				}).always(function(e) {
					deferred.reject(e);
				});
			});
			return deferred.promise();
		},
		/**
		 * Init the spinner before processing record (sunch, remove..)
		 */
		_processRecordBegin: function($$rec) {
			if (this._$$spinner) {
				var pos = $$rec.position();
				this._$$spinner.css({
					top: pos.top + "px",
					display: 'table'
				});
				this._$$spinner.children().outerHeight($$rec.outerHeight()).show();
			}
			if (this._myGestureMgr) {
				this._myGestureMgr.makeVisible($$rec);
			}
		},
		/**
		 * Reset the spinner
		 */
		_processRecordEnd: function($$rec) {
			if (this._$$spinner) {
				this._$$spinner.hide();
			}
			if ($$rec) {
				// nothing
			}
		},
		/**
		 * Set the ui context
		 * Reads the draft
		 */
		_uploadOneBegin: function(id) {
			this._processRecordBegin(this.$$elmt.find("#" + id));
			return globals.getStorage().draftOperation("draftRead", id);
		},
		/**
		 * Set ui context
		 * Save/Delete the draft according to the status
		 */
		_uploadOneEnd: function(id, status, opts) {
			var self = this;
			var $$record = this.$$elmt.find("#" + id);
			this._processRecordEnd($$record);
			if (status === "saveSucceeded") {
				return globals.getStorage().draftOperation("draftDelete", id).then(function() {
					self._logData.nbSuccess++;
					$$record.remove();
				}).fail(function(e) {
					return $.smReject(e);
				});
			} else if (status === "saveFailed") {
				self._logData.nbErrors++;
				return globals.getStorage().draftOperation("draftSave", opts.draftCtx).then(function() {
					var $$newRecord = $(self._getRecordHtml(opts.draftCtx)).addClass("selected synchronized");
					$$record.after($$newRecord);
					$$record.remove();
				}).fail(function(e) {
					return $.smReject(e);
				});
			} else if (status === "exception") {
				return $.smReject(opts.exception);
			} else {
				// Exception
				return $.smReject(new Error("Unexpected draft status"));
			}
		},
		/**
		 * Synchronize the selected drafts
		 */
		_actSynch: function() {
			var self = this;
			self._upload(self._selectRecords(".selected").map(function() {
				return this.id;
			}).get().reverse()).then(function(status) {
				var nbSuccess = self._logData.nbSuccess;
				var nbErrors = self._logData.nbErrors;
				var count = nbSuccess + nbErrors;
				globals.getModal().notify({
					title: locale.text("drafts.synch." + status),
					body: locale.text("drafts.synch.result", [count, nbSuccess, nbErrors]),
					severityClass: nbErrors > 0 ? "warning" : "success"
				});
			}).fail(function(e, status) {
				globals.getModal().error(locale.text("drafts.error.uploading"), e);
			});
		},
		/**
		 * Pop a record and removes it
		 * Resolves or rejects mainDeferred if an error occurs
		 * Returns the promise on first call
		 */
		_removePop: function($$records, mainDeferred) {
			var self = this;
			var first = mainDeferred == null;
			if (first) {
				mainDeferred = $.Deferred();
			}
			var $$rec = $$records.length > 0 ? $$records.pop() : null;
			if ($$rec == null) {
				mainDeferred.resolve();
				return;
			}
			self._processRecordBegin($$rec);
			globals.getStorage().draftOperation("draftDelete", $$rec.attr("id")).then(function() {
				self._logData.nbSuccess++;
				$$rec.remove();
				setTimeout(function() {
					self._removePop($$records, mainDeferred);
				}, 500);
			}).fail(function(e) {
				mainDeferred.reject(e);
			});
			return first ? mainDeferred.promise() : null;
		},
		/**
		 * Remove selected records
		 */
		_actRemove: function() {
			var self = this;
			var _end = function() {
				self._busy = false;
				self._processRecordEnd(null);
				self._updateUI();
			};
			self._busy = true;
			self._logData = {
				nbSuccess: 0
			};
			// List of ids to delete
			var $$records = self._selectRecords(".selected").map(function() {
				return $(this);
			}).get().reverse();
			// Delete selected drafts
			self._removePop($$records).then(function() {
				globals.getModal().notify({
					title: locale.text("drafts.remove.completed", [self._logData.nbSuccess]),
					severityClass: "success"
				});
				_end();
			}).fail(function(e) {
				globals.getModal().error(locale.text("drafts.error.removing"), e, function() {
					_end();
				});
			});
		},
		/** Event sm.action.link
		 *  Notified when a action succeeded - sdata link - see action manager
		 *  success:	true/false
		 *  link:		Link info
		 *  result:		Json response
		 */
		notifActionLink: function(success, link, result, options) {
			if (!this.isActive()) return;
			switch (link.name) {
				case "synch":
					this._actSynch();
					break;
				case "remove":
					this._actRemove();
					break;
				case "stop":
					this._stop = true;
					break;
			}
		},
		/**
		 * Returns the links to display in the header/footer
		 */
		getToolbarLinks: function(toolbar, options) {
			var device = globals.getSiteLayout().getDeviceType();
			if ((device === "tablet" && toolbar === "footer") || (device === "smartphone" && toolbar === "header")) {
				var result = [];
				_toolbarLinks.forEach(function(act) {
					result.push({
						"name": act.name,
						"title": locale.text("drafts.action." + act.name),
						"icon": fontUtils.getDraftIcons(act.name),
						"$uuid": utils.UUID(),
						"css": "draft-" + act.name,
						"footerHeader": true,
						"isClientAction": true,
						"$confirm": act.$confirm === true ? locale.text("drafts.dlog.confirm." + act.name) : null,
						"$isHidden": act.$isHidden === true,
						"$isDisabled": act.$isDisabled === true
					});
				});
				return result;
			}
			return null;
		}
	});

exports.Page = _Page;