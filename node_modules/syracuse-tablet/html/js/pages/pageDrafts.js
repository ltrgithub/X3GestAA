"use strict";

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/pageHtml').Page;
var locale = require('syracuse-tablet/html/js/helpers/locale');
var eventListener = require('syracuse-tablet/html/js/application/eventListener');

var _pageTemplate = '\
		<div class="s-m-drafts-header">\
			<h3>DRAFT LIST - COUNT {{count}}</h3>\
		</div>\
		{{#if isEmpty}}\
			<div>EMPTY LIST</div>\
		{{else}}\
			<div class="list-group s-m-drafts-list">\
			{{#each resources}}\
				<section id="{{id}}" style="padding:10px" class="list-group-item s-m-draft-item {{status}}">\
					<div style="display:table;width:100%">\
						<div style="display:table-row;width:100%">\
							<div style="display:table-cell">\
								<div>\
									<span style="float:left"><b>{{title}}</b></span>\
									<span style="float:right"><b><small>{{creation_date}}</small></b></span>\
								</div>\
								<div style="clear: both;"><b>{{endpoint}} - {{representation}}</span></b></div>\
								<div><span>{{reason}}</span><span>{{comment}}</span></div>\
							</div>\
							<div style="display:table-cell;width:4em;font-size:1.5em;position:relative;padding-left: 15px;">\
								<div style="display:table;width:100%;position:absolute;top:-6px;">	\
									<div style="display:table-cell;width:50%;text-allign:center;">\
										<div data-action="delete" class="fa fa-times"></div>\
									</div>\
									<div style="display:table-cell;width:50%;text-allign:center;">\
										<div data-action="openDraft" data-params={{id}} class="fa fa-pencil-square-o""></div>\
									</div>\
								</div>\
							</div>\
						<div>\
					<\div>\
				</section>\
			{{/each}}\
			</div>\
		{{/if}}\
	';

var _Page = utils.defineClass(

	function DraftsPage($parent, state, options) {
		options.header = true;
		options.footer = false;
		Base.call(this, $parent, state, options);
		this._htmlTemplate = Handlebars.compile(_pageTemplate);
	}, Base, {
		scrollAllowed: function() {
			return true;
		},
		destroy: function() {
			Base.prototype.destroy.call(this);
		},
		appendHtml: function($$parent, loadOpts) {
			this.$$elmt.addClass("drafts");
			this._refreshList($$parent);
		},
		_refreshList: function($$parent) {
			var self = this;
			$$parent = $$parent || self.$$htmlRoot;
			$$parent.empty();
			globals.getStorage().draftOperation("draftReadList").then(function(resources) {
				$$parent.html(self._htmlTemplate({
					resources: resources,
					count: resources ? resources.length : 0,
					isEmpty: resources == null || resources.length == 0
				}));
			});
		},
		_getRecordId: function($$e) {
			return $$e.closest("section.s-m-draft-item").attr("id");
		},
		_actDelete: function(params, $$e, evt) {
			var self = this;
			globals.getStorage().draftOperation("draftDelete", self._getRecordId($$e)).then(function() {
				self._refreshList();
			});
		}
	});

exports.Page = _Page;