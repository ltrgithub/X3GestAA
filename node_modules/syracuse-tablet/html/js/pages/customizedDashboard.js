"use strict";

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var Base = require('syracuse-tablet/html/js/pages/pageDashboard').Page;
var modalConfigTile = require('syracuse-tablet/html/js/ui/modals/modalConfigTile');
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');
var dragManager = require('syracuse-tablet/html/js/ui/dragManager').DragManager;
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var modalChooseDashboardGroup = require('syracuse-tablet/html/js/ui/modals/modalChooseDashboardGroup');
var fontUtils = require('syracuse-tablet/html/js/ui/fontUtils');
var _initConfigPage = false;
var _scroll = 0;
var _Page = utils.defineClass(

	function CustomizedDashboard($parent, state, prototype, article, options) {
		Base.call(this, $parent, state, prototype, article, options);
	}, Base, {
		destroy: function() {
			this.destroyConfigHeaderFooter();
			$(".s-m-hub-group > header > input.title").off("change");
			//$(".s-m-group-handle").off("mousedown")
			Base.prototype.destroy.call(this);
		},
		afterRender: function(loadOptions, buildOpts) {
			var self = this;
			// This page is loaded synchronously - We need to wait until all vignettes has been loaded to continue
			// Needed by the restoreContext process (see application.notifUserLoggedIn)
			loadOptions.forceSynchroVignettes = true;
			return Base.prototype.afterRender.call(self, loadOptions, buildOpts).then(function() {
				if (_initConfigPage) {
					self._toggleConfigPage("enable");
				}
				_initConfigPage = false;
			});
		},
		_actPageConfig: function() {
			var self = this;
			self._toggleConfigPage();
		},

		_actCancelPageConfig: function() {
			var self = this;
			self._toggleConfigPage();
		},
		_actPublishPageConfig: function() {},
		_actRemoveTile: function(vignetteId) {},
		_actRemoveGroup: function(id) {},
		/*see later keep or not drag group  
		_titleDrag:function(event){
			notifications.publish("sm.drag.state.change", true); // set title drag enabled
		},*/
		_titleChange: function(event, opt) {
			var self = this;
			this._setLocalization(opt.title.val(), opt.title.attr("data-old-uuid")).
			then(function(uuid) {
				self._changeHubGroupTitle(opt.layout, uuid);
			});
		},
		_changeHubGroupTitle: function(layout, uuid) {
			var self = this;
			return globals.getMetaData().getDashboard(self.prototype.getDataByPath("$dashboardName")).then(function(dashboard) {
				var idx = $.inArray(layout.article, self.article.$items);
				if (idx >= 0) {
					self.article.$items[idx].$title = "{@" + uuid + "}";
					dashboard.$article = self.article;
					self.dirty = true
					notifications.publish(["sm.dashboard.state.change"], self._getHeaderFooterOptions());
				};
			})
		},
		_actChangeGroupTile: function(vignetteId) {
			var self = this;
			var tileToMove = self._getTileInfo(vignetteId);
			var layoutGroupOriginId = tileToMove.ctrl.parent.parent.id;
			var groups = [];
			self.rootLayout.children.forEach(function(group) {
				if (group.id !== layoutGroupOriginId) {
					groups.push({
						"title": group.getTitle(),
						"id": group.id
					})
				}
			})

			var modal = new modalChooseDashboardGroup.Modal(groups);
			modal.show().then(function(result) {
				if (result) {
					var groupSelected = result.id;
					var opts = {
						dragId: vignetteId,
						dropId: result,
						where: "append"
					}
					self._moveTile(opts);
				}
			});
		},
		_afterChangePage: function(opts) {
			opts = opts || {};
			this._toggleConfigPage(opts.forceStatus);
			_initConfigPage = (opts.forceStatus != "disabled"); //true; // Force auto start of page config on reload
			var gesture = this.getGestureMgr();
			_scroll = opts.scroll == "end" ? 99999 : (opts.keepScrollValue ? _scroll : this.getGestureMgr().getScroll());
		},
		_initScroll: function(preserveScroll) {
			var self = this
			Base.prototype._initScroll.call(self, preserveScroll);
			var gesture = this.getGestureMgr();
			if (_scroll === 99999) {
				_scroll = (gesture.getScrollMin()) - (30 * (gesture.isNative() ? 1 : -1))
			}
			self.getGestureMgr().autoScroll(_scroll);
		},
		_actConfigTile: function(vignetteId) {
			var self = this;

			var ti = self._getTileInfo(vignetteId);
			var classes = ti.$$tile.attr("class");

			var size = "medium";
			var cls = classes.split(" ");
			var validSizes = ["small", "medium", "wide", "large", "full", "all"];
			cls && cls.some(function(c) {
				if (validSizes.indexOf(c) > -1) {
					size = c;
					return true;
				}
				return false;
			});

			var color = /s-m-color-(\w+)/.exec(classes);
			color = (color && color.length > 1 && color[1]) || "darkgrey";
			var tile = {
				title: ti.title || ti.gadget.$title,
				color: color,
				size: size,
				icon: ti.icon || ti.gadget.icon
			};
			var modal = new modalConfigTile.Modal(tile);
			modal.show().then(function(result) {
				if (result != null) {
					self._applyTileChanges(ti, result);
				}
			});
		},
		_applyTileChanges: function(tileInfo, tile) {

		},
		_toggleConfigPage: function(forceStatus) {
			if (!this._configHeader && forceStatus != "disabled") {
				this._configHeader = ctrlFactory.createDashboardConfigHeader(this, this._getHeaderFooterOptions())
			}
			if (!this._configFooter && forceStatus != "disabled") {
				this._configFooter = ctrlFactory.createDashboardConfigFooter(this, this._getHeaderFooterOptions())
			}
			var enable = forceStatus != null ? forceStatus == "enable" : !this.configActive;
			this.toggleHeaderFooter("header", this._configHeader, enable);
			this.toggleHeaderFooter("footer", this._configFooter, enable);
			if (enable === true) {
				this.enabledConfig();
			} else {
				this.disableConfig();
			}
		},
		destroyConfigHeaderFooter: function() {
			if (!this._configHeader && !this.configFooter) return;
			// remove from controller and restore regular one (null)
			this.toggleHeaderFooter("header", null);
			this.removeControl(this._configHeader);
			this._configHeader.destroy();
			this._configHeader = null;

			this.toggleHeaderFooter("footer", null);
			this.removeControl(this._configFooter);
			this._configFooter.destroy();
			this._configFooter = null;

		},
		_getHeaderFooterOptions: function() {
			return null;
		},
		_actCloseDashboardConfig: function() {
			this._toggleConfigPage("disable");
		},
		_dragUI: function(ev) {
			if ($(ev.currentTarget).hasClass("s-m-group-handle")) {
				return $(ev.currentTarget).parent().clone();
			} else {
				return $(ev.currentTarget).clone();
			}
		},
		enabledConfig: function(options) {
			var self = this;
			self.configActive = true;
			var $$tiles = $(".s-m-tile", self.$$elmt);
			$$tiles.addClass("s-m-tile-edit");
			var $$hubGroups = $(".s-m-hub-group", self.$$elmt);
			for (var i = 0; i < $$tiles.length; i++) {
				var $$tile = $($$tiles[i]);
				$$tile.attr("data-tile-config-id", i);
				$$tile.attr("data-disable-navigation", true);
				var $$vignette = $(".s-m-vignette", $$tile);
				if (!$$tile.attr("data-empty-tile")) { //not empty
					$$tile.append($('<div class="cfg insert top" data-param="top" data-vignette-id="' + $$vignette.attr('id') + '"></div>'));
					$$tile.append($('<div class="cfg insert bottom" data-param="bottom" data-vignette-id="' + $$vignette.attr('id') + '"></div>'));
					$$tile.append($('<div class="cfg insert left" data-param="left" data-vignette-id="' + $$vignette.attr('id') + '"></div>'));
					$$tile.append($('<div class="cfg insert right" data-param="right" data-vignette-id="' + $$vignette.attr('id') + '"></div>'));
					if ($$hubGroups.length > 1) $$tile.append($('<btn class="cfg changegroup ' + fontUtils.dashboardIcon("moveTile") + '" data-action="changeGroupTile" data-params="' + $$vignette.attr('id') + '">'));
					$$tile.append($('<btn class="cfg config ' + fontUtils.dashboardIcon("editTile") + '" data-action="configTile" data-params="' + $$vignette.attr('id') + '">'));
					$$tile.append($('<btn class="cfg remove ' + fontUtils.dashboardIcon("removeTile") + '" data-action="removeTile" data-params="' + $$vignette.attr('id') + '">'));
				} else {
					$$tile.append($('<btn class="cfg remove ' + fontUtils.dashboardIcon("removeTile") + '" data-action="removeEmptyTile" data-params="' + $$tile.attr('data-empty-tile') + '">'));
				}
			}
			$$hubGroups.each(function() {
				var layout = self.getLayout($(this).attr("id"));
				if (layout.isEditable) {
					/* remove for moment see later if keep this capability
				    var $$handle=layout.$$header.prepend($('<btn class="cfg move fa fa-ellipsis-v s-m-group-handle" id="' + $(this).attr("id") + '">'));
					$$handle.on("mousedown", jsutils.bindFn(self._titleDrag, self))
					*/

					var $$title = $(".title", layout.$$header);
					$$title.removeAttr("readonly");
					$$title.on("change", jsutils.bindFn(self._titleChange, self, {
						"layout": layout,
						"title": $$title
					}));
					if (layout.isDeletable && (!layout.children || layout.children.length === 0)) {
						layout.$$header.append($('<btn class="cfg remove ' + fontUtils.dashboardIcon("removeGroup") + '" data-action="removeGroup" data-params="' + $(this).attr("id") + '">'));
					}
					var active = (!$(this).is(":last-child"))
					layout.$$header.append($('<btn class="cfg move s-m-move-group ' + (!active ? 'disabled ' : '') + fontUtils.dashboardIcon("moveGroupBefore") + (active ? '" data-action="moveGroup" data-params="right,' + $(this).attr("id") : ' ') + '">'));
					active = (!$(this).is(":first-child"))
					layout.$$header.append($('<btn class="cfg move s-m-move-group ' + (!active ? 'disabled ' : '') + fontUtils.dashboardIcon("moveGroupAfter") + (active ? '" data-action="moveGroup" data-params="left,' + $(this).attr("id") : ' ') + '">'));


				}
			});
			self._dragManagerCreate();
			notifications.subscribe(self, ["sm.dashboard.title.change"]);
			notifications.subscribe(self, ["sm.vignette.pressed"]);
		},
		notifDashboardTitleChange: function(title) {

		},
		notifVignettePressed: function(vignetteId) { // long click on tile
			var tileInfo = this._getTileInfo(vignetteId);
			tileInfo.$$tile.toggleClass("s-m-draggable", true);
			notifications.publish("sm.drag.state.change", true); // set tile drag enabled
		},
		_dragManagerDestroy: function() {
			if (this.dragManager) {
				notifications.unsubscribe(this, this.dragManager.getNotifs());
				this.dragManager.destroy();
				this.dragManager = null;
			}
		},
		_dragManagerCreate: function() {
			var self = this;
			var dragOpts = {
				selector: ".s-m-hub-group>header>.s-m-group-handle,.s-m-tile:not([data-empty-tile])",
				enable: false,
				notify: {
					start: "sm.drag.start",
					stop: "sm.drag.stop",
				},
				options: {
					opacity: 0.4,
					delay: 0,
					scrollSensitivity: 100,
					scrollSpeed: 50,
					helper: self._dragUI,
				}
			};
			var dropOpts = {
				selector: ".s-m-hub-group,.insert",
				notify: {
					drop: "sm.element.drop",
					out: "sm.element.out",
					over: "sm.element.over"
				},
				options: {
					helper: "clone",
				}
			};
			self.dragManager = new dragManager(dragOpts, dropOpts, self.$$elmt);
			notifications.subscribe(self, self.dragManager.getNotifs());
		},
		disableConfig: function() {
			var self = this;
			//_scroll = 0;
			self._dragManagerDestroy();
			self.configActive = false;
			if (self.$$pageConfigHeader) {;
				self.$$pageConfigHeader.remove();
				self.$$pageConfigHeader = null;

			}
			self.getPageControl("footer").show()
			$(".s-m-tile-edit").removeClass("s-m-tile-edit");
			$(".cfg", self.$elmt).remove();
			notifications.unsubscribe(self, ["sm.dashboard.title.change"]);
		},
		notifDragStart: function($$dragElt, ui) {
			if ($$dragElt.is(".s-m-hub-group>header>.s-m-group-handle")) {
				$$dragElt.closest(".s-m-hub-group").toggleClass("s-m-not-droppable", true);
				ui.helper.css("width", ui.helper.css("width"));
				ui.helper.css("background-color", "#009fda");
				ui.helper.css("color", "white");
			}
		},
		notifDragStop: function($$dragElt, ui) {
			notifications.publish("sm.drag.state.change", false) // set drag disabled
			$$dragElt.toggleClass("s-m-draggable", false);
			if ($$dragElt.is(".s-m-hub-group>header>.s-m-group-handle")) {
				$$dragElt.closest(".s-m-hub-group").toggleClass("s-m-not-droppable", false);
				return
			};
		},
		notifElementDrop: function($$dropElt, ui, params) {
			var $$dragElt = ui.draggable;
			if ($$dragElt.hasClass("s-m-tile")) this._tileDrop($$dropElt, $$dragElt, params)
			if ($$dragElt.is(".s-m-hub-group > header > .s-m-group-handle")) this._groupDrop($$dropElt, $$dragElt, params)
		},
		_tileDrop: function($$dropElt, $$dragElt, params) {
			var optsMoveTile = this._getOptsMoveTile($$dropElt, $$dragElt, params)
			if (optsMoveTile.where === "append" && !$$dropElt.hasClass("empty")) return
			this._moveTile(optsMoveTile);
		},
		_groupDrop: function($$dropElt, $$dragElt, params) {
			var $$goupTarget = $$dropElt.closest(".s-m-hub-group");
			if ($$goupTarget.hasClass("s-m-not-droppable")) return
			var layoutTarget = this._layoutsMap[$$goupTarget.attr("id")];
			var $$goupToMove = $$dragElt.closest(".s-m-hub-group");
			var layoutToMove = this._layoutsMap[$$goupToMove.attr("id")];

			this._moveGroup(layoutTarget, layoutToMove);
		},
		_actMoveGroup: function(where, id) {
			var layoutToMove = this._layoutsMap[id];
			var $$goupTarget = (where === "right") ? layoutToMove.$$elmt.next() : layoutToMove.$$elmt.prev();
			var layoutTarget = this._layoutsMap[$$goupTarget.attr("id")];

			/*===========hack to compute scroll===============*/
			var position = layoutTarget.$$elmt.position();
			if (this._prevPageInfo.orientation === "landscape") {
				if (where === "right") {
					_scroll = position.left - parseInt(layoutToMove.$$elmt.width(), 10) + parseInt(layoutTarget.$$elmt.width(), 10) - 100
				} else {
					_scroll = position.left - 100
				}
			} else {
				if (where === "right") {
					_scroll = position.top - parseInt(layoutToMove.$$elmt.height(), 10) + parseInt(layoutTarget.$$elmt.height(), 10) - 100
				} else {
					_scroll = position.top - 100
				}
			}
			_scroll = _scroll * (this.getGestureMgr().isNative() ? 1 : -1)
				/*====================================*/

			if (where === "right") {
				this._moveGroup(layoutTarget, layoutToMove);
			} else {
				this._moveGroup(layoutToMove, layoutTarget);
			}
		},
		_getOptsMoveTile: function($$dropElt, $$dragElt, params) {
			var optMoveTile = {
				dropId: $$dropElt.attr("id"),
				dragId: $(".s-m-vignette", $$dragElt).attr("id"),
				where: "append" // Append inside group
			};
			if ($$dropElt.hasClass("insert")) {
				optMoveTile.dropId = params ? params.target : $$dropElt.attr("data-vignette-id");
				optMoveTile.where = params ? (params.before ? "top" : "bottom") : $$dropElt.attr("data-param");
			};
			return optMoveTile;
		},
		notifElementOut: function($$dropElt, ui) {
			var $$dragElt = ui.draggable;
			if ($$dragElt.is(".s-m-hub-group>header> .s-m-group-handle")) {
				var $$group = $$dropElt.closest(".s-m-hub-group");
				$$group.toggleClass("s-m-over-droptarget", false);
			}
			this.dragManager.hideIndicator();
		},
		notifElementOver: function($$dropElt, ui) {
			var $$dragElt = ui.draggable;
			if ($$dragElt.hasClass("s-m-tile")) this._tileOver($$dropElt, $$dragElt)
			if ($$dragElt.is(".s-m-hub-group>header > .s-m-group-handle")) this._groupOver($$dropElt, $$dragElt)
		},
		_tileOver: function($$dropElt, $$dragElt) {
			var optsMoveTile = this._getOptsMoveTile($$dropElt, $$dragElt);
			var cellOrigineInfo = this._getCellInfo(optsMoveTile.dragId);
			var targetInfo = (optsMoveTile.where === "append" && $$dropElt.hasClass("empty")) ? this._getGroupInfo(optsMoveTile.dropId, $$dropElt) : this._getCellInfo(optsMoveTile.dropId);

			var where = this._tileWhere(optsMoveTile, cellOrigineInfo, targetInfo);

			if (where && where.parent) {
				var opts = {
					top: where.top,
					left: where.left,
					height: where.height,
					width: where.width,
					$$parent: where.parent,
				};
				this.dragManager.showIndicator(opts, {
					before: where.before,
					target: where.idTileTarget || where.idTarget
				});
			} else {
				this.dragManager.hideIndicator();
			}
		},
		_groupOver: function($$dropElt, $$dragElt) {
			var $$group = $$dropElt.closest(".s-m-hub-group");
			if ($$group.hasClass("s-m-not-droppable")) return
			$$group.toggleClass("s-m-over-droptarget", true);
			var $$header = $("header:first", $$group);
			if ($$header.length > 0) {
				var opts = {
					$$parent: $$group,
				};
				this.dragManager.showIndicator(opts, {
					before: false,
					target: ""
				});
			} else {
				this.dragManager.hideIndicator();
			}
		},
		_tileWhere: function(optsMoveTile, cellOrigineInfo, targetInfo) {
			if (optsMoveTile.where === "append") {
				//append to empty group: target is group (no tile no cell)
				return {
					top: parseInt($("header", targetInfo.targetElmt).css("height"), 10) + "px",
					left: "0px",
					width: cellOrigineInfo.$$tile.css("width"),
					height: "10px",
					idTarget: targetInfo.id,
					before: false,
					parent: targetInfo.targetElmt
				}
			};
			var layoutGroup = targetInfo.tileCtrl.parent.parent;
			var before = (optsMoveTile.where === "top" || optsMoveTile.where === "left");
			var where;
			switch (cellOrigineInfo.tileSize) {
				case "small":
					if (targetInfo.tileSize === "small" || targetInfo.tileSize === "medium") {
						where = {
							top: "0px",
							left: before ? "-5px" : (parseInt(targetInfo.$$tile.css("width"), 10) - 5) + "px",
							width: "10px",
							height: cellOrigineInfo.$$tile.css("height"),
							parent: targetInfo.$$tile,
						}
					} else {
						where = {
							top: before ? "-5px" : (layoutGroup.cells[targetInfo.cellIndex].h - 5) + "px",
							left: "0px",
							width: cellOrigineInfo.$$tile.css("width"),
							height: "10px",
							parent: targetInfo.cellDomItem
						}
					}
					break;
				case "medium":
					if (targetInfo.tileSize === "small" || targetInfo.tileSize === "medium") {
						where = {
							top: "0px",
							left: before ? "-5px" : (layoutGroup.cells[targetInfo.cellIndex].w - 5) + "px",
							width: "10px",
							height: cellOrigineInfo.$$tile.css("height"),
							parent: targetInfo.cellDomItem
						}
					} else {
						where = {
							top: before ? "-5px" : (layoutGroup.cells[targetInfo.cellIndex].h - 5) + "px",
							left: "0px",
							width: cellOrigineInfo.$$tile.css("width"),
							height: "10px",
							parent: targetInfo.cellDomItem
						}
					};
					break;
				case "wide":
				case "large":
				case "full":
					where = {
						top: before ? "-5px" : (layoutGroup.cells[targetInfo.cellIndex].h - 5) + "px",
						left: "0px",
						width: cellOrigineInfo.$$tile.css("width"),
						height: "10px",
						parent: (targetInfo.cellColumn % 2) ? layoutGroup.cells[targetInfo.cellIndex - 1].domItem : targetInfo.cellDomItem
					}
					break;
				case "all ":
					break
			}
			if (where) {
				//Get first or last tile id of the destination cell depending on before
				var layoutTile = targetInfo.cellChildren[(before ? 0 : targetInfo.cellChildren.length - 1)];
				where.idTileTarget = layoutTile.children[0].id;
				where.before = before;
			}
			return where;
		},
		_getCellInfo: function(tileId) {
			var tileInfos = this._getTileInfo(tileId);
			if (!tileInfos) return {}
			var layoutGroup = tileInfos.ctrl.parent.parent;
			var $$dhtmlCell = tileInfos.ctrl.$$elmt.parent().parent();
			var index = $$dhtmlCell.attr("data-cellIndex");
			var cells = layoutGroup.cells;
			return {
				tileSize: tileInfos.size,
				tileCtrl: tileInfos.ctrl,
				$$tile: tileInfos.$$tile,
				cellIndex: index,
				cellDomItem: cells[index].domItem,
				cellColumn: cells[index].abs,
				cellChildren: cells[index].children
			}
		},
		_getTileInfo: function(vignetteId) {
			var ctrl = this.getControl(vignetteId);
			if (!ctrl) {
				return;
			}
			var $$vignette = $("#" + vignetteId);
			var $$tile = $$vignette.closest(".s-m-tile");
			return {
				$$tile: $$tile,
				$$vignette: $$vignette,
				$$remove: $(".s-m-tile btn.remove", $$tile),
				ctrl: ctrl,
				gadget: ctrl.prototype.data("$gadget"),
				size: ctrl.parent.article.$size,
				title: ctrl.article && ctrl.article.$title ? ctrl.article.$title : null,
				icon: ctrl.article && ctrl.article.$icon ? ctrl.article.$icon : null,
			};
		},
		_getGroupInfo: function(groupId, $$elmt) {
			return {
				id: groupId,
				targetElmt: $$elmt
			}
		},
		/**
		 * Return always false to force to load this page even if it's the current one (context could change and we need to reload the page))
		 */
		isSamePage: function(state) {
			return false;
		}
	});

exports.Page = _Page;