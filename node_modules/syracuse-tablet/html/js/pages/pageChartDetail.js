"use strict";

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/pageRegular').Page;
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var sessStorage = require('syracuse-tablet/html/js/storage/sessionStorage');
var ctrlCubeChart = require('syracuse-tablet/html/js/controls/chart/ctrlCubeChart');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');


/**
 * Child page that displays chart detail
 */
var _Page = utils.defineClass(
	// Name ChartDetailPage used for instanceof
	function ChartDetailPage($parent, state, prototype, article, parentPage, options) {
		if (globals.isAuthoringActive()) {
			options.header = false;
			options.footer = false;
			options.breadcrumbs = false;
		}
		// For parent page to create the container
		options.topToolbar = true;
		this.isChartDetailPage = true;
		if (!article.$display) article.$display = "bothSideToSide";
		this.parentPage = parentPage;
		if (!this.parentPage) throw new Error("chartdetail page - Unexpected empty parent page");
		Base.call(this, $parent, state, prototype, article, options);
		// Since this page is just a full screen copy of the parent, we clone the sdata-url
		// Otherwise, the request level will be lost in the sdata url query parameter "representation"
		this._originalSdataUrl = this.parentPage._originalSdataUrl;
		this._initSdataInfo();
	}, Base, {


		destroy: function() {
			if (this.destoyed) return;
			Base.prototype.destroy.call(this);
			this.parentPage = null;
			this._notifData = null;
		},

		/**
		 * Create the toolbar
		 */
		createPageControl: function(id) {
			if (id === "topToolbar") {
				return globals.isAuthoringActive() ? null : ctrlFactory.createPageControl("topToolbarChartDetail", this);
			}
			return ctrlFactory.createPageControl(id, this);
		},
		buildHtmlOption: function(loadOptions) {
			if (loadOptions) {
				// No need to send a request - data are in the cache because already read by the dashboard
				loadOptions.updateLayout = true;
			}
			return Base.prototype.buildHtmlOption.call(this, loadOptions).then(function(opts) {
				opts.toolBars.showAuthoring = true;
				opts.toolBars.showUserMenuLinks = true;
				opts.toolBars.showHome = true;
				opts.toolBars.showActions = false;
				opts.toolBars.statusPinPage = false;
				return opts;
			});
		},
		/**
		 * Page is visible
		 */
		activated: function() {
			var prefs = this.getUserPrefs();
			var chart = this.getChart();
			if (!chart && !prefs) return;
			if (!prefs.style && !prefs.display) return;
			if ((prefs.style && prefs.style != chart.article.$style) || (prefs.display && prefs.display != this.article.$display)) {
				// We redraw only if preferences changed
				this._setDisplay({
					display: prefs.display,
					style: prefs.style
				});
			}
		},
		/**
		 * Return data for parent
		 */
		getParentNotif: function() {
			if (this._notifData) {
				return {
					parentId: this.state.options.parentId,
					controlId: this.state.options.controlId,
					notifId: "sm.updt.chart.article",
					notifData: this._notifData
				};
			} else if (this.parentPage.isVignette) {
				/**
				 * #6843
				 * Multiple charts in dashboards
				 * If we click on a chart detail before all the charts have been loaded the size of the charts could be wrong
				 * --> because chart in dashboard could be rendered while the chartDetail page is loading
				 * So when the chartDetail is closed it publishes this notification to allow the charts in parent's dashboard to check the height
				 */
				return {
					// no parentId is provided because we want to notify all the nested pages in the dashboard
					notifId: "sm.updt.chart.dashboard",
					notifData: this.state.options.parentId
				};
			}
			return null;
		},
		scrollAllowed: function() {
			return true;
		},

		getChart: function() {
			return this._findCtrl("CtrlCubeChart");
		},
		getArray: function() {
			return this._findCtrl("CtrlArray");
		},
		_findCtrl: function(instance) {
			var self = this;
			var res = null;
			this.forEachControl(function(id, ctrl) {
				if (jsutils.isInstanceOf(ctrl, instance)) {
					self["_" + instance] = ctrl;
					return true;
				}
			});
			return self["_" + instance];
		},
		toolbarWrite: function(type, info) {
			sessStorage.setItem(this._getId(type), info ? JSON.stringify(info) : null);
		},
		toolbarRead: function(type) {
			var info = sessStorage.getItem(this._getId(type));
			if (!info) return null;
			try {
				info = JSON.parse(info);
				return info;
			} catch (e) {};
			return null;
		},
		_getId: function(type) {
			return this._originalSdataUrl + this.getChart().$bind + "#" + type;
		},
		_actSaveChartDetail: function() {
			this._notifData = {};
			this._notifData.article = $.extend(true, {}, this.article);
			globals.getApplication().goBack();
		},
		authUpdateLayout: function(article, vignetteToUpdt) {
			// Clear preferences in order to see the changes when we exit authoring
			// Otherwise the preferences will override the authoring
			this.saveUserPrefs(null);
			return Base.prototype.authUpdateLayout.call(this, article);
		},
		_setDisplay: function() {
			var chart = this.getChart();
			var array = this.getArray();
			if (!chart || !array) return false;
			// If authoring we take the article of the controls chart and array and force display to bothside2side
			var prefs = globals.isAuthoringActive() ? null : this.getUserPrefs();
			var opts = {
				display: prefs ? prefs.display : null,
				style: prefs ? prefs.style : null
			};
			// Create structure article (chart) by using the article of the controls to preserve authoring 
			var article = ctrlCubeChart.getChartDetailArticle(opts, chart.$bind, chart ? chart.article : null, array ? array.article : null);
			// Copy the properties specific to the page article - e.g $display..
			for (var p in this.article) {
				if (p != "$layoutType" && p != "$items") {
					article[p] = this.article[p];
				}
			}
			// Update layout
			var self = this;
			Base.prototype.authUpdateLayout.call(this, article).then(function() {
				notifications.publish("sm.chartdetail.updt.toolbar", opts);
			});
			return true;
		},
		actToolbarGetDisplay: function(opts) {
			var prefs = this.getUserPrefs();
			var opts = {
				display: prefs ? prefs.display : null,
				style: prefs ? prefs.style : null
			};
		},
		actToolbarSetDisplay: function(opts) {
			this.saveUserPrefs(opts);
			this._setDisplay();
		},
		getUserPrefs: function() {
			return this.toolbarRead("toolbar", this) || {};
		},
		saveUserPrefs: function(opts) {
			var prefs = this.getUserPrefs();
			prefs.display = opts ? opts.display : null;
			prefs.style = opts ? opts.style : null;
			this.toolbarWrite("toolbar", prefs);
		}

	});

exports.Page = _Page;