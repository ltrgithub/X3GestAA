"use strict";
/**
 * Default Home page that is display if there's no current mobile application
 * User can select an application or logout
 */
var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("page");
var Base = require('syracuse-tablet/html/js/pages/html/pageHtml').Page;
var modal = require('syracuse-tablet/html/js/ui/modal');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var _tmplCtx = {
	header: {
		"title": "Sage X3 Mobile Login Page",
		"logout": "logout"
	},
	content: {
		"title": "Home page",
		"listtitle": "Please select an application",
		"listcontent": ""
	}
};
var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
	}, Base, {

		loadData: function() {
			var self = this;
			var deferred = $.Deferred();
			dispatcher.getAppList().then(function(data) {
				self.appList = data || [];
				deferred.resolve();
			}, function(e) {
				deferred.reject(e);
			});
			return deferred.promise();
		},

		buildHtml: function() {
			var self = this;
			var html = [];
			if (self.appList) {
				self.appList.forEach(function(x) {
					html.push('<li><a href="#" data-action="select" data-params="');
					html.push(x.$uuid);
					html.push('">');
					html.push(x.title || x.description);
					html.push('&nbsp;&nbsp;&nbsp;<span class="label label-primary">');
					html.push(x.applicationName);
					html.push('</span>');
					html.push('</a></li>');
				});
			}
			_tmplCtx.content.listcontent = html.join('');
			return Base.prototype.buildHtml.call(this, _tmplCtx.content, _tmplCtx.header);
		},

		_actSelect: function(uuid) {
			var self = this;
			uiutils.waitStart();
			var info;
			self.appList.some(function(x) {
				if (x.$uuid === uuid) {
					info = x;
					return true;
				}
			});
			dispatcher.getAppDetail(info).then(function(data) {
				self.deactivate(null);
				notifications.publish("sm.switch.app", data);
				uiutils.waitStop();
			}, function(e) {
				uiutils.waitStop();
				modal.error("Error loading application", e);
			});
		}
	});

exports.Page = _Page;