"use strict";
define('syracuse-tablet/html/js/helpers/winjs',['require','exports','module'],function (require, exports, module) {

var _activeNotifications = {};
var _requestCounter = 0;

/* 
    this function is the global callback hook for WinJS to trigger callbacks started by callWinJS function
*/
var _winjsCallbackHook = function(param) {
	if (!param) {
		// todo error
		return;
	}

	var data;
	try {
		data = JSON.parse(param);
	} catch (e) {
		// todo error
		return;
	}
	if (!data.$uuid) {
		// todo error
		return;
	}

	// recover stored callback information to route callback
	var $active = _activeNotifications[data.$uuid];
	if (!$active) {
		// todo error
		return;
	}
	delete _activeNotifications[data.$uuid];
	if (!$active.$deferred) {
		// no error
		return;
	}
	if (data.$error) {
		$active.$deferred.reject(data.$error);
	} else {
		$active.$deferred.resolve(data.$data);
	}
};

var _callWinJS = function(domain, funcName, parameterObject, fireAndForget) {
	var deferred = $.Deferred();
	if (_isAvailable()) { // do we have an winJs container?
		_requestCounter = _requestCounter + 1;

		var $invoke = {
			$domain: domain,
			$funcName: funcName,
			$uuid: "" + _requestCounter,
			$data: parameterObject,
			$execCallback: !fireAndForget
		};

		var param = JSON.stringify($invoke);
		var $active;
		if (fireAndForget !== true) {
			$active = {
				$uuid: $invoke.$uuid,
				$deferred: deferred
			};
			_activeNotifications[$active.$uuid] = $active;
		}

		window.external.notify(param);

		if (fireAndForget === true) {
			deferred.resolve();
		}
	} else {
		deferred.reject({
			$message: "No WinJS container"
		});
	}
	return deferred.promise();
};

var _isAvailable = function() {
	try {
		return ("notify" in window.external);
	} catch (e) {
		// Safari
		return false;
	}
};

// Register callback hook on window object to be available "globally" from outside the web view control
if (window) {
	window.winjsCallbackHook = _winjsCallbackHook;
}

exports.callWinJS = _callWinJS;
exports.isAvailable = _isAvailable;
});

define('syracuse-tablet/html/js/helpers/logger',['require','exports','module','syracuse-tablet/html/js/helpers/winjs'],function (require, exports, module) {

var winjs = require('syracuse-tablet/html/js/helpers/winjs');

var _log;

if (winjs.isAvailable()) {
	_log = function() {
		var args = [];
		for (var i = 0; i < arguments.length; i++) {
			args.push(arguments[i]);
		}
		winjs.callWinJS("logger", "log", {
			"args": args
		}, true);
	};
} else {
	_log = function() {
		var text = [];
		for (var i = 0; i < arguments.length; i++) {
			var a = arguments[i];
			if (a != null) {
				if (_isError(a))
					console && console.log && console.log(a.message, "\n", _cleanStack(a.stack));
				else
					text.push(a);
			}
		}
		console && console.log && console.log(text.join(text, " "));
	};
}
if (window) {
	window.logger = _log;
}

function _getLogger(module) {
	if (true || module !== "sdataDispatcher" && module !== "SDataCache")
		return null;
	var logger = function() {
		var text, errs;
		for (var i = 0; i < arguments.length; i++) {
			if (_isError(arguments[i])) {
				if (!errs) errs = [];
				errs.push(arguments[i]);
			} else {
				if (!text) text = ["[" + module + "]: "];
				text.push(arguments[i]);
			}
		}
		if (text && text.length > 1) _log(text.join(" "));
		if (errs) {
			errs.forEach(function(e) {
				_log("[" + module + "]: " + e.message);
				if (e.stack) _log(_cleanStack(e.stack));
			});
		}
	};
	return logger;
}

/** 
 * Clean error stack from current base url and limit the size due to the use of deferred
 * html: true -> Display in Html
 **/

var _stackRegexp;
var _cleanStack = function(stack, max, html) {
	var globals = window.$sm;
	if (!_stackRegexp && globals && globals.baseLocation()) {
		_stackRegexp = {
			r1: new RegExp(globals.baseLocation().withPath, "g"),
			r2: new RegExp(globals.baseLocation().requirePath, "g")
		};
	}

	max = max == null ? 5 : max;
	if (stack) {
		var array = stack.split("\n");
		var res;
		if (array.length > 0) {
			array.forEach(function(l) {
				var pos1 = l.lastIndexOf(".js");
				if (pos1 > 0) {
					var pos2 = l.lastIndexOf("/", pos1);
					if (pos1 > 0) {
						if (!res) res = [];
						res.push(l.substring(pos2));
					}
				}
			});
		}
		if (!res && _stackRegexp) {
			stack = _stackRegexp ? stack.replace(_stackRegexp.r1, "").replace(_stackRegexp.r2, "") : stack;
		} else {
			stack = res.join('\n');
		}
	} else {
		stack = "";
	}
	stack = stack.split("\n");
	if (stack.length > max) {
		stack = stack.splice(0, max).join(html ? "<br>&nbsp&nbsp&nbsp&nbsp&nbsp" : "\n");
	}
	return stack;
};

var _isError = function(o) {
	return o && Error.prototype.toString === o.toString;
};
exports.log = _log;
exports.getLogger = _getLogger;
/** Like we nned these method here we published them instead of duplicating the code */
exports.cleanStack = _cleanStack;
exports.isError = _isError;
});

define('syracuse-tablet/html/js/helpers/notifications',['require','exports','module','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("notifs");

/**
 * publish/subscribe - Observer/Observable pattern with jQuery
 * We use jQuery triggering and use body as dispatcher
 * TODO - Eventually implement our own dispatcher
 **/

var _nameSpace = "sm";
var _subscriptions = {};

var _err = function(e) {
	log && log("Error", e);
	if (typeof e == "string") {
		throw new Error("Notification - " + e);
	} else {
		throw e;
	}
};

/**
 *  publish an event ("sm.login") or an array of events ["sm.login","sm.logout"]
 * 		Functional Object Subscribers
 * 			 notified through method notifEventname - object.notifLogin, object.notifLogout
 * 		Simple callBack Subscriber
 * 			called with event as first parameter
 * 	Argument that follow events parameter are passed to the Subscriber
 * */
var _publish = function(events) {
	try {
		if (!events) {
			throw new Error("No topic to publish");
		}
		var events = typeof events === "string" ? [events] : events;
		log && log("Publish " + events.join(" - "));
		var args, subscription, subscription, res;
		var count = 0,
			array;
		var objArgs, args = arguments;
		events.forEach(function(evt) {
			array = _subscriptions[evt];
			if (array) {
				array = array.slice();
				for (var i = 0, l = array.length; i < l; i++) {
					subscription = array[i];
					if (subscription.object) {
						if (!objArgs) objArgs = Array.prototype.slice.call(args, 1);
						// Remove first argument and call the method
						res = subscription.callBack.apply(subscription.object, objArgs);
					} else {
						// call the function with evt as first parameter
						args[0] = evt;
						res = subscription.callBack.apply(null, args);
					}
					count++;
					// TO SEE - -stop is res = false if ( res === false ) { break; }
				}
			}
		});
	} catch (e) {
		_err(e);
	}
};
/**
 * object subscribes for events (string or array)
 * 		object can be an functional Object or a function
 * 		functional Object must implement a method notifEventName  sm.Login.user -> Method notifLoginUser
 * Events starts with "sm" (sm.login, sm.logout)
 * High priority subscriptions are called first
 */
var _subscribe = function(object, events, priority) {
	if (!events) {
		_err("No topic to publish");
	}
	if (!object) {
		_err("Null object");
	}
	priority = priority || 10;
	var events = typeof events === "string" ? [events] : events;
	log && log("Subscribe " + events.join(" - ") + " - priority=" + priority);
	events.forEach(function(evt) {
		var callBackFct, callBackObj;
		if (typeof object == "function") {
			callBackFct = object;
			callBackObj = null;
		} else {
			callBackObj = object;
			var methodName = evt.split('.');
			if (methodName[0] != _nameSpace) _err("Bad event domain name");
			methodName = $.camelCase("notif-" + methodName.splice(1).join('-'));
			callBackFct = object[methodName];
			if (!callBackFct) {
				_err("Object must implement " + methodName);
			}
		}
		var added = false;
		if (!_subscriptions[evt]) {
			_subscriptions[evt] = [];
		}
		var subscriptionInfo = {
			callBack: callBackFct,
			object: callBackObj,
			priority: priority
		};
		for (var i = _subscriptions[evt].length - 1; i >= 0; i--) {
			if (_subscriptions[evt][i].priority <= priority) {
				_subscriptions[evt].splice(i + 1, 0, subscriptionInfo);
				added = true;
				break;
			}
		}
		if (!added) {
			_subscriptions[evt].unshift(subscriptionInfo);
		}
	});
};

/**
 * object unsubscribes for events
 *  object != null
 * 		Remove all object's subscription for given events
 * 		object can be an Object or a function
 *  object == null
 * 		Remove all subscription for given events
 *  events string or array
 * 		null -> unsubscribe for allevent
 */
var _unsubscribe = function(object, events) {
	if (!events) {
		events = Object.keys(_subscriptions);
	} else if (typeof events == "string") {
		events = [events];
	}

	var propToCheck = typeof object === "function" ? "callBack" : "object";
	events.forEach(function(evt) {
		var array = _subscriptions[evt];
		if (array) {
			for (var i = 0, l = array.length; i < l; i++) {
				if (object == null || array[i][propToCheck] === object) {
					array.splice(i, 1);
					// Adjust counter and length for removed item
					i--;
					l--;
				}
			}
		}

	});
};

// Remove all subscription
var _reset = function(object, events) {
	log && log("Reset");
	// For tests
	_unsubscribe(null, null);
	// We could just do _subscriptions = {};
};

// the number of subscriptions per event (for object if != null)
var _check = function(object) {
	var res = {};
	var propToCheck = typeof object === "function" ? "callBack" : "object";
	Object.keys(_subscriptions).forEach(function(key) {
		if (object == null) {
			res[key] = _subscriptions[key].length;
		} else {
			res[key] = 0;
			var arr = _subscriptions[key];
			for (var i = 0, l = arr.length; i < l; i++) {
				if (arr[i][propToCheck] === object) res[key] = res[key] + 1;
			}
		}
	});
	return res;
};

exports.check = _check;
exports.reset = _reset;
exports.subscribe = _subscribe;
exports.unsubscribe = _unsubscribe;
exports.publish = _publish;
});

define('syracuse-tablet/html/js/helpers/utils',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/notifications'],function (require, exports, module) {

var logger = require('syracuse-tablet/html/js/helpers/logger');
var log = logger.log;
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var _defineClass = function(constructor, parent, members) {
	function _addMembers(proto, members) {
		for (var name in members || {}) {
			var member = members[name];
			if (typeof member.get === "function" || typeof member.set === "function") {
				Object.defineProperty(proto, name, member);
			} else {
				proto[name] = member;
			}
		}
	}

	if (parent) constructor.prototype = Object.create(parent.prototype);
	constructor.prototype.constructor = constructor;
	_addMembers(constructor.prototype, members);
	return constructor;
};

/* Universal UUID - Not readable */
var _UUID = function() {
	return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,
		function(c) {
			var r = Math.random() * 16 | 0,
				v = c == 'x' ? r : (r & 0x3 | 0x8);
			return v.toString(16);
		});
};

var _getCurISODateTime = function() {
	var currentdate = new Date();
	var values = [
		currentdate.getFullYear(), 4, (currentdate.getMonth() + 1), 2,
		currentdate.getDate(), 2,
		currentdate.getHours(), 2,
		currentdate.getMinutes(), 2,
		currentdate.getSeconds(), 2
	];
	var datetime;
	for (var i = 0; i < values.length; i += 2) {
		var val = "" + values[i];
		while (val.length < values[i + 1]) {
			val = "0" + val;
		}
		if (!datetime) {
			datetime = val;
		} else {
			datetime += "-" + val;
		}
	}
	return datetime;
};

/* Return a DOM compliant id */
var _domIdCpt = 0;
var _domId = function(id) {
	return id.replace(/([^\w-_])/g, '_');
};

/* Readable ui for html dom ids */
var _uidCpt = 0;
var _readableuid = function() {
	return _domId($.camelCase((arguments.length > 0 ? Array.prototype.join.call(arguments, '-') + '-' : "") + _uidCpt++));
};


var _errProps = ["message", "stack", "lineNumber", "fileName", "columnNumber"];
var _error2JSON = function(e) {
	if (logger.isError(e)) {
		var res = {};
		_errProps.forEach(function(p) {
			res[p] = p === "fileName" ? logger.cleanStack(e[p]).join('') : p === "stack" ? "\n" + logger.cleanStack(e[p]) : e[p];
		});
		return res;
	}
	return {
		message: "object is not an Error"
	};
};
/* Build a Syracuse diagnose - accept JS exceptions*/
var _toDiagnose = function(o, parent, html) {
	if (!parent) parent = {
		$diagnoses: []
	};
	if (!o) return parent;
	if (typeof o == "string") o = {
		message: o
	};
	if (!Array.isArray(o)) o = [o];
	o.forEach(function(diag) {
		var d;
		if (logger.isError(diag)) {
			d = {
				exception: diag
			};
		} else {
			var jsonObj = {};
			for (var p in diag) {
				if (logger.isError(diag[p])) {
					diag[p] = _error2JSON(diag[p]);
				}
			}
			d = $.extend(true, {}, diag);
		}
		if (d.exception) {
			d.message = (d.message ? d.message + (html ? "<br>" : "\n") : "") + d.exception.message;
			if (d.exception.stack) {
				d.stackTrace = logger.cleanStack(d.exception.stack, null, html);
			}
			delete d.exception;
		}
		if (!d.severity) d.severity = "error";
		if (!d.message) d.message = "";
		parent.$diagnoses.push(d);
	});
	return parent;
};
/* Parse an url */
var _purlOptions = {
	strictMode: false,
	key: ["source", "protocol", "authority", "userInfo", "user", "password", "host", "port", "relative", "path", "directory", "file", "querystring", "anchor"],
	q: {
		name: "query",
		parser: /(?:^|&)([^&=]*)=?([^&]*)/g
	},
	parser: {
		strict: /^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,
		loose: /^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/
	}
};
/*
 * {
  "anchor": "", "file": "", "password": "", "user": "", "userInfo": "",
  "querystring": "representation=AQTCRUDM.$edit",
  "directory": "/sdata/x3/erp/SUPERV/AQTCRUD/$template/$workingCopies",
  "path": "/sdata/x3/erp/SUPERV/AQTCRUD/$template/$workingCopies",
  "relative": "/sdata/x3/erp/SUPERV/AQTCRUD/$template/$workingCopies?representation=AQTCRUDM.$edit",
  "port": "8124",
  "host": "pc101329.sagefr.adinternal.com",
  "authority": "pc101329.sagefr.adinternal.com:8124",
  "protocol": "http",
  "source": "http://pc101329.sagefr.adinternal.com:8124/sdata/x3/erp/SUPERV/AQTCRUD/$template/$workingCopies?representation=AQTCRUDM.$edit",
  "query": {
    "representation": "AQTCRUDM.$edit"
  }
 */
var _parseURL = function(str) {
	var o = _purlOptions;
	var m = o.parser[o.strictMode ? "strict" : "loose"].exec(str);
	var uri = {};
	var i = 14;

	while (i--) uri[o.key[i]] = m[i] || "";

	uri[o.q.name] = {};
	uri[o.key[12]].replace(o.q.parser, function($0, $1, $2) {
		if ($1) uri[o.q.name][$1] = decodeURIComponent($2);
	});
	return uri;
};

/* Parse url QS */
var _qsParser = /([^&=;]*)=?([^&;]*)/g;
var _parseQueryString = function(qs) {
	qs = qs || window.location.search;
	var res = {};
	var qs = decodeURIComponent(qs);
	var ii = qs.indexOf('?');
	if (ii >= 0) {
		qs = qs.substring(ii + 1);
	}
	qs.replace(_qsParser, function($0, $1, $2) {
		if ($1 && $1.length > 0) {
			res[$1] = decodeURIComponent($2);
		}
	});
	return res;
};

/* Encoding/Decoding stuff*/
// TODO - can be improved
var _htmlEncode = function(value) {
	return $('<div/>').text(value).html();
};
var _htmlDecode = function(value) {
	return $('<div/>').html(value).text();
};


// Display an error in alert box if no possibilities to display in ui
// Better to use than console.log
var _alertError = function(title, e) {
	log && log(title);
	log && log(e);
	alert(title + "\n" + (e ? e.message + "\n\n" + logger.cleanStack(e.stack) : "No error"));
};

/* cleanup all references */
var _unbindObj = function(obj) {
	if (obj == null) return;
	if (obj.jquery) {
		obj.unbind();
		obj.undelegate();
		obj.off();
		obj.remove();
		if (obj.smPageRemoveController) obj.smPageRemoveController();
	}
	notifications.unsubscribe(obj);
};
/**
 *  Resolves expression according to current dataset and prototype
 *  	expression: Syrause SData expression
 *  	dataset: optionnal - DaoSdata object (with value method to chain with a parent) or a simple JSON object
 *  			 if dataset=null prototype must be != null
 *  	prototype: optionnal - PrototypeObject
 **/
var _exprRegExp = /\{(.*?)\}/g;
var _execExpression = function(expression, dataset, prototype, level) {
	level = level || 0;
	expression = (expression || "") + "";
	if (level === 0 && expression.indexOf("{") < 0 && dataset) {
		var value = dataset.getValue ? dataset.getValue(expression) : dataset[expression];
		return value == null ? "" : value;
	}
	var prevProp = null;
	var res = expression.replace(_exprRegExp,
		function(match, prop) {
			// Search in data first - "{VACBPR}~{LEG}"
			var val = dataset == null ? null : dataset.getValue ? dataset.getValue(prop) : dataset[prop];
			if (val != null) return val;
			if (!prototype) return "";
			if (prop.smStartsWith('@')) {
				//Case @1234
				return prototype.localization(prop);
			}
			val = prototype.data(prop, dataset);
			if (val != null && val.indexOf("{") >= 0) {
				// Search in prototype - ex "{@7898}", "{$baseUrl}/$prototype('{$representation}.$thumb')"
				return _execExpression(val, dataset, prototype, level + 1);
			}
			return val == null ? "" : val;
		});
	return res || "";
};


exports.UUID = _UUID;
exports.defineClass = _defineClass;
exports.readableuid = _readableuid;
exports.domId = _domId;
exports.toDiagnose = _toDiagnose;
exports.error2JSON = _error2JSON;
exports.parseQueryString = _parseQueryString;
exports.parseURL = _parseURL;
exports.htmlEncode = _htmlEncode;
exports.alertError = _alertError;
exports.getCurISODateTime = _getCurISODateTime;
exports.unbindObj = _unbindObj;
exports.parseExpression = function(expression, dataset, prototype) {
	return _execExpression(expression, dataset, prototype, 0);
};
/* Method used also by logger - we publish them in log module instead of duplcating the code*/
exports.isError = logger.isError;
exports.cleanStack = logger.cleanStack;
});

define('syracuse-tablet/html/js/ui/uiUtils',['require','exports','module'],function (require, exports, module) {

//empty dom
var _empty = function(domNode) {
	if (domNode) {
		while (domNode.firstChild) {
			domNode.removeChild(domNode.firstChild);
		}
	}
};
//add or remove class to dom element
var _toggleClass = function(item, css, show) {
	if (item) {
		var className = item.className;
		if (show) {
			if (className.indexOf(css) < 0) {
				item.className = className + (" " + css);
			}
		} else {
			item.className = className.replace(css, "");
		}
	}
};

var _waitDefOpts = {
	className: 'waiting-circles',
	elements: 8,
	radius: 30,
	auto: true
};
/**
 * Wait plugin for global application only (no current page or application)
 */
var _waitGlobal = null;
var _wait = function(waitObject, start) {
	if (waitObject == null) {
		// use only if no current application otherwise use page's wait plugin
		if (_waitGlobal == null) _waitGlobal = _waitWheelCreate($(document.body));
		waitObject = _waitGlobal;
	}
	if (start) {
		waitObject.$$bckg.show();
		_waitPluginStatus(waitObject.$$wheel, "enable");
	} else {
		waitObject.$$bckg.hide();
		_waitPluginStatus(waitObject.$$wheel, "disable");
	}
};

var _waitWheelCreate = function($$parent, opts) {
	var waitObject = {
		$$bckg: $('<div class="waiting-background" style="display:none"></div>'),
		$$wheel: $('<div class="waiting-wheel"  style="display:none"></div>')
	};
	waitObject.$$bckg.appendTo($$parent);
	waitObject.$$wheel.appendTo($$parent);
	// Initialize plugin
	_waitPluginCreate(waitObject.$$wheel, _waitDefOpts);
	return waitObject;
};
/**
 * Destroy plugin
 */
var _waitPluginDestroy = function($$elmt) {
	/**
	 * We need to check data('waiting') because the plugin is not safe
	 * 	If no data('waiting') it fails
	 * 	That occurs if we remove a parent element of the plugin before destroying the plugin
	 */
	if ($$elmt && $$elmt.data('waiting')) {
		$$elmt.waiting("destroy");
		$$elmt.remove();
	}
};

var _waitPluginStatus = function($$elmt, status) {
	if ($$elmt && $$elmt.data('waiting')) {
		$$elmt.waiting(status);
		$$elmt[status === "disable" ? "hide" : "show"]();
	}
};

var _waitPluginCreate = function($$elmt, opts) {
	if (!opts) throw new Error("opts is mandatory");
	if ($$elmt) $$elmt.waiting(opts);
	return $$elmt;
};
var _waitWheelDestroy = function(waitObject) {
	if (waitObject) {
		_waitPluginDestroy(waitObject.$$wheel);
		if (waitObject.$$bckg) waitObject.$$bckg.remove();
	}
};
/**
 * Returns a dom element
 * - tag : html tag
 * - classList : array of classes
 * - content : dom.textContent
 * - attrList : various attributes list with key,value (JSON format)
 **/

var _createDomElement = function(tag, classList, content, attrList, parent) {
	if (!tag) {
		throw new Error("tag parameter is necessary !");
	}
	// create dom element
	var dom = document.createElement(tag);

	// append classes
	if (classList) {
		if ($.isArray(classList)) {
			$.each(classList, function(index, className) {
				dom.className += className + (index == classList.length - 1 ? "" : " ");
			});
		} else {
			if (typeof classList !== 'string') {
				throw new Error("classList parameter must be an array or a string");
			} else {
				dom.className += classList;
			}
		}
	}

	// set content
	dom.textContent = content ? content : "";

	if (attrList) {
		$.each(attrList, function(key, value) {
			dom.setAttribute(key, value);
		});
	}

	if (parent) {
		if (parent.jquery) {
			parent = parent.append(dom);
		} else {
			parent.appendChild(dom);
		}
	}

	return dom;
};

var _buildDom = function(domDesc, parent) {
	$.each(domDesc, function(nodeName, value) {
		var dom = _createDomElement(nodeName, value.classList, value.textContent, value.attr, parent);
		if (value.children) {
			$.each(value.children, function(index, childElement) {
				_buildDom(childElement, dom);
			});
		}
	});
};


exports.empty = _empty;
exports.toggleClass = _toggleClass;

exports.waitWheelStart = function(waitObject) {
	_wait(waitObject, true);
};
exports.waitWheelStop = function(waitObject) {
	_wait(waitObject, false);
};

exports.waitWheelCreate = _waitWheelCreate;
exports.waitWheelDestroy = _waitWheelDestroy;

/** Wait plugin SAFE call - SAFE if plugin has been remove from DOM*/
exports.waitPluginDestroy = _waitPluginDestroy;
exports.waitPluginCreate = _waitPluginCreate;
exports.waitPluginDisable = function($$elmt) {
	_waitPluginStatus($$elmt, "disable");
};
exports.waitPluginEnable = function($$elmt) {
	_waitPluginStatus($$elmt, "enable");
};

exports.createDomElement = _createDomElement;
exports.buildDom = _buildDom;
});

define('syracuse-tablet/html/js/helpers/globals',['require','exports','module','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("globals");

var _emptyCacheCtx = {
	"$user": "none",
	"$role": "none",
	"$lang": "none"
};
var _globals = {
	application: null,
	userCtx: null,
	isTestEnvironment: false,
	baseLocation: null,
	isDvlpMode: false,
	isOffLineMode: false,
	storage: null,
	cache: null,
	cacheCtx: $.extend({}, _emptyCacheCtx),
	lookAndFeel: "windows"
};

var _setUserCtx = function(userCtx) {
	log && log("Set user context");
	var ctx = userCtx == null ? $.extend({}, _emptyCacheCtx) : userCtx;

	_globals.cache.setContext(ctx);
	return _globals.userCtx = ctx;
};

var _setApplication = function(appObj) {
	if (!appObj) {
		throw new Error("Bad application description");
	}
	log && log("Set application description");
	_globals.application = appObj;
	return appObj;
};

/**
 * Called by main.js
 */
var _init = function(dvlpMode, storage, cache, utilsModule) {
	_globals.isOffLineMode = false;
	_globals.isDvlpMode = dvlpMode;
	var bl = _globals.baseLocation = {};
	bl.host = window.location.protocol + "//" + window.location.host;
	var path = window.location.pathname.split('/').splice(0, 2).join('/');
	bl.withPath = bl.host + path;
	bl.requirePath = bl.host + "/requireJS" + path;
	bl.htmlRoot = bl.withPath + "/html";
	if (utilsModule) bl.query = utilsModule.parseQueryString();
	_globals.isTestEnvironment = window.location.href.indexOf("/syracuse-tablet/test/index.html") > -1;
	_globals.storage = storage;
	_globals.cache = cache;
};

/* Getters */
exports.isOffLineMode = function() {
	return _globals.isOffLineMode;
};
/**
 * baseLocation.host - protocol://host:port
 * baseLocation.withPath
 * baseLocation.requirePath
 * baseLocation.htmlRoot
 * baseLocation.query
 */
exports.baseLocation = function() {
	return _globals.baseLocation;
};
exports.isDvlpMode = function() {
	return _globals.isDvlpMode;
};
exports.isTestEnvironment = function() {
	return _globals.isTestEnvironment;
};
exports.getApplication = function() {
	return _globals.application;
};
exports.getUserCtx = function() {
	return _globals.userCtx;
};
exports.getGlobalCtx = function() {
	return _globals;
};
exports.getStorage = function() {
	return _globals.storage;
};
exports.getCache = function() {
	return _globals.cache;
};
exports.getCacheCtx = function() {
	return _globals.cacheCtx;
};
exports.getEmptyCacheCtx = function() {
	return _emptyCacheCtx;
};
exports.getEndpoint = function() {
	var ep = _globals.endpoint;
	return ep;
};
exports.setEndpoint = function(ep) {
	_globals.endpoint = ep;
};
exports.$config = function(prop) {
	return _globals.application.$config(prop);
};
exports.setLookAndFeel = function(lookAndFeel) {
	_globals.lookAndFeel = lookAndFeel;
};
/*
 * returns: windows | android | ios
 */
exports.getLookAndFeel = function() {
	return _globals.lookAndFeel;
};

/**
 * Returns the size of current device
 */
exports.getDeviceSize = function(camelCase) {
	return camelCase ? "Md" : "md";
};
/* Setters */
exports.setApplication = _setApplication;
exports.setUserCtx = _setUserCtx;
/* Initialization by main.js */
exports.init = _init;
/* Set global ctx*/
if (window) {
	window.$sm = exports;
}
});

define('syracuse-tablet/html/js/ajax/ajaxInterface',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {
/*
 * Ajax module (Default browser implementation)
 */


var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("ajax");
var utils = require('syracuse-tablet/html/js/helpers/utils');


function _AjaxInterface() {};

var _httpStatus = {
	"200": 'Ok',
	"201": 'Created',
	"400": 'Bad Request',
	"401": 'Unauthenticated',
	"403": 'Forbidden',
	"404": 'Not Found',
	"405": 'Method Not Allowed',
	"406": 'Not Acceptable',
	"409": 'Conflict',
	"410": 'Gone',
	"411": 'Length Required',
	"412": 'Precondition Failed',
	"413": 'Request Entity Too Large',
	"414": 'Request URI Too Long',
	"415": 'Unsupported Media Type',
	"422": 'Unprocessable Entity',
	"429": 'Too Many Requests',
	"500": 'Internal Server Error',
	"501": 'Not Implemented',
	"502": 'Bad Gateway',
	"503": 'Service Unavailable',
	"504": 'Gateway Timeout'
};
var _rheaders = /^(.*?):[ \t]*([^\r\n]*)\r?$/mg;
var _ajaxInterfaceClass = utils.defineClass(
	_AjaxInterface,
	null, {
		/**
		 *
		 * Parameters:
		 *
		 * method: GET, PUT, POST, DELETE, HEAD
		 * url: http URL
		 * send: Data to send (Objects will be stringified to json on POST and PUT)
		 * headers: headers to add to the request
		 * options: {
		 *   noJsonParsing: true, : Returns response body as string without trying to parse and return an object. (Default: Parse and return object)
		 *   timeout: 1000 : Request timeout (Default: 0)
		 * }
		 *
		 * When promise is resolved, callback gets the following object as parameter:
		 * {
		 *     textStatus: e.g. "success", "errror"
		 *     status: http status code (200, 404, 500, ...)
		 *     descrHttpStatus: description of http status code (e.g. "Internal Server Error")
		 *     isSuccess: true for: status >= 200 && status < 300 || status === 304
		 *     responseJSON: Contains parsed object returned by server (Unless response did not contain JSON or option noJsonParsing was set)
		 *     responseText: Contains response as returned by server (as string)
		 *     headers: { ... } : Contains returned http headers
		 * }
		 *
		 */
		ajax: function(method, url, send, headers, options) {
			var deferred = $.Deferred();
			try {
				method = method ? method.toUpperCase() : "GET";
				if (method === "GET" && send) {
					if (url.indexOf('?') === -1) url += "?";
					var params = [];
					for (var p in send) {
						if (send[p] != null) {
							params.push(encodeURIComponent(p) + "=" + encodeURIComponent(send[p].toString()));
						}
					}
					url += params.join('&');
				}
				options = options || {};
				var doAjax = function() {
					try {
						var allHeaders = {
							"Accept": "application/json;vnd.sage=syracuse"
						};
						if (headers) {
							$.extend(allHeaders, headers);
						}
						// TODO: Authentication
						var ajaxData = {
							headers: allHeaders,
							type: method,
							url: url,
							timeout: options.timeout == null ? 0 : options.timeout
							//processData : false
						};
						if (["PUT", "POST"].indexOf(method) >= 0 && send != null) {
							ajaxData.contentType = options.contentType || "application/json;charset=utf-8";
							if (ajaxData.contentType.indexOf("application/json") >= 0 && typeof send === "object") {
								try {
									send = JSON.stringify(send);
								} catch (e) {
									throw new Error("Error parsing send data\nurl: " + url);
								}
							};
							ajaxData.data = send;
						}

						// We need this option to deal with non-json data
						var parseJson = allHeaders.Accept.indexOf("application/json") >= 0 && options.noJsonParsing !== true;
						if (parseJson) {
							ajaxData.dataType = "json";
						}
						log && log("'" + method + "':" + url);
						// $.ajax is replaced after startup to ensure the module  ajax/ajax.is used since $.ajax will not work
						// in winJS container because of blocked CORS.
						// Here, it's ok to use $.ajax since if we are in a winJS container, this function will be replaced by a
						// function that redirects the call to a winJS function.
						// If we end up here, we are sure we are in standalone browser mode and $.ajax will work as usually

						var ajax = $.ajax_original || $.ajax;
						var promise = ajax(ajaxData);
						promise.complete(function(jqXHR, textStatus) {
							var status = jqXHR.status != null ? jqXHR.status : textStatus == "success" ? 200 : 500;
							var result = {
								textStatus: textStatus,
								status: status,
								descrHttpStatus: _httpStatus[status] || ("unknown: " + status),
								isSuccess: status >= 200 && status < 300 || status === 304,
								headers: {}
							};
							if (parseJson) {
								result.responseJSON = jqXHR.responseJSON;
							} else {
								result.responseText = jqXHR.responseText;
							}
							var match, headerStr = jqXHR.getAllResponseHeaders();
							if (headerStr) {
								while ((match = _rheaders.exec(headerStr))) {
									result.headers[match[1].toLowerCase()] = match[2];
								}
							}
							deferred.resolve(result);
						});
					} catch (e) {
						alert(e);
						deferred.resolve(e);
					} finally {
						return promise;
					}
				};

				doAjax();
			} catch (e) {
				log && log("Ajax error", e);
				return deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		}
	}
);

exports.AjaxInterfaceClass = _ajaxInterfaceClass;

exports.init = function(config) {
	config = config || {};
	$.ajaxSetup({
		timeout: config.timeout == null ? 20000 : config.timeout,
		async: true
	});
};
});

define('syracuse-tablet/html/js/ajax/ajaxWinJS',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/winjs'],function (require, exports, module) {
/*
 * Ajax module for winJS
 */


var utils = require('syracuse-tablet/html/js/helpers/utils');
var winjs = require('syracuse-tablet/html/js/helpers/winjs');

var _ajax;

function _AjaxWinJSInterface() {};

var _ajaxWinJSInterfaceClass = utils.defineClass(
	_AjaxWinJSInterface,
	null, {
		ajax: function(method, url, send, headers, options) {
			var deferred = $.Deferred();
			method = method || "GET";

			var allHeaders = {
				"Accept": "application/json;vnd.sage=syracuse"
			};
			if (headers) {
				$.extend(allHeaders, headers);
			}

			var data = {
				"$method": method || "GET",
				"$url": url,
				"$send": send,
				"$headers": allHeaders,
				"$options": options
			};
			winjs.callWinJS("winjsAjax", "ajax", data).then(function(data) {
				// WinJS call succeeded, this does not mean ajax call succeeded!

				var respHeaders = {
					"status": data.$status,
					"location": (data.$headers && data.$headers["location"]) || ""
				};

				if (data.$succeeded) {
					deferred.resolve(data.$data, respHeaders);
				} else {
					deferred.reject(data.$status, respHeaders);
				}
			}).fail(function(error) {
				// WInJS call failed!
				deferred.reject(500, {});
			});

			return deferred.promise();
		}
	}
);

exports.AjaxInterfaceClass = _ajaxWinJSInterfaceClass;
exports.init = function() {};
});

define('syracuse-tablet/html/js/ajax/ajax',['require','exports','module','syracuse-tablet/html/js/helpers/winjs','syracuse-tablet/html/js/ajax/ajaxInterface','syracuse-tablet/html/js/ajax/ajaxWinJS'],function (require, exports, module) {
/*
 * Ajax module
 */


var winJS = require('syracuse-tablet/html/js/helpers/winjs');
var ajaxInterface = require('syracuse-tablet/html/js/ajax/ajaxInterface');
var ajaxWinJS = require('syracuse-tablet/html/js/ajax/ajaxWinJS');

var _ajax;

exports.getAjax = function() {
	if (!_ajax) {
		if (winJS.isAvailable()) {
			_ajax = new ajaxWinJS.AjaxInterfaceClass();
		} else {
			_ajax = new ajaxInterface.AjaxInterfaceClass();
		}
	}
	return _ajax;
};

exports.init = function() {
	if (winJS.isAvailable()) {
		ajaxWinJS.init();
	} else {
		ajaxInterface.init();
	}
};
});

define('syracuse-tablet/html/js/helpers/locale',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ajax/ajax'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

var _currentLocale = null;
var _resources = {};

var _datetimeInformationKey = "$datetimeInformation";
var _decimalInformationKey = "$decimalInformation";
var _upLocalePreferences;

var _txtRegexp = /\{([\w-]+)\}/g;
var _localeHashUser = "*";

var _userProfileSettings = {};
var _userLocales = {};

var _text = function(key, args) {
	var resources = _resources && _resources[_currentLocale];
	if (!resources) {
		return;
	}
	var text = resources[key] || "Resource key not found[" + key + "]";

	if (args) {
		text = text.replace(_txtRegexp, function(match, p1) {
			var idx = +p1;
			if (idx >= 0 && idx < args.length) {
				return args[idx];
			}
			return "?";
		});
	}

	return text;
};

var _getDatetimeInfo = function() {
	var resources = _resources && _resources[_currentLocale];
	if (!resources) {
		return;
	}
	return resources[_datetimeInformationKey];
};

var _getDecimalInfo = function() {
	var resources = _resources && _resources[_currentLocale];
	if (!resources) {
		return;
	}
	return resources[_decimalInformationKey];
};

var _setLocale = function(locale, upLocalePreferences) {
	var deferred = new $.Deferred();
	_upLocalePreferences = upLocalePreferences;

	// Everytime a locale is set, the user is remembered
	// this is because formatters created afterwards are cached
	// and need to be linked to locale + user (because of user defined locale settings)
	// See getCurrentLocaleHash()
	var ctx = globals.getUserCtx();
	_localeHashUser = ctx && ctx.$user || "*";
	_userProfileSettings = _userLocales[locale] || {};

	var resources = _resources && _resources[locale];
	if (resources) {
		_currentLocale = locale;
		deferred.resolve();
	} else if (locale === _currentLocale) {
		deferred.resolve();
	} else {
		var result = ajax("GET", "/syracuse-tablet/html/js/resources/strings-" + locale + ".json", null, null);
		_loadFile("/syracuse-tablet/html/js/resources", "strings", locale, "en")
			.then(function(data) {
				_currentLocale = locale;
				_resources[locale] = data;
			})
			.then(function() {
				return _loadFile("/syracuse-tablet/html/js/resources/locales", "date", locale, "en-GB");
			})
			.then(function(data) {
				// join strings-xx-XX and date-xx-XX
				_resources[locale][_datetimeInformationKey] = data;
			})
			.then(function() {
				return _loadFile("/syracuse-tablet/html/js/resources/locales", "decimal", locale, "en-GB");
			})
			.then(function(data) {
				// join strings-xx-XX and decimal-xx-XX
				_resources[locale][_decimalInformationKey] = data;
			})
			.then(function() {
				deferred.resolve();
			}).fail(function(e) {
				deferred.resolve();
			});
	}
	return deferred.promise();
};

var _loadFile = function(path, file, locale, defLocale) {
	var deferred = new $.Deferred();
	var segs = locale.split("-");

	function _load() {
		if (segs.length === 0) {
			// Fallback to default
			var url = path + "/" + file + "-" + defLocale + ".json";
			ajax("GET", url, null, null)
				.then(function(data) {
					if (data && data.responseJSON) {
						deferred.resolve(data.responseJSON);
					}
					deferred.resolve({});
				}).fail(function(e) {
					deferred.reject(e);
				});
		} else {
			var code = segs.join("-");
			var url = path + "/" + file + "-" + code + ".json";
			ajax("GET", url, null, null)
				.then(function(data) {
					if (data && data.responseJSON) {
						deferred.resolve(data.responseJSON);
					} else if (data.status === 404) {
						segs.pop();
						_load();
					} else {
						deferred.reject(data.textStatus + " - " + data.status);
					}
				}).fail(function(e) {
					deferred.reject(e);
				});
		}
	}
	_load();
	return deferred.promise();
};

var _isCurrent = function(locale, strict) {
	if (!locale || !_currentLocale) return false;
	if (_currentLocale === locale) return true;
	return strict ? false : (locale.split('-'))[0] === _currentLocale;
};

/*
 * TODO: Use prefered format from _upLocalePreferences if set
 */
exports.getDateFormat = function() {
	var di = _getDatetimeInfo();
	return _userProfileSettings.shortDate || (di && di.formatPatterns && di.formatPatterns.shortDate) || "dd/MM/yyyy";
};

exports.getDateTimeFormat = function() {
	var di = _getDatetimeInfo();
	var date = _userProfileSettings.shortDate || (di && di.formatPatterns && di.formatPatterns.shortDate) || "dd/MM/yyyy";
	var time = _userProfileSettings.shortTime || (di && di.formatPatterns && di.formatPatterns.shortTime) || "HH:mm:ss";
	return date + " " + time;
};
exports.getTimeFormat = function() {
	var di = _getDatetimeInfo();
	return _userProfileSettings.longTime || (di && di.formatPatterns && di.formatPatterns.longTime || "HH:mm:ss");
};
exports.getTimeFormatShort = function() {
	var di = _getDatetimeInfo();
	return _userProfileSettings.shortTime || (di && di.formatPatterns && di.formatPatterns.shortTime || "HH:mm");
};

exports.getNumberFormat = function(type) {
	return (type === "application/x-integer" ? "#,##0" : "#,##0.##");
};

exports.getNumberGroupSeparator = function() {
	var di = _getDecimalInfo();
	var gs = _userProfileSettings.numberGroupSeparator || (di && di.numberGroupSeparator) || ",";
	return gs;
};

exports.getNumberDecimalSeparator = function() {
	var di = _getDecimalInfo();
	var ds = _userProfileSettings.numberDecimalSeparator || (di && di.numberDecimalSeparator) || ".";
	return ds;
};

exports.setLocale = _setLocale;
exports.text = _text;
exports.isCurrent = _isCurrent;

// Get Month names, etc for parsers
exports.getDatetimeInfo = _getDatetimeInfo;
exports.getCurrentLocale = function() {
	return _currentLocale;
};
exports.getCurrentLocaleHash = function() {
	return _currentLocale + "#" + _localeHashUser;
};
exports.setUserLocales = function(locales) {
	_userLocales = {};
	if (locales) {
		locales.forEach(function(locale) {
			_userLocales[locale.code] = {
				shortDate: locale.shortDate,
				shortTime: locale.shortTime,
				longTime: locale.longTime,
				numberDecimalSeparator: locale.numberDecimalSeparator,
				numberGroupSeparator: locale.numberGroupSeparator
			};
		});
	}
};
});

define('syracuse-tablet/html/js/ui/modal',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/locale','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/notifications'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("ui");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var _templates = {
	confirm: ' \
		<div class="modal fade" id="modal-confirm" tabindex="-1" role="dialog" aria-labelledby="basicModal" aria-hidden="true"> \
		    <div class="modal-dialog"> \
		        <div class="modal-content"> \
		            <div class="modal-header"> \
		            <h4 class="modal-title" id="myModalLabel">{{title}}</h4> \
		            </div> \
		            <div class="modal-body"> \
		            <div class="alert alert-warning" role="alert">{{message}}</div> \
		            </div> \
		            <div class="modal-footer"> \
		                <button type="button" class="btn btn-default" data-action="yes">{{yes}}</button> \
		                <button type="button" class="btn btn-default" data-action="no">{{no}}</button> \
		        </div> \
		    </div> \
		  </div> \
		</div>',
	error: ' \
		<div class="modal fade" id="modal-error" tabindex="-1" role="dialog"> \
		    <div class="modal-dialog"> \
				<div class="modal-content"> \
				    <div class="modal-header"> \
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&#215;</button> \
				    	<h4 class="modal-title" id="myModalLabel">{{title}}</h4> \
				    </div> \
				    <div class="modal-body"> \
				        <pre>{{body}}</pre> \
				    </div> \
				    <div class="modal-footer"> \
				        <button type="button" class="btn btn-default" data-dismiss="modal">{{close}}</button> \
					</div> \
				</div> \
			</div> \
		</div>',
	info: '\
		<div class="modal fade" id="modal-info" tabindex="-1" role="dialog"> \
		    <div class="modal-dialog"> \
				<div class="modal-content"> \
				    <div class="modal-header"> \
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&#215;</button> \
						<h4 class="modal-title" id="myModalLabel">{{title}}</h4> \
				    </div> \
				    <div class="modal-body"> \
				       <h3>{{body}}</h3> \
				    </div> \
				    <div class="modal-footer"> \
				        <button type="button" class="btn btn-default" data-dismiss="modal">{{close}}</button> \
					</div> \
				</div> \
			</div> \
		</div>',
	field: '\
		<div class="modal fade" id="modal-field" tabindex="-1" role="dialog"> \
		    <div class="modal-dialog"> \
				<div class="modal-content"> \
				    <div class="modal-header"> \
						<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&#215;</button> \
						<h4 class="modal-title" id="myModalLabel">{{title}}</h4> \
				    </div> \
				    <div class="modal-body"> \
				       {{{body}}} \
				    </div> \
				    <div class="modal-footer"> \
				        <button type="button" class="btn btn-default" data-dismiss="modal">{{close}}</button> \
					</div> \
				</div> \
			</div> \
		</div>'
};

var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};

/* First param : cb - Second msg - Third data ...*/
var _execCb = function(cb, msg, data) {
	if (!cb || arguments.length == 0) return;
	try {
		var cb = arguments[0];
		var args = Array.prototype.slice.call(arguments, 1);
		cb.apply(null, args);
	} catch (e) {
		utils.alertError("Error calling modal callback", e);
	}
};

var _error = function(title, e, cb) {
	if (e == null) {
		e = utils.toDiagnose({
			where: title
		});
	} else if (utils.isError(e)) {
		e = utils.toDiagnose({
			where: title,
			exception: e
		});
	} else if (typeof e === "string") {
		e = utils.toDiagnose({
			where: title,
			message: e
		});
	} else {
		if (!e.hasOwnProperty("where")) e.where = title;
		e = utils.toDiagnose(e);
	}
	var body = JSON.stringify(e, null, 2).replace(/\\n/g, '\n');
	log && log("exports.displayError", body);
	return _modalStatic("error", {
		close: locale.text("modal.btn.close"),
		title: locale.text("modal.error.ttl"),
		body: body
	}, cb);
};

var _info = function(title, text, cb) {
	return _modalStatic("info", {
		close: locale.text("modal.btn.close"),
		title: title || "Warning",
		body: text
	}, cb);
};

var _confirm = function(action, cb) {
	return _modalStatic("confirm", {
		title: locale.text("modal.confirm.ttl"),
		message: locale.text("modal.confirm.msg", [action]),
		yes: locale.text("yes"),
		no: locale.text("no")
	}, function(message, modal, params) {
		if (cb && (message === "yes" || message === "no")) {
			_execCb(cb, "yes" === message);
		}
	});
};

var _field = function(title, domBody, cb) {
	return _modalStatic("field", {
		close: locale.text("modal.btn.close"),
		title: title || "Warning",
		body: domBody
	}, cb);
};

/*
 * cb (message, modal, params)
 *    message: bootstrap message or clicked action (data-action)
 *    params: data-params
 */

var _modalStatic = function(id, context, cb) {
	/* Always to retry read template and display alert if not found */
	var h = _getHtml(id, context);
	return _modal(h, cb);
};


var _modal = function(html, cb) {
	// Disable wait wheel if any
	uiutils.waitWheelStop();
	if (globals.getApplication().currentPage) {
		globals.getApplication().currentPage.waitWheelStop();
	}
	/* Always to retry read template and display alert if not found */
	var h = $(html).modal({
		keyboard: false,
		backdrop: "static"
	});
	var done = false;
	// Use <button data-dismiss"modal" for close action
	// Use <button data-action"myaction" for action other than
	// close
	h.on("shown.bs.modal", function() {
		try {
			_execCb(cb, "shown.bs.modal", h);
		} catch (e) {
			alert("Modal open - call back error" + e.stack);
		}
		notifications.publish("sm.modal.open");
	});
	h.on("hidden.bs.modal", function() {
		// Call cb only if no click action
		if (!done && cb) {
			try {
				_execCb(cb, "hidden.bs.modal", h);
			} catch (e) {
				alert("Modal close - call back error" + e.stack);
			}
		}
		// Called when dialog is close - data-dismiss = "modal"
		// or m.modal('hide')
		h.unbind();
		h.remove();
		notifications.publish("sm.modal.close");
	});
	// For dialogs with option
	h.delegate("button[data-action]", "click", function(evt) {
		var t = $(evt.target);
		var act = t.attr("data-action");
		if (act) {
			done = true;
			evt.preventDefault();
			evt.stopPropagation();
			_execCb(cb, act, h, t.attr("data-params"));
		}
		// Close modal
		h.modal('hide');
	});
	return h;
};

exports.error = _error;
exports.info = _info;
exports.field = _field;
exports.confirm = _confirm;
exports.modal = _modal;
});

define('syracuse-tablet/html/js/init/initStyles',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals'],function (require, exports, module) {

/*
 * Module to initialize CSS for used OS/Platform
 *
 */
var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');

function _loadCss(file) {
	var ref = document.createElement("link");

	ref.setAttribute("rel", "stylesheet");
	ref.setAttribute("type", "text/css");
	ref.setAttribute("href", file);

	document.getElementsByTagName("head")[0].appendChild(ref);
}

function _getOS() {
	var mobile = (/iphone|ipad|ipod|android|blackberry|mini|windows|palm/i.exec(navigator.userAgent.toLowerCase()));
	var map = {
		iphone: "ios",
		ipad: "ios",
		ipod: "ios",
		android: "android",
		windows: "windows"
	};
	return map[mobile || "windows"] || windows;
}

function _isReleaseVersion() {
	return (document.location.href.indexOf("index.html") > -1);
}

exports.init = function() {
	var deferred = new $.Deferred();
	var os = _getOS();
	var css = "./css/" + os + (_isReleaseVersion() ? ".min" : "") + ".css";
	_loadCss(css);
	deferred.resolve();

	globals.setLookAndFeel(os);

	return deferred.promise();
};
});

define('syracuse-tablet/html/js/init/initLocale',['require','exports','module','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var locale = require('syracuse-tablet/html/js/helpers/locale');

exports.init = function() {
	var lang = "en_GB";
	return locale.setLocale(lang);
};
});

define('syracuse-tablet/html/js/application/appFactory',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("factory");
var globals = require('syracuse-tablet/html/js/helpers/globals');

var _ctor = {
	Application: function() {
		throw new Error("Not implemented");
	},
	DashoardPage: function() {
		throw new Error("Not implemented");
	},
	RegularPage: function() {
		throw new Error("Not implemented");
	},
	DefHomePage: function() {
		throw new Error("Not implemented");
	},
	LoginPage: function() {
		throw new Error("Not implemented");
	},
	SettingsPage: function() {
		throw new Error("Not implemented");
	},
	AboutPage: function() {
		throw new Error("Not implemented");
	},
	DaoApp: function() {
		throw new Error("Not implemented");
	},
	DaoSdata: function() {
		throw new Error("Not implemented");
	}
};

var _createApplication = function($$elmt) {
	var res = new _ctor.Application($$elmt, exports);
	res.init();
	log && log("Application", "Create ok");
	return res;
};

var _createPage = function($parent, state) {
	var res = null,
		type = state.type;
	var deferred = $.Deferred();
	try {
		if (type == "html" && state.name == "login") {
			res = new _ctor.LoginPage($parent, state);
		} else if (type == "html" && state.name == "settings") {
			res = new _ctor.SettingsPage($parent, state);
		} else if (type == "html" && state.name == "about") {
			res = new _ctor.AboutPage($parent, state);
		} else if (type == "html" && state.name == "defhome") {
			res = new _ctor.DefHomePage($parent, state);
		} else if (type == "dashboard") {
			var info = globals.getApplication().dao.getDashboardInfo(state.dashboardUuid);
			res = new _ctor.DashoardPage($parent, state, info.prototype, info.article);
		} else if (type == "regular") {
			globals.getApplication().dao.getRegularPageInfo(state.name, state.options)
				.then(function(info) {
					res = new _ctor.RegularPage($parent, state, info.prototype, info.article);
					deferred.resolve(res);
				}).fail(function(e) {
					deferred.reject(e);
				});
		} else {
			throw new Error("Unknown page type[" + type + "]");
		}
		if (res) {
			// Synchronous result
			deferred.resolve(res);
		}
		log && log("New Page", "Create ok");
	} catch (e) {
		deferred.reject(e);
	} finally {
		return deferred.promise();
	}
};

var _createDaoApp = function(appli) {
	var dao = new _ctor.DaoApp(appli);
	log && log("New DAO Application", "Create ok");
	return dao;
};

var _createDaoSdata = function(type, data, prototype, parent, options) {
	var dao;
	switch (type) {
		case "representation":
		case "process":
		case "request":
		case "statistics":
		case "dashboardpage":
		case "externallink":
			dao = new _ctor.DaoSdata(data, prototype, parent, options);
			break;
		default:
			throw new Error("Unknown DaoSdata type[" + type + "]");
			break;
	}
	log && log("New DAO View", "Create ok");
	return dao;
};

exports.setImpl = function(name, ctor) {
	_ctor[name] = ctor;
};

exports.createApplication = _createApplication;
exports.createPage = _createPage;
exports.createDaoApp = _createDaoApp;
exports.createDaoSdata = _createDaoSdata;
});

define('syracuse-tablet/html/js/application/breadcrumb',['require','exports','module','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').log;


var _BreadCrumb = function() {
	var self = this;

	// Initial length of history
	self.historyLength = window.history.length;

	self.destroy = function() {

	};

	self.getHistory = function(page) {
		var res = [];
		window.$sm.getApplication.$elmt.find(".page.breadcrumb").each(function(ix) {
			var page = $(this).smPageController();
			if (page) {
				res.push({
					title: page.historyTitle,
					historyLength: page.historyLength
				});
			}
		});
	};

	self.display = function() {
		var html = "";
		self.getHistory().forEach(function(entry, idx) {
			html.push("[" + idx + "] - title: " + entry.title + " - historyLength:" + entry.historyLength);
		});
		alert(html);
	};
};

exports.BreadCrumb = _BreadCrumb;
});

define('syracuse-tablet/html/js/application/authentication',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ajax/ajax'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("app");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

/**
 * Login services are temporarily implemented in requireJSDispatcher._js
 * - tabletCheckLogin
 * 		Return 403 if login failed because 401 forces the browser to display the authentication dialog
 * - tabletDoLogin
 *      Return user's profile if OK
 */
var _config = {
	svcCheckLogin: "/requireJS/tabletCheckLogin",
	svcDoLogin: "/requireJS/tabletDoLogin",
	svcLogout: "/logout",
	authParams: "/sdata/syracuse/collaboration/syracuse/userProfiles/$service/current"
};

/**
 * True if user is logged in
 */
var _check = function() {
	var deferred = new $.Deferred();
	var _rejectError = function(e, t) {
		log && log(t || "Check login request rejected", e);
		deferred.reject(e);
	};
	try {
		var checkurl = globals.baseLocation().host + _config.authParams;
		return ajax("GET", _config.svcCheckLogin, {
			checkurl: checkurl
		}).then(function(result) {
			// check login service return 200 or 403 - See 
			deferred.resolve({
				authenticated: result.status === 200
			});
		}).fail(function(e){
			_rejectError
		});
	} catch (e) {
		_rejectError(e, "Check login request exception");
	} finally {
		return deferred.promise();
	}
};
/**
 * Resolve with success and user's profile
 */
var _login = function(user, password, lang) {
	var deferred = new $.Deferred();
	var _rejectError = function(e, t) {
		log && log(t || "Login request rejected", e);
		deferred.reject(e);
	};
	try {
		var checkurl = globals.baseLocation().host + _config.authParams;
		// temporarily - To improve
		return ajax("GET", _config.svcDoLogin, {
			checkurl: checkurl,
			user: user,
			password: password,
			lang: lang
		}).then(function(result) {
			// Return the userProfiles if ok
			deferred.resolve(result.isSuccess, result.responseJSON, "Httpstatus: " + result.status + (result.descrHttpStatus ? "[" + result.descrHttpStatus + "]" : ""));
		}, _rejectError);
	} catch (e) {
		_rejectError(e, "Do login request exception");
	} finally {
		return deferred.promise();
	}
};

/**
 * Logout
 */
var _logout = function() {
	var deferred = new $.Deferred();
	var _rejectError = function(e, t) {
		log && log(t || "Logout request rejected", e);
		deferred.reject(e);
	};
	try {
		var url = globals.baseLocation().host + _config.svcLogout;
		// temporarily - To improve
		return ajax("GET", url, {
			device: "phone"
		}).then(function(result) {
			var data;
			var msg = "";
			if (!result.isSuccess) {
				msg = "Httpstatus: " + result.status + (result.descrHttpStatus ? "[" + result.descrHttpStatus + "]" : "");
			}
			var diag = result.responseJSON ? result.responseJSON.$diagnoses : null;
			if (diag) {
				diag.forEach(function(d) {
					msg += (msg.lengthj > 0 ? "\n" : "") + d.$message;
				});
			}
			deferred.resolve(result.isSuccess, msg);
		}, _rejectError);
	} catch (e) {
		_rejectError(e, "Do logout request exception");
	} finally {
		return deferred.promise();
	}
};

exports.check = _check;
exports.login = _login;
exports.logout = _logout;
});

define('syracuse-tablet/html/js/application/eventListener',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ui/modal'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("evts");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var modal = require('syracuse-tablet/html/js/ui/modal');

var _attr = function($$e, name, nullIfEmpty) {
	var a = ($$e.attr(name) || "").trim();
	return nullIfEmpty && a.length === 0 ? null : a;
};
/**
 * Only if current pages  is a dashboard
 * return the parent vignette or null
 * we assume that there are no dashboard in vignettes
 */
var _findParentVignette = function($$target, app, fail) {
	if (app.currentPage.getType() === "dashboard") {
		// Find vignette controlId + get vignette control
		var vignetteId = _attr($$target.closest(".s-m-control.s-m-vignette"), "id");
		if (fail && vignetteId.length === 0) throw new Error("Vignette DOM elmt not found");
		var vignette = app.currentPage.getControl(vignetteId);
		if (fail && !vignette) throw new Error("Vignette not found - id[" + vignetteId + "]");
		return vignette;
	} else if (fail) {
		throw new Error("Current page is not a dashboard");
	}
	return null;
};
/**
 * Returns null or {vignette, control} if ctrlId has been found in a vignette
 */
var _findCtrlInDashboard = function($$target, app, ctrlId) {
	//Two ways - tested - second should be more efficient but both take few ms
	if (false) {
		// Scan all vignettes and seach control (ctrlId is unic)
		return app.currentPage.findVignetteControl(ctrlId);
	} else {
		// Find vignette controlId + get vignette control + get control from vignette's page
		var vignette = _findParentVignette($$target, app, true);
		var control = vignette.getPageControl(ctrlId);
		return control ? {
			control: control,
			vignette: vignette
		} : null;
	}
};

/*
 * Parse code=abc&value=cde to
 * {
 * code: "abc",
 * value: "cde"
 * }
 */
var _parseParameters = function(params) {
	var p = params.split("&");
	var res = {};
	for (var i = 0; i < p.length; i++) {
		var v = p[i].split("=");
		res[v[0]] = v[1];
	}
	return res;
};
/**
 * Calls an action given by data-action
 */
var _doAction = function(evt, app, act, params, controlId) {
	var fail = function(e) {
		var title = "_doAction[" + act + "]" + (controlId ? " CtrlId[" + controlId + "]" : "") + " error";
		log && log(title, e);
		modal.error(title, e);
	};
	try {
		if (app.currentPage == null) throw new Error("No current page");
		var method = "_act" + $.camelCase("-" + act);
		var object;
		if (controlId) {
			// Find control in current page and vignettes if dashboard
			object = app.currentPage.getControl(controlId);
			if (object == null && app.currentPage.getType() === "dashboard") {
				object = _findCtrlInDashboard($(evt.target), app, controlId);
				if (object) object = object.control;
			}
			if (object == null) throw new Error("Control not found");
		} else {
			// Find if it's an action off a vignette (contains a page)
			var vignette = _findParentVignette($(evt.target), app, false);
			if (vignette) {
				if (vignette[method]) {
					object = vignette;
				} else {
					var p = vignette.getPage();
					if (p && p[method]) object = p;
				}
			}
			// Find if it's a current page action
			if (object == null && app.currentPage[method]) object = app.currentPage;
			// Find if it's a global action
			if (object == null) object = app;
		}
		if (!object[method]) throw new Error("Method [" + method + "] not found in object/application/current page)");
		$.when(object[method].call(object, params)).then(function(todo) {
			if (todo) {
				if (todo.page) {
					globals.getApplication().changePage(todo.page);
				}
			}
		}, function(e) {
			fail(e);
		});
	} catch (e) {
		fail(e);
	}
};
/** 
 * Bind actions declared by data-nav or data-action/data-params attributes to an object
 *      for navigation data-nav  contains the name of the targeted page
 * 		for action method name is : _actActionName with ActionName the name of action declared in data-action attribute
 * object	: object that processes the actions
 * 				Check current page and application if method not found in object
 * 				if data-control-id attribute call control's action on current page
 * $$elmt 	: optional if object.$$elmt - element to bind event
 * selector : optional
 * 		Default selector is "[data-nav], [data-action]"
 */
var _bindActions = function(app) {
	var fail = function(e) {
		var title = "_bindActions error";
		log && log(title, e);
		modal.error(title, e);
	};
	// Action are bound to application $$elmt and dispatcched to current page or control
	var $$elmt = app.$$elmt;
	if (!$$elmt) throw new Error("_bindActions - null $$elmt");
	$$elmt.delegate("[data-nav], [data-nav-refresh], [data-action]", "click select change", function(evt) {
		try {
			if (app.hasModalOpen()) {
				// If we have a modal in front of a page with a default button and if we press enter to close the dialog we trigger default action of the page
				// This test block the action - TODO improve
				console.log("!!! Tries to execute an action data-action with a MODAL open.\nAction is skipped");
				return;
			}
			var target = $(evt.target);
			evt.preventDefault();
			evt.stopPropagation();
			var clickedElmt = target.closest("[data-nav], [data-nav-refresh]");
			if (clickedElmt.length > 0) {
				/** NAVIGATION **/
				var options = {};
				// Page to open
				var attr = _attr(clickedElmt, "data-sdata-url");
				if (attr.length > 0) {
					options["sdata-url"] = decodeURIComponent(attr);
				}
				// Link type : pagination...
				var attrType = _attr(clickedElmt, "data-nav-type");
				if (attr.length > 0) {
					options["type"] = attrType;
				}
				// Target - vignette -> Change/Refresh the page in the vignette - null or "application" Change/Refresh  application currentpage
				var attrTarget = _attr(clickedElmt, "data-nav-target");
				var navTarget;
				if (attrTarget === "vignette") {
					// data-nav-target allows to specify the target for navigation link - Ex pagination
					navTarget = _findParentVignette(target, app, true);
				} else if (attrTarget !== "application" && app.$config("openLinkInVignette")) {
					// Navigation in vignette - Just a  try but it works - Vignette display back/home icon in icon bar
					navTarget = _findParentVignette(target, app, false);
				}
				// default navigation is done at application level
				if (!navTarget) navTarget = app;
				// Page refresh instead of opening a new page	
				if (_attr(clickedElmt, "data-nav-refresh") === "true") {
					/** Refresh current page**/
					options["pageRefresh"] = true;
					// Control to refresh if any
					options["controlId"] = _attr(clickedElmt, "data-control-id", true);
					navTarget.refreshPage(options);
				} else {
					/** Open a new page**/
					var pageName = decodeURIComponent(_attr(clickedElmt, "data-nav"));
					// Gadget - Page opener
					attr = _attr(clickedElmt, "data-gadget-id");
					if (attr.length > 0) {
						options["gadget-id"] = attr;
					}

					attr = _attr(clickedElmt, "data-sdata-parameters");
					if (attr && attr.length > 0) {
						options["sdataParameters"] = _parseParameters(attr);
					}
					// history.back not allowed - TODO See how to pass options	JSON in params ?	
					attr = _attr(clickedElmt, "data-nav-noback");
					options["noHistoryBack"] = attr === "true";
					navTarget.changePage(pageName, options);
				}
				return;
			}
			clickedElmt = target.closest("[data-action]");
			if (clickedElmt.length > 0) {
				/** ACTION **/
				evt.preventDefault();
				evt.stopPropagation();
				var param;
				if (clickedElmt.is("select")) {
					param = $(this).val();
				} else {
					param = decodeURIComponent(_attr(clickedElmt, "data-params"));
				}
				var controlId = _attr(clickedElmt, "data-control-id", true);
				_doAction(evt, app, _attr(clickedElmt, "data-action"), param, controlId);
				return;
			}
		} catch (e) {
			fail(e);
		}
	});
};

/**
 * Add event handlers for controls
 * 		put a ctrl-evt- + evtName in the class attribute of the dom element you want to enable
 * 		handler will call ctrl.onEventName (onClick, onBlur...)
 */
var _bindControlEvents = function(app) {
	var fail = function(e) {
		var title = "_bindControlEvents error";
		log && log(title, e);
		modal.error(title, e);
	};
	var events = ["click", "blur", "change"];
	// Use forEach instead of for(var i =...) to preserve evtname closure context otherwise evtname has always the last value
	events.forEach(function(evtname) {
		app.$$elmt.delegate(".ctrl-evt-" + evtname, evtname, function(event) {
			event.preventDefault();
			event.stopPropagation();
			try {
				var target = $(event.target);
				var ctrlId = _attr(target.hasClass("s-m-control") ? target : target.closest(".s-m-control"), "id");
				if (!app.currentPage) throw new Error("No current page");
				var ctrl = app.currentPage.getControl(ctrlId);
				if (!ctrl && app.currentPage.getType() === "dashboard") {
					ctrl = _findCtrlInDashboard(target, app, ctrlId);
					if (ctrl) ctrl = ctrl.control;
				}
				if (!ctrl) throw new Error("Control not found - ctrlid[" + ctrlId + "] in currentpage or vignettes");
				var method = "on" + evtname.smCapitalize();
				if (!ctrl[method]) {
					console.log("!!! Method[" + method + "] not found - ctrlid[" + ctrlId + "]");
					return;
				}
				ctrl[method](event);
			} catch (e) {
				fail(e);
			}
			return;
		});
	});
};

/**
 * Application event listener
 */

var _bindEvents = function(app) {

	$(window).bind("popstate", function(event) {
		event.preventDefault();
		var state = event.originalEvent.state;
		log && log("popstate", "history.length=" + window.history.length, "State=" + (state != null));
		if (!state) return;
		setTimeout(function() {
			app.back(state);
		}, 0);
	});

	$(window).bind("hashchange", function() {
		log && log("hashchange", "history.length=" + window.history.length, "Hash=" + window.location.hash);
	});

	// Bind action/navigation call to click/select/change 
	_bindActions(app);

	// Bind control events
	_bindControlEvents(app);

};

exports.bindEvents = _bindEvents;
});

define('syracuse-tablet/html/js/application/gadget',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("sdataDao");
var globals = require('syracuse-tablet/html/js/helpers/globals');

var _Gadget = utils.defineClass(function(jsonData) {
	var self = this;
	self._data = jsonData;
}, null, {

	destroy: function() {
		var self = this;
		self._data = null;
	},

	isRequest: function() {
		return this._data.$type === "$request";
	},

	data: function(prop) {
		return this._data ? this._data[prop] : null;
	},

	getEndPoint: function() {
		// Default endpoint if not specified
		return this._data.endpoint || globals.getEndpoint();
	},

	isDefaultEndpoint: function() {
		return !this._data.endpoint;
	},

	getPageName: function() {
		var self = this;
		if (!self.isValid()) return null;
		var rep = self.isRequest() ? self.getRequestRepresentation() : self._data.representation;
		return self.getEndPoint() + "." + rep + "." + self._data.facet;
	},

	getSDataUrl: function(proto) {
		var self = this;
		var url;
		switch (self._data.$type) {
			case "$representation":
				if (["$details", "$edit"].indexOf(self._data.action) > -1) {
					url = proto.data("$url", {
						$key: self._data.keyParameter
					});
				} else if (["$create"].indexOf(self._data.action) > -1) {
					url = proto.data("$url");
					url = url.replace(/\((.*?)\)/, "/$template");
				} else {
					url = proto.data("$url");
				}
				break;
			case "$request":
				url = proto.data("$baseUrl");
				url = url + "/QUERY('" + self._data.requestName + "')?representation=" + self.getRequestRepresentation() + ".$query";
				break;
		}
		return url;
	},
	getRequestRepresentation: function() {
		return "QUERY~" + this._data.requestName + "~" + this._data.requestLevel;
	},
	getJSON: function() {
		return $.extend(true, {}, this._data);
	},
	isValid: function() {
		// to complete
		return this.getInvalidReason() == null;
	},
	getInvalidReason: function() {
		var t = this._data.$type;
		if (t === "$representation" || t === "$stats" || t === "$request") {
			// When we import mobile apps we could have such error
			// tablet client displays a user friendly message
			// to complete
			if (this._data.$uuid.smStartsWith("test")) return null;
			return (this.getEndPoint() || "").trim().length == 0 ? "No endpoint" : null;
		}
		// TODO
		return null;
	},
	getParameters: function() {
		return this._data.parameters || {};
	}
});

exports.Klass = _Gadget;
});

define('syracuse-tablet/html/js/application/pageLoader',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/application/gadget'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("pageLoader");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var modal = require('syracuse-tablet/html/js/ui/modal');
var Gadget = require('syracuse-tablet/html/js/application/gadget').Klass;


/**
 * Load a page in a container
 * 	container must provide the following interface
 * 	Use by application and vignette - code factorization
 * 	callerInterface - see CALLER INTERFACE below
 */
var _PageLoader = utils.defineClass(
	function(callerInterface) {
		this.callerInterface = callerInterface;
		this.factory = globals.getApplication().factory;
	}, null, {

		destroy: function() {
			this.callerInterface = null;
			this.factory = null;
		},

		load: function(state, back) {
			var deferred = $.Deferred();
			var self = this;
			var _fail = function(e) {
				self.waitStop();
				self.loadingError(deferred, state, e);
			};
			var _success = function(dstPage) {
				self.waitStop();
				if (back !== true && (state.options == null || state.options.noHistoryBack !== true)) {
					// Store page in history - noHistoryBack option is used by example for pagination actions
					self.setHistory(dstPage.state);
				}
				self.succeeded();
				deferred.resolve(dstPage);
			};
			try {
				if (state === null || typeof state != "object") throw new Error("Bad state object");
				log && log("_gotoPage", "start", "page: " + state.uuid);
				var curPage = self.getCurrentPage();
				if (curPage && curPage.getProp("uuid") === state.uuid) {
					log && log("\tPage is current -> Skip");
					return;
				}
				self.waitStart();
				var dstPage = $("#" + state.uuid).smPageController();
				// Page found -> Direct access -> Activate and remove childs
				if (dstPage != null) {
					log && log("\tPage found in dom -> Activate");
					if (!dstPage) throw new Error("Unexpected null page data");
					self._pageActivate(dstPage, function() {
						// After activation to keep current page for transition
						// No siblings expected
						dstPage.destroySiblings();
						deferred.resolve(dstPage);
					}, back);
					return deferred.promise();
				}
				// Page not found -> Create and display
				self.factory.createPage(self.getRootElmt(), state)
					.then(function(p) {
						dstPage = p;
						// TODO - Use href to allow reload or find a workaround by storing the sate into a hash in _sessionStorage
						return dstPage.load();
					})
					.then(function() {
						self._pageActivate(dstPage, function() {
							_success(dstPage);
						}, back);
					}, function(e) {
						_fail(e);
					});
			} catch (e) {
				_fail(e);
			}
			return deferred.promise();
		},

		_pageActivate: function(page, cb, back) {
			var self = this;
			page.activate(self.getCurrentPage(), function() {
				self.setCurrentPage(page);
				if (cb) cb();
			});
		},

		/**
		 * CALLER INTERFACE BEGIN
		 */

		/* Methods MUST be implemented */
		setHistory: function(state) {
			this.callerInterface.setHistory(state);
		},

		waitStop: function() {
			this.callerInterface.waitStop();
		},

		waitStart: function() {
			this.callerInterface.waitStart();
		},

		getRootElmt: function() {
			return this.callerInterface.getRootElmt();
		},

		getCurrentPage: function() {
			return this.callerInterface.getCurrentPage();
		},

		setCurrentPage: function(page, back) {
			var self = this;
			var curPage = self.getCurrentPage();
			if (curPage) {
				if (back === true || curPage.getProp("cached") !== true) {
					curPage.destroy();
				} else {
					// Keep cached page only if not back - Ex: List -> Detail
					curPage.deactivate();
				}
			}
			self.callerInterface.setCurrentPage(page);
		},
		/* Methods CAN be overridden */
		loadingError: function(deferred, state, e) {
			if (this.callerInterface.loadingError) {
				this.callerInterface.loadingError(deferred, state, e);
			} else {
				modal.error("Loading page [" + state.name + "] error", e, function() {
					deferred.reject(e);
				});
			}
		},
		succeeded: function() {
			if (this.callerInterface.succeeded) this.callerInterface.succeeded();
		}
		/**
		 * CALLER INTERFACE END
		 */
	});

/**
 * window.history accepts only json object (no class/prototype based object)
 * We have to serialize/deserialize object contained by state
 */
var _stateSerialize = function(state) {
	if (!state || !state.options || !state.options.gadget) return state;
	// Object that represents the gadget data
	state.options.gadget = state.options.gadget.getJSON();
	return state;
};
var _stateDeserialize = function(state) {
	if (!state || !state.options || !state.options.gadget) return state;
	state.options.gadget = new Gadget(state.options.gadget);
	return state;
};

exports.stateSerialize = _stateSerialize;
exports.stateDeserialize = _stateDeserialize;
exports.Klass = _PageLoader;
});

define('syracuse-tablet/html/js/helpers/templating',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ajax/ajax'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("tmpl");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

var _config = {
	htmlHolder: "body",
	tmplPath: "templates",
	tmplExt: ".tmpl"
};
var _temptates = {};

var _url = (function() {
	var url = window.location.href.split('/');
	url[url.length - 1] = _config.tmplPath + "/";
	return url.join('/');
})();

var _get = function(filePath, tmplId, options) {
	options = options || {};
	var deferred = $.Deferred();
	tmplId = tmplId || filePath;
	var domId = utils.domId(tmplId);
	if (_temptates[tmplId]) {
		deferred.resolve(_temptates[tmplId]);
	} else if ($("#" + domId).length > 0) {
		_temptates[tmplId] = $("#" + domId).html();
		deferred.resolve(_temptates[tmplId]);
	} else {
		var url = _url + filePath + _config.tmplExt;
		if (globals.isDvlpMode()) {
			// Force templae reload in development mode
			url += "?" + new Date().getTime();
		}
		ajax("GET", url, null, {
			"Accept": "text/html"
		}).then(function(result) {
			try {
				var data = result.responseText || "";
				if (result.status === 200) {
					// We add the script tag here to have Syntax highlighting in .tmpl file
					var e = $(_config.htmlHolder);
					if (data.indexOf("<script") === -1) {
						e.append($('<script id="' + domId + '" type="text/x-handlebars-template">' + data + "</script>"));
					} else {
						$(data).each(function(i, script) {
							e.append(script);
						});
					}
					deferred.resolve($("#" + domId).html());
				} else {
					if (options.failNotFound) throw new Error("Template not found status[" + result.status + "]");
					deferred.resolve(null);
				}
			} catch (e) {
				deferred.reject(e);
			}
		}, function(e) {
			deferred.reject(e);
		});
	}
	return deferred.promise();
};

// file : template file path - tmplId : template id - tmplId = null if only one template in the file
var _exec = function(filePath, context, options, tmplId) {
	var deferred = $.Deferred();
	tmplId = tmplId || filePath;
	_get(filePath, tmplId, options).then(function(tmpl) {
		try {
			if (typeof tmpl === "string") {
				tmpl = Handlebars.compile(tmpl);
				_temptates[tmplId] = tmpl;
			}
			deferred.resolve(tmpl ? tmpl(context || {}) : null);
		} catch (e) {
			log && log("!!!! Compileemplate  rejected", e);
			log && log("filePath[#" + filePath + "]\n\ttmplId[#" + tmplId + "]\n\tExt [" + _config.tmplExt + "]");
			deferred.reject(e);
		}
	}, function(e) {
		log && log("!!!! Read template rejected", e);
		log && log("filePath[#" + filePath + "]\n\ttmplId[#" + tmplId + "]\n\tExt [" + _config.tmplExt + "]");
		deferred.reject(e);
	});
	return deferred.promise();
};

// Execute a template already loaded - Multiple templates in a same file
var _execSync = function(tmplId, context) {
	var tmpl = _temptates[tmplId];
	if (!_temptates[tmplId]) {
		tmpl = $("#" + utils.domId(tmplId)).html();
		if (tmpl) {
			tmpl = Handlebars.compile(tmpl);
			_temptates[tmplId] = tmpl;
		}
	}
	return tmpl ? tmpl(context || {}) : null;
};


// Preload templates in background - Temporarily - TODO use workers
var _preload = function(templates) {
	var promises = [];
	templates.forEach(function(t) {
		promises.push(_exec(t), {});
	});
	/* Always to not break templates loading */
	$.when(promises).always(function(e) {
		var nbKo = 0;
		for (var i = 0; i < arguments.length; i++) {
			if (!utils.isError(arguments[i])) nbKo++;
		}
		log && log("Templates preload", "Count[" + templates.length + "]", "NbOk[" + (arguments.length - nbKo) + "]", "NbKo[" + nbKo + "]");
	});
};
/**
 * Set the parent root that contains _config.tmplPath folder
 *  relativePath : relative to /syracuse-tablet
 **/
var _setTmplRoot = function(relativePath) {
	if (!relativePath || relativePath.length == 0) return;
	_url = globals.baseLocation().withPath;
	if (!relativePath.smStartsWith('/')) _url += '/';
	_url += relativePath;
	if (!relativePath.smEndsWith('/')) _url += '/';
	_url += _config.tmplPath + '/';
};

//id = null -> Remove all templates
var _remove = function(id) {
	var s = id ? "#" + utils.domId(id) : "script[type='text/x-handlebars-template']";
	var e = $(_config.htmlHolder).find(s).remove();
};

/* called by main.js*/
var _init = function() {
	// Remove templates on reload otherwise they not refreshed
	if (globals.isDvlpMode()) {
		// Remove templates to force reload in development mode
		_remove();
	}
};
exports.setTmplRoot = _setTmplRoot;
exports.preload = _preload;
exports.remove = _remove;
exports.execSync = _execSync;
exports.exec = _exec;
exports.init = _init;
});

define('syracuse-tablet/html/js/pages/html/pageTemplates',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/templating','syracuse-tablet/html/js/ajax/ajax','syracuse-tablet/html/js/ui/modal'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("page");
var templates = require('syracuse-tablet/html/js/helpers/templating');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;
var modal = require('syracuse-tablet/html/js/ui/modal');

var _consts = {
	tmplPage: "pages/",
	tmplDefHeader: "pages/default/header",
	tmplRoot: "templates/pages/",
	dataFile: "/data.json",
	tmplHead: "header",
	tmplMain: "main"
};

var _defHeaderCtx = {
	title: "Sage X3 Mobile",
	home: " Home",
	about: " About",
	logout: " Logout",
	settings: " Settings",
	application: ""
};

/**
 * Reads header in templates/pageName
 * If no header reads default header in templates/default
 */
var _getTemplateHeader = function(state, ctxHeader) {
	var self = this;
	var deferred = $.Deferred();
	var _resolveError = function(e) {
		log && log(state.name + "Template header error", e);
		deferred.resolve(null);
	};
	try {
		if (ctxHeader == null) deferred.resolve(null);
		var root = _consts.tmplPage + state.name + "/";
		templates.exec(root + _consts.tmplHead, ctxHeader, {
			failNotFound: false
		}).then(function(header) {
			if (header == null && ctxHeader != null) {
				_defHeaderCtx.application = globals.getApplication().getTitle();
				templates.exec(_consts.tmplDefHeader, _defHeaderCtx).then(function(header) {
					deferred.resolve(header);
				}, function(e) {
					_resolveError("Error loading default page header");
				});
			} else {
				deferred.resolve(header);
			}
		}, function(e) {
			_resolveError(e);
		});
	} catch (e) {
		_resolveError(e);
	} finally {
		return deferred.promise();
	}
};

/**
 * Reads content templates in templates/pageName
 */
var _getTemplateContent = function(state, ctxContent) {
	var self = this;
	var deferred = $.Deferred();
	try {
		if (ctxContent == null) deferred.resolve(null);
		var root = _consts.tmplPage + state.name + "/";
		templates.exec(root + _consts.tmplMain, ctxContent).then(function(content) {
			deferred.resolve(content);
		}, function(e) {
			_resolveError(deferred, state.name, e);
		});
	} catch (e) {
		_resolveError(deferred, state.name, e);
	} finally {
		return deferred.promise();
	}
};


/**
 * Mockup - Load a data.json file in templates/pageName
 */
var _getData = function(state) {
	var deferred = $.Deferred();
	var url = globals.baseLocation().htmlRoot + state.name + _consts.dataFile;
	if (state.detailid) {
		// If the link has a data-detailid attribute we expect a data.detaild.json file
		url = url.replace(".json", "." + state.detailid + ".json");
	}
	ajax("GET", url).then(function(result) {
		deferred.resolve(result.status === 200 ? result.responseJSON : null);
	}, function(e) {
		deferred.reject(e);
	});
	return deferred.promise();
};

var _resolveError = function(deferred, pageName, e) {
	var content = '<div class="alert alert-danger" role="alert"> Error loading page  "' + pageName + '"</div>';
	if (e) {
		content += "<p>Error</p><pre>" + JSON.stringify(utils.toDiagnose(e, null, true), null, 2) + "</pre>";
	}
	if (deferred) {
		deferred.resolve(content);
	}
};

exports.getTemplateContent = _getTemplateContent;
exports.getTemplateHeader = _getTemplateHeader;
exports.getData = _getData;
exports.resolveError = _resolveError;
});

define('syracuse-tablet/html/js/pages/html/modalSelectContext',['require','exports','module','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var modal = require('syracuse-tablet/html/js/ui/modal');
var locale = require('syracuse-tablet/html/js/helpers/locale');

var _template = '\
	<div class="modal fade" id="modal-endpoint" tabindex="-1" role="dialog"> \
    <div class="modal-dialog"> \
		<div class="modal-content"> \
		    <div class="modal-header"> \
				<h4 class="modal-title" id="myModalLabel">{{title}}</h4> \
		    </div> \
		    <div class="modal-body"> \
				<div class="form-group"> \
					<label>{{label_endpoints}}</label>\
					<select class="form-control" id="login-select-endpoint"> \
					{{#each endpoints}}\
						<option value="{{this.application}}.{{this.contract}}.{{this.dataset}}" {{#if this.selected}}selected{{/if}}>\
						{{this.description}}\
						</option>\
					{{/each}}\
					</select>\
				</div> \
			<div class="form-group"> \
				<label>{{label_roles}}</label>\
				<select class="form-control" id="login-select-role"> \
				{{#each roles}}\
					<option value="{{this.code}}" {{#if this.selected}}selected{{/if}}>\
					{{this.description}}\
					</option>\
				{{/each}}\
				</select>\
			</div> \
			<div class="form-group"> \
				<label>{{label_languages}}</label>\
				<select class="form-control" id="login-select-language"> \
				{{#each languages}}\
					<option value="{{this.code}}" {{#if this.selected}}selected{{/if}}>\
					{{this.description}}\
					</option>\
				{{/each}}\
				</select>\
			</div> \
			{{#if label_warning}}\
			<div class="alert alert-warning" role="alert">\
				{{label_warning}}\
			</div>\
			{{/if}}\
		    </div> \
		    <div class="modal-footer"> \
		        <button type="button" class="btn" data-action="validate">{{label_ok}}</button> \
    			<button type="button" class="btn btn-default" data-action="cancel">{{label_cancel}}</button> \
			</div> \
		</div> \
	</div> \
	</div>';

/**
 * force = true
 * 		Force display of  modal is an endpoint is still available in local storage
 */
var _selectContext = function(context, endpoints, roles, languages, warn) {
	var deferred = $.Deferred();
	try {
		try {
			var modalHtml = Handlebars.compile(_template);
			var ctx = {
				title: locale.text("modal.context.title"),
				label_endpoints: locale.text("modal.context.endpoint"),
				endpoints: endpoints,
				label_roles: locale.text("modal.context.roles"),
				roles: roles,
				label_languages: locale.text("modal.context.languages"),
				languages: languages,
				label_ok: locale.text("modal.context.ok"),
				label_cancel: locale.text("modal.context.cancel"),
				label_warning: warn && locale.text("modal.context.warning"),
			};
			if (context) {
				endpoints.forEach(function(ep) {
					if (ep.application + "." + ep.contract + "." + ep.dataset === context.endpoint) {
						ep.selected = true;
					} else {
						ep.selected = false;
					}
				});
				roles.forEach(function(role) {
					if (role.code === context.role) {
						role.selected = true;
					} else {
						role.selected = false;
					}
				});
				languages.forEach(function(lang) {
					if (lang.code === context.language) {
						lang.selected = true;
					} else {
						lang.selected = false;
					}
				});
			}
			modalHtml = modalHtml(ctx);
			modal.modal(modalHtml, function(msg, dialg) {
				if (msg === "validate") {
					var endpoint = dialg.find("#login-select-endpoint").val();
					var role = dialg.find("#login-select-role").val();
					var language = dialg.find("#login-select-language").val();

					deferred.resolve({
						endpoint: endpoint,
						role: role,
						language: language
					});
				} else if (msg === "cancel") {
					deferred.resolve(); // null = cancelled
				}
			});
		} catch (e) {
			deferred.reject(e);
		}
	} catch (e) {
		deferred.reject(e);
	} finally {
		return deferred.promise();
	}
};

exports.selectContext = _selectContext;
});

define('syracuse-tablet/html/js/sdata/sdataUtils',['require','exports','module','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');

/*
 * add complements to utils.parseURL
 * {
   	"representation": "AQTCRUDM",
	"facet": "edit",

  	// for sdataDispatcher id "sdata" or "local"
  	"dispatch": "sdata",
  	"application": "x3",
  	"contract": "erp",
  	"dataset": "SUPERV",
  	"entity": "AQTCRUD",
  	
  	// entity id
  	"id": null,
}
 */
var _rID = /^(.*)\(\'(.*)\'\)$/i;
var _parseSDataURL = function(url) {
	var res = utils.parseURL(url);
	if (res.query && res.query.representation) {
		res.representation = res.query.representation;
		res.facet = null;
		var p = res.representation.indexOf('.');
		if (p != -1) {
			res.facet = res.representation.substr(p + 1);
			if (res.facet.charAt(0) == '$') res.facet = res.facet.substr(1);
			res.representation = res.representation.substr(0, p);
		}
	}
	var a = res.directory.split('/');
	if (a.length <= 4) {
		throw new Error("Bad sdata url:" + url);
	}
	res.dispatch = a[1];
	res.application = a[2];
	res.contract = a[3];
	res.dataset = a[4];
	if (a.length === 4) return res;
	var match = _rID.exec(a[5]);
	if (match && (match.length == 3)) {
		res.entity = match[1];
		res.id = match[2];
		if (res.id && res.id.trim().Length === 0) res.id = null;
	} else {
		res.entity = a[5];
		res.id = null;
	}
	if (a.length === 5) return res;
	return res;
};

/**
 * Resolve sdataurl and return navigation info to generate the <a>/<button> link
 */
var _getLinkInfo = function(sDataUrl, dao) {
	if (dao) { // dao is optional since a link can be a link without dataset (e.g. prev/next)
		sDataUrl = dao.parseExpression(sDataUrl);
	}
	var url = _parseSDataURL(sDataUrl);
	if (url.query.representation) {
		var ep = url.application + "." + url.contract + "." + url.dataset;
		return {
			type: 'navig',
			page: ep + "." + url.query.representation,
			sDataUrl: sDataUrl
		};
	} else if (url.entity === "$mobileDashboards") {
		return {
			type: 'navig',
			page: url.query.dashboard + ".$dashboard",
			parameters: url.query.parameters
		};
	} else {
		throw new Error("getLink - not implemented\n" + sDataUrl);
	}
};
/**
 * Returns attributes for link tag
 * 	linkInfo: 	object returned by _getLinkInfo
 * 				or sdataUrl
 * dao:			mandatory if linkInfo is a sdataUrl
 */
var _getLinkAttrs = function(linkInfo, dao) {
	if (typeof linkInfo === "string") {
		// We assume that linkInfo is the url - we need dao
		linkInfo = _getLinkInfo(linkInfo, dao);
	}
	if (linkInfo.type === "navig") {
		return 'data-nav="' + linkInfo.page + '" data-sdata-url="' + encodeURIComponent(linkInfo.sDataUrl) + '"';
	} else if (linkInfo.type === "act") {
		return 'data-action="' + linkInfo.action + '" data-params="' + encodeURIComponent((linkInfo.params || "")) + '"';
	} else {
		throw new Error("_getLinkAttrs - unknonwn type\n" + linkInfo.type);
	}
};
/**
 * SCan diagnoses in a sdata response
 * TODO TEST
 */
var _scanDiagnoses = function(data) {
	var result = [];
	var done = [];
	var _scan = function(o, prop, path) {
		if (!path) path = [];
		if (!data) return null;
		if (done.indexOf(o) >= 0) return;
		if (Array.isArray(o)) {
			done.push(o);
			if (prop) path.push(prop);
			o.forEach(function(e, idx) {
				_scan(e, idx + "", path);
			});
			if (prop) path.pop(prop);
		} else if ($.isPlainObject(o)) {
			done.push(o);
			for (var p in o) {
				if (p === "$diagnoses") {
					o[p].forEach(function(d) {
						var $path = [].concat(path);
						if (prop) $path.push(prop);
						if (p) $path.push(p);
						d = $.extend({}, d);
						d.$path = $path.join('.');
						result.push(d);
					});
				} else {
					if (prop) path.push(prop);
					_scan(o[p], p, path);
					if (prop) path.pop(prop);
				}
			}
		}
	};
	if (!data) return null;
	_scan(data);
	return result;

};
exports.parseSDataURL = _parseSDataURL;
exports.getLinkInfo = _getLinkInfo;
exports.getLinkAttrs = _getLinkAttrs;
exports.scanDiagnoses = _scanDiagnoses;
});

define('syracuse-tablet/html/js/sdata/sdataHttp',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/ajax/ajax','syracuse-tablet/html/js/helpers/globals'],function (require, exports, module) {
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("sDataHttp");
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;
var globals = require('syracuse-tablet/html/js/helpers/globals');

// We force no parsing
var _forceOptions = {
	noJsonParsing: true
};
/* 
 * params : {method, url, send, headers, options, login}
 * optional : send, headers, options, login = {user,password}
 * Return a promise
 * Resolve with result {status, isSuccess, responseText, jsonData, textStatus, descrHttpStatus, headers}
 * Never rejects
 * status = 600 if Java Script exception
 */

var _send = function(params) {
	var deferred = $.Deferred();
	var params = params || {};

	params.options = $.extend(params.options || {}, _forceOptions);
	if (params.login) {
		// Temporarily - allows to launch tests with a login
		params.headers = $.extend(params.headers || {}, {
			Authorization: 'Basic ' + window.btoa("guest" + ":" + "guest")
		});
	};
	try {
		log && log("_httpSend - Begin - Method:" + params.method + "\n\t" + params.url);

		ajax(params.method, params.url, params.send, params.headers, params.options)
			.then(function(result) {
				log && log("_httpSend - End - status=" + result.status + " - " + result.textStatus);
				// Try to parse data even if fail status - we can have a $diagnose in response
				var responseText = result.responseText ? result.responseText.trim() : "";
				if (responseText.length > 0 && ['{', '['].indexOf(responseText.charAt(0)) >= 0) {
					result.responseJSON = JSON.parse(responseText);
				} else {
					result.responseJSON = null;
				}
				return result;
			})
			.then(function(result) {
				deferred.resolve(result);
			}, function(e) {
				deferred.reject(e);
			});
	} catch (e) {
		deferred.reject(e);
	}
	return deferred.promise();
};

exports.fetchRemotePrototype = function(id) {
	var deferred = $.Deferred();
	var self = this;
	try {
		var base = globals.baseLocation();
		var segs = id.split(".");
		var ep = segs.slice(0, 3).join("/");
		var repr = segs.slice(3, 5).join(".");
		var url = base.host + "/mobile1/" + ep + "/$prototypes('" + repr + "')";
		ajax("GET", url)
			.then(function(data) {
				if (data.isSuccess) {
					deferred.resolve(data.responseJSON);
				} else {
					var err = "Http error status[" + data.status + "] reading prototype id [" + id + "]";
					if (data.responseJSON && data.responseJSON.length > 0) err += "\n" + JSON.stringify(data.responseJSON, null, 2);
					deferred.reject(new Error(err));
				}
			}, function(e) {
				deferred.reject(e);
			});
	} catch (e) {
		deferred.reject(e);
	} finally {
		return deferred.promise();
	}
},

exports.send = _send;
});

define('syracuse-tablet/html/js/sdata/sdataCommonResources',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/sdata/sdataUtils','syracuse-tablet/html/js/sdata/sdataHttp','syracuse-tablet/html/js/ajax/ajax'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

/*
 * This file should be the only file containing direct, non generic access to server side supporting entities/services
 */
var _appListUrl = "/sdata/syracuse/collaboration/syracuse/mobileApplications/$service/availableApplications";
var _localePreferencesUrl = "/requireJS/tabletLocalePreferences";
var _userProfileUrl = "/sdata/syracuse/collaboration/syracuse/userProfiles/$service/current";
var _endpointListUrl = "/sdata/syracuse/collaboration/syracuse/endPoints?representation=endPoint.$query";
var _roleListUrl = "/sdata/syracuse/collaboration/syracuse/roles?representation=role.$query";

var _getSdataError = function(title, result, url) {

	var err = title;
	err += "\nStatus: " + result.status + " - " + result.descrHttpStatus;
	if (url) err += "\n" + url;
	var diags = sdataUtils.scanDiagnoses(result.responseJSON);
	if (diags) err += "\nDIAGNOSES\n" + JSON.stringify(diags, null, 2);
	return err;
};

exports.queryMyApplications = function() {
	var deferred = $.Deferred();
	var params = {
		method: "GET",
		url: _appListUrl
	};
	if (globals.isDvlpMode()) {
		if (params.url.indexOf("?") > -1) {
			params.url += "&";
		} else {
			params.url += "?";
		}
		params.url += "allApps";
	}
	params.parsedUrl = sdataUtils.parseSDataURL(params.url);
	sdataHttp.send(params)
		.then(function(result) {
			if (result.isSuccess && result.responseJSON) {
				var apps = result.responseJSON.$resources;
				deferred.resolve(apps);
			} else {
				var err = _getSdataError("Loading application list error", result, params.url);
				deferred.reject(new Error(err));
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

exports.queryMyApplicationDetail = function(appHeader) {
	var deferred = $.Deferred();
	var params = {
		method: "GET",
		url: appHeader.$metaDataUrl
	};
	params.parsedUrl = sdataUtils.parseSDataURL(params.url);
	sdataHttp.send(params)
		.then(function(result) {
			if (result.isSuccess && result.responseJSON) {
				var app = result.responseJSON;
				deferred.resolve(app);
			} else {
				var err = _getSdataError("Error oading application detail - Name: " + appHeader.applicationName, result, params.url);
				deferred.reject(new Error(err));
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

exports.queryLocalePreferences = function() {
	var deferred = $.Deferred();

	ajax("GET", _localePreferencesUrl)
		.then(function(result) {
			if (result.isSuccess) {
				var locales = [];
				(result.responseJSON.$resources || []).forEach(function(locale) {
					locales.push({
						"$uuid": locale.$uuid,
						"code": locale.code,
						"description": locale.description
					});
				});
				deferred.resolve(locales);
			} else {
				deferred.resolve([]);
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

exports.getUserProfile = function() {
	var deferred = $.Deferred();
	var params = {
		method: "GET",
		url: _userProfileUrl
	};
	params.parsedUrl = sdataUtils.parseSDataURL(params.url);
	sdataHttp.send(params)
		.then(function(result) {
			if (result.isSuccess && result.responseJSON) {
				var profile = result.responseJSON;
				deferred.resolve(profile);
			} else {
				var err = _getSdataError("Loading user profile error", result, params.url);
				deferred.reject(new Error(err));
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

exports.queryEndpoints = function() {
	var deferred = $.Deferred();
	var params = {
		method: "GET",
		url: _endpointListUrl
	};
	params.parsedUrl = sdataUtils.parseSDataURL(params.url);
	sdataHttp.send(params)
		.then(function(result) {
			if (result.isSuccess && result.responseJSON) {
				var eps = result.responseJSON.$resources;
				deferred.resolve(eps);
			} else {
				var err = _getSdataError("Loading endpoint list error", result, params.url);
				deferred.reject(new Error(err));
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

exports.queryRoles = function() {
	var deferred = $.Deferred();
	var params = {
		method: "GET",
		url: _roleListUrl
	};
	params.parsedUrl = sdataUtils.parseSDataURL(params.url);
	sdataHttp.send(params)
		.then(function(result) {
			if (result.isSuccess && result.responseJSON) {
				var eps = result.responseJSON.$resources;
				deferred.resolve(eps);
			} else {
				var err = _getSdataError("Loading roles list error", result, params.url);
				deferred.reject(new Error(err));
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();

};
});

define('syracuse-tablet/html/js/storage/localStorage',['require','exports','module','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

/**
 * Local storage
 * Uses only window local storage
 */

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("sessstorage");

var _available = null;

var _isAvailable = function() {
	if (_available !== null) {
		return _available;
	}
	_available = false;
	try {
		window.localStorage.setItem("__test_availability__", "__test_availability__");
		_available = true;
	} catch (e) {}
	return _available;
};

var _getItem = function(key, removeAfter) {
	if (!_isAvailable()) {
		log && log("local.unsupported.getItem(" + key + "):" + val);
		return;
	}
	var val = window.localStorage.getItem(key);
	log && log("local.getItem(" + key + "):" + val);
	if (true === removeAfter) {
		_removeItem(key);
	}
	return val;
};

var _setItem = function(key, value) {
	if (!_isAvailable()) {
		console.log("local.unsupported.setItem(" + key + "):" + value);
		return;
	}
	log && log("local.setItem(" + key + "):" + value);
	return window.localStorage.setItem(key, value);
};

var _removeItem = function(key) {
	if (!_isAvailable()) {
		log && log("local.unspported.removeItem(" + key + ")");
		return;
	}
	log && log("local.removeItem(" + key + ")");
	return window.localStorage.removeItem(key);
};

exports.removeItem = _removeItem;
exports.setItem = _setItem;
exports.getItem = _getItem;
});

define('syracuse-tablet/html/js/init/initContext',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/locale','syracuse-tablet/html/js/pages/html/modalSelectContext','syracuse-tablet/html/js/helpers/notifications','syracuse-tablet/html/js/sdata/sdataCommonResources','syracuse-tablet/html/js/storage/localStorage'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var locale = require('syracuse-tablet/html/js/helpers/locale');

var modalSelectContext = require('syracuse-tablet/html/js/pages/html/modalSelectContext');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var sdataCommonResources = require('syracuse-tablet/html/js/sdata/sdataCommonResources');
var localStorage = require('syracuse-tablet/html/js/storage/localStorage');

exports.getLastUsedContext = function(userName) {
	var context;
	try {
		var settingsKey = userName + "_lastContext";
		var contextString = localStorage.getItem(settingsKey);
		if (contextString && contextString.length > 0) {
			context = JSON.parse(contextString);
		}
	} catch (e) {}
	return context;
};

exports.setLastUsedContext = function(userName, context) {
	try {
		var settingsKey = userName + "_lastContext";
		var contextString = JSON.stringify(context);
		localStorage.setItem(settingsKey, contextString);
	} catch (e) {}
};

exports.init = function(force, warn) {
	var endpoints;
	var roles = [];
	var languages = [];

	var userCtx = globals.getUserCtx();
	var userName = userCtx && userCtx.$user;

	var currentContext = exports.getLastUsedContext(userName);

	return sdataCommonResources.queryEndpoints()
		.then(function(eps) {
			endpoints = eps;
			return sdataCommonResources.queryLocalePreferences();
		})
		.then(function(ls) {
			languages = ls;
			return sdataCommonResources.queryRoles();
		})
		.then(function(rs) {
			roles = rs;
		})
		.then(function() {
			var deferred = $.Deferred();
			var _dialog = function(ctx) {
				var selectNewContext;
				if (force || ctx == null) {
					selectNewContext = modalSelectContext.selectContext(ctx, endpoints, roles, languages, warn);
				} else {
					selectNewContext = $.smResolve(ctx);
				}

				selectNewContext.then(function(context) {
					var valid;
					// context = null = dialog canceled, this is only valid if there is a default context from the last application use
					valid = !(currentContext == null && context == null) || context != null;
					return {
						isValid: valid,
						context: context
					};
				}).
				then(function(context) {
					if (context.isValid) {
						deferred.resolve(context.context);
					} else {
						force = true;
						_dialog(context.context);
					}
				});
			};

			_dialog(currentContext);

			return deferred.promise();
		})
		.then(function(context) {
			if (context) {
				// Locale for client UI
				locale.setLocale(context.language);

				// Endpoint for storing records locally and to use for gadgets with default endpoint usage
				globals.setEndpoint(context.endpoint);

				// Context for storing records locally
				globals.setUserCtx({
					$user: userCtx.$user,
					$role: context.role,
					$lang: context.language,
				});
			}
			return context;
		})
		.then(function(context) {
			if (context) {
				exports.setLastUsedContext(userName, context);
				notifications.publish("sm.context.changed", context);
			}
			return context;
		});
};
});

define('syracuse-tablet/html/js/application/application',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/application/breadcrumb','syracuse-tablet/html/js/helpers/notifications','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/application/authentication','syracuse-tablet/html/js/application/eventListener','syracuse-tablet/html/js/application/pageLoader','syracuse-tablet/html/js/pages/html/pageTemplates','syracuse-tablet/html/js/init/initContext'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var modal = require('syracuse-tablet/html/js/ui/modal');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("app");
var BreadCrumb = require('syracuse-tablet/html/js/application/breadcrumb').BreadCrumb;
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var auth = require('syracuse-tablet/html/js/application/authentication');
var eventListener = require('syracuse-tablet/html/js/application/eventListener');
var pageLoader = require('syracuse-tablet/html/js/application/pageLoader');
var pageTemplates = require('syracuse-tablet/html/js/pages/html/pageTemplates');
var initContext = require('syracuse-tablet/html/js/init/initContext');

var _subscribe = function(self) {
	notifications.subscribe(self, ["sm.context.changed", "sm.logout", "sm.switch.app", "sm.modal.open", "sm.modal.close"], 1);
};
var _Application = utils.defineClass(
	function($$elmt, factory) {
		var self = this;
		self.breadCrumb = new BreadCrumb();
		self.$$elmt = $$elmt;
		self.currentPage = null;
		self.uuid = null;
		self.homePageId = "defhome";
		self._$config = {
			transition: null,
			openLinkInVignette: false
		};
		self.factory = factory;
		self._pageLoader = null;
		self._nbModals = 0;
	}, null, {
		/**
		 * Called after object has been created
		 **/
		init: function() {
			var self = this;
			// Can't be called in constructor
			eventListener.bindEvents(self);
			self.dao = self.factory.createDaoApp(self);
			_subscribe(self);
			self.$$elmt.show();
		},

		destroy: function() {
			var self = this;
			if (self.breadCrumb) self.breadCrumb.destroy();
			self.breadCrumb = null;
			notifications.unsubscribe();
			self.removeAllPages();
			self.currentPage = null;
			if (self._pageLoader = null) {
				self._pageLoader.destroy();
				self._pageLoader = null;
			}
			utils.unbindObj(self);
			utils.unbindObj(self.$$elmt);
			$(window).unbind();
		},

		getTitle: function() {
			return this.dao.getApplicationName();
		},

		/**
		 * User logged in
		 */
		_activate: function() {
			var self = this;
			log && log("Activate application");
			if (self.dao.isApplicationLoaded()) {
				log && log("Application loaded -> Goto appication home");
				self.gotoHome();
			} else {
				self.homePageId = "defhome";
				self.uuid = null;
				log && log("No application loaded -> Goto default home");
				/* redirect to home page */
				self.gotoHome();
			}
		},

		gotoHome: function() {
			var self = this;
			setTimeout(function() {
				self.changePage(self.homePageId || "defhome");
			});
		},

		$config: function(id) {
			return this._$config[id];
		},
		/**
		 * User has selected a new Syracuse mobile application
		 * appInfo json description of application
		 */
		notifSwitchApp: function(appInfo) {
			var self = this;
			/* Todo - check if application changed with id and timestamp */
			if (!appInfo) throw new Error("NULL appInfo");
			log && log("Switch to Syracuse Mobile Application " + appInfo.$application.applicationName);
			self.dao.setApplicationDesc(appInfo);
			self.homePageId = self.dao.getHomeDashboard() || "defhome";
			self.uuid = appInfo.$uuid;
			self.removeAllPages();
			self.gotoHome();
		},
		/**
		 * User, role, endpoint or language changed
		 */
		notifContextChanged: function(context) {
			var self = this;
			self._activate();
		},

		notifLogout: function() {
			log && log("Application Notification Logout");
			globals.setUserCtx(null);
		},

		notifModalOpen: function() {
			this._nbModals++;
			// console.log("notifModalOpen nbModals=" + this._nbModals)	
		},

		notifModalClose: function() {
			this._nbModals = Math.max(this._nbModals - 1, 0);
			// console.log("notifModalClose nbModals=" + this._nbModals)
		},

		hasModalOpen: function() {
			//  console.log("_nbModals=" + this._nbModals)
			return this._nbModals > 0;
		},

		_actBreadCrumb: function() {
			this.breadCrumb.display();
		},

		_actReload: function() {
			window.location.reload();
		},

		_actBack: function() {
			window.history.back();
		},
		// Switch role, endpoint, language
		_actSwitchContext: function() {
			var self = this;
			initContext.init(true, true).then(function(context) {}, function(e) {
				pageTemplates.resolveError(null, self.state.name, e);
			});
		},
		_actLogout: function() {
			var deferred = $.Deferred();
			var self = this;
			modal.confirm("logout", function(confirmed) {
				if (confirmed) {
					self.waitWheelStart();
					auth.logout().then(function(ok, message) {
						if (ok) {
							notifications.publish("sm.logout");
							deferred.resolve({
								page: "login"
							});
							self.waitWheelStop();
						} else {
							self.waitWheelStop();
							modal.error(message, function() {
								deferred.resolve(null);
							});
						}
					}, function(e) {
						self.waitWheelStop();
						modal.error("Logout error", e, function() {
							deferred.resolve(null);
						});
					});
				} else {
					deferred.resolve(null);
				}
			});
			return deferred.promise();
		},

		_actClearCache: function() {
			var self = this;
			var deferred = $.Deferred();
			modal.confirm("clearCache", function(confirmed) {
				if (confirmed) {
					self.waitWheelStart();
					globals.getCache().clearCache().always(function() {
						self.waitWheelStop();
						deferred.resolve(null);
					});
				} else {
					deferred.resolve(null);
				}
			});
			return deferred.promise();
		},

		back: function(state) {
			var self = this;
			log && log("back", "start", "\n" + JSON.stringify(state, null, 2));
			if (!state) throw new Error("Back", "Unexpected null history state");
			return self._gotoPage(pageLoader.stateDeserialize(state), true);
		},

		_gotoPage: function(state, back) {
			var self = this;
			if (!self._pageLoader) {
				/**
				 * Page loader shared with vignette
				 * Load a page
				 */
				self._pageLoader = new pageLoader.Klass({
					waitStop: function() {
						self.waitWheelStop();
					},
					getRootElmt: function() {
						return self.$$elmt;
					},
					waitStart: function() {
						self.waitWheelStart();
					},
					getCurrentPage: function() {
						return self.currentPage;
					},
					setCurrentPage: function(page) {
						self.currentPage = page;
						if (page.state.home) {
							// Destroy all cached pages except current home page
							self.removeAllPages(page);
						}
					},
					setHistory: function(state) {
						// Store page in browser history to enable back - accepts only json objects
						state = pageLoader.stateSerialize(state);
						window.history.pushState(state, state.uuid, null);
						log && log("pushState", state.uuid, "history.length=" + window.history.length);
					}
				});
			}
			return self._pageLoader.load(state, back);
		},
		/**
		 * arguments : Pages to exclude
		 **/
		removeAllPages: function() {
			var self = this;
			var exclude = arguments;
			if (!self.$$elmt) return;
			self.$$elmt.find(".page").each(function(idx) {
				var page = $(this).smPageController();
				if (page && Array.prototype.indexOf.call(exclude, page) == -1) {
					page.destroy();
				}
			});
		},
		/** state - name of the page or history state object
		 * Option noverride standard pageInfo and allows to store a context
		 **/
		changePage: function(state, options) {
			var self = this;
			if (typeof state === "string") {
				log && log("changePage", state);
			}
			return self._gotoPage(self.getPageInfo(state, options));
		},

		/**
		 * Refresh current page - called from eventListener
		 */
		refreshPage: function(options) {
			var self = this;
			if (!self.currentPage) throw new Error("No current page");
			self.currentPage.refresh(options).then(function() {
				//	Eventually do something in vignette control	
			}, function(e) {
				modal.error("Refresh page", e);
			});;
		},

		getPageInfo: function(state, options) {
			return this.dao.getPageInfo(state, options);
		},

		// fullName: x3.erp.SUPERV.AQMCRUD.$details
		getPrototype: function(fullName) {
			var self = this;
			return self.dao.getPrototype(fullName);
		},

		/**
		 * One waiting plugin per page
		 */
		waitWheelStart: function() {
			if (!this.currentPage) return;
			this.currentPage.waitWheelStart();
		},
		waitWheelStop: function() {
			if (!this.currentPage) return;
			this.currentPage.waitWheelStop();
		}

	});


exports.Application = _Application;
});

define('syracuse-tablet/html/js/controls/ctrlFactory',['require','exports','module','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("factory");

var _ctor = {};

var _types = {
	// official types
	string: "application/x-string",
	password: "application/x-password",
	text: "text/plain",
	integer: "application/x-integer",
	real: "application/x-real",
	decimal: "application/x-decimal",
	quantity: "application/x-quantity",
	choice: "application/x-choice",
	boolean: "application/x-boolean",
	date: "application/x-date",
	time: "application/x-time",
	datetime: "application/x-datetime",
	reference: "application/x-reference",
	array: "application/x-array",
	// our own types
	vignette: "application/x-vignette",
	layout: "application/x-layout",
	pageheader: "application/x-pageheader"
};
/**
 * Create a control and insert DOM element in a grid cell
 * 	TODO - Use an HTML builder instead of a control
 */
var _appendField2Cell = function($$parentCell, controller, ctrlArticle, ctrlProto, ctrlData, options) {
	if (!$$parentCell) return;
	options = options || {};
	options.isGridCell = true;
	if (!$$parentCell.jquery) $$parentCell = $($$parentCell);
	var ctrl = _createControl(controller, null, ctrlArticle, ctrlProto, options);
	ctrl.buildHtml($$parentCell, ctrlData, options);
	// Destroy the control without removing dom element
	ctrl.detachElmt();
};
/**
 * Create a control
 * 	Add control to controller
 * 	Append control as a child of parentStructElmt
 */
var _createControl = function(controller, parentStructElmt, article, prototype, options) {
	if (!controller) throw new Error("Control - null parent or controller");
	var c;
	var type = prototype.data("$type");
	switch (type) {
		case _types.string:
		case _types.password:
		case _types.text:
			switch (prototype.data("$format")) {
				case "$phone":
					c = new _ctor.PhoneField(controller, article, prototype);
					break;
				case "$email":
					c = new _ctor.EmailField(controller, article, prototype);
					break;
				default:
					c = new _ctor.Alphanum(controller, article, prototype);
			}
			break;
		case _types.integer:
		case _types.real:
		case _types.decimal:
			c = new _ctor.Numeric(controller, article, prototype);
			break;
		case _types.quantity:
			c = new _ctor.Quantity(controller, article, prototype);
			break;
		case _types.choice:
			c = new _ctor.Combo(controller, article, prototype);
			break;
		case _types.boolean:
			c = new _ctor.CheckBox(controller, article, prototype);
			break;
		case _types.date:
		case _types.time:
		case _types.datetime:
			c = new _ctor.Date(controller, article, prototype);
			break;
		case _types.reference:
			c = new _ctor.Reference(controller, article, prototype);
			break;
		case _types.array:
			if (prototype.data("$cube")) {
				c = new _ctor.CubeChart(controller, article, prototype);
			} else if (prototype.isQuery()) {
				c = new _ctor.ArrayQuery(controller, article, prototype);
			} else if (prototype.isLookup()) {
				c = new _ctor.ArrayQLookup(controller, article, prototype);
			} else {
				// Child array
				c = new _ctor.Array(controller, article, prototype);
			}
			break;
		case _types.vignette:
			c = new _ctor.Vignette(controller, article, prototype);
			break;
		default:
			c = new _ctor.TypeUnknown(controller, article, prototype);
			break;
	}
	if (options && options.isGridCell === true) {
		// Nothing - Control is used only to build html - TODO use html Builders instead of control
	} else {
		if (parentStructElmt) {
			// Add control elmt in a tree
			parentStructElmt.appendStructElmt(c);
			// Add control to controller
			controller.addControl(c);
		} else {
			throw new Error("Parent's control is mandatory");
		}
	}
	return c;
};
var _createLayout = function(controller, parentStructElmt, article) {
	var type = article.$layoutType || "stack";
	var klass;
	if (type == "stack") {
		klass = _ctor.LayoutStack;
	} else if (type == "row") {
		klass = _ctor.LayoutRow;
	} else if (type == "tab") {
		klass = _ctor.LayoutTab;
	} else if (type == "hub") {
		klass = _ctor.LayoutHub;
	} else if (type == "hubGroup") {
		klass = _ctor.LayoutHubGroup;
	} else {
		log && log("layout type=" + type + " is not implemented");
		return null;
	}
	var l = new klass(controller, _types.layout, article);
	if (parentStructElmt) {
		parentStructElmt.appendStructElmt(l);
	} else {
		// Root layout
		l.parent = controller;
	}
	return l;
};

var _createPageHeader = function(controller) {
	var c = new _ctor.PageHeader(controller, _types.pageheader);
	controller.addControl(c);
	return c;
};

exports.createControl = _createControl;
exports.createLayout = _createLayout;
exports.createPageHeader = _createPageHeader;
exports.appendField2Cell = _appendField2Cell;

exports.type = function(name) {
	return _types[name];
};
exports.setImpl = function(name, ctor) {
	_ctor[name] = ctor;
};
});

define('syracuse-tablet/html/js/helpers/articleParser',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/ctrlFactory'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("articleParser");
var utils = require('syracuse-tablet/html/js/helpers/utils');
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');

/**
 * Parses an article and generate the control tree structure
 */
var _Parser = utils.defineClass(
	function(page) {
		// Controller
		var self = this;
		self.page = page;
	}, null, {
		doParse: function($article, prototype, parent) {
			var self = this;
			if ($article.$layoutType) {
				var lyt = ctrlFactory.createLayout(self.page, parent, $.extend({}, $article));
				if (lyt && $article.$items) {
					$article.$items.forEach(function($itm) {
						self.doParse($itm, prototype, lyt);
					});
				}
				return lyt;
			} else if ($article.$bind) {
				var fieldProto = prototype.getPrototype($article.$bind);
				if (!fieldProto) throw new Error("Property not found in prototype - id[" + $article.$bind + "]");
				if (!fieldProto.$isExcluded) {
					return ctrlFactory.createControl(self.page, parent, $.extend({}, $article), fieldProto);
				}
			} else {
				log && log("$layoutType or $bind expected");
				//throw new Error ("$layoutType or $bind expected");
			}
		},
		parse: function($article, prototype) {
			var self = this;
			try {
				if (!$article || !prototype) throw new Error("Not empty $article and prototype are expected");
				if (!$article.$layoutType) throw new Error("$layoutType expected for root layout");
				return self.doParse($article, prototype);
			} catch (e) {
				log && log('$article parser error', e);
				throw new Error("Error parsing $article [" + e.message + "]\n" + utils.cleanStack(e.stack));
			}
		}
	}
);

/**
 * Parses $article and calls the controls factory
 * 		$article: json description
 *  	prototype: prototype object (Prototype class)
 *  Return root element (layout)
 */
var _article2Controls = function(page, $article, prototype) {
	var p = new _Parser(page);
	return p.parse($article, prototype);
};

/**
 * Convert a desktop $article to tablet one
 * 		$article:  desktop json description
 *  	prototype: prototype object (Prototype class)
 */
var _defOption = {
	skipblock: true,
	skipsection: true,
	include: ["$category", "$layoutType", "$title", "$bind"],
	exclude: ["$items", "$widths"],
	protoExclude: ["application/x-array", "application/json"]
};

var _convertWidth = function(widths) {
	var r = [];
	widths = widths.split(",");
	// temporarily - We can also embed cells into 
	if (widths.length === 0) throw new Error("Number of cells/rows must be > 0");
	if (widths.length > 12) throw new Error("Number of cells/rows must be <= 12");
	var sum = 0;
	widths.forEach(function(w) {
		w = parseInt(w, 10);
		w = Math.ceil(w / 12);
		sum += w;
		r.push(w);
	});
	if (sum > 12) {
		var d = sum - 12;
		r.sort();
		while (d > 0) {
			// Remove excess starting from large cells
			for (var i = r.length - 1; i >= 0; i--) {
				if (d > 0 && r[i] > 1) {
					r[i] = r[i] - 1;
					d--;
				}
			}
		}
	} else if (sum < 12) {
		var d = 12 - sum;
		r.sort();
		while (d > 0) {
			// Add shortage starting from small cells
			for (var i = 0; i < r.length; i++) {
				if (d > 0) {
					r[i] = r[i] + 1;
					d--;
				}
			}
		}
	}
	return r.join(",");
};
var _scanDesktop = function(json, options) {

	if (!json) return null;
	// we skip $layout
	var res;
	if (json.$layout) {
		res = _scanDesktop(json.$layout, options);
	} else {
		res = {};
	}
	if (json.$layoutType) {
		if (!json.$items) throw new Error("$items is missing");
		res.$items = [];
		json.$items.forEach(function(itm) {
			res.$items.push(_scanDesktop(itm, options));
		});
	}
	for (var p in json) {
		if (p === "$widths") {
			res[p] = _convertWidth(json[p]);
		} else if (options.exclude.indexOf(p) === -1 && options.include.indexOf(p) >= 0) {
			res[p] = json[p];
		}
	}
	return res;
};

var _convertDesktop = function($article, prototype, options) {
	options = $.extend({}, _defOption, options);
	return _scanDesktop($article, options);
};

exports.article2Controls = _article2Controls;
exports.convertDesktop = _convertDesktop;
});

define('syracuse-tablet/html/js/pages/page',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/articleParser','syracuse-tablet/html/js/controls/ctrlFactory'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("page");
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var articleParser = require('syracuse-tablet/html/js/helpers/articleParser');
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');

var _templates = {
	fullpage: '\
		<section class="s-m-page s-m-full" id="{{pageid}}" data-appid="{{appid}}" style=""> \
			<header></header> \
			<section></section> \
			<footer></footer> \
		</section> \
	',
	// data-pageid used to retrieve 
	vignette: '<section class= "s-m-page s-m-nested" data-pageid="{{pageid}}"></section>'
};

var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};
// These link enable wait on control - TODO enable only if data not in cache for next, prev...
var _controlWheel = ["$more"]; //"$next", "$last", "$previous","$more","$first"];
/**
 * Base class for all pages
 *  $$parent: Parent element
 * 	state: Page information - JSON structure stored in history
 *  prototype: Prototype object (class prototype)
 *  article: JSON article
 *  !! Temporarily prototype and article can be null for html pages
 */
var _Page = utils.defineClass(
	function($$parent, state, prototype, article) {
		var self = this;
		// article, prototype, rootLayout null for html pages
		self.prototype = prototype;
		self.article = article;
		self.rootLayout = null;
		self.headerCtrl = null;
		self.vignette = state.options && state.options.vignette;
		// For breadCrumb
		self.historyLength = 0;
		self.historyTitle = state.id;
		self._$$parent = $$parent;
		self.state = state;
		self.id = state.uuid;
		self.controlsMap = {};
		self._nbControls = 0;
		self.dao = null;
		self._initRootElmt($$parent);
	}, null, {

		/**
		 * Create and return root DOM element of every page
		 */
		_initRootElmt: function($$parent) {
			var self = this;
			var root, ctx = {
					appid: self.state.appId,
					pageid: self.id
				};
			if (self.isVignette()) {
				self.$$contentElmt = self.$$elmt = $(_getHtml("vignette", ctx));
			} else {
				self.$$elmt = $(_getHtml("fullpage", ctx));
				self.$$headerElmt = self.$$elmt.children("header");
				self.$$footerElmt = self.$$elmt.children("footer");
				self.$$contentElmt = self.$$elmt.children("section");
			}
			self.$$elmt.hide();
			self.$$elmt.appendTo($$parent);
			self.$$elmt.smPageController(self);
		},

		destroy: function() {
			var self = this;
			if (self._waiting) {
				uiutils.waitWheelDestroy(self._waiting);
				self._waiting = null;
			}
			log && log("Page destroy", self.id);
			if (self.getProp["type"] === "appdashboard") {
				// appdashboard page -> Destroy all related pages
				self._destroyAppChilds();
			}
			if (self.headerCtrl) {
				self.headerCtrl.destroy();
				self.headerCtrl = null;
			}
			if (self.controlsMap) {
				for (var id in self.controlsMap) {
					self.controlsMap[id].destroy();
				}
				self.controlsMap = null;
			}
			self._nbControls = 0;
			if (self.dao) {
				self.dao.destroy();
				self.dao = null;
			}
			// At the end to destroy childs before parent
			if (self.$$elmt) {
				utils.unbindObj(self.$$elmt);
				self.$$elmt = null;
			}
			utils.unbindObj(self);
			self.article = null;
			self.prototype = null;
			self._$$parent = null;
		},

		/**
		 * TODO
		 */
		_destroyAppChilds: function() {
			var self = this;
			if (self.$$elmt) {
				// destroy all page that belongs to an application except this (dashboard)
				var childs = self._$$parent.find('.class[data-appId="' + self.getProp("appId") + '"]');
				if (childs.length > 0) {
					log && log("Page destroychilds", self.id);
					childs.each(function(idx) {
						var ctrl = $(this).smPageController();
						if (ctrl && ctrl != self) ctrl.destroy();
					});
				}
			}
		},
		/**
		 * TODO
		 */
		destroySiblings: function() {
			var self = this;
			if (self.$$elmt) {
				// destroy all siblings if any when direct access with the breadcrumb
				log && log("Page destroySiblings", "destroySiblings");
				var next = self.$$elmt.siblings(function(idx) {
					var ctrl = $(this).smPageController();
					if (ctrl) ctrl.destroy();
				});
			}
		},
		/**
		 * dashboard/regular/html
		 */
		getType: function() {
			return this.state.type;
		},

		getProp: function(prop) {
			return this.state[prop];
		},

		setDao: function(dao) {
			var self = this;
			if (self.dao && self.dao.destroy) self.dao.destroy();
			self.dao = dao;
		},

		getDao: function() {
			return this.dao;
		},

		/**
		 * Refresh the page
		 * 	options.sdata-url -> New url
		 * 	options.controlId!=null -> refresh the control
		 *  options.type Type of refresh (pagination...)
		 *  callBackInterface
		 *  	waitStop(ctrlId) / waitStart(ctrlId)
		 */
		refresh: function(options, callBackInterface) {
			var self = this;
			var deferred = $.Deferred();
			var url = options["sdata-url"];
			var controlId = options["controlId"];
			var _wait = function(status) {
				// I added the capability to enable the wait on the control
				// True if the type of refresh needs the display of wheel on control ($more)
				var ctrlWheel = controlId ? _controlWheel.indexOf(options.type) >= 0 : false;
				if (callBackInterface) {
					// Caller wheel - Ex: vignette
					var m = "wait" + status.smCapitalize();
					if (callBackInterface[m]) callBackInterface[m](ctrlWheel ? controlId : null);
					return;
				}
				// Page wheel or control wheel if ctrlId && pagination
				// TODO use the same name waitStart/waitStop for all objects
				self["waitWheel" + status.smCapitalize()].call(self, ctrlWheel ? controlId : null);
			};
			try {
				var _succeeded = function() {
					_wait("stop");
					self.refreshControls(controlId ? [controlId] : null, options);
					deferred.resolve();
				};
				if (!url) {
					_succeeded();
				} else {
					_wait("start");
					self.state.options["sdata-url"] = url;
					self.loadData()
						.then(function() {
							_succeeded();
						}, function(e) {
							_wait("stop");
							deferred.reject(e);
						});
				}
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		/**
		 * ids == null means all controls
		 */
		refreshControls: function(ids, options) {
			var self = this;
			var array;
			if (ids && ids.length > 0) {
				array = [];
				ids.forEach(function(id) {
					array.push(self.controlsMap[id]);
				});
			} else {
				array = self.controlsMap;
			}
			array.forEach(function(c) {
				c.refresh(self.dao, options);
			});
		},

		load: function() {
			var self = this;
			var deferred = $.Deferred();

			try {
				self.loadStructure()
					.then(function() {
						return self.loadData();
					})
					.then(function() {
						return self.render();
					})
					.then(function() {
						return self.afterRender();
					})
					.then(function() {
						deferred.resolve();
					}, function(e) {
						deferred.reject(e);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		loadStructure: function() {
			var deferred = $.Deferred();
			var self = this;
			try {
				if (!self.article || !self.prototype) throw new Error("loadStructure - NULL article or prototype");
				if (self.$$headerElmt) {
					self.headerCtrl = ctrlFactory.createPageHeader(self, self.article, self.prototype);
				}
				self.rootLayout = articleParser.article2Controls(self, self.article, self.prototype);

				deferred.resolve();
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		loadData: function() {
			var deferred = $.Deferred();
			var self = this;
			try {
				self.setDao(null);
				deferred.resolve();
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		/**
		 *
		 */
		render: function() {
			var self = this;

			try {
				if (!self.rootLayout) {
					throw new Error("buildHtml - NULL rootLayout");
				}

				if (self.headerCtrl) {
					self.headerCtrl.buildHtml(self.$$headerElmt, self.dao);
				}

				if (self.$$contentElmt) {
					self._beforeAddContent();
					self.rootLayout.buildHtml(self.$$contentElmt, self.dao, null);
				}
			} catch (e) {
				return $.smReject(e);
			}
			return $.smResolve();
		},

		isEditMode: function() {
			return false;
		},

		_beforeAddContent: function() {

		},

		addTitle: function(title, description) {
			var self = this;
			var html = "";
			if (title) html = '<header><h3>' + title + '</h3></header>';
			if (description) html += '<p>' + description + '<p>';
			if (html.length > 0) $(html).prependTo(self.$$contentElmt);
		},

		afterRender: function() {
			var self = this;
			if (self.isVignette() && self.getNbControls() === 1) {
				// Needed for charts dashboard to display chart in full vignette
				// Stacks with one control are full height in vignettes
				// Make cell 100% height
				self.rootLayout.$$elmt.height("100%");
			}
		},

		/**
		 *  called each tile a control/layout is created
		 **/
		addControl: function(c) {
			if (!c) return;
			this._nbControls++;
			this.controlsMap[c.id] = c;
		},
		/**
		 * return the control/layout
		 * 	id:  id attribute of dom element
		 * */
		getControl: function(id) {
			return this.controlsMap && this.controlsMap[id];
		},

		getNbControls: function(id) {
			return this._nbControls;
		},

		activate: function(currentPage, cb) {
			var self = this;
			log && log("Page activate", self.id);
			self.historyLength = window.history.length;
			self._show(currentPage, cb);
		},

		deactivate: function(currentPage, cb) {
			var self = this;
			log && log("Page deactivate", self.id);
			self._hide(currentPage, cb);
		},

		_show: function(currentPage, cb) {
			var self = this;
			var transition = self.getProp("transition");
			if (currentPage) {
				currentPage._hide(function() {
					self.$$elmt.show(transition || 0, function() {
						if (cb) cb();
					});
				});
				return;
			}
			self.$$elmt.show(transition == null ? 0 : transition, cb);
		},

		_hide: function(cb) {
			var self = this;
			if (!self.$$elmt) {
				if (cb) cb();
				// page has been destroyed
				return;
			}
			var transition = self.getProp("transition");
			self.$$elmt.hide(transition == null ? 0 : transition, cb);
		},

		isActive: function() {
			var self = this;
			return self.$$elmt && self.$$elmt.is(":visible");
		},
		isVignette: function() {
			var self = this;
			return self.vignette === true;
		},
		/**
		 * Returns attribute for the link that opens this page (used to open this page from a vignette to full page)
		 * Overriden by regular page to put s-data-url
		 */
		getOpenLinkAttrs: function() {
			return {
				"data-nav": this.state.name
			};
		},

		/***
		 * Test action
		 */
		_actTest: function(params) {
			var e = $('<h5 style="color:red">Action test succeeded</h5>').prependTo(this.$$elmt);
			window.setTimeout(function() {
				e.remove();
			}, 2000);
		},

		/**
		 * Wait wheel management
		 * We need one plugin per page
		 */
		waitWheelStart: function(controlId) {
			var self = this;
			if (controlId) {
				var c = self.controlsMap[controlId];
				if (c && c.waitStart) c.waitStart();
				return;
			}
			if (!self._waiting) {
				self._waiting = uiutils.waitWheelCreate(self.$$elmt);
			}
			uiutils.waitWheelStart(self._waiting);
		},
		waitWheelStop: function(controlId) {
			var self = this;
			if (controlId) {
				var c = self.controlsMap[controlId];
				if (c && c.waitStop) c.waitStop();
				return;
			}
			if (self._waiting) {
				uiutils.waitWheelStop(self._waiting);
			}
		}
	}
);

exports.Page = _Page;
});

define('syracuse-tablet/html/js/pages/pageDashboard',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/pages/page','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/page').Page;
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("page");

var _Page = utils.defineClass(

	function($parent, state, prototype, article) {
		var self = this;
		Base.call(self, $parent, state, prototype, article);
		self.vignettes = [];
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			self.vignettes = null;
		},

		loadData: function() {
			return null;
		},

		_beforeAddContent: function() {
			var self = this;
			self.addTitle(self.prototype.data("$title"), self.prototype.data("$description"));
		},

		addControl: function(c) {
			var self = this;
			Base.prototype.addControl.call(self, c);
			if (c && c.isVignette()) {
				self.vignettes.push(c);
			}
		},


		/**
		 * Scan vignettes to find control per id
		 * 	Allows to call ctrl actions in vignettes
		 * ctrlId is a unicid for all controls of all pages
		 */
		findVignetteControl: function(ctrlId) {
			var self = this;
			if (!self.vignettes) return null;
			var c, v;
			for (var i = 0; i < self.vignettes.length; i++) {
				v = self.vignettes[i];
				c = v.getPageControl(ctrlId);
				if (c) {
					return {
						control: c,
						vignette: v
					};
				}
			}
			return null;
		},

		afterRender: function() {
			var self = this;
			var deferred = $.Deferred();
			var rejectError = function(e) {
				log && log("Error loading vignettes", e);
				deferred.reject(e);
			};
			try { /* Standard process - bind actions - no deferred returned*/
				Base.prototype.afterRender.call(self); /* Load vignettes*/
				var promises = [];
				self.vignettes.forEach(function(v) {
					var options = {
						sdataParameters: self.state.options && self.state.options.sdataParameters || {}
					};

					//promises.push(v.load(null, options));
					v.load(null, options);
				});
				/*
				$.when(promises).then(function() {
					// all the vignettes have been loaded successfully
					log && log(self.vignettes.length + " vignettes have loaded successfully");
				//	deferred.resolve();
				});//, rejectError);*/
				deferred.resolve();
			} catch (e) {
				rejectError(e);
			} finally {
				return deferred.promise();
			}
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/sdata/entities/clientContract',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');

var _apps = {};
var _entities = {};

var _propertiesToCopy = [
	// ui related
	"$title",
	"$isExcluded",
	"$isHidden",
	"$isMandatory",
	"$isReadOnly",
	"$isDisabled",

	// for formats
	"$format",
	"$x3Format",

	// for quantity and ref fields
	"$unit",
	"$value",

	// constraints according to https://github.com/Sage-ERP-X3/platform/wiki/Resource-Prototypes
	"$minimum",
	"$maximum",
	"$exclusiveMinimum",
	"$exclusiveMaximum",
	"$minItems",
	"$maxItems",
	"$isNullable",
	"$isUnique",
	"$pattern",
	"$minLength",
	"$maxLength",
	"$precision",
	"$scale",
	"$enum"
];

exports.getApps = function() {
	var apps = [];
	Object.keys(_apps).forEach(function(key) {
		var app = _apps[key];
		apps.push(app.$application);
	});
	return apps;
};

exports.getAppDetail = function(applicationName) {
	return _apps[applicationName];
};

exports.registerApp = function(app) {
	_apps[app.$application.applicationName] = app;
};

exports.registerEntity = function(entity) {
	_entities[entity.$entityName] = entity;
};

exports.getEntity = function(entity) {
	return _entities[entity];
};


exports.getPageInfo = function(name, options) {
	var repr = name.split(".");
	if (repr.length === 5) {
		repr = repr.slice(3, 5);
	}

	if (repr[0].smStartsWith("QUERY~")) {
		var p = repr[0].split("~");
		repr[0] = p[1];
	}

	var ent = _entities[repr[0]];
	if (!ent) {
		return null;
	}

	var state = {
		home: false,
		type: "regular",
		cached: false,
		refreshed: false,
		appId: "root",
		changeHash: false
	};
	if (options) {
		state.options = options ? $.extend(true, {}, options) : {};
		// Regular page needs gadget context - Ex create action..
		var gadgetId = options["gadget-id"];
		if (gadgetId) {
			state.options.gadget = globals.getApplication().dao.getGadget(gadgetId);
		}
	}
	state.name = name;
	if (!state.transition) {
		// Default transition
		state.transition = globals.getApplication().$config("transition");
	}
	// Readable id
	state.uuid = utils.readableuid("page", state.appId || "root", state.type, state.name);

	return state;

};

exports.getRegularPageInfo = function(pageId) {
	var repr = pageId.split(".");
	if (repr.length === 5) {
		repr = repr.slice(3, 5);
	}

	if (repr[0].smStartsWith("QUERY~")) {
		var p = repr[0].split("~");
		repr[0] = p[1];
	}

	var ent = _entities[repr[0]];
	var pageInfo;
	if (ent) {
		pageInfo = _buildPageInfo(repr[0], repr[1], ent);
	}
	return $.smResolve(pageInfo);
};

exports.getDashboardInfo = function(id) {

};


function _buildPageInfo(repr, facet, entity) {
	var page = {
		$page: {},
		$cache: {}
	};
	_buildPage(repr, facet, entity, page.$page);
	return page;
}

function _buildPage(repr, facet, entity, page) {
	if (facet === "$query" || facet === "$lookup") {
		page.$prototype = {
			$properties: {
				$resources: {
					$type: "application/x-array",
					$item: _buildPrototype(repr, facet)
				}
			}
		};
		page.$prototype.$url = "{$baseUrl}/" + repr + "?representation=" + repr + "." + facet;
		page.$prototype.$properties.$resources.$item.$key = "{$uuid}";
		page.$prototype.$properties.$resources.$item.$value = entity.$value;
		page.$prototype.$properties.$resources.$item.$links = {
			$details: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$details",
				$title: "Details"
			},
			$edit: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$edit",
				$title: "Edit"
			}
		};
		page.$prototype.$links = {
			$create: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$create",
				$title: "Create New"
			}
		};
		page.$prototype.$key = "{$uuid}";
	} else {

		page.$prototype = _buildPrototype(repr, facet);
		page.$prototype.$url = "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + "." + facet;
		page.$prototype.$key = "{$uuid}";
		page.$prototype.$links = {};

		// links to set in a json variable
		var links = {
			$edit: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$edit",
				$title: "Edit"
			},
			$query: {
				$url: "{$baseUrl}/" + repr + "?representation=" + repr + ".$query",
				$title: "List"
			},
			$save: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$save",
				$title: "Save"
			},
			$details: {
				$url: "{$baseUrl}/" + repr + "('{$key}')?representation=" + repr + ".$details",
				$title: "Detail"
			}
		};

		// add links according to facet (remainting facets are '$details', '$edit', '$create')
		switch (facet) {
			case "$create":
				page.$prototype.$links["$save"] = links["$save"];
				page.$prototype.$links["$query"] = links["$query"];
				break;
			case "$details":
				page.$prototype.$links["$edit"] = links["$edit"];
				page.$prototype.$links["$query"] = links["$query"];
				break;
			case "$edit":
				page.$prototype.$links["$save"] = links["$save"];
				page.$prototype.$links["$details"] = links["$details"];
				page.$prototype.$links["$query"] = links["$query"];
				break;
			default:
				throw new Error(facet ? "facet " + facet + " not handled yet" : "No facet specified");
		}
	}
	var $article = entity.$articles && entity.$articles[facet];
	if ($article) {
		page.$article = $article;
	}
	// not used at all but needs to be set since it's syntactically checked later
	page.$prototype.$baseUrl = "http://localhost:8124/mobile1/x3/erp/local";

	if (entity.$prototype) {
		entity.$prototype(page.$prototype, repr, facet);
	}
}

function _buildPrototype(repr, facet) {
	var entity = _entities[repr];
	var proto = {
		$properties: {}
	};
	Object.keys(entity.$properties).forEach(function(key) {
		var prop = entity.$properties[key];
		var $type = prop.$type || "application/x-string";
		var propNew = proto.$properties[key] = {
			$type: $type
		};
		for (var i = 0; i < _propertiesToCopy.length; i++) {
			var pname = _propertiesToCopy[i];
			var p = prop[pname];
			if (p) {
				propNew[pname] = p;
			}
		}
	});
	return proto;
}

exports.getPrototype = function(repr, facet) {
	return _buildPrototype(repr, facet);
};
});

define('syracuse-tablet/html/js/sdata/sdatawhere/operator',['require','exports','module','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {
var helpers = require('syracuse-tablet/html/js/helpers/utils');

exports.Operator = function(code, text, precedence, isPrefix, isInfix, isAssociative, isPredicate) {
	var self = this;
	self.code = code;
	self.text = text;
	self.precedence = precedence;
	self.isPrefix = isPrefix;
	self.isInfix = isInfix;
	self.isAssociative = isAssociative;
	self.isPredicate = isPredicate;
};
helpers.defineClass(exports.Operator, null, {
	toString: function() {
		return this.text;
	}
});

exports.operators = new function() {
	var self = this;
	self.operators = { //length : 0
	};

	init();

	function createOp(code, text, precedence, isPrefix, isInfix, isAssociative, isPredicate) {
		var op = new exports.Operator(code || text, text, precedence, isPrefix, isInfix, isAssociative, isPredicate);
		self.operators[op.text] = op;
		//self.operators.length++;
	}

	function init() {
		// codes are SQL operators - makes SQL conversion easy
		createOp(null, ".", 1, false, true, true, false);
		createOp(null, "not", 2, true, false, false, false);
		createOp("*", "mul", 3, false, true, true, false);
		createOp("/", "div", 3, false, true, true, false);
		createOp("%", "mod", 3, false, true, true, false);
		createOp(null, "+", 4, false, true, true, false);
		createOp(null, "-", 4, true, true, true, false);
		createOp("=", "eq", 5, false, true, false, true);
		createOp("<>", "ne", 5, false, true, false, true);
		createOp("<", "lt", 5, false, true, false, true);
		createOp("<=", "le", 5, false, true, false, true);
		createOp(">", "gt", 5, false, true, false, true);
		createOp(">=", "ge", 5, false, true, false, true);
		createOp(null, "between", 5, false, true, false, true);
		createOp(null, "in", 5, false, true, false, true);
		createOp(null, "like", 5, false, true, false, true);
		createOp(null, "and", 6, false, true, true, true);
		createOp(null, "or", 7, false, true, true, true);
		createOp(null, "(", 8, true, false, false, false);
		createOp(null, ")", 8, false, false, false, false);
		createOp(null, ",", 8, false, false, false, false);
	}

	return self;

};
});

define('syracuse-tablet/html/js/sdata/sdatawhere/token',['require','exports','module','syracuse-tablet/html/js/helpers/utils','./operator'],function (require, exports, module) {
var helpers = require('syracuse-tablet/html/js/helpers/utils');
var operators = require('./operator');

exports.tokenType = {
	identifier: 'identifier',
	operator: 'operator',
	literal: 'literal'
};

exports.Token = function(type, line, offset, length, val) {
	var self = this;
	self.type = type;
	self.value = val;

	var _line = line;
	var _offset = offset;
	var _length = length;
	self.getRemainingText = function() {
		return _line.substring(_offset, _line.length);
	};
};

helpers.defineClass(exports.Token, null, {
	matches: function(code) {
		return this.value instanceof operators.Operator && this.value.code == code;
	}
});
});

define('syracuse-tablet/html/js/sdata/sdatawhere/tokenizer',['require','exports','module','./token','./operator'],function (require, exports, module) {


var token = require('./token');
var operators = require('./operator');

exports.Tokenizer = new function() {
	var self = this;

	function _skipSpaces(chars, i) {
		while (i < chars.length && chars[i] === " ") {
			i++;
		}
		return i;
	}

	function _isDigit(str) {
		return new RegExp('[0-9]').test(str);
	}

	function _isLetter(str) {
		return new RegExp('[\$a-zA-Z%\']').test(str);
	}

	function _isWordChar(str) {
		return new RegExp('[\$a-zA-Z0-9_%\']').test(str);
	}

	function _parseNumber(line, chars, i, tokens) {
		var end = i + 1;
		while (end < chars.length && _isDigit(chars[end])) {
			end++;
		}
		var val;
		if (end < chars.length && chars[end] === '.') {
			end++;
			while (end < chars.length && _isDigit(chars[end])) {
				end++;
			}
			val = parseFloat(line.substring(i, end));

		} else {
			val = parseInt(line.substring(i, end), 10);
		}
		tokens.push(new token.Token(token.tokenType.literal, line, i, end - i,
			val));
		return end;
	}

	var _literals = {
		"true": true,
		"false": false,
		"null": null,
	};

	function _parseWord(line, chars, i, tokens) {
		var end = i + 1;
		while (end < chars.length && _isWordChar(chars[end])) {
			end++;
		}
		var word = chars.substr(i, end - i);
		var op = operators.operators.operators[word.toLowerCase()];
		if (op != null) {
			tokens.push(new token.Token(token.tokenType.operator, line, i, end - i, op));
		} else {
			var lit;
			if ((lit = _literals[word]) !== undefined) {
				tokens.push(new token.Token(token.tokenType.literal, line, i,
					end - i, lit));
			} else {
				tokens.push(new token.Token(token.tokenType.identifier, line,
					i, end - i, word));
			}
		}
		return end;
	}

	function _parseQuotedString(line, chars, i, tokens) {
		var quote = chars[i];
		var end = i + 1;
		var dest = 0;
		var res = "";
		while (end < chars.length) {
			if (chars[end] === quote) {
				end++;
				if (end === chars.length || chars[end] !== quote) {
					tokens.push(new token.Token(token.tokenType.literal, line,
						i, end - i, res));
					return end;
				}
			}
			res += chars[end++];
		}
		throw new Error('quoted string not terminated: ' + line.substring(i));
	}

	function _parseOperator(line, ch, i, tokens) {
		var op = operators.operators.operators[ch];
		tokens.push(new token.Token(token.tokenType.operator, line, i, 1, op));
		return i + 1;
	}

	function _parseDateTime(line, chars, i, tokens) {
		var end = i + 1,
			len = chars.length;
		while (end < len) {
			if (chars[end] == '@')
				break;
			end++;
		}
		if (end === chars.length) {
			throw new Error('Where parser: date constant not terminated:' + line.substring(i, line.length));
		}
		var str = chars.substr(i + 1, end - i - 1);
		var dt = new Date(str);
		if (dt != null) {
			var nt = new token.Token(token.tokenType.literal, line, i, end + 1 - i, dt);
			nt.dataType = "datetime";
			nt.svalue = str;
			tokens.push(nt);
		}
		return end + 1;
	}

	self.tokenize = function(line) {
		var tokens = [];
		var i = 0;
		while (i < line.length) {
			i = _skipSpaces(line, i);
			var ch = line[i];
			switch (ch) {
				case '@':
					i = _parseDateTime(line, line, i, tokens);
					break;
				case '"':
				case '\'':
					i = _parseQuotedString(line, line, i, tokens);
					break;
				case '.':
				case '-':
				case '+':
				case '(':
				case ')':
				case ',':
					i = _parseOperator(line, ch, i, tokens);
					break;
				default:
					if (_isLetter(ch)) {
						i = _parseWord(line, line, i, tokens);
					} else if (_isDigit(ch)) {
						i = _parseNumber(line, line, i, tokens);
					} else {
						throw new Error('invalid character: ' + line.substring(i));
					}
					break;
			}
		}

		return tokens;
	};

	return self;
};
});

define('syracuse-tablet/html/js/sdata/sdatawhere/expression',['require','exports','module','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {
var helpers = require('syracuse-tablet/html/js/helpers/utils');

exports.Expression = function(config) {
	var self = this;

	self.children = null;
	if (config.operator) {
		self.type = "operator";
		self.value = config.operator;
		self.children = [];
		if (config.expression1) {
			self.children.push(config.expression1);
		}
		if (config.expression2) {
			self.children.push(config.expression2);
		}
	} else if (config.expressionType) {
		self.type = config.expressionType;
		self.value = config.value;
		self.svalue = config.svalue;
		self.dataType = config.dataType;
		if (self.type === "function") {
			self.children = [];
		}
	}
};
helpers.defineClass(exports.Expression, null, {
	isPredicate: function() {
		switch (this.type) {
			case "operator":
				return this.value.isPredicate;
			case "identifier":
				return true; // don't know
			case "function":
				return true; // don't know -- will improve later
			case "literal":
				return false;
			default:
				throw new Error("invalid expression type: " + this.type);
		}
	},
	toString: function() {
		if (this.children == null) {
			return this.value.toString();
		}
		var sb = [];
		sb.push("[" + this.value.toString());
		for (var i = 0; i < this.children.length; i++) {
			sb.push(" " + this.children[i].toString());
		}
		sb.push("]");
		return sb.join('');
	}

});
});

define('syracuse-tablet/html/js/sdata/sdatawhere/parser',['require','exports','module','./token','./operator','./tokenizer','./expression'],function (require, exports, module) {
var token = require('./token');
var operators = require('./operator');
var tokenizer = require('./tokenizer');
var expression = require('./expression');

exports.Parser = new function() {
	var self = this;
	var _maxPrecedence = 8;

	function _finishBetween(tokens, tokenIndex, exp, precedence) {
		if (tokenIndex[0] == tokens.length || !tokens[tokenIndex[0]].matches("and")) {
			throw new Error("invalid expression: expected 'and' after " + tokens[tokenIndex[0] - 1].getRemainingText());
		}
		tokenIndex[0]++;
		var arg = _parseExpression(tokens, tokenIndex, precedence);
		exp.children.push(arg);
	}

	function _parseExpression(tokens, tokenIndex, precedence) {
		var exp = _parseTerm(tokens, tokenIndex);
		while (tokenIndex[0] < tokens.length) {
			var tk = tokens[tokenIndex[0]];
			var op = tk.value instanceof operators.Operator ? tk.value : null;
			if (op == null || !op.isInfix || op.precedence > precedence) {
				break;
			}
			tokenIndex[0]++;
			if (op.code == "in") {
				if (tokenIndex[0] === tokens.length || !tokens[tokenIndex[0]].matches("(")) {
					throw new Error("invalid expression: '(' expected after " + tk.getRemainingText());
				}
				tokenIndex[0]++;
				exp = new expression.Expression({
					operator: op,
					expression1: exp
				});
				_parseArguments(tokens, tk, tokenIndex, exp.children);
			} else {
				var arg = _parseExpression(tokens, tokenIndex, op.precedence - 1);
				exp = new expression.Expression({
					operator: op,
					expression1: exp,
					expression2: arg
				});
				if (op.code == "between") {
					_finishBetween(tokens, tokenIndex, exp, op.precedence);
				}
			}
			if (!op.isAssociative && op.precedence == precedence) {
				return exp;
			}
		}
		return exp;
	}

	function _parseTerm(tokens, tokenIndex) {
		if (tokenIndex[0] == tokens.length) {
			throw new Error("premature end of expression");
		}
		var tk = tokens[tokenIndex[0]];
		switch (tk.type) {
			case token.tokenType.identifier:
				tokenIndex[0]++;
				if (tokenIndex[0] < tokens.length && tokens[tokenIndex[0]].matches("(")) {
					return _parseFunctionCall(tokens, tk, tokenIndex);
				} else {
					return new expression.Expression({
						expressionType: "identifier",
						value: tk.value
					});
				}
			case token.tokenType.literal:
				tokenIndex[0]++;
				return new expression.Expression({
					expressionType: "literal",
					value: tk.value,
					svalue: tk.svalue,
					dataType: tk.dataType
				});
			case token.tokenType.operator:
				var op = tk.value;
				if (!op.isPrefix) {
					throw new Error("invalid expression: expected beginning of term at " + tk.getRemainingText());
				}
				tokenIndex[0]++;
				return _parsePrefixOperator(tokens, op, tokenIndex);
			default:
				throw new Error("internal error: bad token type " + tk.type);
		}
	}

	function _parseArguments(tokens, tk, tokenIndex, arguments0) {
		if (tokenIndex[0] < tokens.length && tokens[tokenIndex[0]].matches(")")) {
			tokenIndex[0]++;
			return;
		}
		while (tokenIndex[0] < tokens.length) {
			var arg = _parseExpression(tokens, tokenIndex, _maxPrecedence);
			arguments0.push(arg);
			if (tokenIndex[0] < tokens.length && tokens[tokenIndex[0]].matches(")")) {
				tokenIndex[0]++;
				return;
			}
			if (tokenIndex[0] == tokens.length || !tokens[tokenIndex[0]].matches(",")) {
				throw new Error("invalid expression: expected ',' or ')' at " + tokens[tokenIndex[0]].getRemainingText());
			}
			tokenIndex[0]++;
		}
		throw new Error("invalid function call syntax: argument missing after " + tk.getRemainingText());
	}

	function _parsePrefixOperator(tokens, op, tokenIndex) {
		var arg1;
		switch (op.code) {
			case "-":
			case "not":
				arg1 = _parseExpression(tokens, tokenIndex, 1);
				return new expression.Expression({
					operator: op,
					expression1: arg1
				});
			case "(":
				arg1 = _parseExpression(tokens, tokenIndex, op.precedence);
				//require('term').stream.print('???' + tokens[tokenIndex[0]].value);
				if (tokenIndex[0] == tokens.length || !tokens[tokenIndex[0]].matches(")")) {
					throw new Error("invalid expression: expected ')' after " + tokens[tokenIndex[0] - 1].getRemainingText());
				}
				tokenIndex[0]++;
				return arg1;
			default:
				throw new Error("internal error: bad prefix operator " + op.code);
		}
	}

	function _parseFunctionCall(tokens, tk, tokenIndex) {
		tokenIndex[0]++;
		var exp = new expression.Expression({
			expressionType: "function",
			value: tk.value
		});
		_parseArguments(tokens, tk, tokenIndex, exp.children);
		return exp;
	}

	self.parse = function(str) {
		if (str == null || str.length == 0) {
			return null;
		}
		var tokens = tokenizer.Tokenizer.tokenize(str);
		var tokenIndex = [];
		tokenIndex[0] = 0;
		var exp = _parseExpression(tokens, tokenIndex, _maxPrecedence);
		if (tokenIndex[0] != tokens.length) {
			throw new Error("invalid expression: unexpected token at " + tokens[tokenIndex[0]].getRemainingText());
		}
		return exp;
	};

	return self;
};
});

define('syracuse-tablet/html/js/sdata/sdatawhere/whereUtils',['require','exports','module'],function (require, exports, module) {

function _exec(data, exp, proto) {
	if (exp.type == "identifier") {
		exp.property = data[exp.value];
		// issue #3744 in X3 boolean properties has numeric values
		// and in the x3 filters (where clauses use numeric values 1(false) and
		// 2(true) for boolean properties)
		var item = proto && proto.$properties && proto.$properties.$resources ? proto.$properties.$resources.$item : null;
		if (item && item.$properties && item.$properties[exp.value] && item.$properties[exp.value].$type === "application/x-boolean") {
			exp.property = exp.property === true ? 2 : 1;
		}
	} else if (exp.type == "literal") {
		exp.property = (exp.dataType == "datetime") ? exp.svalue : exp.value;
	} else {
		if (exp.children) {
			var property = null;

			// propagate property from child to parent if operator if low level
			// operator
			if (exp.type == "operator") {
				switch (exp.value.code) {

					case "and":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property && exp.children[1].property);
						break;
					case "or":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property || exp.children[1].property);
						break;
					case "between":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property >= exp.children[1].property) && (exp.children[0].property <= exp.children[2].property);
						break;
					case ">=":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property >= exp.children[1].property);
						break;
					case ">":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property > exp.children[1].property);
						break;
					case "<=":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property <= exp.children[1].property);
						break;
					case "<":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property < exp.children[1].property);
						break;
					case "like_s":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						exp.property = (exp.children[0].property.toUpperCase()
							.indexOf(exp.children[1].property.toUpperCase()) === 0);
						break;
					case "like":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						var val = exp.children[1].property.toUpperCase().replace(
							/%/g, '');
						exp.property = (exp.children[0].property.toUpperCase()
							.indexOf(val) >= 0);
						break;
					case "=":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						if (exp.children[0].property == "0000-00-00" && exp.children[1].dataType === "datetime") {
							exp.children[0].property = "";
						}
						if (exp.children[1].property == "0000-00-00" && exp.children[0].dataType === "datetime") {
							exp.children[1].property = "";
						}
						exp.property = (exp.children[0].property == exp.children[1].property);
						break;
					case "<>":
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
						});
						if (exp.children[0].property == "0000-00-00" && exp.children[1].dataType === "datetime") {
							exp.children[0].property = "";
						}
						if (exp.children[1].property == "0000-00-00" && exp.children[0].dataType === "datetime") {
							exp.children[1].property = "";
						}
						exp.property = (exp.children[0].property != exp.children[1].property);
						break;
					case ".":
						_exec(data, exp.children[0], proto);
						_exec(exp.children[0].property, exp.children[1], proto);
						exp.property = exp.children[1].property;
						break;
					default:
						exp.property = property;
						// propagate to literals
						exp.children.forEach(function(child) {
							_exec(data, child, proto);
							if (child.type == "literal")
								child.property = property;
						});
				}
			} else if (exp.type == "function") {
				throw new Error("exp.type == 'function' not implemented");
			}
		}
	}
};

exports.execWhere = function(dataContext, exp, proto) {

	if (exp == null) {
		return true;
	}

	_exec(dataContext, exp, proto);

	return exp.property;

};
});

define('syracuse-tablet/html/js/sdata/sdataDispatcherLocal',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/sdata/entities/clientContract','syracuse-tablet/html/js/sdata/sdatawhere/parser','syracuse-tablet/html/js/sdata/sdatawhere/whereUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var parser = require('syracuse-tablet/html/js/sdata/sdatawhere/parser').Parser;
var whereUtils = require('syracuse-tablet/html/js/sdata/sdatawhere/whereUtils');

exports.Dispatcher = utils.defineClass(function() {}, null, {
	"getEntity": function($representation) {
		var repr = $representation && $representation.split(".");
		if (repr && repr[0] && repr[0].smStartsWith("QUERY~")) {
			repr = repr[0].split("~")[1];
		} else {
			repr = repr && repr[0];
		}
		return repr && clientContract.getEntity(repr);
	},
	"accept": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		deferred.resolve(self.getEntity(op.$representation) != null);
		return deferred.promise();
	},

	"prototype": function(op, data) {
		var deferred = $.Deferred();
		deferred.reject("Dispatcher should never request for prototypes since they are cached in the application model on client side");
		return deferred.promise();
	},

	"new": function(op, data) {
		var self = this;
		var ent = self.getEntity(op.$representation);
		return ent.$services["$new"](op, data);
	},

	"read": function(op, data) {
		var self = this;
		var ent = self.getEntity(op.$representation);
		return ent.$services["$read"](op, data);
	},

	"query": function(op, data) {
		var self = this;
		var ent = self.getEntity(op.$representation);
		var list = ent.$services["$query"](op, data);

		// Apply where condition
		if (op.$where) {
			var deferred = $.Deferred();
			list.then(function(resources) {
				var list = resources.$resources;
				var exp = parser.parse(op.$where);
				var repr = op.$representation && op.$representation.split(".");
				var $proto = clientContract.getPrototype(repr[0], repr[1]);
				var res = [];
				list.forEach(function(item, i) {
					if (whereUtils.execWhere(item, exp, $proto)) {
						res.push(item);
					}
				});
				deferred.resolve({
					$resources: res
				});
			}, function(e) {
				deferred.reject(e);
			});
			return deferred.promise();
		}
		return list;
	},

	"save": function(op, data) {
		var self = this;
		var ent = self.getEntity(op.$representation);
		return ent.$services["$save"](op, data);
	},

	"delete": function(op, data) {
		var self = this;
		var ent = self.getEntity(op.$representation);
		return ent.$services["$delete"](op, data);
	},
	"service": function() {
		var deferred = $.Deferred();
		deferred.resolve();
		return deferred.promise();
	}
});
});

define('syracuse-tablet/html/js/sdata/sdataDispatcherHttp',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/sdata/sdataHttp'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("sdataDispatcher");
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');

exports.Dispatcher = utils.defineClass(function() {}, null, {
	"accept": function() {
		var deferred = $.Deferred();
		deferred.resolve(true);
		return deferred.promise();
	},

	/**
	 *  Called for every request handled by the dispatcher
	 *  Can be used to disable caching in general or for specific representations
	 */
	_useCache: function(op, data) {
		var nocache = op.$parsedUrl && op.$parsedUrl.query && op.$parsedUrl.query.nocache;
		if (nocache) {
			return false;
		}
		return true;
	},

	// GET: {$baseUrl}/SUPERV//$prototypes('AQTCRUD.$query')
	"prototype": function(op, data) {
		var deferred = $.Deferred();
		deferred.reject("Dispatcher should never request for prototypes since they are cached in the application model on client side");
		return deferred.promise();
	},

	//GET: {$baseUrl}/SUPERV/AQTCRUD/$template?representation=AQTCRUD.$create
	"new": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		try {
			self._newGetCache(op, data)
				.then(function(result) {
					// got new template from cache
					if (result) {
						log && log("Read template from cache: " + op.$representation);
						// Change UUID since we create a new record!
						result.$uuid = utils.UUID();
						return result;
					} else {
						return self._newDoHttp(op, data)
							.then(function(result) {
								if (result.isSuccess) {
									var data = result.responseJSON;
									return self._newPutCache(op, data)
										.then(function() {
											return data;
										});
								}
								return $.smReject(new Error("Error reading $template: " + JSON.stringify(result)));
							});
					}
				})
				.then(function(result) {
					deferred.resolve(result);
				}, function(e) {
					deferred.reject(e);
				});
		} catch (e) {
			deferred.reject(e);
		}
		return deferred.promise();
	},

	_newGetCache: function(op) {
		var self = this;
		if (self._useCache(op, null, "read")) {
			var cache = globals.getCache();
			log && log("Reading template from cache: " + op.$representation);
			return cache.read({
				$representation: "$templates",
				$endpoint: op.$endpoint,
				$key: op.$representation
			});
		}
		log && log("Disabled reading template from cache : " + op.$representation);
		return $.smResolve();
	},
	_newDoHttp: function(op, data) {
		var send = {
			method: "GET",
			url: op.$link.$url
		};
		return sdataHttp.send(send);
	},
	_newPutCache: function(op, data) {
		var self = this;
		if (self._useCache(op, data, "write")) {
			log && log("Writing template to cache: " + op.$representation);
			var cache = globals.getCache();
			return cache.put({
				$representation: "$templates",
				$key: op.$representation,
				$endpoint: op.$endpoint,
				$data: data
			});
		}
		log && log("Disabled writing template to cache : " + op.$representation);
		return $.smResolve();
	},

	//GET: {$baseUrl}/SUPERV/AQTCRUD('10')?representation=AQTCRUD.$create
	"read": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		try {
			self._readGetCache(op, data)
				.then(function(result) {
					if (result) {
						log && log("Read data from cache: " + op.$representation);
						return result;
					} else {
						return self._readDoHttp(op, data)
							.then(function(result) {
								if (result.isSuccess) {
									var data = result.responseJSON;
									return self._readPutCache(op, data)
										.then(function() {
											return data;
										});
								}
								return $.smReject(new Error("Error reading data: " + JSON.stringify(result)));
							});
					}
				})
				.then(function(result) {
					deferred.resolve(result);
				}, function(e) {
					deferred.reject(e);
				});
		} catch (e) {
			deferred.reject(e);
		}
		return deferred.promise();
	},

	_readGetCache: function(op) {
		var self = this;
		if (self._useCache(op, null, "read")) {
			var cache = globals.getCache();
			log && log("Reading data from cache: " + op.$representation);
			return cache.read({
				$representation: op.$representation,
				$endpoint: op.$endpoint,
				$key: op.$key
			});
		}
		log && log("Disabled reading data from cache : " + op.$representation);
		return $.smResolve();
	},
	_readDoHttp: function(op, data) {
		var send = {
			method: "GET",
			url: op.$link.$url
		};
		return sdataHttp.send(send);
	},
	_readPutCache: function(op, data) {
		var self = this;
		if (self._useCache(op, data, "write")) {
			log && log("Writing data to cache: " + op.$representation);
			var cache = globals.getCache();
			return cache.put({
				$representation: op.$representation,
				$key: op.$key,
				$endpoint: op.$endpoint,
				$data: data
			});
		}
		log && log("Disabled writing data to cache : " + op.$representation);
		return $.smResolve();
	},

	// GET: {$baseUrl}/SUPERV/AQTCRUD?representation=AQTCRUD.$create?where=xxx
	"query": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		try {
			self._queryGetCache(op, data)
				.then(function(result) {
					if (result && result.length > 0) {
						log && log("Queried data from cache: " + op.$representation);
						var response = {};
						self._queryCutAndAddLinks(op, data, result, response);
						if (response.$resources.length > 0) {
							return response;
						}
					};

					return self._queryDoHttp(op, data)
						.then(function(result) {
							if (result.isSuccess) {
								var data = result.responseJSON;
								return self._queryPutCache(op, data)
									.then(function() {
										return data;
									});
							}
							return $.smReject(new Error("Error querying data: " + JSON.stringify(result)));
						});
				})
				.then(function(result) {
					deferred.resolve(result);
				}, function(e) {
					deferred.reject(e);
				});
		} catch (e) {
			deferred.reject(e);
		}
		return deferred.promise();
	},
	_queryCutAndAddLinks: function(op, data, result, response) {
		var self = this;
		var baseUrl = op.$parsedUrl.source.split("?")[0];
		var query = "";
		var key;
		var max = 30;

		if (op.$parsedUrl.query && op.$parsedUrl.query.where) {
			query += "&where=" + op.$parsedUrl.query.where;
		}

		key = op.$parsedUrl.query && op.$parsedUrl.query.key;
		var firstKeyRead;
		var lastKeyRead;

		var resources = response.$resources = [];
		var hasNextPage = false;
		var hasPreviousPage = false;
		var i;

		var pageName = op.$endpoint + "." + op.$representation;
		var proto = globals.getApplication().getPrototype(pageName);
		var val;
		var kv;
		proto = (proto.$properties && proto.$properties.$resources && proto.$properties.$resources.$item) || proto;
		var keyField;
		if (proto.$key) {
			keyField = proto.$key.replace(/{/g, "").replace(/}/g, "");
		} else {
			keyField = "$uuid";
		}
		var keyType = proto.$properties[keyField];
		var isNumericKey = keyType && keyType.$type && keyType.$type !== "application/x-string";

		if (key && key.smStartsWith("gt")) {
			val = isNumericKey ? 0 + key.substr(3) : "" + key.substr(3);

			for (i = 0; i < result.length; i++) {
				kv = self._calculateKey(proto, result[i]);
				kv = isNumericKey ? +kv : "" + kv;

				if (kv > val) {
					resources.push(result[i]);
					if (resources.length > max) {
						break;
					}
				} else {
					hasPreviousPage = true;
				}
			}
			if (resources.length > 0) {
				if (resources.length > max) {
					resources.pop();
					hasNextPage = true;
				}
				firstKeyRead = self._calculateKey(proto, resources[0]);
				lastKeyRead = self._calculateKey(proto, resources[resources.length - 1]);
			}
		} else if (key && key.smStartsWith("lt")) {

			if (key.length > 3) {
				val = isNumericKey ? +key.substr(3) : "" + key.substr(3);

				for (i = result.length - 1; i >= 0; i--) {

					kv = self._calculateKey(proto, result[i]);
					kv = isNumericKey ? 0 + kv : "" + kv;

					if (kv < val) {
						resources.push(result[i]);
						if (resources.length > max) {
							break;
						}
					} else {
						hasNextPage = true;
					}
				}
				if (resources.length > max) {
					hasPreviousPage = true;
					resources.pop();
				}
			} else {
				for (i = result.length - 1; i >= 0; i--) {
					resources.push(result[i]);
					if (resources.length > max) {
						break;
					}
				}
			}
			if (resources.length > 0) {
				if (resources.length > max) {
					hasPreviousPage = true;
					resources.pop();
				}
				response.$resources = resources = resources.reverse();

				firstKeyRead = self._calculateKey(proto, resources[0]);
				lastKeyRead = self._calculateKey(proto, resources[resources.length - 1]);
			}
		} else {
			for (i = 0; i < result.length; i++) {
				resources.push(result[i]);
				if (resources.length > max) {
					break;
				}
			}
			if (resources.length > 0) {
				if (resources.length > max) {
					hasNextPage = true;
					resources.pop();
				}

				firstKeyRead = self._calculateKey(proto, resources[0]);
				lastKeyRead = self._calculateKey(proto, resources[resources.length - 1]);
			}
		}

		var links = response.$links = {};
		if (key) {
			links.$first = {
				$url: baseUrl + "?representation=" + op.$representation + query
			};
		}

		if (key && firstKeyRead && hasPreviousPage) {
			if (key !== "gt") { // not on first page?
				links.$previous = {
					$url: baseUrl + "?representation=" + op.$representation + query + "&key=lt." + firstKeyRead
				};
			}
		}

		if (key !== "lt" && lastKeyRead && hasNextPage) { // not on last page and more records
			links.$next = {
				$url: baseUrl + "?representation=" + op.$representation + query + "&key=gt." + lastKeyRead
			};
		}
		if (key !== "lt") {
			links.$last = {
				$url: baseUrl + "?representation=" + op.$representation + query + "&key=lt"
			};
		}

		links.$more = {
			$url: op.$parsedUrl.source + "&nocache=true"
		};
	},
	_queryGetCache: function(op) {
		var self = this;
		if (self._useCache(op, null, "read")) {
			var cache = globals.getCache();
			log && log("Querying data from cache: " + op.$representation);
			var p = op.$endpoint + "." + op.$representation;
			var proto = globals.getApplication().dao.getPrototype(p);
			if (proto) {
				self._checkQueryPrototype(op, proto);
				return cache.query({
					$proto: proto,
					$endpoint: op.$endpoint,
					$where: op.$where
				});
			} else {
				// Ususally this should never be called since the sync call above
				// returns the prototype already.
				return sdataHttp.fetchRemotePrototype(op).then(function(proto) {
					self._checkQueryPrototype(op, proto);
					return cache.query({
						$proto: proto,
						$endpoint: op.$endpoint,
						$where: op.$where
					});
				});
			}
		}
		log && log("Disabled querying data from cache : " + op.$representation);
		return $.smResolve();
	},
	_queryDoHttp: function(op, data) {
		var send = {
			method: "GET",
			url: op.$link.$url
		};
		return sdataHttp.send(send);
	},
	_queryPutCache: function(op, data) {
		var self = this;
		try {
			if (self._useCache(op, data, "write")) {
				log && log("Writing data to cache: " + op.$representation);
				var cache = globals.getCache();

				var pageName = op.$endpoint + "." + op.$representation;
				var proto = globals.getApplication().getPrototype(pageName);
				proto = (proto.$properties && proto.$properties.$resources && proto.$properties.$resources.$item) || proto;

				return data.$resources.forEachPromise(function(item) {
					var key = self._calculateKey(proto, item);
					return cache.put({
						$representation: op.$representation,
						$key: key,
						$endpoint: op.$endpoint,
						$data: item
					});
				});
			}
			log && log("Disabled writing data to cache : " + op.$representation);
			return $.smResolve();
		} catch (e) {
			return $.smReject(e);
		}
	},


	// PUT: {$baseUrl}/SUPERV/AQTCRUD('10')?representation=AQTCRUD.$edit
	// POST: {$baseUrl}/SUPERV/AQTCRUD?representation=AQTCRUD.$create
	"save": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		try {
			self._saveDoHttp(op, data)
				.then(function(result) {
					if (result.isSuccess) {
						var data = result.responseJSON;
						return self._savePutCache(op, data)
							.then(function() {
								return data;
							});
					}
					return $.smReject(new Error("Error saving object: " + JSON.stringify(result)));
				})
				.then(function(result) {
					deferred.resolve(result);
				}, function(e) {
					deferred.reject(e);
				});
		} catch (e) {
			deferred.reject(e);
		}
		return deferred.promise();
	},

	_saveDoHttp: function(op, data) {
		var send = {
			method: op.$link.$method,
			url: op.$link.$url,
			send: data
		};
		return sdataHttp.send(send);
	},

	_savePutCache: function(op, data) {
		var self = this;
		try {
			if (self._useCache(op, data, "write")) {
				log && log("Writing data to cache: " + op.$representation);
				var cache = globals.getCache();
				var key = op.$key;
				if (!key) {
					var pageName = op.$endpoint + "." + op.$representation;
					var proto = globals.getApplication().getPrototype(pageName);
					proto = (proto.$properties && proto.$properties.$resources && proto.$properties.$resources.$item) || proto;
					key = self._calculateKey(proto, data);
				}
				return cache.put({
					$representation: op.$representation,
					$key: key,
					$endpoint: op.$endpoint,
					$data: data
				});
			}
			log && log("Disabled writing data to cache : " + op.$representation);
			return $.smResolve();
		} catch (e) {
			return $.smReject(e);
		}
	},

	// DELETE: {$baseUrl}/SUPERV/AQTCRUD('10')?representation=AQTCRUD.$query
	"delete": function(op, data) {
		var self = this;
		var deferred = $.Deferred();
		try {
			self._deleteDoHttp(op, data)
				.then(function(result) {
					if (result.isSuccess) {
						var data = result.responseJSON;
						return self._deleteRemoveCache(op, data)
							.then(function() {
								return data;
							});
					}
					return $.smReject(new Error("Error saving object: " + JSON.stringify(result)));
				})
				.then(function(result) {
					deferred.resolve(result);
				}, function(e) {
					deferred.reject(e);
				});
		} catch (e) {
			deferred.reject(e);
		}
		return deferred.promise();
	},
	_deleteDoHttp: function(op, data) {
		var send = {
			method: op.$link.$method,
			url: op.$link.$url
		};
		return sdataHttp.send(send);
	},
	_deleteRemoveCache: function(op, data) {
		var self = this;
		if (self._useCache(op, data, "write")) {
			log && log("Deleting data from cache: " + op.$representation);
			var cache = globals.getCache();
			return cache.remove({
				$representation: op.$representation,
				$key: op.$key,
				$endpoint: op.$endpoint
			});
		}
		log && log("Disabled deleting data from cache : " + op.$representation);
		return $.smResolve();
	},

	"service": function() {

	},
	_calculateKey: function(proto, item) {
		var key;
		if (proto.$key) {
			key = proto.$key.replace(/\{(.*?)\}/g, function(match, prop) {
				return item[prop];
			});
		} else {
			key = item.$uuid;
		}
		return key;
	},
	_checkQueryPrototype: function(op, proto) {
		// Queries (Requester) do not generate a full prototype, add what's missing here
		if (op.$representation.smStartsWith("QUERY~")) {
			if (proto.$properties.$resources.$item && !proto.$properties.$resources.$item.$type) {
				proto.$properties.$resources.$item.$type = "{$baseType}." + op.$representation;
			}
		}
	}
});
});

define('syracuse-tablet/html/js/sdata/sdataDispatcher',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/sdata/sdataUtils','syracuse-tablet/html/js/sdata/sdataDispatcherLocal','syracuse-tablet/html/js/sdata/sdataDispatcherHttp'],function (require, exports, module) {

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("sdataDispatcher");
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');

var dispLocal = require('syracuse-tablet/html/js/sdata/sdataDispatcherLocal').Dispatcher;
var dispHttp = require('syracuse-tablet/html/js/sdata/sdataDispatcherHttp').Dispatcher;

var _dispatchers = [
	new dispLocal(),
	new dispHttp()
];

/**
 * link
 * {
 * 	 $url: ...,
 * 	 $method: "GET", ...
 * }
 * data
 * {
 *   ...
 * }
 */
exports.dispatch = function(link, data, options) {
	var deferred = $.Deferred();
	try {
		log && log("Dispatch: " + link.$method + ": " + link.$url);

		var op = exports.parseLink(link);

		var dispatcher;
		_dispatchers.forEachPromise(function(disp) {
			return disp.accept(op, data);
		}, function(disp, result) {
			if (result === true) {
				dispatcher = disp;
				return true;
			}
			return false;
		});

		var prom = dispatcher[op.$operation](op, data);
		if (!prom) {
			throw new Error("Could not dispatch: " + link.$method + ": " + link.$url + " (" + op.$operation + ")");
		}
		prom.then(function(result) {
			deferred.resolve(result);
		}, function(e) {
			deferred.reject(e);
		});
	} catch (e) {
		deferred.reject(e);
	}
	return deferred.promise();
};

/**
 * Parse link to identify which kind of operation it's intended to start
 *
 * link:
 * {
 * 	 $url: ...,
 * 	 $method: "GET", ...
 * }
 *
 * Return:
 * {
 *    "$link":{
 *       "$method":"DELETE",
 *       "$url":"http://localhost:8124/sdata/x3/erp/SUPERV/AQTCRUD('10')?representation=AQTCRUD.$query"
 *    },
 *    "$parsedUrl":{
 * ...
 *       "directory":"/sdata/x3/erp/SUPERV/AQTCRUD('10')",
 *       "path":"/sdata/x3/erp/SUPERV/AQTCRUD('10')",
 *       "relative":"/sdata/x3/erp/SUPERV/AQTCRUD('10')?representation=AQTCRUD.$query",
 * ...
 *       "query":{
 *          "representation":"AQTCRUD.$query"
 *       },
 * ...
 *       "representation":"AQTCRUD",
 *    },
 *    "$operation":"delete",
 *    "$key":"10",
 *    "$representation":"AQTCRUD.$query"
 * }
 *
 */
exports.parseLink = function(link) {
	var url = link.$url;
	var result = {
		$link: link,
		$parsedUrl: sdataUtils.parseSDataURL(link.$url)
	};
	var keyExp = /\('(.*?)'\)/;

	result.$endpoint = result.$parsedUrl.application + "." + result.$parsedUrl.contract + "." + result.$parsedUrl.dataset;
	var dir = result.$parsedUrl.directory; // All except query parameters
	var idx;
	if (link.$method === "GET") {
		if (url.indexOf("$prototypes") > -1) {
			result.$operation = "prototype";
			result.$representation = /\$prototypes\('(.*?)'\)/.exec(url)[1];
		} else if (dir.indexOf("$template") > -1) {
			result.$operation = "new";
			result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
		} else if ((idx = dir.indexOf("/$services/")) > -1) {
			var service = dir.substring(idx + 11);
			result.$operation = "service";
			result.$service = service;
			result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
		} else {
			var key = keyExp.exec(dir);
			var isQuery = dir.indexOf("/QUERY(") > -1;
			if (key && !isQuery) {
				result.$operation = "read";
				result.$key = key[1];
				result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
			} else {
				result.$operation = "query";
				result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
			}
		}
		if (result.$parsedUrl.query && result.$parsedUrl.query.where) {
			result.$where = result.$parsedUrl.query.where;
		}
	} else if ((idx = dir.indexOf("/$services/")) > -1) {
		var service = dir.substring(idx + 11);
		result.$operation = "service";
		result.$service = service;
		result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
	} else if (link.$method === "DELETE") {
		var key = keyExp.exec(dir);
		result.$operation = "delete";
		result.$key = key[1];
		result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
	} else {
		// PUT/POST and no service
		var key = keyExp.exec(dir);
		if (key) {
			result.$operation = "save";
			result.$key = key[1];
			result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
		} else {
			result.$operation = "save";
			result.$representation = result.$parsedUrl.query && result.$parsedUrl.query.representation;
		}
	}

	return result;
};
});

define('syracuse-tablet/html/js/pages/pageRegular',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/pages/page','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/sdata/sdataDispatcher','syracuse-tablet/html/js/application/appFactory'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("page");
var Base = require('syracuse-tablet/html/js/pages/page').Page;
var globals = require('syracuse-tablet/html/js/helpers/globals');
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');
var factory = require('syracuse-tablet/html/js/application/appFactory');

var _Page = utils.defineClass(
	function($parent, state, prototype, article) {
		var self = this;
		Base.call(self, $parent, state, prototype, article);
		self.gadget = self.state.options.gadget;
		self.sDataUrl = null;
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			self.gadget = null;
		},

		isEditMode: function() {
			var self = this;
			var url = self.prototype.data("$url");
			if (url && (url.indexOf("$create") > -1 || url.indexOf("$edit") > -1)) {
				return true;
			}
			return false;
		},

		_beforeAddContent: function() {
			var self = this;
			if (!self.vignette) self.addTitle(globals.getApplication().getTitle() + " - " + self.prototype.data("$title"));
		},

		/**
		 * Used by html builder to create a link to full page
		 */
		getOpenLinkAttrs: function() {
			var self = this;
			var res = Base.prototype.getOpenLinkAttrs.call(self);
			res["data-sdata-url"] = self.sDataUrl;
			res["data-gadget-id"] = self.gadget.data("$uuid");
			return res;
		},
		loadData: function() {
			var deferred = $.Deferred();
			var self = this;
			var _rejectError = function(e) {
				log && log("loadData failed", e);
				deferred.reject(e);
			};
			try {
				self.sDataUrl = self.state.options["sdata-url"];
				if (!self.sDataUrl) {
					if (self.gadget) {
						self.sDataUrl = self.gadget.getSDataUrl(self.prototype);
					} else {
						self.sDataUrl = self.prototype.data("$url");
					}
				}

				if (self.gadget) {
					var params = self.gadget.getParameters();
					if (params.where) {
						self.sDataUrl = self._addWhereClause(self.sDataUrl, params.where, self.state.options.sdataParameters || {});
					}
				}

				if (!self.sDataUrl) throw new Error("$url (sDataUrl) is expected");
				dispatcher.dispatch({
					$url: self.sDataUrl,
					$method: "GET"
				}).then(function(data) {
					try {
						var options = {};
						self.setDao(factory.createDaoSdata("representation", data, self.prototype, null, options));
						deferred.resolve();
					} catch (e) {
						_rejectError(e);
					}
				}, _rejectError);
			} catch (e) {
				_rejectError(e);
			} finally {
				return deferred.promise();
			}
		},
		_addWhereClause: function(url, where, params) {
			where = where.value;
			var res = where.replace(/\{(\w*?)\}/g, function(m, p1) {
				var value = params[p1];
				return value != null ? value : "";
			});
			url = url + "&where=" + res;
			return url;
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/pages/html/pageHtml',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/pages/page','syracuse-tablet/html/js/pages/html/pageTemplates'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/page').Page;
var pageTemplates = require('syracuse-tablet/html/js/pages/html/pageTemplates');

/**
 * Temporarily HTML page
 * 		All pages should be generated based on $article and $prototype
 */
var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
	}, Base, {

		/**
		 * No article an proto
		 */
		loadStructure: function() {
			return $.smResolve();
		},

		render: function() {
			try {
				return this.buildHtml();
			} catch (e) {
				return $.smReject(e);
			}
		},

		buildHtml: function() {
			throw new Error("Not implemented");
		},

		buildHtmlTpl: function(contentCtx, headerCtx) {
			var deferred = $.Deferred();
			var self = this;
			try {
				self.buildHtmlContent(contentCtx)
					.then(function(html) {;
						self.$$contentElmt.html(html);
					})
					.then(function() {
						return self.buildHtmlHeader(headerCtx);
					})
					.then(function(html) {
						self.$$headerElmt.html(html);
					})
					.then(function() {
						deferred.resolve();
					}, function(e) {
						deferred.reject(e);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		buildHtmlContent: function(ctxContent) {
			var self = this;
			return pageTemplates.getTemplateContent(self.state, ctxContent || {});
		},

		buildHtmlHeader: function(ctxHeader) {
			var self = this;
			return pageTemplates.getTemplateHeader(self.state, ctxHeader || {});
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/storage/storageInterface',['require','exports','module','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {

/*
 * Default interface for mobile application metadata, favorites, drafts and templates, ...
 */


var utils = require('syracuse-tablet/html/js/helpers/utils');

function _StorageInterface() {
	this.infoString = "Interface only";
};

/*
 * All storage interfaces must inherit the "Not implemented" methods of this super class
 */
var storageInterfaceClass = utils.defineClass(
	_StorageInterface,
	null, {
		getInfo: function() {
			return this.infoString;
		},

		/**
		 * Init storage
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK,
		 *   $data: { }
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		init: function() {
			throw new Error("Not implemented!");
		},

		/**
		 * Query a list of items
		 *
		 * Parameters:
		 * opts: {
		 *   $context: {
		 *     $user,
		 *     $role,
		 *     $lang
		 *   },
		 *   $endpoint,
		 *   $collection: "users.$query",
		 *   $orderBy: "name, email" // optional
		 * }
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK,
		 *   $data: [record1, record2, ...]
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		query: function(opts) {
			throw new Error("Not implemented!");
		},

		/**
		 * Does a create or update if record is there already
		 *
		 * Parameters:
		 * opts: {
		 *   $context: {
		 *     $user,
		 *     $role,
		 *     $lang
		 *   },
		     $endpoint,
		 *   $collection: "users.$query",
		 *   $data: {},
		 *   $key: "abc~def"
		 * }
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK,
		 *   $data: { }
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		put: function(opts) {
			throw new Error("Not implemented!");
		},

		/**
		 * Reads exactly one record by it's key
		 *
		 * Parameters:
		 * opts: {
		 *   $context: {
		 *     $user,
		 *     $role,
		 *     $lang
		 *   },
		     $endpoint,
		 *   $collection: "users.$query",
		 *   $key: "abc~def"
		 * }
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK or StatusCodes.NOT_FOUND
		 *   $data: { }
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		read: function(opts) {
			throw new Error("Not implemented!");
		},

		/**
		 * Delete exactly one record by it's key
		 *
		 * Parameters:
		 * opts: {
		 *   $context: {
		 *     $user,
		 *     $role,
		 *     $lang
		 *   },
		     $endpoint,
		 *   $collection: "users.$query",
		 *   $key: "abc~def"
		 * }
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK or StatusCodes.NOT_FOUND
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		remove: function(opts) {
			throw new Error("Not implemented!");
		},

		/**
		 * Delete exactly one record by it's key
		 *
		 * Parameters:
		 * opts: {
		 *   $context: {
		 *     $user,
		 *     $role,
		 *     $lang
		 *   },
		     $endpoint,
		 *   $collection: "users.$query", // string or regex
		 * }
		 *
		 * Return:
		 * Resolve:
		 * {
		 *   $status: StatusCodes.OK
		 * }
		 *
		 * Reject:
		 * {
		 *   $status: StatusCodes.ERROR,
		 *   $message: "Error message",
		 *   $exception: { ... }
		 * }
		 *
		 */
		clearCollection: function() {
			throw new Error("Not implemented!");
		}
	}
);

function buildResult(status, data, message, exception, metaData) {

	var res = {
		$status: status
	};

	if (data) res.$data = data;
	if (metaData) res.$metaData = metaData;
	if (message) res.$message = message;
	if (exception) res.$exception = exception;

	return res;
}
exports.StorageInterface = storageInterfaceClass;
exports.StatusCodes = {
	OK: 1,
	NOT_FOUND: 2,
	ERROR: 3
};
exports.buildResult = buildResult;
// Same db name for all kind of database - !!must be different from mobile application name
exports.databaseName = "sage-tablet-db";
});

define('syracuse-tablet/html/js/storage/storageWinJS',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/storage/storageInterface','syracuse-tablet/html/js/helpers/winjs'],function (require, exports, module) {

/*
 * WinJS storage interface (Webview control running in Windows Store Application)
 */

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var storageInterface = require('syracuse-tablet/html/js/storage/storageInterface');
var winjs = require('syracuse-tablet/html/js/helpers/winjs');

function _StorageInterfaceWinJS() {
	this.infoString = "WinJS storage interface";
};

/*
 *
 * Proxy class to route all call to winJS container
 *
 */
var _storageInterfaceWinJSClass = utils.defineClass(
	_StorageInterfaceWinJS,
	storageInterface.StorageInterface, {
		init: function() {
			var useTestDatabase = globals.isTestEnvironment();
			return winjs.callWinJS("winjsDB", "init", {
				useTestDatabase: useTestDatabase
			});
		},

		queryAppConfigs: function() {
			return winjs.callWinJS("winjsDB", "queryAppConfigs", {});
		},

		createAppConfig: function(data) {
			return winjs.callWinJS("winjsDB", "createAppConfig", {
				app: data
			});
		},

		readAppConfig: function(appid) {
			return winjs.callWinJS("winjsDB", "readAppConfig", {
				appid: appid
			});
		},

		deleteAppConfig: function(appid) {
			return winjs.callWinJS("winjsDB", "deleteAppConfig", {
				appid: appid
			});
		}
	}
);

exports.StorageInterface = _storageInterfaceWinJSClass;
exports.isAvailable = function() {
	return winjs.isAvailable();

};
});

define('syracuse-tablet/html/js/storage/storageWebSQL',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/storage/storageInterface','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

/*
 * WebSQL storage interface (Chrome, Safari)
 */

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var storageInterface = require('syracuse-tablet/html/js/storage/storageInterface');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("webSQL");

//Increase this number to upgrade database to schema described in _objectStores
var _databaseVersion = 16;

var _tables = [
	// meta data table for handling etags, ttl, size, ..
	"DROP TABLE IF EXISTS sdata_meta",
	"CREATE TABLE sdata_meta ( " +
	"key text, " +
	"collection text, " +
	"endpoint text, " +
	"context text, " +
	"id text, " +
	"etag text, " +
	"last_read text, " +
	"last_updated text" +
	")",
	"DROP INDEX IF EXISTS sdata_meta_pk",
	"CREATE UNIQUE INDEX sdata_meta_pk ON sdata_meta (key, collection, endpoint, context)",
	"DROP INDEX IF EXISTS sdata_meta_id",
	"CREATE UNIQUE INDEX sdata_meta_id ON sdata_meta (id)",
	// data table
	"DROP TABLE IF EXISTS sdata_objects",
	"CREATE TABLE sdata_objects ( " +
	"id text, " +
	"data text " +
	")",
	"DROP INDEX IF EXISTS sdata_objects_pk",
	"CREATE UNIQUE INDEX sdata_objects_pk ON sdata_objects (id)"
];

function _StorageInterfaceWebSQL() {
	this.infoString = "WebSQL storage interface";
	this.databaseVersion = _databaseVersion;
	this.databaseName = storageInterface.databaseName;
	this.useTestDatabase = false;
	this.databaseSize = 2 * 1024 * 1024;
	this.db = null;
};

var _storageInterfaceWebSQLClass = utils.defineClass(
	_StorageInterfaceWebSQL,
	storageInterface.StorageInterface, {
		init: function() {
			var deferred = $.Deferred();
			var self = this;
			var useTestDatabase = globals.isTestEnvironment();
			self.databaseName = storageInterface.databaseName + "-test";
			self.useTestDatabase = useTestDatabase;
			try {
				self._openDB().then(function(status) {
					deferred.resolve(status);
				}, function(status) {
					deferred.reject(status);
				});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database", e));
			} finally {
				return deferred.promise();
			}
		},
		put: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("PUT: ", JSON.stringify(opts));

				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var context = JSON.stringify(opts.$context);
				var params = [opts.$key, opts.$collection, opts.$endpoint, context];

				var insertData = function(metaData) {
					self._executeSql("INSERT INTO sdata_objects (data, id) values (?, ?)", [JSON.stringify(opts.$data), metaData.$id])
						.then(function() {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, opts.$data));
						}, function(status) {
							deferred.reject(status);
						});
				};

				var updateData = function(metaData) {
					self._executeSql("UPDATE sdata_objects set data = ? where id = ?", [JSON.stringify(opts.$data), metaData.$id])
						.then(function(result) {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, opts.$data));
						}, function(status) {
							deferred.reject(status);
						});
				};

				// handle meta data
				self._readMetaData(context, params)
					.then(function(metaData) {
						if (metaData && metaData.$etag === opts.$data.$etag) {
							// record has not changed
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, opts.$data));
						} else if (metaData) {
							// update
							metaData.$etag = opts.$data.$etag;
							metaData.$lastUpdated = utils.getCurISODateTime();
							self._writeMetaData(metaData)
								.then(function() {
									updateData(metaData);
								}, function(status) {
									deferred.reject(status);
								});
						} else {
							// insert
							metaData = {
								$key: opts.$key,
								$collection: opts.$collection,
								$endpoint: opts.$endpoint,
								$context: opts.$context,
								$etag: opts.$data.$etag,
								$lastUpdated: utils.getCurISODateTime()
							};
							self._writeMetaData(metaData)
								.then(function(metaData) {
									insertData(metaData);
								}, function(status) {
									deferred.reject(status);
								});
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database", e));
			} finally {
				return deferred.promise();
			}
		},

		read: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("READ: ", JSON.stringify(opts));

				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var context = JSON.stringify(opts.$context);
				var params = [opts.$key, opts.$collection, opts.$endpoint, context];

				self._readMetaData(context, params)
					.then(function(metaData) {
						if (!metaData) {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
						} else {
							self._executeSql("SELECT * FROM sdata_objects where id = ?", [metaData.$id])
								.then(function(result) {
									try {
										if (result.rows.length <= 0) {
											deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
										} else {
											deferred.resolve(storageInterface.buildResult(
												storageInterface.StatusCodes.OK,
												JSON.parse(result.rows.item(0).data),
												null,
												null, {
													$lastRead: metaData.$lastRead,
													$lastUpdated: metaData.$lastUpdated
												}));
										}
									} catch (e) {
										deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
									}
								}, function(status) {
									deferred.reject(status);
								});
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		query: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("QUERY: ", JSON.stringify(opts));

				if (!opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var context = JSON.stringify(opts.$context);
				var params = [opts.$collection, opts.$endpoint, context];

				self._executeSql("SELECT o.*, m.last_read, m.last_updated FROM sdata_objects o INNER JOIN sdata_meta m ON (o.id = m.id and m.collection = ? and m.endpoint = ? and m.context = ?)", params)
					.then(function(result) {
						var ret = [];
						var meta = [];
						try {
							for (var i = 0; i < result.rows.length; i++) {
								var item = result.rows.item(i);
								ret.push(JSON.parse(item.data));
								meta.push({
									$lastRead: item.last_read,
									$lastUpdated: item.last_updated
								});
							}
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, ret, null, null, meta));
						} catch (e) {
							deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		remove: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("REMOVE: ", JSON.stringify(opts));

				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var context = JSON.stringify(opts.$context);
				var params = [opts.$key, opts.$collection, opts.$endpoint, context];
				self._removeMetaData(context, params)
					.then(function(metaData) {
						if (!metaData) {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
						} else {
							self._executeSql("DELETE FROM sdata_objects where id = ?", [metaData.$id])
								.then(function() {
									deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
								}, function(status) {
									deferred.reject(status);
								});
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database", e));
			} finally {
				return deferred.promise();
			}
		},
		clearCollection: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("CLEAR: ", JSON.stringify(opts));

				if (!opts.$collection || !opts.$context)
					throw new Error("Insufficient parameters");

				var context = JSON.stringify(opts.$context);
				var params = [context];

				self._executeSql("SELECT * FROM sdata_meta where context = ?", params)
					.then(function(result) {
						var ret = [];
						try {
							for (var i = 0; i < result.rows.length; i++) {
								var item = result.rows.item(i);
								if (opts.$collection.test(item.collection)) {
									ret.push({
										$context: opts.$context,
										$collection: item.collection,
										$endpoint: item.endpoint,
										$key: item.key
									});
								}
							}
							ret.forEachPromise(function(item) {
								return self.remove(item);
							}).then(function() {
								deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
							}, function(e) {
								deferred.reject(e);
							});
						} catch (e) {
							deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		_readMetaData: function(context, params, noUpdate) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				self._executeSql("SELECT * FROM sdata_meta where key = ? and collection = ? and endpoint = ? and context = ?", params)
					.then(function(result) {
						try {
							if (result.rows.length <= 0) {
								deferred.resolve(null);
							} else {
								var item = result.rows.item(0);
								var metaData = {
									$key: item.key,
									$collection: item.collection,
									$endpoint: item.endpoint,
									$context: item.context,
									$id: item.id,
									$etag: item.etag,
									$lastRead: item.last_read,
									$lastUpdated: item.last_updated
								};
								if (noUpdate === true) {
									deferred.resolve(metaData);
								} else {
									self._writeMetaData(metaData)
										.then(function() {
											// allways resolve and ignore errors
											deferred.resolve(metaData);
										});
								}
							}
						} catch (e) {
							deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		_writeMetaData: function(metaData) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				metaData.$lastRead = utils.getCurISODateTime();
				if (!metaData.$id) {
					metaData.$id = utils.UUID();

					self._executeSql("INSERT INTO sdata_meta (key, collection, endpoint, context, id, etag, last_read, last_updated) values (?, ?, ?, ?, ?, ?, ?, ?)", [
						metaData.$key,
						metaData.$collection,
						metaData.$endpoint,
						JSON.stringify(metaData.$context),
						metaData.$id,
						metaData.$etag,
						metaData.$lastRead,
						metaData.$lastUpdated
					])
						.then(function() {
							deferred.resolve(metaData);
						}, function(status) {
							deferred.reject(status);
						});
				} else {
					self._executeSql("UPDATE sdata_meta set etag = ?, last_read = ?, last_updated = ? where id = ?", [metaData.$etag, metaData.$lastRead, metaData.$lastUpdated, metaData.$id])
						.then(function(result) {
							deferred.resolve(metaData);
						}, function(status) {
							deferred.reject(status);
						});
				}
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing meta data", e));
			} finally {
				return deferred.promise();
			}
		},

		_removeMetaData: function(context, params) {
			var deferred = $.Deferred();
			var self = this;
			try {
				self._readMetaData(context, params, true)
					.then(function(metaData) {
						if (!metaData) {
							deferred.resolve(null);
						} else {
							self._executeSql("DELETE FROM sdata_meta where id = ?", [metaData.$id])
								.then(function() {
									deferred.resolve(metaData);
								}, function(status) {
									deferred.reject(status);
								});
						}
					}, function(status) {
						deferred.reject(status);
					});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},
		_executeSql: function(sql, params) {
			var deferred = $.Deferred();
			var self = this;
			try {
				self.db.transaction(function(tx) {
					try {
						log && log("SQL: " + sql);
						log && log(params);
						tx.executeSql(sql, params, function(tx, result) {
							deferred.resolve(result);
						}, function(tx, error) {
							deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database: " + _errorToMessage(tx, error)));
						});
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error running SQL statement", e));
					}
				});
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error running SQL statement", e));
			}
			return deferred.promise();
		},

		/*
		 *
		 * Database migration functions
		 *
		 */
		_openDB: function() {
			var deferred = $.Deferred();
			var self = this;
			if (self.useTestDatabase === false && self.db) {
				deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
			}

			var request;
			try {
				log && log("Open database, request version: " + self.databaseVersion);
				self.db = openDatabase(self.databaseName, 7, 'Database', self.databaseSize);
				self._readCurrentVersion().then(function(version) {
					log && log("Current version: " + version);
					// In test framework create DB every time
					if (version === self.databaseVersion && self.useTestDatabase !== true) {
						deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
					} else {
						self._createTables().then(function(status) {
							return self._writeCurrentVersion();
						}).then(function(status) {
							deferred.resolve(status);
						}, function(status) {
							deferred.reject(status);
						});
					}
				}, function(status) {
					deferred.reject(status);
				});

			} catch (e) {
				log && log("Open database, exception", e);
				self.db = null;
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database", e));
			}

			return deferred.promise();
		},
		_readCurrentVersion: function() {
			var deferred = $.Deferred();
			var self = this;
			self._executeSql('SELECT version FROM version', null).then(function(result) {
				try {
					var len = result.rows.length;
					if (len === 1) {
						var version = result.rows.item(0).version;
						log && log("Read version: " + version);
						deferred.resolve(+version);
					}
					deferred.resolve(-1);
				} catch (e) {
					deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading database version", e));
				}
			}, function(status) {
				// Asume table does not exist, create it
				log && log("Creating version table");
				self._executeSql('CREATE TABLE version (version TEXT)').then(function(status) {
					deferred.resolve(-1);
				}, function(status) {
					deferred.reject(status);
				});
			});
			return deferred.promise();
		},
		_writeCurrentVersion: function() {
			var deferred = $.Deferred();
			var self = this;
			self._executeSql('DELETE FROM version', null)
				.then(function(result) {
					return self._executeSql('INSERT INTO version (version) values (?)', [_databaseVersion]);
				})
				.then(function(status) {
					deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
				}, function(status) {
					deferred.reject(status);
				});
			return deferred.promise();
		},
		_createTables: function() {
			var deferred = $.Deferred();
			var self = this;
			var p = [];
			for (var i = 0; i < _tables.length; i++) {
				p.push(self._executeSql(_tables[i]));
			}
			$.when.apply($, p).then(function() {
				deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
			}, function(status) {
				deferred.reject(status);
			});
			return deferred.promise();
		}
	}
);

function _errorToMessage(tx, error) {
	return "CODE: " + error.code + " MESSAGE: " + error.message;
}
exports.StorageInterface = _storageInterfaceWebSQLClass;
exports.isAvailable = function() {
	return (window.openDatabase != null);
};
});

define('syracuse-tablet/html/js/storage/storageIndexedDB',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/storage/storageInterface','syracuse-tablet/html/js/helpers/logger'],function (require, exports, module) {

/*
 * IndexDB storage interface (Internet Explorer, Firefox)
 */

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var storageInterface = require('syracuse-tablet/html/js/storage/storageInterface');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("indexedDB");

var _indexedDB = window.indexedDB || window.webkitIndexedDB;
var IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction;
var IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange;
var IDBDatabaseException = window.IDBDatabaseException || window.webkitIDBDatabaseException;

var READ_ONLY = (IDBTransaction && IDBTransaction.READ_ONLY) || "readonly";
var READ_WRITE = (IDBTransaction && IDBTransaction.READ_WRITE) || "readwrite";


// Increase this number to upgrade database to schema described in _objectStores
var _databaseVersion = 11;

var _objectStores = {
	"sdata": {
		"options": {
			"autoIncrement": true
		},
		"indexes": {
			"read_write_one": {
				"key": "key_collection_endpoint_context",
				"options": {
					"unique": true
				}
			},
			"read_write_all": {
				"key": "collection_endpoint_context",
				"options": {
					"unique": false
				}
			},
			"read_write_ctx": {
				"key": "context",
				"options": {
					"unique": false
				}
			}
		}
	}
};

function _StorageInterfaceIndexedDB() {
	this.infoString = "IndexedDB storage interface";
	this.databaseVersion = _databaseVersion;
	this.databaseName = storageInterface.databaseName;
	this.useTestDatabase = false;
	this.db = null;
};

var _storageInterfaceIndexedDBClass = utils.defineClass(
	_StorageInterfaceIndexedDB,
	storageInterface.StorageInterface, {

		init: function(requester) {
			requester = requester || "";
			log && log("_INIT " + requester);
			var deferred = $.Deferred();
			var self = this;
			var useTestDatabase = globals.isTestEnvironment();
			try {
				var _doInit = function() {
					log && log("DATABASE INIT!");
					self._openDB().then(function(status) {
						log && log("_openDB OK " + requester);
						deferred.resolve(status);
					}, function(status) {
						log && log("_openDB KO " + requester);
						deferred.resolve(status);
					});
				};
				if (useTestDatabase === true) {
					if (self.db) {
						self.db.close();
						self.db = null;
					}
					self.useTestDatabase = true;
					self.databaseName = storageInterface.databaseName + "-test";
					log && log("DATABASE IN TEST MODE! " + requester);
					var req = _indexedDB.deleteDatabase(self.databaseName);
					req.onsuccess = function() {
						_doInit();
					};
					req.onerror = function(e) {
						log && log("REQUEST ERROR! " + requester);
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error deleting database"));
					};
					req.onblocked = function(e) {
						log && log("REQUEST BLOCKED! " + requester);
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error deleting database (blocked)"));
					};
				} else if (!self.db) {
					_doInit();
				}
			} catch (e) {
				log && log("init ERROR " + requester);
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database", e));
			} finally {
				return deferred.promise();
			}
		},

		put: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("PUT: ", JSON.stringify(opts));
				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var tx = db.transaction(["sdata"], READ_WRITE);
				var objectStore = tx.objectStore("sdata");
				var context = JSON.stringify(opts.$context);

				var key = [opts.$key, opts.$collection, opts.$endpoint, context].join("_");

				var index = objectStore.index("read_write_one");
				var keyRange = IDBKeyRange.only(key);
				var request = index.openCursor(keyRange);
				var mustInsert = true;
				var datetime = utils.getCurISODateTime();
				var doInsert = function() {
					var obj = {
						"context": context,
						"collection": opts.$collection,
						"endpoint": opts.$endpoint,
						"key": opts.$key,
						"last_updated": datetime,
						"last_read": datetime,
						"key_collection_endpoint_context": key,
						"collection_endpoint_context": [opts.$collection, opts.$endpoint, context].join("_"),
						"data": opts.$data,
					};

					var reqt = objectStore.add(obj);
					reqt.onerror = function(event) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database: " + _eventToMessage(event)));
					};
					reqt.onsuccess = function(event) {
						deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, opts.$data));
					};
				};
				request.onsuccess = function(event) {
					try {
						var cr = event.target.result;
						if (cr) {
							if (opts.$data.$etag) {
								var etag = cr.value && cr.value.data.$etag;
								if (etag === opts.$data.$etag) {
									deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK, opts.$data));
									return;
								}
							}
							cr["delete"]();
							cr["continue"]();
						} else {
							doInsert();
						}
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database", e));
					}
				};
				request.onerror = function(event) {
					if (event.target.errorCode == IDBDatabaseException.NOT_FOUND_ERR) {
						doInsert();
					} else {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database: " + _eventToMessage(event)));
					}
				};
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error writing to database", e));
			} finally {
				return deferred.promise();
			}
		},

		read: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("READ: ", JSON.stringify(opts));
				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");
				var tx = db.transaction(["sdata"], READ_WRITE);
				var objectStore = tx.objectStore("sdata");
				var context = JSON.stringify(opts.$context);
				var key = [opts.$key, opts.$collection, opts.$endpoint, context].join("_");

				var index = objectStore.index("read_write_one");
				var keyRange = IDBKeyRange.only(key);
				var request = index.openCursor(keyRange);

				request.onsuccess = function(event) {
					try {
						var cr = event.target && event.target.result && event.target.result.value;
						if (!cr) {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
						} else {
							deferred.resolve(storageInterface.buildResult(
								storageInterface.StatusCodes.OK,
								cr.data,
								null,
								null, {
									$lastRead: cr.last_read,
									$lastUpdated: cr.last_updated
								}));
						}
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
					}
				};
				request.onerror = function(event) {
					if (event.target.errorCode == IDBDatabaseException.NOT_FOUND_ERR) {
						// Resolve since it's a logical issue and not neccessarily an error
						deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
					} else {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database: " + _eventToMessage(event)));
					}
				};
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		query: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("QUERY: ", JSON.stringify(opts));
				if (!opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var tx = db.transaction(["sdata"], READ_WRITE);
				var objectStore = tx.objectStore("sdata");
				var context = JSON.stringify(opts.$context);

				var key = [opts.$collection, opts.$endpoint, context].join("_");

				var index = objectStore.index("read_write_all");
				var keyRange = IDBKeyRange.only(key);
				var request = index.openCursor(keyRange);
				var results = [];
				var meta = [];

				request.onsuccess = function(event) {
					try {
						var cr = event.target.result;
						if (cr) {
							var data = cr.value.data;
							results.push(data);
							meta.push({
								$lastRead: cr.last_read,
								$lastUpdated: cr.last_updated
							});
							cr["continue"]();
						} else {
							deferred.resolve(storageInterface.buildResult(
								storageInterface.StatusCodes.OK,
								results,
								null,
								null,
								meta));
						}
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
					}
				};
				request.onerror = function(event) {
					if (event.target.errorCode == IDBDatabaseException.NOT_FOUND_ERR) {
						// Resolve since it's a logical issue and not neccessarily an error
						deferred.resolve(storageInterface.buildResult(
							storageInterface.StatusCodes.OK,
							results,
							null,
							null,
							meta));
					} else {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database: " + _eventToMessage(event)));
					}
				};
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		remove: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("REMOVE: ", JSON.stringify(opts));
				if (!opts.$key || !opts.$collection || !opts.$endpoint || !opts.$context)
					throw new Error("Insufficient parameters");

				var tx = db.transaction(["sdata"], READ_WRITE);
				var objectStore = tx.objectStore("sdata");
				var context = JSON.stringify(opts.$context);

				var key = [opts.$key, opts.$collection, opts.$endpoint, context].join("_");

				var index = objectStore.index("read_write_one");
				var keyRange = IDBKeyRange.only(key);
				var request = index.openCursor(keyRange);

				request.onsuccess = function(event) {
					try {
						var cr = event.target.result;
						if (cr) {
							cr["delete"]();
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
						} else {
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
						}
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error deleting from database", e));
					}
				};
				request.onerror = function(event) {
					if (event.target.errorCode == IDBDatabaseException.NOT_FOUND_ERR) {
						// Resolve since it's a logical issue and not neccessarily an error
						deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.NOT_FOUND));
					} else {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database: " + _eventToMessage(event)));
					}
				};
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error deleting from database", e));
			} finally {
				return deferred.promise();
			}
		},

		clearCollection: function(opts) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var db = self.db;
				log && log("CLEAR: ", JSON.stringify(opts));
				var tx = db.transaction(["sdata"], READ_WRITE);
				var objectStore = tx.objectStore("sdata");
				var context = JSON.stringify(opts.$context);

				var key = context;

				var index = objectStore.index("read_write_ctx");
				var keyRange = IDBKeyRange.only(key);
				var request = index.openCursor(keyRange);
				var records = [];

				var deleteMatches = function() {
					records.forEachPromise(function(rec) {
						return self.remove({
							$context: opts.$context,
							$collection: rec.collection,
							$endpoint: rec.endpoint,
							$key: rec.key
						});
					}).then(function() {
						deferred.resolve();
					}, function(e) {
						deferred.reject(e);
					});
				};
				request.onsuccess = function(event) {
					try {
						var cr = event.target.result;
						if (cr) {
							if (opts.$collection.test(cr.value.collection)) {
								records.push(cr.value);
							}
							cr["continue"]();
						} else {
							deleteMatches();
						}
					} catch (e) {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
					}
				};
				request.onerror = function(event) {
					if (event.target.errorCode == IDBDatabaseException.NOT_FOUND_ERR) {
						deleteMatches();
					} else {
						deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database: " + _eventToMessage(event)));
					}
				};
			} catch (e) {
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error reading from database", e));
			} finally {
				return deferred.promise();
			}
		},

		_openDB: function() {
			var deferred = $.Deferred();
			var self = this;
			if (self.useTestDatabase === false && self.db) {
				deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
			}

			var request;
			try {
				log && log("Open database, request version: " + self.databaseVersion);
				request = _indexedDB.open(self.databaseName, self.databaseVersion);
				request.onupgradeneeded = function(e) {
					log && log("Open database, need upgrade");
					self.db = (e.target.result || e.target.source);
					self._createObjectStore();
				};
				request.onsuccess = function(e) {
					log && log("Open database, success");
					var db = (e.target.result || e.target.source);
					if (!db.setVersion && (self.databaseVersion != db.version)) {
						log && log("Open database, versions missmatch: " + self.DatabaseVersion + " != " + db.version);
						var sdv = db.setVersion(self.databaseVersion);
						sdv.onsuccess = function(e) {
							log && log("Open database, setting version, success");
							self.db = db;
							self._createObjectStore();
							log && log("Open database, opened");
							deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
						};
						sdv.onerror = function(e) {
							log && log("Open database, setting version, error", e);
							self.db = null;
							deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database: " + _eventToMessage(e)));
						};
					} else {
						log && log("Open database, opened");
						self.db = db;
						deferred.resolve(storageInterface.buildResult(storageInterface.StatusCodes.OK));
					}
				};
				request.onerror = function(e) {
					log && log("Open database, error", e);
					self.db = null;
					deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database: " + _eventToMessage(e)));
				};
			} catch (ex) {
				log && log("Open database, exception", ex);
				self.db = null;
				deferred.reject(storageInterface.buildResult(storageInterface.StatusCodes.ERROR, null, "error initializing database", ex));
			}

			return deferred.promise();
		},

		// Create schema of database on version change
		_createObjectStore: function() {
			var self = this;
			var db = self.db;
			log && log("Updating database");
			Object.keys(_objectStores).forEach(function(name) {
				var os = _objectStores[name];
				if (db.objectStoreNames.contains(name)) {
					log && log("Deleting objectStore: " + name);
					db.deleteObjectStore(name);
				}

				log && log("Creating objectStore: " + name);
				var obj = db.createObjectStore(name, os.options);
				Object.keys(os.indexes).forEach(function(iname) {
					var idx = os.indexes[iname];
					log && log("Creating index: " + iname);
					obj.createIndex(iname, idx.key, idx.options);
				});
			});
		}
	}
);

function _eventToMessage(event) {
	return JSON.stringify(event);
}

exports.StorageInterface = _storageInterfaceIndexedDBClass;
exports.isAvailable = function() {
	return (_indexedDB != null);
};
});

define('syracuse-tablet/html/js/storage/storage',['require','exports','module','syracuse-tablet/html/js/storage/storageInterface','syracuse-tablet/html/js/storage/storageWinJS','syracuse-tablet/html/js/storage/storageWebSQL','syracuse-tablet/html/js/storage/storageIndexedDB'],function (require, exports, module) {

/*
 * Storage module (Selects implementation depending on what's available in the current browser
 */

var storageInterface = require('syracuse-tablet/html/js/storage/storageInterface');

var _impls = [
	require('syracuse-tablet/html/js/storage/storageWinJS'),
	require('syracuse-tablet/html/js/storage/storageWebSQL'),
	require('syracuse-tablet/html/js/storage/storageIndexedDB')
];

var _storageImpl;

// Choose the first supported storage engine
function _getStorageImpl() {
	if (_storageImpl) {
		return _storageImpl;
	}

	_impls.some(function(impl) {
		if (impl.isAvailable()) {
			var ctor = impl.StorageInterface;
			_storageImpl = new ctor();
			return true;
		}
		return false;
	});

	return _storageImpl;
}

exports.getStorage = _getStorageImpl;
exports.StatusCodes = storageInterface.StatusCodes;
});

define('syracuse-tablet/html/js/application/settings',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/storage/storage','syracuse-tablet/html/js/sdata/sdataCommonResources','syracuse-tablet/html/js/sdata/entities/clientContract'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var storageModule = require('syracuse-tablet/html/js/storage/storage');
var sdataCommonRes = require('syracuse-tablet/html/js/sdata/sdataCommonResources');

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');

exports.getMyApplications = function() {
	var deferred = $.Deferred();
	var ctx = globals.getCacheCtx();
	var storage = globals.getStorage();

	var prefix = globals.getCache().cachePrefix;

	function appendClientApps(apps) {
		var clientApps = clientContract.getApps();
		clientApps.forEach(function(app) {
			apps.push(app);
		});
	};

	storage.read({
		$context: ctx,
		$collection: prefix + "$settings",
		$endpoint: "$local",
		$key: "MyApps"
	})
		.then(function(result) {
			if (result.$status === storageModule.StatusCodes.OK) {
				var apps = result.$data;
				appendClientApps(apps);
				deferred.resolve(apps);
			} else {
				// no config found
				sdataCommonRes.queryMyApplications()
					.then(function(apps) {
						return _storeMyApplications(apps);
					}, function(e) {
						deferred.reject(e);
					})
					.then(function(apps) {
						appendClientApps(apps);
						deferred.resolve(apps);
					}, function(e) {
						deferred.reject(e);
					});
			}
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
};

function _storeMyApplications(apps) {
	var deferred = $.Deferred();
	var ctx = globals.getCacheCtx();
	var storage = globals.getStorage();
	var prefix = globals.getCache().cachePrefix;

	storage.put({
		$context: ctx,
		$collection: prefix + "$settings",
		$endpoint: "$local",
		$key: "MyApps",
		$data: apps
	})
		.then(function(result) {
			deferred.resolve(apps);
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
}

exports.getMyApplicationDetail = function(appHeader) {
	var deferred = $.Deferred();
	var ctx = globals.getCacheCtx();
	var storage = globals.getStorage();
	var prefix = globals.getCache().cachePrefix;

	// No meta data url, so it's a client side application
	if (!appHeader.$metaDataUrl) {
		var app = clientContract.getAppDetail(appHeader.applicationName);
		if (app) {
			deferred.resolve(app);
		} else {
			deferred.reject("Application not found: " + appHeader.applicationName);
		}
	} else {
		storage.read({
			$context: ctx,
			$collection: prefix + "$settings",
			$endpoint: "$local",
			$key: "MyApp_" + appHeader.applicationName
		})
			.then(function(result) {
				if (result.$status === storageModule.StatusCodes.OK) {
					deferred.resolve(result.$data);
				} else {
					// no config found
					sdataCommonRes.queryMyApplicationDetail(appHeader)
						.then(function(apps) {
							return _storeMyApplicationDetail(apps);
						})
						.then(function(apps) {
							deferred.resolve(apps);
						}, function(e) {
							deferred.reject(e);
						});
				}
			}, function(e) {
				deferred.reject(e);
			});
	}
	return deferred.promise();
};

function _storeMyApplicationDetail(app) {
	var deferred = $.Deferred();
	var ctx = globals.getCacheCtx();
	var storage = globals.getStorage();
	var prefix = globals.getCache().cachePrefix;

	storage.put({
		$context: ctx,
		$collection: prefix + "$settings",
		$endpoint: "$local",
		$key: "MyApp_" + app.$application.applicationName,
		$data: app
	})
		.then(function(result) {
			deferred.resolve(app);
		}, function(e) {
			deferred.reject(e);
		});
	return deferred.promise();
}
});

define('syracuse-tablet/html/js/pages/html/pageDefHome',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/pages/html/pageHtml','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/notifications','syracuse-tablet/html/js/application/settings','syracuse-tablet/html/js/pages/html/pageTemplates'],function (require, exports, module) {
/**
 * Default Home page that is display if there's no current mobile application
 * User can select an application or logout
 */
var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Base = require('syracuse-tablet/html/js/pages/html/pageHtml').Page;
var modal = require('syracuse-tablet/html/js/ui/modal');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var settings = require('syracuse-tablet/html/js/application/settings');
var pageTemplates = require('syracuse-tablet/html/js/pages/html/pageTemplates');

var _tmplCtx = {
	header: {
		"title": "Sage X3 Mobile Home Page",
		"logout": "logout"
	},
	content: {
		"btnendpoint": "Change endpoint",
		"title": "Home page",
		"listtitle": "Please select an application",
		"labelendpoint": "Default endpoint is ",
		"listcontent": ""
	}
};
var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
	}, Base, {

		loadData: function() {
			var self = this;
			var deferred = $.Deferred();
			settings.getMyApplications().then(function(data) {
				self.appList = data || [];
				deferred.resolve();
			}, function(e) {
				deferred.reject(e);
			});
			return deferred.promise();
		},

		buildHtml: function() {
			var self = this;
			var html = [];
			if (self.appList) {
				self.appList.forEach(function(x) {
					html.push('<li><a href="#" data-action="select" data-params="');
					html.push(x.$uuid);
					html.push('">');
					html.push(x.title || x.description);
					html.push('&nbsp;&nbsp;&nbsp;<span class="label label-primary">');
					html.push(x.applicationName);
					html.push('</span>');
					html.push('</a></li>');
				});
			}
			var ctxContent = $.extend({}, _tmplCtx.content);
			ctxContent.listcontent = html.join('');
			ctxContent.endpoint = globals.getEndpoint() || "No endpoint defined";
			return Base.prototype.buildHtmlTpl.call(this, ctxContent, _tmplCtx.header);
		},

		_actSelect: function(uuid) {
			var self = this;
			self.waitWheelStart();
			var info;
			self.appList.some(function(x) {
				if (x.$uuid === uuid) {
					info = x;
					return true;
				}
			});
			settings.getMyApplicationDetail(info).then(function(data) {
				self.deactivate(null);
				notifications.publish("sm.switch.app", data);
				self.waitWheelStop();
			}, function(e) {
				self.waitWheelStop();
				modal.error("Error loading application", e);
			});
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/pages/html/pageLogin',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/pages/page','syracuse-tablet/html/js/application/authentication','syracuse-tablet/html/js/helpers/notifications'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/page').Page;
var auth = require('syracuse-tablet/html/js/application/authentication');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var _pageContext = {
	"label_user": "User name",
	"value_user": "Enter some text",
	"label_password": "Password",
	"value_password": "Enter some text",
	"title": "Login page",
	"act_login": "Login"
};

var _pageTemplate = '\
	<div class="container">\
		<div class="row">\
			<div class="col-md-3"></div>\
			<div class="col-md-6">\
				<div class="well">\
					<div class="form-group">\
						<label>{{label_user}}</label>\
						<input type="text" value="" class="form-control" placeholder="{{label_user}}"	id="login-user">\
					</div>\
					<div class="form-group">\
						<label>{{label_password}}</label>\
						<input type="password" class="form-control" placeholder="{{label_password}}" id="login-password">\
					</div>\
					<button id="login-login" data-action="login" type="button" class="btn btn-primary">{{act_login}}</button>\
				</div>\
			</div>\
		</div>\
		<div class="row">\
			<div class="col-md-3"></div>\
			<div class="col-md-6">\
				<div id="login-success" style="display: none" class="alert alert-success" role="alert"></div>\
				<div id="login-fail" style="display: none" class="alert alert-danger" role="alert"></div>\
			</div>\
		</div>\
	</div>';

var lang;
var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
	}, Base, {
		loadStructure: function() {
			return $.smResolve();
		},

		render: function() {
			var self = this;
			var deferred = $.Deferred();
			_pageContext.reason = self.getProp("reason") || "";

			var template = Handlebars.compile(_pageTemplate);
			var html = template(_pageContext);
			var cc = self.$$contentElmt;
			cc.html(html);
			deferred.resolve();
			return deferred.promise();
		},

		_actLogin: function() {
			var self = this;
			var deferred = $.Deferred();
			var askDlog = false;
			try {
				var $$success = self.$$elmt.find("#login-success").hide();
				var $$fail = self.$$elmt.find("#login-fail").hide();
				var usr = self.$$elmt.find("#login-user").val();
				var pwd = self.$$elmt.find("#login-password").val();
				var locale = self.$$elmt.find("#login-locale").val();
				var userProfile = null;
				self.waitWheelStart();
				// TODO: Locale needs to be sent to server to get messages etc. in correct language
				auth.login(usr, pwd)
					.then(function(ok, syraUsrProfile, message) {
						if (ok) {
							userProfile = syraUsrProfile;
							return $.smResolve();
						} else {
							return $.smReject(message);
						}
					})
					.then(function() {
						self.waitWheelStop();
						notifications.publish("sm.login", userProfile);
					}, function(e) {
						var stack, message;
						if (utils.isError(e)) {
							message = e.message;
							stack = utils.cleanStack(e.stack, 3, true);
						} else {
							message = e;
						}
						$$fail.show().html("Login failed<p>" + message + "</p>" + (stack ? stack : ""));
						self.waitWheelStop();
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/pages/html/pageSettings',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/pages/html/pageHtml','syracuse-tablet/html/js/pages/html/pageTemplates','syracuse-tablet/html/js/helpers/notifications','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/application/settings'],function (require, exports, module) {

/**
 * Settings page
 * temporarily - This page will be build with a $article/$prototype
 *
 */
var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Base = require('syracuse-tablet/html/js/pages/html/pageHtml').Page;
var pageTemplates = require('syracuse-tablet/html/js/pages/html/pageTemplates');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var modal = require('syracuse-tablet/html/js/ui/modal');
var settings = require('syracuse-tablet/html/js/application/settings');

var _tmplCtx = {
	header: {
		"pageId": "login",
		"headerttl": "Sage X3 Mobile Login Page",
		"forgotpwd": "Forgot password"
	},
	content: {
		"listtitle": "Select an application to install"
	}
};

var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
		self.appList = null;
	}, Base, {

		loadData: function() {
			var self = this;
			var deferred = $.Deferred();
			settings.getMyApplications().then(function(data) {
				self.appList = data || [];
				deferred.resolve();
			}, function(e) {
				deferred.reject(e);
			});
			return deferred.promise();
		},

		buildHtmlContent: function() {
			var self = this;
			var deferred = $.Deferred();
			try {
				var html = [];
				if (self.appList) {
					var curApp = globals.getApplication();
					self.appList.forEach(function(x) {
						html.push('<option value="');
						html.push(x.$uuid);
						html.push('" ');
						html.push(curApp && curApp.uuid == x.$uuid ? "selected" : "");
						html.push(' >');
						html.push(x.title || x.description);
						html.push(' (' + x.applicationName + ')');
						html.push('</option>');
					});
				}
				_tmplCtx.content.listcontent = html.join('');
				Base.prototype.buildHtmlContent.call(self, _tmplCtx.content).then(function(content) {
					deferred.resolve(content);
				}, function(e) {
					pageTemplates.resolveError(deferred, self.state.name, e);
				});
			} catch (e) {
				pageTemplates.resolveError(deferred, self.state.name, e);
			} finally {
				return deferred.promise();
			}
		},

		afterRender: function() {
			var self = this;
			Base.prototype.afterRender.call(self);
			self.$$elmt.find('.selectpicker').selectpicker();
		},

		_actSelect: function(uuid) {
			var self = this;
			var info;
			self.appList.some(function(x) {
				if (x.$uuid === uuid) {
					info = x;
					return true;
				}
			});
			settings.getMyApplicationDetail(info).then(function(data) {
				self.deactivate(null);
				notifications.publish("sm.switch.app", data);
			}, function(e) {
				modal.error("Error loading application", e);
			});
		}
	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/pages/html/pageAbout',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/pages/html/pageHtml'],function (require, exports, module) {

/**
 * About page
 * temporarily - This page will be build with a $article/$prototype
 *
 */
var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/pages/html/pageHtml').Page;

var _Page = utils.defineClass(
	function($parent, state) {
		var self = this;
		Base.call(self, $parent, state);
	}, Base, {

	});

exports.Page = _Page;
});

define('syracuse-tablet/html/js/helpers/prototype',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/application/gadget'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').log;
var Gadget = require('syracuse-tablet/html/js/application/gadget').Klass;

var _defMetaData = {
	"$isExcluded": false,
	"$isHidden": false,
	"isMandatory": false,
	"$isReadOnly": false,
	"$isDisabled": false
};
/**
 * Property of prototype that contains row index
 */
var _rowIdxProperty = "$ROWIDX";
var _rowIdxProto = null;
/**
 * getFieldNameForValue
 */
var _reg1 = /{[^}]+}/g,
	_reg2 = /[{}]/g;
/**
 * Prototype class
 * 	Provides all the method to deal with prototype
 * 	manage prototype chaining parent -> child
 * !!use Prototype methods instead of dealing directly with JSON
 */
var _Prototype = utils.defineClass(function(json, parent) {
	var self = this;
	self.json = json || {};
	if (typeof self.json == "string") {
		self.json = JSON.parse(self.json);
	}
	self._children = null;
	if (parent) {
		parent._appendChild(self);
		self.parent = parent;
	}
}, null, {
	destroy: function() {
		var self = this;
		self.parent = null;
		self.json = null;
		if (self._children) {
			self.children.forEach(function(c) {
				if (c) c.destroy();
			});
		}
		self._children = null;
	},
	/**
	 * For destroy
	 */
	_appendChild: function(child) {
		var self = this;
		if (!self._children) self._children = [];
		self._children.push(child);
	},
	/**
	 * returns json[prop]
	 */
	data: function(prop, dataContext) {
		var self = this;
		if (!prop || prop.length == 0) return null;
		var val = self.json[prop];
		if (val == null) {
			return self.parent ? self.parent.data(prop) : val;
		}
		return self._getVal(val, dataContext);
	},
	/**
	 * returns JSON for json.$properties[name]
	 * If prop!=null returns json.$properties[name][prop]
	 * dataContext: optional
	 */
	property: function(name, prop, dataContext) {
		var self = this;
		if (!name || name.length === 0) return null;
		var o = self.json.$properties ? self.json.$properties[name] : self.parent ? self.parent.property(name) : null;
		if (!o || !prop) return o;
		return self._getVal(o[prop], dataContext);
	},
	_getVal: function(val, dataContext) {
		if (val && val.indexOf && val.indexOf('{') >= 0) {
			val = utils.parseExpression(val, dataContext, this);
		}
		return val;
	},
	getMetaData: function(name) {
		var self = this;
		if (!self._metaData) self._metaData = {};
		var meta = self._metaData[name];
		if (meta) return meta;
		meta = self._metaData[name] = $.extend({}, _defMetaData, self.property(name));
		return meta;
	},
	localization: function(val) {
		var self = this;
		var loc = self.json.$localization || {};
		return loc[val] ? loc[val] : self.parent ? self.parent.localization(val) : null;
	},
	/**
	 * returns a prototype object for json.$properties[prop] or $item proto for grids
	 */
	getPrototype: function(prop) {
		if (prop === "$item") {
			var json = this.data(prop);
		} else {
			var json = this.property(prop);
		}
		return json ? exports.create($.extend({}, json), this) : null;
	},
	/**
	 * Query prototype
	 */
	isQuery: function() {
		if (this._isQuery != null) return this._isQuery;
		var url = this.data("$url");
		this._isQuery = url && url.smEndsWith("$query") ? true : false;
		return this._isQuery;
	},
	/**
	 * Lookup prototype
	 */
	isLookup: function() {
		if (this._isLookup != null) return this._isLookup;
		var url = this.data("$url");
		this._isLookup = url && url.smEndsWith("$lookup") ? true : false;
		return this._isLookup;
	},
	/**
	 * Format for display a value according to proto description
	 * Temporarily
	 */
	formatDisplay: function(prop, dataContext) {
		var self = this;
		var info = self.property(prop);

	},
	/**
	 * Temporarily - Add our own property - TODO Find another way
	 * 		Add row index in prototype for grids
	 */
	addProperty: function(name, descr) {
		var self = this;
		if (descr && self.json.$properties && !self.json.$properties[name]) {
			self.json.$properties[name] = descr;
		}
	},
	getPropTitle: function(propName) {
		var self = this;
		var prop = self.property(propName);
		return prop && prop.$title ? self._getVal(prop.$title) : "";

	},
	/**
	 * Returns the name of the field that contains the value ($refValue)
	 * 	For std type it returns name
	 * 	For reference type
	 * 		Set $refValue in prototype
	 * 		Set $lookupdescr - I don't remember if it will be used in tablet but I suppose - TODO remove if not used
	 * 		In mobile client this method was called after having loaded the prototype to calculated additionnal information needed by the client
	 */
	getFieldNameForValue: function(name) {
		var self = this;
		var protoField = self.property(name);
		if (!protoField) throw new Error("Field proto expected[" + name + "]");
		var item = protoField.$item;
		if (!item) return name;
		if (item.$refValue) return item.$refValue;
		item.$refValue = name;
		if (item.$value && typeof item.$value == "string") {
			var vals = item.$value.match(_reg1);
			if (vals && vals.length == 1) {
				// In X3 we expect only one param in $values -> "{CUR}"
				// v : must point to key of cd object - { $value:"{F1}", F1:"{F2}"} - F2 must be a field of cd parent
				var f1 = vals[0].replace(_reg2, "").trim();
				if (item.$properties && item.$properties[f1]) {
					// Field/Property that contains the value in data returned selection in lookup list
					item.$lookupvalue = f1;
				}
				if (item[f1]) {
					var f2 = item[f1].replace(_reg2, "").trim();
					if (self.property(f2)) {
						// Field that contains the value in the prototype - Same field in collaboration - Dedicated field in X3 :-(
						item.$refValue = f2;
					} // else field not found in parent keep $$refValue = property
				} // else item  key not found keep $refValue = property
			} else {
				log && log("!!! _getRefenceValue - Only one value is expected");
			}
		}
		// Copied from mobile client - TODO see if still useful
		// Add $lookupdescr which gives the field that contains $description 
		if (item.$description && item.$properties && typeof item.$description == "string") {
			var descrs = item.$description.match(_reg1);
			if (descrs && descrs.length == 1) {
				var fld = descrs[0].replace(_reg2, "").trim();
				if (item.$properties[fld]) {
					item.$lookupdescr = fld;
				}
			}
		}
		return item.$refValue;
	},
	getVignetteGadget: function() {
		var json = this.data("$gadget");
		return json ? new Gadget(json) : null;
	}
});
exports.rowIdxProperty = _rowIdxProperty;
exports.getRowIdxProto = function() {
	if (_rowIdxProto) return _rowIdxProto;
	_rowIdxProto = exports.create({
		$type: "application/x-integer"
	});
};
exports.create = function(json, parent) {
	return new _Prototype(json, parent);
};
});

define('syracuse-tablet/html/js/helpers/dashboardArticle',['require','exports','module'],function (require, exports, module) {

/**
 * Returns $article from dashBoard info
 * 		Calculates and Sets $article if no $article was found
 */
var _getDashboardArticle = function(dashInfo) {
	var nbCellsPerRow = 3;
	var _addWidth = function(json, nbCells, device) {
		if (nbCells <= 0 || nbCells > 12) throw new Error("Nb cells must be <= 12 (" + nbCells + ")");
		var prop = '$width' + (device || "md").smCapitalize();
		json[prop] = "";
		var sz = Math.round(12 / nbCells);
		for (var i = 0; i < nbCells; i++) {
			json[prop] += i === 0 ? sz : "," + sz;
		}
	};
	var vignetteIds = Object.keys(dashInfo.$vignettes || []);
	if (vignetteIds.length === 0) throw new Error('Dashboard ' + dashInfo.$dashboardName + ' has no vignette');
	if (!dashInfo.$article) {
		dashInfo.$article = {
			$layoutType: "stack",
			$items: []
		};
		/* Create an article with 3 vignettes per row*/
		var remainCells = vignetteIds.length;
		var nbRows = Math.ceil(vignetteIds.length / nbCellsPerRow),
			vgntIdx = 0;
		for (var ri = 0; ri < nbRows; ri++) {
			var row = {
				$layoutType: "row",
				displayOptions: {
					rowHeight: "300px"
				},
				$items: []
			};
			_addWidth(row, nbCellsPerRow);
			for (var ci = 0; ci < Math.min(nbCellsPerRow, remainCells); ci++) {
				row.$items.push({
					$bind: vignetteIds[vgntIdx]
				});
				vgntIdx++;
			}
			dashInfo.$article.$items.push(row);
		}
	}
	return dashInfo.$article;
};

exports.getDashboardArticle = _getDashboardArticle;
});

define('syracuse-tablet/html/js/helpers/prototypeParser',['require','exports','module'],function (require, exports, module) {

/**
 * Parses a JSON prototype and returns a default JSON $article
 *  	prototype: JSON
 */
var _proto2Article = function(prototype) {
	var props = prototype.$properties;
	var article = {
		$layoutType: "stack",
		$items: []
	};
	// No title for query's array - TODO Pass a prototype object as parameter
	var forceNoTitle = prototype.$url.indexOf(".$query") > 0;
	for (var prop in props) {
		if (props[prop].$isExcluded !== true) {
			article.$items.push({
				$bind: prop,
				$isTitleHidden: forceNoTitle
			});
		}
	}
	return article;
};

exports.proto2Article = _proto2Article;
});

define('syracuse-tablet/html/js/application/pageHelper',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/utils'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');

var _staticPages = {
	"login": {
		type: "html"
	},
	"about": {
		type: "html"
	},
	"settings": {
		type: "html"
	},
	"defhome": {
		type: "html"
	}
};

var _defInfo = {
	home: false,
	type: "regular",
	cached: false,
	refreshed: false,
	appId: "root",
	changeHash: false
};

var _pages = {};

function _registerStaticPages() {
	for (var p in _staticPages) {
		_pages[p] = $.extend(true, {}, _defInfo, _staticPages[p]);
	}
}

var _getInfo = function(id, clone) {
	var i;
	i = _pages[id];
	if (i && clone === true) i = $.extend(true, {}, i);
	return i;
};

var _getPageInfo = function(state, options, fallback) {
	if (state == null) state = "";
	if (typeof state !== "string") return state;
	var name = state.trim();
	if (name.indexOf("#") == 0) {
		name = name.substring(1);
	}
	state = _getInfo(name, true);
	if (!state && fallback) {
		state = fallback;
	} else if (!state) {
		return null;
	}
	if (options) {
		state.options = options ? $.extend(true, {}, options) : {};
		// Regular page needs gadget context - Ex create action..
		var gadgetId = options["gadget-id"];
		if (gadgetId) {
			state.options.gadget = globals.getApplication().dao.getGadget(gadgetId);
		}
	}
	state.name = name;
	if (!state.transition) {
		// Default transition
		state.transition = globals.$config("transition");
	}
	// Readable id
	state.uuid = utils.readableuid("page", state.appId || "root", state.type, state.name);
	return state;
};

/**
 *  Register the pages of a Syracause Mobile Application
 *  Returns the id of home page
 **/

var _registerPages = function(appMetaData) {

	_pages = {};
	_registerStaticPages();

	var info;
	if (appMetaData.$dashboards) {
		var idx = 0;
		for (var p in appMetaData.$dashboards) {
			var data = appMetaData.$dashboards[p];
			info = $.extend(true, {}, _defInfo);
			info.type = "dashboard";
			// Name is used for readable dom ids - info guarantee unic ids 
			info.name = info.id = data.$dashboardName + ".$dashboard";
			info.dashboardUuid = p;
			_pages[info.id] = info;
		}
	}
	if (appMetaData.$pages) {
		for (var p in appMetaData.$pages) {
			info = $.extend(true, {}, _defInfo);
			info.type = "regular";
			_pages[p] = info;
		}
	}
};

_registerStaticPages();

exports.getPageInfo = _getPageInfo;
exports.registerPages = _registerPages;
});

define('syracuse-tablet/html/js/application/daoApp',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/prototype','syracuse-tablet/html/js/helpers/dashboardArticle','syracuse-tablet/html/js/helpers/prototypeParser','syracuse-tablet/html/js/application/pageHelper','syracuse-tablet/html/js/sdata/entities/clientContract','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/application/gadget','syracuse-tablet/html/js/sdata/sdataHttp'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var prototype = require('syracuse-tablet/html/js/helpers/prototype');
var dashboardArticle = require('syracuse-tablet/html/js/helpers/dashboardArticle');
var prototypeParser = require('syracuse-tablet/html/js/helpers/prototypeParser');
var pageHelper = require('syracuse-tablet/html/js/application/pageHelper');
var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Gadget = require('syracuse-tablet/html/js/application/gadget').Klass;
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');

/**
 * Class that manage access to application DATA
 *  	appli: 		Application object
 * !!use DAO methods instead of dealing directly with JSON
 */
var _Dao = utils.defineClass(
	function(appli) {
		var self = this;
		self._appli = appli;
		self.appMetaData = null;
	}, null, {

		destroy: function() {
			var self = this;
			self._appli = null;
		},
		/**
		 *Returns the JSON description of application
		 */
		isApplicationLoaded: function() {
			var self = this;
			return (self.appMetaData != null);
		},

		/**
		 * Set the JSON description of application
		 */
		setApplicationDesc: function(appMetaData) {
			var self = this;
			if (appMetaData) {
				self.appMetaData = appMetaData;
				pageHelper.registerPages(self.appMetaData);
			}
		},

		getApplicationName: function() {
			var self = this;
			return self.appMetaData.$application.applicationName;
		},

		getHomeDashboard: function() {
			var self = this;
			var homeId;
			if (self.appMetaData && self.appMetaData.$dashboards) {
				for (var p in self.appMetaData.$dashboards) {
					var data = self.appMetaData.$dashboards[p];
					if (data.$dashboardName === self.appMetaData.$application.$homeDashboard.dashboardName) {
						homeId = data.$dashboardName + ".$dashboard";
					}
				}
			}
			return homeId;
		},

		/**
		 * Get information on page kind: html/prototype based, etc
		 */
		getPageInfo: function(state, options) {
			var self = this;
			var pi = clientContract.getPageInfo(state, options);
			if (pi) return pi;
			var name = state;
			if (state === "home") name = self.getHomeDashboard();
			pi = pageHelper.getPageInfo(name, options);
			if (pi) return pi;
			pi = pageHelper.getPageInfo(name, options, {
				home: false,
				type: "regular",
				cached: false,
				refreshed: false,
				appId: "root",
				changeHash: false
			});
			return pi;
		},

		/**
		 * Returns JSON description article/prototype for a regular page (id=AQMCRUDM.$query)
		 */
		getRegularPageInfo: function(id, options) {
			var self = this;
			var deferred = $.Deferred();
			try {
				// Try to get client side implementation first
				clientContract.getRegularPageInfo(id)
					.then(function(info) {
						if (info) {
							return info;
						}
						return self.getPageMetaData(id);
					})
					.then(function(info) {
						if (!info) {
							// This is intended to get prototypes from the server in case representations
							// are used in client side only applications that point to server side entities
							// In real world applications, this will never be used, it's only to simplyfy setup up testcases
							return self.fetchRemotePrototype(id);
						}
						return info;
					})
					.then(function(info) {
						if (!info) {
							return $.smReject(new Error('Page not found - PageId=' + id));
						}
						if (!info.$page) {
							return $.smReject(new Error('Bad page description - PageId=' + id));
						}
						if (!info.$page.$prototype) {
							return $.smReject(new Error('Prototype is NULL - PageId=' + id));
						}
						return info;
					})
					.then(function(info) {
						var proto = info.$page.$prototype;
						// layout:
						// 1 - as defined as sub node in dashboard layout
						// 2 - as comming from the page definition (entity)
						// 3- generate s.th.
						var article = (options && options.article) || (info.$page.$article) || prototypeParser.proto2Article(proto);
						deferred.resolve({
							article: article,
							prototype: prototype.create(proto)
						});
					}, function(e) {
						deferred.reject(e);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		getPageMetaData: function(id) {
			var self = this;
			if (self.appMetaData.$pages) {
				return $.smResolve(self.appMetaData.$pages[id]);
			}
			return $.smResolve(null);
		},

		fetchRemotePrototype: function(id) {
			var self = this;
			return sdataHttp.fetchRemotePrototype(id).then(function(proto) {
				var page = {
					$cache: {
						cacheType: "$auto"
					},
					$page: {
						$prototype: proto
					}
				};
				self.appMetaData.$pages = self.appMetaData.$pages || {};
				self.appMetaData.$pages[id] = page;
				return page;
			}, function(e) {
				return e;
			});
		},

		/**
		 * Returns the prototype and article for a dashBoard
		 * prototype.$properties gives the description of vignettes 'fields'
		 */
		getDashboardInfo: function(dashBoardId) {
			var self = this;
			var dash;

			dash = clientContract.getDashboardInfo(dashBoardId);
			if (!dash) {
				dash = self.appMetaData.$dashboards[dashBoardId];
			}

			if (!dash) throw new Error('Dashboard not found ' + dashBoardId);
			/* Generates article form dashBoard description*/
			var article = dashboardArticle.getDashboardArticle(dash);
			/* Generates proto form dashBoard description*/
			var proto = {
				$title: dash.$title,
				$description: dash.$description,
				$properties: {}
			};
			var vignetteIds = Object.keys(dash.$vignettes || []);
			for (var i = 0; i < vignetteIds.length; i++) {
				var vignetteId = vignetteIds[i];
				var property = $.extend({}, dash.$vignettes[vignetteId]);
				var gadgetId = property.$uuid;
				property.$gadget = self.appMetaData.$gadgets[gadgetId];
				if (property.$gadget) {
					property.$gadget = $.extend({}, property.$gadget);
					// Set gadget uuid
					property.$gadget.$uuid = gadgetId;
					// Set vignette uuid
					property.$uuid = vignetteId;
					// Set type - "application/x-string"
					property.$type = "application/x-vignette";
					// Readable dom uid
					property.domId = utils.readableuid("vgnt", property.$gadget.$type);
				} else {
					property.$gadget = {
						$uuid: gadgetId,
						$type: "$gadgetMissing"
					};
					property.$uuid = vignetteId;
					property.$type = "application/x-vignette";
					property.domId = utils.readableuid("vgnt", property.$gadget.$type);

				}
				proto.$properties[vignetteId] = property;
			}
			return {
				article: $.extend({}, dash.$article),
				prototype: prototype.create(proto)
			};
		},

		/**
		 * Returns a gadget
		 */
		getGadget: function(id) {
			var self = this;
			var g = self.appMetaData.$gadgets[id];
			// We need the uuid in the gadget to build url links (data-gadget-id)
			if (!g.$uuid) g.$uuid = id;
			return new Gadget(g);
		},

		// fullName: x3.erp.SUPERV.AQMCRUD.$details
		getPrototype: function(fullName) {
			var self = this;
			if (self.appMetaData == null) throw new Error("Get page prototype error - No application metadata");
			var page = self.appMetaData.$pages[fullName];
			if (page == null || page.$page == null) throw new Error("Get page prototype error - Page not found[" + fullName + "]");
			return page.$page.$prototype;
		}
	});

exports.Dao = _Dao;
});

define('syracuse-tablet/html/js/application/daoSdata',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/prototype','syracuse-tablet/html/js/helpers/notifications'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var reqProto = require('syracuse-tablet/html/js/helpers/prototype');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');


/**
 * Class that manages access to sdata data structure
 *  	data: 		JOSN data
 *  	prototype: 	Prototype
 *  	parent:		Parent DAO (see getPrototype)
 *  	options:	Not used
 * Manages DAO chaining parent -> child
 * !!use DAO methods instead of dealing directly with JSON
 */
var _Dao = utils.defineClass(function(data, prototype, parent, options) {
	var self = this;
	self.options = options || {};
	self.data = data || {};
	if (!prototype) throw new Error("Prototype is mandatory");
	if (!data) throw new Error("jsonData is mandatory");
	self.prototype = prototype;
	self._children = null;
	self._cache = {
		metaData: {},
		queryData: null
	};
	if (parent) {
		parent._appendChild(self);
		self.parent = parent;
	}
}, null, {

	destroy: function() {
		var self = this;
		self.parent = null;
		self.data = null;
		self.prototype = null;
		if (self._children) {
			self._children.forEach(function(c) {
				if (c) c.destroy();
			});
		}
		self._children = null;
	},
	/**
	 * For destroy
	 */
	_appendChild: function(child) {
		var self = this;
		if (!self._children) self._children = [];
		self._children.push(child);
	},
	/**
	 * Set field's value
	 */
	setValue: function(name, value, notify) {
		var self = this;
		if (self.data[name] !== value) {
			self.data[name] = value;
			if (notify === true) {
				notifications.publish('s-m-dao-updated', self, name, value);
			}
			return true;
		}
		return false;
	},
	/**
	 * Set field's value
	 */
	getValue: function(name, defValue) {
		var self = this;
		if (!name || name.length === 0) return defValue;
		var val = self.data[name];
		if (val != null && typeof val === "object" && !val.$value && self.prototype.property(name, "$type") === "application/x-reference") {
			// Add $value in value with te value of the linked field 
			var nameValue = self.prototype.getFieldNameForValue(name);
			if (nameValue != name) {
				val.$value = self.getValue(nameValue, defValue);
			} else {
				throw new Error("TODO - Syracuse entities");
			}
			return val;
		}
		return val != null ? val : self.parent ? self.parent.getValue(name, defValue) : defValue;
	},
	/**
	 * Temporarily - Returns a string
	 */
	getDisplayValue: function(name, defValue) {
		var self = this;
		var val = self.getValue(name, defValue);
		var meta = self.getMetaData(name);
		// TODO format
		if (typeof val === "object") val = val.$value || val.$title || val.$description;
		return (val || "").toString();

	},
	/**
	 * Return the meta-data for field 'name' including the ones given by prototype
	 */
	getMetaData: function(name) {
		var self = this;
		var meta = self._cache.metaData[name];
		if (meta) return meta;
		meta = self._cache.metaData[name] = $.extend({}, self.prototype.getMetaData(name), self.data.$properties ? self.data.$properties[name] : null);
		return meta;
	},
	getFieldInfo: function(name) {
		var self = this;
		return {
			meta: self.getMetaData(),
			value: self.getValue()
		};
	},
	/**
	 * Returns Array field data
	 * 	$resources an array of dao per row
	 *  No server pagination for array field in Syracuse
	 */
	getArrayData: function(name, itemProto) {
		var self = this;
		var res = {
			$resources: [],
		};
		var rsrcs = self.getValue(name) || [];
		rsrcs.forEach(function(rsrc) {
			res.$resources.push(new _Dao(rsrc, itemProto, self));
		});
		return res;
	},
	/**
	 * Returns query info
	 * 	Pagination info : 	$itemsPerPage $links
	 * 	Data : 				$resources an array of dao per row
	 *
	 */
	getQueryData: function(protoArray) {
		var self = this;
		var res = {
			$itemsPerPage: self.getValue("$itemsPerPage"),
			$resources: [],
			$links: self.getValue("$links")
		};
		if (!protoArray) throw new Error("getQueryData - Prototype Array is mandatory");
		var rowProto = protoArray.getPrototype("$item");
		var rsrcs = self.getValue("$resources");
		rsrcs.forEach(function(rsrc) {
			res.$resources.push(new _Dao(rsrc, rowProto, self));
		});
		return res;
	},
	/**
	 * Lookup info
	 */
	getLookupData: function(protoArray) {
		return this.getQueryData(protoArray);
	},

	getQueryResources: function() {
		var self = this;
		var rsrcs = self.getValue("$resources");
		return rsrcs;
	},

	/* Resolve expression according to current dataset and prototype*/
	parseExpression: function(expression) {
		var self = this;
		return utils.parseExpression(expression, self, self.prototype);
	},
	/**
	 * Set row index for arrays
	 */
	setRowIndex: function(value) {
		this.setValue(reqProto.rowIdxProperty, value, false);
	}
});
// for override only
exports.Dao = _Dao;
});

define('syracuse-tablet/html/js/application/appFactoryDeps',['require','exports','module','syracuse-tablet/html/js/application/application','syracuse-tablet/html/js/pages/pageDashboard','syracuse-tablet/html/js/pages/pageRegular','syracuse-tablet/html/js/pages/html/pageDefHome','syracuse-tablet/html/js/pages/html/pageLogin','syracuse-tablet/html/js/pages/html/pageSettings','syracuse-tablet/html/js/pages/html/pageAbout','syracuse-tablet/html/js/application/daoApp','syracuse-tablet/html/js/application/daoSdata','syracuse-tablet/html/js/application/appFactory'],function (require, exports, module) {

var Application = require('syracuse-tablet/html/js/application/application').Application;
var DashoardPage = require('syracuse-tablet/html/js/pages/pageDashboard').Page;
var RegularPage = require('syracuse-tablet/html/js/pages/pageRegular').Page;
var DefHomePage = require('syracuse-tablet/html/js/pages/html/pageDefHome').Page;
var LoginPage = require('syracuse-tablet/html/js/pages/html/pageLogin').Page;
var SettingsPage = require('syracuse-tablet/html/js/pages/html/pageSettings').Page;
var AboutPage = require('syracuse-tablet/html/js/pages/html/pageAbout').Page;
var DaoApp = require('syracuse-tablet/html/js/application/daoApp').Dao;
var DaoSdata = require('syracuse-tablet/html/js/application/daoSdata').Dao;

var factory = require('syracuse-tablet/html/js/application/appFactory');

exports.init = function() {
	factory.setImpl("Application", Application);
	factory.setImpl("DashoardPage", DashoardPage);
	factory.setImpl("RegularPage", RegularPage);
	factory.setImpl("DefHomePage", DefHomePage);
	factory.setImpl("LoginPage", LoginPage);
	factory.setImpl("SettingsPage", SettingsPage);
	factory.setImpl("AboutPage", AboutPage);
	factory.setImpl("DaoApp", DaoApp);
	factory.setImpl("DaoSdata", DaoSdata);
};
});

define('syracuse-tablet/html/js/controls/structElmt',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _typeNames = {};
var _regExp = /-|\//g;
/**
 * Base class for controls and layouts
 *
 * controller: page (or child controller)
 * 		must implements addControl Method
 *
 */
var _Klass = utils.defineClass(
	function(controller, $type, article, options) {
		var self = this;
		self.options = options || {};
		self.controller = controller;
		self.$type = $type;
		self.typeName = _typeNames[$type];
		if (!self.typeName) {
			// used to generate readable ids - type expected "application/x-name" or "text/plain"
			var a = $type.split(_regExp);
			self.typeName = _typeNames[$type] = a[a.length - 1];
		}
		self.article = article || {};
		self.id = self.createId(self.typeName);
		self.children = null;
		self.parent = null;
		if (!self.controller.addControl) {
			throw new Error("Controller must implement addControl method");
		}
		self.displayOptions = $.extend({}, self.article.displayOptions);
		self.$$elmt = null;
	}, null, {
		destroy: function() {
			var self = this;
			self.controller = null;
			self.parent = null;
			utils.unbindObj(self.$$elmt);
			utils.unbindObj(self);
			if (self.children) {
				self.children.forEach(function(child) {
					if (child) child.destroy();
				});
				self.children = null;
			}
			self.$$elmt = null;
		},
		/**
		 * Temporarily
		 * 	Detach the $$elmt and destroy the object
		 * Used by grid cells
		 * TODO - For grid celleit's not necessary to create object
		 * It's better to have generator the return html/dom elmt per type of control to be able to call the generator without creating objects
		 */
		detachElmt: function() {
			var e = this.$$elmt;
			this.$$elmt = null;
			this.destroy();
			return e;
		},
		/**
		 * Empty current element
		 * 	Called before a refresh
		 *  Keep control objects
		 */
		empty: function() {
			var self = this;
			if (self.children) {
				self.children.forEach(function(child) {
					if (child) child.empty();
				});
			}
			if (self.$$elmt) {
				self.$$elmt.empty();
			}
		},
		/**
		 * return the dao of the controller (page)
		 */
		getControllerDao: function() {
			return this.controller.dao;
		},
		isLayout: function() {
			return this.typeName === "layout";
		},
		isVignette: function() {
			return this.typeName === "vignette";
		},
		isControl: function() {
			return this.isLayout() && !this.isVignette();
		},
		createId: function(typeName) {
			return utils.readableuid(typeName);
		},
		/**
		 * Append structElmt c as a child of this
		 */
		appendStructElmt: function(c) {
			var self = this;
			if (!c) return;
			if (!self.children) self.children = [];
			c.parent = self;
			self.children.push(c);
		},
		isRoot: function() {
			return this.controller === this.parent || this.parent == null;
		},

		getNbChilds: function() {
			return this.children && this.children.length > 0;
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			throw new Error("Must be overridden");
		},
		/**
		 * Refreshes the control
		 */
		refresh: function(controllerDao, options) {
			throw new Error("not implemented");
		},
		/**
		 * Create the root element of the control/layout/vignette
		 * 	This element is identified by self.id
		 */
		createRootElement: function(css, $$parent) {
			return this.setRootElement(uiUtils.createDomElement("div", css, null, {
				"id": this.id
			}), $$parent);
		},
		setRootElement: function(e, $$parent) {
			var dom = e;
			var pom = $$parent;
			if (!e) return null;
			if (typeof e === "string" || !e.jquery) e = $(e);
			this.$$elmt = e;
			if ($$parent) {
				if (!$$parent.jquery) $$parent = $($$parent);
				e.appendTo($$parent);
			}
			return e;
		}
	}
);

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/ctrlBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/structElmt'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/structElmt').Klass;

/**
 * Default ctrl html  - Just the value embedded into a div
 */
var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		self.prototype = prototype;
		self.$bind = article.$bind;
		Base.call(self, controller, prototype.data('$type'), article);
	}, Base, {
		destroy: function() {
			var self = this;
			self.prototype = null;
			Base.prototype.destroy.call(self);
		}
	}
);

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/helpers/types/date',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require("syracuse-tablet/html/js/helpers/locale");

var _dateInfo = locale.getDatetimeInfo;

function _padLeft(str, len, ch) {
	str = str ? str.toString() : '';
	if (!ch || ch.length == 0)
		ch = " ";
	while (str.length < len)
		str = ch + str;
	return str;
};

exports.validate = function(value, constraints, errors) {
	if (value == null) {
		if (constraints.$isMandatory)
			return errors.push(locale.text("date.valMan"));
		if (!constraints.$isNullable)
			return errors.push(locale.text("date.valNull"));
		return;
	}
	if (!(value instanceof DateObj)) {
		errors.push(locale.text("date.valDate"));
		return;
	}

	// month value check
	if (!(value.month >= 1 && value.month <= 12)) {
		errors.push(locale.text("date.invMonth"));
		return;
	}

	// day value check
	if (!(value.day >= 1 && value.day <= _daysInMonth(value.year, value.month))) {
		errors.push(locale.text("date.invDay"));
		return;
	}

};

var _monthOffsets = [0, 31, 59, 90, 120, 151, 181, 212, 243, 273, 304, 334];
var _monthLengths = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

// internal value is integer yyyymmdd
// this is a very simple and compact representation that leads to
// very efficient component extraction and formatting. 
// Also nice for debugging

function DateObj(value) {
	this._value = value;
	//Object.freeze(this); -- confuses JSON, reenable later
}

function _dayName(weekDay, abbrev) {
	return abbrev ? _dateInfo().abbreviatedDayNames[weekDay] : _dateInfo().dayNames[weekDay];
}

function _monthName(month, abbrev) {
	return abbrev ? _dateInfo().abbreviatedMonthNames[month - 1] : _dateInfo().monthNames[month - 1];
}

function _pad2(val) {
	var s = val.toString();
	return (s.length == 1) ? "0" + s : s;
}

function _toOffset(date) {
	var year = date.year;
	var month = date.month;
	var day = date.day;
	// Compute the number of leap days since Jan 1st, 1970.
	// The trick is to use the previous year if month is January or February,
	// the current year otherwise.
	// Then, we compute the number of multiples of 4, 100 and 400 since 1970.
	var y = month <= 2 ? year - 1 : year;

	var n4 = Math.floor(y / 4) - Math.floor(1970 / 4);
	var n100 = Math.floor(y / 100) - Math.floor(1970 / 100);
	var n400 = Math.floor(y / 400) - Math.floor(1970 / 400);

	// Years that are multiple of 400 (like 2000) contribute by 1 (1 -1 +1 in expression below)
	// Years that are multiple of 100 but not of 400 contribute by 0 (1 -1 +0 in expression below)
	// Years that are multiple of 4 but not 100 nor 400 contribute by 1 (1 -0 +0 in expression below).
	var nLeap = n4 - n100 + n400;

	// The offset is straightforward at this point.
	// The February/March transition on leap days will be handled by the fact that the
	// 'y' value above will change, and hence the 'nLeap' value.
	return (year - 1970) * 365 + nLeap + _monthOffsets[month - 1] + day - 1;
}

function _fromOffset(offset) {
	var julian = 2440588 + offset;
	var l = julian + 68569;
	var n = Math.floor((4 * l) / 146097);
	l = l - Math.floor((146097 * n + 3) / 4);
	var i = Math.floor((4000 * (l + 1)) / 1461001);
	l = l - Math.floor((1461 * i) / 4) + 31;
	var j = Math.floor((80 * l) / 2447);
	var day = l - Math.floor((2447 * j) / 80);
	l = Math.floor(j / 11);
	var month = j + 2 - (12 * l);
	var year = 100 * (n - 49) + i + l;
	return new DateObj(year * 10000 + month * 100 + day);
}

function _make(year, month, day) {
	return new DateObj(year * 10000 + month * 100 + day);
}

function _isLeap(year) {
	return year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0);
}

function _daysInMonth(year, month) {
	return month == 2 ? (_isLeap(year) ? 29 : 28) : _monthLengths[month - 1];
}

function _isWorkDay(weekDay) {
	return weekDay != 0 && weekDay != 6;
}

function _amDesignator() {
	return _dateInfo().amDesignator || "AM";
}

function _pmDesignator() {
	return _dateInfo().pmDesignator || "PM";
}

exports.amDesignator = _amDesignator;
exports.pmDesignator = _pmDesignator;

// do not export the class
utils.defineClass(DateObj, null, {
	year: {
		get: function() {
			return Math.floor(this._value / 10000);
		}
	},
	month: {
		get: function() {
			return Math.floor(this._value / 100) % 100;

		}
	},
	day: {
		get: function() {
			return this._value % 100;
		}
	},
	weekDay: {
		get: function() {
			// Add Julian offset (+1 because Julian origin is Monday) 
			// so that modulo is on positive value even if date is before 1970
			return ((2440588 + 1 + _toOffset(this)) % 7);
		}
	},
	yearDay: {
		get: function() {
			var month = this.month;
			var leap = month > 2 && _isLeap(this.year) ? 1 : 0;
			return _monthOffsets[month - 1] + leap + this.day;
		}
	},
	week: {
		// ISO 8601 with week 0
		get: function() {
			// week 1 is the beg of week that contains Jan 4th.
			var begOfWeek1 = _make(this.year, 1, 4).begOfWeek(1);
			return Math.floor((7 + _toOffset(this) - _toOffset(begOfWeek1)) / 7);
		}
	},

	valueOf: function() {
		return this.toString();
	},
	compare: function(date) {
		return this._value - date._value;
	},
	equals: function(date) {
		return this._value === date._value;
	},
	between: function(begin, end) {
		return begin._value <= this._value && this._value <= end._value;
	},

	isLeapYear: function() {
		return _isLeap(this.year);
	},
	isWorkDay: function() {
		return _isWorkDay(this.weekDay);
	},
	daysInMonth: function() {
		return _daysInMonth(this.year, this.month);
	},

	begOfYear: function() {
		return _make(this.year, 1, 1);
	},
	endOfYear: function() {
		return _make(this.year, 12, 31);
	},
	begOfQuarter: function() {
		return _make(this.year, Math.floor((this.month - 1) / 3) * 3 + 1, 1);
	},
	endOfQuarter: function() {
		return this.begOfQuarter().addMonths(2).endOfMonth();
	},
	begOfMonth: function() {
		return _make(this.year, this.month, 1);
	},
	endOfMonth: function() {
		return _make(this.year, this.month, this.daysInMonth());
	},
	sameMonth: function(day) {
		day = Math.min(day, this.daysInMonth());
		return _make(this.year, this.month, day);
	},
	pastDay: function(day, includeThis) {
		var delta = day - this.day;
		return (delta > 0 || delta == 0 && !includeThis) ? this.addMonths(-1).sameMonth(day) : this.sameMonth(day);
	},
	futureDay: function(day, includeThis) {
		var delta = day - this.day;
		return (delta < 0 || delta == 0 && !includeThis) ? this.addMonths(1).sameMonth(day) : this.sameMonth(day);
	},
	pastMonth: function(month, includeThis) {
		var delta = this.month - month;
		delta = delta == 0 ? (includeThis ? 0 : 12) : delta > 0 ? delta : delta + 12;
		return this.addMonths(-delta);
	},
	futureMonth: function(month, includeThis) {
		var delta = month - this.month;
		delta = delta == 0 ? (includeThis ? 0 : 12) : delta > 0 ? delta : delta + 12;
		return this.addMonths(delta);
	},
	begOfWeek: function(startDay) { // 0: Sunday (default), 1: Monday
		var delta = this.weekDay - (startDay || 0);
		return delta == 0 ? this : delta > 0 ? this.addDays(-delta) : this.addDays(-delta - 7);
	},
	endOfWeek: function(startDay) {
		return this.begOfWeek(startDay).addDays(6);
	},
	sameWeek: function(weekDay, startDay) {
		return this.begOfWeek(startDay).futureWeekDay(weekDay, true);
	},
	pastWeekDay: function(weekDay, includeThis) {
		var result = this.begOfWeek(weekDay);
		return !includeThis && result.equals(this) ? this.addWeeks(-1) : result;
	},
	futureWeekDay: function(weekDay, includeThis) {
		return this.pastWeekDay(weekDay, !includeThis).addWeeks(1);
	},
	addYears: function(years) {
		if (years == 0)
			return this;
		var year = this.year + years;
		var month = this.month;
		var day = Math.min(this.day, _daysInMonth(year, month));
		return _make(year, month, day);
	},
	addMonths: function(months) {
		if (months == 0)
			return this;
		var self = this;
		var day = self.day;
		var month0 = self.month - 1;
		var year = self.year;
		month0 += months;
		year += Math.floor(month0 / 12);
		var month = (month0 + 120000) % 12 + 1;
		var monthLen = _daysInMonth(year, month);
		day = day < monthLen ? day : monthLen;
		return _make(year, month, day);
	},
	addWeeks: function(weeks) {
		return this.addDays(7 * weeks);
	},
	addDays: function(days) {
		if (days == 0)
			return this;
		return _fromOffset(_toOffset(this) + days);
	},

	daysDiff: function(date) {
		return _toOffset(this) - _toOffset(date);
	},

	/**
     * Adds (or subtracts) to the value of the year, month, day, hour, minute, second, millisecond of the date instance using given configuration object. Positive and Negative values allowed.
     * Example
     <pre><code>
     Date.today().add( { day: 1, month: 1 } )
     </code></pre>
     * @param {Object}   Configuration object containing attributes (month, day, etc.)
     * @return {Date}    this
     */
	add: function(delta) {
		return this.addYears(delta.years || 0).addMonths(delta.months || 0).addWeeks(delta.weeks || 0).addDays(delta.days || 0);
	},

	// format as 
	toString: function(format) {
		var self = this;
		if (format == null) {
			// RFC 3339 by default -- very fast
			var str = self._value.toString();
			str = _padLeft(str, 8, "0");
			return str.substring(0, 4) + "-" + str.substring(4, 6) + "-" + str.substring(6, 8);
		} else {
			var result = '';
			_walkFormat(format, {
				literal: function(lit) {
					result += lit;
				},
				d: function(repeat) {
					switch (repeat) {
						case 1:
							result += self.day.toString();
							break;
						case 2:
							result += _pad2(self.day);
							break;
						case 3:
							result += _dayName(self.weekDay, true);
							break;
						case 4:
							result += _dayName(self.weekDay);
							break;
						default:
							throw new Error(locale.text("date.formatd", repeat));
					}
				},
				M: function(repeat) {
					switch (repeat) {
						case 1:
							result += self.month.toString();
							break;
						case 2:
							result += _pad2(self.month);
							break;
						case 3:
							result += _monthName(self.month, true);
							break;
						case 4:
							result += _monthName(self.month);
							break;
						default:
							throw new Error(locale.text("date.formatM", repeat));
					}
				},
				y: function(repeat) {
					switch (repeat) {
						case 2:
							result += self.year.toString().substring(2, 4);
							break;
						case 4:
							result += self.year.toString();
							break;
						default:
							throw new Error(locale.text("date.formatM", repeat));
					}
				}
			});
			return result;
		}
	},

	at: function(time, millisecond) {
		throw new Error(locale.text("date.notInstalled"));
	},

	toJsDate: function(utc) {
		return utc ? new Date(Date.UTC(this.year, this.month - 1, this.day)) : new Date(this.year, this.month - 1, this.day);
	},

	isNull: function() {
		return this._value == 0;
	}
});

exports.monthName = _monthName;

/**
 * Gets the month number (1-12) if given a Culture Info specific string which is a valid monthName or abbreviatedMonthName.
 * @param {String}   The name of the month (eg. "February, "Feb", "october", "oct").
 * @return {Number}  The day number
 */
exports.monthFromName = function(name) {
	var n = _dateInfo().monthNames,
		m = _dateInfo().abbreviatedMonthNames,
		s = name.toLowerCase();
	for (var i = 0; i < n.length; i++) {
		if (n[i].toLowerCase() == s || m[i].toLowerCase() == s) {
			return i + 1;
		}
	}
	return -1;
};

exports.dayName = _dayName;

/**
 * Gets the day number (0-6) if given a CultureInfo specific string which is a valid dayName, abbreviatedDayName or shortestDayName (two char).
 * @param {String}   The name of the day (eg. "Monday, "Mon", "tuesday", "tue", "We", "we").
 * @return {Number}  The day number
 */
exports.weekDayFromName = function(name) {
	var n = _dateInfo().dayNames,
		m = _dateInfo().abbreviatedDayNames,
		o = _dateInfo().shortestDayNames,
		s = name.toLowerCase();
	for (var i = 0; i < n.length; i++) {
		if (n[i].toLowerCase() == s || m[i].toLowerCase() == s) {
			return i;
		}
	}
	return -1;
};

exports.isLeap = _isLeap;

exports.daysInMonth = _daysInMonth;

exports.today = function(utc) {
	return exports.fromJsDate(new Date(), utc);
};

function _walkFormat(format, map) {
	var i = 0,
		len = format.length;

	function count(i) {
		var ch = format[i],
			k = 1;
		while (format[i + k] === ch)
			k++;
		return k;
	}

	while (i < len) {
		var c = format[i];
		switch (c) {
			case "'":
				i++;
				var literal = '';
				// going to the end of the following litteral or to the format end
				for (; i < len; i++) {
					if (format[i] === "'") {
						i++;
						// check wether the "'" is not doubled
						if (format[i] === "'") {
							literal += "'";
						} else
							break;
					} else {
						literal += format[i];
					}
				}
				map.literal(literal);
				break;
			case "d":
			case "M":
			case "y":
				var repeat = count(i);
				map[c](repeat);
				i += repeat;
				break;
			default:
				map.literal(c);
				i++;

		}
	}
}

function _parse(str, format) {
	var day, weekday, month, year;
	// position in str
	var j = 0;

	function parseInteger(max) {
		if (!/\d/.test(str[j])) {
			throw new Error(locale.text("date.notNumber", str.substring[j]));
		}
		var beg = j++;
		while (j < beg + max && /\d/.test(str[j]))
			j++;
		return parseInt(str.substring(beg, j), 10);
	}

	function parseName(names) {
		for (var k = 0; k < names.length; k++) {
			var name = names[k],
				len = name.length;
			if (str.substring(j, j + len).toUpperCase() == name.toUpperCase()) {
				j += len;
				return k;
			}
		}
		throw new Error(locale.text("date.unknown", str.substring(j)));
	}

	_walkFormat(format, {
		literal: function(literal) {
			if (str.substring(j, j + literal.length) !== literal)
				throw new Error(locale.text("date.wrongFormat", literal, str.substring(j)));
			j += literal.length;
		},
		d: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					day = parseInteger(2);
					break;
				case 3:
					weekday = parseName(_dateInfo().abbreviatedDayNames);
					break;
				case 4:
					weekday = parseName(_dateInfo().dayNames);
					break;
				default:
					throw new Error(locale.text("date.badDay", format.substring(j))); // replaced i with j
			}
		},
		M: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					month = parseInteger(2);
					break;
				case 3:
					month = parseName(_dateInfo().abbreviatedMonthNames) + 1;
					break;
				case 4:
					month = parseName(_dateInfo().monthNames) + 1;
					break;
				default:
					throw new Error(locale.text("date.badDay", format.substring(j))); // replaced i with j
			}
		},
		y: function(arg) {
			switch (arg) {
				case 2:
					year = parseInteger(2);
					year = year < 40 ? 2000 + year : 1900 + year;
					break;
				case 4:
					year = parseInteger(4);
					year = year > 99 ? year : year < 40 ? 2000 + year : 1900 + year;
					break;
				default:
					throw new Error(locale.text("date.badYear", format.substring(j))); // replaced i with j
			}
		}
	});

	//console.log(result);
	// ignore weekday
	return _make(year, month, day);
}

exports.parse = function(str, format) {
	if (str == null)
		throw new Error(locale.text("date.dateNull"));

	if (format == null) {
		// RFC 3339 by default -- very fast
		if (str.length != 10)
			throw new Error(locale.text("date.badFormat", str));
		var value = parseInt(str.replace(/-/g, ''), 10);
		return new DateObj(value);
	} else {
		return _parse(str, format);
	}
};

// used for format conversions
exports.walkFormat = _walkFormat;

exports.fromJsDate = function(jsDate, utc) {
	return utc ? _make(jsDate.getUTCFullYear(), jsDate.getUTCMonth() + 1, jsDate.getUTCDate()) : _make(jsDate.getFullYear(), jsDate.getMonth() + 1, jsDate.getDate());
};

exports.fromInternalValue = function(value) {
	return new DateObj(value);
};

exports.makeInWeek = function(year, week, wday) {
	var dday = wday ? wday - 1 : 6;
	return _make(year, 1, 4).begOfWeek(1).addDays(7 * (week - 1) + dday);
};
exports.isDate = function(obj) {
	return obj instanceof DateObj;
};


exports.sunday = 0;
exports.Sunday = 0;
exports.monday = 1;
exports.Monday = 1;
exports.tuesday = 2;
exports.Tuesday = 2;
exports.wednesday = 3;
exports.Wednesday = 3;
exports.thursday = 4;
exports.Thursday = 4;
exports.friday = 5;
exports.Friday = 5;
exports.saturday = 6;
exports.Saturday = 6;

exports.make = _make;
});

define('syracuse-tablet/html/js/helpers/types/time',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require("syracuse-tablet/html/js/helpers/locale");
var _dateInfo = locale.getDatetimeInfo;

exports.validate = function(value, constraints, errors) {
	if (value == null) {
		if (constraints.$isMandatory) return errors.push(locale.text("time.valMan"));
		if (!constraints.$isNullable) return errors.push(locale.text("time.valNull"));
		return;
	}
	if (!(value instanceof Time)) {
		errors.push(locale.text("time.valTime"));
		return;
	}
};

function Time(value) {
	// force modulo on value to bring it back in range
	value = (value + 86400 * 365 * 10000) % 86400;
	this._value = value;
}

function _pad2(val) {
	var s = val.toString();
	return (s.length == 1) ? "0" + s : s;
}

function _parse2(str, beg, end) {
	return parseInt(str.substring(beg, end), 10);
}

function _make(hour, minute, second) {
	return new Time(hour * 3600 + (minute || 0) * 60 + (second || 0));
}

function _amDesignator() {
	return _dateInfo().amDesignator || "AM";
}

function _pmDesignator() {
	return _dateInfo().pmDesignator || "AM";
}

utils.defineClass(Time, null, {
	hour: {
		get: function() {
			return Math.floor(this._value / 3600);
		}
	},
	minute: {
		get: function() {
			return Math.floor(this._value / 60) % 60;
		}
	},
	second: {
		get: function() {
			return this._value % 60;
		}
	},
	value: {
		get: function() {
			return this._value;
		}
	},
	valueOf: function() {
		return this.toString();
	},
	compare: function(time) {
		return this._value - time._value;
	},
	equals: function(time) {
		return this._value === time._value;
	},
	between: function(begin, end) {
		return begin._value <= this._value && this._value <= end._value;
	},

	begOfDay: function() {
		return _make(0, 0, 0);
	},
	endOfDay: function() {
		return _make(23, 59, 59);
	},
	begOfHour: function() {
		return _make(this.hour, 0, 0);
	},
	endOfHour: function() {
		return _make(this.hour, 59, 59);
	},
	begOfMinute: function() {
		return _make(this.hour, this.minute, 0);
	},
	endOfMinute: function() {
		return _make(this.hour, this.minute, 59);
	},

	// format as
	toString: function(format) {
		var self = this;
		if (format == null) {
			return _pad2(self.hour) + ":" + _pad2(self.minute) + ":" + _pad2(self.second);
		} else {
			var result = '';
			_walkFormat(format, {
				literal: function(lit) {
					result += lit;
				},
				H: function(repeat) {
					switch (repeat) {
						case 1:
							result += self.hour;
							break;
						case 2:
							result += _pad2(self.hour);
							break;
						default:
							throw new Error(locale.text("time.formatH", repeat));
					}
				},
				h: function(repeat) {
					switch (repeat) {
						case 1:
							var hour = self.hour;
							if (hour === 0) {
								result += 12;
							} else {
								result += hour > 12 ? hour - 12 : hour;
							}
							break;
						case 2:
							var hour = self.hour;
							if (hour === 0) {
								result += 12;
							} else {
								result += hour > 12 ? _pad2(hour - 12) : _pad2(hour);
							}
							break;
						default:
							throw new Error(locale.text("time.formath", repeat));
					}
				},
				m: function(repeat) {
					switch (repeat) {
						case 2:
							result += _pad2(self.minute);
							break;
						default:
							throw new Error(locale.text("time.formatm", repeat));
					}
				},
				s: function(repeat) {
					switch (repeat) {
						case 2:
							result += _pad2(self.second);
							break;
						default:
							throw new Error(locale.text("time.formats", repeat));
					}
				},
				t: function(repeat) {
					switch (repeat) {
						case 1:
							result += self.hour < 12 ? _amDesignator().substring(0, 1) : _pmDesignator().substring(0, 1);
							break;
						case 2:
							result += self.hour < 12 ? _amDesignator() : _pmDesignator();
							break;
						default:
							throw new Error(locale.text("time.formata", repeat));
					}
				}
			});
			return result;
		}

	},

	secondsDiff: function(t) {
		return this._value - t._value;
	},

	// add functions circle from 23:59:59 to 00:00:00 without warning
	addHours: function(hours) {
		return hours == 0 ? this : new Time(this._value + hours * 3600);
	},
	addMinutes: function(minutes) {
		return minutes == 0 ? this : new Time(this._value + minutes * 60);
	},
	addSeconds: function(seconds) {
		return seconds == 0 ? this : new Time(this._value + seconds);
	},
	add: function(delta) {
		return this.addHours(delta.hours || 0).addMinutes(delta.minutes || 0).addSeconds(delta.seconds || 0);
	},
	isNull: function() {
		return this._value == 0;
	}
});

exports.make = _make;

exports.fromSeconds = function(seconds) {
	return new Time(seconds);
};

exports.fromJsDate = function(js, utc) {
	return utc ? _make(js.getUTCHours(), js.getUTCMinutes(), js.getUTCSeconds()) : _make(js.getHours(), js.getMinutes(), js.getSeconds());
};

exports.now = function(utc) {
	return exports.fromJsDate(new Date(), utc);
};

exports.parse = function(str, format) {
	if (str == null) throw new Error(locale.text("time.isNull"));

	if (format == null) {
		// RFC 3339 full time without fraction -- very fast
		// hh:mm
		if (str.length != 5 && str.length != 8) throw new Error(locale.text("time.badFormat", str));

		var value = str.length == 8 ? _parse2(str, 0, 2) * 3600 + _parse2(str, 3, 5) * 60 + _parse2(str, 6, 8) : _parse2(str, 0, 2) * 3600 + _parse2(str, 3, 5) * 60;
		return new Time(value);
	} else {
		return _parse(str, format);
	}
};

function _walkFormat(format, map) {
	var i = 0,
		len = format.length;

	function count(i) {
		var ch = format[i],
			k = 1;
		while (format[i + k] === ch)
			k++;
		return k;
	}

	while (i < len) {
		var c = format[i];
		switch (c) {
			case "'":
				i++;
				var literal = '';
				// going to the end of the following literal or to the format end
				for (; i < len; i++) {
					if (format[i] === "'") {
						i++;
						// check whether the "'" is not doubled
						if (format[i] === "'") {
							literal += "'";
						} else break;
					} else {
						literal += format[i];
					}
				}
				map.literal(literal);
				break;
			case "H":
			case "h":
			case "m":
			case "s":
			case "t":
				var repeat = count(i);
				map[c](repeat);
				i += repeat;
				break;
			default:
				map.literal(c);
				i++;
		}
	}
}

function _parse(str, format) {
	var hour, minute, second, timeMode, abbrTimeMode;
	var timeModes = [_amDesignator(), _pmDesignator()];
	var abbrTimeModes = [timeModes[0].substring(0, 1), timeModes[1].substring(0, 1)];
	// position in str
	var j = 0;

	function parseInteger(max) {
		if (!/\d/.test(str[j])) {
			throw new Error(locale.text("time.noNumber", str.substring[j]));
		}
		var beg = j++;
		while (j < beg + max && /\d/.test(str[j]))
			j++;
		return parseInt(str.substring(beg, j), 10);
	}

	function parseName(names) {
		for (var k = 0; k < names.length; k++) {
			var name = names[k],
				len = name.length;
			if (str.substring(j, j + len).toUpperCase() == name.toUpperCase()) {
				j += len;
				return k;
			}
		}
		throw new Error(locale.text("time.unknown", str.substring(j)));
	}

	_walkFormat(format, {
		literal: function(literal) {
			if (str.substring(j, j + literal.length) !== literal) throw new Error(locale.text("time.wrongFormat", literal, str.substring(j)));
			j += literal.length;
		},
		H: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					hour = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("time.badHour", format.substring(j))); // replaced i with j
			}
		},
		h: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					hour = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("time.badHour", format.substring(j)));
			}
		},
		m: function(arg) {
			switch (arg) {
				case 2:
					minute = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("time.badMin", format.substring(j)));
			}
		},
		s: function(arg) {
			switch (arg) {
				case 2:
					second = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("time.badSec", format.substring(j)));
			}
		},
		t: function(arg) {
			switch (arg) {
				case 1:
					abbrTimeMode = parseName(abbrTimeModes);
					break;
				case 2:
					timeMode = parseName(timeModes);
					break;
				default:
					throw new Error(locale.text("time.badMarker", format.substring(j)));
			}
		}
	});

	// from 12 format to 24 format, used when necessary

	function from12to24(mode, index) {
		switch (mode[index]) {
			case mode[0]:
				// AM
				hour = hour === 12 ? 0 : hour;
				break;
			case mode[1]:
				// PM
				if (hour >= 1 && hour <= 11) {
					hour += 12;
				}
				break;
		}
	}

	if (timeMode != null || abbrTimeMode != null) {
		if (hour > 12) throw new Error(locale.text("time.badHourVal", hour, timeMode));
		var mode = timeMode != null ? timeModes : abbrTimeModes;
		var index = timeMode != null ? timeMode : abbrTimeMode;
		from12to24(mode, index);
	}

	return _make(hour, minute, second);
}

exports.amDesignator = _amDesignator;
exports.pmDesignator = _pmDesignator;
});

define('syracuse-tablet/html/js/helpers/types/datetime',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/types/date','syracuse-tablet/html/js/helpers/types/time','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var date = require('syracuse-tablet/html/js/helpers/types/date');
var time = require('syracuse-tablet/html/js/helpers/types/time');
var locale = require("syracuse-tablet/html/js/helpers/locale");

var _dateInfo = locale.getDatetimeInfo;

exports.validate = function(value, constraints, errors) {
	if (value == null) {
		if (constraints.$isMandatory) return errors.push(locale.text("datetime.valMand"));
		if (!constraints.$isNullable) return errors.push(locale.text("datetime.valNull"));
		return;
	}
	if (!(value instanceof Datetime)) {
		errors.push(locale.text("datetime.valDT"));
		return;
	}

	// month value check
	if (!(value.month >= 1 && value.month <= 12)) {
		errors.push(locale.text("datetime.valMon"));
		return;
	}

	// day value check
	if (!(value.day >= 1 && value.day <= date.daysInMonth(value.year, value.month))) {
		errors.push(locale.text("datetime.valDay"));
		return;
	}
};

function _pad2(val) {
	var s = val.toString();
	return (s.length == 1) ? "0" + s : s;
}

function _pad3(val) {
	var s = val.toString();
	switch (s.length) {
		case 1:
			return "00" + s;
		case 2:
			return "0" + s;
		default:
			return s;
	}
}

// internal value is GMT millis since origin (Jan 1st, 1970).
// We also cache the local and utc values separately as _local and _utc, when
// they are requested.

function Datetime(value, tzOffset) {
	this._value = value;
	if (tzOffset != null) this._tzOffset = tzOffset;
}

// returns millis value for seconds and milliseconds part

function _ms(dt) {
	// add millis for approx 2000 years to ensure positive before applying modulo
	return (dt._value + 2000 * 365 * 24 * 3600 * 1000) % 1000;
}

// get UTC components packed into an int
// millis are not included as they are independent from UTC/local

function _utc(dt) {
	var utc = dt._utc;
	if (!utc) {
		var d = new Date(dt._value);
		utc = d.getUTCFullYear() * 10000 * 100000 + (d.getUTCMonth() + 1) * 100 * 100000 + d.getUTCDate() * 100000 + d.getUTCHours() * 3600 + d.getUTCMinutes() * 60 + d.getUTCSeconds();
		d._utc = utc;
	}
	return utc;
}

// get local components packed into an int
// millis are not included as they are independent from UTC/local

function _local(dt) {
	var local = dt._local;
	if (!local) {
		var d = new Date(dt._value);
		local = d.getFullYear() * 10000 * 100000 + (d.getMonth() + 1) * 100 * 100000 + d.getDate() * 100000 + d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
		d._local = local;
	}
	return local;
}

exports.Datetime = utils.defineClass(Datetime, null, {
	date: {
		get: function() {
			return date.fromInternalValue(Math.floor(_local(this) / 100000));
		}
	},
	time: {
		get: function() {
			return time.fromSeconds(_local(this) % 100000);
		}
	},
	year: {
		get: function() {
			return this.date.year;
		}
	},
	month: {
		get: function() {
			return this.date.month;
		}
	},
	day: {
		get: function() {
			return this.date.day;
		}
	},
	weekDay: {
		get: function() {
			return this.date.weekDay;
		}
	},
	yearDay: {
		get: function() {
			return this.date.yearDay;
		}
	},
	hour: {
		get: function() {
			return this.time.hour;
		}
	},
	minute: {
		get: function() {
			return this.time.minute;
		}
	},
	second: {
		get: function() {
			return this.time.second;
		}
	},
	millisecond: {
		get: function() {
			return _ms(this);
		}
	},

	utcDate: {
		get: function() {
			return date.fromInternalValue(Math.floor(_utc(this) / 100000));
		}
	},
	utcTime: {
		get: function() {
			return time.fromSeconds(_utc(this) % 100000);
		}
	},
	utcYear: {
		get: function() {
			return this.utcDate.year;
		}
	},
	utcMonth: {
		get: function() {
			return this.utcDate.month;
		}
	},
	utcDay: {
		get: function() {
			return this.utcDate.day;
		}
	},
	utcWeekDay: {
		get: function() {
			return this.utcDate.weekDay;
		}
	},
	utcYearDay: {
		get: function() {
			return this.utcDate.yearDay;
		}
	},
	utcHour: {
		get: function() {
			return this.utcTime.hour;
		}
	},
	utcMinute: {
		get: function() {
			return this.utcTime.minute;
		}
	},
	utcSecond: {
		get: function() {
			return this.utcTime.second;
		}
	},
	utcMillisecond: {
		get: function() {
			return _ms(this);
		}
	},
	value: {
		get: function() {
			return this._value;
		}
	},
	timezoneOffset: {
		get: function() {
			if (this._tzOffset == null) this._tzOffset = this.toJsDate().getTimezoneOffset();
			return this._tzOffset;
		}
	},

	compare: function(dt) {
		return this._value - dt._value;
	},
	equals: function(dt) {
		return this._value === dt._value;
	},
	between: function(begin, end) {
		return begin._value <= this._value && this._value <= end._value;
	},

	addYears: function(years) {
		return this.date.addYears(years).at(this.time, this.millisecond);
	},
	addMonths: function(months) {
		return this.date.addMonths(months).at(this.time, this.millisecond);
	},
	addWeeks: function(weeks) {
		return this.date.addWeeks(weeks).at(this.time, this.millisecond);
	},
	addDays: function(days) {
		return this.date.addDays(days).at(this.time, this.millisecond);
	},
	addHours: function(hours) {
		return new Datetime(this._value + hours * 3600 * 1000);
	},
	addMinutes: function(minutes) {
		return new Datetime(this._value + minutes * 60 * 1000);
	},
	addSeconds: function(seconds) {
		return new Datetime(this._value + seconds * 1000);
	},
	addMilliseconds: function(millis) {
		return new Datetime(this._value + millis);
	},
	addDayFractions: function(fraction) {
		return new Datetime(this._value + fraction * 86400 * 1000);
	},

	millisDiff: function(dt) {
		return this._value - dt._value;
	},
	begOfMonth: function() {
		return _make(this.year, this.month, 1);
	},
	begOfWeek: function(startDay) { // 0: Sunday (default), 1: Monday
		var delta = this.weekDay - (startDay || 0);
		return delta == 0 ? this : delta > 0 ? this.addDays(-delta) : this.addDays(-delta - 7);
	},

	/**
     * Adds (or subtracts) to the value of the year, month, day, hour, minute, second, millisecond of the date instance using given configuration object. Positive and Negative values allowed.
     * Example
     <pre><code>
     Date.today().add( { day: 1, month: 1 } )
     </code></pre>
     * @param {Object}   Configuration object containing attributes (month, day, etc.)
     * @return {Date}    this
     */
	add: function(delta) {
		return this.addYears(delta.years || 0).addMonths(delta.months || 0).addWeeks(delta.weeks || 0).addDays(delta.days || 0).addHours(delta.hours || 0).addMinutes(delta.minutes || 0).addSeconds(delta.seconds || 0).addMillis(delta.millis || 0);
	},

	// format as
	toString: function(format) {
		var self = this;
		if (format == null) {
			return new Date(this._value).toISOString();
		} else {
			var utc = _getIndexOfZ(format);
			var _date = utc ? self.utcDate : self.date;
			var _time = utc ? self.utcTime : self.time;

			var result = '';
			_walkFormat(format, {
				literal: function(lit) {
					result += lit;
				},
				H: function(repeat) {
					switch (repeat) {
						case 1:
							result += _time.hour.toString();
							break;
						case 2:
							result += _pad2(_time.hour);
							break;
						default:
							throw new Error(locale.text("datetime.formatH", repeat));
					}
				},
				h: function(repeat) {
					switch (repeat) {
						case 1:
							result += _time.hour < 13 ? _time.hour : (_time.hour - 12);
							break;
						case 2:
							result += _pad2(_time.hour < 13 ? _time.hour : (_time.hour - 12));
							break;
						default:
							throw new Error(locale.text("datetime.formath", repeat));
					}
				},
				m: function(repeat) {
					switch (repeat) {
						case 2:
							result += _pad2(_time.minute);
							break;
						default:
							throw new Error(locale.text("datetime.formatm", repeat));
					}
				},
				s: function(repeat) {
					switch (repeat) {
						case 2:
							result += _pad2(self.second);
							break;
						default:
							throw new Error(locale.text("datetime.formats", repeat));
					}
				},
				t: function(repeat) {
					switch (repeat) {
						case 1:
							result += self.hour < 12 ? _dateInfo().amDesignator.substring(0, 1) : _dateInfo().pmDesignator.substring(0, 1);
							break;
						case 2:
							result += self.hour < 12 ? _dateInfo().amDesignator : _dateInfo().pmDesignator;
							break;
						default:
							throw new Error(locale.text("datetime.formata", repeat));
					}
				},
				d: function(repeat) {
					switch (repeat) {
						case 1:
							result += _date.day.toString();
							break;
						case 2:
							result += _pad2(_date.day);
							break;
						case 3:
							result += date.dayName(_date.weekDay, true);
							break;
						case 4:
							result += date.dayName(_date.weekDay);
							break;
						default:
							throw new Error(locale.text("datetime.formatd", repeat));
					}
				},
				M: function(repeat) {
					switch (repeat) {
						case 1:
							result += _date.month.toString();
							break;
						case 2:
							result += _pad2(_date.month);
							break;
						case 3:
							result += date.monthName(_date.month, true);
							break;
						case 4:
							result += date.monthName(_date.month);
							break;
						default:
							throw new Error(locale.text("datetime.formatM", repeat));
					}
				},
				y: function(repeat) {
					switch (repeat) {
						case 2:
							result += _date.year.toString().substring(2, 4);
							break;
						case 4:
							result += _date.year.toString();
							break;
						default:
							throw new Error(locale.text("datetime.formaty", repeat));
					}
				},
				S: function(repeat) {
					if (repeat === 3) result += _pad3(self.millisecond);
					else new Error(locale.text("datetime.formatS", repeat));
				}
			});
			return result;
		}
	},
	toJsDate: function() {
		return new Date(this._value);
	},
	withoutTimezoneOffset: function() {
		return new Datetime(this._value);
	},
	isNull: function() {
		return this._value == 0;
	}
});

function _formatTzOffset(offset, len) {
	var s = "-";
	if (offset < 0) {
		s = "+";
		offset = -offset;
	}
	var hr = Math.round(offset / 60);
	var min = offset - hr * 60;
	s += len > 1 ? _pad2(hr) : hr;
	s += len > 2 || min ? (":" + (len > 1 ? _pad2(min) : min)) : "";
	return s;
}

function _parseIso(str) {
	var year = 0,
		month = 0,
		day = 0,
		hours = 0,
		minutes = 0,
		seconds = 0,
		ms = 0,
		offset = 0,
		convertError = true;
	var d = /(\d{4})-(\d{2})-(\d{2})([T\s]?)(\d{2})?(:)?(\d{2})?(:)?(\d{2})?(\.(\d{3}))?(Z)?(([+-])(\d{2}))?(.*$)/.exec(str);
	if (d) {
		convertError = false;
		year = +d[1];
		month = d[2] - 1;
		day = +d[3];
		hours = +(d[5] || 0);
		minutes = +(d[7] || 0);
		seconds = +(d[9] || 0);
		ms = +(d[11] || 0);
		if (d[12] === "Z") {
			if (d[14] === '-') offset = (d[15] || 0) * 60;
			else if (d[14] === '+') offset = -(d[15] || 0) * 60;
			var utc = Date.UTC(year, month, day, hours, minutes + offset, seconds, ms);
			return new Datetime(utc);
		} else {
			var jsDate = new Date(year, month, day, hours, minutes + offset, seconds, ms);
			return new Datetime(jsDate.getTime(), jsDate.getTimezoneOffset());
		}
	}
	if (convertError) throw new Error(locale.text("datetime.noParse", str));
}

exports.now = function(withMillis) {
	var jsDate = new Date();
	var millis = jsDate.getTime();
	if (!withMillis) millis = Math.floor(millis / 1000) * 1000;
	return new Datetime(millis, jsDate.getTimezoneOffset());
};

exports.parse = function(str, format) {
	if (str == null) throw new Error(locale.text("datetime.isNull"));

	if (format == null) {
		return _parseIso(str);
	} else {
		return _parse(str, format);
	}
};

exports.fromJsDate = function(jsDate) {
	return new Datetime(jsDate.getTime(), jsDate.getTimezoneOffset());
};

exports.isDatetime = function(obj) {
	return obj instanceof Datetime;
};

exports.fromInternalValue = function(value) {
	return new Datetime(value);
};

exports.dayName = function(weekDay, abbrev) {
	return abbrev ? _dateInfo().abbreviatedDayNames[weekDay] : _dateInfo().dayNames[weekDay];
};

exports.monthName = function(month, abbrev) {
	return abbrev ? _dateInfo().abbreviatedMonthNames[month - 1] : _dateInfo().monthNames[month - 1];
};

function _make(year, month, day, hour, minute, second, millis) {
	var jsDate = new Date(year, month - 1, day, hour || 0, minute || 0, second || 0, millis || 0);
	return new Datetime(jsDate.getTime(), jsDate.getTimezoneOffset());
}

exports.make = _make;
exports.makeUtc = _makeUtc;

function _makeUtc(year, month, day, hour, minute, second, millis) {
	var jsDate = new Date(Date.UTC(year, month - 1, day, hour || 0, minute || 0, second || 0, millis || 0));
	return new Datetime(jsDate.getTime(), jsDate.getTimezoneOffset());
}

// hack to install "at" method in date, without require cycles
date.make(1, 1, 1).constructor.prototype.at = function(time, millisecond) {
	return exports.make(this.year, this.month, this.day, time.hour, time.minute, time.second, millisecond);
};

exports.sunday = 0;
exports.Sunday = 0;
exports.monday = 1;
exports.Monday = 1;
exports.tuesday = 2;
exports.Tuesday = 2;
exports.wednesday = 3;
exports.Wednesday = 3;
exports.thursday = 4;
exports.Thursday = 4;
exports.friday = 5;
exports.Friday = 5;
exports.saturday = 6;
exports.Saturday = 6;

function _walkFormat(format, map) {
	var i = 0,
		len = format.length;

	function count(i) {
		var ch = format[i],
			k = 1;
		while (format[i + k] === ch)
			k++;
		return k;
	}

	while (i < len) {
		var c = format[i];
		switch (c) {
			case "'":
				i++;
				var literal = '';
				// going to the end of the following litteral or to the format end
				for (; i < len; i++) {
					if (format[i] === "'") {
						i++;
						// check wether the "'" is not doubled
						if (format[i] === "'") {
							literal += "'";
						} else break;
					} else {
						literal += format[i];
					}
				}
				map.literal(literal);
				break;
			case "H":
			case "h":
			case "m":
			case "s":
			case "S":
			case "t":
			case "d":
			case "M":
			case "y":
				var repeat = count(i);
				map[c](repeat);
				i += repeat;
				break;
			default:
				map.literal(c);
				i++;
		}
	}
}

exports.walkFormat = _walkFormat;

function _parse(str, format) {
	var day, weekday, month, year, hour, minute, second, millis, timeMode, abbrTimeMode;
	var timeModes = [date.amDesignator(), date.pmDesignator()];
	//var timeModes = _dateInfo().amDesignator ? [_dateInfo().amDesignator, _dateInfo().pmDesignator] : ["AM", "PM"];
	var abbrTimeModes = [timeModes[0].substring(0, 1), timeModes[1].substring(0, 1)];
	//var abbrTimeModes = _dateInfo().amDesignator ? [_dateInfo().amDesignator.substring(0, 1), _dateInfo().pmDesignator.substring(0, 1)] : ["A", "P"];

	// position in str
	var j = 0;

	function parseInteger(max) {
		if (!/\d/.test(str[j])) {
			throw new Error(locale.text("datetime.noNumber", str.substring[j]));
		}
		var beg = j++;
		while (j < beg + max && /\d/.test(str[j]))
			j++;
		return parseInt(str.substring(beg, j), 10);
	}

	function parseName(names) {
		for (var k = 0; k < names.length; k++) {
			var name = names[k],
				len = name.length;
			if (str.substring(j, j + len).toUpperCase() == name.toUpperCase()) {
				j += len;
				return k;
			}
		}
		throw new Error(locale.text("datetime.unknown", str.substring(j)));
	}

	_walkFormat(format, {
		literal: function(literal) {
			if (str.substring(j, j + literal.length) !== literal) throw new Error(locale.text("datetime.formatMis", literal, str.substring(j)));
			j += literal.length;
		},
		d: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					day = parseInteger(2);
					break;
				case 3:
					weekday = parseName(_dateInfo().abbreviatedDayNames);
					break;
				case 4:
					weekday = parseName(_dateInfo().dayNames);
					break;
				default:
					throw new Error(locale.text("datetime.badDay", format.substring(j))); // replaced i with j
			}
		},
		M: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					month = parseInteger(2);
					break;
				case 3:
					month = parseName(_dateInfo().abbreviatedMonthNames) + 1;
					break;
				case 4:
					month = parseName(_dateInfo().monthNames) + 1;
					break;
				default:
					throw new Error(locale.text("datetime.badDay", format.substring(j))); // replaced i with j
			}
		},
		y: function(arg) {
			switch (arg) {
				case 2:
					year = parseInteger(2);
					year = year < 40 ? 2000 + year : 1900 + year;
					break;
				case 4:
					year = parseInteger(4);
					year = year > 99 ? year : year < 40 ? 2000 + year : 1900 + year;
					break;
				default:
					throw new Error(locale.text("datetime.badYear", format.substring(j))); // replaced i with j
			}
		},
		H: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					hour = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("datetime.badHour", format.substring(j)));
			}
		},
		h: function(arg) {
			switch (arg) {
				case 1:
				case 2:
					hour = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("datetime.badHour", format.substring(j)));
			}
		},
		m: function(arg) {
			switch (arg) {
				case 2:
					minute = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("datetime.badMin", format.substring(j)));
			}
		},
		s: function(arg) {
			switch (arg) {
				case 2:
					second = parseInteger(2);
					break;
				default:
					throw new Error(locale.text("datetime.badSec", format.substring(j)));
			}
		},
		t: function(arg) {
			switch (arg) {
				case 1:
					abbrTimeMode = parseName(abbrTimeModes);
					break;
				case 2:
					timeMode = parseName(timeModes);
					break;
				default:
					throw new Error(locale.text("datetime.badMarker", format.substring(j)));
			}
		}
	});

	// from 12 format to 24 format, used when necessary

	function from12to24(mode, index) {
		switch (mode[index]) {
			case mode[0]:
				// AM
				hour = hour === 12 ? 0 : hour;
				break;
			case mode[1]:
				// PM
				if (hour >= 1 && hour <= 11) {
					hour += 12;
				}
				break;
		}
	}

	if (timeMode != null || abbrTimeMode != null) {
		if (hour > 12) throw new Error(locale.text("datetime.badHourVal", hour, timeMode));
		var mode = timeMode != null ? timeModes : abbrTimeModes;
		var index = timeMode != null ? timeMode : abbrTimeMode;
		from12to24(mode, index);
	}

	// ignore weekday
	return _make(year, month, day, hour, minute, second, millis);
}

function _getIndexOfZ(format) {
	var i = 0,
		len = format.length;

	function count(i) {
		var ch = format[i],
			k = 1;
		while (format[i + k] === ch)
			k++;
		return k;
	}

	while (i < len) {
		var c = format[i];
		if (c === "'") {
			i++;
			var literal = '';
			// going to the end of the following litteral or to the format end
			for (; i < len; i++) {
				if (format[i] === "'") {
					i++;
					// check wether the "'" is not doubled
					if (format[i] === "'") {
						literal += "'";
					} else break;
				} else {
					literal += format[i];
				}
			}
		} else if (c === 'Z') {
			return i;
		} else {
			i++;
		}
	}
}
});

define('syracuse-tablet/html/js/helpers/types/numberFormat',['require','exports','module','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var locale = require("syracuse-tablet/html/js/helpers/locale");

//======================
//	Useful elements
//======================

/**
 * Format object used to handle format. Useful for the formatting and parsing methods
 * @param {Object} prefix	Any text before directives
 * @param {Object} postfix	Any text after directives
 * @param {Object} properties	Properties are : hasDecimalSeparator, hasGroupSeparator, mandatoryAfter, maxAfter, groupSize, mandatoryBefore, directive, hasPercent, hasPermil, hasSignFormat
 */
function FormatObj(prefix, postfix, properties) {
	this.prefix = prefix;
	this.postfix = postfix;
	this.properties = properties;
}

/**
 * Set number format properties from directive parameter.
 * @param {String}	directive
 * @param {Object}	fObj
 * @return {Object}	Returns a formatObj with properties set
 */
function _processDirective(directive, fObj) {
	// properties to set:   

	// result
	var f = new FormatObj(fObj.prefix, fObj.postfix, fObj.properties);

	var hasDecimalSeparator, hasGroupSeparator;

	var dsIndex = directive.indexOf('.');
	var gsIndex = directive.indexOf(',');

	// decimal and group separator properties
	f.properties.hasDecimalSeparator = hasDecimalSeparator = dsIndex > -1;
	f.properties.hasGroupSeparator = hasGroupSeparator = gsIndex > -1;

	// after properties	
	if (hasDecimalSeparator) {
		var decimal = directive.substring(dsIndex + 1);
		f.properties.mandatoryAfter = decimal.indexOf("0") > -1 ? decimal.match(/0/g).length : 0;
		f.properties.maxAfter = decimal.length;
	}

	// group size property
	if (hasGroupSeparator) {
		f.properties.groupSize = hasDecimalSeparator ? dsIndex - gsIndex - 1 : directive.substring(gsIndex + 1).length;
	}

	// before property
	var integer = hasDecimalSeparator ? directive.substring(0, dsIndex) : directive;
	f.properties.mandatoryBefore = integer.indexOf("0") > -1 ? integer.match(/0/g).length : 0;

	// directive
	f.properties.directive = directive;

	// percent/permil property
	f.properties.hasPercent = directive.indexOf("%") > -1;
	f.properties.hasPermil = directive.indexOf("‰") > -1;

	// sign format
	f.properties.hasSignFormat = directive.indexOf('+') > -1 && directive.indexOf('+') === 0;

	return f;
}

/**
 * Walk through the given format and run functions in map
 * @param {Object} format
 * @param {Object} map
 */
function _walkFormat(format, map) {
	var i = 0,
		len = format.length;

	// valid directive characters in format (except ';')
	var validDir = "0#.,%‰+"; //	'E' or 'e' are not supported yet
	function count(i) {
		var ch = format[i],
			k = 1;
		while (validDir.indexOf(format[i + k]) > -1)
			k++;
		return k;
	}

	while (i < len) {
		var c = format[i];
		switch (c) {
			case "'":
				i++;
				var literal = '';
				// going to the end of the following litteral or to the format end
				for (; i < len; i++) {
					if (format[i] === "'") {
						i++;
						// check wether the "'" is not doubled
						if (format[i] === "'") {
							literal += "'";
						} else break;
					} else {
						literal += format[i];
					}
				}
				map.literal(literal);
				break;
			case "0":
			case "#":
			case ".":
			case "%":
			case "‰":
			case "+":
				var directiveLength = count(i);
				map.directive(i, i + directiveLength);
				i += directiveLength;
				break;
			case ";":
				map.listSeparator();
				i++;
				break;
			default:
				map.literal(c);
				i++;
		}
		// at the end of the loop
		if (i === len) {
			map.listSeparator();
		}
	}
}

/**
 * Add separator parameter after every digits group of size value to the number paramater.
 * @param {Object} num
 * @param {Object} gs
 * @param {Object} size
 */
function _addSeparator(num, gs, size) {
	var result = "";
	var len = num.length;
	var c = "";
	var count = 0;
	for (var i = len - 1; i >= 0; i--) {
		c = num[i];
		result += c;
		++count;
		if ((count % size === 0) && i > 0) {
			result += gs;
		}
	}
	return result.split("").reverse().join("");
}

//======================
//	Format functions
//======================

/**
 * Forat a number
 * @param {Object} val	Raw number
 * @param {Object} format	Format to apply
 * @return {String} Returns a string value containing formatted number
 */
exports.format = function(val, format) {

	//	if (!val)
	//		throw new Error("empty number value");

	if (isNaN(val)) throw new Error(locale.text("numberFormat.notNumber", val));

	if (format == null) {
		val = val.toString();
		var dsIndex = val.indexOf('.');
		var hasDecimal = dsIndex > -1;
		var intPart = hasDecimal ? val.substring(0, dsIndex) : val;
		var decimalPart = hasDecimal ? val.substring(dsIndex + 1) : '';
		var gs = locale.getNumberGroupSeparator() || "";
		var ds = hasDecimal ? (locale.getNumberDecimalSeparator() || ".") : '';
		return _addSeparator(intPart, gs, 3) + ds + decimalPart;
	} else {
		return _format(val, format);
	}

};

function _format(val, format) {
	var prefix, postfix;
	// position in val
	var j = 0;
	// format list (used in case of list of formats separated with ';', empty otherwise)
	var formatsList = [];

	var directiveProcessed = false;

	var f = new FormatObj('', '', {});

	_walkFormat(format, {
		literal: function(literal) {
			// set prefix or postfix value
			directiveProcessed ? f.postfix += literal : f.prefix += literal;
		},
		directive: function(beg, end) {
			// get directive part of the format
			var directive = format.substring(beg, end);

			// process directive
			f = _processDirective(directive, f);

			directiveProcessed = true;
		},
		listSeparator: function() {
			directiveProcessed = false;
			formatsList.push(f);
			f = new FormatObj('', '', {});
			prefix = '';
			postfix = '';
		}
	});

	var flen = formatsList.length;
	switch (flen) {
		case 1:
			return _formatNumber(val, formatsList[0]);
			break;
		case 2:
		case 3:
			if (val === 0) return _formatZero(formatsList[2]);
			else return val < 0 ? _formatNumber(val.toString().substring(1), formatsList[1]) : _formatNumber(val, formatsList[0]);
			break;
		default:
			throw new Error(flen === 0 ? locale.text("numberFormat.noFormat") : locale.text("numberFormat.manyFormat"));
	}
}

function _formatZero(fObj) {
	return fObj.prefix;
}

function _formatNumber(num, fObj) {
	var res = '';

	// locale separators
	var gs = locale.getNumberGroupSeparator();
	var ds = locale.getNumberDecimalSeparator();

	var directive = fObj.properties.directive;

	// special case for percentages
	num = fObj.properties.hasPercent ? num * 100 : num;
	num = fObj.properties.hasPermil ? num * 1000 : num;

	// == decimal ==
	if (fObj.properties.hasDecimalSeparator) {
		var decimalPart = '';
		var maxAfter = fObj.properties.maxAfter;
		var decimalFormat = directive.substr(directive.indexOf('.') + 1, maxAfter);
		var decimalValue = num % 1;
		var decimalString = '' + decimalValue.toFixed(maxAfter);
		decimalString = decimalString.substring(decimalString.indexOf('.') + 1);
		for (var i = 0; i < maxAfter; i++) {
			var f = decimalFormat.charAt(i);
			var n = decimalString.charAt(i);
			if (f === '0') {
				decimalPart += n;
			} else if (f === '#' && n !== '0') {
				decimalPart += n;
			} else if (f === '#' && n === '0') { // end loop if only '0' left in decimalString
				var notParsed = decimalString.substring(i);
				if (notParsed.match('[1-9]')) decimalPart += n;
				else break;
			}
		}
		res = decimalPart ? ds + decimalPart : res; // in case of integer value, decimalPart --> ''
	} else {
		// it is possible to have decimal number and format not containing decimal separator
		num = Math.round(num);
	}

	// == integer ==
	var intPart = num < 0 ? '' + Math.ceil(num) : '' + Math.floor(num);
	intPart = intPart.replace(/[^\d]+/g, '');
	var intFormat = directive.indexOf('.') === -1 ? directive : directive.substring(0, directive.indexOf('.'));
	// padding if necessary
	if (intPart.length < fObj.properties.mandatoryBefore) {
		var missing = fObj.properties.mandatoryBefore - intPart.length;
		var toAdd = '';
		for (var i = 0; i < missing; i++) {
			toAdd += '0';
		}
		intPart = toAdd + intPart;
	}
	// adding group separator if needed
	if (fObj.properties.hasGroupSeparator) {
		if (fObj.properties.groupSize < intPart.length) {
			intPart = _addSeparator(intPart, gs, fObj.properties.groupSize);
		}
	}

	// in case of no mandatory digit before decimal separator, no character for int part
	intPart = (parseInt(intPart, 10) === 0 && fObj.properties.mandatoryBefore === 0) ? '' : intPart;

	intPart = intPart && num < 0 ? '-' + intPart : intPart;
	res = intPart + res;

	// == specific cases ==
	// sign format
	res = fObj.properties.hasSignFormat && num > 0 ? '+' + res : res;

	// percent and/or permil
	res += fObj.properties.hasPercent ? "%" : '';
	res += fObj.properties.hasPermil ? "‰" : '';

	return fObj.prefix + res + fObj.postfix;
}

//======================
//	Parsing functions
//======================

// * @param {Object} fn	Function called if number returned doesn't match with the integer type (only use)
// exports.parse = function(str, format, fn){
/**
 * Get a number from a formatted number string value
 * @param {Object} str	Formatted number
 * @param {Object} format	Format supposedly used
 * @return {Object}	Returns a number (integer : floor(number), decimal : BigDecimal, real : number)
 */
exports.parse = function(str, format) {
	if (!str) return 0;
	//throw new Error("number string is null");

	if (format == null) {
		return parseFloat(str);
	} else {
		return _parse(str, format);
	}
};

function _parse(str, format) {
	//format = /[0-9-+,.#eE%‰;()\s]/g.exec();
	var prefix, postfix;

	// position in str
	var j = 0;

	// format list (used in case of list of formats separated with ';', empty otherwise)
	var formatsList = [];

	var directiveProcessed = false;

	var f = new FormatObj('', '', {});

	_walkFormat(format, {
		literal: function(literal) {
			// set prefix or postfix value
			directiveProcessed ? f.postfix += literal : f.prefix += literal;
		},
		directive: function(beg, end) {
			// get directive part of the format
			var directive = format.substring(beg, end);

			// process directive
			f = _processDirective(directive, f);

			directiveProcessed = true;
		},
		listSeparator: function() {
			directiveProcessed = false;
			formatsList.push(f);
			f = new FormatObj('', '', {});
			prefix = '';
			postfix = '';
		}
	});

	return _parseFormats(str, formatsList);
}

function _parseFormats(str, formatsList, negative) {
	var flen = formatsList.length;
	var num;
	// locale separators
	var gs = locale.getNumberGroupSeparator();
	var ds = locale.getNumberDecimalSeparator();

	switch (flen) {
		case 1:
			var fObj = formatsList[0];
			var formatNumber = str;
			var integerPart, decimalPart;
			// extract prefix and postfix
			var prefix = fObj.prefix;
			var postfix = fObj.postfix;
			formatNumber = prefix ? formatNumber.substring(prefix.length) : formatNumber;
			formatNumber = postfix ? formatNumber.substring(0, formatNumber.length - postfix.length) : formatNumber;

			// splitting into integer and decimal parts
			var splitted = formatNumber.split(ds);
			// error : too many periods
			if (splitted.length > 2) throw new Error(locale.text("numberFormat.oneSep", formatNumber));
			// setting integer and decimal parts values
			integerPart = splitted[0] ? splitted[0].match(/[0-9]/g).join('') : '0';
			decimalPart = splitted.length > 1 ? splitted[1].match(/[0-9]/g).join('') : '';
			num = parseFloat(decimalPart ? integerPart + "." + decimalPart : integerPart);

			// == specific cases ==
			// negative value
			num = formatNumber.charAt(0) === '-' ? parseFloat('-' + num) : num;
			// percent or permil
			num = fObj.properties.hasPercent ? num / 100 : num;
			num = fObj.properties.hasPermil ? num / 1000 : num;
			// negative value set for list separator cases
			num = negative ? parseFloat('-' + num) : num;
			break;
		case 2:
		case 3:
			// valid characters in formatted number
			var validFormat = "1234567890" + ds + gs + "%‰-+"; // 'E' or 'e' are not supported yet
			var len = formatsList.length;
			var slen = str.length;

			for (var i = 0; i < len; i++) {
				var f = formatsList[i];
				var prefix = f.prefix;
				var postfix = f.postfix;

				var prefixDefined = prefix ? true : false;
				var postfixDefined = postfix ? true : false;

				var pre, post;

				pre = prefixDefined ? str.substring(0, prefix.length) : '';
				post = postfixDefined ? str.substring(slen - postfix.length) : '';

				if (((prefixDefined && !postfixDefined) && pre.indexOf(prefix) > -1) || ((prefixDefined && postfixDefined) && (pre.indexOf(prefix) > -1 && post.indexOf(postfix) > -1)) || ((!prefixDefined && postfixDefined) && post.indexOf(postfix) > -1) || ((!prefixDefined && !postfixDefined) && (validFormat.indexOf(str.charAt(0)) > -1 && validFormat.indexOf(str.charAt(slen - 1)) > -1))) {
					break;
				}
			}
			var flist = [];
			flist.push(formatsList[i]);
			switch (i) {
				case 0:
					num = _parseFormats(str, flist);
					break;
				case 1:
					num = _parseFormats(str, flist, true);
					break;
				case 2:
					num = 0;
					break;
				default:
					throw new Error(locale.text("numberFormat.cannotParse"));
			}
			break;
		default:
			throw new Error(flen === 0 ? locale.text("numberFormat.noFormat") : locale.text("numberFormat.manyFormats"));
	}
	return num;
}
});

define('syracuse-tablet/html/js/helpers/formatApi',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/locale','syracuse-tablet/html/js/helpers/types/date','syracuse-tablet/html/js/helpers/types/datetime','syracuse-tablet/html/js/helpers/types/time','syracuse-tablet/html/js/helpers/types/numberFormat'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var date = require('syracuse-tablet/html/js/helpers/types/date');
var datetime = require('syracuse-tablet/html/js/helpers/types/datetime');
var time = require('syracuse-tablet/html/js/helpers/types/time');
var numberFormat = require('syracuse-tablet/html/js/helpers/types/numberFormat');

var _cache = {};
var _cacheLocaleHash;

exports.getFormatter = function($type, $format) {
	var ctor = _formatters[$type];
	if (!ctor) {
		return null;
	}
	var curLocaleHash = locale.getCurrentLocaleHash();
	if (curLocaleHash !== _cacheLocaleHash) {
		_cacheLocaleHash = curLocaleHash;
		_cache = {};
	}
	var cache = _cache[$type];
	if (!cache) cache = _cache[$type] = {};
	var key = $format || "noformat";
	var fmt = cache[key];
	if (fmt) return fmt;
	fmt = new ctor($type, $format);
	cache[key] = fmt;
	return fmt;
};

var Formatter = utils.defineClass(function($type, $format) {
	this.$format = $format;
	this.$type = $type;
}, null, {

	_isEmpty: function(value) {
		if (value == null)
			return true;
		value = "" + value;
		value = value.trim();
		if (value === "")
			return true;
		return false;
	},

	/*
	 * Format a value for displaying
	 * This will be used on read only fields to format the internal value to a human readable localized pattern.
	 * Also, this will be used to format values in editable fields BEFORE putting the focus into the field for editing
	 *
	 */
	formatValue: function(value) {
		return value;
	},

	/*
	 * Format a value for editing it
	 *
	 * This will be used to format values in editable fields AFTER putting the focus into the field for editing.
	 *
	 * Example, in case of dates:
	 * A field displays "April, 1. 2014"
	 * Once the focus is put into the field, it will render the value as "01.04.2014" since it's easier to edit
	 */
	formatValueEdit: function(value) {
		return value;
	},

	/* 
	 * Parse any kind of input string to the internal representation
	 */
	parseValue: function(value, errors) {
		errors.push("No parser for this type, return this dummy error to not override value by null");
	},

	getFormat: function() {
		return this.format;
	}
});

var DateFormatter = utils.defineClass(function($type, $format) {
	Formatter.call(this, $type, $format);
	this.format = locale.getDateFormat();
	this.twoDigitYearSwitch = 40;
}, Formatter, {
	_isEmpty: function(value) {
		if (value == null)
			return true;
		value = "" + value;
		value = value.trim();
		if (value === "")
			return true;

		if (value === "0000-00-00")
			return true;

		return false;
	},

	_checkShortYear: function(year) {
		if (year.year) {
			// Date object
			var y = year.year;
			if (y < 100) {
				year.add({
					years: y < this.twoDigitYearSwitch ? 2000 : 1900
				});
			}
		} else {
			// Number
			year = year > 99 ? year : (year < this.twoDigitYearSwitch ? 2000 + year : 1900 + year);
		}
		return year;
	},

	/**
	 * value expected to be a date string like "2014-08-19"
	 */
	formatValue: function(value) {
		if (this._isEmpty(value)) {
			return "";
		}

		var p = value.split(/[^\d]+/);
		var format;
		if (p.length >= 3) {
			p[0] = this._checkShortYear(+p[0]);
			var d = date.make(+p[0], +p[1], +p[2]);
			format = d.toString(this.format);
		} else {
			format = value;
		}
		return format;
	},
	parseValue: function(value, errors) {
		var fmt;
		if (this._isEmpty(value)) {
			return "";
		}
		try {
			fmt = date.parse(value, this.format);
			fmt = this._checkShortYear(fmt);
		} catch (e) {
			errors.push(locale.text("field.invalidInput", [this.format]));
			return value;
		}
		return fmt.toString("yyyy-MM-dd");
	}
});

var DateTimeFormatter = utils.defineClass(function($type, $format) {
	DateFormatter.call(this, $type, $format);
	this.format = locale.getDateTimeFormat();
}, DateFormatter, {
	_isEmpty: function(value) {
		if (value == null)
			return true;
		value = "" + value;
		value = value.trim();
		if (value === "")
			return true;

		if (value === "0000-00-00T00:00:00Z")
			return true;

		return false;
	},
	/**
	 * value expected to be a date string like "2010-10-13T13:25:03.424Z"
	 */
	formatValue: function(value) {
		if (this._isEmpty(value)) {
			return datetime.now().toString(this.format);
			//return "";
		}

		var p = value.split(/[^\d]+/);
		var format;
		if (p.length >= 6) {
			p[0] = this._checkShortYear(+p[0]);
			var d = datetime.make(+p[0], +p[1], +p[2], +p[3], +p[4], +p[5]);
			format = d.toString(this.format);
		} else {
			format = value;
		}
		return format;
	},
	parseValue: function(value, errors) {
		var fmt;
		if (this._isEmpty(value)) {
			return "";
		}

		try {
			fmt = datetime.parse(value, this.format);
			fmt = this._checkShortYear(fmt);
		} catch (e) {
			errors.push(locale.text("field.invalidInput", [this.format]));
			return value;
		}
		return fmt.toString("yyyy-MM-ddTHH:mm:ss.SSS") + "Z";
	}
});

var TimeFormatter = utils.defineClass(function($type, $format) {
	Formatter.call(this, $type, $format);
	if (this.$format === "TT") {
		this.format = locale.getTimeFormat();
	} else {
		this.format = locale.getTimeFormatShort();
	}
}, Formatter, {
	/**
	 * value expected to be a date string like "13:25:03"
	 */
	formatValue: function(value) {
		if (this._isEmpty(value)) {
			return "";
		}

		var p = value.split(/[^\d]+/);
		var format;
		if (p.length >= 2) {
			var t = time.make(+p[0], +p[1], +p[2]);
			format = t.toString(this.format);
		} else {
			format = value;
		}
		return format;
	},
	parseValue: function(value, errors) {
		if (this._isEmpty(value)) {
			return "";
		}
		var p = value.split(/[^\d]+/);
		if (p.length >= 1) {
			var t = time.make(+p[0], +p[1], +p[2]);
			return t.toString("HH:mm:ss");
		}
	}
});

var NumberFormatter = utils.defineClass(function($type, $format) {
	Formatter.call(this, $type, $format);
	this.format = this.$format || locale.getNumberFormat(this.$type);
}, Formatter, {
	/*
	 * value to be expected to be a number
	 */
	formatValue: function(value) {
		if (this._isEmpty(value)) {
			return "";
		}
		var format = numberFormat.format(value, this.format);
		return format;
	},
	parseValue: function(value, errors) {
		if (this._isEmpty(value)) {
			return "";
		}
		try {
			var fmt = numberFormat.parse(value, this.format);
		} catch (e) {
			errors.push(locale.text("field.invalidInput", [this.format]));
			return value;

		}
		return fmt;
	}
});

var _formatters = {
	"application/x-integer": NumberFormatter,
	"application/x-decimal": NumberFormatter,
	"application/x-real": NumberFormatter,

	"application/x-date": DateFormatter,
	"application/x-time": TimeFormatter,
	"application/x-datetime": DateTimeFormatter
};
});

define('syracuse-tablet/html/js/controls/validator',['require','exports','module','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var locale = require('syracuse-tablet/html/js/helpers/locale');

/*
 *
 * Collection of all SData contraints and a validation function per constraint
 *
 */

var _validator = {
	validate: function(ctrl, value, errors, constraints) {
		var proto = ctrl.prototype;
		var ok = true;
		for (var i = 0; i < constraints.length; i++) {
			var c = constraints[i];
			var prop = proto && proto.data(c);
			if (prop != null) { // constraint set in prototype
				var fn = _validator[c];
				if (fn) {
					ok = fn(value, errors, prop) && ok;
				} else {
					errors.push(locale.text("field.unknownConstraint", [c]));
					ok = false;
				}
			}
		}
		return ok;
	},

	// General
	$isMandatory: function(value, errors, constraint) {
		if (constraint && value == null || value == "") {
			errors.push(locale.text("field.valMand"));
			return false;
		}
	},

	// Strings
	$pattern: function(value, errors, constraint) {
		var self = this;
		if (value && constraint) {
			var re = new RegExp(constraint);
			if (!re.test(value)) {
				errors.push(locale.text("field.patternError", [constraint]));
				return false;
			}
		}
		return true;
	},

	// Numeric
	$minimum: function(value, errors, constraint) {
		var self = this;
		if (value != null && value < constraint) {
			errors.push(locale.text("field.minimum", [constraint]));
			return false;
		}
		return true;
	},
	$maximum: function(value, errors, constraint) {
		var self = this;
		if (value != null && value > constraint) {
			errors.push(locale.text("field.maximum", [constraint]));
			return false;
		}
		return true;
	},
	$exclusiveMinimum: function(value, errors, constraint) {
		var self = this;
		if (value != null && value <= constraint) {
			errors.push(locale.text("field.exclusiveMinimum", [constraint]));
			return false;
		}
		return true;
	},
	$exclusiveMaximum: function(value, errors, constraint) {
		var self = this;
		if (value != null && value >= constraint) {
			errors.push(locale.text("field.exclusiveMaximum", [constraint]));
			return false;
		}
		return true;
	},
	$minLength: function(value, errors, constraint) {
		var self = this;
		if (!value || value.length < constraint) {
			errors.push(locale.text("field.minLength", [constraint]));
			return false;
		}
		return true;
	},
	$maxLength: function(value, errors, constraint) {
		var self = this;
		if (value && value.length > constraint) {
			errors.push(locale.text("field.maxLength", [constraint]));
			return false;
		}
		return true;
	},
	$precision: function(value, errors, constraint) {
		var self = this;
		if (value) {
			var txt = ("" + value).split(".").join("");
			if (txt.length > constraint) {
				errors.push(locale.text("field.precision", [constraint]));
				return false;
			}
		}
		return true;
	},
	$scale: function(value, errors, constraint) {
		var self = this;
		if (value) {
			var txt = ("" + value).split(".");
			txt = txt && txt[1] || "";
			if (txt.length > constraint) {
				errors.push(locale.text("field.scale", [constraint]));
				return false;
			}
		}
		return true;
	},

};

exports.Validator = _validator;
});

define('syracuse-tablet/html/js/controls/field/ctrlFieldBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/ctrlBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/formatApi','syracuse-tablet/html/js/controls/validator'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var formatApi = require('syracuse-tablet/html/js/helpers/formatApi');
var validator = require('syracuse-tablet/html/js/controls/validator').Validator;

/**
 * Base class for controls that display exactly one value/property
 */
var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self.$format = prototype.data('$format');
		self.formatter = formatApi.getFormatter(self.$type, self.$format);
		self.ensureEditMode();
	}, Base, {

		ensureEditMode: function() {
			var self = this;
			// Get page edit mode
			self.$isEditMode = self.controller.isEditMode();
			if (self.$isEditMode !== false) {
				// if page is NOT in read only mode, article can override edit mode of widget
				if (self.article.$isEditMode != null) {
					self.$isEditMode = self.article.$isEditMode;
				}
			}
		},

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			self.formatter = null;
		},

		getTitle: function() {
			var self = this;
			return self.prototype.getPropTitle(self.$bind);
		},

		getPropertyType: function() {
			var self = this;
			return self.prototype.data("$type");
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			if (!controllerDao) throw new Error("BuildHtml - dao is expected for data parameter");
			buildOptions = buildOptions || {};
			self.dao = controllerDao;
			var classes = ["s-m-control s-m-field-slot"];
			if (self.prototype.data("$isAdvanced") === true) {
				classes.push("s-m-field-advanced");
			}
			self.createRootElement(classes, $$parent);
			var fieldSlot = self.$$elmt.get(0);
			this.buildFieldTitle(fieldSlot, buildOptions);
			this.buildFieldCore(fieldSlot, buildOptions);
		},

		buildFieldTitle: function(parentSlot, buildOptions) {
			var self = this;
			// don't build field title if grid cell
			if (!(self.article.$isTitleHidden === true) && buildOptions.isGridCell !== true) {
				parentSlot.appendChild(uiUtils.createDomElement("div", ["s-m-field-title"], self.getTitle()));
			}
		},

		buildFieldCore: function(parentSlot, buildOptions) {
			var fieldCore = uiUtils.createDomElement("div", ["s-m-field-core"]);
			var fieldValueSlot = uiUtils.createDomElement("div", ["s-m-field-value-slot"]);
			var fieldValue = uiUtils.createDomElement("div", ["s-m-field-value"]);
			fieldValueSlot.appendChild(fieldValue);
			fieldCore.appendChild(fieldValueSlot);

			this.buildFieldValue(fieldValue, buildOptions);
			this.buildFieldMessage(fieldCore, buildOptions);

			parentSlot.appendChild(fieldCore);
		},

		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value;

			value = self.getFormattedValue(self.getValue());
			if (this.$isEditMode) {
				self.domInput = parentSlot.appendChild(uiUtils.createDomElement("input", ["s-m-field-input", "form-control", "ctrl-evt-blur"], null, {
					"type": "text",
					"value": value

				}));
			} else {
				self.appendTextValue(parentSlot, value);
			}
		},

		appendTextValue: function(parentSlot, value) {
			return uiUtils.createDomElement("div", ["s-m-field-value-read"], value || null, null, parentSlot);
		},

		buildFieldMessage: function(parentSlot, buildOptions) {
			this.domMessage = uiUtils.createDomElement("div", ["s-m-field-message"]);
			parentSlot.appendChild(this.domMessage);
		},

		/*
		 * value: value inputed into the field as string
		 * errors: array where to add validation errors as strings
		 * return true if ok
		 */
		validateValue: function(value, errors) {
			var ok = true;
			ok = validator.validate(this, value, errors, ["$isMandatory"]) && ok;
			return ok;
		},

		/*
		 * value: value inputed into the field as string
		 * errors: array where to add parsing errors as strings
		 *
		 * return: Parsed value as represented in sdata data
		 * E.g. "2014-12-31" for dates or 123 for numbers
		 */
		parseValue: function(value, errors) {
			if (!this.formatter) {
				return value;
			}
			return this.formatter.parseValue(value, errors);
		},
		showInputErrors: function(errors) {
			var $$msg = $(this.domMessage);
			$$msg.empty();
			if (errors) {
				errors.forEach(function(error) {
					$$msg.append($("<p>").text(error));
				});
			}
		},
		clearInputErrors: function() {
			this.showInputErrors(null);
		},

		/*
		 * Get value as string to be displayed in control (ev. formatted specific to locale)
		 */
		getFormattedValue: function(value) {
			if (!this.formatter) {
				return value || "";
			}
			return this.formatter.formatValue(value);
		},

		getValue: function() {
			return this.dao.getValue(this.$bind);
		},

		/*
		 * Change visible value (UI only)
		 * value parameter must be formatted already!
		 */
		setDisplayValue: function(value) {
			if (this.domInput) {
				this.domInput.value = value;
			}
		},

		/*
		 * Change internal value (non UI only)
		 * value parameter must be a correct datatype value without UI specific formatting
		 */
		setValue: function(value) {
			this.dao.setValue(this.$bind, value);
		},

		/*
		 * Set internal value (controller) and visible formatted value (UI) by applying formatting if needed
		 * value parameter must be a correct datatype value without UI specific formatting
		 */
		setFieldValue: function(value) {
			var self = this;
			self.setDisplayValue(self.getFormattedValue(value));
			self.dao.setValue(self.article.$bind, value);
		},

		onBlur: function() {
			var value = this.domInput.value;
			var errors = [];

			value = this.parseValue(value, errors);
			if (errors.length > 0) {
				this.showInputErrors(errors);
				return;
			}

			// Set displayed value, also it may violate constraints later
			// This is because a parseable value is reformatted here to emiminate wrong characters
			// Internat value remains unchanged until all constraints are met
			this.setDisplayValue(this.getFormattedValue(value));

			this.validateValue(value, errors);
			if (errors.length > 0) {
				this.showInputErrors(errors);
			} else {
				this.clearInputErrors();
				this.setValue(value);
			}
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlAlphanum',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/field/ctrlFieldBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/controls/validator'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var validator = require('syracuse-tablet/html/js/controls/validator').Validator;

var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		validateValue: function(value, errors) {
			var self = this;
			var ok = Base.prototype.validateValue.call(self, value, errors);
			ok = validator.validate(this, value, errors, ["$pattern", "$minLength", "$maxLength"]) && ok;
			return ok;
		}
	});

var _PhoneField = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		_Klass.call(self, controller, article, prototype);
	}, _Klass, {
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value = self.getValue();
			// return input if editMode
			if (this.$isEditMode) {
				parentSlot.appendChild(uiUtils.createDomElement("input", ["s-m-field-input", "form-control"], null, {
					"type": "text",
					"value": value
				}));
			} else {
				// return a link (<a>) with 'tel:' protocol
				// phone field value

				// phone field value as a link
				var link = uiUtils.createDomElement("a", ["s-m-phone-link"], value, {
					"href": "tel:" + value
				});
				// bootstrap span to display icon
				link.appendChild(uiUtils.createDomElement("span", ["s-m-phone-badge", "badge", "pull-left"]));

				// value container
				var container = self.appendTextValue();
				container.appendChild(link);

				parentSlot.appendChild(container);
			}
		}
	});


var _EmailField = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		_Klass.call(self, controller, article, prototype);
	}, _Klass, {
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value = self.getValue();
			// return input if editMode
			if (this.$isEditMode) {
				parentSlot.appendChild(uiUtils.createDomElement("input", ["s-m-field-input", "form-control"], null, {
					"type": "text",
					"value": value
				}));
			} else {
				// return a link (<a>) with 'mailto:' protocol
				// phone field value
				// email field value as a link
				var link = uiUtils.createDomElement("a", ["s-m-email-link"], value, {
					"href": "mailto:" + value
				});
				// bootstrap span to display icon
				link.appendChild(uiUtils.createDomElement("span", ["s-m-email-badge", "badge", "pull-left"]));

				// value container
				var container = self.appendTextValue();
				container.appendChild(link);

				parentSlot.appendChild(container);
			}
		}
	});

exports.Klass = _Klass;
exports.PhoneField = _PhoneField;
exports.EmailField = _EmailField;
});

define('syracuse-tablet/html/js/controls/field/ctrlProgress',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/controls/field/ctrlFieldBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;

var defaultValues = {
	$valueMin: 0,
	$valueMax: 100
};

var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		buildFieldValue: function(parentSlot, controllerDao, buildOptions) {
			var self = this;
			// building progress bar layout based on bootstrap component
			var value = self.getValue();
			var progressContainer = uiUtils.createDomElement("div", ["progress"]);
			var progressBar = uiUtils.createDomElement("div", ["progress-bar"], value, {
				"role": "progressbar",
				"aria-valuenow": value,
				"aria-valuemin": self.article.$valueMin || defaultValues.$valueMin,
				"aria-valuemax": self.article.$valueMax || defaultValues.$valueMax,
				"style": "width:" + value + "%;"
			});
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlNumeric',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/field/ctrlFieldBase','syracuse-tablet/html/js/controls/validator','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var validator = require('syracuse-tablet/html/js/controls/validator').Validator;
var locale = require('syracuse-tablet/html/js/helpers/locale');

var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		parseValue: function(value, errors) {
			var self = this;
			if (self.formatter) {
				var format = self.formatter.getFormat();
				if (format) {
					var gs = locale.getNumberGroupSeparator();
					var ds = locale.getNumberDecimalSeparator();

					if (format.indexOf(",") < 0 && gs && gs.length > 0) {
						// Format with no GS, consider eventual GS as DS
						value = value.replace(new RegExp(gs, "g"), ds);
					}
					if (format.indexOf(",") > 0 && format.indexOf(".") > 0 && gs && gs.length > 0) {
						// Format with GS and DS, consider GS as DS if no DS entered
						if (value.indexOf(gs) > -1 && value.indexOf(ds) < 0) {
							value = value.replace(new RegExp(gs, "g"), ds);
						}
					}
				}
			}
			return Base.prototype.parseValue.call(self, value, errors);
		},

		validateValue: function(value, errors) {
			var self = this;
			var ok = Base.prototype.validateValue.call(self, value, errors);
			// #4748 do not check "$precision" since the desktop client also does not check it and we do not want to put an extra unexpected constraint
			ok = validator.validate(this, value, errors, ["$minimum", "$maximum", "$exclusiveMinimum", "$exclusiveMaximum"]) && ok;
			if (this.$type !== "application/x-integer") {
				ok = validator.validate(this, value, errors, ["$scale"]) && ok;
			}
			return ok;
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlQuantity',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/prototype','syracuse-tablet/html/js/controls/field/ctrlFieldBase','syracuse-tablet/html/js/controls/ctrlBase','syracuse-tablet/html/js/helpers/formatApi','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/controls/ctrlFactory'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var proto = require('syracuse-tablet/html/js/helpers/prototype');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var ctrlBase = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var formatApi = require('syracuse-tablet/html/js/helpers/formatApi');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');

var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		// Call only super->super->constructor, not direct super class constructor
		ctrlBase.call(self, controller, article, prototype);

		var valueProto = prototype.data('$value');
		self.$format = valueProto.$format;
		self.formatter = formatApi.getFormatter(valueProto.$type, self.$format);
		self.valueTitle = valueProto.$title;
		self.$unit = prototype.data("$unit");

		if (typeof self.$unit == "object") {
			self.unitFieldProto = proto.create(self.$unit);
			self.unitBindName = "$unit";
		} else if (typeof self.$unit == "string") {
			self.unitBindName = self.$unit;
			var parentProto = prototype.parent;
			while (parentProto) {
				self.unitFieldProto = parentProto.property(self.$unit);
				if (self.unitFieldProto) {
					self.unitFieldProto = proto.create(self.unitFieldProto);
					break;
				}
				parentProto = parentProto.parent;
			}
		}

		// Create extra control for UNIT in read only mode
		self.unitCtrl = ctrlFactory.createControl(self.controller, self, {
			"$bind": self.unitBindName,
		}, self.unitFieldProto, self.controller);
		self.unitCtrl.$isEditMode = false;

		self.ensureEditMode();
	}, Base, {

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			if (self.unitCtrl) {
				self.unitCtrl.buildHtml($(self.unitCtrlParent), controllerDao, buildOptions);
			}
		},
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value;
			self.unitCtrlParent = parentSlot;
			value = self.getFormattedValue(self.getValue());
			if (this.$isEditMode) {
				self.domInput = parentSlot.appendChild(uiUtils.createDomElement("input", ["s-m-field-input", "form-control", "ctrl-evt-blur"], null, {
					"type": "text",
					"value": value
				}));

			} else {
				self.appendTextValue(parentSlot, value);
			}
		},
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlCheckBox',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/field/ctrlFieldBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {

		buildFieldTitle: function(parentSlot, buildOptions) {
			var self = this;
			// in edit mode, value is displayed before title
			var method = self.$isEditMode ? Base.prototype.buildFieldCore : Base.prototype.buildFieldTitle;
			method.call(self, parentSlot, buildOptions);
		},

		buildFieldCore: function(parentSlot, buildOptions) {
			var self = this;
			// in edit mode, value is displayed before title
			var method = self.$isEditMode ? Base.prototype.buildFieldTitle : Base.prototype.buildFieldCore;
			method.call(self, parentSlot, buildOptions);
		},


		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var val = self.getValue();
			val = val === true;
			if (this.$isEditMode) {
				self.domInput = uiUtils.createDomElement("input", ["s-m-field-input-boolean", "ctrl-evt-click"], null, {
					"type": "checkbox"
				}, parentSlot);
				self.domInput.checked = val;
			} else {
				parentSlot.appendChild(uiUtils.createDomElement("span", ["glyphicon", val ? "glyphicon-ok" : "glyphicon-remove"]));
			}
		},

		onClick: function(evt) {
			var self = this;
			setTimeout(function() {
				self.domInput.checked = !self.domInput.checked;
				self.setValue(self.domInput.checked);
			}, 50);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlCombo',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/controls/field/ctrlFieldBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;

var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			self.choiceList = self.prototype.data("$value").$enum;
			if (self.$isEditMode) {
				var $format = self.prototype.data("$format");

				// if '$format' is set it can only have values '$combo' or '$radio'
				if ($format && ($format != '$radios' && $format != '$combo')) {
					throw new Error("Choice can only have formats '$radios' or '$combo'");
				}

				// ## set display in case of edit mode ##
				var value = self.currentValue = self.getValue();
				var domValue;
				if (self.choiceList.length > 0) {
					// display in case of '$radios' format
					if (self.prototype.data("$format") == '$radios') {
						self.radioItemList = [];
						$.each(self.choiceList, function(index, choiceItem) {
							// building choice item display
							var choiceItemDom = uiUtils.createDomElement("div", ["s-m-field-radio-item"]);
							var inputDom = uiUtils.createDomElement("input", ["s-m-field-choice-radio", "ctrl-evt-click"], null, {
								"type": "radio",
								"value": index,
								"name": "s-m-radio-" + self.id
							});
							if (value && choiceItem.$value == value) {
								inputDom.setAttribute("checked", true);
							}
							var titleDom = uiUtils.createDomElement("div", ["s-m-field-choice-radio-title"], choiceItem.$title);

							// build radioItemList array
							self.radioItemList.push({
								"inputDom": inputDom,
								"titleDom": titleDom
							});

							// appending to parent layout
							choiceItemDom.appendChild(inputDom);
							choiceItemDom.appendChild(titleDom);
							parentSlot.appendChild(choiceItemDom);
						});
					}

					// default format is '$combo'
					else {

						var selectDom = uiUtils.createDomElement("select", "ctrl-evt-change");

						// build list
						$.each(self.choiceList, function(index, choiceItem) {
							var optDom = uiUtils.createDomElement("option", null, choiceItem.$title, {
								"value": choiceItem.$value
							}, selectDom);
							if ((choiceItem.$value == value) || (!value && index == 0)) {
								optDom.setAttribute("selected", true);
							}
						});

						parentSlot.appendChild(selectDom);
					}
				}
			} else {
				if (self.choiceList.length > 0) {
					self.appendTextValue(parentSlot, self._getChoiceTitle(value));
				}
			}
		},
		_getChoiceTitle: function(value) {
			var self = this;
			var res;
			$.each(self.choiceList, function(index, choice) {
				res = choice.$value == value ? choice.$title : res;
				if (res) {
					return false;
				}
			});
			return res;
		},
		_getChoiceValue: function(title) {
			var self = this;
			var res;
			$.each(self.choiceList, function(index, choice) {
				res = choice.$title == title ? choice.$value : res;
				if (res) {
					return false;
				}
			});
			return res;
		},
		setDisplayValue: function(value, index, pickerText) {
			var self = this;

			if (!self.$isEditMode) {
				self.fieldValue.textContent = self._getChoiceTitle(value);
			} else {
				// in case of radio choice
				if (self.prototype.data("$format") == '$radios') {
					// apply change if new value
					if (value != self.currentValue) {
						// update widget
						$.each(self.radioItemList, function(idx, radioItem) {
							setTimeout(function() {
								// if new choice index is defined
								if (index) {
									radioItem.inputDom.checked = index == idx;
								}
								// if new choice index is not defined
								else {
									radioItem.inputDom.checked = self.choiceList[idx].$value == value;
								}
							}, 5);
						});
					}
				}

			}
		},
		setFieldValue: function(value, index, pickerText) {
			var self = this;

			self.setDisplayValue(value, index, pickerText);

			self.currentValue = value;
			self.dao.setValue(self.article.$bind, value);
		},
		onClick: function(evt) {
			var self = this;
			if (self.prototype.data("$format") == '$radios') {
				self.setFieldValue(self._getChoiceValue(evt.target.nextElementSibling.textContent), $(evt.target.parentNode).index());
			}
		},
		onChange: function(evt) {
			this.setFieldValue(evt.target.value, evt.target.selectedIndex, evt.target.selectedOptions[0].textContent);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/monthChoice',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/types/date'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var _dateApi = require('syracuse-tablet/html/js/helpers/types/date');

var _Klass = utils.defineClass(

	function() {

	}, null, {
		create: function(parentSlot, dateValue, handler) {
			this.parent = parentSlot;
			this.handler = handler;
			this.domItem = document.createElement("nav");
			this.domItem.className = "s-calendar-quick-list";
			this._dateValue = dateValue;
			var table = document.createElement("table");
			table.className = "s-calendar-month-choice";
			var tbody = document.createElement("tbody");
			for (var ii = 0; ii < 6; ii++) {
				var row = document.createElement("tr");
				row.appendChild(this.drawCell(ii + 1, _dateApi.monthName(ii + 1, true), this._dateValue.month));
				row.appendChild(this.drawCell(ii + 7, _dateApi.monthName(ii + 7, true), this._dateValue.month));
				tbody.appendChild(row);
			}
			table.appendChild(tbody);
			this.domItem.appendChild(table);
			//this.domItem.style.display = "none";
			this.parent.appendChild(this.domItem);
			this.bindEvents(true);
		},
		drawCell: function(value, text, selValue) {
			var td = document.createElement("td");
			td.className = "s-calendar-my-item";
			td.syraOnClick = "onMonthClick";
			td.syraValue = value;
			td.textContent = text;
			if (value == selValue) {
				td.className += " s-calendar-select";
				this.selectedCell = td;
			}
			return td;
		},
		toggle: function(show) {
			if (show) {
				this.domItem.style.display = "";
			} else {
				this.domItem.style.display = "none";
			}
		},
		onMonthClick: function(picker) {
			if (this.selectedCell) {
				this.selectedCell.className = "s-calendar-my-item";
			}
			(this.selectedCell = picker).className = "s-calendar-my-item s-calendar-select";
			this._selectedMonth = picker.syraValue;
			var month = this._selectedMonth ? this._selectedMonth : this._dateValue.month;
			this._currentDate = this._dateValue = _dateApi.fromJsDate(new Date(this._dateValue.year, month - 1, this._dateValue.day));
			this.handler.onEvent("onCalendarUpdate", this);
		},
		bindEvents: function(bind) {
			var self = this;
			if (bind) {
				$(self.domItem).delegate("td", "click", function(evt) {
					self.onClick(evt);
					evt.preventDefault();
					evt.stopPropagation();
				});
			} else {
				$(self.domItem).undelegate();
			}
		},
		onClick: function(evt) {
			var self = this;
			while (evt.target) {
				if (evt.target.syraOnClick) {
					this[evt.target.syraOnClick](evt.target, evt);
					return;
				} else {
					evt.target = evt.target.parentNode;
				}
			}
		},
		destroy: function() {
			this.bindEvents(false);
			//this.parent.removeChild(this.domItem);
			this.domItem = this._dateValue = this.selectedCell = null;
		}
	});

exports.MonthChoice = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/yearChoice',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/types/date'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var _dateApi = require('syracuse-tablet/html/js/helpers/types/date');


var _Klass = utils.defineClass(

	function() {

	}, null, {
		create: function(parentSlot, dateValue, handler) {
			this.parent = parentSlot;
			this.domItem = document.createElement("nav");
			this.domItem.className = "s-calendar-quick-list";
			this.handler = handler;
			this._dateValue = dateValue;
			this._selectedYear = this._dateValue.year;
			var table = document.createElement("table");
			table.className = "s-calendar-year-choice";
			var tbody = document.createElement("tbody");
			this.rows = [];
			for (var ii = 0; ii < 6; ii++) {
				var row = document.createElement("tr");
				if (ii == 0) {
					this.addPrevNextCell(row, true);
					this.addPrevNextCell(row, false);
				} else {
					var cuYear = this._dateValue.year + ii - 4;
					row.appendChild(this.drawCell(cuYear, cuYear));
					row.appendChild(this.drawCell(cuYear + 5, cuYear + 5));
				}
				tbody.appendChild(row);
				this.rows.push(row);
			}
			table.appendChild(tbody);
			this.domItem.appendChild(table);
			//this.domItem.style.display = "none";
			this.parent.appendChild(this.domItem);
			this.bindEvents(true);
		},
		addPrevNextCell: function(row, isPrev) {
			var td = document.createElement("td");
			td.className = "s-calendar-my-link-cell";
			var link = document.createElement("a");
			link.className = (link.syraIsPrev = isPrev) ? "s-calendar-prev-year" : "s-calendar-next-year";
			//TODO : localize !
			link.textContent = (link.syraIsPrev = isPrev) ? "Prev" : "Next";
			link.syraOnClick = "onChangeYear";
			td.appendChild(link);
			row.appendChild(td);
		},
		drawCell: function(value, text) {
			var td = document.createElement("td");
			td.className = "s-calendar-my-item";
			td.syraOnClick = "onSelectYear";
			td.syraValue = value;
			td.textContent = text;
			if (value == this._selectedYear) {
				td.className += " s-calendar-select";
				this.selectedCell = td;
			}
			return td;
		},
		toggle: function(show) {
			if (show) {
				this.domItem.style.display = "";
			} else {
				this.domItem.style.display = "none";
			}
		},
		_refreshYearCell: function(td, step) {
			td.syraValue += step;
			td.textContent = td.syraValue;
			if (td.syraValue == this._selectedYear) {
				td.className += " s-calendar-select";
				this.selectedCell = td;
			}
		},
		onChangeYear: function(picker) {
			var step = picker.syraIsPrev ? (-10) : 10;
			for (var ii = 1, jj = this.rows.length; ii < jj; ii++) {
				var nodes = this.rows[ii].childNodes;
				this._refreshYearCell(nodes[0], step);
				this._refreshYearCell(nodes[1], step);
			}
		},
		onSelectYear: function(picker) {
			if (this.selectedCell) {
				this.selectedCell.className = "s-calendar-my-item";
			}(this.selectedCell = picker).className = "s-calendar-my-item s-calendar-select";
			this._selectedYear = picker.syraValue;
			var year = this._selectedYear ? this._selectedYear : this._dateValue.year;
			this._currentDate = this._dateValue = _dateApi.fromJsDate(new Date(year, this._dateValue.month, this._dateValue.day));
			this.handler.onEvent("onCalendarUpdate", this);
		},
		bindEvents: function(bind) {
			var self = this;
			if (bind) {
				$(self.domItem).delegate("td", "click", function(evt) {
					self.onClick(evt);
					evt.preventDefault();
					evt.stopPropagation();
				});
			} else {
				$(self.domItem).undelegate();
			}
		},
		onClick: function(evt) {
			var self = this;
			while (evt.target) {
				if (evt.target.syraOnClick) {
					this[evt.target.syraOnClick](evt.target, evt);
					return;
				} else {
					evt.target = evt.target.parentNode;
				}
			}
		},
		destroy: function() {
			this.bindEvents(false);
			//this.parent.removeChild(this.domItem);
			this.rows = this.domItem = this._dateValue = this.selectedCell = null;
		}
	});

exports.YearChoice = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/types/date','syracuse-tablet/html/js/ui/datetimeSelectors/monthChoice','syracuse-tablet/html/js/ui/datetimeSelectors/yearChoice'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var modal = require('syracuse-tablet/html/js/ui/modal');
var _dateApi = require('syracuse-tablet/html/js/helpers/types/date');
var MonthChoice = require('syracuse-tablet/html/js/ui/datetimeSelectors/monthChoice').MonthChoice;
var YearChoice = require('syracuse-tablet/html/js/ui/datetimeSelectors/yearChoice').YearChoice;

var _Klass = utils.defineClass(

	function() {

	}, null, {
		onClick: function(evt) {
			var self = this,
				close;
			while (evt.target && evt.target != self.handler.parentSlot) {
				if (evt.target.getAttribute("data-s-syraOnClick")) {
					close = this[evt.target.getAttribute("data-s-syraOnClick")](evt.target, evt);
					if (close) {
						this.handler.closeContainer();
					}
					return;
				} else {
					evt.target = evt.target.parentNode;
				}
			}
		},
		onTodayClick: function() {
			this._currentDate = _dateApi.today();
			this.field.setFieldValue(_dateApi.fromInternalValue(this._currentDate._value).toString());
			return true;
		},
		onDayClick: function(picker) {
			this.field.setFieldValue(_dateApi.fromInternalValue(picker.getAttribute("data-s-syraValue")).toString());
			return true;
		},
		onQuickItemClick: function(picker, event) {
			//TODO
			/*
			var isBegin = syra_site.dom.getChildIndex(event.target) == 0;
			this._currentDate = this._currentDate[(isBegin ? "begOf" : "endOf") + picker.getAttribute("data-s-syraInterval")]((picker.getAttribute("data-s-syraInterval") == "Week") ? 1 : undefined);
			this._drawBody();
			this.quickList.style.display = "none";
			*/
		},
		onChangePeriode: function(picker) {
			if (picker.getAttribute("data-s-syraPeriod") == "month") {
				this._currentDate = this._currentDate.addMonths(picker.getAttribute("data-s-syraIsPrev") ? -1 : 1);
			} else if (picker.getAttribute("data-s-syraPeriod") == "year") {
				this._currentDate = this._currentDate.addYears(picker.getAttribute("data-s-syraIsPrev") ? -1 : 1);
			} else {
				this._currentDate = this._currentDate.addDays(picker.getAttribute("data-s-syraIsPrev") ? -7 : 7);
			}
			this.handler.onEvent("onCalendarUpdate", this);
			//this._drawBody();
		},
		onQuickClick: function() {
			modal.info("Date time selector", "implementation in progress");
			return;
			//TODO
		},
		onMonthClick: function() {
			this.handler.onEvent("onMonthClick", this);
		},
		onYearClick: function() {
			this.handler.onEvent("onYearClick", this);
		},
		create: function(field, handler) {
			this.domItem = document.createElement("div");
			this.domItem.className = "s-calendar";

			var value = field.getValueForSelector() || "";

			this._selectedDate = value ? _dateApi.parse(value) : _dateApi.today();
			this._selectedDate = this._selectedDate._value == 0 ? _dateApi.today() : this._selectedDate;
			this._currentDate = handler._currentDate || _dateApi.fromInternalValue(this._selectedDate._value);

			this.field = field;
			this.handler = handler;

			this._table = document.createElement("table");
			this._table.setAttribute("cellspacing", 0);
			this._table.className = "s-calendar-content";
			this._table.appendChild(this._appendHead());
			this._table.appendChild(this.body = document.createElement("tbody"));
			this._table.appendChild(this._appendFoot());
			this.domItem.appendChild(this._table);

			this._drawBody();

			return this.domItem;
		},
		_appendHead: function() {
			var head = document.createElement("thead");
			var row = document.createElement("tr");
			var cell = document.createElement("th");
			cell.setAttribute("colspan", 8);
			cell.className = "s-calendar-month-year";

			var slot = document.createElement("div");
			slot.className = "s-calendar-month-year-slot";
			cell.appendChild(slot);

			// prev year link
			var link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraIsPrev", true);
			link.setAttribute("data-s-syraPeriod", "year");
			link.className = "s-calendar-prev s-calendar-prev-year glyphicon glyphicon-fast-backward";
			slot.appendChild(link);

			// prev month link
			link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraIsPrev", true);
			link.setAttribute("data-s-syraPeriod", "month");
			link.className = "s-calendar-prev s-calendar-prev-month glyphicon glyphicon-step-backward";
			slot.appendChild(link);

			this._monthLink = document.createElement("a");
			this._monthLink.className = "s-month s-calendar-month-year-link";
			slot.appendChild(this._monthLink).setAttribute("data-s-syraOnClick", "onMonthClick");

			this._yearLink = document.createElement("a");
			this._yearLink.className = "s-year s-calendar-month-year-link";
			slot.appendChild(this._yearLink).setAttribute("data-s-syraOnClick", "onYearClick");

			// next month link
			link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraPeriod", "month");
			link.className = "s-calendar-next s-calendar-next-month glyphicon glyphicon-step-forward";
			slot.appendChild(link);

			// next year link
			link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraPeriod", "year");
			link.className = "s-calendar-next s-calendar-next-year glyphicon glyphicon-fast-forward";
			slot.appendChild(link);

			row.appendChild(cell);
			head.appendChild(row);

			row = document.createElement("tr");
			var cell = document.createElement("th");
			cell.className = "s-calendar-week-day";
			row.appendChild(cell);

			var days = [1, 2, 3, 4, 5, 6, 0];
			for (var ii = 0, jj = days.length; ii < jj; ii++) {
				var cell = document.createElement("th");
				cell.className = "s-calendar-week-day";
				cell.title = _dateApi.dayName(days[ii]);
				cell.textContent = _dateApi.dayName(days[ii], true);
				row.appendChild(cell);
			}
			head.appendChild(row);
			return head;
		},
		_appendFoot: function() {
			var row = document.createElement("tr");
			var cell = document.createElement("td");
			cell.setAttribute("colspan", 3);
			cell.className = "s-calendar-foot-week";

			var link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraPeriod", "week");
			link.className = "s-calendar-prev s-calendar-prev-week glyphicon glyphicon-chevron-left";
			link.setAttribute("data-s-syraIsPrev", true);
			cell.appendChild(link);

			var label = document.createElement("label");
			label.className = "s-calendar-foot-week-title";
			label.textContent = "Week";
			//TODO
			//label.textContent = this.field.localize.fdpWeek;
			cell.appendChild(label);

			this._weekNumber = document.createElement("label");
			this._weekNumber.className = "s-calendar-foot-week-title-num";
			cell.appendChild(this._weekNumber);

			link = document.createElement("a");
			link.setAttribute("data-s-syraOnClick", "onChangePeriode");
			link.setAttribute("data-s-syraPeriod", "week");
			link.className = "s-calendar-next s-calendar-next-week glyphicon glyphicon-chevron-right";
			cell.appendChild(link);
			row.appendChild(cell);

			cell = document.createElement("td");
			cell.setAttribute("colspan", 3);
			cell.className = "s-calendar-foot-today";
			link = document.createElement("a");
			link.className = "s-calendar-today-link";
			link.setAttribute("data-s-syraOnClick", "onTodayClick");

			//TODO
			//link.textContent = this.field.localize.fdpToday;
			link.textContent = "Today";
			cell.appendChild(link);
			row.appendChild(cell);

			cell = document.createElement("td");
			cell.setAttribute("colspan", 2);
			cell.className = "s-calendar-foot-more";
			this._quick = document.createElement("a");
			this._quick.className = "s-calendar-quick-btn glyphicon glyphicon-plus";
			this._quick.setAttribute("data-s-syraOnClick", "onQuickClick");
			cell.appendChild(this._quick);
			row.appendChild(cell);

			var foot = document.createElement("tfoot");
			foot.appendChild(row);
			return foot;
		},
		_drawBody: function() {
			//TODO
			//var curMonth = this._currentDate.month
			var curMonth = this._currentDate.month || 9;
			var month = _dateApi.monthName(curMonth);

			this._monthLink.textContent = month;
			this._yearLink.textContent = this._currentDate.year || 2014;

			uiUtils.empty(this.body);

			var curDate = _dateApi.fromInternalValue(this._currentDate._value);
			var begOfMonth = curDate = curDate.begOfMonth();
			curDate = curDate.begOfWeek(1);

			for (var weekRow = 0; weekRow < 6; weekRow++) {
				var row = document.createElement("tr");
				var weekDay = (weekRow == 0) ? begOfMonth : curDate;
				var cell = document.createElement("td");
				cell.className = "s-calendar-week-num";
				row.appendChild(cell);
				cell.textContent = weekDay.week;
				for (var day = 0; day < 7; day++) {
					var cell = document.createElement("td");
					cell.className = "s-calendar-day-link";
					cell.setAttribute("data-s-syraOnClick", "onDayClick");
					cell.setAttribute("data-s-syraValue", curDate._value);
					var link = document.createElement("a");
					link.textContent = curDate.day;
					if (curMonth != curDate.month) {
						cell.className += " s-calendar-other-month";
					}
					if (this._currentDate.equals(curDate)) {
						cell.className += " s-calendar-select";
						link.className = "s-calendar-select";
					}
					cell.appendChild(link);
					row.appendChild(cell);
					curDate = curDate.addDays(1);
				}
				this.body.appendChild(row);
			}
			this._weekNumber.textContent = this._currentDate.week;
		},
		bindEvents: function(bind) {
			var self = this;
			var parentSlot = self.handler.getParentSlot();
			if (bind) {
				$(parentSlot).delegate("td, a", "click", function(evt) {
					self.onClick(evt);
					evt.preventDefault();
					evt.stopPropagation();
				});
			} else {
				$(parentSlot).undelegate();

				// unbind monthchoice and yearchoice components if necessary
				if (self._month) {
					self._month.bindEvents(false);
				}
				if (self._year) {
					self._year.bindEvents(false);
				}
			}
		},
		destroy: function() {
			//TODO to complete
			this.bindEvents(false);
			this._currentDate = this.field = this._currentDate = this.quickList = this._month = this._year = this._selectedDate = this._monthLink = this._yearLink = this._weekNumber = this._quick = this.body = this.domItem = null;
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/types/time','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var _timeApi = require('syracuse-tablet/html/js/helpers/types/time');
var locale = require('syracuse-tablet/html/js/helpers/locale');

var _Klass = utils.defineClass(

	function() {

	}, null, {
		onClick: function(evt) {
			var self = this,
				close;
			while (evt.target) {
				if (evt.target.getAttribute("data-s-syraOnClick")) {
					close = this[evt.target.getAttribute("data-s-syraOnClick")](evt.target, evt);
					if (close) {
						this.handler.closeContainer();
					}
					return;
				} else {
					evt.target = evt.target.parentNode;
				}
			}
		},
		setContainer: function($$modalElmt) {
			this.$$modalElmt = $$modalElmt;
		},
		create: function(field, handler, cb) {

			this.domItem = document.createElement("div");
			this.domItem.className = "s-time-choice";

			var options = options || {};
			this.columns = options.columns || 2;
			this.interval = options.interval || 60;

			this.field = field;
			this.handler = handler;
			this.cb = cb;

			this.curTime = _timeApi.now();
			//this.curTime = handler._currentTime || field.getValue() ? _timeApi.parse(field.getValue()) : _timeApi.now();

			var cellCount = (24 * 60) / this.interval;
			var rowCount = cellCount / this.columns;

			var table = document.createElement("table");
			table.className = "s-time-choice-table";
			table.setAttribute("cellspacing", "0");
			table.setAttribute("cellpadding", "0");

			var row, cell;
			var cellIndex = 0;
			var timeHour = _timeApi.parse("00:00:00");
			for (var rr = 0; rr < rowCount; rr++) {
				row = document.createElement("tr");
				for (var col = 0; col < this.columns; col++) {
					cell = document.createElement("td");
					cell.className = "s-time-choice-td";
					if (cellIndex < cellCount) {
						var link = document.createElement("a");
						link.className = "s-time-choice-a";
						link.setAttribute("data-s-syraOnClick", "onTimeClick");
						if (timeHour.hour == this.curTime.hour) {
							link.className += " s-time-select";
						}
						link.textContent = timeHour.toString(locale.getTimeFormat());
						cell.appendChild(link);
					}
					row.appendChild(cell);
					timeHour = timeHour.addMinutes(this.interval);
					cellIndex++;
				}
				table.appendChild(row);
			}
			this.domItem.appendChild(table);
			return this.domItem;
		},
		onTimeClick: function(picker) {
			var self = this;
			var fieldVal = _timeApi.parse(picker.textContent, locale.getTimeFormat()).toString();
			if (!this.cb) {
				self.field.setFieldValue(fieldVal);
				return true;
			} else {
				self.cb(fieldVal, self.handler);
			}
		},
		bindEvents: function(bind) {
			var self = this;
			var parentSlot = self.handler.getParentSlot();
			if (bind) {
				$(parentSlot).delegate("a", "click", function(evt) {
					self.onClick(evt);
					evt.preventDefault();
					evt.stopPropagation();
				});
			} else {
				$(parentSlot).undelegate();
			}
		},
		destroy: function() {
			//TODO to complete
			this.bindEvents(false);
			this.domItem = this.field = this.selectedLink = null;
		}
	});
exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/datetimeSelector',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/types/date','syracuse-tablet/html/js/helpers/types/time','syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector','syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector'],function (require, exports, module) {
var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var modal = require('syracuse-tablet/html/js/ui/modal');
var _dateApi = require('syracuse-tablet/html/js/helpers/types/date');
var _timeApi = require('syracuse-tablet/html/js/helpers/types/time');
var TimeSelector = require('syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector').Klass;
var Base = require('syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector').Klass;

var _Klass = utils.defineClass(

	function() {

	}, Base, {
		onTodayClick: function() {
			this._currentDate = _dateApi.today();
			this.dateValue = _dateApi.fromInternalValue(this._currentDate._value).toString();
			this.handler.onEvent("onOpenTime", this);
		},
		onDayClick: function(picker) {
			this.dateValue = _dateApi.fromInternalValue(picker.getAttribute("data-s-syraValue")).toString();
			this.handler.onEvent("onOpenTime", this);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/selectorFactory',['require','exports','module','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector','syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector','syracuse-tablet/html/js/ui/datetimeSelectors/datetimeSelector'],function (require, exports, module) {

var globals = require('syracuse-tablet/html/js/helpers/globals');

// date / time selectors
var $devices = ["Windows", "IOS", "Android"];

var selectors = {
	dateSelectorWindows: require('syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector').Klass,
	timeSelectorWindows: require('syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector').Klass,
	datetimeSelectorWindows: require('syracuse-tablet/html/js/ui/datetimeSelectors/datetimeSelector').Klass
};


exports.getSelector = function(propertyType) {
	// extract string after 'application/x-'
	var $type = propertyType.slice(14);

	// if method getDeviceOS() is implemented
	// assuming it returns strings "Windows", "IOS" or "Android" (default will be 'Windows')
	var $OS = globals.getApplication().getDeviceOS && globals.getApplication().getDeviceOS() || "Windows";

	if ($OS) {
		try {
			return new selectors[$type + "Selector" + $OS]();
		} catch (e) {
			throw new Error("Expected date/time/datetime type. Got " + propertyType);
		}

	}
};
});

define('syracuse-tablet/html/js/ui/datetimeSelectors/selectorSwitchHandler',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/ui/datetimeSelectors/monthChoice','syracuse-tablet/html/js/ui/datetimeSelectors/yearChoice','syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector','syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector','syracuse-tablet/html/js/ui/datetimeSelectors/datetimeSelector'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require("syracuse-tablet/html/js/ui/uiUtils");
var MonthChoice = require('syracuse-tablet/html/js/ui/datetimeSelectors/monthChoice').MonthChoice;
var YearChoice = require('syracuse-tablet/html/js/ui/datetimeSelectors/yearChoice').YearChoice;
var DateSelector = require('syracuse-tablet/html/js/ui/datetimeSelectors/dateSelector').Klass;
var TimeSelector = require('syracuse-tablet/html/js/ui/datetimeSelectors/timeSelector').Klass;
var DatetimeSelector = require('syracuse-tablet/html/js/ui/datetimeSelectors/datetimeSelector').Klass;

//var events = ['onMonthClick','onYearClick','onOpenTime','onCalendarUpdate','onSelectTime'];
var _Klass = utils.defineClass(

	function(field) {
		this.field = field;
	}, null, {
		/**
		Triggers an action when the following events occurs :
		- onMonthClick : When user clicks on month selection link
		- onYearClick : When user clicks on year selection link
		- onOpenTime : In case of datetime field, when user has selected the date, time selector must be displayed afterwards
		- onCalendarUpdate : When user clicks on links that will reshape the calendar (change month, change year, change week, select month, select year)
		- onSelectTime : In case of datetime field, when user has selected the time, field must be set with appropriate date + time value

		@param	evt 		Triggered event in set as string
		@param	selector 	The selector object. Use to get value and for destroy action
		*/
		onEvent: function(evt, selector) {
			this[evt](selector);
		},

		/*
			Set the $$container of the date / time selectors which is likely to be the modal.
			It will make it easier to close it from within the library
			@param	$$container 	Jquery container object (the modal)
		*/
		setContainer: function($$container) {
			this.$$container = $$container;
		},

		/*
			Set parentSlot dom parameter. Useful to make some dom actions like emptying or appending.
			It is the modal body
			@param parentSlot Modal body.

		*/
		setParentSlot: function(parentSlot) {
			this.parentSlot = parentSlot;
		},


		/*
			Returns parentSlot dom parameter
		*/
		getParentSlot: function() {
			return this.parentSlot;
		},

		/*
			Triggered when user clicks on month selection link. It builds the month selector
			@param 	selector 	The selector object. Use to get value and for destroy action
		*/
		onMonthClick: function(selector) {
			var self = this;
			// save date
			var date = selector._currentDate;

			// clear previous selector
			uiUtils.empty(self.parentSlot);
			selector.destroy();

			// create month selector
			var monthChoice = new MonthChoice();
			monthChoice.create(this.parentSlot, date, self);
		},

		/*
			Triggered when user clicks on year selection link. It builds the year selector
			@param 	selector 	The selector object. Use to get value and for destroy action
		*/
		onYearClick: function(selector) {
			var self = this;
			// save date
			var date = selector._currentDate;

			// clear previous selector
			uiUtils.empty(self.parentSlot);
			selector.destroy();

			// create month selector
			var yearChoice = new YearChoice();
			yearChoice.create(self.parentSlot, date, self);
		},


		/*
			Triggered in case of datetime field. It builds time selector after user clicked on date
			@param 	selector 	The selector object. Use to get value and for destroy action
		*/
		onOpenTime: function(selector) {
			var self = this;

			// save date
			self.dateValue = selector.dateValue;

			// clear previous selector
			uiUtils.empty(self.parentSlot);
			selector.destroy();

			// create time selector
			var timeSelector = new TimeSelector();
			var sDom = timeSelector.create(self.field, self, self.onSelectTime);
			self.parentSlot.appendChild(sDom);
			timeSelector.bindEvents(true);
		},

		/*
			Triggered when user clicks on link that will update the calendar. It builds the calendar with updated value
			@param 	selector 	The selector object. Use to get value and for destroy action
		*/
		onCalendarUpdate: function(selector) {
			var self = this;

			// save date
			self._currentDate = selector._currentDate;

			// clear previous selector
			uiUtils.empty(self.parentSlot);
			selector.destroy();

			// create back date selector
			var dateSelector = new DateSelector();
			var sDom = dateSelector.create(self.field, self);
			self.parentSlot.appendChild(sDom);
			dateSelector.bindEvents(true);
		},

		/*
			Triggered in case of datetime field. It sets the final field value and closes the container (the modal)
			@param 	selector 	The selector object. Use to get value and for destroy action
		*/
		onSelectTime: function(timeVal, handler) {
			var self = handler;
			self.field.setFieldValue(self.dateValue + " " + timeVal);
			self.closeContainer();
		},

		/*
			Closes the container (the modal here)
		*/
		closeContainer: function() {
			this.$$container.modal("hide");
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlDate',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/field/ctrlFieldBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/ui/datetimeSelectors/selectorFactory','syracuse-tablet/html/js/ui/datetimeSelectors/selectorSwitchHandler'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var modal = require('syracuse-tablet/html/js/ui/modal');
var selectorFactory = require('syracuse-tablet/html/js/ui/datetimeSelectors/selectorFactory');
var SelectorHandler = require('syracuse-tablet/html/js/ui/datetimeSelectors/selectorSwitchHandler').Klass;

var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value;

			value = self.getFormattedValue(self.getValue());
			if (self.$isEditMode) {

				var inputGroup = uiUtils.createDomElement("div", ["input-group"], null, null, parentSlot);

				self.domInput = uiUtils.createDomElement("input", ["s-m-field-input", "form-control", "ctrl-evt-blur"], null, {
					"type": "text",
					"value": value
				}, inputGroup);
				var span = uiUtils.createDomElement("span", ["input-group-btn"], null, null, inputGroup);
				self.picker = uiUtils.createDomElement("button", ["btn", "btn-default"], null, null, span);

				var iconClasses = self.$type.indexOf("date") != -1 ? ["glyphicon", "glyphicon-calendar"] : ["glyphicon", "glyphicon-time"];
				uiUtils.createDomElement("span", iconClasses, null, null, self.picker);

				$(self.picker).click(function() {
					// selector handler
					var sHandler = new SelectorHandler(self);

					// build selector (calendar or time grid)
					// selector will be handled according to field type
					var ctrlSelector = selectorFactory.getSelector(self.getPropertyType());
					var selectorDom = ctrlSelector.create(self, sHandler);

					var $$selectorModal = modal.field(self.getTitle(), selectorDom.outerHTML, function(modalEvent, $$modalElmt) {
						// build content on open
						if (modalEvent == 'shown.bs.modal') {
							sHandler.setContainer($$modalElmt);
							sHandler.setParentSlot($$modalElmt.find(".modal-body")[0]);
							ctrlSelector.bindEvents(true);
						}

						// run actions on close 'hidden.bs.modal'
						else {
							ctrlSelector.destroy();
						}
					});

				});
			} else {
				self.appendTextValue(parentSlot, value);
			}
		},
		setFieldValue: function(value) {
			if (this.getPropertyType().indexOf("datetime") > -1 && value.length <= 10) {
				value += "T00:00:00.0Z";
			}
			Base.prototype.setFieldValue.call(this, value);
		},
		setDisplayValue: function(value) {
			var self = this;
			if (self.$isEditMode) {
				self.domInput.value = value;
			} else {
				self.fieldValue.textContent = value;
			}
		},
		getValueForSelector: function() {
			return this.getValue().slice(0, 10);
		},
		getFieldFormat: function() {
			return this.formatter.format;
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/arrayBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/ctrlBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {


var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');

var _destroyArrayData = function(a) {
	if (!a || !a.$resources) return null;
	a.$resources.forEach(function(r) {
		if (r) r.destroy();
	});
	return null;
};
/**
 * x-array control base class
 */
var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self.builder = null;
		self._arrayData = null;
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			self.prototype = null;
			if (self.builder) {
				self.builder.destroy();
				self.builder = null;
			}
			self._arrayData = _destroyArrayData(self._arrayData);
			if (self._waiting) {
				uiutils.waitWheelDestroy(self._waiting);
				self._waiting = null;
			}
		},

		/**
		 *	Build html DOM object + bind event
		 **/
		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			if (self.builder == null) throw new Error("Null builder");
			self.builder.buildHtml($$parent, self._setArrayData(controllerDao), buildOptions);
		},

		setBuilder: function(builder) {
			this.builder = builder;
		},

		/**
		 * Refreshes the control
		 */
		refresh: function(controllerDao, options) {
			var self = this;
			if (self.builder == null) throw new Error("Null builder");
			self.builder.refresh(self._setArrayData(controllerDao), options);
		},

		/**
		 *	returns array rows
		 *		depends on the kind of page query/lookup or detail/edit
		 *		called one time to create the dao - then use getArrayData()
		 **/
		readArrayData: function(controllerDao) {
			throw new Error("not implemented");
		},

		/**
		 *	Set array data - depends on array type
		 **/
		_setArrayData: function(controllerDao) {
			var self = this;
			self.empty();
			_destroyArrayData(self._arrayData);
			self._arrayData = self.readArrayData(controllerDao);
			if (self._arrayData == null) throw new Error("Null arrayData");
			return self._arrayData;
		},

		/**
		 *	returns array rows
		 *		controllerDao optional
		 **/
		getArrayData: function() {
			return this._arrayData;
		},

		waitStart: function() {
			var self = this;
			if (!self._waiting) {
				// TODO - Optimization
				self._waiting = uiutils.waitWheelCreate(self.$$elmt.parent());
				self._waiting.$$bckg.css({
					position: "absolute"
				});
				self._waiting.$$wheel.css({
					position: "absolute"
				});
			}
			uiutils.waitWheelStart(self._waiting);
		},
		waitStop: function() {
			var self = this;
			if (self._waiting) {
				uiutils.waitWheelStop(self._waiting);
			}
		}


	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/builderBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/sdata/sdataUtils','syracuse-tablet/html/js/controls/ctrlFactory'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');
var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');

var _paginBtns = {
	"$first": {
		icon: "glyphicon glyphicon-step-backward"
	},
	"$previous": {
		icon: "glyphicon glyphicon-chevron-left"
	},
	"$next": {
		icon: "glyphicon glyphicon-chevron-right"
	},
	"$last": {
		icon: "glyphicon glyphicon-step-forward"
	},
	"$more": {
		icon: "glyphicon glyphicon-refresh"
	}
};
/**
 * Array builder base class
 */
var _Klass = utils.defineClass(
	function(control) {
		var self = this;
		if (control == null) throw new Error("Null control");
		self.control = control;
		self.itemProto = control.prototype.getPrototype("$item");
	}, null, {

		destroy: function() {
			var self = this;
			self.control = null;
			self.itemProto = null;
			/* No destroy - destroyed in control*/
			self.$$elmt = null;
		},

		/**
		 * $$parent parent JQuery element
		 * 		$$parent == null means a REFRESH - TODO optimize refresh if needed
		 * 	arrayData is an object that contains all data needed by array
		 * 	arrayData.$resources contains rows data - Array of dao
		 */
		buildHtml: function($$parent, arrayData, buildOptions) {
			var self = this;
			if ($$parent != null) self.$$elmt = self.control.createRootElement(["s-m-control"], $$parent);
			return self.$$elmt;
		},

		/**
		 * Refreshes the control
		 * 		Just clear and re-build html
		 */
		refresh: function(arrayData, options) {
			var self = this;
			self.control.empty();
			self.buildHtml(null, arrayData, {});
		},

		buildPagingLinks: function(arrayData, options) {
			var self = this;
			var addLink = function(parent, linkName, attrs) {
				$(uiUtils.createDomElement('a', ["s-m-link " + _paginBtns[linkName].icon],
					null, attrs)).appendTo(parent);
			};
			options = options || {};
			var linksBottom = options.bottom ? $(uiUtils.createDomElement('div', ["s-m-grid-links"])).appendTo(self.$$elmt) : null;
			var linksTop = options.top ? $(uiUtils.createDomElement('div', ["s-m-grid-links"])).prependTo(self.$$elmt) : null;
			if (arrayData.$links) {
				for (var linkName in _paginBtns) {
					var link = arrayData.$links[linkName];
					if (link) {
						var linkInfo = sdataUtils.getLinkInfo(link.$url);
						var attrs = {
							// page refresh
							"data-nav-refresh": true,
							// data-nav-type is used to specify the type of link
							"data-nav-type": linkName,
							// Data url
							"data-sdata-url": link.$url,
							// refresh control only
							"data-control-id": self.control.id,
						};
						if (self.control.controller.isVignette()) {
							// Add vignette info to reload the page in vignette
							attrs["data-nav-target"] = "vignette";
						}
						if (linksBottom) addLink(linksBottom, linkName, attrs);
						if (linksTop) addLink(linksTop, linkName, attrs);
					}
				}
			}
		},

		buildDetailLink: function(cellData, options) {
			if (options == null) throw new Error("Null options");
			var self = this;
			var attrs = options.attrs || {};
			var links = self.itemProto.data("$links"),
				link;
			// If there is a DASHBOARD link it replaces $details
			var linkProto = (links && links.DASHBOARD) || (links && links.$details);
			if (linkProto) {
				link = sdataUtils.getLinkInfo(linkProto.$url, cellData);
				attrs["href"] = "#";
				attrs["data-nav"] = link.page;
				if (link.sDataUrl) {
					attrs["data-sdata-url"] = link.sDataUrl;
				}
				if (link.parameters) {
					var params = utils.parseExpression(link.parameters, cellData);
					attrs["data-sdata-parameters"] = params;
				}
			} else {
				link = null;
			}
			if (link != null || options.createIfNoLink) {
				return uiUtils.createDomElement(options.tag, options.css, options.title, attrs, options.parent);
			}
			return null;
		},

		getPrototype: function() {
			return this.control.prototype;
		},

		getArticle: function() {
			return this.control.article;
		},

		/**
		 * Returns array rows data (Array)
		 */
		getArrayData: function() {
			return this.control.getArrayData();
		},

		/**
		 * Returns control id eventually concatenated with arguments
		 * 	Allows to get unic ids for control childs if needed
		 */
		getId: function() {
			var self = this;
			if (arguments.length > 0) {
				return self.control.id + " - " + Array.prototype.join.call(arguments, '-');
			} else {
				return self.control.id;
			}
		},

		/**
		 * Create a field control to get the html
		 * 	TODO Destroy the ctrl after getting html - no needs to store it
		 */
		appendField2Cell: function($$parent, fieldName, fieldProto, data) {
			var self = this;
			if (!fieldProto) fieldProto = self.itemProto.getPrototype(fieldName);
			if (!fieldProto) return null;
			ctrlFactory.appendField2Cell($$parent, self.control.controller, {
				"$bind": fieldName
			}, fieldProto, data);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/builderGrid',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/array/builderBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/prototype'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/builderBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var reqProto = require('syracuse-tablet/html/js/helpers/prototype');

/**
 * x-array control class
 */
var _Klass = utils.defineClass(
	function(control) {
		var self = this;
		Base.call(self, control);
	}, Base, {

		buildHtml: function($$parent, arrayData, options) {
			var self = this;
			options = options || {};
			options.displayRowIdx = true;
			Base.prototype.buildHtml.call(self, $$parent, arrayData, options);
			self.$$elmt.addClass("s-m-array s-m-table");

			var title = self.getPrototype().property(self.getArticle().$bind, "$title");
			if (title) {
				$(uiUtils.createDomElement('div', ["s-m-title"])).text(title).appendTo(self.$$elmt);
			}

			self._createColumnInfo(options);
			self._buildTable(arrayData, options);
			self.buildPagingLinks(arrayData, {
				top: true,
				bottom: true
			});
		},

		// get columns that should be displayed
		_createColumnInfo: function(options) {
			var self = this;
			self.columnInfo = [];
			if (options.displayRowIdx) {
				self.columnInfo.push({
					"$bind": reqProto.rowIdxProperty,
					"$item": reqProto.getRowIdxProto()
				});
			}
			var props = self.itemProto.data("$properties");
			var keys = Object.keys(props);
			keys.forEach(function(key) {
				var item = props[key];
				if (["application/x-array", "application/x-password"].indexOf(item.$type) === -1 && !item.$isExcluded) {
					self.columnInfo.push({
						"$bind": key,
						"$item": self.itemProto.getPrototype(key)
					});
				}
			});
		},

		_buildTable: function(arrayData, options) {
			var self = this;
			self.tabElmt = uiUtils.createDomElement('table', ["table table-hover table-condensed"], null, null, self.$$elmt);
			self._buildTableHead(options);
			self._buildTableBody(arrayData, options);
		},

		_buildTableHead: function(options) {
			var self = this;
			var tabHead = uiUtils.createDomElement('thead', null, null, null, self.tabElmt);
			var tr = uiUtils.createDomElement('tr', null, null, null, tabHead);
			self.columnInfo.forEach(function(col) {
				var title = col.$item ? utils.parseExpression(col.$item.data('$title') || "", null, self.control.prototype) : "";
				uiUtils.createDomElement('th', null, title, null, tr);
			});
		},

		_buildTableBody: function(arrayData, options) {
			var self = this;
			var tabBody = uiUtils.createDomElement('tbody');
			self.tabElmt.appendChild(tabBody);
			// Build rows
			arrayData.$resources.forEach(function(cellData, idx) {
				self._buildTableRow(tabBody, cellData, idx, options);
			});
		},

		_buildTableRow: function(tabBody, cellData, idx, options) {
			var self = this;
			var cssRowIdx;
			if (options.displayRowIdx) {
				cellData.setRowIndex(idx);
				cssRowIdx = ["s-m-rowidx"];
			}
			var tr = self.buildDetailLink(cellData, {
				tag: "tr",
				parent: tabBody,
				createIfNoLink: true
			});
			self.columnInfo.forEach(function(col, idx) {
				var rowIdx = options.displayRowIdx && col.$bind === reqProto.rowIdxProperty;
				self.appendField2Cell(uiUtils.createDomElement('td', rowIdx ? cssRowIdx : null, null, null, tr), col.$bind, col.$item, cellData);
			});
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/arrayStd',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/array/arrayBase','syracuse-tablet/html/js/controls/array/builderGrid'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/arrayBase').Klass;
var builderGrid = require('syracuse-tablet/html/js/controls/array/builderGrid').Klass;


var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self.setBuilder(new builderGrid(self));
	}, Base, {

		readArrayData: function(controllerDao) {
			return controllerDao.getArrayData(this.article.$bind, this.prototype);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/builderCardHoriz',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/array/builderBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/builderBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');


/**
 * Array Control
 * 	Horizontal grid builder for queries
 */
var _Klass = utils.defineClass(
	function(control) {
		var self = this;
		Base.call(self, control);
		/*
		 * CSS-DEPENDEND: Needs to be adjusted on major size or page layout changes
		 */
		self.pageContentHeightSubstraction = 190;
		self.minLandscapeHeight = 550;
		self._itemWidth = 140;
		self._itemHeight = 140;
		self._itemSpacing = 10;
		self.recordItems = {};
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			$(window).off("resize", self.onResizeHandler);
			self.recordItems = null;
		},

		buildHtml: function($$parent, arrayData, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, arrayData, buildOptions);
			self.$$elmt.addClass("s-m-array s-m-grid s-m-horizontal");
			self.$$domItems = $(uiUtils.createDomElement('div', ["s-m-grid-items s-m-horizontal"], null, {
				"id": self.getId("items")
			})).appendTo(self.$$elmt);
			self.onResizeHandler = self.onResizeWindow.bind(self);
			$(window).on("resize", self.onResizeHandler);

			arrayData.$resources.forEach(function(record, idx) {
				var domItem = uiUtils.createDomElement('div', ["s-m-grid-item"], null, null, self.$$domItems);
				self.recordItems[record.getValue("$uuid")] = domItem;
				self._buildRecord(record, domItem, idx);
			});

			self.onResizeWindow();
			self.buildPagingLinks(arrayData, {
				top: true
			});
		},

		_buildRecord: function(record, domItem, idx) {
			var self = this;
			var title = self.itemProto.data("$value", record) || ("Rank;" + (idx + 1));
			var a = self.buildDetailLink(record, {
				tag: "a",
				parent: domItem,
				title: title,
				css: ["s-m-link s-m-detail-link"]
			});
			if (false && domItem) {
				var title = self.itemProto.data("$value", record) || ("Rank;" + (idx + 1));
				uiUtils.createDomElement("span", ["s-m-link"], title, null, domItem);
			}
		},

		onResizeWindow: function() {
			var self = this;
			var arrayData = self.getArrayData();
			if (!arrayData) return;
			var w = window.innerWidth;
			var h = window.innerHeight;

			h = h - self.pageContentHeightSubstraction;
			self._maxItemHeight = h;
			self.$$domItems.height(self._maxItemHeight - 20);

			var x = 0;
			var y = 0;
			arrayData.$resources.forEach(function(record) {
				if (y + self._itemHeight > self._maxItemHeight) {
					y = 0;
					x += self._itemWidth + self._itemSpacing;
				}
				var domItem = self.recordItems[record.getValue("$uuid")];
				if (domItem) {
					var s = domItem.style;
					s.left = x + "px";
					s.top = y + "px";
					s.width = self._itemWidth + "px";
					s.height = self._itemHeight + "px";
					y += self._itemHeight + self._itemSpacing;
				}
			});
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/arrayQuery',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/array/arrayBase','syracuse-tablet/html/js/controls/array/builderCardHoriz','syracuse-tablet/html/js/controls/array/builderGrid'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/arrayBase').Klass;
var builderCardHoriz = require('syracuse-tablet/html/js/controls/array/builderCardHoriz').Klass;
var builderGrid = require('syracuse-tablet/html/js/controls/array/builderGrid').Klass;

/**
 * Array control for a QUERY FACET
 */
var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		if (self.controller.isVignette()) {
			self.setBuilder(new builderGrid(self));
		} else if (self.prototype.isQuery()) {
			self.setBuilder(new builderCardHoriz(self));
		} else {
			self.setBuilder(new builderGrid(self));
		}
	}, Base, {

		readArrayData: function(controllerDao) {
			return controllerDao.getQueryData(this.prototype);
		}

	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/array/arrayLookup',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/array/arrayBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/arrayBase').Klass;

/**
 * Array control for a LOOKUP FACET
 */
var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {

		readArrayData: function(controllerDao) {
			return controllerDao.getQueryData(this.prototype);
		}

	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/field/ctrlReference',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/field/ctrlFieldBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;

var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {
		getValue: function() {
			var self = this;
			var val = Base.prototype.getValue.call(self);
			return val ? val.$title || val.$value : "";
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/layout/layoutBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/structElmt','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/structElmt').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _Klass = utils.defineClass(function(controller, type, article) {
	var self = this;
	Base.call(self, controller, type, article);
	self.title = article.$title;
}, Base, {
	destroy: function() {
		var self = this;
		Base.prototype.destroy.call(self);
	},
	createId: function(typeName) {
		var self = this;
		return utils.readableuid(typeName, self.article.$layoutType);
	},
	buildHtml: function($$parent, controllerDao, buildOptions) {
		var self = this;
		self.createRootElement(["s-m-layout"], $$parent);
		if (self.article.$title && (buildOptions == null || buildOptions.noTitle)) {
			self.buildTitle();
		}
	},

	buildTitle: function() {
		return uiUtils.createDomElement('header', null, this.article.$title, null, this.$$elmt);
	},

	onLayoutChange: function() {
		$.each(this.children, function(index, value) {
			value.onLayoutChange && value.onLayoutChange();
		});
	}
});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/layout/layoutRow',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/layout/layoutBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

/**
 */
var _Klass = utils.defineClass(

	function(controller, type, article) {
		var self = this;
		Base.call(self, controller, type, article);
	}, Base, {

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			self.$$elmt.addClass("s-m-row");
			var attrs = {};
			if (self.displayOptions && self.displayOptions.rowHeight) {
				attrs.style = "height:" + self.displayOptions.rowHeight;
			}
			var widths = self._getWidthClasses();
			var coreSlot = uiUtils.createDomElement("div", ["row"], null, attrs, self.$$elmt);
			$.each(self.children, function(index, child) {
				var coreItemClassList = ["s-m-layout-cell"];
				coreItemClassList.smExtend(widths[index]);
				var coreItem = uiUtils.createDomElement("div", coreItemClassList, null, null, coreSlot);
				child.buildHtml($(coreItem), controllerDao, buildOptions);
			});
		},

		_getWidthClasses: function() {
			var self = this;
			var widths = {};
			var sizes = [{
				$prop: "$widthLg",
				$prefix: "col-lg-"
			}, {
				$prop: "$widthMd",
				$prefix: "col-md-"
			}, {
				$prop: "$widthSm",
				$prefix: "col-sm-"
			}, {
				$prop: "$widthXs",
				$prefix: "col-xs-"
			}];

			sizes.forEach(function(size) {
				var $width = self.article[size.$prop];
				if ($width) {
					var $prefix = size.$prefix;
					var cols = $width.split(",");
					if (self.children.length === cols.length) {
						for (var index = 0; index < self.children.length; index++) {
							widths[index] = widths[index] || [];
							widths[index].push($prefix + cols[index].trim());
							size.$added = true;
						}
					}
				}
			});

			// if there is no size for the smallest device kind, set it to 12 (full row) to have a default for all devices
			var smallest = sizes[sizes.length - 1];
			if (smallest.$added !== true) {
				for (var index = 0; index < self.children.length; index++) {
					widths[index] = widths[index] || [];
					widths[index].push(smallest.$prefix + "12");
				}
			}
			return widths;
		}
	}
);

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/helpers/classUtils',['require','exports','module','syracuse-tablet/html/js/pages/page','syracuse-tablet/html/js/pages/page'],function (require, exports, module) {

var Page = require('syracuse-tablet/html/js/pages/page').Page;
var Vignette = require('syracuse-tablet/html/js/pages/page').Klass;

var _refObj = new Object();

var _scanProto = function(o, name) {
	if (o == null || !o.__proto__) return false;
	if (o.__proto__ === _refObj.__proto__) return false;
	if (!o.__proto__.constructor) return false;
	if (o._$smclass && o._$smclass.indexOf(name) >= 0) {
		return true;
	}
	switch (name) {
		case "page":
			if (o.__proto__.constructor === Page) {
				// Optimization to prevent prototype scanning
				if (!o._$smclass) o._$smclass = [];
				o._$smclass.push(name);
				return true;
			}
			break;
		case "vignette":
			if (o.__proto__.constructor === Vignette) {
				return true;
			}
			break;
		default:
			break;
	}
	return _scanProto(o.__proto__, name);
};

exports.smInstanceOf = function(o, name) {
	return _scanProto(o, name);
};
});

define('syracuse-tablet/html/js/controls/layout/layoutStack',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/layout/layoutBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/classUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var classUtils = require('syracuse-tablet/html/js/helpers/classUtils');

/**
 * cssOptions
 * 		cssLayout, cssCell: class added to default ones
 * default classes can  be overridden
 */
var _Klass = utils.defineClass(
	function(controller, type, article) {
		var self = this;
		Base.call(self, controller, type, article);
	}, Base, {
		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			self.$$elmt.addClass("s-m-stack");
			$.each(self.children, function(index, child) {
				child.buildHtml(self.$$elmt, controllerDao, buildOptions);
			});
			// COde that set height 1000 for page vignettes is moved to page.afterRender
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/layout/layoutTab',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/layout/layoutBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _Klass = utils.defineClass(
	function(controller, type, article) {
		var self = this;
		Base.call(self, controller, type, article);
	}, Base, {
		/**
		 * Build Html recursively
		 */

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			self.$$elmt.addClass("s-m-tabs");
			var slot = uiUtils.createDomElement("div", [self.article.$layoutType]);
			$.each(self.children, function(index, layout) {
				layout.isTabSection = true;
				var item = uiUtils.createDomElement("div", ["s-m-layout-cell"], null, {
					"style": "display:" + (index != 0 ? "none" : "")
				}, slot);
				layout.buildHtml($(item), controllerDao, buildOptions);
			});
		},
		/**
		 * TODO - FDB - DOESNT WORK - Not attached to DOM
		 */
		buildTitle: function() {
			/*
			var self = this;
			var header = uiUtils.createDomElement('header', ["s-m-layout-header"]);
			var tabSlot = uiUtils.createDomElement("div", ["s-m-tabs-slot"]);
			var tabsContainer = uiUtils.createDomElement("ul", ["nav,nav-tabs"], null, {
				"role": "tablist"
			});
			$.each(self.children, function(index, layout) {
				var tabClass = index == 0 ? ["active"] : null;
				var tab = uiUtils.createDomElement("li", tabClass);
				var tabLink = uiUtils.createDomElement("a", ["s-m-tab"], layout.article.$title, {
					"href": "#"
				});
				tab.appendChild(tabLink);
				tabsContainer.appendChild(tab);
			});
			tabSlot.appendChild(tabsContainer);
			container.appendChild(header);
			*/
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/layout/layoutHub',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/layout/layoutBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;

/**
 * Top level layout node that must only contain layoutHubGroups as children
 * This "hub" expands horizontally and only uses the available vertical space
 * Use this to define pages which only scroll horizontally
 */
var _Klass = utils.defineClass(
	function(controller, type, article) {
		var self = this;
		Base.call(self, controller, type, article);
		/*
		 * CSS-DEPENDEND: Needs to be adjusted on major size or page layout changes
		 */
		self.pageContentHeightSubstraction = 160;
		self.minLandscapeHeight = 550;
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
			$(window).off("resize", self.onResizeHandler);
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			buildOptions = buildOptions || {};
			buildOptions.noTitle = true;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			self.$$elmt.addClass("s-m-hub");
			self.children.forEach(function(child) {
				child.buildHtml(self.$$elmt, controllerDao);
			});
			self.onResizeHandler = self.onResizeWindow.bind(self);
			$(window).on("resize", self.onResizeHandler);
			self._calculateLayout();
		},
		onResizeWindow: function() {
			var self = this;
			self._calculateLayout();
		},
		_calculateLayout: function() {
			var self = this;

			var w = window.innerWidth;
			var h = window.innerHeight;

			var orientation = (w > h && h >= self.minLandscapeHeight) ? "landscape" : "portrait";

			h = h - self.pageContentHeightSubstraction;
			self.$$elmt.height(h);

			var posX = 0;
			var posY = 0;
			this.children.forEach(function(child) {
				child.calculateLayout({
					posX: posX,
					posY: posY,
					maxHeight: h,
					maxWidth: w,
					orientation: orientation
				});

				if (orientation === "landscape") {
					posX += child.getWidth() + 10;
				} else {
					posY += child.getHeight() + 10;
				}
			});

			setTimeout(function() {
				self.onLayoutChange();
			}, 500);
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/layout/layoutHubGroup',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/layout/layoutBase','syracuse-tablet/html/js/ui/uiUtils'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

/**
 * Layout node that can only be used inside layoutHub parent nodes
 * Renders a group of tiles using the available space from top to bottom and then wraps to the right
 * Child elements bound to this layout may set "$size" attribute to define their size:
 * - small		- four tiles will fit into one group from left to right
 * - medium		- two tiles fit into one group from left to right, also double height of "small"
 * - wide		- one tile fits into one group from left to right, same height as "medium"
 * - large		- same width as "wide" and double height of "wide"/"medium"
 * - full		- same width as "wide", uses one full column (rounded to tile size medium)
 */
var _Klass = utils.defineClass(
	function(controller, type, article) {
		var self = this;
		Base.call(self, controller, type, article);

		/*
		 * CSS-DEPENDEND: Needs to be adjusted on major size or page layout changes
		 */
		self._headerSpace = 40;
		self._verticalBorderSubstraction = 40;

	}, Base, {

		/**
		 * Build full html structed but do not yet apply position and size attributes (Will be done in a later step or on resize)
		 */
		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
			self.$$elmt.addClass("s-m-hub-group");
			self._buildCellStructure();
			self.cells.forEach(function(cell) {
				var style = "";
				cell.domItem = uiUtils.createDomElement("div", ["s-m-tile"], null, null, self.$$elmt);
				cell.children.forEach(function(tileLayout) {
					var size = (tileLayout.article && tileLayout.article.$size) || "medium";
					var coreItem = uiUtils.createDomElement("div", ["s-m-tile", "s-m-" + size], null, null, cell.domItem);
					tileLayout.domItem = coreItem;
					tileLayout.buildHtml($(coreItem), controllerDao, buildOptions);
				});
			});
		},

		_buildCellStructure: function() {
			var self = this;
			self.cells = [];
			var cell = null;
			self.children.forEach(function(layout) {
				var size = (layout.article && layout.article.$size) || "medium";
				if (!cell) {
					cell = self._createCell(layout);
					self.cells.push(cell);
				}
				if (size === "small") {
					cell.children.push(layout);
					if (cell.children.length === 4) {
						cell = null;
					}
				} else {
					if (cell.children.length > 0) {
						cell = self._createCell(layout);
						self.cells.push(cell);
					}
					cell.children.push(layout);
					cell = null;
				}
			});
		},

		_createCell: function(layout) {
			var self = this;
			var size = (layout.article && layout.article.$size) || "medium";
			size = (size === "small" ? "medium" : size);
			var cell = {
				size: size,
				children: []
			};
			return cell;
		},

		calculateLayout: function(options) {
			var self = this;
			var size;

			self._width = 0;
			self._height = 0;

			self.hubGroupOptions = options;

			if (self.hubGroupOptions.orientation === "landscape") {
				self._calculateLayoutHorizontal();
			} else {
				self._calculateLayoutVertical();
			}

			self.cells.forEach(function(cell) {
				size = cell.size;
				cell.domItem.style.left = cell.x + "px";
				cell.domItem.style.top = (cell.y + self._headerSpace) + "px";
				cell.domItem.style.width = self._sizes[size].width + "px";
				cell.domItem.style.height = self._sizes[size].height + "px";
				cell.domItem.style.position = "absolute";

				if (cell.x + self._sizes[size].width > self._width) {
					self._width = cell.x + self._sizes[size].width;
				}
				if (cell.y + self._sizes[size].height > self._height) {
					self._height = cell.y + self._sizes[size].height;
				}

				var x = 0;
				var y = 0;
				cell.children.forEach(function(tileLayout) {
					size = (tileLayout.article && tileLayout.article.$size) || "medium";
					tileLayout.domItem.style.left = x + "px";
					tileLayout.domItem.style.top = y + "px";
					tileLayout.domItem.style.width = self._sizes[size].width + "px";
					tileLayout.domItem.style.height = self._sizes[size].height + "px";
					tileLayout.domItem.style.position = "absolute";

					if (x !== 0) {
						x = 0;
						y += self._sizes[size].height + self.hubGroupOptions.padY;
					} else {
						x += self._sizes[size].width + self.hubGroupOptions.padX;
					}
				});
			});
			var style = self.$$elmt.get(0).style;
			if (self.hubGroupOptions.orientation === "landscape") {
				style.top = "0px";
				style.left = self.hubGroupOptions.posX + "px";
				style.width = self._width + "px";
				style.height = (self.hubGroupOptions.maxHeight - self._headerSpace) + "px";
			} else {
				style.top = self.hubGroupOptions.posY + "px";
				style.left = "0px";
				style.width = self._width + "px";
				style.height = self._height + "px";
				self._height += self._headerSpace;
			}
		},

		/**
		 * Calc tile positions in horizontal scrolling model
		 */
		_calculateLayoutHorizontal: function() {
			var self = this;

			self.hubGroupOptions.baseSize = 70;
			self.hubGroupOptions.padX = 5;
			self.hubGroupOptions.padY = 5;

			self.hubGroupOptions.maxGroupHeight = self.hubGroupOptions.maxHeight - self._headerSpace;
			self.hubGroupOptions.maxGroupWidth = 4 * self.hubGroupOptions.baseSize + 3 * self.hubGroupOptions.padX;

			self.hubGroupOptions.maxFullTileHeight = Math.floor((self.hubGroupOptions.maxGroupHeight + self.hubGroupOptions.padY) / (self.hubGroupOptions.baseSize + self.hubGroupOptions.padY) / 2) * (self.hubGroupOptions.baseSize + self.hubGroupOptions.padY) * 2 - self.hubGroupOptions.padY;

			self._sizes = {
				small: {
					width: self.hubGroupOptions.baseSize,
					height: self.hubGroupOptions.baseSize
				},
				medium: {
					width: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padX,
					height: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padY
				},
				wide: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padY
				},
				large: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padY * 3
				},
				full: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.maxFullTileHeight
				}
			};

			var relX = 0;
			var relY = 0;
			var x = 0;
			var y = 0;

			self.cells.forEach(function(cell) {
				cell.w = self._sizes[cell.size].width;
				cell.h = self._sizes[cell.size].height;
				if ((y + cell.h > self.hubGroupOptions.maxGroupHeight) ||
					(y !== 0 && cell.size === "full")) // full size cell always use one full column 
				{
					y = 0;
					relX += self.hubGroupOptions.maxGroupWidth + self.hubGroupOptions.padX;
					x = relX;
				}
				if (cell.size === "medium") {
					if ((x - relX) + cell.w > self.hubGroupOptions.maxGroupWidth) {
						x = relX;
						y += cell.h + self.hubGroupOptions.padY;
					}
					cell.x = x;
					cell.y = y;
					x += cell.w + self.hubGroupOptions.padX;
				} else {
					if (x !== relX) {
						x = relX;
						y += self._sizes.medium.height + self.hubGroupOptions.padY;
					}
					cell.x = x;
					cell.y = y;
					y += cell.h + self.hubGroupOptions.padY;
				}
			});
		},

		/**
		 * Calc tile positions in horizontal scrolling model
		 */
		_calculateLayoutVertical: function() {
			var self = this;

			self.hubGroupOptions.padX = 5;
			self.hubGroupOptions.padY = 5;
			self.hubGroupOptions.baseSize = Math.floor((self.hubGroupOptions.maxWidth - 5 * self.hubGroupOptions.padX - self._verticalBorderSubstraction) / 40) * 10;

			self.hubGroupOptions.maxGroupWidth = 4 * self.hubGroupOptions.baseSize + 3 * self.hubGroupOptions.padX;
			self.hubGroupOptions.maxGroupHeight = self.hubGroupOptions.maxHeight - self._headerSpace;
			self.hubGroupOptions.maxFullTileHeight = self.hubGroupOptions.maxGroupHeight;

			self._sizes = {
				small: {
					width: self.hubGroupOptions.baseSize,
					height: self.hubGroupOptions.baseSize
				},
				medium: {
					width: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padX,
					height: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padY
				},
				wide: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.baseSize * 2 + self.hubGroupOptions.padY
				},
				large: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padY * 3
				},
				full: {
					width: self.hubGroupOptions.baseSize * 4 + self.hubGroupOptions.padX * 3,
					height: self.hubGroupOptions.maxFullTileHeight
				}
			};

			var x = 0;
			var y = 0;

			self.cells.forEach(function(cell) {
				cell.w = self._sizes[cell.size].width;
				cell.h = self._sizes[cell.size].height;

				if (cell.size === "medium") {
					cell.x = x;
					cell.y = y;

					x += cell.w + self.hubGroupOptions.padX;
					if (x + cell.w > self.hubGroupOptions.maxGroupWidth) {
						x = 0;
						y += cell.h + self.hubGroupOptions.padY;
					}
				} else {
					if (x > 0) { // middle of line of medium size -> next line
						x = 0;
						y += self._sizes.medium.height + self.hubGroupOptions.padY;
					}
					cell.x = x;
					cell.y = y;
					y += cell.h + self.hubGroupOptions.padY;
				}
			});
		},

		getWidth: function() {
			return this._width;
		},
		getHeight: function() {
			return this._height;
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/vignetteBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/controls/ctrlBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/application/pageLoader','syracuse-tablet/html/js/ui/modal'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var PageLoader = require('syracuse-tablet/html/js/application/pageLoader').Klass;
var modal = require('syracuse-tablet/html/js/ui/modal');

var _waitConfig = {
	className: 'waiting-blocks',
	elements: 5,
	auto: true,
	speed: 200
};
var _templates = {
	main: '\
		<div id="{{ctrlId}}" class="s-m-control s-m-vignette"> \
			<section></section> \
			<footer> \
				<div class="s-m-waiting" style="display:none"></div> \
			</footer> \
		</div>\
	',
	iframe: '\
		<br><iframe src="{{url}}" style="position: absolute; top: 0px; left: 0px; height: 100vh; width: 100vh;"/>\
	',
	navgigBtns: '\
		<a href="#" data-action="vignetteBack" class="glyphicon glyphicon-circle-arrow-left" style="display:none"></a>\
		<a href="#" data-action="vignetteHome" class="glyphicon glyphicon-home" style="display:none"></a>\
	',
	vignetteError: '\
		<a href="#" data-action="vignetteError">{{text}}</a>\
	',
	linkPage: '<a href="{{href}}" data-nav-target="application" data-nav="{{data-nav}}" data-gadget-id="{{data-gadget-id}}" class="s-m-link-page">{{title}}</a>'
};

var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};


var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self._currentPage = null;
		self._pageLoader = null;
		self._$$wait = null;
		self._stateStack = [];
		self._error = null;
		self.openLinkInVignette = globals.$config("openLinkInVignette");
	}, Base, {
		destroy: function() {
			var self = this;
			self._error = null;
			uiUtils.waitPluginDestroy(self._$$wait);
			if (self._currentPage) {
				self._currentPage.destroy();
				self._currentPage = null;
			}
			if (self._pageLoader = null) {
				self._pageLoader.destroy();
				self._pageLoader = null;
			}
			Base.prototype.destroy.call(self);
		},
		/**
		 * If vignette contains a page return the control object identified by id
		 */
		getPageControl: function(ctrlId) {
			return this._currentPage && this._currentPage.getControl ? this._currentPage.getControl(ctrlId) : null;
		},

		getPage: function() {
			return this._currentPage;
		},

		/**
		 * Change current page - called from eventListener
		 * 	data-nav action has been clicked in a vignette's link
		 * 	we could have a parameter that indicates if the link has to be opened full page or inside the vignette
		 */
		changePage: function(state, options) {
			options = options || {};
			// Always full page
			options.$displayStyle = "$full";
			return this._loadPage(state, options, false);
		},
		/**
		 * Refresh current page - called from eventListener
		 */
		refreshPage: function(options) {
			var self = this;
			if (!self._currentPage) throw new Error("No current page");
			self._currentPage.refresh(options, {
				waitStart: function(controlId) {
					// Wait managed by vignette
					self.waitStart();
				},
				waitStop: function(controlId) {
					self.waitStop();
				}
			}).then(function() {
				//	Eventually do something in vignette control	
			}, function(e) {
				modal.error("Refresh page on vignette", e);
			});;
		},

		/**
		 * Load a page
		 * 	back if history.back - back icon button
		 */
		_loadPage: function(state, options, back) {
			var self = this;
			self._error = null;
			self._$$content.empty();
			if (!self._pageLoader) {
				/**
				 * Page loader shared with application
				 * Load a page
				 */
				self._pageLoader = new PageLoader({
					waitStop: function() {
						self.waitStop();
					},
					waitStart: function() {
						self.waitStart();
					},
					getRootElmt: function() {
						return self._$$content;
					},
					getCurrentPage: function() {
						return self._currentPage;
					},
					setCurrentPage: function(page) {
						self._currentPage = page;
					},
					setHistory: function(state) {
						if (self.openLinkInVignette) {
							self._stateStack.push(state);
						}
					},
					succeeded: function() {
						if (self.openLinkInVignette) {
							self.refreshNavBtns();
						}
					},
					loadingError: function(deferred, state, e) {
						self._displayError("Loading page [" + state.name + "] error", e);
						// No reject
						deferred.resolve();
					}
				});
			}
			var pageInfo;
			if (typeof state === "string") {
				options = options || {};
				options.vignette = true;
				pageInfo = globals.getApplication().getPageInfo(state, options);
			} else if (back) {
				pageInfo = state;
			} else {
				throw new Error("Unexpected state");
			}
			if (pageInfo.options && pageInfo.options.$displayStyle === "$full") {
				return self._pageLoader.load(pageInfo, back);
			} else if (options.gadget) {
				var deferred = $.Deferred();
				self._addPicker({
					"data-nav": pageInfo.name,
					"data-gadget-id": options.gadget.data("$uuid"),
					"title": options.gadget.data("$title")
				});
				deferred.resolve();
				return deferred.promise();
			} else {
				throw new Error("Unexpected vignette page");
			}
		},

		_loadRepresentation: function(gadget, name, options) {
			var self = this;
			options = $.extend({}, options);
			options.$displayStyle = self.prototype.data("$displayStyle");
			options.gadget = gadget;
			options.article = self.article && self.article.$article; // sub article in case the layout of a vignette is defined in the dashboard layout
			return self._loadPage(name || gadget.getPageName(), options);
		},

		_displayError: function(msg, detail) {
			var self = this;
			self._error = {
				message: msg,
				detail: detail
			};
			self.$$elmt.addClass("s-m-error");
			self.$$elmt.html(_getHtml("vignetteError", {
				text: "Loading failed"
			}));
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			self.setRootElement(_getHtml("main", {
				ctrlId: self.id
			}), $$parent);
			self._$$content = self.$$elmt.children("section");
			self.$$icons = self.$$elmt.children("footer");
			self._$$wait = uiUtils.waitPluginCreate(self.$$icons.children(".s-m-waiting"), _waitConfig);
		},

		/**
		 * First load of the page
		 */
		load: function(name, options) {
			var self = this;
			options = options || {};
			var deferred = $.Deferred();
			var gadget;
			var _finalize = function() {
				deferred.resolve();
			};
			var _fail = function(e) {
				self._displayError(e);
				// Deferred is not rejected because error is displayed in the vignette
				_finalize();
			};
			try {
				gadget = self.prototype.getVignetteGadget();
				if (gadget && gadget.isValid()) {
					switch (gadget.data("$type")) {
						case "$representation":
						case "$stats":
						case "$request":
							self._loadRepresentation(gadget, name, options).then(function() {
								_finalize();
							}, function(e) {
								_fail(e);
							});
							break;
						case "$dashboard":
							self._loadDashboard(gadget);
							break;
						case "$external":
							self._loadExternal(gadget);
							break;
						case "$gadgetMissing":
							self._displayError("Referenced gadget does not exist: " + gadget.data("$uuid"));
							break;
						default:
							self._displayError("Unsupported gadget type: " + gadget.data("$type"));
							break;
					}
				} else {
					self._displayError("Invalid gadget" + (gadget ? " [" + gadget.getInvalidReason() + "]" : ""), gadget ? gadget.getJSON() : "Null gadget");
				}
				_finalize();
			} catch (e) {
				_fail(e);
			} finally {
				return deferred.promise();
			}
		},

		_loadDashboard: function(gadget) {
			this._addPicker({
				"data-nav": gadget.data("dashboardName") + ".$dashboard",
				"data-gadget-id": gadget.data("$uuid"),
				"title": gadget.data("$title")
			});
		},

		_loadExternal: function(gadget) {
			var self = this,
				url = gadget.data("externalUrl");
			var displayStyle = self.prototype.data("$displayStyle");
			self._addPicker({
				"href": url,
				"title": gadget.data("$title")
			});
			if (displayStyle !== "$link") {
				var iFrame = _getHtml("iframe", {
					url: url
				});
				$(iFrame).appendTo(self.$$elmt);
			}
		},

		_addPicker: function(context) {
			if (!context.href) context.href = "#";
			$(_getHtml("linkPage", context)).appendTo(this.$$elmt);
		},

		onLayoutChange: function() {
			if (this._currentPage && this._currentPage.rootLayout) {
				this._currentPage.rootLayout.onLayoutChange && this._currentPage.rootLayout.onLayoutChange();
			}
		},
		waitStart: function() {
			uiUtils.waitPluginEnable(this._$$wait);
		},
		waitStop: function() {
			uiUtils.waitPluginDisable(this._$$wait);
		},

		refreshNavBtns: function() {
			var self = this;
			if (!self.$$icons) {
				$(_getHtml("navgigBtns", {})).prependTo(self.$$icons);
				self.$$icnBack = self.$$icons.find("[data-action=vignetteBack]");
				self.$$icnHome = self.$$icons.find("[data-action=vignetteHome]");
				self.$$icnEmpty = self.$$icons.find("span.text");
			}
			var l = self._stateStack.length;
			self.$$icnBack.toggle(l > 1);
			self.$$icnHome.toggle(l > 2);
			self.$$icnEmpty.toggle(l <= 1);
		},

		_actVignetteHome: function() {
			var self = this;
			if (self._stateStack.length == 0) return;
			self._loadPage(self._stateStack[0], null, true);
			self._stateStack = [];
		},

		_actVignetteBack: function() {
			var self = this;
			if (self._stateStack.length <= 1) return;
			self._stateStack.pop();
			self._loadPage(self._stateStack[self._stateStack.length - 1], null, true);
		},
		_actVignetteError: function() {
			var self = this;
			modal.error("Vignette load error", self._error);
		}


	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/ctrlPageHeader',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/sdata/sdataUtils','syracuse-tablet/html/js/controls/structElmt'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');
var Base = require('syracuse-tablet/html/js/controls/structElmt').Klass;


var _templates = {
	main: '\
		<div id="{{ctrlId}} class="s-m-control"> \
			<nav class="navbar navbar-inverse" role="navigation">\
				<div class="container-fluid">\
					<div class="navbar-header">\
						<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-collapse-{{ctrlId}}">\
					        <span class="icon-bar"></span>\
					        <span class="icon-bar"></span>\
					        <span class="icon-bar"></span>\
						</button>\
						<a data-action="reload" class="navbar-brand" href="#">{{title}}</a>\
					</div>\
					<div class="collapse navbar-collapse" id="header-collapse-{{ctrlId}}">\
						<ul class="nav navbar-nav">\
							<li></li>\
						</ul>\
						<ul class="nav navbar-nav navbar-right">\
							<li>\
							<a href="#" data-action="clearCache">\
							<span class="glyphicon glyphicon-fire" /></a>\
							</li>\
							<li>\
							<a href="#" data-action="logout"> \
								<span class="glyphicon glyphicon-log-out" />{{logout}}\
							</a>\
							</li>\
							<li>\
							<a href="#" data-action="switchContext"> \
								<span class="glyphicon glyphicon-user" />\
							</a>\
							</li>\
							<li style="display:none" class="linkbar">\
								<a href="#" data-action="openlinksbar"  data-control-id="{{ctrlId}}">\
									<span class="glyphicon glyphicon-align-justify" />\
								</a>\
							</li>\
						</ul>\
						<form style="display:none" class="navbar-form navbar-right" role="search">\
							<div class="form-group input-group-sm"">\
								<input type="text" class="form-control" placeholder="Search">\
							</div>\
							<button type="submit" class="btn btn-success">\
								<span class="glyphicon glyphicon-search"></span>\
							</button>\
						</form>\
					</div>\
				</div>\
			</nav> \
		</div>',
	linkBar: '\
		<div class="s-m-links-bar-layout" style="display:none">\
			<div class="s-m-links-bar" style="height:866px"> \
			 {{#each links}} \
				<div class="s-m-links-bar-slot"> \
					<div class="s-m-links-bar-item-slot">\
						<a class="s-m-links-bar-item" href="#" data-nav="{{data-nav}}" data-sdata-url="{{data-sdata-url}}">{{title}}</a> \
					</div> \
				</div> \
			 {{/each}} \
			</div> \
		</div>\
		'
};

var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};

/**
 * Page header Generate Html
 */
var _Klass = utils.defineClass(

	function(controller, $type) {
		var self = this;
		Base.call(self, controller, $type);
	}, Base, {

		destroy: function() {
			var self = this;
			Base.prototype.destroy.call(self);
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			var _mainCtx = {
				title: "Sage ERP X3 - Mobile",
				logout: "Logout",
				ctrlId: self.id
			};
			self.setRootElement(_getHtml("main", _mainCtx), $$parent);
			var $links = self.controller.prototype.data("$links");
			if ($links && Object.keys($links).length > 0) {
				// Process links and create link panel + header icon for open/close
				var linksCtx = [];
				$.each($links, function(name, value) {
					try {
						var link = sdataUtils.getLinkInfo(value.$url, controllerDao);
						linksCtx.push({
							"data-nav": link.page,
							"data-sdata-url": link.sDataUrl,
							"title": utils.parseExpression(value.$title, null, self.controller.prototype) || self.getLinkTitle(name)
						});
					} catch (e) {
						value = value || {};
						console.log("invalid link" + (value.$title || 'no title') + "\n\t" + (value.$url || 'no url'));
					}
				});
				self.$$linksBar = $(_getHtml("linkBar", {
					links: linksCtx
				})).prependTo(self.$$elmt);
				self.$$elmt.find("li.linkbar").show();
			}
		},

		// TODO
		getLinkTitle: function(facetValue) {
			switch (facetValue) {
				case "$edit":
					return "Edit";
				case "$query":
					return "List";
				case "$save":
					return "Save";
				case "$details":
					return "Detail";
				default:
					throw new Error("Facet " + facetValue + " not implemented yet");
			}
		},

		_actOpenlinksbar: function(linksBar) {
			var self = this;
			if (self.$$linksBar) self.$$linksBar.toggle();
		}
	});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/ctrlTypeUnknown',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/ctrlBase'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;

/**
 * Base class for controls that display exactly one value/property
 */
var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
	}, Base, {

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			self.createRootElement(["s-m-control", "s-m-field-slot", "s-m-field-slot-unknown"], $$parent).text("Unknown type: " + self.$type);
		}
	}
);

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/chart/ctrlCubeChartTheme',['require','exports','module'],function (require, exports, module) {

var theme = {
	//colors: ['#007f64', '#34b233', '#4d4f53', '#9a9b9c', '#ff5800', '#009fda', '#6639b7' /*green brightgreen darkgrey midgray orange blue purple*/ , '#409f8b', '#67c566', '#7a7b7e', '#b3b4b5', '#ff8240', '#40b7e3', '#8c6bc9', /*75%*/ /*'#7fbfb1','#99d899','#a6a7a9','#cccdcd','#ffab7f','#7fcfec','#b29cdb',50%*/ ],
	colors: ['#BF7070', '#BFB730', '#7ABF30', '#7373FF', '#BF7730', '#BF3080', '#30BF9F', '#FF7373', '#FFF773', '#85FF00', '#3030BF', '#FF9F40', '#FF40BC', '#1699A6', '#FF0000', '#FFF100', '#00FF00', '#0000FF', '#FF7F00', '#FF00A6', '#00FFC6', '#A60000', '#A69C00', '#56A600', '#90B2FF', '#A65200', '#A6006C', '#00A681', '#FF4040', '#FFF440', '#A3FF40', '#3673FF', '#FFB873', '#FF76CE', '#73FFED'],
	chart: {
		borderRadius: '0',
		spacingTop: 10,
		backgroundColor: '#fff',
		borderColor: '#ccc',
		borderWidth: 1,
		className: 'dark-container',
		// backgroundColor: {
		//	linearGradient: [250, 250, 250, 400],
		// 	stops: [
		// 		[0, 'rgb(250, 250, 250)'],
		// 		[1, 'rgb(240, 240, 240)']
		// 	]
		// },
		resetZoomButton: {
			theme: {
				fill: 'white',
				stroke: '#dddddd',
				r: 0,
				states: {
					hover: {
						fill: '#00a1de',
						style: {
							color: 'white'
						}
					}
				}
			},
			position: {
				// align: 'right', // by default
				// verticalAlign: 'top', // by default
				x: -50,
				y: 5
			},
			relativeTo: 'chart'
		}
	},
	title: {
		style: {
			color: '#464646',
			font: 'bold 16px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	subtitle: {
		style: {
			color: '#464646',
			font: 'bold 12px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	xAxis: {
		gridLineColor: 'rgba(0, 0, 0, 0.05)',
		gridLineDashStyle: 'longdash',
		gridLineWidth: 1,
		labels: {
			style: {
				color: '#A0A0A0'
			}
		},
		lineColor: 'rgba(0, 0, 0, 0.2)',
		tickColor: 'rgba(0, 0, 0, 0.2)',
		title: {
			style: {
				color: '#464646',
				fontWeight: 'normal',
				fontSize: '20px',
				fontFamily: 'arial',
			}
		}
	},
	yAxis: {
		minorGridLineColor: 'rgba(0, 0, 0, 0.05)',
		minorTickInterval: 'auto',
		/*alternateGridColor: 'rgba(0, 0, 0, 0.02)',*/
		gridLineWidth: 2,
		gridLineColor: 'rgba(0, 0, 0, 0.07)',
		labels: {
			align: 'left',
			x: 0,
			y: 12,
			style: {
				color: '#A0A0A0'
			}
		},
		lineColor: 'rgba(0, 0, 0, 0.07)',
		/*minorTickInterval: null,*/

		title: {
			style: {
				color: '#CCC',
				fontSize: '16px',
				fontFamily: 'Georgia, Verdana, sans-serif',
				fontStyle: 'italic',
			}
		}
	},
	tooltip: { /*backgroundColor: 'rgba(250,250, 250, 0.75)',*/
		backgroundColor: '#464646',
		borderRadius: '0',
		style: {
			color: '#fff',
			/*fontFamily: '"georgia"',
			fontStyle: 'italic',*/
			fontSize: '12px',
			padding: '5px',
			whiteSpace: 'nowrap',

		}
	},
	toolbar: {
		itemStyle: {
			color: 'silver'
		}
	},
	plotOptions: {
		series: {
			marker: { /*	fillColor: '#FFFFFF',*/
				lineWidth: 2,
				lineColor: null,
				// inherit from series,
				radius: 4,
				states: {
					hover: {
						radius: 8,
						lineColor: null,
					}
				}
			}
		},
		area: {
			fillOpacity: 0.15

		},
		areaspline: {
			fillOpacity: 0.15
		},
		line: {
			dataLabels: {
				color: '#CCC'
			},
			marker: {
				lineColor: '#FFFFFF',
			}
		},
		spline: {
			marker: {
				lineColor: '#FFFFFF',
			}
		},
		scatter: {
			marker: {
				lineColor: '#FFFFFF'
			}
		},
		candlestick: {
			lineColor: '#FFFFFF',
			animation: {
				duration: 2000,
				easing: 'easeOutBounce'
			}
		},
		pie: {
			allowPointSelect: true,
			cursor: 'pointer',
			borderColor: 'rgba(250,250,250,0.3)',
			borderWidth: 0.5,
			dataLabels: {
				enabled: true,
				connectorWidth: 2,
				color: '#464646',
				style: {
					fontWeight: 'bold'
				}
			},
		},

	},
	legend: {
		borderRadius: 0,
		borderWidth: 1,
		// borderColor: '#dddddd',
		backgroundColor: 'white',
		//shadow: true,
		itemMarginTop: 8,
		itemStyle: {
			color: '#464646',
			fontFamily: '"arial"',
			fontWeight: 'bold',
			/*fontStyle: 'italic',*/
			fontSize: '8pt ',
		},
		itemHoverStyle: {
			color: '#00a1de'
		},
		itemHiddenStyle: {
			color: '#555'
		},
		title: {
			style: {
				color: '#464646',
				fontWeight: 'bold',
				fontSize: '8pt',
				fontFamily: 'arial',
			}
		}
	},
	credits: {
		enabled: false,
		style: {
			color: '#666'
		}
	},
	labels: {
		style: {
			color: '#CCC'
		}
	},

	exporting: {
		buttons: {
			drillUp: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',

			},
			exportButton: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',

			},
			printButton: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',
			}
		}
	},

	// scroll charts
	rangeSelector: {
		buttonTheme: {
			fill: {
				linearGradient: [0, 0, 0, 20],
				stops: [
					[0.4, '#888'],
					[0.6, '#555']
				]
			},
			stroke: '#000000',
			style: {
				color: '#CCC',
				fontWeight: 'bold'
			},
			states: {
				hover: {
					fill: {
						linearGradient: [0, 0, 0, 20],
						stops: [
							[0.4, '#BBB'],
							[0.6, '#888']
						]
					},
					stroke: '#000000',
					style: {
						color: 'white'
					}
				},
				select: {
					fill: {
						linearGradient: [0, 0, 0, 20],
						stops: [
							[0.1, '#000'],
							[0.3, '#333']
						]
					},
					stroke: '#000000',
					style: {
						color: 'yellow'
					}
				}
			}
		},
		inputStyle: {
			backgroundColor: '#333',
			color: 'silver'
		},
		labelStyle: {
			color: 'silver'
		}
	},

	navigator: {
		handles: {
			backgroundColor: '#666',
			borderColor: '#AAA'
		},
		outlineColor: '#CCC',
		maskFill: 'rgba(16, 16, 16, 0.5)',
		series: {
			color: '#7798BF',
			lineColor: '#A6C7ED'
		}
	},

	scrollbar: {
		barBackgroundColor: {
			linearGradient: [0, 0, 0, 20],
			stops: [
				[0.4, '#888'],
				[0.6, '#555']
			]
		},
		barBorderColor: '#CCC',
		buttonArrowColor: '#CCC',
		buttonBackgroundColor: {
			linearGradient: [0, 0, 0, 20],
			stops: [
				[0.4, '#888'],
				[0.6, '#555']
			]
		},
		buttonBorderColor: '#CCC',
		rifleColor: '#FFF',
		trackBackgroundColor: {
			linearGradient: [0, 0, 0, 10],
			stops: [
				[0, '#000'],
				[1, '#333']
			]
		},
		trackBorderColor: '#666'
	},

	// special colors for some of the
	legendBackgroundColor: 'rgba(0, 0, 0, 0.5)',
	legendBackgroundColorSolid: 'rgb(35, 35, 70)',
	dataLabelsColor: '#444',
	textColor: '#C0C0C0',
	maskColor: 'rgba(255,255,255,0.3)'
};

var colors = theme.colors;

// Options for Org chart view
theme.orgChart = {
	node: {
		textColor: 'black ',
		borderColor: colors[1],
		borderWidth: 2,
		backgroundColor: 'white ',
		fontWeight: 'normal ',
		hover: {
			backgroundColor: colors[3],
			textColor: 'white '
		}
	},
	junction: {
		lineColor: colors[3],
		lineWidth: 2
	},
	dropMarker: {
		borderColor: colors[1],
		borderWidth: 0,
		backgroundColor: colors[4],
		backgroundOpacity: 1
	},
	tooltip: {
		backgroundColor: colors[1],
		backgroundOpacity: 1,
		borderWidth: 2,
		borderRadius: 0,
		borderColor: colors[2],
		style: {
			color: '#fff',
			/*fontFamily: '"georgia"',
			fontStyle: 'italic',*/
			fontSize: '12px',
			padding: '5px',
			whiteSpace: 'nowrap',
		}
	}
};

theme.version = Highcharts.version.split(".").map(function(e) {
	return parseInt(e, 10);
});

if (theme.version[0] === 2) {
	// theme.navigation = {
	// 	buttonOptions: {
	// 		borderRadius: 50,
	// 		height: 24,
	// 		width: 24,
	// 		backgroundColor: '#00acec',
	// 		borderColor: '#00a1de',
	// 		symbolX: 12,
	// 		symbolY: 12,
	// 	}
	// },
} else if (theme.version[0] === 3) {
	theme.navigation = {
		buttonOptions: {
			symbolStroke: '#DDDDDD',
			hoverSymbolStroke: '#FFFFFF',
			theme: {
				fill: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0.4, '#606060'],
						[0.6, '#333333']
					]
				},
				stroke: '#000000'
			}
		}
	};

	delete theme.exporting;
}

exports.theme = theme;
});

define('syracuse-ui/themes/desktop/sage/highcharts/theme',['require','exports','module'],function (require, exports, module) {var theme = {
	//colors: ['#007f64', '#34b233', '#4d4f53', '#9a9b9c', '#ff5800', '#009fda', '#6639b7' /*green brightgreen darkgrey midgray orange blue purple*/ , '#409f8b', '#67c566', '#7a7b7e', '#b3b4b5', '#ff8240', '#40b7e3', '#8c6bc9', /*75%*/ /*'#7fbfb1','#99d899','#a6a7a9','#cccdcd','#ffab7f','#7fcfec','#b29cdb',50%*/ ],
	colors: ['#BF7070','#BFB730','#7ABF30','#7373FF','#BF7730','#BF3080','#30BF9F','#FF7373','#FFF773','#85FF00','#3030BF','#FF9F40','#FF40BC','#1699A6','#FF0000','#FFF100','#00FF00','#0000FF','#FF7F00','#FF00A6','#00FFC6','#A60000','#A69C00','#56A600','#90B2FF','#A65200','#A6006C','#00A681','#FF4040','#FFF440','#A3FF40','#3673FF','#FFB873','#FF76CE','#73FFED'],
	chart: {
		borderRadius: '0',
		spacingTop: 10,
		backgroundColor: '#fff',
		borderColor: '#ccc',
		borderWidth: 1,
		className: 'dark-container',
		// backgroundColor: {
		//	linearGradient: [250, 250, 250, 400],
		// 	stops: [
		// 		[0, 'rgb(250, 250, 250)'],
		// 		[1, 'rgb(240, 240, 240)']
		// 	]
		// },
		resetZoomButton: {
			theme: {
				fill: 'white',
				stroke: '#dddddd',
				r: 0,
				states: {
					hover: {
						fill: '#00a1de',
						style: {
							color: 'white'
						}
					}
				}
			},
			position: {
				// align: 'right', // by default
				// verticalAlign: 'top', // by default
				x: -50,
				y: 5
			},
			relativeTo: 'chart'
		}
	},
	title: {
		style: {
			color: '#464646',
			font: 'bold 16px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	subtitle: {
		style: {
			color: '#464646',
			font: 'bold 12px "Trebuchet MS", Verdana, sans-serif'
		}
	},
	xAxis: {
		gridLineColor: 'rgba(0, 0, 0, 0.05)',
		gridLineDashStyle: 'longdash',
		gridLineWidth: 1,
		labels: {
			style: {
				color: '#A0A0A0'
			}
		},
		lineColor: 'rgba(0, 0, 0, 0.2)',
		tickColor: 'rgba(0, 0, 0, 0.2)',
		title: {
			style: {
				color: '#464646',
				fontWeight: 'normal',
				fontSize: '20px',
				fontFamily: 'arial',
			}
		}
	},
	yAxis: {
		minorGridLineColor: 'rgba(0, 0, 0, 0.05)',
		minorTickInterval: 'auto',
		/*alternateGridColor: 'rgba(0, 0, 0, 0.02)',*/
		gridLineWidth: 2,
		gridLineColor: 'rgba(0, 0, 0, 0.07)',
		labels: {
			align: 'left',
			x: 0,
			y: 12,
			style: {
				color: '#A0A0A0'
			}
		},
		lineColor: 'rgba(0, 0, 0, 0.07)',
		/*minorTickInterval: null,*/

		title: {
			style: {
				color: '#CCC',
				fontSize: '16px',
				fontFamily: 'Georgia, Verdana, sans-serif',
				fontStyle: 'italic',
			}
		}
	},
	tooltip: { /*backgroundColor: 'rgba(250,250, 250, 0.75)',*/
		backgroundColor: '#464646',
		borderRadius: '0',
		style: {
			color: '#fff',
/*fontFamily: '"georgia"',
			fontStyle: 'italic',*/
			fontSize: '12px',
			padding: '5px',
			whiteSpace: 'nowrap',

		}
	},
	toolbar: {
		itemStyle: {
			color: 'silver'
		}
	},
	plotOptions: {
		series: {
			marker: { /*	fillColor: '#FFFFFF',*/
				lineWidth: 2,
				lineColor: null,
				// inherit from series,
				radius: 4,
				states: {
					hover: {
						radius: 8,
						lineColor: null,
					}
				}
			}
		},
		area: {
			fillOpacity: 0.15

		},
		areaspline: {
			fillOpacity: 0.15
		},
		line: {
			dataLabels: {
				color: '#CCC'
			},
			marker: {
				lineColor: '#FFFFFF',
			}
		},
		spline: {
			marker: {
				lineColor: '#FFFFFF',
			}
		},
		scatter: {
			marker: {
				lineColor: '#FFFFFF'
			}
		},
		candlestick: {
			lineColor: '#FFFFFF',
			animation: {
				duration: 2000,
				easing: 'easeOutBounce'
			}
		},
		pie: {
			allowPointSelect: true,
			cursor: 'pointer',
			borderColor: 'rgba(250,250,250,0.3)',
			borderWidth: 0.5,
			dataLabels: {
				enabled: true,
				connectorWidth: 2,
				color: '#464646',
				style: {
					fontWeight: 'bold'
				}
			},
		},

	},
	legend: {
		borderRadius: 0,
		borderWidth: 1,
		// borderColor: '#dddddd',
		backgroundColor: 'white',
		//shadow: true,
		itemMarginTop: 8,
		itemStyle: {
			color: '#464646',
			fontFamily: '"arial"',
			fontWeight: 'bold',
			/*fontStyle: 'italic',*/
			fontSize: '8pt ',
		},
		itemHoverStyle: {
			color: '#00a1de'
		},
		itemHiddenStyle: {
			color: '#555'
		},
		title: {
			style: {
				color: '#464646',
				fontWeight: 'bold',
				fontSize: '8pt',
				fontFamily: 'arial',
			}
		}
	},
	credits: {
		enabled: false,
		style: {
			color: '#666'
		}
	},
	labels: {
		style: {
			color: '#CCC'
		}
	},

	exporting: {
		buttons: {
			drillUp: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',

			},
			exportButton: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',

			},
			printButton: {
				symbolStroke: '#fff',
				symbolFill: 'rgba(250,250,250,0.5)',
				hoverSymbolStroke: '#fff',
				hoverSymbolFill: 'rgba(250,250,250,0.5)',
			}
		}
	},

	// scroll charts
	rangeSelector: {
		buttonTheme: {
			fill: {
				linearGradient: [0, 0, 0, 20],
				stops: [
					[0.4, '#888'],
					[0.6, '#555']
				]
			},
			stroke: '#000000',
			style: {
				color: '#CCC',
				fontWeight: 'bold'
			},
			states: {
				hover: {
					fill: {
						linearGradient: [0, 0, 0, 20],
						stops: [
							[0.4, '#BBB'],
							[0.6, '#888']
						]
					},
					stroke: '#000000',
					style: {
						color: 'white'
					}
				},
				select: {
					fill: {
						linearGradient: [0, 0, 0, 20],
						stops: [
							[0.1, '#000'],
							[0.3, '#333']
						]
					},
					stroke: '#000000',
					style: {
						color: 'yellow'
					}
				}
			}
		},
		inputStyle: {
			backgroundColor: '#333',
			color: 'silver'
		},
		labelStyle: {
			color: 'silver'
		}
	},

	navigator: {
		handles: {
			backgroundColor: '#666',
			borderColor: '#AAA'
		},
		outlineColor: '#CCC',
		maskFill: 'rgba(16, 16, 16, 0.5)',
		series: {
			color: '#7798BF',
			lineColor: '#A6C7ED'
		}
	},

	scrollbar: {
		barBackgroundColor: {
			linearGradient: [0, 0, 0, 20],
			stops: [
				[0.4, '#888'],
				[0.6, '#555']
			]
		},
		barBorderColor: '#CCC',
		buttonArrowColor: '#CCC',
		buttonBackgroundColor: {
			linearGradient: [0, 0, 0, 20],
			stops: [
				[0.4, '#888'],
				[0.6, '#555']
			]
		},
		buttonBorderColor: '#CCC',
		rifleColor: '#FFF',
		trackBackgroundColor: {
			linearGradient: [0, 0, 0, 10],
			stops: [
				[0, '#000'],
				[1, '#333']
			]
		},
		trackBorderColor: '#666'
	},

	// special colors for some of the
	legendBackgroundColor: 'rgba(0, 0, 0, 0.5)',
	legendBackgroundColorSolid: 'rgb(35, 35, 70)',
	dataLabelsColor: '#444',
	textColor: '#C0C0C0',
	maskColor: 'rgba(255,255,255,0.3)'
};

var colors = theme.colors;

// Options for Org chart view
theme.orgChart = {
	node: {
		textColor: 'black ',
		borderColor: colors[1],
		borderWidth: 2,
		backgroundColor: 'white ',
		fontWeight: 'normal ',
		hover: {
			backgroundColor: colors[3],
			textColor: 'white '
		}
	},
	junction: {
		lineColor: colors[3],
		lineWidth: 2
	},
	dropMarker: {
		borderColor: colors[1],
		borderWidth: 0,
		backgroundColor: colors[4],
		backgroundOpacity: 1
	},
	tooltip: {
		backgroundColor: colors[1],
		backgroundOpacity: 1,
		borderWidth: 2,
		borderRadius: 0,
		borderColor: colors[2],
		style: {
			color: '#fff',
/*fontFamily: '"georgia"',
			fontStyle: 'italic',*/
			fontSize: '12px',
			padding: '5px',
			whiteSpace: 'nowrap',
		}
	}
};

theme.version = Highcharts.version.split(".").map(function(e) {
	return parseInt(e, 10);
});

if (theme.version[0] === 2) {
	// theme.navigation = {
	// 	buttonOptions: {
	// 		borderRadius: 50,
	// 		height: 24,
	// 		width: 24,
	// 		backgroundColor: '#00acec',
	// 		borderColor: '#00a1de',
	// 		symbolX: 12,
	// 		symbolY: 12,
	// 	}
	// },
} else if (theme.version[0] === 3) {
	theme.navigation = {
		buttonOptions: {
			symbolStroke: '#DDDDDD',
			hoverSymbolStroke: '#FFFFFF',
			theme: {
				fill: {
					linearGradient: {
						x1: 0,
						y1: 0,
						x2: 0,
						y2: 1
					},
					stops: [
						[0.4, '#606060'],
						[0.6, '#333333']
					]
				},
				stroke: '#000000'
			}
		}
	};

	delete theme.exporting;
}

exports.theme = theme;
});

define('syracuse-tablet/html/js/controls/chart/ctrlCubeChartBase',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/ctrlBase','syracuse-tablet/html/js/helpers/formatApi','syracuse-tablet/html/js/controls/chart/ctrlCubeChartTheme','syracuse-ui/themes/desktop/sage/highcharts/theme'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var formatApi = require('syracuse-tablet/html/js/helpers/formatApi');
var theme = require('syracuse-tablet/html/js/controls/chart/ctrlCubeChartTheme').theme;

var _merge = Highcharts.merge;
var objectClone = function(o) {
	return $.extend({}, o);
};

Highcharts.theme = require('syracuse-ui/themes/desktop/sage/highcharts/theme').theme;
Highcharts.setOptions(Highcharts.theme);

var colors = Highcharts.theme.colors;

var _style = function($style) {
	var map = {
		xy: "line",
		point: "scatter",
		stick: "column",
		radar: "spiderweb"
	};

	return $style && (map[$style] || $style);
};

function _isCubeValid(cube, proto) {
	return !!(cube && cube.$hierarchies && proto.$axes && proto.$axes.length > 0 && //
		proto.$axes[0].$hierarchies && proto.$axes[0].$hierarchies.length > 0);
}
/**
 * cube chart control class
 *
 * article:
 * $isLegendHidden: true/false
 * $isXLabelHidden: true/false
 * $isYLabelHidden: true/false
 * $isXLabelsHidden: true/false
 * $isYLabelsHidden: true/false
 * $style: line, spline, area, areaspline, bar, stick, pie
 */
var _Klass = utils.defineClass(function(controller, article, prototype) {
	var self = this;
	Base.call(self, controller, article, prototype);
	self.itemProto = prototype.getPrototype("$item");
}, Base, {
	_mergeMetaData: function(metadata) {
		var m = {};
		if (metadata && metadata.$cube) m.$cube = metadata.$cube;
		if (metadata && metadata.$axes) m.$axes = metadata.$axes;
		if (metadata && metadata.$style) m.$style = metadata.$style;
		if (metadata && metadata.$color) m.$color = metadata.$color;
		if (metadata && metadata.$isLegendHidden) m.$isLegendHidden = metadata.$isLegendHidden;
		if (metadata && metadata.$isXLabelHidden) m.$isXLabelHidden = metadata.$isXLabelHidden;
		if (metadata && metadata.$isYLabelHidden) m.$isYLabelHidden = metadata.$isYLabelHidden;
		if (metadata && metadata.$isXLabelsHidden) m.$isXLabelsHidden = metadata.$isXLabelsHidden;
		if (metadata && metadata.$isYLabelsHidden) m.$isYLabelsHidden = metadata.$isYLabelsHidden;
		this.currentMetaData = _merge(this.currentMetaData || {}, m);

		if (metadata && metadata.$item && metadata.$item.$properties && this.currentMetaData && this.currentMetaData.$cube && this.currentMetaData.$cube.$measures) {
			$.smForEachKey(this.currentMetaData.$cube.$measures, function(key, m) {
				if (metadata.$item.$properties[key] && metadata.$item.$properties[key].$title) {
					m.$title = metadata.$item.$properties[key].$title;
				}

			});
		}

		return this.currentMetaData;
	},

	_settingsFromValue: function() {
		var self = this,
			$cube = this.currentMetaData.$cube,
			icolor = 0,
			settings;

		if ($cube.$style === "spiderweb") {
			settings = {};
			settings.categories = Object.keys(self._meta.series).map(function(key) {
				return self._meta.series[key].options.name;
			});

			settings.series = {};
			self.dataset && self.dataset.reduce(function(res, current) {
				var serie = {
					name: self._getMeasureLabel(current, self._meta.xAxis[0].code),
					color: colors[icolor++],
					data: [],
					pointPlacement: 'on'
				};
				if (serie.name) {
					serie.id = "#s-" + serie.name;
					$.smForEachKey(self._meta.series, function(key, s) {
						if (!s.isHidden) self._pushData(serie, key, key, current);
					});
					res.series[serie.name] = serie;
				}
				return res;
			}, settings);
		} else {
			settings = {
				categories: [],
				series: {}
			};
			self.dataset && self.dataset.reduce(function(res, current) {
				var categoryName = self._getMeasureLabel(current, self._meta.xAxis[0].code);
				if (categoryName != null) {
					res.categories.push(categoryName);
					$.smForEachKey(self._meta.series, function(key, s) {
						var serie = res.series[key];
						if (!serie) {
							serie = objectClone(s.options);
							serie.data = [];
							res.series[key] = serie;
						}
						self._pushData(serie, categoryName, key, current);
					});
				}
				return res;
			}, settings);
		}
		return settings;
	},

	_pushData: function(serie, categoryName, key, data) {
		var val = parseFloat(data.$rawV && data.$rawV[key] && data.$rawV[key].v || data[key]) || 0;
		if (this.useLogarithmicAxis) {
			this.maxValue = Math.max(this.maxValue || -Infinity, val);
			this.minValue = Math.min(this.maxValue || Infinity, val);
		}
		serie.data.push([categoryName, val]);
	},

	_createChart: function(settings) {
		var self = this,
			options = _merge(self._getPref(), self._getOptions(self.$prototype));

		if (settings) {
			options.xAxis[0].categories = settings.categories;
			$.smForEachKey(settings.series, function(key, s) {
				var serie = objectClone(s),
					serieMeta = self._meta.series[key];
				if (options.chart.polar && serie && serie.type) {
					delete serie.type;
				}
				if (!(serieMeta && serieMeta.isHidden)) {
					options.series.push(serie);
				}
			});
		} else {
			$.smForEachKey(self._meta.series, function(key, s) {
				var serie = objectClone(s.options);
				if (options.chart.polar && serie && serie.type) {
					delete serie.type;
				}
				serie.data = [0];
				if (!s.isHidden) {
					options.series.push(serie);
				}
			});
		}
		if (!(self.$prototype.$cube && self.$prototype.$cube.$style == "spiderweb")) {
			options.series.reverse();
		}
		if (this.useLogarithmicAxis) {
			if ((this.maxValue || 0) / (this.minValue || 1) > 10) {
				options.yAxis.type = 'logarithmic';
			}
		}
		self._chart = new Highcharts.Chart(options);

		var legend = this._chart.legend;
		self.displayLegend = legend && legend.display;

		var chartSeries = self._chart.series,
			serie, serieMeta;
		for (var j = chartSeries.length - 1; j >= 0; j--) {
			serie = chartSeries[j];
			serieMeta = serie && serie.options.id && self._meta.series[serie.options.id.slice(3)];
			if (serieMeta && serieMeta.measure) {
				serieMeta.measure.$color = serieMeta.options.color = serie.color;
			}
		}
	},

	_getOptions: function(proto) {
		var self = this,
			$cube = this.currentMetaData.$cube,
			defOptions = Highcharts.getOptions(),
			buttons = defOptions.exporting.buttons,
			measuresTitle = this._getFieldEvalTitle(),
			axe = proto.$axes && proto.$axes[0] || {},
			axeTitle = axe.$hierarchies && measuresTitle[axe.$hierarchies[0][0]] || axe.$title,
			enuml;
		var options = {
			chart: {
				renderTo: this.chartSlot,
				zoomType: 'x',
				ignoreHiddenSeries: false,
				width: 50,
				height: 50
			},
			lang: {
				showHideLegend: self._localize.highCharts_showHideLegend
			},

			legend: {
				layout: 'vertical',
				align: 'right',
				verticalAlign: 'top',
				y: 60,
				x: -10,
				title: {
					text: ':::: ' + self._localize.highCharts_seriesTitle,
				},
				floating: true,
				draggable: true,
				zIndex: 20,
				enabled: !(this.currentMetaData.$isLegendHidden === true)
			},
			title: {
				text: ($cube && self._localizedText($cube.$title)) || '',
				margin: 5
			},
			xAxis: [{
				categories: [],
				title: {
					text: self._localizedText(axeTitle),
					enabled: !(this.currentMetaData.$isXLabelHidden === true)
				},
				labels: {
					rotation: -45,
					align: 'right',
					enabled: !(this.currentMetaData.$isXLabelsHidden === true)
				}
			}],

			yAxis: [{
				title: {
					text: '',
					enabled: !(this.currentMetaData.$isYLabelHidden === true)
				},
				labels: {
					align: 'right',
					enabled: !(this.currentMetaData.$isYLabelsHidden === true)
				}
			}],

			plotOptions: {
				series: {
					cursor: 'pointer',
					events: {},
					point: {
						events: {
							click: function(event) {

							}
						}
					},
					stacking: self._meta.stacking,
					animation: false
				}
			},

			tooltip: {
				formatter: function() {
					var seriesMeta = self._meta.series,
						serie = this.key && seriesMeta[this.key] || seriesMeta[this.series.options.id.slice(3)],
						measure = serie && serie.measure,
						data = this.series.processedYData,
						y = this.y;

					if (measure) {
						self._ensureFormatter(measure);
					}
					var label = this.series.name || measure && measure.$title,
						mformat = measure && measure.formatApi,
						mlocale = measure && measure.localeFormat;
					label = (label ? label + "<br>" : "") + (this.x || this.key) + ': <b> ' + (mformat ? mformat.format(y, mlocale) : y) + '</b>';
					if (measure && (measure.$isNormalized) && data.length > 0) {
						var sum = data.reduce(function(a, b) {
							return a + b;
						});
						label += ' (' + (mformat ? mformat.format(y / sum * 100, mlocale) : y / sum * 100) + '%)';
					}

					return label;
				}
			},

			series: [],
		};
		if (Highcharts.theme.version[0] === 3) {
			// For Highcarts 3.0.0
			options.exporting = {
				type: 'image/png',
				url: 'http://export.highcharts.com/',
				buttons: {
					contextButton: { // docs
						//x: -10, // docs: x is different now
						symbol: 'menu',
						enabled: false,
						_titleKey: 'contextButtonTitle',
						menuItems: [{
							textKey: 'showHideLegend',
							onclick: function() {
								setTimeout(function() {
									self._toggleLegendDisplay();
								}, 100);
							}
						}]
					},
					legendButton: {
						enabled: false,
						textKey: 'showHideLegend',
						symbol: 'menu',
						onclick: function() {
							setTimeout(function() {
								self._toggleLegendDisplay();
							}, 100);
						}
					}
				}
			};
			var menuItems = options.exporting.buttons.contextButton.menuItems || [];
			if (this._printSupported()) {
				menuItems.push({
					text: 'Print chart',
					onclick: function() {
						this.print(self);
					}
				});
			}
			if (this._exportSupported()) {
				menuItems.push({
					separator: true
				});
				menuItems.push({
					textKey: 'downloadPNG',
					onclick: function() {
						this.exportChart();
					}
				});
				menuItems.push({
					textKey: 'downloadJPEG',
					onclick: function() {
						this.exportChart({
							type: 'image/jpeg'
						});
					}
				});
				menuItems.push({
					textKey: 'downloadPDF',
					onclick: function() {
						this.exportChart({
							type: 'application/pdf'
						});
					}
				});
				menuItems.push({
					textKey: 'downloadSVG',
					onclick: function() {
						this.exportChart({
							type: 'image/svg+xml'
						});
					}
				});
			}
		}

		if (options.xAxis[0].title.text !== options.title.text) {
			options.xAxis[0].title.text = (options.xAxis[0].title.text ? options.xAxis[0].title.text : options.title.text);
		}
		options.chart.type = self._meta.defaultStyle;

		return options;
	},

	_initializeMeta: function() {
		this._mergeMetaData(this.$prototype);
		this._mergeMetaData(this.article);

		var proto = this.$prototype;
		var cube = this.currentMetaData;

		this._meta = {
			xAxis: [{}],
			series: {},
			displaysOneMeasure: cube && cube.$displaysOneMeasure,
			hasMeasureSelector: cube && cube.$hasMeasureSelector,
			hasStyleSelector: cube && cube.$hasStyleSelector,
			defaultStyle: _style(cube.$style) || 'column',
			drill: {
				minLevel: 1,
				maxLevel: 0,
				currLevel: 1,
				currAxisHier: 0,
				levelsProperties: [],
				members: [],
				stack: [{
					$axes: proto.$axes,
					$item: proto.$item,
					$slicer: proto.$slicer
				}]
			}
		};
		this.__processMeta(proto, true);
	},

	_exportSupported: function() {
		return true;
	},

	_printSupported: function() {
		return true;
	},

	__processMeta: function(metaData, init) {
		this._processMeasures(metaData, init);
		this._processAxes(metaData, init);
	},

	_processMeasures: function(metaData, init) {
		this._mergeMetaData(metaData);

		var self = this,
			items = this.$prototype.$properties;

		// Get measures definition. If measures are not defined in the second axis members (Cf. specs),
		// we used all the measures defined in the cube
		var measures = this._getRestraintMeasures(),
			icolor = 0;
		if (measures) {
			$.smForEachKey(measures, function(key, m) {
				// Because duplicate properties is possible for cube definition... we keep the last defined
				var code = (m.$property || key);
				var measure = _merge(items[code], m);
				if (metaData && metaData.$item && metaData.$item.$properties) {
					measure = _merge(measure, metaData.$item.$properties[code]);
				}
				// measures[key] = measure;
				var serie = self._meta.series[code];

				if (init) {
					self._ensureFormatter(measure);

					serie = self._meta.series[code] = {
						options: {
							id: '#s-' + code,
							// legendIndex: "",
							name: self._localizedText(measure.$title) || String.fromCharCode(160),
							// visible: measure.$title !== "" && !!(!self._meta.displaysOneMeasure || measure.$isDefault)
						},
						measure: measure
					};
				}
				if (serie) {
					serie.isHidden = measure.$title === "";
					serie.options.type = _style(measure.$style);
					serie.options.color = measure.$color || colors[icolor++];
					serie.options.name = self._localizedText(measure.$title) || String.fromCharCode(160);
					serie.options.visible = measure.$title !== "" && !! (!self._meta.displaysOneMeasure || measure.$isDefault);
				}

				if (measure.$isStacked || measure.$stackingGroup) {
					serie.options.stack = measure.$stackingGroup || 0; // a stack ID
					self._meta.stacking = measure.$isNormalized ? 'percent' : self._meta.stacking || 'normal';
				}
			});
		}
	},

	_getRestraintMeasures: function() {
		var proto = this.currentMetaData,
			$cube = proto.$cube,
			measures = $cube && $cube.$measures,
			restraintMeasures = measures;
		if (measures) {
			if (proto.$axes && proto.$axes.length > 1 && proto.$axes[1].$members && proto.$axes[1].$members[0][0].length > 0) {
				restraintMeasures = {};
				$.smForEach(proto.$axes[1].$members[0][0], function(measureCode) {
					restraintMeasures[measureCode] = measures[measureCode];
				});
			}
		}
		return restraintMeasures;
	},

	_processAxes: function(proto, init) {
		var cube = this.$prototype.$cube;
		if (!_isCubeValid(cube, proto)) return false;

		var self = this,
			currAxisHier = 0,
			axis0 = proto.$axes && proto.$axes[0];

		// TODO: review this
		// Get axis analysis
		var mainHLevelsTab = null;
		if (axis0) {
			$.smForEachKey(axis0.$hierarchies, function(idx, hierarchy) {
				if (!mainHLevelsTab && hierarchy.length > 1 && hierarchy[1] == 1) {
					mainHLevelsTab = cube.$hierarchies[hierarchy[0]].$properties;
					if (mainHLevelsTab) {
						self._meta.xAxis[0].code = mainHLevelsTab[hierarchy.length > 2 ? hierarchy[2] : 0];
						currAxisHier = idx;
					}
				}
			});
			if (!mainHLevelsTab && axis0.$hierarchies[0].length > 0) {
				mainHLevelsTab = cube.$hierarchies[axis0.$hierarchies[0][0]].$properties;
				if (mainHLevelsTab && mainHLevelsTab.length > 0) self._meta.xAxis[0].code = mainHLevelsTab[0];
			}
			// Get drill definition
			var properties;
			$.smForEach(axis0.$hierarchies, function(hierarchie) {
				properties = cube.$hierarchies[hierarchie[0]].$properties;
				$.smForEach(properties, function(property) {
					this.levelsProperties[this.maxLevel++] = property;
				}, self._meta.drill);
			});
			if (axis0.$members) {
				$.smForEach(axis0.$members, function(tuple) {
					$.smForEach(tuple, function(value) {
						if (value.length > 0) {
							this.members[(this.currLevel++) - 1] = value[0];
						}
					}, this);
				}, self._meta.drill);
			}
		}
		self._meta.drill.code = proto.$codeStat || "UNKNOWN";
		self._meta.drill.axis0FieldCode = self._meta.xAxis[0].code || "";
		self._meta.drill.maxLevel = Math.max(self._meta.drill.maxLevel, self._meta.drill.minLevel);
	},

	_getPref: function() {
		return Highcharts.getOptions();
	},

	_getMeasureLabel: function(measure, code) {
		// return cubeHelper.getMeasureLabel(measure, code, this.$prototype && this.$prototype.$properties);
		var label = this._localizedText(measure.$title);
		if (label) return label;
		var self = this;
		var item = self.$prototype.$properties[code];
		if (!item) return null;
		switch (item.$type) {
			case "application/x-choice":
				label = measure[code];
				item.$value.$enum.some(function(element, i, array) {
					if (element.$value === label) {
						label = this._localizedText(element.$title);
						return true;
					}
					return false;
				});
				break;
			case "application/x-date":
				item.formatApi = item.formatApi || _formatApi.getApi(item.$type);
				item.localeFormat = item.localeFormat || _formatApi.getLocale().getDateFormat(item.$format);
				label = datetime.parse(measure[code]).toString(item.localeFormat);
				break;
			case "application/x-integer":
			case "application/x-decimal":
				item.formatApi = item.formatApi || _formatApi.getApi(item.$type);
				item.formatObj = item.formatObj || _formatApi.getLocale().getNumberFormatObj(item.$type);
				item.localeFormat = item.localeFormat || item.$format || item.formatObj.numFormat;
				label = item.formatApi.format(measure[code], item.localeFormat);
				break;
			default:
				label = "" + measure[code];
				break;
		}
		return label;
	},

	_toggleLegendDisplay: function() {
		var legend = this._chart.legend;
		legend && this._displayLegend(!legend.display);
	},

	_displayLegend: function(display) {
		var legend = this._chart.legend;
		if (!legend) return;
		if (display) {
			legend.group.show();
			legend.box.show();
		} else {
			legend.group.hide();
			legend.box.hide();
		}
		this.displayLegend = legend.display = display;
	},
	destroy: function() {
		var self = this;
		Base.prototype.destroy.call(self);

		this._chart && this._chart.destroy();
		this._chart = this._localize = this._meta = this.currentMetaData = null;
	}
});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/chart/ctrlCubeChart',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/controls/chart/ctrlCubeChartBase','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/formatApi','syracuse-tablet/html/js/helpers/locale'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/chart/ctrlCubeChartBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var formatApi = require('syracuse-tablet/html/js/helpers/formatApi');
var locale = require("syracuse-tablet/html/js/helpers/locale");

/**
 * cube chart control class
 */
var _Klass = utils.defineClass(function(controller, article, prototype) {
	var self = this;
	Base.call(self, controller, article, prototype);
	self.itemProto = prototype.getPrototype("$item");
}, Base, {

	buildHtml: function($$parent, controllerDao, buildOptions) {
		var self = this;
		self.createRootElement(["s-m-control", "s-m-chart"], $$parent);
		self.chartSlot = uiUtils.createDomElement('div', ["s-m-chart-slot"], null, null, self.$$elmt);
		self._buildChart();
	},

	_buildChart: function() {
		var self = this;

		// This block assignes some variables so that the implementations
		// in ctrlCubeChartBase which have been migrated from the desktop client
		// do not need to be modified too much!
		self.$prototype = self.prototype.json;
		self.$prototype.$properties = self.$prototype.$item.$properties;
		self._localize = {
			highCharts_showHideLegend: locale.text("highCharts_showHideLegend"),
			highCharts_seriesTitle: locale.text("highCharts_seriesTitle")
		};
		//

		self._initializeMeta();

		self.dataset = self.getControllerDao().getQueryResources();

		var settings = self._settingsFromValue();
		self._createChart(settings);
	},


	_ensureFormatter: function(measure) {
		measure.formatApi = {
			format: function(val, localFormat) {
				return val;
			}
		};
		//		measure.formatObj = measure.formatObj || formatApi.getLocale().getNumberFormatObj(measure.$type);
		//		measure.localeFormat = measure.localeFormat || measure.$format || measure.formatObj.numFormat;
	},

	_localizedText: function(key) {
		return key;
	},

	_getFieldEvalTitle: function() {
		return [];
	},

	onLayoutChange: function() {
		var self = this;
		if (self._chart) {
			var $$cs = $(self.chartSlot);
			self._chart.setSize($$cs.width(), $$cs.height(), false);
		}
	},
	destroy: function() {
		var self = this;
		Base.prototype.destroy.call(self);
		self.dataset = null;
	}
});

exports.Klass = _Klass;
});

define('syracuse-tablet/html/js/controls/ctrlFactoryDeps',['require','exports','module','syracuse-tablet/html/js/controls/field/ctrlAlphanum','syracuse-tablet/html/js/controls/field/ctrlAlphanum','syracuse-tablet/html/js/controls/field/ctrlAlphanum','syracuse-tablet/html/js/controls/field/ctrlProgress','syracuse-tablet/html/js/controls/field/ctrlNumeric','syracuse-tablet/html/js/controls/field/ctrlQuantity','syracuse-tablet/html/js/controls/field/ctrlCheckBox','syracuse-tablet/html/js/controls/field/ctrlCombo','syracuse-tablet/html/js/controls/field/ctrlDate','syracuse-tablet/html/js/controls/array/arrayStd','syracuse-tablet/html/js/controls/array/arrayQuery','syracuse-tablet/html/js/controls/array/arrayLookup','syracuse-tablet/html/js/controls/field/ctrlReference','syracuse-tablet/html/js/controls/layout/layoutRow','syracuse-tablet/html/js/controls/layout/layoutStack','syracuse-tablet/html/js/controls/layout/layoutTab','syracuse-tablet/html/js/controls/layout/layoutHub','syracuse-tablet/html/js/controls/layout/layoutHubGroup','syracuse-tablet/html/js/controls/vignetteBase','syracuse-tablet/html/js/controls/ctrlPageHeader','syracuse-tablet/html/js/controls/ctrlTypeUnknown','syracuse-tablet/html/js/controls/chart/ctrlCubeChart','syracuse-tablet/html/js/controls/ctrlFactory'],function (require, exports, module) {

var Alphanum = require('syracuse-tablet/html/js/controls/field/ctrlAlphanum').Klass;
var PhoneField = require('syracuse-tablet/html/js/controls/field/ctrlAlphanum').PhoneField;
var EmailField = require('syracuse-tablet/html/js/controls/field/ctrlAlphanum').EmailField;
var ProgressField = require('syracuse-tablet/html/js/controls/field/ctrlProgress').Klass;
var Numeric = require('syracuse-tablet/html/js/controls/field/ctrlNumeric').Klass;
var Quantity = require('syracuse-tablet/html/js/controls/field/ctrlQuantity').Klass;
var CheckBox = require('syracuse-tablet/html/js/controls/field/ctrlCheckBox').Klass;
var Combo = require('syracuse-tablet/html/js/controls/field/ctrlCombo').Klass;
var Date = require('syracuse-tablet/html/js/controls/field/ctrlDate').Klass;
var Array = require('syracuse-tablet/html/js/controls/array/arrayStd').Klass;
var ArrayQuery = require('syracuse-tablet/html/js/controls/array/arrayQuery').Klass;
var ArrayLookup = require('syracuse-tablet/html/js/controls/array/arrayLookup').Klass;
var Reference = require('syracuse-tablet/html/js/controls/field/ctrlReference').Klass;
var LayoutRow = require('syracuse-tablet/html/js/controls/layout/layoutRow').Klass;
var LayoutStack = require('syracuse-tablet/html/js/controls/layout/layoutStack').Klass;
var LayoutTab = require('syracuse-tablet/html/js/controls/layout/layoutTab').Klass;
var LayoutHub = require('syracuse-tablet/html/js/controls/layout/layoutHub').Klass;
var LayoutHubGroup = require('syracuse-tablet/html/js/controls/layout/layoutHubGroup').Klass;
var Vignette = require('syracuse-tablet/html/js/controls/vignetteBase').Klass;
var PageHeader = require('syracuse-tablet/html/js/controls/ctrlPageHeader').Klass;
var TypeUnknown = require('syracuse-tablet/html/js/controls/ctrlTypeUnknown').Klass;
var CubeChart = require('syracuse-tablet/html/js/controls/chart/ctrlCubeChart').Klass;

var ctrlFactory = require('syracuse-tablet/html/js/controls/ctrlFactory');

exports.init = function() {
	ctrlFactory.setImpl("Alphanum", Alphanum);
	ctrlFactory.setImpl("PhoneField", PhoneField);
	ctrlFactory.setImpl("EmailField", EmailField);
	ctrlFactory.setImpl("ProgressField", EmailField);
	ctrlFactory.setImpl("Numeric", Numeric);
	ctrlFactory.setImpl("Quantity", Quantity);
	ctrlFactory.setImpl("CheckBox", CheckBox);
	ctrlFactory.setImpl("Combo", Combo);
	ctrlFactory.setImpl("Date", Date);
	ctrlFactory.setImpl("Array", Array);
	ctrlFactory.setImpl("ArrayQuery", ArrayQuery);
	ctrlFactory.setImpl("ArrayLookup", ArrayLookup);
	ctrlFactory.setImpl("Reference", Reference);
	ctrlFactory.setImpl("LayoutRow", LayoutRow);
	ctrlFactory.setImpl("LayoutStack", LayoutStack);
	ctrlFactory.setImpl("LayoutTab", LayoutTab);
	ctrlFactory.setImpl("LayoutHub", LayoutHub);
	ctrlFactory.setImpl("LayoutHubGroup", LayoutHubGroup);
	ctrlFactory.setImpl("Vignette", Vignette);
	ctrlFactory.setImpl("PageHeader", PageHeader);
	ctrlFactory.setImpl("TypeUnknown", TypeUnknown);
	ctrlFactory.setImpl("CubeChart", CubeChart);
};
});

define('syracuse-tablet/html/js/sdata/sdataSort',['require','exports','module'],function (require, exports, module) {

/*
 *
 */

function _sdataSortArray(data, proto, orderBy) {

	var comparators = [];
	var properties = (proto.$properties.$resources && proto.$properties.$resources.$item && proto.$properties.$resources.$item.$properties) || proto.$properties;

	orderBy.forEach(function(exp) {
		var prop = exp.property;
		var sort = (exp.sort === "DESC" ? "DESC" : "ASC");
		var type = (properties[prop] && properties[prop].$type) || "application/x-string";

		if (type === "application/x-decimal") {
			if (sort === "ASC") {
				try {
					comparators.push(function(a, b) {
						var vala = a[prop];
						var valb = b[prop];
						return (+vala) - (+valb);
					});
				} catch (e) {}
				return 0;
			} else {
				try {
					comparators.push(function(a, b) {
						var vala = a[prop];
						var valb = b[prop];
						return (+valb) - (+vala);
					});
				} catch (e) {}
				return 0;
			}
		} else {
			if (sort === "ASC") {
				comparators.push(function(a, b) {
					try {
						var vala = a[prop];
						var valb = b[prop];
						if (vala > valb) {
							return 1;
						} else if (vala < valb) {
							return -1;
						}
					} catch (e) {}
					return 0;
				});
			} else {
				comparators.push(function(a, b) {
					try {
						var vala = a[prop];
						var valb = b[prop];
						if (vala > valb) {
							return -1;
						} else if (vala < valb) {
							return 1;
						}
					} catch (e) {}
					return 0;
				});
			}
		}
	});

	data.sort(function(a, b) {
		var c = 0;
		for (var i = 0; i < comparators.length; i++) {
			c = comparators[i](a, b);
			if (c !== 0) {
				break;
			}
		}
		return c;
	});
}
exports.sdataSortArray = _sdataSortArray;
});

define('syracuse-tablet/html/js/sdata/sdataCache',['require','exports','module','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/storage/storage','syracuse-tablet/html/js/sdata/sdatawhere/parser','syracuse-tablet/html/js/sdata/sdatawhere/whereUtils','syracuse-tablet/html/js/sdata/sdataSort'],function (require, exports, module) {

/*
 *
 */

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("SDataCache");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var storageModule = require('syracuse-tablet/html/js/storage/storage');
var parser = require('syracuse-tablet/html/js/sdata/sdatawhere/parser').Parser;
var whereUtils = require('syracuse-tablet/html/js/sdata/sdatawhere/whereUtils');
var sdataSort = require('syracuse-tablet/html/js/sdata/sdataSort');

// all storage entries created by the case will be prefixed with this to be able to empty the cache w/o removing settings
var _cachePrefix = "$cache_";

function _SDataCache(storage) {
	this.storage = storage;
	this.context = null;
};

/*
 *
 */
var _SDataCacheClass = utils.defineClass(
	_SDataCache,
	null, {
		setContext: function(context) {
			log && log("Changing cache context: " + JSON.stringify(context));
			this.context = context;
		},

		cachePrefix: _cachePrefix,

		/**
		 * Put an instance of an sdata object into the cache
		 *
		 * Parameters:
		 * data
		 * {
		 *   $data: {} - Data to store in cache (mandatory)
		 *   $proto: {} - Prototype of data
		 *   $representation: "user.$details" - Representation of data
		 *   $key: "mawal" - Key of data
		 * }
		 * Note that $proto OR $representation AND $key must be set
		 *
		 * Return:
		 * Resolve:
		 * null
		 *
		 * Reject:
		 * Instance of Error
		 *
		 */
		put: function(data) {
			var deferred = $.Deferred();
			var self = this;
			try {
				if (!data.$data) {
					throw new Error("PUT: No data specified");
				}
				var repr;
				var key;
				if (data.$proto) {
					var $proto = self._getProto(data.$proto);
					repr = self._getRepresentation($proto);
					key = self._getKeyValue(data.$data, $proto);
				} else if (data.$representation && data.$key) {
					repr = data.$representation;
					key = data.$key;
				} else {
					throw new Error("PUT: Neither proto nor representation and key specified");
				}
				self.storage.put({
					$context: self.context,
					$collection: _cachePrefix + repr,
					$endpoint: data.$endpoint,
					$key: key,
					$data: {
						$item: data.$data
					}
				}).then(function(result) {
					deferred.resolve();
				}, function(error) {
					deferred.reject(error);
				});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred;
			}
		},

		/**
		 * Query an array of instances from cache
		 *
		 * Parameters:
		 * data
		 * {
		 *   $proto: {} - Prototype of data
		 *   $representation: "user.$details" - Representation of data
		 *   $where: "user eq 'admin' - Optional where clause
		 *   $orderBy: [{ "property": "user", "sort" : "ASC"}, { "property": "login", "sort" : "desc"}] - Optional array of sort conditions
		 * }
		 * Note that $proto OR $representation must be set
		 *
		 * Return:
		 * Resolve:
		 * Matched instances of queried representation
		 * [
		 *   {},
		 *   {}
		 * ]
		 *
		 * Reject:
		 * Instance of Error
		 *
		 */
		query: function(data) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var repr;
				if (data.$proto) {
					var $proto = self._getProto(data.$proto);
					repr = self._getRepresentation($proto);
				} else if (data.$representation) {
					if (data.$where) {
						throw new Error("QUERY: Where clause parsing requires prototype");
					}
					if (data.$orderBy) {
						throw new Error("QUERY: Order by requires prototype");
					}
					repr = data.$representation;
				} else {
					throw new Error("QUERY: Neither proto nor representation specified");
				}
				self.storage.query({
					$context: self.context,
					$endpoint: data.$endpoint,
					$collection: _cachePrefix + repr
				}).then(function(result) {
					var res = [];
					try {
						if (data.$where) {
							var exp = parser.parse(data.$where);
							result.$data.forEach(function(item, i) {
								if (whereUtils.execWhere(item.$item, exp, $proto)) {
									var d = item.$item;
									var m = result.$metaData[i];
									d.$cache = {
										$lastRead: m.$lastRead,
										$lastUpdated: m.$lastUpdated
									};
									res.push(d);
								}
							});
						} else {
							result.$data.forEach(function(item, i) {
								var d = item.$item;
								var m = result.$metaData[i];
								d.$cache = {
									$lastRead: m.$lastRead,
									$lastUpdated: m.$lastUpdated
								};
								res.push(d);
							});
						}
						if (data.$orderBy) {
							sdataSort.sdataSortArray(res, $proto, data.$orderBy);
						}
						deferred.resolve(res);
					} catch (e) {
						deferred.reject(e);
					}
				}, function(error) {
					deferred.reject(error);
				});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred;
			}
		},

		/**
		 * Read one instance from cache using given key
		 *
		 * Parameters:
		 * data
		 * {
		 *   $key: "abc~def" - Key of object to read
		 *   $proto: {} - Prototype of data
		 *   $representation: "user.$details" - Representation of data
		 * }
		 * Note that $proto OR $representation must be set
		 *
		 * Return:
		 * Resolve:
		 * Instance for given key or null if no match
		 * { ... }
		 *
		 * Reject:
		 * Instance of Error
		 *
		 */
		read: function(data) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var repr;
				if (!data.$key) {
					throw new Error("READ: No key specified");
				}
				if (data.$proto) {
					var $proto = self._getProto(data.$proto);
					repr = self._getRepresentation($proto);
				} else if (data.$representation) {
					repr = data.$representation;
				} else {
					throw new Error("READ: Neither proto nor representation specified");
				}
				self.storage.read({
					$context: self.context,
					$collection: _cachePrefix + repr,
					$endpoint: data.$endpoint,
					$key: data.$key
				}).then(function(result) {
					if (result.$status === storageModule.StatusCodes.OK) {
						var res = result.$data.$item;
						res.$cache = {
							$lastRead: result.$metaData.$lastRead,
							$lastUpdated: result.$metaData.$lastUpdated
						};
						deferred.resolve(res);
					} else {
						deferred.resolve(null);
					}
				}, function(error) {
					deferred.reject(error);
				});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred;
			}
		},

		/**
		 * Delete instance from cache by given key
		 *
		 * Parameters:
		 * data
		 * {
		 *   $key: "abc~def" - Key of object to read
		 *   $proto: {} - Prototype of data
		 *   $representation: "user.$details" - Representation of data
		 * }
		 * Note that $proto OR $representation must be set
		 *
		 * Return:
		 * Resolve:
		 * null
		 *
		 * Reject:
		 * Instance of Error
		 *
		 */
		remove: function(data) {
			var deferred = $.Deferred();
			var self = this;
			try {
				var repr;
				if (!data.$key) {
					throw new Error("REMOVE: No key specified");
				}
				if (data.$proto) {
					var $proto = self._getProto(data.$proto);
					repr = self._getRepresentation($proto);
				} else if (data.$representation) {
					repr = data.$representation;
				} else {
					throw new Error("READ: Neither proto nor representation specified");
				}
				self.storage.remove({
					$context: self.context,
					$collection: _cachePrefix + repr,
					$endpoint: data.$endpoint,
					$key: data.$key
				}).then(function() {
					deferred.resolve();
				}, function(error) {
					deferred.reject(error);
				});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred;
			}
		},

		/**
		 *
		 */
		clearCache: function() {
			var deferred = $.Deferred();
			var self = this;
			var re = new RegExp(self.cachePrefix.replace(/([\$\_]+)/g, "\\$1"));
			try {
				self.storage.clearCollection({
					$context: self.context,
					$collection: re
				})
					.then(function() {
						self.storage.clearCollection({
							$context: globals.getEmptyCacheCtx(),
							$collection: re
						});
					})
					.then(function() {
						deferred.resolve();
					}, function(error) {
						deferred.reject(error);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred;
			}
		},

		_getProto: function(proto) {
			return (proto.$properties.$resources && proto.$properties.$resources.$item) || proto;
		},
		_getRepresentation: function(proto) {
			return proto.$type.split(".").slice(1, 3).join(".").replace("$queryItem", "$query");
		},
		_getKeyValue: function(data, proto) {
			return proto.$key.replace(/\{(.*?)\}/g, function(m, p) {
				return data[p];
			});
		}
	}
);

exports.SDataCache = _SDataCacheClass;
});

define('syracuse-tablet/html/js/sdata/entities/test/example',['require','exports','module'],function (require, exports, module) {

var _data = [];
for (var i = 0; i < 100; i++) {
	_data.push({
		$uuid: i,
		name: "My name is: " + i,
		desc: "My desc is: " + i,
		desc2: "My desc2 is: " + i,
		amount: i * 100,
	});
}

exports.entity = {
	$entityName: "example",
	$value: "{name}",
	$properties: {
		name: {
			$type: "application/x-string",
			$title: "My name"
		},
		desc: {
			$type: "application/x-string",
			$title: "My description"
		},
		desc2: {
			$type: "application/x-string",
			$title: "My description 2"
		},
		amount: {
			$type: "application/x-integer",
			$title: "My amount",
			$isExcluded: false,
			$isHidden: false,
			$isMandatory: false,
			$isReadOnly: false,
			$isDisabled: false
		}
	},
	$relations: {
		values: {
			$type: "exampleChild"
		}
	},
	$articles: {
		$details: {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"$widthMd": "6,6",
				"$items": [{
					"$bind": "name",
					"$isTitleHidden": false
				}, {
					"$bind": "desc",
					"$isTitleHidden": false
				}],
			}, {
				"$layoutType": "row",
				"$widthMd": "6,6",
				"$items": [{
					"$bind": "desc2",
					"$isTitleHidden": false
				}, {
					"$bind": "amount",
					"$isTitleHidden": false
				}]
			}]
		},
		$edit: {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"$widthMd": "6,6",
				"$items": [{
					"$bind": "name",
					"$isTitleHidden": true
				}, {
					"$bind": "desc",
					"$isTitleHidden": true
				}],
			}, {
				"$layoutType": "row",
				"$widthMd": "6,6",
				"$items": [{
					"$bind": "desc2",
					"$isTitleHidden": false
				}, {
					"$bind": "amount",
					"$isTitleHidden": false
				}]
			}]
		}
	},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testDatatypes',['require','exports','module'],function (require, exports, module) {

var _data = [];
var _switch = false;
for (var i = 0; i < 10; i++) {
	_data.push({
		$uuid: i,
		propString: "Simple String=" + i,
		propDate: "2014-03-" + (i + 20),
		propDateTime: "2014-06-" + (i + 10) + "T12:45:" + (i + 44) + ".123Z",
		propTime: "15:45:" + (i + 34),
		propTimeShort: "15:45:" + (i + 34),
		propInt: (i * 1000 + i * 10),
		propDecimal: Math.sqrt(i * 1000 + i * 10),
		propReal: Math.sqrt(i * 1000 + i * 30),
		propBoolean: (_switch = !_switch),
		propChoice: "mr",
		propQuantity: i * 123,
		propStringUnit: "EUR",
		propStringMandatory: "Mandatory",
		propDecimalMandatory: "",
		propStringMinMax: "",
		propStringMinMaxValue: "",
		propStringPattern: "",

	});
}

exports.entity = {
	$entityName: "testDataTypes",
	$properties: {
		propString: {
			$type: "application/x-string",
			$isMandatory: false,
			$title: "My name (max len 25)",
			$maxLength: 25
		},
		propStringMandatory: {
			$type: "application/x-string",
			$isMandatory: true,
			$title: "String Madatory"
		},
		propStringMinMax: {
			$type: "application/x-string",
			$title: "String MinMaxLength(3-5)",
			$minLength: 3,
			$maxLength: 5
		},
		propStringMinMaxValue: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer MinMaxValue(3-50)",
			$minimun: "3",
			$maximun: "50"
		},
		propStringPattern: {
			$type: "application/x-string",
			$title: "Pattern",
			$maxLength: 40
		},
		propDate: {
			$type: "application/x-date",
			$isMandatory: false,
			$title: "Date"
		},

		propDateTime: {
			$type: "application/x-datetime",
			$isMandatory: false,
			$title: "Date+Time"
		},
		propTime: {
			$type: "application/x-time",
			$isMandatory: false,
			$title: "Time long",
			$format: "TT"
		},
		propTimeShort: {
			$type: "application/x-time",
			$isMandatory: false,
			$title: "Time",
		},
		propInt: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer (1-7000 Max)",
			$minimun: "1",
			$maximun: "7000"
		},

		propDecimalMandatory: {
			$type: "application/x-decimal",
			$isMandatory: true,
			$title: "Decimal mandatory(2.4)",
			$scale: 2,
			$precision: 4,
			$format: "0.00"
		},
		propDecimal: {
			$type: "application/x-decimal",
			$isMandatory: false,
			$title: "Decimal(4.7)",
			$scale: 4,
			$precision: 7,
			$format: "0.0000"
		},
		propReal: {
			$type: "application/x-real",
			$isMandatory: false,
			$title: "Real",
		},

		propBoolean: {
			$type: "application/x-boolean",
			$isMandatory: false,
			$title: "Boolean"
		},
		propChoice: {
			$type: "application/x-choice",
			$isMandatory: false,
			$title: "Choice",
			//$format: "$radios",
			$value: {
				$enum: [{
					$title: "Mr.",
					$value: "mr"
				}, {
					$title: "Mrs.",
					$value: "mrs"
				}],
				$type: "application/x-string"
			}
		},
		propQuantity: {
			$title: "Quantity",
			$type: "application/x-quantity",
			$value: {
				$title: "{$value} {$unit}",
				$type: "application/x-decimal",
				$scale: 9,
				$precision: 2,
				$format: "0.00"
			},
			$unit: "propStringUnit"
		},
		propStringUnit: {
			$type: "application/x-string",
			$isMandatory: false,
			$isExcluded: true,
			$title: "Unit for quantity"
		},
		propStringM: {
			$type: "application/x-string",
			$isMandatory: true,
			$title: "My name"
		},
		propDateM: {
			$type: "application/x-date",
			$isMandatory: true,
			$title: "Date (Mandatory)"
		},
		propDateTimeM: {
			$type: "application/x-datetime",
			$isMandatory: true,
			$title: "Date+Time (Mandatory)"
		},
		propTimeM: {
			$type: "application/x-time",
			$isMandatory: true,
			$title: "Time (Mandatory)",
		},
		propIntM: {
			$type: "application/x-integer",
			$isMandatory: true,
			$title: "Integer (Mandatory)",
		},
		propDecimalM: {
			$type: "application/x-decimal",
			$isMandatory: true,
			$title: "Decimal (Mandatory)",
		},
		propRealM: {
			$type: "application/x-real",
			$isMandatory: true,
			$title: "Real (Mandatory)",
		},
		propBooleanM: {
			$type: "application/x-boolean",
			$isMandatory: true,
			$title: "Boolean (Mandatory)"
		}
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			// template when creating a new record
			var i = 15;
			var tpl = {
				$uuid: i,
				propString: "Simple String=" + i,
				propDate: "2014-03-" + i,
				propDateTime: "2014-06-" + i + "T12:45:" + (i + 44) + ".234Z",
				propTime: "15:45:" + (i + 34),
				propInt: (i * 1000 + i * 10),
				propDecimal: Math.sqrt(i * 1000 + i * 10),
				propReal: Math.sqrt(i * 1000 + i * 30),
				propBoolean: (_switch = !_switch)
			};

			deferred.resolve(tpl);
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testFormats',['require','exports','module'],function (require, exports, module) {

var _data = [];
var _switch = false;
for (var i = 0; i < 10; i++) {
	_data.push({
		$uuid: i,
		propDate1: "2014-03-" + (i + 20),
		propDateTime1: "2014-06-" + (i + 10) + " 12:45:" + (i + 44),
		propTime1: "15:45:" + (i + 34),
		propInt1: (i * 1000 + i * 10),
		propDecimal1: Math.sqrt(i * 1000 + i * 10),
		propReal1: Math.sqrt(i * 1000 + i * 30),
		propDate2: "2014-03-" + (i + 20),
		propDateTime2: "2014-06-" + (i + 10) + " 12:45:" + (i + 44),
		propTime2: "15:45:" + (i + 34),
		propInt2: (i * 1000 + i * 10),
		propDecimal2: Math.sqrt(i * 1000 + i * 10),
		propReal2: Math.sqrt(i * 1000 + i * 30)

	});
}

exports.entity = {
	$entityName: "testFormats",
	$properties: {
		propDate1: {
			$type: "application/x-date",
			$title: "Date"
		},
		propDateTime1: {
			$type: "application/x-datetime",
			$title: "Date+Time"
		},
		propTime1: {
			$type: "application/x-time",
			$title: "Time",
		},
		propInt1: {
			$type: "application/x-integer",
			$title: "Integer",
		},
		propDecimal1: {
			$type: "application/x-decimal",
			$title: "Decimal",
		},
		propReal1: {
			$type: "application/x-real",
			$title: "Real",
		},
		propDate2: {
			$type: "application/x-date",
			$title: "Date"
		},
		propDateTime2: {
			$type: "application/x-datetime",
			$title: "Date+Time"
		},
		propTime2: {
			$type: "application/x-time",
			$title: "Time",
		},
		propInt2: {
			$type: "application/x-integer",
			$title: "Integer",
		},
		propDecimal2: {
			$type: "application/x-decimal",
			$title: "Decimal",
		},
		propReal2: {
			$type: "application/x-real",
			$title: "Real",
		},
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({});
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testCharts',['require','exports','module'],function (require, exports, module) {

var _data = [{
	part: "Gear",
	value: 50,
	revenue: 40,
	margin: 10
}, {
	part: "Motor",
	value: 60,
	revenue: 40,
	margin: 20
}, {
	part: "Head drive",
	value: 60,
	revenue: 80,
	margin: -20
}, {
	part: "Handwheel",
	value: 70,
	revenue: 90,
	margin: 10
}, {
	part: "Crank",
	value: 70,
	revenue: 70,
	margin: 0
}, {
	part: "Saddle",
	value: 80,
	revenue: 30,
	margin: 50
}, {
	part: "Base",
	value: 20,
	revenue: 40,
	margin: -20
}, {
	part: "Spindle",
	value: 10,
	revenue: 0,
	margin: 10
}];


exports.entity = {
	$entityName: "testCharts",
	$properties: {
		part: {
			$type: "application/x-string",
			$title: "Item"
		},
		value: {
			$type: "application/x-decimal",
			$title: "Value",
			$format: "0.0000"
		},
		revenue: {
			$type: "application/x-decimal",
			$title: "Revenue",
			$format: "0.0000"
		},
		margin: {
			$type: "application/x-decimal",
			$title: "Margin",
			$format: "0.0000"
		}
	},

	// invoked after protype generation to do adjustments
	$prototype: function(proto) {

		// Add some chart information in $query prototype
		var res = proto.$properties && proto.$properties.$resources;
		if (res) {
			res.$axes = [{
				$title: "Item",
				$hierarchies: [
					["part"]
				]
			}, {
				$hierarchies: [
					["$measures"]
				]
			}];
			res.$cube = {
				$title: "Sales overview",
				$hierarchies: {
					part: {
						$properties: ["part"]
					}
				},
				$measures: {
					value: {},
					revenue: {},
					margin: {}
				}
			};
		}
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testConstraints',['require','exports','module'],function (require, exports, module) {

var _data = [];
var _switch = false;
for (var i = 0; i < 10; i++) {
	_data.push({
		$uuid: i,
		propString: "Test " + i,
		propString2: "Some text " + i,
		propString3: "Fill me " + i,
		propInt: (i * 1000 + i * 10),
		propInt2: (i * 1000 + i * 100),
		propDecimal: Math.sqrt(i * 1000 + i * 10),
		propDecimal2: Math.sqrt(i * 1000 + i * 100),
		propDecimal3: Math.sqrt(i * 1000 + i * 110),
		propDecimal4: Math.sqrt(i * 1000 + i * 120),
		propQuantity: i * 123,
		propStringUnit: "EUR"
	});
}

exports.entity = {
	$entityName: "testConstraints",
	$properties: {
		propString: {
			$title: "Test: $pattern=Test.*\\d$",
			$type: "application/x-string",
			$isMandatory: true,
			$pattern: "Test.*\\d$"
		},
		propString2: {
			$title: "Test: $minLength=5, $maxLength=15",
			$type: "application/x-string",
			$isMandatory: true,
			$minLength: 5,
			$maxLength: 15
		},
		propString3: {
			$title: "Test: $minLength=5, $maxLength=15, $pattern=Fill me.*\\d$",
			$type: "application/x-string",
			$isMandatory: true,
			$pattern: "Fill me.*\\d$",
			$minLength: 5,
			$maxLength: 15
		},
		propInt: {
			$title: "Test: $minimum=100, $maximum=200",
			$type: "application/x-integer",
			$isMandatory: true,
			$minimum: 100,
			$maximum: 200
		},
		propInt2: {
			$title: "Test: $exclusiveMinimum=100, $exclusiveMaximum=200",
			$type: "application/x-integer",
			$isMandatory: true,
			$exclusiveMinimum: 100,
			$exclusiveMaximum: 200
		},
		propDecimal: {
			$title: "Test: $format=0.0000",
			$type: "application/x-decimal",
			$isMandatory: true,
			$format: "0.0000"
		},
		propDecimal2: {
			$title: "Test: $format=0.00",
			$type: "application/x-decimal",
			$isMandatory: true,
			$format: "0.00"
		},
		propDecimal3: {
			$title: "Test: $precision=10",
			$type: "application/x-decimal",
			$isMandatory: true,
			$precision: 10
		},
		propDecimal4: {
			$title: "Test: $scale=3",
			$type: "application/x-decimal",
			$isMandatory: true,
			$scale: 3,
			$format: "0.00000"
		},
		propQuantity: {
			$title: "Test: $format=0.00",
			$isMandatory: true,
			$type: "application/x-quantity",
			$value: {
				$title: "{$value} {$unit}",
				$type: "application/x-decimal",
				$scale: 9,
				$precision: 2,
				$format: "0.00"
			},
			$unit: "propStringUnit"
		},
		propStringUnit: {
			$title: "Unit for quantity",
			$type: "application/x-string",
			$isMandatory: false,
			$isExcluded: true
		},
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			// template when creating a new record
			var i = 15;
			var tpl = {
				$uuid: i,
				propString: "Simple String=" + i,
				propInt: (i * 1000 + i * 10),
				propDecimal: Math.sqrt(i * 1000 + i * 10),
			};
			deferred.resolve(tpl);
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testNavigateTo',['require','exports','module'],function (require, exports, module) {

var _data = [];

for (var i = 0; i < 10; i++) {
	_data.push({
		$uuid: i,
		name: "Customer group " + i,
		group: "" + i
	});

}

exports.entity = {
	$entityName: "testNavigateTo",
	$properties: {
		name: {
			$title: "Customer group name",
			$type: "application/x-string",
		},
		group: {
			$title: "Customer group",
			$type: "application/x-string",
		},
	},
	$prototype: function(proto) {

		// Add some chart information in $query prototype
		var res = proto.$properties && proto.$properties.$resources && proto.$properties.$resources.$item && proto.$properties.$resources.$item.$links || {};

		res["DASHBOARD"] = {
			$title: "Show details",
			$url: "{$baseUrl}/$mobileDashboards?dashboard=testContextDashboardChild&parameters=group%3D%7Bgroup%7D"
		};
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			// template when creating a new record
			var i = 15;
			var tpl = {
				$uuid: i,
				propString: "Simple String=" + i,
				propInt: (i * 1000 + i * 10),
				propDecimal: Math.sqrt(i * 1000 + i * 10),
			};
			deferred.resolve(tpl);
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testNavigateToChild',['require','exports','module'],function (require, exports, module) {

var _data = [];

for (var i = 0; i < 10; i++) {
	for (var j = 0; j < 10; j++) {
		_data.push({
			$uuid: (i * 10) + j,
			name: "Customer " + (i * 10) + j,
			desc: "Belongs to group " + i,
			group: "" + i
		});
	}
}

exports.entity = {
	$entityName: "testNavigateToChild",
	$properties: {
		name: {
			$title: "Customer name",
			$type: "application/x-string",
		},
		desc: {
			$title: "Description",
			$type: "application/x-string",
		},
		group: {
			$title: "Customer group",
			$type: "application/x-string",
		},
	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			// template when creating a new record
			var i = 15;
			var tpl = {
				$uuid: i,
				propString: "Simple String=" + i,
				propInt: (i * 1000 + i * 10),
				propDecimal: Math.sqrt(i * 1000 + i * 10),
			};
			deferred.resolve(tpl);
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShow',['require','exports','module'],function (require, exports, module) {

var _data = [];
var _switch = false;
for (var i = 0; i < 10; i++) {
	_data.push({
		$uuid: i,
		propStringShow: "Simple String=" + i,
		propStringHide: "Simple String=" + i,
		propStringReadOnly: "ReadOnly String=" + i,
		propStringDisabled: "Disabled=true String=" + i,
		propStringDisabledFalse: "Disabled=false String=" + i,

		propDate: "2014-03-" + (i + 20),
		propDateHide: "2014-03-" + (i + 20),
		propDateDisabled: "2014-03-" + (i + 20),
		propDateReadOnly: "2014-03-" + (i + 20),

		propDateTime: "2014-06-" + (i + 10) + "T12:45:" + (i + 44) + ".123Z",
		propDateTimeHide: "2014-06-" + (i + 10) + "T12:45:" + (i + 44) + ".123Z",
		propDateTimeDisabled: "2014-06-" + (i + 10) + "T12:45:" + (i + 44) + ".123Z",

		propTime: "15:45:" + (i + 34),
		propTimeHide: "15:45:" + (i + 34),
		propTimeDisabled: "15:45:" + (i + 34),


		propInt: (i * 1000 + i * 10),
		propIntHide: (i * 1000 + i * 10),
		propIntDisabled: (i * 1000 + i * 10),
		propIntReadOnly: (i * 1000 + i * 10),

		propDecimal: Math.sqrt(i * 1000 + i * 10),
		propDecimalHide: Math.sqrt(i * 1000 + i * 10),
		propDecimalDisabled: Math.sqrt(i * 1000 + i * 10),
		propDecimalReadOnly: Math.sqrt(i * 1000 + i * 10),

		propReal: Math.sqrt(i * 1000 + i * 30),

		propBoolean: (_switch = !_switch),
		propBooleanHidden: (_switch = !_switch),
		propBooleanDisabled: (_switch = !_switch),

		propChoice: "mr",
		propChoiceHidden: "mr",
		propChoiceDisabled: "mr",

		propQuantity: i * 123,
		propStringUnit: "EUR",
		propQuantityExcluded: i * 123,
		propStringUnitExcluded: "USD"

	});
}

exports.entity = {
	$entityName: "testPropertyHideShow",
	$properties: {
		propStringShow: {
			$type: "application/x-string",
			$isMandatory: true,
			$title: "String Mandatory $isHidden: false",
			$isHidden: false
		},
		propStringHide: {
			$type: "application/x-string",
			$isMandatory: false,
			$title: "String $isHidden: true",
			$isHidden: true
		},
		propStringReadOnly: {
			$type: "application/x-string",
			$title: "String $isReadOnly: true",
			$isReadOnly: true
		},
		propStringDisabledFalse: {
			$type: "application/x-string",
			$title: "String $isDisabled: false",
			$isDisabled: false
		},
		propStringDisabled: {
			$type: "application/x-string",
			$title: "String $isDisabled: true",
			$isDisabled: true
		},
		propDate: {
			$type: "application/x-date",
			$isMandatory: false,
			$title: "Date $isHidden: false",
			$isHidden: false
		},
		propDateHide: {
			$type: "application/x-date",
			$isMandatory: false,
			$title: "Date $isHidden: true",
			$isHidden: true
		},
		propDateDisabled: {
			$type: "application/x-date",
			$isMandatory: false,
			$title: "Date $isDisabled: true",
			$isDisabled: true
		},
		propDateReadOnly: {
			$type: "application/x-date",
			$isMandatory: false,
			$title: "Date $isReadOnly: true",
			$isReadOnly: true
		},

		propDateTime: {
			$type: "application/x-datetime",
			$isMandatory: false,
			$title: "Date+Time $isHidden: false",
			$isHidden: false
		},
		propDateTimeHide: {
			$type: "application/x-datetime",
			$isMandatory: false,
			$title: "Date+Time $isHidden: true",
			$isHidden: true
		},
		propDateTimeDisabled: {
			$type: "application/x-datetime",
			$isMandatory: false,
			$title: "Date+Time $isDisabled: true",
			$isDisabled: true
		},

		propTime: {
			$type: "application/x-time",
			$isMandatory: false,
			$title: "Time long",
			$format: "TT"
		},
		propTimeHide: {
			$type: "application/x-time",
			$isMandatory: false,
			$title: "Time $isHidden: true",
			$isHidden: true
		},
		propTimeDisabled: {
			$type: "application/x-time",
			$isMandatory: false,
			$title: "Time $isDisabled: true",
			$isDisabled: true
		},

		propInt: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer ($isHidden: false)",
			$isHidden: false
		},
		propIntHide: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer ($isHidden: true)",
			$isHidden: true
		},
		propIntDisabled: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer ($isDisabled: true)",
			$isDisabled: true
		},
		propIntReadOnly: {
			$type: "application/x-integer",
			$isMandatory: false,
			$title: "Integer ($isReadOnly: true)",
			$isReadOnly: true
		},
		propDecimal: {
			$type: "application/x-decimal",
			$isMandatory: false,
			$title: "Decimal $isHidden: false",
			$isHidden: false
		},
		propDecimalHide: {
			$type: "application/x-decimal",
			$isMandatory: false,
			$title: "Decimal $isHidden: true",
			$isHidden: true
		},
		propDecimalDisabled: {
			$type: "application/x-decimal",
			$isMandatory: false,
			$title: "Decimal $isDisabled: true",
			$isDisabled: true
		},
		propDecimalReadOnly: {
			$type: "application/x-decimal",
			$isMandatory: false,
			$title: "Decimal $isReadOnly: true",
			$isReadOnly: true
		},

		propReal: {
			$type: "application/x-real",
			$isMandatory: false,
			$title: "Real"
		},

		propBoolean: {
			$type: "application/x-boolean",
			$isMandatory: false,
			$title: "Boolean"
		},
		propBooleanHidden: {
			$type: "application/x-boolean",
			$isMandatory: false,
			$title: "Boolean ($isHidden: true)",
			$isHidden: true
		},
		propBooleanDisabled: {
			$type: "application/x-boolean",
			$isMandatory: false,
			$title: "Boolean ($isDisabled: true)",
			$isDisabled: true
		},

		propChoice: {
			$type: "application/x-choice",
			$isMandatory: false,
			$title: "Choice",
			//$format: "$radios",
			$value: {
				$enum: [{
					$title: "Mr.",
					$value: "mr"
				}, {
					$title: "Mrs.",
					$value: "mrs"
				}],
				$type: "application/x-string"
			}
		},
		propChoiceHidden: {
			$type: "application/x-choice",
			$isMandatory: false,
			$title: "Choice($isHidden: true)",
			$isHidden: true,
			//$format: "$radios",
			$value: {
				$enum: [{
					$title: "Mr.",
					$value: "mr"
				}, {
					$title: "Mrs.",
					$value: "mrs"
				}],
				$type: "application/x-string"
			}
		},
		propChoiceDisabled: {
			$type: "application/x-choice",
			$isMandatory: false,
			$title: "Choice ($isDisabled: true)",
			$isDisabled: true,
			//$format: "$radios",
			$value: {
				$enum: [{
					$title: "Mr.",
					$value: "mr"
				}, {
					$title: "Mrs.",
					$value: "mrs"
				}],
				$type: "application/x-string"
			}
		},
		propQuantity: {
			$title: "Quantity ($unit $isExcluded: false)",
			$type: "application/x-quantity",
			$value: {
				$title: "{$value} {$unit}",
				$type: "application/x-decimal",
				$scale: 9,
				$precision: 2,
				$format: "0.00"
			},
			$unit: "propStringUnit"
		},
		propStringUnit: {
			$type: "application/x-string",
			$isMandatory: false,
			$isExcluded: false,
			$title: "Unit for quantity ($isExcluded: false)"
		},
		propQuantityExcluded: {
			$title: "Quantity($unit $isExcluded: true)",
			$type: "application/x-quantity",
			$value: {
				$title: "{$value} {$unit}",
				$type: "application/x-decimal",
				$scale: 9,
				$precision: 2,
				$format: "0.00"
			},
			$unit: "propStringUnitExcluded"
		},
		propStringUnitExcluded: {
			$type: "application/x-string",
			$isMandatory: false,
			$isExcluded: true,
			$title: "Unit for quantity ($isExcluded: true)"
		}

	},
	$relations: {},
	$articles: {},
	$services: {
		$new: function(op, data) {
			var deferred = $.Deferred();
			// template when creating a new record
			var i = 15;
			var tpl = {
				$uuid: i,
				propString: "Simple String=" + i,
				propDate: "2014-03-" + i,
				propDateTime: "2014-06-" + i + "T12:45:" + (i + 44) + ".234Z",
				propTime: "15:45:" + (i + 34),
				propInt: (i * 1000 + i * 10),
				propDecimal: Math.sqrt(i * 1000 + i * 10),
				propReal: Math.sqrt(i * 1000 + i * 30),
				propBoolean: (_switch = !_switch)
			};

			deferred.resolve(tpl);
			return deferred.promise();
		},
		$read: function(op, data) {
			var deferred = $.Deferred();
			// only works because op.$key is equal the array index and equal the $uuid
			deferred.resolve(_data[op.$key]);
			return deferred.promise();
		},
		$query: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve({
				$resources: _data
			});
			return deferred.promise();
		},
		$save: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		},
		$delete: function(op, data) {
			var deferred = $.Deferred();
			deferred.resolve();
			return deferred.promise();
		}
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testHomeDashboard',['require','exports','module'],function (require, exports, module) {
exports.dashboards = {
	"testHomeDashboard": {
		"$dashboardName": "testHomeDashboard",
		"$title": "Main test dashboard",
		"$description": "This dashboard links to different dashboards used for every kind of UI tests",
		"$vignettes": {
			"testLayoutsDashboard": {
				"$uuid": "testLayoutsDashboard",
				"$displayStyle": "$link"
			},
			"testTypesDashboard": {
				"$uuid": "testTypesDashboard",
				"$displayStyle": "$link"
			},
			"testTypesDashboard2": {
				"$uuid": "testTypesDashboard2",
				"$displayStyle": "$link"
			},
			"testFormatsDashboard": {
				"$uuid": "testFormatsDashboard",
				"$displayStyle": "$link"
			},
			"testGX3APPDashboard": {
				"$uuid": "testGX3APPDashboard",
				"$displayStyle": "$link"
			},
			"testSUPERVDashboard": {
				"$uuid": "testSUPERVDashboard",
				"$displayStyle": "$link"
			},
			"testChartsDashboard": {
				"$uuid": "testChartsDashboard",
				"$displayStyle": "$link"
			},
			"testSUPERVDashboard2": {
				"$uuid": "testSUPERVDashboard2",
				"$displayStyle": "$link"
			},
			"testGX3APPDashboard2": {
				"$uuid": "testGX3APPDashboard2",
				"$displayStyle": "$link"
			},
			"testConstraintsDashboard": {
				"$uuid": "testConstraintsDashboard",
				"$displayStyle": "$link"
			},
			"testContextDashboard": {
				"$uuid": "testContextDashboard",
				"$displayStyle": "$link"
			},
			"testPropertyHideShowDashboard": {
				"$uuid": "testPropertyHideShowDashboard",
				"$displayStyle": "$link"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "150px"
				},
				"$widthXs": "1,1,1,1,1,1,1,1",
				"$items": [{
					"$bind": "testLayoutsDashboard"
				}, {
					"$bind": "testTypesDashboard"
				}, {
					"$bind": "testTypesDashboard2"
				}, {
					"$bind": "testFormatsDashboard"
				}, {
					"$bind": "testChartsDashboard"
				}, {
					"$bind": "testConstraintsDashboard"
				}, {
					"$bind": "testContextDashboard"
				}, {
					"$bind": "testPropertyHideShowDashboard"
				}]
			}, {
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "150px"
				},
				"$widthXs": "2,2,2,2",
				"$items": [{
					"$bind": "testGX3APPDashboard"
				}, {
					"$bind": "testSUPERVDashboard"
				}, {
					"$bind": "testSUPERVDashboard2"
				}, {
					"$bind": "testGX3APPDashboard2"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testLayoutsDashboard": {
		"$type": "$dashboard",
		"$title": "Layout tests",
		"$description": "Layout tests",
		"dashboardName": "testLayoutsDashboard"
	},
	"testTypesDashboard": {
		"$type": "$dashboard",
		"$title": "Datatype tests",
		"$description": "Datatype tests",
		"dashboardName": "testTypesDashboard"
	},
	"testTypesDashboard2": {
		"$type": "$dashboard",
		"$title": "Datatype AQTCRUD",
		"$description": "Datatype AQTCRUD",
		"dashboardName": "testTypesDashboard2"
	},
	"testFormatsDashboard": {
		"$type": "$dashboard",
		"$title": "Formats tests",
		"$description": "Formats tests",
		"dashboardName": "testFormatsDashboard"
	},
	"testGX3APPDashboard": {
		"$type": "$dashboard",
		"$title": "GX3APP tests",
		"$description": "GX3APP tests",
		"dashboardName": "testGX3APPDashboard"
	},
	"testSUPERVDashboard": {
		"$type": "$dashboard",
		"$title": "SUPERV tests",
		"$description": "SUPERV tests",
		"dashboardName": "testSUPERVDashboard"
	},
	"testChartsDashboard": {
		"$type": "$dashboard",
		"$title": "Charts tests",
		"$description": "Charts tests",
		"dashboardName": "testChartsDashboard"
	},
	"testSUPERVDashboard2": {
		"$type": "$dashboard",
		"$title": "AQMCRUD default endpoint",
		"$description": "AQMCRUD default endpoint",
		"dashboardName": "testSUPERVDashboard2"
	},
	"testGX3APPDashboard2": {
		"$type": "$dashboard",
		"$title": "GX3APP Cost",
		"$description": "GX3APP Cost",
		"dashboardName": "testGX3APPDashboard2"
	},
	"testConstraintsDashboard": {
		"$type": "$dashboard",
		"$title": "SData constraints",
		"$description": "SData constraints",
		"dashboardName": "testConstraintsDashboard"
	},
	"testContextDashboard": {
		"$type": "$dashboard",
		"$title": "Dashboard with context",
		"$description": "Dashboard with context",
		"dashboardName": "testContextDashboard"
	},
	"testPropertyHideShowDashboard": {
		"$type": "$dashboard",
		"$title": "Dashboard PropertyHideShow",
		"$description": "Dashboard PropertyHideShow",
		"dashboardName": "testPropertyHideShowDashboard"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testLayoutsDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testLayoutsDashboard": {
		"$dashboardName": "testLayoutsDashboard",
		"$title": "Layout test dashboard",
		"$description": "Test different kinds of layouts",
		"$vignettes": {
			"testLayoutHubDashboard": {
				"$uuid": "testLayoutHubDashboard",
				"$displayStyle": "$link"
			},
			"testLayoutRowsDashboard": {
				"$uuid": "testLayoutRowsDashboard",
				"$displayStyle": "$link"
			},
			"testLongQuery": {
				"$uuid": "testLongQuery",
				"$displayStyle": "$link"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "150px"
				},
				"$widthXs": "2,2,2",
				"$items": [{
					"$bind": "testLayoutHubDashboard"
				}, {
					"$bind": "testLayoutRowsDashboard"
				}, {
					"$bind": "testLongQuery"
				}]
			}]
		}
	},
	"testLayoutHubDashboard": {
		"$dashboardName": "testLayoutHubDashboard",
		"$title": "Hub dashboard (scroll horizontal)",
		"$description": "Horizontal scrolling dashboard",
		"$vignettes": {
			"testDummyTile": {
				"$uuid": "testDummyTile",
				"$displayStyle": "$full"
			},
		},
		"$article": {
			"$layoutType": "hub",
			"$items": [{
				"$layoutType": "hubGroup",
				"$title": "Layout group 1",
				"$items": [{
					"$bind": "testDummyTile",
					"$size": "full", // as wide as a column, as high as the screen (rounded/snapped to the next "medium" size tile coordinates)
				}, {
					"$bind": "testDummyTile",
					"$size": "medium", // square, half the width of a column
				}, {
					"$bind": "testDummyTile",
					"$size": "small", // square, quarter size of a column
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "wide", // fill width of a column, and half the height of the width
				}, {
					"$bind": "testDummyTile",
					"$size": "large", // square, width and heigth as big as a column
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Layout group 2",
				"$items": [{
					"$bind": "testDummyTile",
					"$size": "medium",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Layout group 3",
				"$items": [{
					"$bind": "testDummyTile",
					"$size": "wide",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Layout group 4",
				"$items": [{
					"$bind": "testDummyTile",
					"$size": "large",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}, {
					"$bind": "testDummyTile",
					"$size": "medium",
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Layout group 5",
				"$items": [{
					"$bind": "testDummyTile",
					"$size": "wide",
				}, {
					"$bind": "testDummyTile",
					"$size": "full",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}, {
					"$bind": "testDummyTile",
					"$size": "small",
				}]
			}]
		}
	},
	"testLayoutRowsDashboard": {
		"$dashboardName": "testLayoutRowsDashboard",
		"$title": "Row layout dashboard (scroll vertical)",
		"$description": "Vertical scrolling dashboard",
		"$vignettes": {
			"testDummyTile": {
				"$uuid": "testDummyTile",
				"$displayStyle": "$full"
			},
			"testDummyTileLink": {
				"$uuid": "testDummyTile",
				"$displayStyle": "$link"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "100px"
				},
				"$widthLg": "3,3,3,3",
				"$widthSm": "3,3,6,6",
				"$widthXs": "12,12,12,12",
				"$items": [{
					"$bind": "testDummyTileLink"
				}, {
					"$bind": "testDummyTileLink"
				}, {
					"$bind": "testDummyTileLink"
				}, {
					"$bind": "testDummyTileLink"
				}]
			}, {
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "200px"
				},
				"$widthLg": "3,3,3,3",
				"$widthSm": "4,4,4,12",
				"$widthXs": "12,12,12,12",
				"$items": [{
					"$bind": "testDummyTile"
				}, {
					"$bind": "testDummyTile"
				}, {
					"$bind": "testDummyTile"
				}, {
					"$bind": "testDummyTile"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testLayoutHubDashboard": {
		"$type": "$dashboard",
		"$title": "Hub Layout tests",
		"$description": "Hub Layout tests",
		"dashboardName": "testLayoutHubDashboard"
	},
	"testLayoutRowsDashboard": {
		"$type": "$dashboard",
		"$title": "Rows Layout tests",
		"$description": "Rows Layout tests",
		"dashboardName": "testLayoutRowsDashboard"
	},
	"testDummyTile": {
		"$type": "$representation",
		"$title": "Dummy",
		"$description": "Dummy",
		"entity": "example",
		"action": "$details",
		"representation": "example",
		"facet": "$details",
		"keyParameter": "5"
	},
	"testLongQuery": {
		"$type": "$representation",
		"$title": "Long query",
		"$description": "Query",
		"entity": "example",
		"action": "$query",
		"representation": "example",
		"facet": "$query"
	}

};
});

define('syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testTypesDashboard": {
		"$dashboardName": "testTypesDashboard",
		"$title": "Datatypes test dashboard",
		"$description": "Test different kinds of datatypes",
		"$vignettes": {
			"testLinkQueryRecord": {
				"$uuid": "testDisplayQueryRecord",
				"$displayStyle": "$link"
			},
			"testLinkDetailsRecord": {
				"$uuid": "testDisplayDetailsRecord",
				"$displayStyle": "$link"
			},
			"testLinkEditRecord": {
				"$uuid": "testDisplayEditRecord",
				"$displayStyle": "$link"
			},
			"testLinkCreateRecord": {
				"$uuid": "testDisplayCreateRecord",
				"$displayStyle": "$link"
			},
			"testDisplayQueryRecord": {
				"$uuid": "testDisplayQueryRecord",
				"$displayStyle": "$full"
			},
			"testDisplayDetailsRecord": {
				"$uuid": "testDisplayDetailsRecord",
				"$displayStyle": "$full"
			},
			"testDisplayEditRecord": {
				"$uuid": "testDisplayEditRecord",
				"$displayStyle": "$full"
			},
			"testDisplayCreateRecord": {
				"$uuid": "testDisplayCreateRecord",
				"$displayStyle": "$full"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "100px"
				},
				"$widthXs": "3,3,3,3",
				"$items": [{
					"$bind": "testLinkQueryRecord"
				}, {
					"$bind": "testLinkDetailsRecord"
				}, {
					"$bind": "testLinkEditRecord"
				}, {
					"$bind": "testLinkCreateRecord"
				}]
			}, {
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "300px"
				},
				"$widthLg": "3,3,3,3",
				"$widthSm": "6,6,6,6",
				"$widthXs": "12,12,12,12",
				"$items": [{
					"$bind": "testDisplayQueryRecord"
				}, {
					"$bind": "testDisplayDetailsRecord"
				}, {
					"$bind": "testDisplayEditRecord"
				}, {
					"$bind": "testDisplayCreateRecord"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testDisplayDetailsRecord": {
		"$type": "$representation",
		"$title": "Details facet",
		"entity": "testDataTypes",
		"action": "$details",
		"representation": "testDataTypes",
		"facet": "$details",
		"keyParameter": "5"
	},
	"testDisplayEditRecord": {
		"$type": "$representation",
		"$title": "Edit facet",
		"entity": "testDataTypes",
		"action": "$edit",
		"representation": "testDataTypes",
		"facet": "$edit",
		"keyParameter": "5"
	},
	"testDisplayCreateRecord": {
		"$type": "$representation",
		"$title": "Create facet",
		"entity": "testDataTypes",
		"action": "$create",
		"representation": "testDataTypes",
		"facet": "$create",
		"keyParameter": "5"
	},
	"testDisplayQueryRecord": {
		"$type": "$representation",
		"$title": "Query facet",
		"entity": "testDataTypes",
		"action": "$query",
		"representation": "testDataTypes",
		"facet": "$query",
		"keyParameter": "5"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard2',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testTypesDashboard2": {
		"$dashboardName": "testTypesDashboard2",
		"$title": "AQTCRUD default endpoint",
		"$description": "AQTCRUD Representation",
		"$vignettes": {
			"testLinkQueryRecord2": {
				"$uuid": "testDisplayQueryRecord2",
				"$displayStyle": "$link"
			},
			"testLinkDetailsRecord2": {
				"$uuid": "testDisplayDetailsRecord2",
				"$displayStyle": "$link"
			},
			"testLinkEditRecord2": {
				"$uuid": "testDisplayEditRecord2",
				"$displayStyle": "$link"
			},
			"testLinkCreateRecord2": {
				"$uuid": "testDisplayCreateRecord2",
				"$displayStyle": "$link"
			},
			"testDisplayQueryRecord2": {
				"$uuid": "testDisplayQueryRecord2",
				"$displayStyle": "$full"
			},
			"testDisplayDetailsRecord2": {
				"$uuid": "testDisplayDetailsRecord2",
				"$displayStyle": "$full"
			},
			"testDisplayEditRecord2": {
				"$uuid": "testDisplayEditRecord2",
				"$displayStyle": "$full"
			},
			"testDisplayCreateRecord2": {
				"$uuid": "testDisplayCreateRecord2",
				"$displayStyle": "$full"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "100px"
				},
				"$widthXs": "3,3,3,3",
				"$items": [{
					"$bind": "testLinkQueryRecord2"
				}, {
					"$bind": "testLinkDetailsRecord2"
				}, {
					"$bind": "testLinkEditRecord2"
				}, {
					"$bind": "testLinkCreateRecord2"
				}]
			}, {
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "300px"
				},
				"$widthLg": "3,3,3,3",
				"$widthSm": "6,6,6,6",
				"$widthXs": "12,12,12,12",
				"$items": [{
					"$bind": "testDisplayQueryRecord2"
				}, {
					"$bind": "testDisplayDetailsRecord2"
				}, {
					"$bind": "testDisplayEditRecord2"
				}, {
					"$bind": "testDisplayCreateRecord2"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testDisplayDetailsRecord2": {
		"$type": "$representation",
		"$title": "Details facet",
		"entity": "AQTCRUD",
		"action": "$details",
		"representation": "AQTCRUD",
		"facet": "$details",
		"keyParameter": "10"
	},
	"testDisplayEditRecord2": {
		"$type": "$representation",
		"$title": "Edit facet",
		"entity": "AQTCRUD",
		"action": "$edit",
		"representation": "AQTCRUD",
		"facet": "$edit",
		"keyParameter": "10"
	},
	"testDisplayCreateRecord2": {
		"$type": "$representation",
		"$title": "Create facet",
		"entity": "AQTCRUD",
		"action": "$create",
		"representation": "AQTCRUD",
		"facet": "$create"
	},
	"testDisplayQueryRecord2": {
		"$type": "$representation",
		"$title": "Query facet",
		"entity": "AQTCRUD",
		"action": "$query",
		"representation": "AQTCRUD",
		"facet": "$query"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testFormatsDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testFormatsDashboard": {
		"$dashboardName": "testFormatsDashboard",
		"$title": "Formatting test dashboard",
		"$description": "Test different kinds of formats",
		"$vignettes": {
			"testFormatEditRecord": {
				"$uuid": "testFormatEditRecord",
				"$displayStyle": "$full"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "500px"
				},
				"$widthXs": "6",
				"$items": [{
					"$bind": "testFormatEditRecord"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testFormatEditRecord": {
		"$type": "$representation",
		"$title": "Details facet",
		"entity": "testFormats",
		"action": "$edit",
		"representation": "testFormats",
		"facet": "$edit",
		"keyParameter": "5"
	}

};
});

define('syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testGX3APPDashboard": {
		"$dashboardName": "testGX3APPDashboard",
		"$title": "Display data from GX3APP",
		"$description": "Test different representations on GX3APP",
		"$vignettes": {
			"testACTIVQuery": {
				"$uuid": "testACTIVQuery",
				"$displayStyle": "$full"
			},
			"testRequestVEN085": {
				"$uuid": "testRequestVEN085",
				"$displayStyle": "$full"
			}
		},

		"$article": {
			"$layoutType": "hub",
			"$items": [{
				"$layoutType": "hubGroup",
				"$title": "Some data...",
				"$items": [{
					"$bind": "testACTIVQuery",
					"$size": "full",
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Some fancy chart",
				"$items": [{
					"$bind": "testRequestVEN085",
					"$size": "large"
				}]
			}]
		},
	}
};

exports.gadgets = {
	"testACTIVQuery": {
		"$type": "$representation",
		"$title": "Query ACTIV",
		"entity": "ACTIV",
		"action": "$query",
		"representation": "ACTIV",
		"endpoint": "x3.erp.GX3APP",
		"facet": "$query"
	},
	"testRequestVEN085": {
		"$type": "$request",
		"$title": "Request VEN085",
		"requestName": "VEN085",
		"requestLevel": "1",
		"action": "$query",
		"endpoint": "x3.erp.GX3APP",
		"facet": "$query"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testSUPERVDashboard": {
		"$dashboardName": "testSUPERVDashboard",
		"$title": "Display Query AQMCRUDM from SUPERV",
		"$description": "Test different representations on SUPERV",
		"$vignettes": {
			"testAQMDEVICEQuery": {
				"$uuid": "testAQMDEVICEQuery",
				"$displayStyle": "$full"
			},
			"testAQMDEVICEQueryLink": {
				"$uuid": "testAQMDEVICEQuery",
				"$displayStyle": "$link"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "500px"
				},
				"$widthXs": "6,1",
				"$items": [{
					"$bind": "testAQMDEVICEQuery"
				}, {
					"$bind": "testAQMDEVICEQueryLink"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testAQMDEVICEQuery": {
		"$type": "$representation",
		"$title": "Query AQMCRUDM",
		"entity": "AQMDEVICE",
		"action": "$query",
		"representation": "AQMCRUDM",
		"endpoint": "x3.erp.SUPERV",
		"facet": "$query"
	}

};
});

define('syracuse-tablet/html/js/sdata/entities/test/testChartsDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testChartsDashboard": {
		"$dashboardName": "testChartsDashboard",
		"$title": "Display some charts",
		"$description": "Test different kind of charts",
		"$vignettes": {
			"testRequestChart": {
				"$uuid": "testRequestChart",
				"$displayStyle": "$full"
			}
		},

		"$article": {
			"$layoutType": "hub",
			"$items": [{
				"$layoutType": "hubGroup",
				"$title": "Big chart (!)",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "full",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "bar" // default = stick = colum = bar chart
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "bar"
						}]
					}
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Bar charts",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "stick" // default = stick = colum = bar chart
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "bar"
						}]
					}
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Line charts",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "line"
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "area"
						}]
					}
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Spline charts",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "spline"
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "areaspline"
						}]
					}
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Pie chart",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$style": "pie"
						}]
					}
				}]
			}, {
				"$layoutType": "hubGroup",
				"$title": "Test different sizes/legends",
				"$items": [{
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$isLegendHidden": false,
							"$style": "line"
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "large",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$isLegendHidden": true,
							"$style": "line"
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "wide",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$isLegendHidden": true,
							"$isXLabelHidden": true,
							"$isYLabelHidden": true,
							"$isXLabelsHidden": true,
							"$isYLabelsHidden": true,
							"$style": "line"
						}]
					}
				}, {
					"$bind": "testRequestChart",
					"$size": "medium",

					/* if this node is present, the layout of 
					 * the gadget is comming from this layout embedded in the dashbaord */
					"$article": {
						"$layoutType": "stack",
						"$items": [{
							"$bind": "$resources",
							"$isTitleHidden": true,
							"$isLegendHidden": true,
							"$isXLabelHidden": true,
							"$isYLabelHidden": true,
							"$isXLabelsHidden": true,
							"$isYLabelsHidden": true,
							"$style": "bar"
						}]
					}
				}]
			}]
		},
	}
};

exports.gadgets = {
	"testRequestChart": {
		"$type": "$request",
		"$title": "Request test",
		"requestName": "testCharts",
		"requestLevel": "1",
		"action": "$query",
		"facet": "$query"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard2',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testSUPERVDashboard2": {
		"$dashboardName": "testSUPERVDashboard2",
		"$title": "AQMCRUD default endpoint",
		"$description": "Test representation AQMCRUD",
		"$vignettes": {
			"testAQTCRUDQuery": {
				"$uuid": "testAQTCRUDQuery",
				"$displayStyle": "$full"
			},
			"testAQTCRUDQueryLink": {
				"$uuid": "testAQTCRUDQuery",
				"$displayStyle": "$link"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "500px"
				},
				"$widthXs": "6,1",
				"$items": [{
					"$bind": "testAQTCRUDQuery"
				}, {
					"$bind": "testAQTCRUDQueryLink"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testAQTCRUDQuery": {
		"$type": "$representation",
		"$title": "Query AQMCRUD",
		"entity": "AQMCRUD",
		"action": "$query",
		"representation": "AQMCRUD",
		"facet": "$query"
	},
	"testAQTCRUDQueryLink": {
		"$type": "$representation",
		"$title": "Query 10 AQMCRUD",
		"requestName": "10",
		"requestLevel": "1",
		"action": "$query",
		"facet": "$query"
	}

};
});

define('syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard2',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testGX3APPDashboard2": {
		"$dashboardName": "testGX3APPDashboard2",
		"$title": "Display data from GX3APP",
		"$description": "Test PRPCOSTCTR representation on GX3APP",
		"$vignettes": {
			"testPRPCOSTCTRQuery": {
				"$uuid": "testPRPCOSTCTRQuery",
				"$displayStyle": "$full"
			}
		},

		"$article": {
			"$layoutType": "hub",
			"$items": [{
				"$layoutType": "hubGroup",
				"$title": "Some data Spending cost...",
				"$items": [{
					"$bind": "testPRPCOSTCTRQuery",
					"$size": "full",
				}]

			}]
		},
	}
};
exports.gadgets = {
	"testPRPCOSTCTRQuery": {
		"$type": "$representation",
		"$title": "Query PRPCOSTCTR",
		"entity": "PRPCOSTCTR",
		"action": "$query",
		"representation": "PRPCOSTCTR",
		"endpoint": "x3.erp.GX3APP",
		"facet": "$query"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testConstraintsDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testConstraintsDashboard": {
		"$dashboardName": "testConstraintsDashboard",
		"$title": "Constraints test dashboard",
		"$description": "Test SData constraints: https://github.com/Sage-ERP-X3/platform/wiki/Resource-Prototypes#type-constraints",
		"$vignettes": {
			"testConstraintsEditRecord": {
				"$uuid": "testConstraintsEditRecord",
				"$displayStyle": "$full"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "500px"
				},
				"$widthXs": "12",
				"$items": [{
					"$bind": "testConstraintsEditRecord"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testConstraintsEditRecord": {
		"$type": "$representation",
		"$title": "Edit facet",
		"entity": "testConstraints",
		"action": "$edit",
		"representation": "testConstraints",
		"facet": "$edit",
		"keyParameter": "5"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testNavigateToDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testContextDashboard": {
		"$dashboardName": "testContextDashboard",
		"$title": "Test dashboard parameters",
		"$description": "Test navigation to a dashboard with parameters",
		"$vignettes": {
			"testRecordLinkToDashboard": {
				"$uuid": "testRecordLinkToDashboard",
				"$displayStyle": "$full"
			},
			"testRecordLinkToDashboardSUPERV": {
				"$uuid": "testRecordLinkToDashboardSUPERV",
				"$displayStyle": "$full"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "300px"
				},
				"$widthXs": "6, 6",
				"$items": [{
					"$bind": "testRecordLinkToDashboard"
				}, {
					"$bind": "testRecordLinkToDashboardSUPERV"
				}]
			}]
		}
	},
	"testContextDashboardChild": {
		"$dashboardName": "testContextDashboardChild",
		"$title": "Child dashboard",
		"$description": "Child dashboard getting parameters that are applied to the first to vignettes but not to the last one using the same representation to gather data",
		"$vignettes": {
			"testRecordWithContext1": {
				"$uuid": "testRecordWithContext",
				"$displayStyle": "$full"
			},
			"testRecordWithContext2": {
				"$uuid": "testRecordWithContext",
				"$displayStyle": "$full"
			},
			"testRecordWithoutContext": {
				"$uuid": "testRecordWithoutContext",
				"$displayStyle": "$full"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "500px"
				},
				"$widthXs": "4,4,4",
				"$items": [{
					"$bind": "testRecordWithContext1"
				}, {
					"$bind": "testRecordWithContext2"
				}, {
					"$bind": "testRecordWithoutContext"
				}]
			}]
		}
	},
	"testContextDashboardChildSUPERV": {
		"$dashboardName": "testContextDashboardChildSUPERV",
		"$title": "Child dashboard",
		"$description": "Child dashboard getting parameters",
		"$vignettes": {
			"testRecordWithContextSUPERV": {
				"$uuid": "testRecordWithContextSUPERV",
				"$displayStyle": "$full"
			},
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "300px"
				},
				"$widthXs": "12",
				"$items": [{
					"$bind": "testRecordWithContextSUPERV"
				}]
			}]
		}
	}

};

exports.gadgets = {
	"testRecordLinkToDashboard": {
		"$type": "$representation",
		"$title": "Click to navigate",
		"entity": "testNavigateTo",
		"action": "$query",
		"representation": "testNavigateTo",
		"facet": "$query"
	},
	"testRecordWithContext": {
		"$type": "$representation",
		"$title": "Click to navigate",
		"entity": "testNavigateToChild",
		"action": "$query",
		"representation": "testNavigateToChild",
		"facet": "$query",
		"parameters": {
			"where": {
				"value": "group eq '{group}'"
			}
		}
	},
	"testRecordWithoutContext": {
		"$type": "$representation",
		"$title": "Click to navigate",
		"entity": "testNavigateToChild",
		"action": "$query",
		"representation": "testNavigateToChild",
		"facet": "$query"
	},
	"testRecordLinkToDashboardSUPERV": {
		"$type": "$representation",
		"$title": "Click to navigate",
		"entity": "AQMDEVICEM",
		"action": "$query",
		"representation": "AQMDEVICEM",
		"facet": "$query",
		"endpoint": "x3.erp.SUPERV"
	},
	"testRecordWithContextSUPERV": {
		"$type": "$representation",
		"$title": "Click to navigate",
		"entity": "AQMDEVICEM",
		"action": "$query",
		"representation": "AQMDEVICEM",
		"facet": "$query",
		"endpoint": "x3.erp.SUPERV",
		"parameters": {
			"where": {
				"value": "CODE eq {CODE}"
			}
		}
	},
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShowDashboard',['require','exports','module'],function (require, exports, module) {

exports.dashboards = {
	"testPropertyHideShowDashboard": {
		"$dashboardName": "testPropertyHideShowDashboard",
		"$title": "PropertyHideShow test dashboard",
		"$description": "Test different kinds of PropertyHideShow",
		"$vignettes": {
			"testLinkQueryRecordHS": {
				"$uuid": "testDisplayQueryRecordHS",
				"$displayStyle": "$link"
			},
			"testLinkDetailsRecordHS": {
				"$uuid": "testDisplayDetailsRecordHS",
				"$displayStyle": "$link"
			},
			"testLinkEditRecordHS": {
				"$uuid": "testDisplayEditRecordHS",
				"$displayStyle": "$link"
			},
			"testLinkCreateRecordHS": {
				"$uuid": "testDisplayCreateRecordHS",
				"$displayStyle": "$link"
			},
			"testDisplayQueryRecordHS": {
				"$uuid": "testDisplayQueryRecordHS",
				"$displayStyle": "$full"
			},
			"testDisplayDetailsRecordHS": {
				"$uuid": "testDisplayDetailsRecordHS",
				"$displayStyle": "$full"
			},
			"testDisplayEditRecordHS": {
				"$uuid": "testDisplayEditRecordHS",
				"$displayStyle": "$full"
			},
			"testDisplayCreateRecordHS": {
				"$uuid": "testDisplayCreateRecordHS",
				"$displayStyle": "$full"
			}
		},
		"$article": {
			"$layoutType": "stack",
			"$items": [{
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "100px"
				},
				"$widthXs": "3,3,3,3",
				"$items": [{
					"$bind": "testLinkQueryRecordHS"
				}, {
					"$bind": "testLinkDetailsRecordHS"
				}, {
					"$bind": "testLinkEditRecordHS"
				}, {
					"$bind": "testLinkCreateRecordHS"
				}]
			}, {
				"$layoutType": "row",
				"displayOptions": {
					"rowHeight": "300px"
				},
				"$widthLg": "3,3,3,3",
				"$widthSm": "6,6,6,6",
				"$widthXs": "12,12,12,12",
				"$items": [{
					"$bind": "testDisplayQueryRecordHS"
				}, {
					"$bind": "testDisplayDetailsRecordHS"
				}, {
					"$bind": "testDisplayEditRecordHS"
				}, {
					"$bind": "testDisplayCreateRecordHS"
				}]
			}]
		}
	}
};

exports.gadgets = {
	"testDisplayDetailsRecordHS": {
		"$type": "$representation",
		"$title": "Details facet",
		"entity": "testPropertyHideShow",
		"action": "$details",
		"representation": "testPropertyHideShow",
		"facet": "$details",
		"keyParameter": "5"
	},
	"testDisplayEditRecordHS": {
		"$type": "$representation",
		"$title": "Edit facet",
		"entity": "testPropertyHideShow",
		"action": "$edit",
		"representation": "testPropertyHideShow",
		"facet": "$edit",
		"keyParameter": "5"
	},
	"testDisplayCreateRecordHS": {
		"$type": "$representation",
		"$title": "Create facet",
		"entity": "testPropertyHideShow",
		"action": "$create",
		"representation": "testPropertyHideShow",
		"facet": "$create",
		"keyParameter": "5"
	},
	"testDisplayQueryRecordHS": {
		"$type": "$representation",
		"$title": "Query facet",
		"entity": "testPropertyHideShow",
		"action": "$query",
		"representation": "testPropertyHideShow",
		"facet": "$query",
		"keyParameter": "5"
	}
};
});

define('syracuse-tablet/html/js/sdata/entities/test/testApplication',['require','exports','module','syracuse-tablet/html/js/sdata/entities/clientContract','syracuse-tablet/html/js/sdata/entities/test/example','syracuse-tablet/html/js/sdata/entities/test/testDatatypes','syracuse-tablet/html/js/sdata/entities/test/testFormats','syracuse-tablet/html/js/sdata/entities/test/testCharts','syracuse-tablet/html/js/sdata/entities/test/testConstraints','syracuse-tablet/html/js/sdata/entities/test/testNavigateTo','syracuse-tablet/html/js/sdata/entities/test/testNavigateToChild','syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShow','syracuse-tablet/html/js/sdata/entities/test/testHomeDashboard','syracuse-tablet/html/js/sdata/entities/test/testLayoutsDashboard','syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard','syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard2','syracuse-tablet/html/js/sdata/entities/test/testFormatsDashboard','syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard','syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard','syracuse-tablet/html/js/sdata/entities/test/testChartsDashboard','syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard2','syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard2','syracuse-tablet/html/js/sdata/entities/test/testConstraintsDashboard','syracuse-tablet/html/js/sdata/entities/test/testNavigateToDashboard','syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShowDashboard'],function (require, exports, module) {

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');

var _example = require('syracuse-tablet/html/js/sdata/entities/test/example');
var _testDatatypes = require('syracuse-tablet/html/js/sdata/entities/test/testDatatypes');
var _testFormats = require('syracuse-tablet/html/js/sdata/entities/test/testFormats');
var _testCharts = require('syracuse-tablet/html/js/sdata/entities/test/testCharts');
var _testConstraints = require('syracuse-tablet/html/js/sdata/entities/test/testConstraints');
var _testNavigateTo = require('syracuse-tablet/html/js/sdata/entities/test/testNavigateTo');
var _testNavigateToChild = require('syracuse-tablet/html/js/sdata/entities/test/testNavigateToChild');
var _testPropertyHideShow = require('syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShow');

var _testHomeDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testHomeDashboard');
var _testLayoutsDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testLayoutsDashboard');
var _testTypesDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard');
var _testTypesDashboard2 = require('syracuse-tablet/html/js/sdata/entities/test/testTypesDashboard2');
var _testFormatsDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testFormatsDashboard');
var _testGX3APPDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard');
var _testSUPERVDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard');
var _testChartsDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testChartsDashboard');
var _testSUPERVDashboard2 = require('syracuse-tablet/html/js/sdata/entities/test/testSUPERVDashboard2');
var _testGX3APPDashboard2 = require('syracuse-tablet/html/js/sdata/entities/test/testGX3APPDashboard2');
var _testConstraintsDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testConstraintsDashboard');
var _testNavigateToDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testNavigateToDashboard');
var _testPropertyHideShowDashboard = require('syracuse-tablet/html/js/sdata/entities/test/testPropertyHideShowDashboard');

var _testApplication = {
	"$application": {
		"$uuid": "clientTestApplication",

		"applicationName": "clientTestApplication",
		"title": "Client test application",
		"description": "Application for testing client features without server dependencies",

		"$homeDashboard": {
			"$uuid": "testHomeDashboard",
			"dashboardName": "testHomeDashboard"
		},
	},
	"$dashboards": {},
	"$gadgets": {}
};

function _addToApp(app) {
	if (app.gadgets) {
		Object.keys(app.gadgets).forEach(function(key) {
			if (_testApplication.$gadgets[key]) {
				console.log("Duplicate gadget name: " + key);
			}
			_testApplication.$gadgets[key] = app.gadgets[key];
		});
	}
	if (app.dashboards) {
		Object.keys(app.dashboards).forEach(function(key) {
			if (_testApplication.$dashboards[key]) {
				console.log("Duplicate dashboard name: " + key);
			}
			_testApplication.$dashboards[key] = app.dashboards[key];
		});
	}
}

exports.register = function() {
	clientContract.registerEntity(_example.entity);

	clientContract.registerEntity(_testDatatypes.entity);
	clientContract.registerEntity(_testFormats.entity);
	clientContract.registerEntity(_testCharts.entity);
	clientContract.registerEntity(_testConstraints.entity);
	clientContract.registerEntity(_testNavigateTo.entity);
	clientContract.registerEntity(_testNavigateToChild.entity);
	clientContract.registerEntity(_testPropertyHideShow.entity);

	_addToApp(_testHomeDashboard);
	_addToApp(_testLayoutsDashboard);
	_addToApp(_testTypesDashboard);
	_addToApp(_testTypesDashboard2);
	_addToApp(_testFormatsDashboard);
	_addToApp(_testGX3APPDashboard);
	_addToApp(_testSUPERVDashboard);
	_addToApp(_testChartsDashboard);
	_addToApp(_testSUPERVDashboard2);
	_addToApp(_testGX3APPDashboard2);
	_addToApp(_testConstraintsDashboard);
	_addToApp(_testNavigateToDashboard);
	_addToApp(_testPropertyHideShowDashboard);

	clientContract.registerApp(_testApplication);
};
});

define('syracuse-tablet/html/js/init/initModules',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/application/appFactory','syracuse-tablet/html/js/application/appFactoryDeps','syracuse-tablet/html/js/controls/ctrlFactoryDeps','syracuse-tablet/html/js/ajax/ajax','syracuse-tablet/html/js/storage/storage','syracuse-tablet/html/js/sdata/sdataCache','syracuse-tablet/html/js/helpers/templating','syracuse-tablet/html/js/sdata/entities/test/testApplication'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");
var globals = require('syracuse-tablet/html/js/helpers/globals');


var factory = require('syracuse-tablet/html/js/application/appFactory');
var appFactoryDeps = require('syracuse-tablet/html/js/application/appFactoryDeps');
var ctrlFactoryDeps = require('syracuse-tablet/html/js/controls/ctrlFactoryDeps');

var ajax = require('syracuse-tablet/html/js/ajax/ajax');
var storage = require('syracuse-tablet/html/js/storage/storage');
var sdataCache = require('syracuse-tablet/html/js/sdata/sdataCache');
var templates = require('syracuse-tablet/html/js/helpers/templating');

//fully client side configured application to add tests later
var testApplication = require('syracuse-tablet/html/js/sdata/entities/test/testApplication');

exports.init = function() {
	var st;
	var cache;
	var deferred = new $.Deferred();

	st = storage.getStorage();
	st.init()
		.then(function() {
			cache = new sdataCache.SDataCache(st);
		})
		.then(function() {
			globals.init(true, st, cache, utils);
			var newRoot = "/html";
			templates.setTmplRoot(newRoot);
		})
		.then(function() {
			return appFactoryDeps.init();
		})
		.then(function() {
			return ctrlFactoryDeps.init();
		})
		.then(function() {
			return templates.init();
		})
		.then(function() {
			ajax.init();
		})
		.then(function() {
			if (globals.isDvlpMode()) {
				testApplication.register();
			}
		})
		.then(function() {
			var app = factory.createApplication($("#s-m-app-id"));
			globals.setApplication(app);
		})
		.then(function() {
			deferred.resolve();
		}, function(e) {
			deferred.reject(e);
		});

	return deferred.promise();
};
});

define('syracuse-tablet/html/js/init/initLogin',['require','exports','module','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/locale','syracuse-tablet/html/js/application/authentication','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/logger','syracuse-tablet/html/js/helpers/notifications','syracuse-tablet/html/js/sdata/sdataCommonResources','syracuse-tablet/html/js/init/initContext'],function (require, exports, module) {

var utils = require('syracuse-tablet/html/js/helpers/utils');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var auth = require('syracuse-tablet/html/js/application/authentication');

var modal = require('syracuse-tablet/html/js/ui/modal');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var sdataCommonRes = require('syracuse-tablet/html/js/sdata/sdataCommonResources');

var initContext = require('syracuse-tablet/html/js/init/initContext');

var _gotoLogin = function(reason) {
	var app = globals.getApplication();
	if (app) {
		app.changePage("login", {
			reason: reason
		});
	}
};

var _loginHandler = {
	notifLogin: function(userProfile) {
		var userCtx = {
			"$user": userProfile.user.$value,
			"$role": userProfile.selectedRole.code,
			"$lang": userProfile.selectedLocale.code
		};

		globals.setUserCtx(userCtx);
		locale.setUserLocales(userProfile && userProfile.user && userProfile.user.locales);

		initContext.init(false, false)
			.then(function(context) {});
	}
};


exports.init = function() {
	notifications.subscribe(_loginHandler, ["sm.login"], 1);

	try {
		uiutils.waitWheelStart();
		return auth.check()
			.then(function(status) {
				if (status.authenticated === true) {
					return sdataCommonRes.getUserProfile();
				} else {
					return null;
				}
			})
			.then(function(profile) {
				uiutils.waitWheelStop();
				if (profile) {
					notifications.publish("sm.login", profile);
				} else {
					_gotoLogin("Please enter your credentials");
				}
				return $.smResolve();
			}, function(e) {
				uiutils.waitWheelStop();
				auth.logout().then(function() {
					_gotoLogin("Please try login again");
				});
			});
	} catch (e) {
		_gotoLogin("Javascript exception");
		return $.smResolve();
	}
};
});

define('syracuse-tablet/html/js/main',['require','exports','module','syracuse-tablet/html/js/ui/modal','syracuse-tablet/html/js/ui/uiUtils','syracuse-tablet/html/js/helpers/globals','syracuse-tablet/html/js/helpers/utils','syracuse-tablet/html/js/init/initStyles','syracuse-tablet/html/js/init/initLocale','syracuse-tablet/html/js/init/initModules','syracuse-tablet/html/js/init/initLogin'],function (require, exports, module) {

//Initialization Sage Mobile jQuery plugins and native prototype object  (add method)
var modal = require('syracuse-tablet/html/js/ui/modal');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');

var initStyles = require('syracuse-tablet/html/js/init/initStyles');
var initLocale = require('syracuse-tablet/html/js/init/initLocale');
var initModules = require('syracuse-tablet/html/js/init/initModules');
var initLogin = require('syracuse-tablet/html/js/init/initLogin');

window.onerror = function(errorMsg, url, lineNumber, error) {
	if (globals.application) {
		globals.application.waitWheelStop();
	} else {
		uiutils.waitWheelStop();
	}
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + utils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

function _startup() {
	return initStyles.init()
		.then(function() {
			return initLocale.init();
		})
		.then(function() {
			return initModules.init();
		})
		.then(function() {
			return initLogin.init();
		}, function(e) {
			try {
				modal.error("_startup error", e);
			} catch (ex) {
				utils.alertError(e);
			}
		});
}

$(document).ready(function() {
	if (document.location.href.indexOf("?circular") > -1) {
		xrayquire.showCycles(undefined, true);
	} else {
		_startup();
	}
});
});

