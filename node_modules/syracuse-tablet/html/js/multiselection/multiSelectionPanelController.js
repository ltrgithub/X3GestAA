"use strict";

var Base = require("syracuse-tablet/html/js/controllers/controller").Controller;
var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');

/**
 * Attached to multi-selection header/footer
 * Handles actions of drop-down list (selectAll...)
 */
exports.MultiSelectionPanelController = utils.defineClass(
	function MultiSelectionPanelController(panel) {
		Base.call(this);
		this._panel = panel;
	},
	Base, {

		destroy: function() {
			Base.prototype.destroy.call(this);
			this._panel = null;
		},
		/**
		 * Invoked when user click on multiSelection action
		 */
		multiSelToggleStatus: function(enabled) {
			this._nbSelected = 0;
			if (enabled !== true) {
				this._actMultiSelActions("$showunselected")
				this._actMultiSelActions("$unselectall")
			}
			this._multiSelUpdateStatus();
		},
		/**
		 * Invoked when user select a card/row
		 */
		multiSelToggleRecord: function(enabled) {
			if (this._multiSelAction("$showunselected").css("display") !== "none") {
				// Disables hideUnselected
				this._actMultiSelActions("$showunselected");
			}
			this._nbSelected = Math.max(0, this._nbSelected + (enabled === true ? 1 : -1));
			this._multiSelUpdateStatus();
			return true;
		},
		/**
		 * Start actions processing
		 */
		multiSelStartProcessing: function() {
			this._multiSelToggleUnselected(false);
			this._multiSelRunToggleStop(true);
			this._panel.multiSelUpdateCounter(0, 0);
		},

		_multiSelRunToggleStop: function(show) {
			this._panel.showAction("multiSelTriggerAction", show, "stop");
			this._panel.showAction("multiSelTriggerAction", !show, "exit");
		},
		/**
		 * Stop actions processing
		 */
		multiSelRunStop: function() {
			this._multiSelRunToggleStop(false);
		},
		/**
		 * Exit actions processing
		 */
		multiSelRunExit: function() {
			// Remove success/error status
			this._multiSelSelected().removeClass("error success");
			this._panel.multiSelUpdateCounter(0, 0);
		},
		/**
		 * Update the status of the actions
		 */
		_multiSelUpdateStatus: function() {
			this._panel.$$elmt.find('a.s-m-link:not([data-menuitem-id="multiSelToggle"])').toggleClass("disabled", this._nbSelected == 0);
			var $$menuActions = this._panel.$$elmt.find("#multiSelMenuActions");
			$$menuActions.find(".badge").text(this._nbSelected);
			$$menuActions.find(".title").text(locale.text(this._nbSelected > 1 ? "multiselect.selected.plural" : "multiselect.selected"));
			var nbRecords = this._panel.page.getQueryArray().getNbRows();
			this._multiSelAction("$hideunselected").toggle(this._nbSelected != 0 && this._nbSelected != nbRecords);
			this._multiSelAction("$selectall").toggle(this._nbSelected != nbRecords);
			this._multiSelAction("$unselectall", "$invert").toggle(this._nbSelected > 0);
			this._multiSelAction("$download").toggle(this._panel.page.isDownloadEnabled() && this._nbSelected > 0);
		},
		/**
		 * Returns unselected records
		 */
		_multiSelUnselected: function() {
			return this._panel.page.$$contentElmt.find(".s-m-array.s-m-control > .s-m-value .s-m-record:not(.s-m-multi-selected)");
		},
		/**
		 * Returns selected records
		 */
		_multiSelSelected: function() {
			return this._panel.page.$$contentElmt.find(".s-m-array.s-m-control > .s-m-value .s-m-record.s-m-multi-selected");
		},
		/**
		 * Returns all the records
		 */
		_multiSelAll: function() {
			return this._panel.page.$$contentElmt.find(".s-m-array.s-m-control > .s-m-value .s-m-record");
		},
		/**
		 * argument is the list of actions id
		 * Returns the array of $elements
		 */
		_multiSelAction: function() {
			var res = $();
			var args = arguments;
			this._panel.$$elmt.find('#multiSelMenuActions a[data-params]').each(function(id) {
				var param = $(this).attr("data-params")
				if (Array.prototype.indexOf.apply(args, [param]) >= 0) {
					res.push(this)
				}
			})
			return res;
		},
		/**
		 * Toggle the status of all unselected elements
		 */
		_multiSelToggleUnselected: function(show) {
			this._multiSelUnselected().toggle(show);
			var array = this._panel.page.getQueryArray();
			if (array.$display === "card") {
				// Hide empty rows to remove the height of empty tr elements
				this._panel.page.$$contentElmt.find(".s-m-array.s-m-card tr").each(function() {
					var e = $(this);
					e.toggle(show ? show : e.find("td").length != e.find("td.s-m-record:not(:visible)").length);
				});
				// To improve - Update scroller after having hidden the empty rows/cards
				array.notifyScrollerUpdate();
			}
		},
		/**
		 * Toggle the status 'select' of the elements given by elmtList
		 */
		_multiSelToggleListStatus: function(elmtList, select) {
			var selected = elmtList.toggleClass("s-m-multi-selected", select);
			if (!selected.is(".s-m-multi-selected")) {
				selected = []
			}
			this._nbSelected = this._multiSelSelected().length;
			this._multiSelUpdateStatus();
		},
		/**
		 * Process multi-selection action (drop down list menu)
		 */
		_actMultiSelActions: function(params) {
			if (params == "$unselectall") {
				this._multiSelToggleUnselected(true);
				this._multiSelToggleListStatus(this._multiSelSelected(), false);
				return;
			}
			if (params == "$selectall") {
				this._multiSelToggleUnselected(true);
				this._multiSelToggleListStatus(this._multiSelUnselected(), true);
				return;
			}
			if (params == "$invert") {
				var unselected = this._multiSelUnselected();
				var selected = this._multiSelSelected();
				this._multiSelToggleListStatus(unselected, true);
				this._multiSelToggleListStatus(selected, false);
				return;
			}
			if (params === "$hideunselected" || params === "$showunselected") {
				var hideUnselected = params === "$hideunselected";
				this._multiSelToggleUnselected(!hideUnselected);
				this._multiSelAction("$hideunselected", "$selectall", "$unselectall", "$invert").toggle(!hideUnselected);
				this._multiSelAction("$showunselected").toggle(hideUnselected);
				return;
			}
		}
	});