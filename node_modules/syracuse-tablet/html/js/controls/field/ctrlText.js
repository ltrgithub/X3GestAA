"use strict";
var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var escaper = require('syracuse-tablet/html/js/helpers/html-escape/index').escaper({
	warn: console.warn.bind(console),
	allowedAttributes: ["style"],
	allowedTags: ["span"]
});
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;
var rtf = require('syracuse-tablet/html/js/helpers/syracuse-rtf/index');

var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');

var _baseHeight = 34; // based on input height within the app

var _templates = {
	expander: '\
		<button type="button" class="btn" data-action="toggleText" data-control-id="{{ctrlId}}>{{label}}</button>'
};

/**
 * Text field
 * authoring:
 * 		$height	set the height of the image - default is _defHeight
 */
var _Klass = utils.defineClass(

	function CtrlText(controller, article, prototype, options) {
		var self = this;

		// set label position default top
		// TODO build a function to apply default authoring parameters ...
		if (article && !article.$labelPosition) {
			article.$labelPosition = "top";
		}

		Base.call(self, controller, article, prototype, options);
		self.cssType = "s-m-clob";
	}, Base, {
		_getHeightPixelValue: function(authH) {
			switch (authH) {
				case "medium":
					return 2 * _baseHeight;
				case "large":
					return 4 * _baseHeight;
				case "xlarge":
					return 8 * _baseHeight;
				default:
					return _baseHeight;
			}
		},
		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			self.$$elmt.css("display", "");
			var value = self.getFormattedValue(self.getValue());

			// Create the enriched text content under the standard s-m-value parent
			var parent = Base.prototype.buildFieldValue.call(self, parentSlot, buildOptions);

			// enriched text container div
			var $$container = $('<section><div class="s-m-enriched-text"></div></section>').appendTo(parent).children(":first-child");

			// dom element which will contain the text
			var $$textContent = $(uiUtils.createDomElement("div", ["s-m-enriched-text-content"], null, null, $$container));

			/**
			 * !!! It's mandatory to have a fixed height for $$container because we need it to calculate the height of the page
			 * If no height is specified it will be set after the data has been loaded (too late)
			 */
			self.authH = self.getAuthoring("$textHeight", "medium");
			self.authH = self._getHeightPixelValue(self.authH);

			// If a new record is created there is hardly a linked text clob that can be shown, so we jump out here
			if (this.controller.$facet === "create") {
				$$textContent.html("&nbsp"); // Just to align hight with other fields, otherwise it looks wired
				return;
			}
			var docUrl = self.prototype.data("$url", self.getDao()) || "";
			var deferred;
			if (clientContract.isLocalEntityUrl(docUrl)) {
				// Used to returned data in client entities
				deferred = $.smResolve(clientContract.callLocalEntityUrl(docUrl));
			} else {
				deferred = ajax("GET", docUrl, null, null, {
					noJsonParsing: true
				});
			}
			deferred.then(function(result) {
				var responseText = result ? result.responseText || "" : "";
				var empty = responseText == null || responseText.length === 0;
				self.$$elmt.toggleClass("s-m-empty", empty);
				self.asynchCheckEmptyValue(empty);
				if (empty) {
					$$container.remove();
					return;
				}

				// put text content
				var $$dataArr = [];
				switch (self.$type) {
					case "text/plain":
						self.buildFieldFromPlain(responseText, $$textContent);
						break;
					case "text/html":
						self.buildFieldFromHtml(responseText, $$textContent);
						break;
					case "text/rtf":
						self.buildFieldFromRtf(responseText, $$textContent);
						break;
				}

				/*
				 *	Set text-content height so that line of text is not half cut.
				 *	We use text line-height css property value
				 */
				var lineheight = parseInt($$textContent.css("line-height").replace("px", ""), 10);
				var multiplier = Math.floor(self.authH / lineheight);
				self.computedHeight = lineheight * multiplier;

				$$textContent.css({
					height: self.computedHeight + "px"
				});

				self.appendExpander($$textContent);
			}).fail(function(e) {
				self.insertError(e.message);
			});
		},

		/**
		 * Can be overridden - gauge
		 * forceEmpty used by asynchronous processes (ctrlText)
		 */
		checkEmptyValue: function(forceEmpty) {
			return;
		},
		asynchCheckEmptyValue: function(forceEmpty) {
			Base.prototype.checkEmptyValue.call(this, forceEmpty);
		},

		/*
		 *	Append an expander button for the text field.
		 *	Button is appended only if full text height (scrollheight) is higher than self.authH by at least 5px
		 */
		appendExpander: function($$container) {
			var self = this;
			if ($$container.get(0).scrollHeight > self.computedHeight && (($$container.get(0).scrollHeight - self.computedHeight) > 5)) {

				// build expander button
				var buttonTmpl = '<button type="button" class="btn" data-action="toggleText"\
				data-control-id="' + self.id + '"\
				data-params="more">' + locale.text("field.text.seemore") + '</button>';

				var $$expander = self.$$expander = $(buttonTmpl);

				// append the button
				$$expander.insertAfter($$container);

				$$expander.css("float", "right");

				$$expander.wrap("<div class='s-m-enriched-text-expander'></div>");

				$$expander.parent().height($$expander.outerHeight());
			}
		},
		/*
		 * Toggle enriched text. It will either show more or hide
		 */
		_actToggleText: function(param) {
			var self = this;
			// show whole text field
			// change button label
			if (param === "more") {
				self.$$elmt.find(".s-m-enriched-text-content").css({
					height: "auto"
				});
				self.$$expander.text(locale.text("field.text.seeless"));
				self.$$expander.attr("data-params", "less");
			}
			// decrease text field height
			else {
				self.$$elmt.find(".s-m-enriched-text-content").css({
					height: self.computedHeight + "px"
				});
				self.$$expander.text(locale.text("field.text.seemore"));
				self.$$expander.attr("data-params", "more");
			}
			uiUtils.triggerResizeInternal({
				preserveScroll: true
			});
		},
		/**
		 * Display an error
		 */
		insertError: function(html) {
			var err = ['<span class="s-m-error">'];
			err.push(html);
			err.push("</span>");
			$(err.join('')).appendTo(this.$$elmt);
		},
		buildFieldFromPlain: function(data, $$parent) {
			$$parent.append($.parseHTML(escaper(data.replace(/\n/g, "<BR/>"))));
		},
		buildFieldFromRtf: function(data, $$parent) {
			this.buildFieldFromHtml(rtf.toHtml(data), $$parent);
		},
		buildFieldFromHtml: function(data, $$parent) {
			$$parent.append($.parseHTML(escaper(data)));
		}
	});

exports.Klass = _Klass;