"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/field/ctrlFieldBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _Klass = utils.defineClass(

	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self.isImage = self.$type.indexOf("image") == 0;
	}, Base, {

		buildFieldValue: function(parentSlot, buildOptions) {
			var self = this;
			var value;
			value = self.getFormattedValue(self.getValue());
			// Create the image stuff under the standard s-m-value parent
			var imgParent = Base.prototype.buildFieldValue.call(self, parentSlot, buildOptions);
			if (this.$isEditMode) {
				//TODO
			} else if (value != null && value != "") {
				// A non empty value is expected for image field
				// TODO - See if we display a default image or background for empty images
				// In current version we optimize the size and don't display empty image
				self.createFieldValueElement(imgParent, value);
			} else {
				// tag image as empty field
				$(imgParent).addClass("empty");
			}
		},
		createFieldValueElement: function(parentSlot, value) {
			var self = this;
			var fieldLinkClassName = "s-m-field-" + (self.isImage ? "img" : "binary") + "-link";
			var fieldLink = uiUtils.createDomElement("a", [fieldLinkClassName], null, {
				"target": "_blank"
			}, parentSlot);
			self._setDocumentFile(fieldLink);
		},
		_setDocumentFile: function(parentSlot) {
			var self = this;

			var docUrl = self.prototype.data("$url", self.dao);

			if (self.isImage) {

				// set default image
				uiUtils.createDomElement("span", ["s-m-field-img-default glyphicon glyphicon-picture"], null, null, parentSlot);

				// display image
				self._setImageFile(parentSlot, docUrl);

			} else {

				uiUtils.createDomElement("span", ["s-m-field-file glyphicon glyphicon-file"], null, null, parentSlot);
			}

			// append link to the parentSlot anchor
			parentSlot.setAttribute("href", docUrl ? docUrl : "");
		},
		_setImageFile: function(parentSlot, docUrl) {
			var self = this;
			if (docUrl) {
				// remove default image
				parentSlot.removeChild(parentSlot.firstChild);

				// append image
				var imgArea = uiUtils.createDomElement("div", ["s-m-field-img-area img-responsive"], null, null, parentSlot);
				imgArea.style.backgroundImage = "url(\"" + docUrl + "\")";
			}
		}
	});

exports.Klass = _Klass;