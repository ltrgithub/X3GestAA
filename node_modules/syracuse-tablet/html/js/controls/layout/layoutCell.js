"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/layout/layoutBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');

var _sizes = [{
	$prop: "$widthXs",
	$prefix: "col-xs-"
}, {
	$prop: "$widthSm",
	$prefix: "col-sm-"
}, {
	$prop: "$widthMd",
	$prefix: "col-md-"
}, {
	$prop: "$widthLg",
	$prefix: "col-lg-"
}];

var _Klass = utils.defineClass(function LayoutCell(controller, type, article, opts) {
	var self = this;
	Base.call(self, controller, type, article, opts);
}, Base, {
	/**
	 * Init the properties to allow reuse of this control
	 */
	initReuseProperties: function() {
		Base.prototype.initReuseProperties.call(this);
		this.$$cell = null;
	},
	buildHtml: function($$parent, controllerDao, buildOptions) {
		var self = this;
		Base.prototype.buildHtml.call(self, $$parent, controllerDao, buildOptions);
		self.$$elmt.addClass("s-m-cell");
		self.$$cell = $(uiUtils.createDomElement("div", ["cell"], null, null, self.$$elmt));
		self._setCellColorClass();
		self._setCellSizeClasses();
		self.buildChildrenHtml(self.$$cell, controllerDao, buildOptions);
	},
	_setCellColorClass: function() {
		var bg = this.article.$bgColor;
		if (bg === "transparent" || (bg != null && bg.length === 0)) {
			// No color if bg == "" or transparent color for compatibility
			return;
		}
		if (bg == null) {
			// Never authored -> Default 
			bg = "s-m-default";
		} else {
			bg = "s-m-color-" + bg;
		}
		this.$$cell.addClass("s-m-bg " + bg);
	},
	_setCellSizeClasses: function() {
		var self = this;
		var last = 12;
		var match = true;

		_sizes.forEach(function(size) {
			match = match || self.article[size.$prop];
		});

		if (!match) { // no size set, generate default
			self.article = {
				"$widthXs": 12,
				"$widthSm": 6,
				"$widthMd": 4,
				"$widthLg": 3
			};
		}

		_sizes.forEach(function(size) {
			var val = self.article[size.$prop];
			if (val != null && val > 0 && val <= 12) {
				last = val;
			} else {
				val = last;
			}
			var cls = size.$prefix + val;
			self.$$elmt.addClass(cls);
		});
	},
	_ensureHeader: function() {
		// header is created under $$cell - used by vignette to display icon on/off like in tiles
		return Base.prototype._ensureHeader.call(this, this.$$cell);
	}
});

exports.Klass = _Klass;