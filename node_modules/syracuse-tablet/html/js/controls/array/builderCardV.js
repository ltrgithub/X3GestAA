"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/array/builderBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var articleParser = require('syracuse-tablet/html/js/helpers/articleParser');

var _table = '<table>'; //'<div style="display:table"/>'; 
var _tr = '<tr>'; //'<div style="display:table-row">';
var _tbody = '<tbody>'; //'<div style="display:table-row-group">';
var _thead = '<thead>'; //'<div style="display:table-header-group">';
var _td = '<td>'; //<div style="display:table-cell">';

/**
 * Manage swipe event on a field array in card mode
 * We display one card and swipe to walk into the collection
 * Maybe crate a class...
 */
var _OneCardSwiper = function(builder, buildOptions) {
	this.hammer = null;
	this.builder = builder;
	this.buildOptions = buildOptions;
	/**
	 * init is Mandatory for the bind - Object must be created
	 */
	this.init = function() {
		this.reset();
		this.hammer = new Hammer(this.builder.$$value.get(0));
		this.hammer.get("swipe").set({
			direction: Hammer.DIRECTION_HORIZONTAL
		});
		// listen to events...
		this.hammer.on("swipeleft swiperight", Hammer.bindFn(this.onSwipe, this));
		// For chaining
		return this;
	};
	this.reset = function() {
		if (this.hammer) this.hammer.destroy();
		this.hammer = null;
		this.curIdx = 0;
	};
	this.destroy = function() {
		this.reset();
		this.builder = null;
	};

	this.triggerSwipe = function() {
		this.onSwipe(null);
		// For chaining
		return this;
	};
	// evt = null on start
	this.onSwipe = function(evt) {
		if (utils.isEvtDirection(evt, "v")) return;
		var self = this;
		setTimeout(function() {
			var next = evt ? evt.type === "swipeleft" : null;
			self.curIdx = next == null ? self.curIdx : next === true ? self.curIdx + 1 : self.curIdx - 1;
			self.builder.singleCardUpdate(self.curIdx, self.buildOptions);
		});
	};
	// Save context
	this.savedCtxCreate = function() {
		return {
			curIdx: this.curIdx
		};
	};
	// Restored on back
	this.savedCtxRestore = function(ctx) {
		this.curIdx = ctx && ctx.curIdx != null ? ctx.curIdx : 0;
	};
};
/**
 * Pagination in table.footer
 */
var _tfootPagin = function($$tbl, nbCols, nbRecords) {
	this.nbRecords = Math.max(0, nbRecords);
	this.$$root = $('<tfoot><tr><td colspan="' + nbCols + '"></td></tr></tfoot>').appendTo($$tbl);
	this.$$text = this.$$root.find("td");
	this.update = function(idx) {
		this.$$root.removeClass().addClass("s-m-card-pagin");
		if (this.nbRecords > 0 && idx >= 0 && idx < this.nbRecords) {
			this.$$text.html("Card " + (idx + 1) + "/" + this.nbRecords);
			if (idx === this.nbRecords) {
				this.$$root.addClass("s-m-first");
			} else if (idx === 0) {
				this.$$root.addClass("s-m-last");
			}
		}
	};
};
/**
 * Pagination in table.caption
 */
var _captionPagin = function($$tbl, nbCols, nbRecords) {
	this.nbRecords = Math.max(0, nbRecords);
	this.$$root = $('<caption/>').appendTo($$tbl);
	this.update = function(idx) {
		this.$$root.removeClass().addClass("s-m-card-pagin");
		if (this.nbRecords > 0 && idx >= 0 && idx < this.nbRecords) {
			this.$$root.html("Page " + (idx + 1) + "/" + this.nbRecords);
			if (idx === this.nbRecords) {
				this.$$root.addClass("s-m-first");
			} else if (idx === 0) {
				this.$$root.addClass("s-m-last");
			}
		}
	};
};

/**
 * Vertical card builder
 * Authoring see ctrlArray
 */
var _Klass = utils.defineClass(
	function(control, options) {
		var self = this;
		Base.call(self, control, options);
		self._layoutRoot = null;
		self.cardsPerRow = self.$articleArray.$cardsPerRow;
		self.cardsPerRow = Math.min(20, Math.max(0, self.cardsPerRow == null ? 1 : parseInt(self.cardsPerRow, 10)));
		self.cardMode = self.$articleArray.$cardMode || (self.control.isArrayField() ? "single" : "multiple");
	}, Base, {
		destroy: function() {
			Base.prototype.destroy.call(this);
			if (this._layoutRoot) {
				this._layoutRoot.destroy();
				this._layoutRoot = null;
			}
			if (this._oneCardSwiper) {
				// Different from buiderbase._gestureMgr which is an std scroller
				// _oneCardSwiper doesn't has the same behavior as _gestureMgr it's wy we need another property to store it
				this._oneCardSwiper.destroy();
				this._oneCardSwiper = null;
			}
		},
		buildHtml: function(arrayData, buildOptions) {
			Base.prototype.buildHtml.call(this, arrayData, buildOptions);
			if (!this.$article) return;
			if (!this._layoutRoot) {
				// Create HTML generator
				this._layoutRoot = articleParser.cardV2Controls(this.control);
			}
			this.$$tbl = $(_table).appendTo(this.$$value);

			this.buildPagingLinks(arrayData, buildOptions);
			if (this.cardMode === "single") {
				this.singleCardBuild(buildOptions);
			} else {
				this.multipleCardsBuild(arrayData, buildOptions);
			}
		},
		/**
		 * Array field in card mode - One card is display at a time - Swipe to walk inside the collection
		 */
		singleCardBuild: function(buildOptions) {
			var rsrcs = this.control.getArrayData().$resources;
			if (rsrcs.length > 1) {
				// Display header in caption to keep the same Y coordinate the same place when we swipe
				// _tfootPagin displays pagin in footer but position changes according to card height
				this._pagin = new _captionPagin(this.$$tbl, 1, rsrcs.length);
			}
			this.$$cardRow = $(_tr).appendTo($(_tbody)).appendTo(this.$$tbl);
			this._oneCardSwiper = new _OneCardSwiper(this, buildOptions).init().triggerSwipe();
		},
		/**
		 * QUery/Lookup Array field in card mode - We display all the cards - Vertical Scroll up/down
		 */
		multipleCardsBuild: function(arrayData, buildOptions) {
			var self = this;
			// Set gesture manager -> disabled - gestureLgr is enabled onResize
			this.newScroller("v", this.$$tbl);
			var cardsPerRow = self.cardsPerRow;
			if (false && cardsPerRow > 1) {
				/* non need of header - used to create columns with same width*/
				var w = Math.round(100 / cardsPerRow);
				var wr = 100 - w * cardsPerRow;
				var $$tr = $(_tr).appendTo($(_thead).appendTo(self.$$tbl));
				for (var i = 0; i < cardsPerRow; i++) {
					$(_td).css({
						width: (i === cardsPerRow - 1 ? w + wr : w) + "%"
					}).appendTo($$tr);
				}
			}
			self.$$tbody = $(_tbody).appendTo(self.$$tbl);
			/* Query/Lookup we display all cards in stack mode */
			var remaining = 0,
				$$row, $$cell;
			arrayData.$resources.forEach(function(rowData, idx) {
				if (remaining === 0) {
					remaining = cardsPerRow;
					$$row = $(_tr).appendTo(self.$$tbody);
				}
				$$cell = $(self.buildDetailLink(rowData, {
					tag: "td", //"div",
					parent: $$row,
					createIfNoLink: true,
					/*attrs: {
						style: "display:table-cell"
					}*/
				}));
				self.callGenerateHtml(self._layoutRoot, $$cell, rowData, false, buildOptions);
				remaining--;
			});
			self._addEmptyCells($$row, remaining, buildOptions);
		},
		/**
		 * Update field array card on swipe
		 */
		singleCardUpdate: function(idx, buildOptions) {
			try {
				var self = this;
				var rsrcs = self.control.getArrayData().$resources;
				if (idx < 0 || idx >= rsrcs.length) return;
				var rowData = rsrcs[idx];
				if (self.$$cardCell) self.$$cardCell.remove();
				self.$$cardCell = $(self.buildDetailLink(rowData, {
					tag: "td", //"div", //tag: "td",
					parent: self.$$cardRow,
					createIfNoLink: true,
					css: "nohover",
					/*attrs: {
						style: "display:table-cell"
					}*/
				}));
				self.callGenerateHtml(self._layoutRoot, self.$$cardCell, rowData, false, buildOptions);
				if (self._pagin) self._pagin.update(idx);
			} catch (e) {
				alert(e);
			}
		}
	});

exports.Klass = _Klass;