"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Base = require('syracuse-tablet/html/js/controls/array/builderBase').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var reqProto = require('syracuse-tablet/html/js/helpers/prototype');;
var modal = require('syracuse-tablet/html/js/ui/modal');
var daoSdata = require('syracuse-tablet/html/js/application/daoSdata');

var _isExcluded = ["application/json", "application/x-array", "application/x-document", "application/x-binary"];
var _ADDROW = "$ADDROW";
var _addRowBtn = {
	$activity: "create",
	$type: "tablet/x-button",
	$icon: "addrow",
	$bind: _ADDROW,
	$text: "Add row",
	attrs: {
		"data-nav": "rowdetail"
	}
};
var _additionalCols = [{
	$type: "tablet/x-icon",
	css: ["s-m-icon"],
	$activity: "edit",
	$icon: "editrow",
	$bind: "$EDITROW",
	attrs: {
		"data-nav": "rowdetail"
	}
}, {
	$type: "tablet/x-icon",
	css: ["s-m-icon"],
	$activity: "edit",
	$icon: "delrow",
	$bind: "$DELETEROW",
	attrs: {
		"data-action": "delrow"
	}
}, {
	$type: "tablet/x-icon",
	css: ["s-m-icon"],
	$activity: "display",
	$icon: "detailrow",
	$bind: "$DETAILROW",
	attrs: {
		"data-nav": "rowdetail"
	}
}];
/**
 * x-array control class
 * Array authoring - $article
 * 		$isTitleHidden		Hide the column title
 * 		$items 				Columns authoring
 * 				$title			Override the title
 * 				$width			Set the width
 * 				$isAdvanced		Not displayed in grid
 */
var _Klass = utils.defineClass(
	function(control, options) {
		var self = this;
		Base.call(self, control, "grid", options);
	}, Base, {

		buildHtml: function($$parent, arrayData, options) {
			var self = this;
			options = options || {};
			options.displayRowIdx = false;
			Base.prototype.buildHtml.call(self, $$parent, arrayData, options, ["s-m-table"]);
			var title = self.control.getTitle();
			if (title) {
				$(uiUtils.createDomElement('div', ["s-m-title"])).text(title).appendTo(self.$$elmt);
			}
			// Create standard control value elmt		
			var value = uiUtils.createDomElement('div', ["s-m-value"], null, null, self.$$elmt);
			if (self._createColumnInfo(options).length > 0) {
				var $$table = $(uiUtils.createDomElement('table', ["table table-hover table-condensed"], null, null, value));
				self._buildTableHead($$table, options);
				self._buildTableBody($$table, arrayData, options);
				self._buildTableFoot($$table, options);
				self.buildPagingLinks(arrayData, {
					top: true,
					bottom: true
				});
			} else {
				$(value).addClass("empty");
			}
		},

		_insertError: function(html) {
			var err = ['<div class="s-m-error">'];
			err.push(html);
			err.push("</div>");
			$(err.join('')).appendTo(this.$$elmt);
		},

		// get columns that should be displayed
		_createColumnInfo: function(options) {
			var self = this;
			var article = self.control.article.$article;
			if (!article || !article.$items) {
				// a$article is expected - see articlePArse which set the default article
				self._insertError("<b>No $article found for array " + self.control.$bind + "<b>");
				return [];
			}
			self.columnInfo = [];
			if (options.displayRowIdx) {
				self.columnInfo.push({
					"$bind": reqProto.ROWIDXPROP,
					"proto": reqProto.getRowIdxProto()
				});
			}
			var proto, nbCols = 0,
				unfound = [],
				col;
			article.$items.forEach(function(item, idx) {
				proto = self.$itemProto.property(item.$bind);
				if (!proto) {
					unfound.push(item);
					// TODO - Display error
				} else {
					nbCols++;
					if (!self.isExcluded(item, proto)) {
						col = {
							"$bind": item.$bind,
							"proto": self.$itemProto.create(proto),
							"article": item
						};
						if (col.article.$isTitleHidden === true) {
							col.title = "";
						} else if (col.article.$title != null) {
							// Title can be overridden bay article - TODO translation
							col.title = self.$itemProto.resolveExpression(col.article.$title) || "";
						} else {
							col.title = col.proto.data('$title') || "";
						}
						self.columnInfo.push(col);
					}
				}
			});
			var edit = self.control.controller.isEditMode();
			var overflow = self.columnInfo.length != nbCols;
			_additionalCols.forEach(function(col) {
				if ((edit && col.$activity === "edit") || (!edit && overflow && col.$activity === "display")) {
					self.columnInfo.push(col);
				}
			});
			if (unfound.length > 0) {
				// Add unfound columns
				var html = ['Field(s) not found<ul>'];
				unfound.forEach(function(x) {
					html.push("<li><b>" + x.$bind + "</b></li>");
				});
				html.push("</ul>");
				self._insertError(html.join(''));
			}
			return self.columnInfo;
		},

		isExcluded: function(item, proto) {
			var self = this;
			if (Base.prototype.isExcluded.call(self, proto)) return true;
			return _isExcluded.indexOf(proto.$type) >= 0 || item.$isAdvanced === true;
		},

		_buildTableHead: function($$table, options) {
			var self = this;
			var tabHead = uiUtils.createDomElement('thead', null, null, null, $$table);
			var tr = uiUtils.createDomElement('tr', null, null, null, tabHead);
			var th, css, hasWidth = false;
			self.columnInfo.forEach(function(col) {
				th = uiUtils.createDomElement('th', col.css, col.title, null, tr);
				if (col.article) {
					css = {};
					if (col.article.$width != null) {
						// TODO -Use our own styles for table not BS
						css["max-width"] = css.width = col.article.$width;
						hasWidth = true;
					}
					$(th).css(css);
				}
			});
			// We need to change table-layout to take into account fixed widths
			$$table.css({
				"table-layout": hasWidth ? "fixed" : "auto"
			});
		},

		_buildTableFoot: function($$table, options) {
			var self = this;
			if (self.control.controller.isEditMode()) {
				var cell = $('<tfoot><tr><td colspan="' + self.columnInfo.length + '"></td></tr></tfoot>').appendTo($$table).find("td");
				var fieldProto = self._getOtherColProto(_addRowBtn, "");
				self.appendField2Cell(cell, _addRowBtn.$bind, fieldProto, daoSdata.emptyDao(fieldProto));
			}
		},
		_buildTableBody: function($$table, arrayData, options) {
			var self = this;
			var tabBody = uiUtils.createDomElement('tbody', null, null, null, $$table);
			// Build rows
			for (var i = 0; i < arrayData.$resources.length; i++) {
				self._buildTableRow(tabBody, arrayData.$resources[i], i, options);
			}
		},

		_buildTableRow: function(tabBody, rowData, idx, options) {
			var self = this;
			var cssRowIdx;
			if (options.displayRowIdx) {
				rowData.setRowIndex(idx);
				cssRowIdx = ["s-m-rowidx"];
			}
			var tr = self.buildDetailLink(rowData, {
				tag: "tr",
				parent: tabBody,
				createIfNoLink: true
			});
			var cell, rowIdx, fieldProto;
			self.columnInfo.forEach(function(col, idx) {
				rowIdx = options.displayRowIdx && col.$bind === reqProto.ROWIDXPROP;
				cell = uiUtils.createDomElement('td', rowIdx ? cssRowIdx : null, null, null, tr);
				fieldProto = col.$activity != null ? self._getOtherColProto(col, rowData.getValue("$uuid")) : col.proto;
				self.appendField2Cell(cell, col.$bind, fieldProto, rowData);
			});
		},

		_getOtherColProto: function(colInfo, rowId) {
			var self = this;
			var $action = {
				"data-control-id": self.control.id,
				"data-parent-id": self.control.controller.id

			};
			for (var p in colInfo.attrs) {
				$action[p] = colInfo.attrs[p];
			}
			if (self.control.controller.isVignette) {
				// It's the vignette which will load the page
				$action["data-nav-target"] = "vignette";
			}
			var params = {
				rowId: rowId,
				activity: colInfo.$activity
			};
			$action["data-params"] = JSON.stringify(params);
			var json = {
				$action: $action
			};
			["$type", "$icon", "$text"].forEach(function(x) {
				if (x != null) json[x] = colInfo[x];
			});
			return reqProto.create(json);
		}
	});

exports.Klass = _Klass;