"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("ctrl");
var Base = require('syracuse-tablet/html/js/controls/ctrlBase').Klass;
var Builder = require('syracuse-tablet/html/js/controls/builderArrays');

/**
 * x-array control class
 */
var _Klass = utils.defineClass(
	function(controller, article, prototype) {
		var self = this;
		Base.call(self, controller, article, prototype);
		self.itemProto = prototype.getPrototype("$item");
		/* Temporarily - Add row index to be abme to display it and put the link to detail*/
		self.itemProto.addRowIndex();
		self.display = "grid-article" // "grid-article"; "grid-html";
	}, Base, {
		/**
		 * Build Html by using a builder class
		 */
		buildHtml: function(parent, controllerDao, buildOptions) {
			var self = this;
			if (!self.builder) {
				if (self.display === "grid-article") {
					self.builder = new Builder.GridArticleBuilder(self);
				} else if (self.display === "grid-html") {
					self.builder = new Builder.GridHtmlBuilder(self);
				} else {
					throw new Error("not implemented[" + self.display + "]");
				}
			}
			var html = [];
			self.builder.buildHtml(html, controllerDao, buildOptions);

			var $$dom = $("<div>");
			$$dom.html(html.join(''));

			parent.append($$dom[0]);
		},
		/**
		 * Returns an array that contains rows data
		 * Each row data is a dao - see DaoSdata.getQueryData
		 */
		getRows: function(controllerDao) {
			var self = this;
			var d = self._getData(controllerDao);
			return d && d.$resources ? d.$resources : [];
		},
		_getData: function(controllerDao) {
			var self = this;
			if (self._data) return self._data;
			self._data = controllerDao.getArrayData(self.article.$bind, self.itemProto);
			return self._data;
		}
	});

exports.Klass = _Klass;