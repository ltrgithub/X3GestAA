"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');
var Base = require('syracuse-tablet/html/js/controls/structElmt').Klass;
var globals = require('syracuse-tablet/html/js/helpers/globals');
var fontUtils = require('syracuse-tablet/html/js/ui/fontUtils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("pageHeader");
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var eventListener = require('syracuse-tablet/html/js/application/eventListener');

var _templates = {
	main: '\
		<div id="{{ctrlId}} class="s-m-control"> \
			<div class="s-m-header container-fluid">\
				<div class="s-m-header-nav">\
					{{#if showHome}} \
						<a href="#" data-action="historyBack">\
							<span class="' + fontUtils.pageIcon("back") + '" />\
						</a>\
						<a href="#" data-action="gotoWelcomeApplication">\
							<span class="' + fontUtils.pageIcon("home") + '" />\
						</a>\
					{{/if}} \
				</div>\
				<div class="s-m-header-labels">\
					<div class="s-m-header-brand"><span class="s-m-brand">{{labelBrand}}</span> <span class="s-m-product">{{labelProduct}}</span></div>\
					<div class="s-m-header-appname">{{appName}}</div>\
				</div>\
				<div class="s-m-header-links">\
					<a href="#">\
						<div>\
							<span class="s-m-nav-text username">{{username}}</span>\
							<span class="s-m-nav-text userrole">{{userrole}}</span>\
						</div>\
						{{#if userPhotoUrl}}\
							<img src="{{userPhotoUrl}}">\
						{{else}}\
							<span class="' + fontUtils.pageIcon("switchContext") + '" />\
						{{/if}}\
					</a>\
				</div>\
				<div class="s-m-header-search" style="display:none">\
					<form style="display:none" class="navbar-form navbar-right" role="search">\
						<div class="form-group input-group-sm"">\
							<input type="text" class="form-control" placeholder="Search">\
						</div>\
						<button type="submit" class="btn btn-success">\
							<span class="' + fontUtils.pageIcon("search") + '"></span>\
						</button>\
					</form>\
				</div>\
			</div>\
		</div>',
	mainbackup: '\
		<div id="{{ctrlId}} class="s-m-control"> \
			<div class="s-m-header container-fluid">\
				<div class="s-m-header-nav">\
					{{#if showHome}} \
						<a href="#" data-action="historyBack">\
							<span class="' + fontUtils.pageIcon("back") + '" />\
						</a>\
						<a href="#" data-action="gotoWelcomeApplication">\
							<span class="' + fontUtils.pageIcon("home") + '" />\
						</a>\
					{{/if}} \
				</div>\
				<div class="s-m-header-labels">\
					<div class="s-m-header-brand"><span class="s-m-brand">{{labelBrand}}</span> <span class="s-m-product">{{labelProduct}}</span></div>\
					<div class="s-m-header-appname">{{appName}}</div>\
				</div>\
				<div class="s-m-header-links">\
					{{#if showAuthoring}} \
						<a href="#" data-action="designPage">\
							<span class="' + fontUtils.pageIcon("designPage") + '" />\
						</a>\
					{{/if}} \
					{{#if showLinks}} \
						<a href="#" data-action="clearCache">\
							<span class="' + fontUtils.pageIcon("clearCache") + '" />\
						</a>\
						<a href="#" data-action="switchContext"> \
							<span class="' + fontUtils.pageIcon("switchContext") + '" /><span class="s-m-nav-text">{{user}}</span>\
						</a>\
					{{/if}} \
				</div>\
				<div class="s-m-header-search" style="display:none">\
					<form style="display:none" class="navbar-form navbar-right" role="search">\
						<div class="form-group input-group-sm"">\
							<input type="text" class="form-control" placeholder="Search">\
						</div>\
						<button type="submit" class="btn btn-success">\
							<span class="' + fontUtils.pageIcon("search") + '"></span>\
						</button>\
					</form>\
				</div>\
			</div>\
		</div>',
	mainMobile: '\
		<div id="{{ctrlId}} class="s-m-control"> \
			<div class="s-m-header container-fluid">\
				<div class="s-m-header-nav">\
					{{#if showHome}} \
						<a href="#" data-action="historyBack">\
							<span class="' + fontUtils.pageIcon("back") + '" />\
						</a>\
						<a href="#" data-action="gotoWelcomeApplication">\
							<span class="' + fontUtils.pageIcon("home") + '" />\
						</a>\
					{{/if}} \
				</div>\
				<div class="s-m-header-labels">\
					<div class="s-m-header-appname">{{appName}}</div>\
				</div>\
				<div class="s-m-header-links" mobile>\
					<a href="#"> \
						<span class="' + fontUtils.pageIcon("switchContext") + '" /><span class="s-m-nav-text">{{user}}</span>\
					</a>\
				</div>\
				<div class="s-m-header-search" style="display:none">\
					<form style="display:none" class="navbar-form navbar-right" role="search">\
						<div class="form-group input-group-sm"">\
							<input type="text" class="form-control" placeholder="Search">\
						</div>\
						<button type="submit" class="btn btn-success">\
							<span class="' + fontUtils.pageIcon("search") + '"></span>\
						</button>\
					</form>\
				</div>\
			</div>\
		</div>',
	mainm: '\
		<div id="{{ctrlId}} class="s-m-control"> \
			<nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">\
				<div class="container-fluid">\
					<div class="navbar-header">\
						<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#header-collapse-{{ctrlId}}">\
					        <span class="icon-bar"></span>\
					        <span class="icon-bar"></span>\
					        <span class="icon-bar"></span>\
						</button>\
						{{#if showHome}} \
							<ul class="nav navbar-nav">\
								<li>\
									<a draggable="false"  href="#" data-action="historyBack">\
										<span class="' + fontUtils.pageIcon("back") + '" />\
									</a>\
								</li>\
								<li>\
									<a draggable="false"  href="#" data-action="gotoWelcomeApplication">\
										<span class="' + fontUtils.pageIcon("home") + '" />\
									</a>\
								</li>\
							</ul>\
						{{/if}} \
						<span class="navbar-brand">{{title}}</span>\
					</div>\
					<div class="collapse navbar-collapse" id="header-collapse-{{ctrlId}}">\
						<ul class="nav navbar-nav">\
							<li></li>\
						</ul>\
						<ul class="nav navbar-nav navbar-right">\
							{{#if showAuthoring}} \
								<li> \
									<a draggable="false"  href="#" data-action="designPage">\
										<span class="' + fontUtils.pageIcon("designPage") + '" />\
									</a>\
								</li> \
							{{/if}} \
							{{#if showLinks}} \
								<li>\
									<a draggable="false"  href="#" data-action="clearCache">\
										<span class="' + fontUtils.pageIcon("clearCache") + '" />\
									</a>\
								</li>\
								<li>\
									<a draggable="false"  href="#" data-action="switchContext"> \
										<span class="' + fontUtils.pageIcon("switchContext") + '" /><span class="s-m-nav-text">{{user}}</span>\
									</a>\
								</li>\
							{{/if}} \
						</ul>\
						<form style="display:none" class="navbar-form navbar-right" role="search">\
							<div class="form-group input-group-sm"">\
								<input type="text" class="form-control" placeholder="Search">\
							</div>\
							<button type="submit" class="btn btn-success">\
								<span class="' + fontUtils.pageIcon("search") + '"></span>\
							</button>\
						</form>\
					</div>\
				</div>\
			</nav> \
		</div>',
	headerLinks: '\
		<div class="s-m-header-links-list list-group">\
			{{#if showAuthoring}} \
				<a href="#" data-action="linkClicked" data-params="designPage" data-control-id="{{ctrlid}}" class="list-group-item">\
					<span class="' + fontUtils.pageIcon("designPage") + '" />\
					{{labelDesignPage}}\
				</a>\
			{{/if}} \
			{{#if showLinks}} \
				<a href="#" data-action="linkClicked" data-params="clearCache" data-control-id="{{ctrlid}}" class="list-group-item">\
					<span class="' + fontUtils.pageIcon("clearCache") + '" />\
					{{labelClearCache}}\
				</a>\
				<a href="#" data-action="linkClicked" data-params="switchContext" data-control-id="{{ctrlid}}" class="list-group-item"> \
					<span class="' + fontUtils.pageIcon("switchContext") + '" />\
					{{labelSwitchContext}}\
				</a>\
			{{/if}} \
		</div>'
};

var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};

/**
 * Page header Generate Html
 */
var _Klass = utils.defineClass(

	function(controller, $type) {
		var self = this;
		Base.call(self, controller, $type);
		notifications.subscribe(self, ["sm.main.layout.changed"]);
	}, Base, {

		destroy: function() {
			if (this.$$linksPicker) this.$$linksPicker.off("click");
			Base.prototype.destroy.call(this);
		},

		buildHtml: function($$parent, controllerDao, buildOptions) {
			var self = this;
			buildOptions = buildOptions.header || {};
			var _mainCtx = {
				labelBrand: buildOptions.labelBrand || "Sage",
				labelProduct: buildOptions.labelProduct || "ERP X3",
				appName: globals.getApplication().getTitle(),
				/*title: buildOptions.title || "Sage ERP X3 - Mobile",*/
				username: globals.getUserName(),
				userrole: globals.getUserRole(),
				userPhotoUrl: globals.getUserPhotoUrl(),
				ctrlId: self.id,
				/* temporarily no authoring in child pages*/
				showAuthoring: !buildOptions.isChild && buildOptions.showAuthoring,
				showLinks: !buildOptions.isChild,
				showHome: !buildOptions.isChild && !globals.getApplication().isWelcomeApplication()
			};
			var isTablet = $(window).width() > 480;
			self.setRootElement(_getHtml(isTablet ? "main" : "mainMobile", _mainCtx), $$parent);


			// bind click on user icon to open header links list
			self.$$linksPicker = self.$$elmt.find(".s-m-header-links");
			self.$$linksPicker.on("click", function(ee) {
				// FK I close the menu - You shoudl use dropdown bootstrap plugin - see vignetteBase.js - FDB
				if (self.$$hLinksList == null) {
					$.extend(_mainCtx, {
						labelDesignPage: locale.text("header.links.designPage"),
						labelClearCache: locale.text("header.links.clearCache"),
						labelSwitchContext: locale.text("header.links.switchContext"),
						ctrlid: self.id
					});
					self.$$hLinksList = $(_getHtml("headerLinks", _mainCtx));
					self.$$hLinksList.css("position", "absolute");
					$("#s-m-app-id").append(self.$$hLinksList);
					self.$$hLinksList.position({
						my: "right top",
						at: "right bottom",
						of: self.$$elmt.find(".s-m-header-links")
					});
				}
				self.$$hLinksList.show();
			});

		},
		_actLinkClicked: function(actionName) {
			if (this.$$hLinksList) this.$$hLinksList.hide();
			eventListener.triggerAction(this.$$elmt, actionName);
		},
		// TODO
		getLinkTitle: function(facetValue) {
			switch (facetValue) {
				case "$edit":
					return "Edit";
				case "$query":
					return "List";
				case "$save":
					return "Save";
				case "$details":
					return "Detail";
				default:
					throw new Error("Facet " + facetValue + " not implemented yet");
			}
		},
		/* function run on resize*/
		notifMainLayoutChanged: function() {
			var self = this;

		}
	});

exports.Klass = _Klass;