"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var Base = require('syracuse-tablet/html/js/controls/page/panels/sidePanel').Klass;
var uiUtils = require('syracuse-tablet/html/js/ui/uiUtils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var fontUtils = require('syracuse-tablet/html/js/ui/fontUtils');
var locale = require('syracuse-tablet/html/js/helpers/locale');

var _templates = {
	main: '\
		<section class="s-m-side-panel {{side}}">\
			<ul class="nav nav-pills" role="tablist"> \
				{{#each tabs}}\
					<li style="{{width}}"><a href="#{{id}}" role="tab" data-toggle="tab">{{title}}</a></li> \
				{{/each}}\
			</ul> \
			<div class="tab-content"> \
				{{#each tabs}}\
					<div id="{{id}}" role="tabpanel" class="tab-pane {{type}}"/> \
				{{/each}}\
			</div> \
		</section>',
	sort: '\
		<div class="btn-group btn-group-justified" role="group">\
		  <a type="button" class="btn btn-default" data-params="save">Ok</a>\
		  <a type="button" class="btn btn-default" data-action="toggleSidePanel">Cancel</a>\
		</div>\
		<ul class="list-group">\
			{{#each items}}\
				<li class="list-group-item" data-params="{{id}}">\
					<span>{{name}}</span>\
					<span class="s-m-order ' + fontUtils.sortIcon("none") + ' {{none}}" data-params="none"></span>\
					<span class="s-m-order ' + fontUtils.sortIcon("asc") + '  {{asc}}" data-params="asc"></span>\
					<span class="s-m-order ' + fontUtils.sortIcon("dsc") + '  {{dsc}}" data-params="dsc"></span>\
				</li>\
			{{/each}}\
		</ul>'
};
var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[key] = Handlebars.compile(_templates[name]);
	}
	return tmpl(ctx);
};

var _Tab = utils.defineClass(
	function(panel, id, options) {
		this.id = id;
		this.options = options || {};
		this.panel = panel;
		this.parentArray = panel.parentArray;
		this.$$tab = this.panel.$$panel.find('[href="#' + id + '"]');
		this.$$content = this.panel.$$panel.find('#' + this.id);
		if (this.isHidden()) {
			this.$$tab.parent().hide();
			this.$$content.hide();
		} else {
			this.$$tab.on('shown.bs.tab', utils.bindFn(this.onTabShown, this));
			this.$$tab.on('hidden.bs.tab', utils.bindFn(this.onTabHidden, this));
			if (this.options.isActive) {
				var self = this;
				window.setTimeout(function() {
					self.activate(true);
				});
			}
		}
	}, null, {
		destroy: function() {
			this.panel = null;
			this.parentArray =
				utils.unbindObj(this.$$tab);
			this.$$tab = null;
			utils.unbindObj(this.$$content);
			this.$$content = null;
		},
		isHidden: function() {
			return this.options.hidden === true;
		},
		isActive: function() {
			return this.$$tab.hasClass("active");
		},
		activate: function(yes) {
			this.$$tab.tab(yes != false ? 'show' : 'hide');
		},
		setAlone: function() {
			this.$$tab.parent().width("100%");
		},
		onTabShown: function(event) {
			if (this.$$content.is(':empty')) {
				this.$$content.append(this.buildHtml());
			}
		},
		onTabHidden: function(event) {},
		/**
		 * When the panel is detached/attached to main page
		 */
		notifyToggled: function(side, action, visible) {},
		buildHtml: function() {},
		addClickHandler: function(selector, handler) {
			this.$$content.on("click", selector, handler);
		}
	});

var _Sort = utils.defineClass(
	function(parentArray, id, options) {
		this.sortInfo = parentArray.parentArray.sortInfoGet();
		options.hidden = options.hidden === true || this.sortInfo.length === 0;
		_Tab.call(this, parentArray, id, options);
	}, _Tab, {
		buildHtml: function() {
			this.sortInfo.forEach(function(i) {
				i.asc = i.sort == "asc" ? "enabled" : "";
				i.dsc = i.sort == "dsc" ? "enabled" : "";
				i.none = i.sort == "none" ? "enabled" : "";
			});
			var $$e = this.$$content.append($(_getHtml("sort", {
				items: this.sortInfo
			})));
			var self = this;
			this.addClickHandler('[data-params]', utils.bindFn(this.onClickSort, this));
		},
		onClickSort: function(evt) {
			evt.preventDefault();
			evt.stopPropagation();
			var $$t = $(evt.target);
			if ($$t.attr("data-params") === "save") {
				var status = {};
				this.$$content.find(".s-m-order.enabled").each(function(idx, $$e) {
					$$e = $($$e);
					status[$$e.parent().attr("data-params")] = $$e.attr("data-params");
				});
				this.sortInfo.forEach(function(i) {
					i.sort = status[i.id] || "none";
				});
				var self = this;
				window.setTimeout(function() {
					self.parentArray.sortInfoSet(self.sortInfo);
				});
				this.panel.close();
				return;
			}
			if ($$t.hasClass("enabled")) {
				$$t.removeClass('enabled');
				return;
			}
			(this.options.singleCriteria === true ? this.$$content : $$t.parent()).find(".s-m-order.enabled").removeClass('enabled');
			$$t.addClass("enabled");

		}
	});

var _Filter = utils.defineClass(
	function(parentArray, id, options) {
		_Tab.call(this, parentArray, id, options);
	}, _Tab, {});

var _tabDescr = [{
	klass: _Sort,
	options: {
		name: "sort",
		isActive: true,
		singleCriteria: true
	}
}, {
	klass: _Filter,
	options: {
		name: "filter",
		isActive: false
	}
}];

/**
 * Arrays Sort/Filter panel
 */
var _Klass = utils.defineClass(
	function(controller, $type, panelId, options) {
		this.parentArray = options.parentArray;
		this._tabs = {};
		Base.call(this, controller, $type, panelId, options);
	}, Base, {
		destroy: function() {
			Base.prototype.destroy.call(this);
			this.parentArray = null;
			if (this._tabs) {
				$.each(this._tabs, function(key, value) {
					value.destroy();
				});
				this._tabs = null;
			}
		},
		buildHtml: function(side) {
			var self = this;
			Base.prototype.buildHtml.call(this, side);
			self.$$elmt.addClass(self.typeName);
			if (self.$$panel) {
				self.$$panel.remove();
			}
			var ctx = {
				ctrlId: self.id,
				side: side,
				tabs: [],
			};
			var ids = {};
			var descriptions = [];
			/**
			 * We can disable filter or sort with self.options.filter = false or  self.options.sort
			 */
			_tabDescr.forEach(function(descr) {
				descr = $.extend({}, descr);
				descr.options.hidden = self.options[descr.options.name] === false;
				descriptions.push(descr);
			});
			var width = Math.round(1000 * 100 / _tabDescr.length) / 1000 + "%";
			descriptions.forEach(function(descr) {
				ids[descr.options.name] = utils.readableuid("array" + descr.options.name);
				ctx.tabs.push({
					id: ids[descr.options.name],
					title: locale.text("panels.array." + descr.options.name),
					type: descr.options.name,
					width: width
				});
			});
			self.$$panel = $(_getHtml("main", ctx));
			if (self.$$panel && self.$$panel.length) {
				self.$$elmt.append(self.$$panel);
				var nbHidden = 0;
				descriptions.forEach(function(descr) {
					var t = new descr.klass(self, ids[descr.options.name], descr.options);
					if (t.isHidden()) nbHidden++;
					self._tabs[descr.options.name] = t;
				});
				if (descriptions.length == 1 || descriptions.length === nbHidden + 1) {
					// Tab is alone
					$.each(self._tabs, function(key, value) {
						if (!value.isHidden()) {
							value.setAlone();
						}
					});
				} else {
					// Todo adjust with if some tabs are hidden
				}
			}
		},
		notifyToggled: function(side, action, visible) {
			var self = this;
			Base.prototype.notifyToggled.call(self, side, action, visible);
			$.each(self._tabs, function(id, tab) {
				tab.notifyToggled(side, action, visible);
			});
		},
	});

exports.Klass = _Klass;