"use strict";

var Prototype = require('syracuse-tablet/html/js/wc/sdata/prototype').Prototype;

var CtrlAlphaNumModule = require('syracuse-tablet/html/js/wc/controls/fields/ctrlAlphanum');

var CtrlAlphaNum = CtrlAlphaNumModule.CtrlAlphaNum;
var CtrlPhone = CtrlAlphaNumModule.CtrlPhone;
var CtrlEmail = CtrlAlphaNumModule.CtrlEmail;
var CtrlUrl = CtrlAlphaNumModule.CtrlUrl;

var CtrlCheckbox = require('syracuse-tablet/html/js/wc/controls/fields/ctrlCheckbox').CtrlCheckbox;
var CtrlSwitch = require('syracuse-tablet/html/js/wc/controls/fields/ctrlSwitch').CtrlSwitch;
var CtrlCombo = require('syracuse-tablet/html/js/wc/controls/fields/ctrlCombo').CtrlCombo;

var CtrlNumeric = require('syracuse-tablet/html/js/wc/controls/fields/ctrlNumeric').CtrlNumeric;
var CtrlQuantity = require('syracuse-tablet/html/js/wc/controls/fields/ctrlQuantity').CtrlQuantity;
var CtrlReference = require('syracuse-tablet/html/js/wc/controls/fields/ctrlReference').CtrlReference;

var CtrlDate = require('syracuse-tablet/html/js/wc/controls/fields/ctrlDate').CtrlDate;
var CtrlText = require('syracuse-tablet/html/js/wc/controls/fields/ctrlText').CtrlText;

var CtrlTypeUnknown = require('syracuse-tablet/html/js/wc/controls/ctrlTypeUnknown').CtrlTypeUnknown;

var ctrlComplexArray = require('syracuse-tablet/html/js/wc/controls/array/ctrlComplexArray').CtrlComplexArray;
var CtrlChartArray = require('syracuse-tablet/html/js/wc/controls/array/ctrlChartArray').CtrlChartArray;
var ctrlArrayFactory = null;
if (window.location.href.indexOf("wocoFdb") > 0) {
	ctrlArrayFactory = require('syracuse-tablet/html/js/wc/controls/array/fdb/ctrlArrayFactory');
}
var CtrlVignette = require('syracuse-tablet/html/js/wc/controls/vignette/ctrlVignette').CtrlVignette;
var CtrlVignetteLink = require('syracuse-tablet/html/js/wc/controls/vignette/ctrlVignetteLink').CtrlVignetteLink;

var CtrlImage = require('syracuse-tablet/html/js/wc/controls/fields/ctrlImage').CtrlImage;
var CtrlGaugeChart = require('syracuse-tablet/html/js/wc/controls/fields/ctrlGaugeChart').CtrlGaugeChart;


var LayoutStack = require('syracuse-tablet/html/js/wc/controls/layouts/layoutStack').LayoutStack;
var LayoutRow = require('syracuse-tablet/html/js/wc/controls/layouts/layoutRow').LayoutRow;
var LayoutCell = require('syracuse-tablet/html/js/wc/controls/layouts/layoutCell').LayoutCell;
var LayoutHub = require('syracuse-tablet/html/js/wc/controls/layouts/layoutHub').LayoutHub;
var LayoutHubGroup = require('syracuse-tablet/html/js/wc/controls/layouts/layoutHubGroup').LayoutHubGroup;
var LayoutTile = require('syracuse-tablet/html/js/wc/controls/layouts/layoutTile').LayoutTile;

var PanelFooterSdataPageTablet = require('syracuse-tablet/html/js/wc/controls/panels/footer/panelFooterSdataPageTablet').PanelFooterSdataPageTablet;

var PanelHeaderSdataPageTablet = require('syracuse-tablet/html/js/wc/controls/panels/header/panelHeaderSdataPageTablet').PanelHeaderSdataPageTablet;
var PanelHeaderSdataPageSmartphone = require('syracuse-tablet/html/js/wc/controls/panels/header/panelHeaderSdataPageSmartphone').PanelHeaderSdataPageSmartphone;

var PanelActions = require('syracuse-tablet/html/js/wc/controls/panels/aside/panelActions').PanelActions;
var PanelGlobalSmartphone = require('syracuse-tablet/html/js/wc/controls/panels/aside/panelGlobalSmartphone').PanelGlobalSmartphone;
var PanelGlobalTablet = require('syracuse-tablet/html/js/wc/controls/panels/aside/panelGlobalTablet').PanelGlobalTablet;
var PanelSortFilter = require('syracuse-tablet/html/js/wc/controls/panels/sortfilter/panelFilterSort').PanelFilterSort;
var BreadcrumbsTablet = require('syracuse-tablet/html/js/wc/controls/panels/crumbs/breadcrumbsTablet').BreadcrumbsTablet;

/**
 * Single function to create controls and bind them to the given controller
 * Control selection is based on article, there are several ways
 * 
 * article can be:
 * {
 *   $bind: "CODE" // Bind to a property of controller
 * }
 * article can be:
 * {
 *   $layoutType: "stack" // Create a layout (not really a control)
 * }
 * article can be:
 * {
 *   $link: "$details" //Create a link control triggering an sdata link
 * }
 * article can be:
 * {
 *   $action: "$save" //Create a action control triggering an sdata action
 * }
 * article can be:
 * {
 *   $type: "footer" //Create a control by a type not backed up by sdata (e.g. panels or footer)
 * }
 */
exports.createControl = function(controller, article, parent, page, opts) {
	var ctrl;
	// Mandatory
	opts = $.extend(true, {}, opts);
	if (article.$bind) {
		ctrl = _createControl(controller, article, parent, opts);
	} else if (article.$layoutType) {
		ctrl = _createLayout(controller, article, parent, opts);
	} else if (article.$link) {
		ctrl = _createLink(controller, article, parent, opts);
	} else if (article.$action) {
		ctrl = _createAction(controller, article, parent, opts);
	} else if (article.$type) {
		ctrl = _createControlType(controller, article, parent, opts);
	}

	if (ctrl) {
		// Keep a reference to the page for every control so a control knows where it sits in
		ctrl.page = page || parent && parent.page;

		var $articleLocalization = article.$localization; // This will be only set if we are on the articles root level
		if (!$articleLocalization && parent) {
			$articleLocalization = parent.$articleLocalization;
		}
		if (!$articleLocalization) {
			$articleLocalization = {};
		}

		ctrl.$articleLocalization = $articleLocalization;
	}

	return ctrl;
};

/**
 * 
 * @param controller
 * @param article
 * @param parent
 * @param opts
 * @returns 
 */
function _createControl(controller, article, parent, opts) {
	var $bind = article.$bind;
	if (!controller.dataset.prototype.propExists($bind)) {
		return;
	}

	var $type = controller.dataset.prototype.propGetType($bind);
	var $format = controller.dataset.prototype.propGetFormat($bind);
	var ctor;
	var proto;
	//	console.log(controller.dataset.prototype.propGetProto($bind).getValueByPath("$title", true), controller.dataset.prototype.propGetProto($bind).json)
	switch ($type) {
		case "application/x-boolean":
			switch ($format) {
				case "$switch":
					ctor = CtrlSwitch;
					break;
				default:
					ctor = CtrlCheckbox;
					break;
			}
			break;

		case "application/x-choice":
			ctor = CtrlCombo;
			break;
		case "application/x-string":
		case "application/x-password":
			switch ($format) {
				case "$phone":
					ctor = CtrlPhone;
					break;
				case "$email":
					ctor = CtrlEmail;
					break;
				case "$url":
					ctor = CtrlUrl;
					break;
				default:
					ctor = CtrlAlphaNum;
			}
			break;
		case "application/x-reference":
			ctor = CtrlReference;
			break;

		case "application/x-integer":
		case "application/x-real":
		case "application/x-decimal":
		case "application/x-quantity":
			// "$numDisplay" is an authoring property used to select how to display numeric value (either "gauge" or "normal")
			// important in case we switch from "normal" to "gauge"
			if (!article.$gauge && article.$numDisplay === "gauge") {
				article.$gauge = {};
			}
			if (article.$gauge) {
				ctor = CtrlGaugeChart;
			} else {
				ctor = ($type === "application/x-quantity" ? CtrlQuantity : CtrlNumeric);
			}
			break;
		case "application/x-date":
		case "application/x-time":
		case "application/x-datetime":
			ctor = CtrlDate;
			break;
		case "application/x-array":
			proto = controller.dataset.prototype.propGetProto($bind);
			if (ctrlArrayFactory) {
				ctor = ctrlArrayFactory.createControl(controller, article, parent, opts);
			} else {
				if (proto.getValueByPath("$cube")) {
					// We always instantiate an ArrayChart because whatever $display chart/table/card...
					// ArrayChart manages the links to detail chart and is needed if we display a "$cube" as a table/card...
					ctor = CtrlChartArray;
				} else if (controller.dataset.prototype.propIsSingleArray($bind)) {
					// TODO: Make Simple array control
					ctor = ctrlComplexArray;
				} else {
					ctor = ctrlComplexArray;
				}
			}
			break;
		case "application/x-vignette":
			ctor = CtrlVignette;
			break;
		case "application/x-vignette-link":
			ctor = CtrlVignetteLink;
			break;
		case "image":
			ctor = CtrlImage;
			break;
		case "text/plain":
		case "text/rtf":
		case "text/html":
			ctor = CtrlText;
			break;
		default:
			ctor = CtrlTypeUnknown;
			break;
	}
	if (ctor) {
		proto = proto || controller.dataset.prototype.propGetProto($bind);
	}

	var ctrl;
	if (ctor && proto) {
		ctrl = new ctor(controller, article, proto, opts || {});
	}

	if (ctrl && parent) {
		parent.appendStructElmt(ctrl);
	}
	return ctrl;
}

/**
 * 
 * @param controller
 * @param article
 * @param parent
 * @param opts
 * @returns
 */
function _createLayout(controller, article, parent, opts) {
	var $type = article.$layoutType;
	var ctrl;
	var ctor;
	// compatibility stateless version hubGroup
	switch ($type.toLowerCase()) {
		case "stack":
			ctor = LayoutStack;
			break;
		case "row":
			ctor = LayoutRow;
			break;
		case "cell":
			ctor = LayoutCell;
			break;
		case "hub":
			ctor = LayoutHub;
			break;
		case "hubgroup":
			ctor = LayoutHubGroup;
			break;
		case "tile":
			ctor = LayoutTile;
			break;
		default:
			throw new Error("Unknown layout type [" + $type + "]")
			ctor = null;
			break;
	}

	if (ctor) {
		ctrl = new ctor(controller, $type, article, opts || {});
	}

	if (ctrl && parent) {
		parent.appendStructElmt(ctrl);
	}

	return ctrl;
}

/**
 * 
 * @param controller
 * @param article
 * @param parent
 * @param opts
 */
function _createLink(controller, article, parent, opts) {}

/**
 * 
 * @param controller
 * @param article
 * @param parent
 * @param opts
 */
function _createAction(controller, article, parent, opts) {}

/**
 * 
 * @param controller
 * @param article
 * @param parent
 * @param opts
 */
function _createControlType(controller, article, parent, opts) {
	var $type = article.$type;
	var ctor;
	var ctrl;
	switch ($type) {
		case "application/x-panel-footer-sdata-page":
			ctor = PanelFooterSdataPageTablet;
			break;

		case "application/x-panel-header-sdata-page-tablet":
			ctor = PanelHeaderSdataPageTablet;
			break;
		case "application/x-panel-header-sdata-page-smartphone":
			ctor = PanelHeaderSdataPageSmartphone;
			break;

		case "application/x-panel-actions":
			ctor = PanelActions;
			break;
		case "application/x-panel-global-smartphone":
			ctor = PanelGlobalSmartphone;
			break;
		case "application/x-panel-global-tablet":
			ctor = PanelGlobalTablet;
			break;
		case "application/x-panel-breadcrumbs-tablet":
			ctor = BreadcrumbsTablet;
			break;
		case "application/x-panel-filtersort":
			ctor = PanelSortFilter;
			break;
	}

	if (ctor) {
		ctrl = new ctor(controller, $type, article, opts);
	}
	return ctrl;
}