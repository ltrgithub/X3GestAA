"use strict";

var modules = require('syracuse-tablet/html/js/common/modules');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main", false);
var environment = require('syracuse-tablet/html/js/helpers/environment');

var waiting = require('syracuse-tablet/html/js/utils/waiting');
var native = require('syracuse-tablet/html/js/helpers/native/native');

var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');

var developmentPage = require('syracuse-tablet/html/js/helpers/developmentPage');

var initThirdParty = require('syracuse-tablet/html/js/init/initThirdParty');
var initStyles = require('syracuse-tablet/html/js/init/initStyles');
var uiSettings = require('syracuse-tablet/html/js/ui/uiSettings');
var initLocale = require('syracuse-tablet/html/js/init/initLocale');
var initModules = require('syracuse-tablet/html/js/init/initModules');
var initStorage = require('syracuse-tablet/html/js/init/initStorage');

var App = require('syracuse-tablet/html/js/app/appController').App;

var _nativeApp;

var _onError = function(error) {
	waiting.reset();
	try {
		modules.get("modal").asynchError(error);
	} catch (e) {
		alert(JSON.stringify(jsutils.convertToDiagnoses(error), null, 2));
	}
}

window.onerror = function(errorMsg, url, lineNumber, error) {
	var diag = {
		$diagnoses: [{
			$message: errorMsg,
			$stackTrace: "url:" + url + "\nLineNUmber:" + lineNumber + "\nError:" + error,
			$severity: "error"
		}]
	}
	_onError(diag);
};

$(document).ready(function() {
	if (document.location.href.indexOf("?circular") > -1) {
		_checkModuleDependencies();
	} else {
		_startApp()
	}
});

function _checkModuleDependencies() {
	xrayquire.showCycles(undefined, true);
}

function _startApp() {
	var sessionAvailable;
	var firstPage;
	var initTask = $.smResolve()
		.then(function() {
			return _initPlatform();
		})
		.then(function() {
			// When technical stuff is ready, we tell it to the wrapper if there is one
			_nativeApp && _nativeApp.notifLoaded();
		})
		.then(function() {
			return developmentPage.restoreOnStartup();
		})
		.then(function() {
			return App.init();
		})
		.then(function() {
			// returns true -> already logged in
			// "offline" when offline
			// "nosession" if we need to login first
			return _checkSession();
		})
		.then(function(_sessionAvailable) {
			sessionAvailable = _sessionAvailable;
		})
		.then(function() {
			firstPage = _defineFirstPage();
			log && log("First page to open: " + JSON.stringify(firstPage));
		});
	return waiting.waitModal(initTask)
		.then(function() {
			if (sessionAvailable === true) {
				return modules.get("appController").App.initApplicationsList()
					.then(function() {
						// firstPage to force home in case of error (bad url...)
						return modules.get("navHelper").gotoUrl(firstPage.url, firstPage.method, firstPage.options, {
							"firstPage": true
						});
					})
			} else {
				var offline = sessionAvailable === "offline";
				return modules.get("navHelper").gotoUrl("html://login", null, {
					"offline": offline,
					"onLogin": {
						"gotoUrl": firstPage
					}
				});
			}
		}).then(function() {
			modules.get("appController").App.applicationIsStarted()
		}).fail(function(e) {
			// needed there
			_onError(e)
		});

}

/**
 * Init low level stuff like locale, native wrapper, modules, ...
 * When this fails, it's a fatal error that cannot be resolved by the user
 */
function _initPlatform() {
	return $.smResolve()
		.then(function() {
			return initThirdParty.init();
		})
		.then(function() {
			return initModules.init();
		})
		.then(function() {
			return native.init();
		})
		.then(function() {
			// After native
			environment.init();
			_nativeApp = native.getModule("nativeApp");
		})
		.then(function() {
			return initStyles.init();
		})
		.then(function(detectedOS) {
			return uiSettings.init(detectedOS);
		})
		.then(function() {
			return initLocale.init();
		})
		.then(function() {
			return initStorage.init();
		});
}

/**
 * Check login session status and connectivity
 * 
 * Resolves with true, "nosession" to force login or "offline"
 * 
 */
function _checkSession() {
	var deferred = $.Deferred();
	var session = modules.get("session");
	var profile;
	var step;

	var nativeApp = native.getModule("nativeApp");
	if (nativeApp) {
		step = nativeApp.getReconnectToken()
			.then(function(loginCookie, sidCookie) {
				if (loginCookie || sidCookie) {
					return session.setReconnectToken(loginCookie, sidCookie);
				}
			});
	} else {
		step = $.smResolve();
	}

	step.then(function() {
			return session.getCurrentUserProfile()
		})
		.then(function(_profile) {
			profile = _profile;
			return App.setUserProfile(profile);
		})
		.then(function() {
			return session.storeUserProfile(profile);
		})
		.then(function() {
			// Fire and forget since we need the token on next login only
			session.nativeStoreReconnectToken();

			deferred.resolve(true);
		})
		.fail(function(result) {
			// Getting user profile failed because we are not authenticated, so it's ok
			if (result.unauthenticated === true) {
				deferred.resolve("nosession");
			} else if (result.offline === true) {
				deferred.resolve("offline");
			} else {
				// Any other error is a "real" failure
				deferred.reject(result);
			}
		});
	return deferred.promise();
}

/**
 * Check if the page to go to after login is given by the url or if we want to go to the home page
 */
function _defineFirstPage() {
	var url;
	var page;

	page = _checkNativeContext();
	if (page) {
		return page;
	}

	try {
		url = jsutils.parseURL(window.location.href);
	} catch (e) {}

	var query = url && url.query;
	var url = query.url;
	var method = query.method || "GET";

	if (url) {
		if (url.indexOf("$mobileProtocol") < 0) url += "&$mobileProtocol=workingcopy"
		page = {
			url: url,
			method: method,
			options: null,
			loadOptions: {
				firstPage: true
			}
		}
	} else {
		page = {
			url: "html://home"
		}
	}

	return page;
}

function _checkNativeContext() {
	if (_nativeApp) {
		log && log("Native app, check for context")
		var contextToRestore = _nativeApp.getReconnectContext();
		if (contextToRestore) {
			var obj;
			if (typeof contextToRestore === "string") {
				try {
					obj = JSON.parse(contextToRestore);
				} catch (e) {}
			} else {
				obj = contextToRestore;
			}
		}
		if (obj && obj.url) { // Sanity check
			var ctxString = JSON.stringify(obj);
			log && log("Native app, context: " + ctxString);
			return {
				url: "context://" + encodeURIComponent(contextToRestore),
				options: null,
				loadOptions: {
					firstPage: true
				}
			};
		}
	}
}