"use strict";

var modal = require('syracuse-tablet/html/js/ui/modals/modal');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var initStyles = require('syracuse-tablet/html/js/init/initStyles');
var initLocale = require('syracuse-tablet/html/js/init/initLocale');
var initModules = require('syracuse-tablet/html/js/init/initModules');
var initLogin = require('syracuse-tablet/html/js/init/initLogin');
var nativeApp = require('syracuse-tablet/html/js/helpers/native/nativeSageX3WUPApp');
var nativeJSCall = require('syracuse-tablet/html/js/helpers/native/nativeJSCall');

// Add Handlebars to root
window.Handlebars = require('syracuse-tablet/html/deps/handlebars-latest');
// Add our own helpers
require('syracuse-tablet/html/js/helpers/handlebarsHelpers').registerHelpers(window.Handlebars);
//Add jqm orientation
require('syracuse-tablet/html/deps/jqm-orientation');

window.onerror = function(errorMsg, url, lineNumber, error) {
	if (globals.application) {
		globals.application.waitWheelStop();
	} else {
		uiutils.waitWheelStop();
	}
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + jsutils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

function _startup() {
	// Register global callback methods that can be access by eventual wrapper
	nativeJSCall.init();
	
	return initStyles.init()
		.then(function() {
			return initLocale.init();
		})
		.then(function() {
			return initModules.init();
		})
		.then(function() {
			return initLogin.init();
		})
		.then(function() {
			// Send notification to wrapping application to signal all is loaded
			if (nativeApp.isSageX3WUPApp()) {
				nativeApp.notifLoaded();
			}
		}).fail(function(e) {
			// Send notification to wrapping application to signal something is wrong
			if (nativeApp.isSageX3WUPApp()) {
				nativeApp.notifStartFail("" + e);
			}
			modal.error("_startup error", e);
		});
}

$(document).ready(function() {
	if (document.location.href.indexOf("?circular") > -1) {
		xrayquire.showCycles(undefined, true);
	} else {
		_startup();
	}
});