"use strict";

var modal = require('syracuse-tablet/html/js/ui/modals/modal');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var initStyles = require('syracuse-tablet/html/js/init/initStyles');
var initLocale = require('syracuse-tablet/html/js/init/initLocale');
var initModules = require('syracuse-tablet/html/js/init/initModules');
var initLogin = require('syracuse-tablet/html/js/init/initLogin');
var nativeX3WUPApp = require('syracuse-tablet/html/js/helpers/native/native').getModule("X3WUPApp");
var nativeJSCall = require('syracuse-tablet/html/js/helpers/native/nativeJSCall');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");

var _fatalError = '<html><body style="font-family:Segoe UI Light,Segoe UI,Segoe WP,Helvetica Neue,sans-serif;font-size: 14px;"><H2>A fatal error occurred during initialization process</H2><p>{{#each $diagnoses}}<section style="border:red solid 1px;margin: 10px;padding: 10px;color: black;background-color: #FBE3E3;">{{#if $message}}<b>{{{$message}}}</b>{{/if}}{{#if $stackTrace}}<br><br>{{{$stackTrace}}}{{/if}}</section>{{/each}}</p></br></body></html>';
// Add Handlebars to root
window.Handlebars = require('syracuse-tablet/html/deps/handlebars-latest');
// Add our own helpers
require('syracuse-tablet/html/js/helpers/handlebarsHelpers').registerHelpers(window.Handlebars);
//Add jqm orientation
require('syracuse-tablet/html/deps/jqm-orientation');
// Add jquery.cookie
require('syracuse-tablet/html/deps/jquery.cookie');

log && log("main loaded");

window.onerror = function(errorMsg, url, lineNumber, error) {
	if (globals.application) {
		globals.application.waitWheelStop();
	} else {
		uiutils.waitWheelStop();
	}
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + jsutils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

function _startup() {
	log && log("main startup");

	// Register global callback methods that can be access by eventual wrapper
	nativeJSCall.init();
	return initStyles.init()
		.then(function() {
			uiutils.waitWheelStart();
			return initLocale.init();
		})
		.then(function() {
			return initModules.init();
		})
		.then(function() {
			return initLogin.init();
		})
		.then(function(loggedIn) {
			uiutils.waitWheelStop();
			if (nativeX3WUPApp) {
				// Send notification to wrapping application to signal all is loaded
				nativeX3WUPApp.notifLoaded();
			}
			// - user is logged in 	-> The welcome page is displayed
			if (!loggedIn) {
				// - user not logged in -> We display login page
				globals.getApplication().logout("login.authentication");
				return false;
			}
		}).fail(function(e) {
			uiutils.waitWheelStop();
			// Application is not necessary available
			if (globals.getApplication()) {
				globals.getApplication().logout().then(function() {
					// $logout$ means that the user clicked on logout in the selectContext dialog
					if (e != null && e.message !== "$logout$") {
						var locale = require('syracuse-tablet/html/js/helpers/locale');
						globals.getModal().error(locale.text("startup.error"), e);
						log && log(JSON.stringify(e));
						if (nativeX3WUPApp) {
							// Send notification to wrapping application to signal something is wrong
							nativeX3WUPApp.notifStartFail("" + e.message || "Startup error");
						}
					}
				});
			} else {
				$(document.body).empty();
				var diags = jsutils.convertToDiagnoses(e, true);
				window.document.write(Handlebars.compile(_fatalError)(diags));
			}
		});
}

$(document).ready(function() {
	log && log("main document ready");

	if (document.location.href.indexOf("?circular") > -1) {
		xrayquire.showCycles(undefined, true);
	} else {
		_startup();
	}
});