"use strict";

//Initialization Sage Mobile jQuery plugins and native prototype object  (add method)
require('syracuse-tablet/html/js/helpers/nativePrototypes');
require('syracuse-tablet/html/js/helpers/jqueryPlugins');
var modal = require('syracuse-tablet/html/js/ui/modal');
var templates = require('syracuse-tablet/html/js/helpers/templating');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var factory = require('syracuse-tablet/html/js/factories/appFactory');
var auth = require('syracuse-tablet/html/js/application/authentication');
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var pages = require('syracuse-tablet/html/js/pages/page');

window.onerror = function(errorMsg, url, lineNumber, error) {
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + utils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

var _initModules = function(lang, rsrc) {
	/* We need resources when we start application */
	locale.init(lang, rsrc);
	/* Init globals module - dvlpMode = true */
	globals.init(true);
	/* Utilities - needs globals */
	utils.init();
	/* templating initialization*/
	templates.init();
	/* pages management initialization*/
	pages.init();
	/* modal initialization - load modal templates*/
	modal.init();
};
var _init = function(lang, rsrc) {
	var fail = function(e, msg, callBack) {
		modal.error(locale.text('err.load.main'), utils.toDiagnose({
			where: "$(document).ready",
			message: msg,
			exception: e
		}), callBack);
	};
	try {
		log && log("Init application", "history.length=" + window.history.length);
		_initModules(lang, rsrc);
		auth.check().then(function(userLoggedIn) {
			/* Check succeeded */
			var app = factory.createApplication($("#application"));
			globals.setApplication(app);
			if (userLoggedIn) {
				log && log("user logged in");
				dispatcher.getUserProfile().then(function(profile) {
					/* Profile succeeded */
					notifications.publish("sm.login", profile);
				}, function(e) {
					/* Profile failed */
					fail(e, "Get user profile failed", function() {
						auth.logout().always(function() {
							app.changePage("login", {
								reason: "Can't read user profile, please try login again"
							});
						});
					});
				});
			} else {
				log && log("user not logged in");
				app.changePage("login", {
					reason: "Please enter your credentials"
				});
			}
		}, function(e) {
			/* Check rejected */
			fail(e, "Check login failed");
		});
	} catch (e) {
		fail(e, "Javascript exception");
	}
};

exports.main = function(lang, rsrc) {
	$(document).ready(function() {
		_init(lang, rsrc);
	});
};