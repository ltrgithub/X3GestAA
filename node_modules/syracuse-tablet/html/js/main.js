"use strict";

//Initialization Sage Mobile jQuery plugins
require('syracuse-tablet/html/js/helpers/jqueryPlugins');
var modal = require('syracuse-tablet/html/js/ui/modal');
var templates = require('syracuse-tablet/html/js/helpers/templating');
var log = require('syracuse-tablet/html/js/helpers/logger').log;
var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var factory = require('syracuse-tablet/html/js/factories/appFactory');

window.onerror = function(errorMsg, url, lineNumber, error) {
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + utils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

var _init = function(lang, rsrc) {
	try {
		log && log("Load", "history.length=" + history.length);
		// Remove templates on reload otherwise they not refreshed
		templates.removeTmpl();
		modal.init();
		locale.init(lang, rsrc);
		var app = factory.createApplication($("#application"));
		// Goto page
		app.changePage(window.location.hash).then(function(dstPage) {
			window.history.replaceState(dstPage.state, dstPage.state.uuid, "");
			log && log("Load after change page", "history.length=" + history.length);
			app.$elmt.show();
		});
	} catch (e) {
		modal.error(locale.text('err.load.main'), utils.toDiagnose({
			where: "$(document).ready",
			exception: e
		}));
	}
};

exports.main = function(lang, rsrc) {
	$(document).ready(function() {
		_init(lang, rsrc);
	});
};