"use strict";

//Initialization Sage Mobile jQuery plugins
require('syracuse-tablet/html/js/helpers/jqueryPlugins');
var modal = require('syracuse-tablet/html/js/helpers/modals');
var templates = require('syracuse-tablet/html/js/helpers/templating');
var log = require('syracuse-tablet/html/js/helpers/logger').log;
var utils = require('syracuse-tablet/html/js/helpers/utils');
var reqSite = require('syracuse-tablet/html/js/site/site');
var mockup = require('syracuse-tablet/html/js/site/mockup');

window.onerror = function(errorMsg, url, lineNumber, error) {
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + utils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

exports.main = function() {
	try {
		log && log("Load", "history.length=" + history.length);
		// Remove templates on reload otherwise they not refreshed
		templates.removeTmpl();
		// Create global site
		var site = reqSite.create($("#site"));
		if (site.config("mockup")) {
			// Load mockup templates
			mockup.init();
		}
		// Goto page
		reqSite.changePage(window.location.hash).then(function(dstPage) {
			window.history.replaceState(dstPage.state, dstPage.state.uuid, "");
			log && log("Load after change page", "history.length=" + history.length);
			site.$elmt.show();
		}, function(e) {
			alert("ERROR CHANGING PAGE");
		});
	} catch (e) {
		modal.error("Error loading page", utils.toDiagnose({
			where: "$(document).ready",
			exception: e
		}));
	}

};