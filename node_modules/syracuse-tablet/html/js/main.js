"use strict";

//Initialization Sage Mobile jQuery plugins and native prototype object  (add method)
var modal = require('syracuse-tablet/html/js/ui/modal');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');
var templates = require('syracuse-tablet/html/js/helpers/templating');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("main");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var appFactoryDeps = require('syracuse-tablet/html/js/application/appFactoryDeps');
var ctrlFactoryDeps = require('syracuse-tablet/html/js/controls/ctrlFactoryDeps');
var factory = require('syracuse-tablet/html/js/application/appFactory');
var auth = require('syracuse-tablet/html/js/application/authentication');
var sdataCommonRes = require('syracuse-tablet/html/js/sdata/sdataCommonResources');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var storage = require('syracuse-tablet/html/js/storage/storage');
var sdataCache = require('syracuse-tablet/html/js/sdata/sdataCache');

// not needed yet
//var fmt = require('syracuse-tablet/html/js/helpers/formatter');

// fully client side configured application to add tests later
var testApplication = require('syracuse-tablet/html/js/sdata/entities/test/testApplication');

window.onerror = function(errorMsg, url, lineNumber, error) {
	if (globals.application) {
		globals.application.waitWheelStop();
	} else {
		uiutils.waitWheelStop();
	}
	try {
		modal.error("Javascript error", {
			where: "window.onerror",
			exception: error,
			message: errorMsg + "\n" + (url ? "Url : " + utils.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
		});
	} catch (e) {
		var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
		alert(msg);
	}
};

var _initModules = function() {
	var st;
	var cache;
	var deferred = new $.Deferred();

	st = storage.getStorage();
	st.init()
		.then(function() {
			cache = new sdataCache.SDataCache(st);
		})
		.then(function() {
			globals.init(true, st, cache, utils);
			var newRoot = "/html";
			templates.setTmplRoot(newRoot);
			// No needs to putendpoint in url - Endpoint is selected at login or on default homepage
		})
		.then(function() {
			return appFactoryDeps.init();
		})
		.then(function() {
			return ctrlFactoryDeps.init();
		})
		.then(function() {
			return templates.init();
		})
		.then(function() {
			if (globals.isDvlpMode()) {
				testApplication.register();
			}
		})
		.then(function() {
			deferred.resolve();
		}, function(e) {
			deferred.reject(e);
		});

	return deferred.promise();
};

var _login = function() {
	var app;
	var fail = function(e, msg, callBack) {
		uiutils.waitWheelStop();
		modal.error(locale.text('err.load.main'), utils.toDiagnose({
			where: "$(document).ready",
			message: msg,
			exception: e
		}), callBack);
	};
	var gotoLogin = function(reason) {
		if (app) {
			app.changePage("login", {
				reason: reason
			});
		}
	};
	try {
		uiutils.waitWheelStart();
		log && log("Init application", "history.length=" + window.history.length);
		auth.check()
			.then(function(userLoggedIn) {
				/* Check succeeded */
				app = factory.createApplication($("#application"));
				globals.setApplication(app);
				if (userLoggedIn) {
					log && log("user logged in");
					sdataCommonRes.getUserProfile().then(function(profile) {
						/* Profile succeeded */
						notifications.publish("sm.login", profile);
						uiutils.waitWheelStop();
					}, function(e) {
						/* Profile failed */
						fail(e, "Get user profile failed", function() {
							auth.logout().then(function() {
								gotoLogin("Can't read user profile, please try login again");
							}, function(e) {
								fail(e, "Logout failed", function() {
									gotoLogin("Can't read user profile, please try login again");
								});
							});
						});
					});
				} else {
					uiutils.waitWheelStop();
					log && log("user not logged in");
					gotoLogin("Please enter your credentials");
				}
			}, function(e) {
				/* Check rejected */
				fail(e, "Check login failed");
			});
	} catch (e) {
		fail(e, "Javascript exception");
	}
};

function _startup() {
	var lang = "en-US";

	locale.setLocale(lang)
		.then(function() {
			return _initModules();
		})
		.then(function() {
			_login();
		}, function(e) {
			try {
				modal.error("_startup error", e);
			} catch (ex) {
				utils.alertError(e);
			}
		});
}

$(document).ready(function() {
	if (document.location.href.indexOf("?circular") > -1) {
		xrayquire.showCycles(undefined, true);
	} else {
		_startup();
	}
});