"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var authHelpers = require('syracuse-tablet/html/js/authoring/authoringHelpers');
var authHtml = require('syracuse-tablet/html/js/authoring/authoringHtml');
var environment = require('syracuse-tablet/html/js/helpers/environment');
var siteLayout = require('syracuse-tablet/html/js/ui/siteLayout');
var authCommons = require('syracuse-tablet/html/js/authoring/authoringCommons');

exports.Panel = utils.defineClass(function AuthoringPanelRight() {
	var self = this;
	self.$$panel = null;
	self.topButtons = [];
}, null, {
	show: function() {
		var self = this;

		self._ensurePanel();
		self._subscribe();

		self.$$panel.show();
		self.$$splitter.show();
		/* Min width for drag - self.$$splitter.width is 0 - We should improve that*/
		self._minWidth = 4 * siteLayout.splitterWidth;;
		self._initDefaults();

		$('#authPanelControl .btn', self.$$panelSave).eq(0).button("toggle");
		$('.nav-pills a[href="#authPanelControl"]').tab('show');
	},

	hide: function() {
		var self = this;
		self._ensurePanel();
		self.$$panel.hide();
		self.$$splitter.hide();
		self._unscribe();
		self.$$panel.empty();
		self.$$panel = null;
	},
	_subscribe: function() {
		var self = this;
		notifications.subscribe(self, ["sm.main.layout.changed"]);
		notifications.subscribe(self, ["sm.auth.set.page"]);
		notifications.subscribe(self, ["sm.auth.set.selection"]);
		notifications.subscribe(self, ["sm.auth.top.button"]);
	},

	_unscribe: function() {
		var self = this;
		notifications.unsubscribe(self, ["sm.main.layout.changed"]);
		notifications.unsubscribe(self, ["sm.auth.set.page"]);
		notifications.unsubscribe(self, ["sm.auth.set.selection"]);
		notifications.unsubscribe(self, ["sm.auth.top.button"]);
	},

	notifMainLayoutChanged: function() {
		var self = this;
		self.$$panel.find(".tab-content").css({
			"height": self.$$panel.height() - 100
		});
	},

	_ensurePanel: function() {
		var self = this;
		if (this.$$panel) {
			return;
		}

		var ctx = {
			label_design: locale.text("auth.panel.label_design"),
			label_openCardDesign: locale.text("auth.openCardDesign")
		};

		self.$$panel = $("#s-m-auth-panel-right-id");
		$(authHtml.execute("authPanelRightStructure", ctx)).appendTo(self.$$panel);

		self._getDomObjects();
		self._initSplitter();
		self._initDomEvents();
	},

	_getDomObjects: function() {
		var self = this;
		self.$$panelRightStruct = self.$$panel.find("#authPanelControlTitle");
		self.$$panelControlSimple = $("#authPanelControlSimple");
		self.$$panelControlExpert = $("#authPanelControlExpert");
		self.$$panelControlTitle = $("#authPanelControlTitle");
		self.$$panelControlType = $("#authPanelControlType");

		self.$$panelControlChild = $("#s-m-auth-child-design-open-id");

		self.$$panelEdit = $("#authPanelEdit");
	},

	_initDomEvents: function() {
		var self = this;
		self.$$panelControlChild.on("click", self._onChildClick.bind(self));
	},

	_initDefaults: function() {
		var self = this;
		self.$$panelControlTitle.text("");
		self.$$panelControlType.text(locale.text("auth.panel.label_design"));
		self.destroyPropertyPanel();
	},
	/**
	 * context	indicates the context of destroy: selection...
	 * 		origin	"selection" -> destroy called by a selection of ctrl.layout
	 * context is used by topButtons destroyButtonMarkup
	 * 		destroyButtonMarkup returns false if button has not been destroyed
	 * -> destroyButtonMarkup/createButtonMarkup facilitate the search for buttons properties
	 */
	destroyPropertyPanel: function(context) {
		if (this.topButtons) {
			var preserveButtons = [];
			this.topButtons.forEach(function(prop) {
				if (prop.destroyButtonMarkup) {
					if (prop.destroyButtonMarkup(context) === false) {
						preserveButtons.push(prop);
					};
				}
			});
			this.topButtons = preserveButtons;
		}
		if (this._propertyPanel) {
			this._propertyPanel.destroy();
			this._propertyPanel = null;
		}
	},

	notifAuthSetPage: function(page) {
		var self = this;
		self.currentPageName = page.getAuthoringName();
		self._initDefaults();
		self._checkDetailNavigation(null, null);
	},

	/**
	 * path = null to remove current selection
	 */
	notifAuthSetSelection: function(id) {
		var self = this;
		self.$$panelControlTitle.text("");
		self.$$panelControlType.text(locale.text("auth.panel.label_design"));

		var sel = id ? authHelpers.getSelectionById(id) : null;

		authHelpers.savePanelStates();
		self.destroyPropertyPanel({
			origin: "selection"
		});
		var data;
		if (sel) {
			data = authHelpers.getSelectionData(sel);
			if (data) {
				self.$$panelControlTitle.text(data.title || "");
				self.$$panelControlType.text(locale.text("auth.panel.label_design") + " " + (data.type || ""));
				var article = data.articleSelection;
				if (article) {
					this._propertyPanel = authHelpers.createPropertyPanel(self.$$panelControlSimple, sel, data);
				}

				if (environment.isAutoUITestMode()) {
					var id = data.control ? data.control.getUnitTestId() : data.page ? data.page.getPageName() : null;
					environment.getUnitTestMgr().authAddRightPanelId(self.$$panelControlTitle.parent(), id);
				}
			}
		}

		self._checkDetailNavigation(sel, data);
	},

	_initSplitter: function() {
		var self = this;
		self.$$splitter = $("#s-m-auth-splitter-right-id");
		self.$$splitter.draggable({
			axis: "x",
			stop: function(e, ui) {
				var $$splitter = $(this);
				var pos = $$splitter.position();
				var width = $$splitter.width();
				var panelRightSize = Math.max(self._minWidth, $(window).width() - pos.left - width);
				// Normally we should block on drag event
				$$splitter.css({
					left: ($(window).width() - panelRightSize - width) + "px"
				});
				authHelpers.triggerResizeInternal({
					layout: {
						authPanelRight: {
							width: panelRightSize
						}
					}
				});
			}
		});
	},
	/**
	 * Ad a button at the top of property panel
	 */
	notifAuthTopButton: function(action, prop) {
		if (!this.$$panelRightStruct || !prop.createButtonMarkup) return;
		this.topButtons.push(prop);
		this.$$panelRightStruct.after(prop.createButtonMarkup(this.getPage()));
	},

	_checkDetailNavigation: function(sel, data) {
		var self = this;
		var page = authCommons.getCurrentPage();
		if (page && !page.isCardDetail() && data && data.control && data.control.$display === "card") {
			self.$$panelControlChild.show();
		} else {
			self.$$panelControlChild.hide();
		}
	},
	_onChildClick: function() {
		notifications.publish("sm.auth.open.card.design");
	}
});