"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');

var _template = '\
	<div id="authPanel" draggable="true" class="modal-dialog"> \
		<div class="modal-content"> \
			<div class="modal-header"> \
				<h3 class="panel-title" id="authCode"></h3> \
			</div> \
			<div class="modal-body"> \
				<textarea  id="authJSON" type="text" \
			    rows="20">{{article}}</textarea> \
			    <div class="modal-footer"> \
					<button type="button" id="authPanelSave" class="btn">Save</button> \
					<button type="button" id="authPanelClose" class="btn btn-default">Close</button> \
					<button type="button" id="authPanelApply" class="btn ">Apply</button> \
				</div> \
			</div> \
		</div> \
	</div>';

var _authInterface;

var AuthInterface = utils.defineClass(function() {
	var self = this;
	self.$$authPanel = null;
	self.authPanelTemplate = Handlebars.compile(_template);
}, null, {
	showAuthoringPanel: function() {
		var self = this;

		self._showAuthPanel();
		self._displayAuth(globals.getApplication().currentPage);
	},

	notifPageLoaded: function(page) {
		var self = this;
		if (page && !page.isVignette) {
			self._displayAuth(page);
		}
	},

	_displayAuth: function(page) {
		var self = this;
		self.$$authCode.text(page.state.authoringName);
		self.$$authJSON.text(JSON.stringify(page.article, null, "  "));
	},

	_showAuthPanel: function() {
		var self = this;
		notifications.subscribe(self, ["sm.page.loaded"]);
		self._ensureAuthPanel();
		self.$$authPanel.show();
	},
	_hideAuthPanel: function() {
		var self = this;
		self._ensureAuthPanel();
		self.$$authPanel.hide();
		notifications.unsubscribe(self, ["sm.page.loaded"]);
	},
	_ensureAuthPanel: function() {
		var self = this;
		if (this.$$authPanel) {
			return;
		}
		var ctx = {};
		self.$$authPanel = $(self.authPanelTemplate(ctx));
		$("body").append(self.$$authPanel);
		self.$$authJSON = $("#authJSON");
		self.$$authCode = $("#authCode");

		$("#authPanelSave").bind("click", self._onSave.bind(self));
		$("#authPanelClose").bind("click", self._onClose.bind(self));
		$("#authPanelApply").bind("click", self._onApply.bind(self));
	},
	_onSave: function() {
		var self = this;
	},
	_onApply: function() {
		var self = this;
	},
	_onClose: function() {
		var self = this;
		self._hideAuthPanel();
	}
});

exports.startDesignPage = function() {
	if (!_authInterface) {
		_authInterface = new AuthInterface();
	}

	_authInterface.showAuthoringPanel();
};