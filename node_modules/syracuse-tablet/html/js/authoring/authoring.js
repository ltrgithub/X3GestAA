"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var locale = require('syracuse-tablet/html/js/helpers/locale');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var authHelpers = require('syracuse-tablet/html/js/authoring/authoringHelpers');
var modal = require('syracuse-tablet/html/js/ui/modal');
var authProps = require('syracuse-tablet/html/js/authoring/authoringProperties');
var authHtml = require('syracuse-tablet/html/js/authoring/authoringHtml');
var uiutils = require('syracuse-tablet/html/js/ui/uiUtils');

var _authInterface;
exports.startDesignPage = function() {
	if (!_authInterface) {
		_authInterface = new AuthInterface();
	}

	_authInterface.showAuthoringPanel();
};

var AuthInterface = utils.defineClass(function() {
	var self = this;
	self.$$authPanel = null;
	self.$$pageContent = $(".s-m-page.s-m-full > section.s-m-main-content");
}, null, {
	showAuthoringPanel: function() {
		var self = this;

		if (self._isVisible()) {
			self._hideAuthPanel();
		} else {
			self._showAuthPanel();
			self._displayAuth(globals.getApplication().currentPage);
		}
	},

	notifPageLoaded: function(page) {
		var self = this;
		if (!self._isVisible()) {
			return;
		}

		if (page && page.state && page.state.disableAuthoring) {
			authHelpers.disableAuthCss();
			self._hideAuthPanel();
			return;
		}

		if (page && !page.isVignette) {
			self._displayAuth(page);
			self._elementSelectionChanged();
		}
		self._hookDOMEvents();
	},

	notifMainLayoutChanged: function() {
		var self = this;
		self.$$authPanelRight.find(".tab-content").css({
			"height": self.$$authPanelRight.height() - 100
		});
	},

	// Called by panel if a property like color has been changed using the simple ui
	notifAuthChangePropUi: function(sel, data) {
		var self = this;
		var articlePage = authHelpers.toSortedJSON(data.articlePage);
		var articleSelection = authHelpers.toSortedJSON(data.articleSelection);
		self.$$authJSONPage.val(articlePage);
		self._updateLayoutPage(sel);
	},

	notifAuthChangeSelection: function(sel) {
		var self = this;
		self._elementSelectionChanged(sel);
	},

	_hookDOMEvents: function() {
		var self = this;
		authHelpers.disableAuthCss();
		authHelpers.enableAuthCss();
	},
	_initJSONArticles: function() {
		var self = this;
		self.$$authJSONPage.val("");
		self.$$authPanelControlTitle.text("");
		self.$$authPanelControlType.text("");
		authHelpers.destroyPropertyPanel(self.$$authPanelControlSimple);
	},
	_displayAuth: function(page) {
		var self = this;
		self.currentPageName = page.state.authoringName;
		self.$$authPageName.text(self.currentPageName);
		self.$$authJSONPage.val(authHelpers.toSortedJSON(page.article));
	},

	_showAuthPanel: function() {
		var self = this;

		self._ensureAuthPanel();
		self.$$authPanelRight.show();
		self.$$authSplitterRight.show();
		$('.btn', self.$$authPanelSave).eq(0).button("toggle");
		$('.nav-pills a[href="#authPanelControl"]').tab('show');
		self._hookDOMEvents();
		self._initJSONArticles();

		self.$$pageContent.css({
			right: self.$$authPanelRight.width() + 10
		});
		authProps.initProperties(authHelpers);
		uiutils.triggerResizeInternal();
	},
	_hideAuthPanel: function() {
		var self = this;
		self._ensureAuthPanel();
		var w = self.$$authPanelRight.width();
		self.$$authPanelRight.hide();
		self.$$authSplitterRight.hide();
		self.$$pageContent.css({
			right: 0
		});
		$("#s-m-app-id").css("padding-right", "0px");
		authHelpers.disableAuthCss();
		uiutils.triggerResizeInternal();
	},
	_ensureAuthPanel: function() {
		var self = this;
		if (this.$$authPanel) {
			return;
		}

		var ctx = {
			label_control: locale.text("auth.panel.label_control"),
			label_edit: locale.text("auth.panel.label_page"),
			label_save: locale.text("auth.panel.label_save"),
			label_close: locale.text("auth.panel.label_close"),
			label_apply: locale.text("auth.panel.label_apply"),

			label_simple: locale.text("auth.panel.label_simple"),
			label_expert: locale.text("auth.panel.label_expert"),

			label_code: locale.text("auth.panel.label_code"),
			label_title: locale.text("auth.panel.label_title"),
			label_description: locale.text("auth.panel.label_description"),
			label_saveas_option: locale.text("auth.panel.label_saveas_option"),
			label_personal: locale.text("auth.panel.label_personal"),
			label_global: locale.text("auth.panel.label_global"),
			label_factory: locale.text("auth.panel.label_factory"),

			label_control_title: locale.text("auth.panel.label_control_title"),
			label_control_type: locale.text("auth.panel.label_control_type"),


			authCodeDefault: locale.text("auth.panel.authCodeDefault"),
			authTitleDefault: locale.text("auth.panel.authTitleDefault"),
			authDescriptionDefault: locale.text("auth.panel.authDescriptionDefault")
		};

		self.$$authPanelRight = $("#s-m-auth-panel-right-id");
		self.$$authPanel = $(authHtml.execute("authPanelMainStructure", ctx));
		self.$$authPanelRight.append(self.$$authPanel);
		self._getDomObjects();
		self._initSplitter();

		$("#authPanelBtnSave").on("click", self._onSave.bind(self));
		$("#authPanelBtnPageApply").on("click", self._onApplyPage.bind(self));

		notifications.subscribe(self, ["sm.page.loaded"]);
		notifications.subscribe(self, ["sm.main.layout.changed"]);
		notifications.subscribe(self, ["sm.auth.change.selection"]);
		notifications.subscribe(self, ["sm.auth.change.prop.ui"]);
	},
	_getDomObjects: function() {
		var self = this;
		self.$$authJSONPage = $("#authJSONPage");
		self.$$authPanelControlSimple = $("#authPanelControlSimple");
		self.$$authPanelControlExpert = $("#authPanelControlExpert");
		self.$$authPageName = $("#authPageName");
		self.$$authCode = $("#authCode");
		self.$$authTitle = $("#authTitle");
		self.$$authDescription = $("#authDescription");
		self.$$authPanelControlTitle = $("#authPanelControlTitle");
		self.$$authPanelControlType = $("#authPanelControlType");

		self.$$authPanelEdit = $("#authPanelEdit");
		self.$$authPanelSave = $("#authPanelSave");
	},
	_elementSelectionChanged: function(sel) {
		var self = this;
		self.$$authPanelControlTitle.text("");
		self.$$authPanelControlType.text("");

		authHelpers.savePanelStates();
		authHelpers.destroyPropertyPanel(self.$$authPanelControlSimple);
		if (!sel) {
			return;
		}
		var data = authHelpers.getSelectionData(sel);
		self.$$authPanelControlTitle.text(data.title);
		self.$$authPanelControlType.text(data.type);
		var article = data && data.articleSelection;
		if (article) {
			authHelpers.createPropertyPanel(self.$$authPanelControlSimple, sel, data);
		}
	},
	_updateLayoutPage: function(sel) {
		var self = this;
		var page = globals.getApplication().currentPage;
		var article = self.$$authJSONPage.val();
		var articleParsed = authHelpers.validateJSON(true, article);
		if (!articleParsed) {
			return;
		}

		authHelpers.savePanelStates();
		page.updateLayout(articleParsed)
			.then(function() {
				self._hookDOMEvents();
				// Since page has re-rendered, apply selection again
				if (sel) {
					authHelpers.selectElement(sel, false);
					var data = authHelpers.getSelectionData(sel);
					authHelpers.refreshPropertyPanels(sel, data);
				}
			})
			.fail(function(e) {
				modal.error("Error", e);
			});

	},
	_onSave: function() {
		var self = this;
		var article = self.$$authJSONPage.val();
		var articleParsed = authHelpers.validateJSON(true, article);
		if (!articleParsed) {
			return;
		}

		authHelpers.saveAuthoring(self.currentPageName, {
			code: self.$$authCode.val(),
			title: self.$$authTitle.val(),
			description: self.$$authDescription.val(),

			// "factory_variant", "personal_copy", "global_variant"
			// -> "shared_copy" not yet supported
			saveAs: $("input:radio:checked", self.$$authPanelSave)[0].id,
			article: articleParsed
		});
	},
	_onApplyPage: function() {
		var self = this;
		self._updateLayoutPage();
	},
	_onClose: function() {
		var self = this;
		self._hideAuthPanel();
	},
	_isVisible: function() {
		var self = this;
		return self.$$authPanelRight && self.$$authPanelRight.is(":visible");
	},
	_initSplitter: function() {
		var self = this;
		self.$$authSplitterRight = $("#s-m-auth-splitter-right-id");
		self.$$authSplitterRight.draggable({
			axis: "x",
			stop: function(e, ui) {
				var $$splitter = $(this);
				var pos = $$splitter.position();
				var width = $$splitter.width();
				var panelRightSize = $(window).width() - pos.left - width;
				uiutils.triggerResizeInternal({
					layout: {
						authPanelRight: {
							width: panelRightSize
						}
					}
				});
			}
		});
	}
});