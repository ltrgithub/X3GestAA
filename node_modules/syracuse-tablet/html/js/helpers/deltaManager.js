"use strict";


function _isVariantArray(list) {
	var first = list && list.length > 0 ? list[0] : null;
	if (first) {
		if (first.$uuid == undefined) {
			if (typeof(first) == 'object' && Object.keys(first).length == 1) {
				return true;
			}
		}
	}
	return false;
}

function _ensureServerIndex(list) {
	if (_isVariantArray(list)) {
		for (var ii = 0, jj = list.length; ii < jj; ii++) {
			var record = list[ii];
			if (typeof(record) == 'object') {
				record[Object.keys(record)[0]].$serverIndex = ii;
			}
		}
	} else {
		if (list.length && typeof(list[0]) == 'object' && list[0].$uuid !== undefined) {
			for (var ii = 0, jj = list.length; ii < jj; ii++) {
				list[ii].$serverIndex = ii;
			}
		}
	}
}

function _applyPageRecordDelta(options, record, subRecord, targetMap, targetList, variantKey) {
	if (subRecord.$uuid !== undefined) {
		if (!subRecord.$isDeleted) {
			if ((subRecord.$uuid !== undefined) && targetMap[subRecord.$uuid]) {
				if (variantKey) {
					var newNecord = _applyObjectDelta(options, targetMap[subRecord.$uuid], subRecord);
					record = {};
					record[variantKey] = newNecord;
					targetList.push(record);
				} else {
					targetList.push(_applyObjectDelta(options, targetMap[subRecord.$uuid], subRecord));
				}
			} else {
				targetList.push(record);
			}
		}
	} else {
		targetList.push(record);
	}
}

function _applyObjectArrayDelta(options, targetList, sourceList) {
	if (sourceList) {
		if (targetList.length == sourceList.length) {
			for (var ii = 0, jj = sourceList.length; ii < jj; ii++) {
				_applyObjectDelta(options, targetList[ii], sourceList[ii]);
			}
		} else {
			targetList.splice(0, targetList.length);
			for (var ii = 0, jj = sourceList.length; ii < jj; ii++) {
				targetList.push(sourceList[ii]);
			}
		}
	}
	return targetList;
}

function _applyObjectDelta(options, target, source, isObjectDelta) {
	options = options || {};
	if (source) {
		var properties = Object.keys(source);
		var isData;
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			isData = property.charAt(0) != "$";
			var targetValue = target[property];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (!(targetValue == null || sourceValue === null)) {
					if (Array.isArray(sourceValue)) {
						// isData: applyPageArrayDelta only for data not for meta-data
						if (isObjectDelta || !isData) {
							sourceValue = _applyObjectArrayDelta(options, targetValue, sourceValue);
						} else {
							if (options.$isEditMode || options.$isPartialDelta) {
								// applyPageArrayDelta update the targetValue by comparison of $uuids
								sourceValue = exports.applyPageArrayDelta(options, targetValue, sourceValue);
							}
						}
					} else {
						sourceValue = _applyObjectDelta(options, targetValue, sourceValue, isObjectDelta);
					}
				}
				if (Array.isArray(sourceValue) && isData) {
					_ensureServerIndex(sourceValue);
				}
			}
			target[property] = sourceValue;
		}
	}
	return target;
}


exports.cleanServerIndex = function(source) {
	if (source && (typeof(source) == 'object')) {
		if (Array.isArray(source)) {
			for (var ii = 0, jj = source.length; ii < jj; ii++) {
				exports.cleanServerIndex(source[ii]);
			}
		} else {
			delete source.$serverIndex;
			var properties = Object.keys(source);
			for (var ii = 0, jj = properties.length; ii < jj; ii++) {
				exports.cleanServerIndex(source[properties[ii]]);
			}
		}
	}
	return source;
};

exports.applyObjectDelta = _applyObjectDelta;

exports.applyPageArrayDelta = function(options, targetList, sourceList) {
	options = options || {};
	if (sourceList) {
		var targetMap = {};
		var isVariant = _isVariantArray(sourceList);
		if (options.$isPartialDelta || (sourceList.length == 1 && sourceList[0].$index !== undefined)) {
			var found, foundIndex;
			for (var ii = 0, jj = sourceList.length; ii < jj; ii++) {
				found = null;
				var sourceRecord = sourceList[ii];
				foundIndex = 0;
				for (var mm = targetList.length; foundIndex < mm; foundIndex++) {
					found = targetList[foundIndex];
					if (found.$uuid == sourceRecord.$uuid) {
						break;
					} else {
						found = null;
					}
				}
				if (found) {
					if (sourceRecord.$isDeleted) {
						targetList.splice(foundIndex, 1);
					} else {
						_applyObjectDelta(options, found, sourceRecord);
						if (sourceRecord.$index !== undefined && sourceRecord.$index != foundIndex) {
							targetList.splice(foundIndex, 1);
							targetList.splice(sourceRecord.$index, 0, found);
							delete found.$index;
						}
					}
				} else {
					if (!sourceRecord.$isDeleted) {
						if (sourceRecord.$index !== undefined) {
							targetList.splice(sourceRecord.$index, 0, sourceRecord);
						} else {
							targetList.push(sourceRecord);
						}
					}
				}
			}
		} else {
			for (var ii = 0, jj = targetList.length; ii < jj; ii++) {
				var record = targetList[ii];
				if (record) {
					if (record.$uuid !== undefined) {
						targetMap[record.$uuid] = record;
					} else {
						if (isVariant) {
							record = record[Object.keys(record)[0]];
							if (record.$uuid !== undefined) {
								targetMap[record.$uuid] = record;
							}
						}
					}

				}
			}
			targetList = [];
			for (var ii = 0, jj = sourceList.length; ii < jj; ii++) {
				var record = sourceList[ii];
				if (isVariant) {
					var variantKey = Object.keys(record)[0];
					_applyPageRecordDelta(options, record, record[variantKey], targetMap, targetList, variantKey);
				} else {
					_applyPageRecordDelta(options, record, record, targetMap, targetList);
				}

			}
		}
	}
	return targetList;
};