"use strict";

var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

var _currentLocale = null;
var _resources = {};

exports.getString = function(key, args) {
	var text = _getString(key);
	if (args) {
		text = text.replace(/\{([\w-]+)\}/g, function(match, p1) {
			var idx = +p1;
			if (idx > 0 && idx < args.length) {
				return args[idx];
			}
			return "?";
		});
	}

	return text;
};

exports.setLocale = function(locale, cb) {
	var deferred = new $.Deferred();
	if (locale === _currentLocale) {
		deferred.resolve();
		return;
	}
	var resources = _resources && _resources[locale];
	if (resources) {
		_currentLocale = locale;
		deferred.resolve();
		return;
	}
	var result = ajax("GET", "/syracuse-tablet/html/js/resources/strings-" + locale + ".json", null, null);
	result.then(function(data) {
		_currentLocale = locale;
		_resources[locale] = data;
		deferred.resolve();
	});
	return deferred.promise();
};

function _getString(key) {
	var resources = _resources && _resources[_currentLocale];
	return resources && resources[key];
}