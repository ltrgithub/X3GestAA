"use strict";

var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

var _currentLocale = null;
var _resources = {};

var _txtRegexp = /\{([\w-]+)\}/g;

var _getString = function(key, args, nbTries) {
	var resources = _resources && _resources[_currentLocale];
	if (!resources) {
		if (nbTries === undefined) {
			// Maybe resource has not been loaded yet	
			setTimeout(function() {
				_getString(key, args, nbTries, 1);
			}, 1000);
		} else {
			return "No resources loaded";
		}
		return;
	}
	var text = resources[key] || "Resource key not found[" + key + "]";

	if (args) {
		text = text.replace(_txtRegexp, function(match, p1) {
			var idx = +p1;
			if (idx > 0 && idx < args.length) {
				return args[idx];
			}
			return "?";
		});
	}

	return text;
};

var _setLocale = function(locale, cb) {
	var deferred = new $.Deferred();
	if (locale === _currentLocale) {
		deferred.resolve();
		return;
	}
	var resources = _resources && _resources[locale];
	if (resources) {
		_currentLocale = locale;
		deferred.resolve();
		return;
	}
	var result = ajax("GET", "/syracuse-tablet/html/js/resources/strings-" + locale + ".json", null, null);
	result.then(function(data) {
		_currentLocale = locale;
		_resources[locale] = data;
		deferred.resolve();
	});
	return deferred.promise();
};

var _init = function(rsrc, rsrclang) {
	if (rsrc) {
		_currentLocale = rsrclang;
		_resources[rsrclang] = rsrc;
	}
};
exports.init = _init;
exports.setLocale = _setLocale;
exports.getString = _getString;
exports.text = _getString;