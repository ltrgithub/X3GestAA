"use strict";

var ajax = require('syracuse-tablet/html/js/common/ajax');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');

var defaultLifeSpan = 10 * 24; // hrs to keep context in database

exports.storeSharedContext = function(context) {
	return ajax.request(
			"/sdata/syracuse/collaboration/syracuse/mobileSharedContexts?representation=mobileSharedContext.$edit",
			"POST", {
				linkCtx: JSON.stringify(context),
				lifespan: defaultLifeSpan
			}
		)
		.then(function(result) {
			return result.data.$uuid;
		});
}

exports.readSharedContext = function(uuid) {
	var deferred = $.Deferred();
	ajax.request("/sdata/syracuse/collaboration/syracuse/mobileSharedContexts('" + uuid + "')?representation=mobileSharedContext.$details")
		.then(function(result) {
			var data = result.data && result.data.linkCtx;
			var obj = null;
			try {
				obj = data && JSON.parse(data);
			} catch (e) {}

			deferred.resolve(obj);
		})
		.fail(function() {
			deferred.resolve(null);
		});

	return deferred.promise();
}

exports.createContextFromPage = function(page) {
	return {
		$url: page.pageData.$url,
		$method: page.pageData.$method,
		$savedCtx: page.savedCtxCreate()
	};
}

exports.createPageLoadDataFromContext = function(context) {
	return {
		$url: context.$url,
		$method: context.$method,
		pageOptions: {
			savedCtx: context.$savedCtx
		}
	};
}

/*
 *  Returns navigation url for deeplinks with client running in native environment like
 *  contextId://d85034ee-ff85-4ada-8ed6-ee36e72bacc6"
 */
exports.getNavContextUrlByPage = function(page) {
	return $.smResolve()
		.then(function() {
			return exports.createContextFromPage(page)
		})
		.then(function(context) {
			return exports.storeSharedContext(context)
		})
		.then(function(uuid) {
			return "contextId://" + uuid
		});
}

/*
 *  Returns full url for loading the client in the browser like
 *  "http://192.168.66.1:8123/syracuse-tablet/html/index_debug.html?url=contextId%3A%2F%2Fd85034ee-ff85-4ada-8ed6-ee36e72bacc6"
 */
exports.getFullContextUrlByPage = function(page) {
	return $.smResolve()
		.then(function() {
			return exports.createContextFromPage(page)
		})
		.then(function(context) {
			return exports.storeSharedContext(context)
		})
		.then(function(uuid) {
			return _getOpenContextUrl(uuid);
		});
}

/**
 * Returns the url that will contain the current page context to restore (ctx) (links, live tiles...)
 */
function _getOpenContextUrl(ctxUuid) {
	var url = $.extend({}, jsutils.getCurrentUrl());
	if (ctxUuid) {
		if (!url.query) {
			url.query = {};
		}
		url.query.url = "contextId://" + ctxUuid;
	}
	return jsutils.urlToString(url);
};