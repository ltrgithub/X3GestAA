"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var modal = require('syracuse-tablet/html/js/ui/modal');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("app");
var BreadCrumb = require('syracuse-tablet/html/js/application/breadcrumb').BreadCrumb;
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var userCtx = require('syracuse-tablet/html/js/application/userContext');
var auth = require('syracuse-tablet/html/js/application/authentication');
var eventListener = require('syracuse-tablet/html/js/application/eventListener');
var pageLoader = require('syracuse-tablet/html/js/application/pageLoader');

var _subscribe = function(self) {
	notifications.subscribe(self, ["sm.login", "sm.logout", "sm.switch.app", "sm.modal.open", "sm.modal.close"], 1);
};
var _Application = utils.defineClass(
	function($$elmt, factory) {
		var self = this;
		self.breadCrumb = new BreadCrumb();
		self.$$elmt = $$elmt;
		self.currentPage = null;
		self.uuid = null;
		self.homePageId = "defhome";
		self._$config = {
			transition: null,
			openLinkInVignette: false
		};
		self.factory = factory;
		self._pageLoader = null;
		self._nbModals = 0;
	}, null, {
		/**
		 * Called after object has been created
		 **/
		init: function() {
			var self = this;
			// Can't be called in constructor
			eventListener.bindEvents(self);
			self.dao = self.factory.createDaoApp(self);
			_subscribe(self);
			self.$$elmt.show();
		},

		destroy: function() {
			var self = this;
			if (self.breadCrumb) self.breadCrumb.destroy();
			self.breadCrumb = null;
			notifications.unsubscribe();
			self.removeAllPages();
			self.currentPage = null;
			if (self._pageLoader = null) {
				self._pageLoader.destroy();
				self._pageLoader = null;
			}
			utils.unbindObj(self);
			utils.unbindObj(self.$$elmt);
			$(window).unbind();
		},

		getTitle: function() {
			return this.dao.getApplicationName();
		},

		/**
		 * User logged in
		 */
		_activate: function() {
			var self = this;
			log && log("Activate application");
			if (self.dao.isApplicationLoaded()) {
				log && log("Application loaded -> Goto appication home");
				self.gotoHome();
			} else {
				self.homePageId = "defhome";
				self.uuid = null;
				log && log("No application loaded -> Goto default home");
				/* redirect to home page */
				self.gotoHome();
			}
		},

		gotoHome: function() {
			var self = this;
			setTimeout(function() {
				self.changePage(self.homePageId || "defhome");
			});
		},

		$config: function(id) {
			return this._$config[id];
		},
		/**
		 * User has selected a new Syracuse mobile application
		 * appInfo json description of application
		 */
		notifSwitchApp: function(appInfo) {
			var self = this;
			/* Todo - check if application changed with id and timestamp */
			if (!appInfo) throw new Error("NULL appInfo");
			log && log("Switch to Syracuse Mobile Application " + appInfo.$application.applicationName);
			self.dao.setApplicationDesc(appInfo);
			self.homePageId = self.dao.getHomeDashboard() || "defhome";
			self.uuid = appInfo.$uuid;
			self.removeAllPages();
			self.gotoHome();
		},
		/**
		 * User logged in with success
		 */
		notifLogin: function(userProfile) {
			var self = this;
			if (!userProfile) throw new Error("NULL userProfile");
			var user = userCtx.create(userProfile);
			globals.setUserCtx(userProfile);
			self._activate();
		},

		notifLogout: function() {
			log && log("Application Notification Logout");
			globals.setUserCtx(null);
		},

		notifModalOpen: function() {
			this._nbModals++;
			// console.log("notifModalOpen nbModals=" + this._nbModals)	
		},

		notifModalClose: function() {
			this._nbModals = Math.max(this._nbModals - 1, 0);
			// console.log("notifModalClose nbModals=" + this._nbModals)
		},

		hasModalOpen: function() {
			//  console.log("_nbModals=" + this._nbModals)
			return this._nbModals > 0;
		},

		_actBreadCrumb: function() {
			this.breadCrumb.display();
		},

		_actReload: function() {
			window.location.reload();
		},

		/* Actions processed by application */
		_actBack: function() {
			window.history.back();
		},

		/* Actions processed by application */
		_actLogout: function() {
			var deferred = $.Deferred();
			var self = this;
			modal.confirm("logout", function(confirmed) {
				if (confirmed) {
					self.waitWheelStart();
					auth.logout().then(function(ok, message) {
						if (ok) {
							notifications.publish("sm.logout");
							deferred.resolve({
								page: "login"
							});
							self.waitWheelStop();
						} else {
							self.waitWheelStop();
							modal.error(message, function() {
								deferred.resolve(null);
							});
						}
					}, function(e) {
						self.waitWheelStop();
						modal.error("Logout error", e, function() {
							deferred.resolve(null);
						});
					});
				} else {
					deferred.resolve(null);
				}
			});
			return deferred.promise();
		},

		_actClearCache: function() {
			var self = this;
			var deferred = $.Deferred();
			modal.confirm("clearCache", function(confirmed) {
				if (confirmed) {
					self.waitWheelStart();
					globals.getCache().clearCache().always(function() {
						self.waitWheelStop();
						deferred.resolve(null);
					});
				} else {
					deferred.resolve(null);
				}
			});
			return deferred.promise();
		},

		back: function(state) {
			var self = this;
			log && log("back", "start", "\n" + JSON.stringify(state, null, 2));
			if (!state) throw new Error("Back", "Unexpected null history state");
			return self._gotoPage(pageLoader.stateDeserialize(state), true);
		},

		_gotoPage: function(state, back) {
			var self = this;
			if (!self._pageLoader) {
				/**
				 * Page loader shared with vignette
				 * Load a page
				 */
				self._pageLoader = new pageLoader.Klass({
					waitStop: function() {
						self.waitWheelStop();
					},
					getRootElmt: function() {
						return self.$$elmt;
					},
					waitStart: function() {
						self.waitWheelStart();
					},
					getCurrentPage: function() {
						return self.currentPage;
					},
					setCurrentPage: function(page) {
						self.currentPage = page;
						if (page.state.home) {
							// Destroy all cached pages except current home page
							self.removeAllPages(page);
						}
					},
					setHistory: function(state) {
						// Store page in browser history to enable back - accepts only json objects
						state = pageLoader.stateSerialize(state);
						window.history.pushState(state, state.uuid, null);
						log && log("pushState", state.uuid, "history.length=" + window.history.length);
					}
				});
			}
			return self._pageLoader.load(state, back);
		},
		/**
		 * arguments : Pages to exclude
		 **/
		removeAllPages: function() {
			var self = this;
			var exclude = arguments;
			if (!self.$$elmt) return;
			self.$$elmt.find(".page").each(function(idx) {
				var page = $(this).smPageController();
				if (page && Array.prototype.indexOf.call(exclude, page) == -1) {
					page.destroy();
				}
			});
		},
		/** state - name of the page or history state object
		 * Option noverride standard pageInfo and allows to store a context
		 **/
		changePage: function(state, options) {
			var self = this;
			if (typeof state === "string") {
				log && log("changePage", state);
			}
			return self._gotoPage(self.getPageInfo(state, options));
		},

		/**
		 * Refresh current page - called from eventListener
		 */
		refreshPage: function(options) {
			var self = this;
			if (!self.currentPage) throw new Error("No current page");
			self.currentPage.refresh(options).then(function() {
				//	Eventually do something in vignette control	
			}, function(e) {
				modal.error("Refresh page", e);
			});;
		},

		getPageInfo: function(state, options) {
			return this.dao.getPageInfo(state, options);
		},

		// fullName: x3.erp.SUPERV.AQMCRUD.$details
		getPrototype: function(fullName) {
			var self = this;
			return self.dao.getPrototype(fullName);
		},

		/**
		 * One waiting plugin per page
		 */
		waitWheelStart: function() {
			if (!this.currentPage) return;
			this.currentPage.waitWheelStart();
		},
		waitWheelStop: function() {
			if (!this.currentPage) return;
			this.currentPage.waitWheelStop();
		}

	});


exports.Application = _Application;