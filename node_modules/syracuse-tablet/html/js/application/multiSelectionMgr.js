"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var jsutils = require('syracuse-tablet/html/js/helpers/jsutils');
var sdataUtils = require('syracuse-tablet/html/js/sdata/sdataUtils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("actionMgr");
var globals = require('syracuse-tablet/html/js/helpers/globals');
var notifications = require('syracuse-tablet/html/js/helpers/notifications');
var fontUtils = require('syracuse-tablet/html/js/ui/fontUtils');
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');

var _linksMenuId = "multiSelMenuLink";
var _actionMenuId = "multiSelMenuActions";
var _multiSelAction = "multiSelection";
var _selectedClass = "s-m-multi-selected";

var _templates = {
	menuActions: '\
		<div id="{{id}}" class="btn-group s-m-ismultisel">\
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">\
				<span class="badge"></span>Selected<span class="caret"></span>\
			</button>\
			<ul class="dropdown-menu" role="menu">\
				{{#each links}}\
					<li><a  {{#if style}}style="{{style}}"{{/if}} draggable="false"  data-action="multiSelectionAction" data-params="{{params}}" data-control-id="{{../ctrlId}}" href="#">{{title}}</a></li>\
				{{/each}}\
			</ul>\
		</div>',
	menuLinks: '\
		<div  id="{{id}}" class="btn-group s-m-ismultisel">\
			<button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false">\
				Actions<span class="caret"></span>\
			</button>\
			<ul class="dropdown-menu" role="menu">\
				{{#each links}}\
					<li>\
						<a draggable="false"  href="#" class="{{css}}" data-action="multiSelectionAction" data-params="{{$uuid}}" data-control-id="{{../ctrlId}}">\
							{{title}}\
						</a>\
					</li>\
				{{/each}}\
			</ul>\
		</div>',
	processMenu: '\
		<a draggable="false"  href="#" class="s-m-ismultisel" data-action="multiSelectionAction" data-params="$exitrun" data-control-id="{{ctrlId}}">\
			<i class="{{icon}}"/>\
		</a>'
};
var _selAction = [{
	title: "Unselect all",
	params: "$unselectall",
	style: "display:none"
}, {
	title: "Select all",
	params: "$selectall",
	style: "display:none"
}, {
	title: "Invert selection",
	params: "$invert",
	style: "display:none"
}, {
	title: "Hide unselected",
	params: "$hideunselected",
	style: "display:none"
}, {
	title: "Show unselected",
	params: "$showunselected",
	style: "display:none"
}];


var _getHtml = function(name, ctx) {
	var key = name + "compiled";
	var tmpl = _templates[key];
	if (!tmpl) {
		tmpl = _templates[name];
		tmpl = _templates[key] = Handlebars.compile(tmpl);
	}
	if (!tmpl) alert("multisel template " + name + " not found");
	return tmpl(ctx);
};

var _getLinks = function(controller) {
	var links = [];
	var proto = controller.prototype;
	var dao = controller.dao;
	var $links = $.extend(true, {}, proto.data("$links", null, true), dao.getValue("$links"));
	if ($links && !$.isEmptyObject($links)) {
		$.each($links, function(name, value) {
			if (value == null || value.$isExcluded === true || name.smStartsWith('$')) {
				return;
			}
			if (value.$url == null || value.$url.length == 0) {
				return;
			}
			var info;
			var link = sdataUtils.getLinkInfo(value.$url, dao, true);
			if (link == null) {
				return;
			}
			info = $.extend(link, value);
			if (info.$services) {
				info.$isAction = true;
			}
			info.$uuid = value.$uuid || utils.UUID();
			info.name = name;
			info.title = proto.resolveExpression(value.$title);
			info.icon = "";
			info.css = "s-m-ismultisel";
			links.push(info);

		});
	}
	return links;
};

var _ActionRunner = function() {

	this.run = function() {

	};
};
/**
 * Manages MultiSelection
 */
var _Klass = utils.defineClass(

	function(controller, cssToToggle) {
		this.controller = controller;
		this.cssToToggle = cssToToggle;
		this.links = null;
		notifications.subscribe(this, ["sm.main.layout.changed"]);
	}, null, {

		destroy: function() {
			this.controller = null;
			this._$$ownerParent = null;
			this.links = null;
		},
		getLinks: function() {
			return this.links;
		},

		isEnabled: function() {
			return this._$$ownerParent != null;
		},

		updateLinks: function(links) {
			if (links) {
				this.links = links;
				return;
			}
			this.links = _getLinks(this.controller);
		},

		_getArray: function() {
			var array = this.controller.getControlByBind("$resources");
			if (!array) throw new Error("Array $resources not found");
			return array;
		},

		/**
		 * enable/disable multi-selection
		 * Called from footer or header
		 */
		toggle: function(ctrlOwner, $$parent) {
			var array = this._getArray();
			if (this._$$ownerParent) {
				this._stopMultiSel(array);
			} else {
				this._startMultiSel($$parent, array);
			}
			return this._$$ownerParent != null;
		},
		/**
		 * Called from array
		 */
		callbackArray: function(ctrlArray, params, $target) {
			if (params == "$selectmultisel") {
				$target = $target.closest(".s-m-record");
				$target.toggleClass(_selectedClass);
				if ($target.hasClass(_selectedClass)) {
					this._updateUI(ctrlArray, this.nbSelected + 1);
				} else {
					this._updateUI(ctrlArray, this.nbSelected - 1);
				}
				return;
			}
			if (params == "$showdiagnoses") {
				this._showDiagnoses($target);
				return;
			}
			if (params == "$exitrun") {
				this._processExit(ctrlArray);
				return;
			}
			if (params == "$exitmultisel") {
				this._stopMultiSel(ctrlArray);
				return;
			}
			var all = this._$$All(ctrlArray).show();
			if (params == "$unselectall") {
				this._$$Selected(ctrlArray).removeClass(_selectedClass);
				this._updateUI(ctrlArray, 0);
				return;
			}
			if (params == "$selectall") {
				all.addClass(_selectedClass);
				this._updateUI(ctrlArray, all.length);
				return;
			}
			if (params == "$invert") {
				var unSelected = this._$$Unselected(ctrlArray);
				var selected = this._$$Selected(ctrlArray);
				selected.removeClass(_selectedClass);
				unSelected.addClass(_selectedClass);
				this._updateUI(ctrlArray, selected.length);
				return;
			}
			if (params === "$hideunselected" || params === "$showunselected") {
				this._$$Unselected(ctrlArray).toggle(params === "$showunselected");
				this._$$action("$hideunselected").toggle(params === "$showunselected");
				this._$$action("$showunselected").toggle(params === "$hideunselected");
				this._updateUI(ctrlArray, null);
				return;
			}
			/**
			 * EXECUTE ACTIONS - params is the id of the link
			 */
			if (this.nbSelected > 0) {
				var self = this;
				setTimeout(function() {
					self._processAll(ctrlArray, params);
				});
			}
		},
		/**
		 * Show/Hide buttons in parent's owner (foorter/header...)
		 */
		_toggleOwnerActions: function(show) {
			var selector = "a:not(.s-m-ismultisel)";
			if (this.cssToToggle) {
				selector += ", " + this.cssToToggle;
			}
			this._$$ownerParent.closest(".s-m-control").find(selector).toggle(show);
		},
		_startMultiSel: function($$parent, array) {
			this._$$ownerParent = $$parent;
			this._$$ownerAction().addClass("enabled");
			array.multiSelSetMgr(this);
			$$parent.prepend(this._$$linksMenuHtml(array));
			$$parent.prepend(this._$$actionMenuHtml(array));
			// Hide all action other than multisel ones
			this._toggleOwnerActions(false);
			// setTimeout otherwise $selectall is not shown
			var self = this;
			setTimeout(function() {
				self._updateUI(array, 0);
			});
		},
		_stopMultiSel: function(array) {
			if (!this._$$ownerParent) return;
			this._processExit(array);
			array.multiSelSetMgr(null);
			this._$$Selected(array).removeClass(_selectedClass);
			this._$$menu(_linksMenuId).remove();
			this._$$menu(_actionMenuId).remove();
			this._$$ownerAction().removeClass("enabled");
			// Show all action other than multisel ones
			this._toggleOwnerActions(true);
			this._$$ownerParent = null;
			this._resizeArray(array);
		},

		_$$linksMenuHtml: function(array) {
			return _getHtml("menuLinks", {
				id: _linksMenuId,
				links: this.links,
				ctrlId: array.id
			});
		},

		_$$actionMenuHtml: function(array) {
			return _getHtml("menuActions", {
				id: _actionMenuId,
				links: _selAction,
				ctrlId: array.id
			});
		},

		_resizeArray: function(array) {
			/**
			 * To recalculate the scroller beacuse we hide/show cells
			 */
			array.onResize();
		},
		_processStart: function(array, uuid) {
			var deferred = $.Deferred();
			try {
				array.waitStart();
				var unSelected = this._$$Unselected(array);
				var selected = this._$$Selected(array);
				unSelected.hide();
				this._resizeArray(array);
				this._$$ownerParent.find(".s-m-ismultisel").hide();
				this._$$ownerParent.prepend(_getHtml("processMenu", {
					title: "Exit",
					ctrlId: array.id,
					icon: fontUtils.getIconByName("$cancelMultiSel")
				}));
				var data = [];
				selected.each(function(idx, record) {
					var $$record = $(record);
					// avoid click
					$$record.attr("data-disabled", "true");
					var rowId = $$record.attr("data-params");
					var rowdata = array.getRowById(rowId);
					if (rowdata) {
						data.push({
							rowData: rowdata.row,
							rowId: rowId,
							$$record: $$record,
							idx: idx,
							status: "init"
						});
					}
				});
				// reads link info
				var link = null;
				var self = this;
				this.getLinks().some(function(l) {
					if (l.$uuid === uuid) {
						link = l;
						return true;
					}
				});
				deferred.resolve(link, data);
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},
		_processAll: function(array, uuid) {
			var self = this;
			self._processStart(array, uuid).then(function(link, data) {
				var deferred = $.Deferred();
				var _run = function(idx) {
					if (idx >= data.length) {
						deferred.resolve(link, data);
					} else {
						self._processOne(array, link, data[idx], idx).then(function(ok) {
							_run(idx + 1);
						});
					}
				};
				_run(0);
				return deferred.promise();
			}).then(function(link, data) {
				self._processEnd(data, array);
			}).fail(function(e) {
				globals.getModal().error("Multiselection failed", e, function() {
					self._processEnd(data, array);
				});
			});
		},
		_processEnd: function(data, array) {
			var res = {
				ok: 0,
				ko: 0,
				init: 0
			};
			data.forEach(function(d) {
				res[d.status]++;
			});
			this._$$ownerParent.prepend('<span class="s-m-multiselmsg">' + res.ok + ' successes - ' + res.ko + ' failures</span>');
			this._resizeArray(array);
			array.waitStop();
		},
		_processExit: function(array) {
			this._$$All(array).show().removeClass("error success " + _selectedClass).removeAttr("data-disabled");
			this._$$ownerParent.find('[data-params="$exitrun"], .s-m-multiselmsg').remove();
			this._$$ownerParent.find(".s-m-ismultisel").show();
			this._updateUI(array, 0);
			array.$$value.find(".s-m-multisel-diag").smRemoveData('diagnoses').remove();
			this._resizeArray(array);
		},
		_processOne: function(array, link, data, idx) {
			var self = this;
			var deferred = $.Deferred();
			var _end = function(success, result) {
				try {
					var diagsMsg = [],
						diagsErr = [];
					if ($.isPlainObject(result)) {
						var diags = sdataUtils.scanDiagnoses(result);
						if (diags) {
							diags.forEach(function(d) {
								if (d.$severity === "error") {
									diagsErr.push(d);
								} else {
									diagsMsg.push(d);
								}
							});
						}
					}
					success = success && diagsErr.length == 0;
					if (!success) {
						if (jsutils.isError(result)) {
							// console.log(JSON.stringify(result.stack, null, 2));
							data.$diagnoses = [{
								$message: e.message,
								$stackTrace: e.stack
							}];
						} else {
							data.$diagnoses = diagsErr;
						}
					} else {
						data.$diagnoses = diagsMsg;
						// console.log(JSON.stringify(result, null, 2));
					}
				} catch (e) {
					success = false;
					data.$diagnoses = [{
						$message: e.message,
						$stackTrace: e.stack
					}];
				} finally {
					data.status = success ? "ok" : "ko";
					data.$$record.addClass(success ? "success" : "error");
					self._addDiagnoses(array, data);
					deferred.resolve(success);
				}
			};
			try {
				if (link.sDataUrl) {
					var payload = data && data.rowData ? data.rowData.getActionPayload(link) : null;
					dispatcher.dispatch({
						$url: link.sDataUrl,
						$method: link.$method || "GET"
					}, payload).then(function(data) {
						_end(true, data);
					}).fail(function(e) {
						_end(false, e);
					});
				} else {
					_end(true);
				}
			} catch (e) {
				_end(false, e);
			} finally {
				return deferred.promise();
			}
		},
		_addDiagnoses: function(array, data) {
			var $$root = null,
				colSpan, $$diag, isTable = array.getMode() === "table";
			if (isTable) {
				colSpan = data.$$record.children('td').length;
			} else {
				$$root = $('<section data-action="multiSelectionAction" data-params="$showdiagnoses"/>').addClass("s-m-multisel-diag").prependTo(data.$$record);
				$$root.width(data.$$record.width());
				$$root.smData('diagnoses', data.$diagnoses);
			}
			data.$diagnoses.forEach(function(d, idx) {
				$$diag = $('<div data-idx="' + idx + '" class="alert alert-' + (d.$severity === "error" ? "danger" : "success") + '" role="alert">' + d.$message + '</div>');
				if (isTable) {
					$$root = $('<tr  data-action="multiSelectionAction"  data-params="$showdiagnoses"><td colspan="' + colSpan + '"/></tr>').addClass("s-m-multisel-diag");
					$$root.smData('diagnoses', data.$diagnoses);
					data.$$record.after($$root);
					$$root = $$root.children()[0];
				}
				$$diag.appendTo($$root);
			});
		},
		_showDiagnoses: function($$elmt) {
			$$elmt = $$elmt.closest(".s-m-multisel-diag");
			var diags = $$elmt.smData('diagnoses');
			if (diags == null || diags.length == 0) return;
			globals.getModal().error("", {
				$diagnoses: diags
			});
		},
		_$$ownerAction: function() {
			return this._$$ownerParent.find('[data-action="' + _multiSelAction + '"]');
		},
		_$$Unselected: function(array) {
			return array.$$value.find(".s-m-record:not(." + _selectedClass + ")");
		},
		_$$Selected: function(array) {
			return array.$$value.find(".s-m-record." + _selectedClass);
		},
		_$$All: function(array) {
			return array.$$value.find(".s-m-record");
		},
		_$$action: function(id) {
			return this._$$ownerParent.find('[data-params="' + id + '"]');
		},
		_$$menu: function(id) {
			return this._$$ownerParent.find("#" + id);
		},
		_updateUI: function(array, nb) {
			if (!this._$$ownerParent) return;
			if (nb != null) {
				this.nbSelected = Math.max(0, nb);
				this._$$menu(_actionMenuId).find(".badge").text(this.nbSelected);
			}
			var noSel = this.nbSelected == 0;
			var allSel = this.nbSelected === array.getNbRecords();
			this._$$menu(_linksMenuId).children("button").toggleClass("disabled", noSel);
			if (noSel || allSel) {
				this._$$action("$hideunselected").hide();
				this._$$action("$showunselected").hide();
			} else if (this.nbSelected > 0 && !this._$$action("$showunselected").is(":visible")) {
				this._$$action("$hideunselected").show();
			}
			this._$$action("$unselectall").toggle(this.nbSelected > 0);
			this._$$action("$selectall").toggle(true);
			this._$$action("$invert").toggle(this.nbSelected > 0);
		},
		notifMainLayoutChanged: function() {
			if (this._$$ownerParent) {
				this._stopMultiSel(this._getArray());
			}
		}
	});

exports.actionId = _multiSelAction;
exports.create = function(controller, cssToToggle) {
	if (!controller.prototype.isQuery()) return null;
	var links = _getLinks(controller);
	if (links.length === 0) return null;
	var mgr = new _Klass(controller, cssToToggle);
	mgr.updateLinks(links);
	return mgr;
};