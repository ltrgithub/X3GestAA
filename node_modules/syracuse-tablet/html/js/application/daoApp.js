"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("app");
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;
var dispatcher = require('syracuse-tablet/html/js/sdata/sdataDispatcher');
var page = require('syracuse-tablet/html/js/pages/page');
var prototype = require('syracuse-tablet/html/js/helpers/prototype');
var dashboardArticle = require('syracuse-tablet/html/js/helpers/dashboardArticle');
var prototypeParser = require('syracuse-tablet/html/js/helpers/prototypeParser');


/*
 * Access to application's data - installed apps, settings
 */

var _consts = {};

var _Dao = function(appli) {
	var self = this;

	self._appli = appli;
	self.json = null;

	self.getConfig = function() {

	};

	self.getSettings = function() {

	};

	self.destroy = function() {
		self._appCtrlr = null;
	};
	/**
	 *Returns the JSON description of application
	 */
	self.getJsonDescr = function() {
		if (!self.json) {
			/* Load the last used application from local DB */
		}
		return self.json;
	};
	/**
	 * Set the JSON description of application
	 */
	self.setJsonDescr = function(json) {
		if (json) {
			self.json = json;
			return page.registerAppPages(json);
		}
	};

	self.getRegularPageInfo = function(id) {
		var info = self.json.$pages[id];
		if (!info) throw new Error('Page not found - PageId=' + id);
		if (!info.$page) throw new Error('Bad page description - PageId=' + id);
		if (!info.$page.$prototype) throw new Error('Prototype is NULL - PageId=' + id);

		/* Temporarily we return only $article and prototype 
		 * $article is calculated from prototype
		 * TODO - check if $article - Convert desktop to tablet article
		 */
		var proto = info.$page.$prototype;
		var article = prototypeParser.proto2Article(id, proto);
		if (false && id.smEndsWith("query") && proto.$properties.$resources) {
			// Temporarily for test - we transform the query into a detail
			proto.$properties = proto.$properties.$resources.$item.$properties;
		}
		return {
			article: article,
			prototype: prototype.create(proto),
			jsonInfo: info
		};
	};

	/**
	 * Returns the $prototype and $article of dashBoardId
	 * $prototype.$properties gives the description of vignettes 'fields'
	 */
	self.getDashboardInfo = function(dashBoardId) {
		var dash = self.json.$dashboards[dashBoardId];
		if (!dash) throw new Error('Dashboard not found ' + dashBoardId);

		var article = $.extend({}, dashboardArticle.getDashboardArticle(dash));
		var proto = {
			$properties: {}
		};
		var vignetteIds = Object.keys(dash.$vignettes || []);
		for (var i = 0; i < vignetteIds.length; i++) {
			var vignetteId = vignetteIds[i];
			var property = $.extend({}, dash.$vignettes[vignetteId]);
			var gadgetId = property.$uuid;
			property.$gadget = self.json.$gadgets[gadgetId];
			if (property.$gadget) {
				property.$gadget = $.extend({}, property.$gadget);
				// Set gadget uuid
				property.$gadget.$uuid = gadgetId;
				// Set vignette uuid
				property.$uuid = vignetteId;
				// Set type - "application/x-string"
				property.$type = "application/x-vignette";
				// Readable dom uid
				property.domId = utils.readableuid("vgnt", property.$gadget.$type);
			} else {
				throw new Error('Dashboard ' + dashBoardId + ' gadget not found - $uuid: ' + gadgetId);
			}
			proto.$properties[vignetteId] = property;
		}
		return {
			article: $.extend({}, dash.$article),
			prototype: prototype.create(proto)
		};
	};
};

exports.Dao = _Dao;