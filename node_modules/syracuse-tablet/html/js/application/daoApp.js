"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var prototype = require('syracuse-tablet/html/js/helpers/prototype');
var dashboardUtils = require('syracuse-tablet/html/js/helpers/dashboardUtils');
var pageHelper = require('syracuse-tablet/html/js/application/pageHelper');
var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var Gadget = require('syracuse-tablet/html/js/application/gadget').Klass;
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');

/**
 * Class that manage access to application DATA
 *  	appli: 		Application object
 * !!use DAO methods instead of dealing directly with JSON
 */
var _Dao = utils.defineClass(
	function(appli) {
		var self = this;
		self._appli = appli;
		self.appMetaData = null;
	}, null, {

		destroy: function() {
			var self = this;
			self._appli = null;
		},
		/**
		 *Returns the JSON description of application
		 */
		isApplicationLoaded: function() {
			var self = this;
			return (self.appMetaData != null);
		},

		/**
		 * Set the JSON description of application
		 */
		setApplication: function(appMetaData) {
			var self = this;
			if (appMetaData) {
				self.appMetaData = $.extend(true, {}, appMetaData);
				pageHelper.registerPages(self.appMetaData);
			}
		},

		getApplicationName: function() {
			var self = this;
			return self.appMetaData && self.appMetaData.$application.applicationName || "";
		},

		getHomeDashboard: function() {
			var self = this;
			var homeId;
			if (self.appMetaData && self.appMetaData.$dashboards) {
				for (var p in self.appMetaData.$dashboards) {
					var data = self.appMetaData.$dashboards[p];
					if (data.$dashboardName === self.appMetaData.$application.$homeDashboard.dashboardName) {
						homeId = globals.getDashboardName(data.$dashboardName);
					}
				}
			}
			return homeId;
		},
		/**
		 * Returns JSON description article/prototype for a regular page (id=AQMCRUDM.$query)
		 * 		state:			page state
		 * 		parentProto		parentProto parent prototype - rowdetail proto needs parent page proto
		 */
		getRegularPageInfo: function(state, parentProto) {
			var self = this;
			state.options = state.options || {};
			var deferred = $.Deferred(),
				registerPage;
			try {
				// Try to get client side implementation first
				clientContract.getRegularPageInfo(state.name)
					.then(function(info) {
						if (info != null) {
							// info!= null -> Test entities page
							registerPage = true;
							return info;
						} else {
							return self.getPageMetaData(state.name);
						}
					})
					.then(function(info) {
						if (!info || !info.$page || !info.$page.$prototype) {
							// This is intended to get prototypes from the server in case representations
							// are used in client side only applications that point to server side entities
							// In real world applications, this will never be used, it's only to simplyfy setup up testcases
							registerPage = true;
							return sdataHttp.fetchRemotePrototype(state.name).then(function(proto) {
								return self.registerAdditionalPage(state.name, proto, null);
							});
						}
						return info;
					})
					.then(function(info) {
						if (!info) {
							throw new Error('Page not found - PageId=' + state.name);
						}
						if (!info.$page) {
							throw new new Error('Bad page description - PageId=' + state.name);
						}
						if (!info.$page.$prototype) {
							throw new new Error('Prototype is NULL - PageId=' + state.name);
						}
						return info;
					})
					.then(function(info) {
						if (registerPage) {
							// We register the page if it has been loaded - test pages
							var newState = pageHelper.registerRegularPage(state.name, info);
							// We refresh state with newState properties
							for (var p in newState) {
								if (state[p] == null || state[p] !== newState[p]) state[p] = newState[p];
							}
						}
						// layout:
						// 1 - as defined as sub node in dash-board layout
						// 2 - as coming from the page definition (entity)
						// 3- generate s.th.
						var proto = info.$page.$prototype;
						if (!$.isPlainObject(proto)) throw new Error("JSON proto expected");
						proto = prototype.create(proto, parentProto);
						// state.options.article || info.$page.$article || proto.toArticle()
						var article = state.options.article;
						if (article && Object.keys(article).length === 0) {
							// Regular page using article from dashboard or generated by prototype
							var protoArticle = proto.toArticle();

							// Copy vignette article into dashboard article sub-node to be available for authoring
							Object.keys(protoArticle).forEach(function(p) {
								article[p] = protoArticle[p];
							});
						} else {
							// Regular page article from page info metadata or generated by prototype
							article = article || info.$page.$article || proto.toArticle();
						}
						deferred.resolve({
							article: article,
							prototype: proto
						});
					}).fail(function(e) {
						deferred.reject(e);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		getPageMetaData: function(id) {
			var self = this;
			if (self.appMetaData.$pages) {
				return $.smResolve(self.appMetaData.$pages[id]);
			}
			return $.smResolve(null);
		},

		/**
		 * Returns the prototype and article for a dashBoard
		 * prototype.$properties gives the description of vignettes 'fields'
		 */
		getDashboardInfo: function(dashBoardId) {
			var self = this;

			return $.smResolve()
				.then(function() {
					var dash = self.appMetaData.$dashboards[dashBoardId];
					if (!dash) {
						throw new Error('Dashboard not found ' + dashBoardId);
					}
					return dash;
				})
				.then(function(dash) {
					if (dash && dash.$update) {
						/* we pass appMetaData as parameter to alow $update to refresh it (original appMetaData has been cloned) */
						return dash.$update(dash, self.appMetaData);
					} else {
						return dash;
					}
				})
				.then(function(dash) {
					var article = dash.$article;
					if (!article) {
						article = dashboardUtils.getDashboardArticle(dash);
					}
					return {
						article: $.extend({}, article),
						prototype: dashboardUtils.getDashboardProto(dash, self)
					};
				});
		},

		getGadgetData: function(id) {
			var self = this;
			var g = (self.appMetaData.$gadgets && self.appMetaData.$gadgets[id]);
			if (!g) throw Error("Gadget data not found - id[" + id + "]");
			if (!g.$uuid) {
				g.$uuid = id;
			}
			return g;
		},
		/**
		 * Returns a gadget
		 */
		getGadget: function(id) {
			var self = this;
			var g = self.getGadgetData(id);
			return new Gadget(g);
		},

		// fullName: x3.erp.SUPERV.AQMCRUD.$details
		getPrototype: function(fullName) {
			var self = this;
			if (self.appMetaData == null) throw new Error("Get page prototype error - No application metadata");
			var page = self.appMetaData.$pages[fullName];
			if (page == null || page.$page == null) throw new Error("Get page prototype error - Page not found[" + fullName + "]");
			return page.$page.$prototype;
		},
		/**
		 * Register pages which are not provided by Syracuse
		 * 		Ex rowdetail page, test entities pages
		 * proto:		JSON or object prototype
		 * article:		JSON article if any (authoring)
		 */
		registerAdditionalPage: function(id, proto, articleJson) {
			var self = this;
			if (!proto || $.isEmptyObject(proto)) throw new Error("Unexpected empty prototype");
			if (!self.appMetaData) self.appMetaData = {};
			if (!self.appMetaData.$pages) self.appMetaData.$pages = {};
			var page = self.appMetaData.$pages[id] = self.appMetaData.$pages[id] || {};
			page.$cache = page.$cache || {
				cacheType: "$auto"
			};
			page.$page = page.$page || {};
			// We register JSON proto because prototype Object is destroyed with the page
			// When the page is created we instantiate a new proto from JSON - Safest way to manage memory
			page.$page.$prototype = page.$page.$prototype || ($.isPlainObject(proto) ? proto : proto.json);
			page.$page.$article = page.$page.$article || articleJson;
			return page;
		}
	});

exports.Dao = _Dao;