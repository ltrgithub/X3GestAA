"use strict";

var utils = require('syracuse-tablet/html/js/helpers/utils');
var prototype = require('syracuse-tablet/html/js/helpers/prototype');
var dashboardArticle = require('syracuse-tablet/html/js/helpers/dashboardArticle');
var prototypeParser = require('syracuse-tablet/html/js/helpers/prototypeParser');
var pageHelper = require('syracuse-tablet/html/js/application/pageHelper');
var clientContract = require('syracuse-tablet/html/js/sdata/entities/clientContract');
var globals = require('syracuse-tablet/html/js/helpers/globals');
var Gadget = require('syracuse-tablet/html/js/application/gadget').Klass;
var sdataHttp = require('syracuse-tablet/html/js/sdata/sdataHttp');

/**
 * Class that manage access to application DATA
 *  	appli: 		Application object
 * !!use DAO methods instead of dealing directly with JSON
 */
var _Dao = utils.defineClass(
	function(appli) {
		var self = this;
		self._appli = appli;
		self.appMetaData = null;
	}, null, {

		destroy: function() {
			var self = this;
			self._appli = null;
		},
		/**
		 *Returns the JSON description of application
		 */
		isApplicationLoaded: function() {
			var self = this;
			return (self.appMetaData != null);
		},

		/**
		 * Set the JSON description of application
		 */
		setApplicationDesc: function(appMetaData) {
			var self = this;
			if (appMetaData) {
				self.appMetaData = appMetaData;
				pageHelper.registerPages(self.appMetaData);
			}
		},

		getApplicationName: function() {
			var self = this;
			return self.appMetaData && self.appMetaData.$application.applicationName || "";
		},

		getHomeDashboard: function() {
			var self = this;
			var homeId;
			if (self.appMetaData && self.appMetaData.$dashboards) {
				for (var p in self.appMetaData.$dashboards) {
					var data = self.appMetaData.$dashboards[p];
					if (data.$dashboardName === self.appMetaData.$application.$homeDashboard.dashboardName) {
						homeId = data.$dashboardName + ".$dashboard";
					}
				}
			}
			return homeId;
		},

		/**
		 * Get information on page kind: html/prototype based, etc
		 */
		getPageInfo: function(state, options) {
			var self = this;
			var pi = clientContract.getPageInfo(state, options);
			if (pi) return pi;
			var name = state;
			if (state === "home") name = self.getHomeDashboard();
			pi = pageHelper.getPageInfo(name, options);
			if (pi) return pi;
			pi = pageHelper.getPageInfo(name, options, {
				home: false,
				type: "regular",
				cached: false,
				refreshed: false,
				appId: "root",
				changeHash: false
			});
			return pi;
		},

		/**
		 * Returns JSON description article/prototype for a regular page (id=AQMCRUDM.$query)
		 */
		getRegularPageInfo: function(id, options) {
			var self = this;
			var deferred = $.Deferred();
			try {
				// Try to get client side implementation first
				clientContract.getRegularPageInfo(id)
					.then(function(info) {
						if (info) {
							return info;
						}
						return self.getPageMetaData(id);
					})
					.then(function(info) {
						if (!info) {
							// This is intended to get prototypes from the server in case representations
							// are used in client side only applications that point to server side entities
							// In real world applications, this will never be used, it's only to simplyfy setup up testcases
							return self.fetchRemotePrototype(id);
						}
						return info;
					})
					.then(function(info) {
						if (!info) {
							return $.smReject(new Error('Page not found - PageId=' + id));
						}
						if (!info.$page) {
							return $.smReject(new Error('Bad page description - PageId=' + id));
						}
						if (!info.$page.$prototype) {
							return $.smReject(new Error('Prototype is NULL - PageId=' + id));
						}
						return info;
					})
					.then(function(info) {
						var proto = info.$page.$prototype;
						// layout:
						// 1 - as defined as sub node in dashboard layout
						// 2 - as comming from the page definition (entity)
						// 3- generate s.th.
						var article = (options && options.article) || (info.$page.$article) || prototypeParser.proto2Article(proto);
						deferred.resolve({
							article: article,
							prototype: prototype.create(proto)
						});
					}).fail(function(e) {
						deferred.reject(e);
					});
			} catch (e) {
				deferred.reject(e);
			} finally {
				return deferred.promise();
			}
		},

		getPageMetaData: function(id) {
			var self = this;
			if (self.appMetaData.$pages) {
				return $.smResolve(self.appMetaData.$pages[id]);
			}
			return $.smResolve(null);
		},

		fetchRemotePrototype: function(id) {
			var self = this;
			return sdataHttp.fetchRemotePrototype(id).then(function(proto) {
				var page = {
					$cache: {
						cacheType: "$auto"
					},
					$page: {
						$prototype: proto
					}
				};
				self.appMetaData.$pages = self.appMetaData.$pages || {};
				self.appMetaData.$pages[id] = page;
				return page;
			}).fail(function(e) {
				return e;
			});
		},

		/**
		 * Returns the prototype and article for a dashBoard
		 * prototype.$properties gives the description of vignettes 'fields'
		 */
		getDashboardInfo: function(dashBoardId) {
			var self = this;

			return $.smResolve()
				.then(function() {
					var dash = self.appMetaData.$dashboards[dashBoardId];

					if (!dash) throw new Error('Dashboard not found ' + dashBoardId);
					return dash;
				})
				.then(function(dash) {
					if (dash && dash.$update) {
						return dash.$update(dash);
					} else {
						return dash;
					}
				})
				.then(function(dash) {
					/* Generates article form dashBoard description*/
					var article = dashboardArticle.getDashboardArticle(dash);
					/* Generates proto form dashBoard description*/
					var proto = {
						$title: dash.$title,
						$description: dash.$description,
						$properties: {}
					};
					var vignetteIds = Object.keys(dash.$vignettes || []);
					for (var i = 0; i < vignetteIds.length; i++) {
						var vignetteId = vignetteIds[i];
						var property = $.extend({}, dash.$vignettes[vignetteId]);
						var gadgetId = property.$uuid;

						property.$gadget = self.getGadgetData(gadgetId);
						if (property.$gadget) {
							property.$gadget = $.extend({}, property.$gadget);
							// Set gadget uuid
							property.$gadget.$uuid = gadgetId;
							// Set vignette uuid
							property.$uuid = vignetteId;
							// Set type - "application/x-string"
							property.$type = "application/x-vignette";
							// Readable dom uid
							property.domId = utils.readableuid("vgnt", property.$gadget.$type);
						} else {
							property.$gadget = {
								$uuid: gadgetId,
								$type: "$gadgetMissing"
							};
							property.$uuid = vignetteId;
							property.$type = "application/x-vignette";
							property.domId = utils.readableuid("vgnt", property.$gadget.$type);

						}
						proto.$properties[vignetteId] = property;
					}
					return {
						article: $.extend({}, dash.$article),
						prototype: prototype.create(proto)
					};
				}).fail(function(e) {
					utils.modalError("getDashboardInfo error", e);
				});
		},

		getGadgetData: function(id) {
			var self = this;
			var g = (self.appMetaData.$gadgets && self.appMetaData.$gadgets[id]);
			if (!g.$uuid) {
				g.$uuid = id;
			}
			return g;
		},
		/**
		 * Returns a gadget
		 */
		getGadget: function(id) {
			var self = this;
			var g = self.getGadgetData(id);
			return new Gadget(g);
		},

		// fullName: x3.erp.SUPERV.AQMCRUD.$details
		getPrototype: function(fullName) {
			var self = this;
			if (self.appMetaData == null) throw new Error("Get page prototype error - No application metadata");
			var page = self.appMetaData.$pages[fullName];
			if (page == null || page.$page == null) throw new Error("Get page prototype error - Page not found[" + fullName + "]");
			return page.$page.$prototype;
		}
	});

exports.Dao = _Dao;