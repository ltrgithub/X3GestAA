"use strict";

(function() {
	var _buildResponseData = function(request, succeeded) {
		var result = {};
		var $data;
		try {
			if (request.response) {
				$data = JSON.parse(request.response);
			}
		} catch (e) {
			result.$message = request.response;
		}
		result.$status = request.status || 200;
		result.$data = $data;
		result.$headers = request.getAllResponseHeaders();
		result.$succeeded = succeeded;

		return result;
	};
	var _ajax = function(data) {
		return new WinJS.Promise(function(resolve, reject, progress) {
			var req = {
				type: data.$method,
				url: data.$url,
				responseType: "json"
			};
			if (data.$send) {
				req.data = data.$send;
			}
			if (data.$headers) {
				req.headers = data.$headers;
			}
			WinJS.xhr(req).then(function(request) {
				resolve(_buildResponseData(request, true));
			}, function(request) {
				resolve(_buildResponseData(request, false));
			});
		});
	};

	window.$SAGE.registerContainerAPI("winjsAjax", {
		ajax: _ajax
	});
})();