"use strict";
// same as $( document ).ready( handler )
$(function($) {
	if (!$.smobile) $.smobile = {};
	var _log = $.smobile.log;
	var helpers = $.smobile.helpers;

	var _templates = ["modals/error", "modals/confirm"];


	$(document).ready(function() {
		try {
			_log && _log("Load", "history.length=" + history.length);
			// Create global site
			var site = $.smobile.createSite($("#site"));
			if (site.config("mockup")) {
				// Reload page removes all templates
				$.stemplates.removeTmpl();
				// Load mockup templates
				$.smobile.mockup.init();
			}
			// Remove templates on reload otherwise they not refreshed
			$.stemplates.removeTmpl();
			$.smobile.modals.init();
			// Goto page
			$.smobile.changePage(window.location.hash).then(function(dstPage) {
				window.history.replaceState(dstPage.state, dstPage.state.uuid, "");
				_log && _log("Load after change page", "history.length=" + history.length);
				site.$elmt.show();
			}, function(e) {
				alert("ERROR CHANGING PAGE");
			});
		} catch (e) {
			$.smobile.displayError("Error loading page", helpers.toDiagnose({
				where: "$(document).ready",
				exception: e
			}));
		}
	});

	window.onerror = function(errorMsg, url, lineNumber, error) {
		try {
			$.smobile.displayError("Javascript error", {
				where: "window.onerror",
				exception: error,
				message: errorMsg + "\n" + (url ? "Url : " + helpers.cleanStack(url) + "\nLineNumber : " + lineNumber : "")
			});
		} catch (e) {
			var msg = errorMsg + "\n" + (error ? +JSON.stringify(error, null, 2) : (url ? "Url : " + url + "\nLineNumber : " + lineNumber : ""));
			alert(msg);
		}
	};
});