<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Sage Mobile - FDB Sandbox</title>
<!-- BOOTSTRAP CSS - CSS -->
<link rel="stylesheet" href="./others/bootstrap/css/bootstrap.css" />
<link rel="stylesheet" href="./others/bootstrap/css/bootstrap-theme.css" />
<!-- LIBRARIES  -->
<script src="./others/jquerylatest.js"></script>
<script src="./js/jqueryPlugins.js"></script>
<script src="./others/bootstrap/js/bootstrap.js"></script>
<script src="./js/helpers.js"></script>
<script src="./others/handlebars-latest.js"></script>
<script src="./js/templating.js"></script>
<script src="./js/test.js"></script>
<script>

var _processes = {}
function registerProcess(processName,  methods){
	var kons = function(name, $res, color){
		$.smobile.$tests.Process.call(this, name, $res, color);
	};
	_processes[processName] = $.smobile.helpers.defineClass(kons, $.smobile.$tests.Process, methods);
}
function joinArgsDone(args){
	for(var i = 0; i < args.length; i++){
		if (Array.isArray(args[i])){
			args[i] = "[" + args[i].toString() + "]"
		}
	}
	return "[" + Array.prototype.join.call(args, ",")  + "]";
}
function joinArgs(args){
	return Array.prototype.join.call(args, "-") 
}
function _init(){
	registerProcess("deferred", {
		resolve: function(){
			var deferred = arguments[0];
			var name = arguments[1];
			this.log("RESOLVE -> " + joinArgs(Array.prototype.slice.call(arguments, 1, arguments.length -1)));
			deferred.resolve(name + "~Param1", name + "~Param2");
		},
		reject: function(){			
			var deferred = arguments[0];
			var name = arguments[1];
			this.log("REJECT -> " + joinArgs(Array.prototype.slice.call(arguments, 1, arguments.length -1)));
			deferred.reject(name + "~Param1", name + "~Param2");
		},
		exec: function(data, name, wait, fail){
			this.log("START " + name + " - Wait " + wait + " ms");
			var self = this;
			var d = $.Deferred();
			setTimeout(function() {
				if (fail){
					self.reject(d, name, data);
				}else{
					self.resolve(d, name, data);
				}
			}, wait);
			return d.promise();
		},
		a:function (data) {
			return this.exec(joinArgs(arguments), "A", 2000);
		},
		b:function (data) {
			return this.exec(joinArgs(arguments), "B", 1000);
		},
		c:function (fail, data) {
			this.log("START C - MustFail[" + (fail===true) + "] - Call C1/C2 in parallel");
			data = joinArgs(arguments);
			var self = this;
			var d = $.Deferred();
			setTimeout(function() {
				$.when(self.c1(data), self.c2(data)).done(function() {
					try{
						if (fail) throw new Error ("Force throw exception");
						self.resolve(d, "C", data);
					}catch(e){
						self.reject(d, "C", e.message, data);
					}
				});
			}, 0);
			return d.promise();
		},
		c1:function (data) {
			return this.exec(data, "C1", 5000);
		},
		c2:function (data) {
			return this.exec(data, "C2", 3000);
		},
		d:function (data) {
			return this.exec(data, "D", 2000);
		},
		parallelError:function   (){
			var self = this;
			self.log("START PARALLEL THAT FAILS")
			$.when(self.a(), self.b(), self.c(true), self.d()).then(function() {
				self.log("STOP PARALLEL - SUCCEEDED - " + joinArgsDone(arguments));
			}, function(s) {
				self.log("STOP PARALLEL - FAILED - " + joinArgsDone(arguments));
			})
		},
		paralleleSuccess :function() {
			var self = this;
			self.log("START PARALLEL THAT SUCCEEDS")
			$.when(self.a(),self.b(),self.c(false), self.d()).then(function() {
				// Arguments contains the data of each process with the same order as call order
				self.log("STOP PARALLEL - SUCCEEDED - ARGUMENTS: " + joinArgsDone(arguments));
			}, function(s) {
				// Arguments contains the parameter of reject call
				self.log("STOP PARALLEL - FAILED -  ARGUMENTS: " + joinArgsDone(arguments));
			})
		},
		serieError : function() {
			var self = this;
			self.log("START SERIE THAT FAILS")
			return self.a().then(function() {
				return self.b(joinArgs(arguments))
			}).then(function() {
				return self.c(true, joinArgs(arguments))
			}).then(function() {
				return self.d(joinArgs(arguments))
			}).then(function() {
				// Arguments contains the parameter of the last resolve
				self.log("STOP SERIE - SUCCEEDED -  ARGUMENTS: " + joinArgsDone(arguments));
			}, function() {
				// Arguments contains the parameter of reject call
				self.log("STOP SERIE - FAILED -  ARGUMENTS: " + joinArgsDone(arguments));
			})
		},
		serieSuccess : function() {
			var self = this;
			self.log("START SERIE THAT SUCCEEDS")
			self.a().then(function() {
				return self.b(joinArgs(arguments))
			}).then(function() {
				return self.c(false, joinArgs(arguments))
			}).then(function() {
				return self.d(joinArgs(arguments))
			}).then(function() {
				// Arguments contains the parameter of the last resolve
				self.log("STOP SERIE - SUCCEEDED -  ARGUMENTS: " + joinArgsDone(arguments));
			}, function() {
				// Arguments contains the parameter of reject call
				self.log("STOP SERIE - FAILED -  ARGUMENTS: " + joinArgsDone(arguments));
			})
		},
		testDone : function() {
			var self = this;
			self.log("START DONE/THEN USE\n\ta().then(function(){return b(arguments))})\n\t.done(function(){return c(arguments))})\n\t.done(function(){return d(arguments)})\n\t.done(function f1(){}, function f2(){}).done(function f3(){})");
			self.a().then(function() {
				self.log ("a().then(b())\n\tb is called once a is resolved\n\tArguments = a.resolve params " + joinArgsDone(arguments))
				return self.b(joinArgs(arguments))
			}).done(function() {
				self.log ("a().then(b()).done(c())\n\tc is called once b is resolved\n\tArguments = b.resolve params " + joinArgsDone(arguments))
				return self.c(false, joinArgs(arguments))
			}).done(function() {
				self.log ("a().then(b()).done(c()).done(d())\n\td is called once B IS RESOLVED\n\tArguments = b.resolve params " + joinArgsDone(arguments) + "\n\tdone refers to the promise returned by b and not to the promise returned by c");
				return self.d(joinArgs(arguments))
			}).done(function() {
				self.log("a().then(b()).done(c()).done(d()).done(f1,f2) - f1 \n\tArguments : " + joinArgsDone(arguments) + "\n\tArguments are the ones of b.reslove\n\tdone refers to the promise returned by b and not to the promise returned by d");
			}, function() {
				self.log("a().then(b()).done(c()).done(d())(f1,f2) - f2 \n\tArguments : " + joinArgsDone(arguments));
			}).done(function() {
				self.log("a().then(b()).done(c()).done(d()).done(f1,f2).done(f3) - f3 \n\tArguments : " + joinArgsDone(arguments) + "\n\tc and d promises are IGNORED like you see below");
			})
		}
	});

	registerProcess("smobile", {
		_smDataProp :"test-sm-data",
		_smDataid :"testsmdata",
		smdataUpdate: function(){
			var self=this;
			var e = $("#" + self._smDataid);
			if (e.length === 0){
				e = $('<div id="' + self._smDataid + '">TEST SMDATA</div>)').show().appendTo(self.$res);
			}
			self.smdataDisplay("before");
			var data = { date:new Date(), id:$.smobile.helpers.uid("test")};
			e.smData(self._smDataProp, data);
			e.html( JSON.stringify(data, null, 2));
			self.smdataDisplay("after");
		},		
		smdataDisplay: function(title){
			var data = $("#" + this._smDataid).smData(this._smDataProp);
			this.log((title || "display") + " - smData(" + $.smobile.nsNormalize(this._smDataProp) + ")");
			this.log(data ? JSON.stringify(data, null, 2) : "no data");
		},		
		smdataRemove: function(e){
			$("#" + this._smDataid).empty().smRemoveData(this._smDataProp);
			this.smdataDisplay("remove");
		}
	});
	
	registerProcess("navigation", {
		testHistory: function(e){
			/* TEST PUSHSTATE/ONPOPSTATE NAVIGATION */
			var self=this;
			var id = "testhistory", pgId = "histpagecontent";
			var displayPage = function(idx, tryNum){
				if (idx==-1){
					$("#" + pgId).html("<h1>First application page <small>Try #" + tryNum + "</small></h1>");
					return;
				}
				$.stemplates.exec("tests/history", {title: "Page " + idx, idx : idx, tryNum:tryNum}, null, "historypage").then(function(html){
					$("#" + pgId).html(html);		
				});
			}
			var gotoPage = function(idx, tryNum){
				displayPage(idx, tryNum);
				self.log("TryNum=" + tryNum + " - " + (idx === -1 ? "replaceState" : "pushState") + " - state=" + idx + " - history.length=" + history.length, true);
				if (idx === -1) {
					// First page - Replace state to reset the first level of navigation
					history.replaceState({pageIdx:idx, tryNum:tryNum}, "Page " + idx, null);
				}else{
					history.pushState({pageIdx:idx, tryNum:tryNum}, "Page " + idx, null);
				}
			}
			$("#" + id).unbind().remove();
			$.stemplates.exec("tests/history", {id:id, pageid:pgId, btnList:[{idx:1},{idx:2},{idx:3},{idx:4},{idx:5}]}, null, "historypanel").then(function(html){
				var e =  $(html).show().appendTo(self.$res);
				var tryNum = self.getGlobalCtx("histTryNum") || 0;
				self.setGlobalCtx("histTryNum", tryNum+1);
				self.log("Click on button to chage page - Click back to go back - Try=" + tryNum, true);
				e.find("button").click(function(evt){
					var b = $(this);
					// DON'T FORGET TO CALL preventDefault/stopPropagation OTHERWISE PushState DOESN'T WORK
					evt.preventDefault();
					evt.stopPropagation();
					setTimeout(function(){
						// PUSHSTATE WORKS IN ASYNCHRNOUS/SYNCHRONOUS MODE
						gotoPage(b.attr("data-index"), tryNum);				
					}, 100)
				});
				$(window).bind("popstate", function(event) {
					event.preventDefault();
					var state = event.originalEvent.state;
					self.log("popstate - state=" + (state && state.pageIdx != null ? state.pageIdx : "") + " - history.length=" + history.length, true);
					if (state && state.pageIdx != null){
						displayPage(state.pageIdx, state.tryNum);
						$("#" + id).find('button[data-index=' + state.pageIdx + ']').focus();
					}else{
						$("#" + pgId).html("<h1>History outside test page - Shouldn't be displayed</h1>");
					}
				});
				gotoPage(-1, tryNum);				
			});
		}
	});
	
}


$(document).ready(function(){
	_init();
	$(document).click(function(e){
		var $btn =$(e.target);	
		var process = $btn.closest(".panel-body").attr("data-process");
		if (_processes[process]){
			var action  = $btn.attr("data-action");
			var $res = $btn.closest(".panel-body").find(".result");
			if (action==="clear"){
				$res.empty();
			}else{
				new _processes[process](process, $res, $btn.attr("data-color")).run(action);
			}
		}
	});
	
});
	
</script>
<style type="text/css">
mark {
	background: none repeat scroll 0 0 #F5F5F5;
}

div {
	background: "#FFFFFF";
}
</style>
</head>

<body>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Test deferred</h3>
		</div>
		<div class="panel-body" data-process="deferred"  data-log="multi">
			<div class="btn-group">
				<button type="button" class="btn btn-default"
					data-action="parallelError" data-color="blue">Parallel - Fails</button>
				<button type="button" class="btn btn-default"
					data-action="paralleleSuccess" data-color="green">Parallel - Succeeds</button>
				<button type="button" class="btn btn-default"
					data-action="serieError" data-color="red">Serie - Fails</button>
				<button type="button" class="btn btn-default"
					data-action="serieSuccess" data-color="gray">Serie - Succeeds</button>
				<button type="button" class="btn btn-default"
					data-action="testDone" data-color="purple">Done and Then</button>
				<button type="button" class="btn btn-default" data-action="clear">Clear</button>
			</div>
			<p class="result"></p>
		</div>
	</div>
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Test smobile</h3>
		</div>
		<div class="panel-body" data-process="smobile">
			<div class="btn-group">
				<button type="button" class="btn btn-default"
					data-action="smdataUpdate">smdataUpdate</button>
				<button type="button" class="btn btn-default"
					data-action="smdataDisplay">smdataDisplay</button>
				<button type="button" class="btn btn-default"
					data-action="smdataRemove">smdataRemove</button>
				<button type="button" class="btn btn-default" data-action="clear">Clear</button>
			</div>
			<p class="result"></p>
		</div>
	</div>	
	<div class="panel panel-default">
		<div class="panel-heading">
			<h3 class="panel-title">Test navigation</h3>
		</div>
		<div class="panel-body" data-process="navigation">
			<div class="btn-group">
				<button type="button" class="btn btn-default"
					data-action="testHistory">testHistory</button>
				<button type="button" class="btn btn-default" data-action="clear">Clear</button>
			</div>
			<p class="result"></p>
		</div>
	</div>
</body>

</html>