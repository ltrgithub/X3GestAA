"use strict";

var driver = require("./driver");
var UT = require("../ut");

/**
 * Point browser to app url
 */
exports.loadApp = function() {
	return UT.Driver.Browser().get(UT.Config.url);
};

/**
 * Ensure user is logged in and sitting on the welcome page
 * @returns
 */
exports.ensureLogin = function() {
	return UT.App.waitPage("login")
		.then(function() {
			return UT.DOM.setInputById('login-user', UT.Config.user);
		})
		.then(function() {
			return UT.DOM.setInputById('login-password', UT.Config.password);
		})
		.then(function() {
			return UT.DOM.clickById('login-login');
		})
		.then(function() {

			return UT.App.waitModal("modal-endpoint", 5000)
				.then(function() {
					// Select context dialog is showing up so we fill and accept it
					return _handleModalSelectContext();
				})
				.thenCatch(function() {
					// Select context does not show up, so we asume it's cached and do nothing
					// next step will check for the welcome page and continue

				})
				.then(function() {
					return UT.App.waitPage("$welcomeDashboard.$mobileDashboard", 5000);
				});
		});
};

function _handleModalSelectContext() {
	// TODO: Fill and check values
	return UT.DOM.clickByAction("$validate");
}

function _checkCurrentContext() {

}

/** 
 * Wait for a page to open up, default timeout is 10000ms
 * Return is a promise with parameter beeing the found webelement
 */
exports.waitPage = function(pageName, timeout) {
	timeout = timeout != null ? timeout : 10000;
	UT.log("Waiting for page: " + pageName);
	return driver.Browser().wait(
		driver.Until.elementLocated(
			driver.By.xpath('//*[@data-s-ut-page-name="' + pageName + '"]' + '[@data-s-ut-page-is-current="' + pageName + '"]')
		),
		timeout
	);
};


/** 
 * Wait for a modal to open up, default timeout is 10000ms
 * Return is a promise with parameter beeing the found webelement
 */
exports.waitModal = function(modalName, timeout) {
	timeout = timeout != null ? timeout : 10000;
	UT.log("Waiting for modal: " + modalName);
	return driver.Browser().wait(
		driver.Until.elementLocated(
			driver.By.xpath('//*[@id="' + modalName + '"]')
		),
		timeout
	);
};