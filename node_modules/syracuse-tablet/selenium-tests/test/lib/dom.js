"use strict";

var driver = require("./driver");
var UT = require("../ut");

/**
 * Set value of element
 */
exports.setValue = function(selector, value, parent) {
	UT.log("Set value: '" + value + "' for " + JSON.stringify(selector) + (parent == null ? "" : JSON.stringify(parent)));
	return _findElement(selector, parent).then(function(element) {
		return element.getTagName().then(function(tagName) {
			if (tagName === "input") {
				return _setInputValue(element, value);
			} else if (tagName === "select") {
				return _setSelectValue(element, value);
			}
		});
	});
};

function _setInputValue(element, value) {
	return element.sendKeys(value);
}

function _setSelectValue(element, value) {
	UT.log("Select option: " + JSON.stringify(UT.SEL.$$Attr("value", value)));
	return element.click()
		.then(function() {
			// Needed for Edge
			return driver.Browser().sleep(250);
		})
		.then(function() {
			return element.findElement(UT.SEL.$$Attr("value", value));
		})
		.then(function(optionElement) {
			return optionElement.click();
		});
}

exports.getAttr = function(selector, attr, parent) {
	return _findElement(selector, parent).then(function(element) {
		return element.getAttribute(attr);
	});
};

/**
 * Click an element
 */
exports.click = function(selector, parent) {
	UT.log("Click " + JSON.stringify(selector) + (parent == null ? "" : JSON.stringify(parent)));
	return _findElement(selector, parent).then(function(element) {
		return element.click();
	});
};

exports.waitVisible = function(selector, timeout) {
	return exports.waitLocated(selector, timeout)
		.then(function(element) {
			return driver.Browser().wait(
				driver.Until.elementIsVisible(element),
				timeout);
		});
};

/**
 * Wait for selector to be available
 * If selector is an array of selectors, wait until the first is located
 */
exports.waitLocated = function(selector, timeout) {
	timeout = timeout != null ? timeout : 1;
	if (!Array.isArray(selector)) {
		return driver.Browser().wait(
			driver.Until.elementLocated(selector),
			timeout);
	} else {
		return driver.Browser().wait(
			driver.Until.elementsLocated(function() {
				var deferred = UT.Deferred();
				var founds = [];
				var done = 0;
				selector.forEach(function(sel, idx) {
					driver.Browser().wait(
						driver.Until.elementLocated(sel), 50)
						.then(function(found) {
							founds.push(found);
						})
						.thenCatch(function() {
							// Timeout
						})
						.thenFinally(function() {
							done++;
							if (done === selector.length) {
								if (founds.length > 0) {
									deferred.fulfill(founds[0]);
								}
								// The callback of elementsLocated is called as long as we resolve with null
								deferred.fulfill(null);
							}
						});
				});
				return deferred.promise;
			}),
			timeout)
			.then(function(elements) {
				return elements[0];
			});
	}
};

/**
 *
 */
function _findElement(selector, parent) {
	var parentStep;
	if (parent) {
		parentStep = driver.Browser().findElement(parent);
	} else {
		parentStep = UT.resolve(driver.Browser());
	}
	return parentStep.then(function(parentElement) {
		return parentElement.findElement(selector);
	});
}