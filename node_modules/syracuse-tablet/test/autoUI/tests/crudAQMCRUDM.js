"use strict";

var UT = require("./../lib/ut");

var _code;
var _texte;
var _texte2;

describe("Test CRUD on AQMCRUDM", function() {

	// Open browser, login, ensure browser is closed once all tests were executed
	UT.defaultBeforeAndAfter();

	it("Navigate to create page", function() {
		this.timeout(15000);
		return UT.App.navToTestPage("x3.erp.SUPERV.AQMCRUDM.$query", "testAutoUI_AQMDEVICE_Query")
			.then(function() {
				return UT.Dom.click(UT.Sel.X3Link("$create"),
					null,
					UT.App.waitPage$("x3.erp.SUPERV.AQMCRUDM.$create"));
			});
	});

	it("Enter data and save", function() {
		this.timeout(20000);
		return UT.Dom.getValue(UT.Sel.Field("CODE"))
			.then(function(text) {
				UT.log("Key generated: " + text);
				_code = text;
				_texte = "TEST:" + _code;
				return UT.Dom.setValue(UT.Sel.Field("TEXTE"), _texte);
			})
			.then(function() {
				// Not required by this test case but seems to be a mandatory field during $edit later
				return UT.Dom.setValue(UT.Sel.Field("MODULE"), "1");
			})
			.then(function() {
				return UT.Dom.click(UT.Sel.X3Link("$save"),
					null,
					UT.App.waitPage$("x3.erp.SUPERV.AQMCRUDM.$query"));
			});
	});
	it("Search new record", function() {
		this.timeout(10000);
		return UT.App.searchInGrid(UT.Sel.Field("$resources"), _texte);
	});

	it("Goto detail page and validate TEXTE", function() {
		this.timeout(10000);
		return UT.Dom.find(UT.Sel.Row(0), UT.Sel.Field("$resources"))
			.then(function($$gridRow) {
				return UT.Dom.click($$gridRow, null, UT.App.waitPage$("x3.erp.SUPERV.AQMCRUDM.$details", 5000));
			})
			.then(function() {
				return UT.Dom.getValue(UT.Sel.Field("TEXTE"));
			})
			.then(function(text) {
				// Check if first line of query search brings us to the record we created before
				UT.assertEquals(text, _texte, "Text has been saved as expected");
			});
	});

	it("Goto edit page and change TEXTE", function() {
		this.timeout(10000);
		return UT.Dom.click(UT.Sel.X3Link("$edit"),
			null,
			UT.App.waitPage$("x3.erp.SUPERV.AQMCRUDM.$edit"))
			.then(function() {
				_texte2 = "TESTMOD:" + _code;
				return UT.Dom.setValue(UT.Sel.Field("TEXTE"), _texte2);
			})
			.then(function() {
				return UT.Dom.click(UT.Sel.X3Link("$save"),
					null,
					UT.App.waitPage$("x3.erp.SUPERV.AQMCRUDM.$details"));
			})
			.then(function() {
				return UT.Dom.getValue(UT.Sel.Field("TEXTE"));
			})
			.then(function(text) {
				// Check if modification did work
				UT.assertEquals(text, _texte2, "Text has been modified as expected");
			});
	});

	it("Delete test record", function() {
		this.timeout(10000);
		return UT.Dom.click(UT.Sel.X3Link("$delete"))
			.then(function() {
				return UT.App.confirm("yes");
			})
			.then(function() {
				return UT.App.waitPage("x3.erp.SUPERV.AQMCRUDM.$query", 5000);
			})
			.then(function(text) {
				return UT.assertOk("All is good if we end up here");
			});
	});
});