"use strict";

var UT = require("./../lib/ut");
var WCODE;
//=========================================================================================
//============ Test using AQMCRUDM, Create Collection lines from Create facet==============
//========================================================================================= 
describe("AQMCRUDM Record and Collection create", function() {
	UT.defaultBeforeAndAfter({
		testPageUrl: "{$hostPort}/mobile2/x3/erp/GX3APP/AQMDEVICE?representation=AQMCRUDM.$query&$mobileEndpoint=x3.erp.GX3APP&$mobileProtocol=workingcopy&$forceProtocol=true"
	});

	it("Button Create", function() {
		return UT.Dom.waitLocated(UT.Sel.Xpath("//a[@data-sdata-link-name='$create']"), 1500).then(function() {
			return UT.Dom.click(UT.Sel.Xpath("//a[@data-sdata-link-name='$create']"), null, UT.App.waitPage$("AQMCRUDM.$edit", 2000));
		});
	});

	it("Set values to create - first", function() {
		return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='TEXTDES0']/div[2]/div//input[@class='s-m-meta form-control']"), "Description")
			.then(function() {
				return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='TEXTAXX']/div[2]/div//input[@class='s-m-meta form-control']"), "Create new")
					.then(function() {
						return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='TDATE']/div[2]/div//input[@class='s-m-meta form-control']"), "12/29/2016")
							.then(function() {
								return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='SITE_REF']/div[2]/div//input[@class='s-m-meta form-control']"), "0032")
							});
					});
			});
	});

	it("Set values to create - second", function() {
		return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='UNIT_REF']/div[2]/div//input[@class='s-m-meta form-control']"), "BA")
			.then(function() {
				return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='DIVERS0_REF']/div[2]/div//input[@class='s-m-meta form-control']"), "PROJECT")
			});
	});


	it("Waiting for browser finish", function() {
		// Simulate an error in order to click on next event
		return UT.App.waitPage("[To improve]", 1000);
	});

	it("Get key of the new record", function() {
		return UT.Dom.getValue(UT.Sel.X3Field("CODE")).then(function(text) {
			WCODE = text;
			UT.log("==>CODE created: " + WCODE);
		});
	});

	it("Collection create - click on sign plus (addRow)..", function() {
		return UT.Dom.waitLocated(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='ADEVADEVCOL1']/div[2]/table/tfoot/tr/td/div/a[@data-naction='addRow']"), 1500).then(function() {
			return UT.Dom.click(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='ADEVADEVCOL1']/div[2]/table/tfoot/tr/td/div/a[@data-naction='addRow']"), null, UT.App.waitPage$("noname", 2000));
		});
	});

	it("Set values for Second collection...", function() {
		return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='ADEVCOL2SUBCODE']/div[2]/div//input[@class='s-m-meta form-control']"), "1570")
			.then(function() {
				return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='ADEVCOL2TEXTDES']/div[2]/div//input[@class='s-m-meta form-control']"), "Description of key")
					.then(function() {
						return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='ADEVCOL2SITE_REF']/div[2]/div//input[@class='s-m-meta form-control']"), "001A")
							.then(function() {
								return UT.Dom.setValue(UT.Sel.Xpath("//div[@data-s-ut-field-x3name='PDATE_COL1']/div[2]/div//input[@class='s-m-meta form-control']"), "12/29/2016")
									.then(function() {
										//--- Validate the input of collection --------------------------------
										return UT.Dom.click(UT.Sel.Xpath("//a[@data-menuitem-id='accept']/i"));
									});

							});
					});
			});
	});
	//---- return to main page ----------------------------------------------------
	it("Waiting for browser finish..", function() {
		// Simulate an error in order to click on next event
		return UT.App.waitPage("[To improve]", 2000);
	});

	it("Save final", function() {
		return UT.Dom.waitLocated(UT.Sel.Xpath("//a[@data-sdata-action-name='$save']"), 1500)
			.then(function() {
				return UT.Dom.click(UT.Sel.Xpath("//a[@data-sdata-action-name='$save']"))
					.then(function() {
						//-- It is ok - click on this panel confirm -------------------------------------
						return UT.Dom.waitLocated(UT.Sel.Xpath("//span[@class='glyphicon glyphicon-remove']"), 1200)
							.then(function() {
								return UT.Dom.click(UT.Sel.Xpath("//span[@class='glyphicon glyphicon-remove']"))
							});

					});
			});
	});

	it("Waiting for browser finish...", function() {
		// Simulate an error in order to click on next event
		return UT.App.waitPage("[To improve]", 2000);
	});

	it("Search new key to delete.", function() {
		return UT.Dom.getValue(UT.Sel.X3Field("CODE")).then(function(ttext) {
			//-- search -----------------------------------------------------
			UT.log("CODE again: " + ttext + "  WCODE=" + WCODE);
			return UT.App.search(WCODE, "AQMCRUDM.$query").then(function() {
				return UT.App.waitPage("[To improve]", 1500);
			});
		});
	});

	it("Detail of record to delete", function() {
		return UT.Dom.waitLocated(UT.Sel.Xpath("//tr[@data-s-ut-row-idx='0']"), 1500).then(function() {
			return UT.Dom.click(UT.Sel.Xpath("//tr[@data-s-ut-row-idx='0']"), null, UT.App.waitPage$("AQMCRUDM.$details", 2000))
				.then(function() {
					//--- delete it ----
					return UT.Dom.waitLocated(UT.Sel.Xpath("//a[@data-sdata-link-name='$delete']/i"), 1500).then(function() {
						return UT.Dom.click(UT.Sel.Xpath("//a[@data-sdata-link-name='$delete']/i"))
							.then(function() {
								return UT.Dom.waitLocated(UT.Sel.Xpath("//button[@data-action='yes']"), 1500).then(function() {
									return UT.Dom.click(UT.Sel.Xpath("//button[@data-action='yes']"))
										.then(function() {
											return UT.App.waitPage("[To improve]", 2200);
										});
								});
							});
					});
				});
		});
	});

	it("Waiting for confirm panel..", function() {
		//-- It is ok - click on this panel confirm -------------------------------------
		return UT.Dom.waitLocated(UT.Sel.Xpath("//span[@class='glyphicon glyphicon-remove']"), 2000)
			.then(function() {
				return UT.Dom.click(UT.Sel.Xpath("//span[@class='glyphicon glyphicon-remove']"))
			});
	});

	it("Waiting for browser finish..", function() {
		// Simulate an error in order to click on next event
		return UT.App.waitPage("[To improve]", 2000);
	});
	// ----------------------------------------------------------------------------
	//------ Logout with span.fa.fa-bars: Burger  icon ----------------------------
	// ----------------------------------------------------------------------------
	it("Logout of Edit facet", function() {
		return UT.App.logout();
	});

});