"use strict";

var UT = require("./../lib/ut");
//=================================================================================================================
//== Test using AQMCRUDM, Propagate all properties from TPOSIF number positif>=2017 from Edit facet================
//================================================================================================================= 
describe("AQMCRUDM Collection create", function() {
	UT.defaultBeforeAndAfter({
		testPageUrl: "{$hostPort}/mobile2/x3/erp/GX3APP/AQMDEVICE('18')/$workingCopies?representation=AQMCRUDM.$edit"
	});

	it("Get values before propagate of the record 18", function() {
		var TEXTDES;
		var TDATE;
		//var currentCyle;	     
		return UT.Dom.getValue(UT.Sel.X3Field("TDATE")).then(function(text) {
			TDATE = text;
			UT.log("TDATE: " + text);
			return UT.Dom.getValue(UT.Sel.X3Field("TEXTDES0")).then(function(textdes) {
				UT.log("TEXTDES before: " + textdes);
				UT.assertEquals(true, (textdes || "").indexOf("Manhattan modif") > -1, "Word: 'Manhattan modif' not found");
			})
		})

	});
	it("Get values before propagate", function() {
		var currentCyle;
		return UT.Dom.getValue(UT.Sel.X3Field("TDCB")).then(function(tdcb) {
				return UT.Dom.getValue(UT.Sel.X3Field("TDCB2")).then(function(tdcb2) {
					return UT.Dom.getValue(UT.Sel.X3Field("TDCB3")).then(function(total) {
						UT.log("==>TDCB before: " + tdcb);
						UT.log("==>TDCB2 before: " + tdcb2);
						UT.log("===>TDCB3 total before: " + total);
					})
				})
			}).then(function() {
				return UT.Dom.getPageCycle(UT.Sel.Page("AQMCRUDM.$edit"));
			}).then(function(cycle) {
				currentCyle = cycle;
				UT.log("CYCLE: " + cycle);
				// Setting TPOSIF to a value should update TDCB3 on server side to contain the value that was set on TPOSIF
				return UT.Dom.setValue(UT.Sel.X3Field("TPOSIF"), "2017");
			}).then(function() {
				return UT.Dom.waitPageCycleChange(UT.Sel.Page("AQMCRUDM.$edit"), null, currentCyle);
			})
			.then(function(text) {
				return UT.Dom.getValue(UT.Sel.X3Field("TDCB"))
			}).then(function(text) {
				UT.log("TDCB  after: " + text);
				return UT.Dom.getValue(UT.Sel.X3Field("TDCB2")).then(function(tdcb2) {
					UT.log("TDCB2 after: " + tdcb2);
					return UT.Dom.getValue(UT.Sel.X3Field("TDCB3")).then(function(tdcb3) {
						UT.log("TDCB3=TDCB+TDCB2 total after: " + tdcb3);
					}).then(function(textaxx) {
						return UT.Dom.getValue(UT.Sel.X3Field("TEXTDES0")).then(function(textaxx) {
							UT.log("TEXTDES0 after: " + textaxx);
							UT.assertEquals(true, (textaxx || "").indexOf("Woco propagate TPOSIF>=2017") > -1, "TEXTDES0 Not propagate...'");
						});
					})
				})

			});
	});

	it("Get values Reference before propagate", function() {
		var CUR;
		return UT.Dom.getValue(UT.Sel.X3Field("CUR_REF")).then(function(text) {
			CUR = text;
			UT.log("=>Reference CURENCY before: " + text);
			UT.assertEquals(true, (text || "").indexOf("AUD") > -1, "Currency must have AUD");
		})
	});


	// ---------------------------------------------------------------------
	//------ Edit mode  ----------------------------------------------------
	// ---------------------------------------------------------------------
	//it("Edit facet", function() {
	//	var $$$edit = UT.Sel.X3Link("$edit");
	//	return UT.Dom.waitLocated($$$edit, 800).then(function() {
	//		return UT.Dom.click($$$edit, null, UT.App.waitPage$("AQMCRUDM.$edit", 2000));
	//	});
	//});


	// ---------------------------------------------------------------------
	//------ Logout with span.fa.fa-bars: Burger  icon ---------------------
	// ---------------------------------------------------------------------
	it("Logout of Edit facet", function() {
		return UT.App.logout();
	});

});