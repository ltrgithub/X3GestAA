"use strict";

require('syracuse-tablet/html/js/helpers/nativePrototypes');
var Layout = require('syracuse-tablet/html/js/ui/widgets/layout').Layout;
var eventListener = require('syracuse-tablet/html/js/ui/widgets/eventListener');
var templates = require('syracuse-tablet/html/js/helpers/templating');
var globals = require('syracuse-tablet/html/js/helpers/globals');

var resources = require("./resources");

exports.main = function() {
	// init globals -- development mode true
	globals.init(true);

	// preload layout templates
	var newRoot = "/html";
	templates.setTmplRoot(newRoot);
	templates.preload(["widgets/layout", "widgets/field"]);

	$("a[data-sm-menu]")
		.bind(
			"click",
			function(event) {

				var bodyLayout = document
					.getElementById("sm-site-body-layout");

				// widget-test-fields"
				switch (event.target.getAttribute("data-sm-menu")) {
					case "widget-test-fields":
						var listItemParent = event.target.parentNode;
						if (listItemParent.className.indexOf("active") < 0) {
							// == clean body ==
							$(bodyLayout).empty();

							// == remove active state from other links in
							// navbar ==
							$(".nav.navbar-nav").children().toggleClass(
								"active", false);

							// == remove active state from other links in
							// sub
							// menus list ==
							$(".dropdown-menu").children().toggleClass(
								"active", false);

							// == append test widgets ==
							buildFieldWidgets($(bodyLayout));


							// == set active state in nav bar ==
							$(listItemParent).toggleClass("active", true);
						}
						break;
					case "widget-test-diagnoses":
						break;
					case "widget-test-layout-1":
					case "widget-test-layout-2":
					case "widget-test-layout-3":
					case "widget-test-layout-4":
					case "widget-test-layout-5":

						if (event.target.parentNode.className
							.indexOf("active") < 0) {
							// == clean body ==
							$(bodyLayout).empty();
							var sampleNumber = event.target.getAttribute(
								"data-sm-menu").match(/\d/g);

							// == remove active state from other links in
							// navbar
							// ==

							$(".nav.navbar-nav").children().toggleClass(
								"active", false);

							// == remove active state from other links in
							// sub
							// menus list ==
							$(event.target.parentNode.parentNode)
								.children()
								.toggleClass("active", false);

							// == set active state in nav bar ==
							$(event.target.parentNode.parentNode.parentNode)
								.toggleClass("active", true);

							// == set active state in sub menus list ==
							$(event.target.parentNode).toggleClass(
								"active", true);

							// == set active state in nav bar ==
							$(event.target.parentNode.parentNode.parentNode)
								.toggleClass("active", true);

							// == set active state in sub menus list ==
							$(event.target.parentNode).toggleClass(
								"active", true);

							// == append widget ==
							var sampleLayout = (new Layout())
								.loadLayout(resources["$articleSample" + sampleNumber]);
							// TODO

							var strHtml = sampleLayout.buildHtml();

							$(bodyLayout).html(strHtml);
						}
						break;
					default:
						break;
				}
			});
	eventListener.bindEvents();
};

function buildFieldWidgets($$layoutParent) {
	var testCases = resources.fieldTestCases;
	var strHtml = [];
	for (var ii = 0, jj = testCases.length; ii < jj; ii++) {
		strHtml.push("<h2>" + testCases[ii].title + "</h2>");
		strHtml.push("<table style='width:100%'><tr><td style='padding:1.5em'>" + templates.execSync(getTmplId(testCases[ii].type),
			testCases[ii].editContext) + "</td>" + "<td style='padding:1.5em'>" + templates.execSync(getTmplId(testCases[ii].type),
			testCases[ii].detailContext) + "</td></tr></table>");
		strHtml.push("<br>");
	}
	$$layoutParent.html(strHtml);
}

function getTmplId(widgetType) {
	var tmplId;
	switch (widgetType) {
		case "application/x-choice":
			tmplId = "tmplFieldChoice";
			break;
		case "application/x-boolean":
			tmplId = "tmplFieldBoolean";
			break;
		case "application/x-progress":
			tmplId = "tmplFieldProgress";
			break;
		default:
			tmplId = "tmplField";
	}
	return tmplId;
}