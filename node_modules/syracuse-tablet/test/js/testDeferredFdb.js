"use strict";
var libTests = require('syracuse-tablet/test/js/libTests');

exports.modulename = "DeferredFDB";

exports.test = function() {

	try {
		var testset = libTests.addTestset("Deferred pattern");
		var testcase;

		try {
			testcase = testset.addTestcase("Simple resolve");
			$.smResolve("xxx")
				.then(function(param) {
					// Ok to be here			
					testcase.addResult("Resolved as expected", true);
					testcase.addResult("Value ok", param === "xxx");
				}, function(param) {
					testcase.addResult("Rejected as NOT expected", false);
				});
		} catch (e) {
			testcase.addResult("Exception as NOT expected", false);
		}

		try {
			testcase = testset.addTestcase("Simple reject");
			$.smReject("xxx")
				.then(function(param) {
					testcase.addResult("Resolved as NOT expected", false);
				}, function(param) {
					// Ok to be here
					testcase.addResult("Rejected as expected", true);
					testcase.addResult("Value ok", param === "xxx");
				});
		} catch (e) {
			testcase.addResult("Exception as NOT expected", false);
		}

		try {
			testcase = testset.addTestcase("Test Reject");
			$.smResolve("xxx")
				.then(function(param) {
					return $.Deferred(function(d) {
						d.reject("rejected data");
					}).promise();
				}, function(param) {
					testcase.addResult("Rejected as NOT expected", false);
				}).then(function(param) {
					return "ffff";
				}, function(param) {
					testcase.addResult("Rejected is expected", param === "rejected data");
				})
				.then(function(param) {
					// we never end up here because of throw
					testcase.addResult("Resolved is NOT expected", false);
				}).fail(function(param) {
					// we never end up here because of throw
					testcase.addResult("LAST Rejected is expected", param == null, "Param is null");
				});
		} catch (e) {
			testcase.addResult("Outer stack exception as NOT expected", false);
		}

		var esSynch = "Sync exception 1";
		try {
			testcase = testset.addTestcase("Test Throw Exception");
			$.smResolve("xxx")
				.then(function(param) {
					testcase.addResult("Resolved is expected", true);
					throw (esSynch);
				}, function(param) {
					// No error handler here
					testcase.addResult("Reject is NOT expected", false);
				}).then(function(param) {
					testcase.addResult("Resolved is NOT expected", false);
				}, function(param) {
					// Error handler here
					testcase.addResult("Rejected is expected", param === esSynch);
				})
				.then(function(param) {
					// we never end up here because of throw
					testcase.addResult("Resolved is NOT expected", false);
				}).fail(function(param) {
					// we never end up here because of throw
					testcase.addResult("LAST Rejected is expected", param == null, "Param is null");
				});
		} catch (e) {
			testcase.addResult("Outer stack exception as NOT expected", false);
		}

		var esSynch = "Sync exception 2";
		try {
			testcase = testset.addTestcase("Test Throw Exception");
			$.smResolve("xxx")
				.then(function(param) {
					testcase.addResult("Resolved as expected", true);
				}).then(function(param) {
					testcase.addResult("Resolved as expected", true);
					throw (esSynch);
				}, function(param) {
					testcase.addResult("Rejected is expected", false);
				})
				.then(function(param) {
					// we never end up here because of throw
					testcase.addResult("Resolved is NOT expected", false);
				}).fail(function(param) {
					// Param not null because no fail handler before
					testcase.addResult("LAST Rejected is expected", param == esSynch, param);
				});
		} catch (e) {
			testcase.addResult("Outer stack exception as NOT expected", false);
		}


		var esAsynch = "Async error";
		var testcaseAsync;
		try {
			testcaseAsync = testset.addTestcase("Test throw Async exception");
			$.smResolve("xxx")
				.then(function(param) {
					testcaseAsync.addResult("Resolved as expected", true);
					testcaseAsync.addResult("Value ok", param === "xxx", param);
					var d = $.Deferred();
					setTimeout(function() {
						d.resolve("yyy");
						testcaseAsync.addResult("Next Success statement NOT expected", true, "We can't prevent it because excption is caught in promise.then");
					}, 0);
					return d.promise();
				})
				.then(function(param) {
					testcaseAsync.addResult("Resolved as expected", true);
					testcaseAsync.addResult("Value ok", param === "yyy", param);
					throw esAsynch;
				}, function(param) {
					// To make sure that reject is actually propagated
					testcaseAsync.addResult("Reject not  expected", true, param);
				})
				.then(function(param) {
					// To make sure that reject is actually propagated
					testcaseAsync.addResult("Resolved NOT expected", false);
				}, function(param) {
					// To make sure that reject is actually propagated
					testcaseAsync.addResult("Reject is  expected", param === esAsynch, param || "No param");
				})
				.then(function(param) {
					// To make sure that reject is actually propagated
					testcaseAsync.addResult("Resolved NOT expected", false);
				})
				.then(function(param) {
					// we never end up here because of throw
					testcaseAsync.addResult("Resolved as NOT expected", false);
				}).fail(function(param) {
					// we never end up here because of throw
					testcaseAsync.addResult("LAST Rejected is expected", param == null, "Param is null");
				});
		} catch (e) {
			// we never end up here because of throw is another async process with another stack
			testcaseAsync.addResult("Outer stack exception is NOT expected", false);
		}


		return $.smResolve();
	} finally {}
};