"use strict";

var log = require('syracuse-tablet/html/js/helpers/logger').getLogger("testAjax");
var testUtil = require('syracuse-tablet/test/js/testUtil');
var ajax = require('syracuse-tablet/html/js/ajax/ajax').getAjax().ajax;

exports.modulename = "ajax";
exports.test = function() {
	var deferred = $.Deferred();
	try {
		var baseUrl = window.location.protocol + "//" + window.location.host;
		var testset = testUtil.addTestset("Ajax test");
		var testcase = testset.addTestcase("GET json file");
		var result = ajax("GET", baseUrl + "/syracuse-tablet/test/fixtures/dummyToGet.json", null, null);

		result.then(function(data, respHeaders) {
			testcase.addResult("Data returned", data != null);
			testcase.addResult("Status is 200 for existing file", respHeaders.status === 200);
			testcase.addResult("Message parsed correctly", data && data.success === true);
		}, function(status, respHeaders) {
			testcase.addResult("Request failed!", false);
		}).then(function() {
			result = ajax("GET", baseUrl + "/syracuse-tablet/test/fixtures/IDoNotExist.json", null, null);

			result.then(function(data, respHeaders) {
				testcase.addResult("Returned success also file is not there", true);
			}, function(status, respHeaders) {
				testcase.addResult("Status is 404 for non existent file", respHeaders.status === 404);
			}).then(function() {
				deferred.resolve();
			});
		}).then(function() {
			deferred.resolve();
		});
	} catch (e) {
		log && log("Test ajax error");
		log && log(e);
		deferred.reject(e);
	} finally {
		return deferred.promise();
	}
};