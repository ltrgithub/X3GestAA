"use strict";

var ezmailer = require('ez-mailer');

exports.entity = {
	$titleTemplate: "Mail Template",
	$descriptionTemplate: "Mail template",
	$valueTemplate: "{name}",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		from: {
			$title: "From",
			$isMandatory: true,
		},
		to: {
			$title: "To",
			$isMandatory: true,
		},
		cc: {
			$title: "Cc",
		},
		bcc: {
			$title: "Bcc",
		},
		subject: {
			$title: "Subject",
			$isMandatory: true,
		},
		html: {
			$title: "Body",
			$type: "text/html",
		},
		// File properties
		attachments: {
			$title: "attachments",
			$type: "string", // should be strings
		},
	},
	$relations: {},
	$searchIndex: {
		$fields: ["name"]
	},
	$functions: {
		sendMail: function(_, message) {
			var settings = require('syracuse-collaboration/lib/entities/setting').getInstance(_, this._db).mailer(_);
			if (!settings) throw new Error("mailer has not been configured");
			settings = settings.mailerOptions(_);
			var mailer = ezmailer.writer(settings);
			var formatter = ezmailer.messageFormatter(this.serializeInstance(_));
			mailer.writeAll(_, formatter(_, message));
		},
	},
	$services: {},
	$events: {},
};