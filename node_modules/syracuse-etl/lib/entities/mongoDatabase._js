"use strict";

var ez = require('ez-streams');
var mongodb = require('mongodb');
var config = require('config');

exports.entity = {
	$titleTemplate: "Mongo DB Database",
	$descriptionTemplate: "Mongo DB Database",
	$valueTemplate: "{name}",
	$properties: {
		name: {
			$title: "Name",
			$isMandatory: true,
			$isUnique: true,
			$linksToDetails: true
		},
		description: {
			$title: "Description",
			$isLocalized: true
		},
		host: {
			$title: "Host",
			$isMandatory: true,
			$default: (config.collaboration && config.collaboration.hostname) || "localhost",
		},
		port: {
			$title: "Port",
			$type: "integer",
			$isMandatory: true,
			$default: (config.collaboration && config.collaboration.port) || 27017,
		},
		connectionString: {
			$title: "Connection string",
			$description: "Optional connection string for replica sets, will override host and port",
			$default: ((config.collaboration && config.collaboration.connectionString) || "")
		},
		database: {
			$title: "Database name",
			$isMandatory: true,
		},
	},
	$relations: {
		//devices: {}
	},
	$searchIndex: {
		$fields: ["name"]
	},
	$functions: {
		getDb: function(_) {
			if (this._cachedDb) return this._cachedDb;
			/*			var server = new mongodb.Server(this.host(_), this.port(_), {});
			var db = new mongodb.Db(this.database(_), server, {
				w: "majority"
			});
			return (this._cachedDb = db.open(_));*/
			// TODO: should define options in entity for db, server, replSet, mongos
			return this._cacheDb = mongodb.MongoClient.connect("mongodb://" + (this.connectionString(_) || (this.host(_) + ":" + this.port(_))) + "/" + this.database(_), {
				db: {
					w: 1
				}
			}, _);
		},
	},
	$services: {},
	$events: {},
};