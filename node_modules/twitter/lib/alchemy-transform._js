"use strict";

var AlchemyAPI = require('alchemy-api');

module.exports = function() {
	var alchemy = new AlchemyAPI('b07b434e1a7f9bd63a1e43dab8c01dea9649b086');

	return function(_, reader, writer) {
		var tweet;

		while(true)
		{
			tweet = reader.read(_);
			if (tweet === undefined)
			{
				// end of in-stream
				return;
			}

			// Use alchemy to compute the sentiment of the text
			try {
				var response = alchemy.sentiment(tweet.text, {},_);
				//console.error('SCORE = ' + JSON.stringify(response));
				if ((response.status == "OK") && response.docSentiment)
				{
					var record =  {
						tweet : tweet,
						sentiment : {
							score : response.docSentiment.score,
							type: response.docSentiment.type,
						}
					};
					writer.write(_, record);
				}
				else
				{
					console.error('Tweet could not be processed [id = ' + tweet.id + '], status = ' + response.status);
				}
			}
			catch (err)
			{
				console.error('Could not analyze the tweet ' + tweet.id + ", reason = " + err.message);		
			}
		}
	};
};