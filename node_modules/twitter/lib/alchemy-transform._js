"use strict";

var AlchemyAPI = require('alchemy-api');

module.exports = function() {
	var alchemy = new AlchemyAPI('d6b82fb5a8cbda2c6ed1dd8ba09aac5c7d4e9927');
	//var alchemy = new AlchemyAPI('7042ea9628e89618064bbd11f41701ab5dcf2624')

	return function(_, reader, writer) {
		var record;
		var id=0;
		while(true)
		{
			record = reader.read(_);
			if (record === undefined)
			{
				// end of in-stream
				return;
			}

			var response;
			// Use alchemy to compute the sentiment of the text
			try {
				console.log("record.tweet.text:"+record.tweet.text);
				response = alchemy.sentiment(record.tweet.text, {}, ~_);
				// console.error('SCORE = ' + JSON.stringify(record.tweet.text));
				if ((response.status == "OK") && response.docSentiment)
				{
					record.sentiment = {
						score : response.docSentiment.score,
						type: response.docSentiment.type,
					};
					console.log((++id)+" tweet:"+record.tweet.id+","+JSON.stringify(record.sentiment));
					writer.write(_, record);
				}
				else
				{
					console.error('Tweet could not be processed [id = ' + record.tweet.id + '], text:'+record.tweet.text+' status = ' + response.status);
				}
			}
			catch (err)
			{
				console.error('Could not analyze the tweet ' + record.tweet.id + ", reason = " + err);
			}
		}
	};
};