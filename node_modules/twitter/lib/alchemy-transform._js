"use strict";

var AlchemyAPI = require('alchemy-api');

module.exports = function() {
	var alchemy = new AlchemyAPI('d7881779bae08d6277a1bf392f60a9a6ffc2cf01');

	return function(_, reader, writer) {
		var record;

		while(true)
		{
			record = reader.read(_);
			if (record === undefined)
			{
				// end of in-stream
				return;
			}

			// Use alchemy to compute the sentiment of the text
			try {
				//console.log("record.tweet.text:"+record.tweet.text);
				var response = alchemy.sentiment(record.tweet.text, {},_);
				//console.error('SCORE = ' + JSON.stringify(response));
				if ((response.status == "OK") && response.docSentiment)
				{
					record.sentiment = {
						score : response.docSentiment.score,
						type: response.docSentiment.type,
					};
					writer.write(_, record);
				}
				else
				{
					console.error('Tweet could not be processed [id = ' + record.tweet.id + '], status = ' + response.status);
				}
			}
			catch (err)
			{
				console.error('Could not analyze the tweet ' + record.tweet.id + ", reason = " + err.message);		
			}
		}
	};
};