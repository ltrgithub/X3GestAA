"use strict";

/* jshint -W079 */
///* jshint unused: false */
/* global QUnit: false, ok: false, asyncTest: false, test: false, strictEqual: false, start: false, stop: false */

var nodeconfig = require('syracuse-main/lib/nodeconfig').config;
var SadFsqClient = require('syracuse-adxadmin/lib/sadfsq/sadfsqClient').SadFsqClient;
var util = require('util');

var tests = [{
		str: "test buffer quite simple: AZERTY",
		fileOptions: {
			folder: "SUPERV",
			path: "tmp",
			name: "test",
			extension: "tst"
		}
	},
	//{
	//	str: "test buffer more complex: <>-*/+.!?:;,",
	//	fileOptions:{
	//		folder: "SUPERV",
	//		path: "tmp",
	//		name: "test2",
	//		extension: "tst"
	//	}
	//},
	//{
	//	str: "test buffer really more complex: &é'([-|è_ç@à$£¤µ%§°}{]#~`²",
	//	fileOptions:{
	//		canonical: "@SUPERV.tmp/test3$tst"
	//	}
	//}
];

var done;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (done) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

var sadfs;

function completeTest(param, i) {

	var bufStr = new Buffer(param.str, "utf-8");
	var fileOptions = param.fileOptions;

	asyncTest("client class instanciation", function(_) {
		var sadUnitConfig = nodeconfig.x3sadfsq && nodeconfig.x3sadfsq.qunit && nodeconfig.x3sadfsq.qunit || {};
		var connCtx = {
			server: sadUnitConfig.server ? sadUnitConfig.server : "sodaix02",
			port: sadUnitConfig.port ? sadUnitConfig.port : 17000,
			user: sadUnitConfig.user ? sadUnitConfig.user : "apisu",
			pass: sadUnitConfig.pass ? sadUnitConfig.pass : "CRYPT:xkvvaTccvr",
			secure: sadUnitConfig.secure ? true : false
		};
		var recOptions = {
			recMode: sadUnitConfig.online ? "REC" : "PLAY",
			fileName: "apiTest_" + i + ".json"
		};
		if (recOptions.recMode === "REC") recOptions.overwrite = true; // always override file
		sadfs = new SadFsqClient(_, connCtx.server, connCtx.port, connCtx.user, connCtx.pass, connCtx.secure, recOptions);
		strictEqual(sadfs.stream != null, true, "Stream is opened");
		start();
	});

	asyncTest("open and close new file", 1, function(_) {
		try {
			var fd = sadfs.open(_, fileOptions, "w");
			sadfs.close(_, fd);
			ok(true, "open and close file ok");
			start();
		} catch (e) {
			// nothin		
			console.error(e.stack);
			ok(false, "open and close file " + e.message + " " + e.stack);
		}
	});

	asyncTest("writeFile", function(_) {
		sadfs.writeFile(_, fileOptions, bufStr, {
			flag: "w"
		});
		strictEqual(true, true, "write ok "); // just to display that the write is ok. if it's not it raise an exception
		start();
	});

	asyncTest("readFile", function(_) {
		var res = sadfs.readFile(_, fileOptions, {
			flag: "r",
			encoding: "utf-8"
		});
		strictEqual(res, param.str, "content ok: " + res);
		start();
	});

	asyncTest("path", function(_) {
		var path = sadfs.path(_, fileOptions);
		strictEqual(path != null, true, "get path " + path);

		start();
	});

	asyncTest("info", 12, function(_) {
		var res = sadfs.stat(_, fileOptions);
		var keys = Object.keys(res);
		for (var i in keys) {
			strictEqual(res[keys[i]] != null, true, keys[i] + ": " + res[keys[i]] + " OK");
		}
		var res2 = sadfs.stat(_, fileOptions, ["size"]);
		strictEqual(res2.size, res.size, "size: " + res2.size + " OK");
		start();
	});

	asyncTest("write", function(_) {
		var buffer = new Buffer(param.str, "utf-8");
		var fd = sadfs.open(_, fileOptions, "w");
		sadfs.write(_, fd, buffer, 0, buffer.length, 0);
		sadfs.close(_, fd);
		strictEqual(true, true, "write ok "); // just to display that the write is ok. if it's not it raise an exception
		start();
	});

	asyncTest("read", function(_) {
		var fd = sadfs.open(_, fileOptions, "r");
		var buffer = new Buffer(80);

		var len = sadfs.read(_, fd, buffer, 0, 8);
		strictEqual(len, 8, "Size read 1 ok: " + len);
		strictEqual(buffer.slice(0, 8).toString('hex'), bufStr.slice(0, 8).toString('hex'), "Buffer content 1 ok");

		len = sadfs.read(_, fd, buffer, 8, 8);
		strictEqual(len, 8, "Size read 2 ok: " + len);
		strictEqual(buffer.slice(8, 16).toString('hex'), bufStr.slice(8, 16).toString('hex'), "Buffer content 2 ok");

		var position = sadfs.getPosition(_, fd);
		strictEqual(position, 16, "Position ok");

		len = sadfs.read(_, fd, buffer, 16, 0);
		strictEqual(len, 0, "Size read 3 ok: " + len);

		len = sadfs.read(_, fd, buffer, 16, 64);
		strictEqual(len, bufStr.length - 16, "Size read 4 ok: " + len);
		strictEqual(buffer.slice(16, bufStr.length).toString('hex'), bufStr.slice(16).toString('hex'), "Buffer content 4 ok");

		position = sadfs.getPosition(_, fd);
		strictEqual(position, bufStr.length, "Position ok");

		len = sadfs.read(_, fd, buffer, 8, 10, 8);
		strictEqual(len, 10, "Size read 5 ok: " + len);
		strictEqual(buffer.slice(8, 18).toString('hex'), bufStr.slice(8, 18).toString('hex'), "Buffer content 5 (with defined position) ok");

		sadfs.close(_, fd);
		strictEqual(param.str, buffer.slice(0, bufStr.length).toString('utf-8'), "Content ok: " + param.str);
		start();
	});

	asyncTest("seek and get position", 12, function(_) {
		var fd = sadfs.open(_, fileOptions, "r");
		var position = sadfs.getPosition(_, fd);
		strictEqual(position, 0, "Init Position: " + position);

		sadfs.seek(_, fd, 0, 8);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 8, "Seek BOF positive: " + position);

		try {
			sadfs.seek(_, fd, 0, -8, false);
		} catch (e) {
			ok(true, "Seek BOF negative failed: " + e.message);
		}

		try {
			sadfs.seek(_, fd, 0, 50);
		} catch (e) {
			ok(true, "Seek BOF too big (STRICT): " + e.message);
		}

		sadfs.seek(_, fd, 1, 8);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 16, "Seek CUR positive: " + position);

		sadfs.seek(_, fd, 1, -8);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 8, "Seek CUR negative: " + position);

		sadfs.seek(_, fd, 1, 50, false);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 58, "Seek CUR positive too big: " + position);
		try {
			sadfs.seek(_, fd, 1, 50);
		} catch (e) {
			ok(true, "Seek CUR positive too big (STRICT): " + e.message);
		}

		try {
			sadfs.seek(_, fd, 1, -50);
		} catch (e) {
			ok(true, "Seek CUR negative too big: " + e.message);
		}

		sadfs.seek(_, fd, 2, -8);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 24, "Seek EOF negative: " + position);

		sadfs.seek(_, fd, 2, 8, false);
		position = sadfs.getPosition(_, fd);
		strictEqual(position, 40, "Seek EOF positive: " + position);
		try {
			sadfs.seek(_, fd, 2, 8);
		} catch (e) {
			ok(true, "Seek EOF positive (STRICT): " + e.message);
		}

		try {
			sadfs.seek(_, fd, 2, -50, false);
		} catch (e) {
			ok(true, "Seek EOF too big failed: " + e.message);
		}

		sadfs.close(_, fd);
		start();
	});

	asyncTest("flush", function(_) {
		var fd = sadfs.open(_, fileOptions, "w");
		sadfs.flush(_, fd);
		ok(true, "Flush ok");

		var size = sadfs.stat(_, fileOptions, ["size"]).size;
		strictEqual(size, 0, "Size after flush: " + size);
		start();
	});

	asyncTest("unlink", function(_) {
		sadfs.unlink(_, fileOptions);
		ok(true, "File removed");
		try {
			sadfs.open(_, fileOptions, "r");
		} catch (e) {
			ok(true, "Check result: " + e.message);
		}
		start();
	});

	asyncTest("client disconnect", function(_) {
		sadfs.disconnect();
		strictEqual(sadfs.stream == null, true, "Stream is closed");
		start();
	});
}

for (var i = 0; i < tests.length; i++) {
	completeTest(tests[i], i);
}
test("kill", function() {
	done = true;
	start();
});