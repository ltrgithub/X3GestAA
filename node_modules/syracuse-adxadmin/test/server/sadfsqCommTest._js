"use strict";
/* jshint -W079 */
/* jshint unused: false */
/* global QUnit: false, asyncTest: false, test: false, strictEqual: false, start: false, stop: false */
var helpers = require('syracuse-core/lib/helpers');
var nodeconfig = require('syracuse-main/lib/nodeconfig');
var flows = require('streamline/lib/util/flows');
var SadFsqFile = require('syracuse-adxadmin/lib/sadfsq/sadfsqFile').SadFsqFile;
var fs = require('fs');

var SadFsqComm = require('syracuse-adxadmin/lib/sadfsq/sadfsqComm').SadFsqComm;
var util = require('util');

var done;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (done) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 500);
		}
	}
});

var comm;
asyncTest("Communicator class instaciation", function(_) {
	comm = new SadFsqComm(_);
	start();
});

//////////////////////////////////////////////////////
test("written buffer T_EFF : delete file with canonical name", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV./toto$txt"
	});
	var buff = comm._writeBufTEFF(sadFsqFile);
	var bytes = new Buffer([0x00, 0x00, 0x16, 0x0A, 0x00, 0x13, 0x00, 0x11, 0x40, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2E, 0x2F, 0x74, 0x6F, 0x74, 0x6F, 0x24, 0x74, 0x78, 0x74]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " T_EFF");

	start();
});

test("written buffer T_PAT : get remote file path", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV./toto$txt"
	});
	var buff = comm._writeBufTPAT(sadFsqFile);
	var bytes = new Buffer([0x00, 0x00, 0x16, 0x08, 0x00, 0x13, 0x00, 0x11, 0x40, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2E, 0x2F, 0x74, 0x6F, 0x74, 0x6F, 0x24, 0x74, 0x78, 0x74]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " T_PAT");

	start();
});

test("written buffer TERR : get a error", function(_) {
	var buff = comm._writeBufTERR();
	var bytes = new Buffer([0x00, 0x00, 0x01, 0x06]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), " TERR");
	start();
});

test("written buffer TOUP : open a remote process", function(_) {

	var sadFsqFile = new SadFsqFile({
		canonical: "ls "
	});
	var buff = comm._writeBufTOUP(sadFsqFile, "r");
	var bytes = new Buffer([0x00, 0x00, 0x0D, 0x04, 0x00, 0x05, 0x00, 0x03, 0x6C, 0x73, 0x20, 0x00, 0x03, 0x00, 0x01, 0x72]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " TOUF Buffer");

});

test("written buffer TOUF : open a remote file", function(_) {

	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra"
	});
	var buff = comm._writeBufTOUF(sadFsqFile, "r");
	var bytes = new Buffer([0x00, 0x00, 0x2B, 0x02, 0x00, 0x23, 0x00, 0x21, 0x40, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2E, 0x74, 0x6D, 0x70, 0x2F, 0x7A, 0x7A, 0x76, 0x70, 0x6F, 0x73, 0x79, 0x73, 0x5F, 0x33, 0x37, 0x32, 0x39, 0x38, 0x32, 0x30, 0x33, 0x24, 0x74, 0x72, 0x61, 0x00, 0x03, 0x00, 0x01, 0x72]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " TOUF Buffer");

});


test("written buffer SLBF : read a remote file", function(_) {

	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra",
		fd: 2,
	});
	var buff = comm._writeBufSLBF(sadFsqFile, 32768);
	var bytes = new Buffer([0x02, 0x00, 0x05, 0x05, 0x00, 0x00, 0x80, 0x00]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " TSLBF Buffer");

});

test("written buffer T_KUS : kill a remote process", function(_) {

	var sadFsqFile = new SadFsqFile({
		pid: 1223456,
	});
	var buff = comm._writeBufTKUS(sadFsqFile, 9);
	var bytes = new Buffer([0x00, 0x00, 0x06, 0x0F, 0x09, 0x00, 0x12, 0xAB, 0x20]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), " T_KUS Buffer");

});

test("written buffer SEBF : write remote file", function(_) {

	var fileBin = new Buffer([0x6a, 0x61, 0xc3, 0xb9, 0x6d, 0x6b, 0x6c, 0x64, 0x6a, 0x66, 0x6d, 0xc3, 0xb9, 0x61, 0x6b, 0x6c, 0x65, 0x6e, 0x6d, 0x6c, 0x61, 0x6b, 0x64, 0x6e, 0x6d, 0x63, 0x61, 0x6b, 0x64, 0x6e, 0x6d, 0xc3, 0xb9, 0x61, 0x6c, 0x6b, 0x64, 0x76, 0x61, 0x0a, 0x64, 0x61, 0x6b, 0x6e, 0x2c, 0x76, 0x61, 0x64, 0x70, 0x76, 0x61, 0x2a, 0x64, 0x6c, 0x76, 0x0a, 0x61, 0x70, 0x64, 0x6c, 0x2c, 0x76, 0x0a, 0x61, 0x6c, 0x61, 0x6d, 0x64, 0x3b, 0x3a, 0x76, 0x0a, 0x41, 0x64, 0x78, 0x6d, 0x3b, 0x76, 0x61, 0x0a, 0x64, 0x6d, 0x3b, 0x76, 0x61, 0x0a, 0x64, 0x6d, 0x3b, 0x76, 0x61, 0x64, 0x76, 0x2c, 0x61, 0x71, 0xc3, 0xb9, 0x64, 0x6b, 0x76, 0x61, 0xc3, 0xb9, 0x21, 0x64, 0x6b, 0x2c, 0x76, 0x61, 0x64, 0x76, 0x61, 0x64, 0x6c, 0x76, 0x61, 0x0a, 0x64, 0x76, 0x3b, 0x61, 0x2a, 0x6d, 0x64, 0x2c, 0x76, 0x61, 0x64, 0x2c, 0x76, 0x61, 0x0a, 0x64, 0x76, 0x61, 0x64, 0x6c, 0x76, 0x61, 0x2a, 0x64, 0x76, 0x2c, 0x61, 0x0a, 0x64, 0x2c, 0x76, 0x61, 0x2a, 0x64, 0x2c, 0x61, 0x0a, 0x64, 0x61, 0x0a, 0x3b, 0x0a]);
	var sadFsqFile = new SadFsqFile({
		fd: 2,
		binary: fileBin
	});
	var buff = comm._writeBufSEBF(sadFsqFile, 150);
	var bytes = Buffer.concat([new Buffer([0x02, 0x00, 0x05, 0x08, 0x00, 0x00, 0x00, 0x96]), fileBin.slice(0, 150)]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), " SEBF Buffer write 150 bytes");
	var buff = comm._writeBufSEBF(sadFsqFile, 23);
	var bytes = Buffer.concat([new Buffer([0x02, 0x00, 0x05, 0x08, 0x00, 0x00, 0x00, 0x09]), fileBin.slice(151)]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), " SEBF Buffer write 23 bytes");

});


test("written buffer TPRM : get info of a remote file", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV./toto$txt"
	});
	var buff = comm._writeBufTPRM(sadFsqFile, "size");
	var bytes = new Buffer([0x00, 0x00, 0x17, 0x07, 0x08, 0x00, 0x13, 0x00, 0x11, 0x40, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2e, 0x2f, 0x74, 0x6f, 0x74, 0x6f, 0x24, 0x74, 0x78, 0x74]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "file " + sadFsqFile.canonical + " TPRM");

	start();
});

test("written buffer Connect : connect sadfsq client", function() {
	var buff = comm._writeBufConnect({
		user: "apisu",
		pass: "CRYPT:xkvvaTccvr",
		secure: true,
	});
	var bytes = new Buffer([0x6A, 0x1D, 0x05, 0x61, 0x70, 0x69, 0x73, 0x75, 0x05, 0x61, 0x70, 0x69, 0x73, 0x75, 0x10, 0x43, 0x52, 0x59, 0x50, 0x54, 0x3A, 0x78, 0x6B, 0x76, 0x76, 0x61, 0x54, 0x63, 0x63, 0x76, 0x72]);
	strictEqual(buff.toString('hex'), bytes.toString('hex'), "Connect");

	start();
});

///////////////// test read 
test("read buffer TOUF : open a remote file", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra"
	});
	var buf = new Buffer([0x02]);
	var buff = comm._readBufTOUF(buf, sadFsqFile);
	strictEqual(sadFsqFile.fd, 2, " open File ");

	start();
});

test("read buffer TOUP : open a remote file", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "ls "
	});
	var buf = new Buffer([0x02]);
	var buff = comm._readBufTOUP(buf, sadFsqFile);
	strictEqual(sadFsqFile.pid, 2, " launch process");

	start();
});
test("read buffer SLBF : read a remote file", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra",
		size: 1418
	});
	// get result buffer
	var buf = Buffer.concat([new Buffer([0x00, 0x00, 0x00, 0x05, 0x8a]), fs.readFileSync(__dirname + "/data/SLBF_read.json")]); // file that contains binary to check 
	strictEqual(comm._hasError(buf.slice(0, 1)), false, "error missing ok"); // del byte that define if it's an error // not validate here 
	var len = comm._readBufSLBF(buf.slice(1, 5), 0, sadFsqFile);
	strictEqual(len, 1418, " get length to read ok");
	var buff = comm._readBufSLBF(buf.slice(6), 1, sadFsqFile);
	strictEqual(sadFsqFile.binary.toString('hex'), buf.slice(6).toString('hex'), " set buffer to sadFile");

	start();
});

test("read buffer TPAT : get path of a remote file", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra",
	});
	var buf = new Buffer([0x01, 0x41, 0x2F, 0x70, 0x72, 0x6F, 0x64, 0x75, 0x69, 0x74, 0x73, 0x2F, 0x76, 0x31, 0x36, 0x30, 0x2F, 0x53, 0x4F, 0x4C, 0x53, 0x55, 0x50, 0x56, 0x36, 0x2F, 0x64, 0x6F, 0x73, 0x73, 0x69, 0x65, 0x72, 0x73, 0x2F, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2F, 0x74, 0x6D, 0x70, 0x2F, 0x7A, 0x7A, 0x76, 0x70, 0x6F, 0x73, 0x79, 0x73, 0x5F, 0x33, 0x37, 0x32, 0x39, 0x38, 0x32, 0x30, 0x33, 0x2E, 0x74, 0x72, 0x61]);
	strictEqual(comm._hasError(buf.slice(0, 1)), false, "error missing ok"); // del byte that define if it's an error // not validate here 
	var len = comm._readBufTPAT(buf.slice(1, 2), 0, sadFsqFile); // size of buffer to read
	strictEqual(len, 65, "buffer size to read ok");

	var buff = comm._readBufTPAT(buf.slice(2), 1, sadFsqFile);
	strictEqual(sadFsqFile.path, "/produits/v160/SOLSUPV6/dossiers/SUPERV/tmp/zzvposys_37298203.tra", "file path ok");

	start();
});
test("read buffer TPRM : read file info", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra",
	});
	var buf = new Buffer([0x00, 0x00, 0x00, 0x05, 0x8A]);
	strictEqual(comm._hasError(buf.slice(0, 1)), false, "error missing ok"); // del byte that define if it's an error // not validate here 
	comm._readBufTPRM(buf.slice(1, 5), sadFsqFile, "size"); // size of buffer to read
	strictEqual(sadFsqFile.fileInfo.size && sadFsqFile.fileInfo.size, 1418, "info id [size] ok ");

	start();
});


test("read buffer TERR : read error", function() {
	var sadFsqFile = new SadFsqFile({
		canonical: "@SUPERV.tmp/zzvposys_37298203$tra",
	});
	var buf = new Buffer([0x00, 0x35, 0x2F, 0x70, 0x72, 0x6F, 0x64, 0x75, 0x69, 0x74, 0x73, 0x2F, 0x76, 0x31, 0x36, 0x30, 0x2F, 0x53, 0x4F, 0x4C, 0x53, 0x55, 0x50, 0x56, 0x36, 0x2F, 0x64, 0x6F, 0x73, 0x73, 0x69, 0x65, 0x72, 0x73, 0x2F, 0x53, 0x55, 0x50, 0x45, 0x52, 0x56, 0x2F, 0x74, 0x6D, 0x70, 0x2F, 0x74, 0x65, 0x73, 0x74, 0x2E, 0x74, 0x65, 0x73, 0x74]);
	strictEqual(comm._hasError(buf.slice(0, 1), true), true, "error present ok"); // del byte that define if it's an error // not validate here 
	var len = comm._readBufTERR(buf.slice(1, 2), 0, sadFsqFile); // size of buffer to read
	strictEqual(len, 53, "buffer size to read ok");

	var buff = comm._readBufTERR(buf.slice(2), 1, sadFsqFile);
	strictEqual(sadFsqFile.err && sadFsqFile.err.length === 1 && sadFsqFile.err[0], "/produits/v160/SOLSUPV6/dossiers/SUPERV/tmp/test.test", "file path ok");

	start();
});







//////////////// test process

test("kill", function() {
	done = true;
	start();
});