"use strict";

var helpers = require("syracuse-core/lib/helpers");
var httpHelper = require('syracuse-sdata/lib/httpHelper');

var _dispatchMap = {
	"xlsx": function(_, context) {
		var headers = {};
		headers["content-type"] = httpHelper.mediaTypes.xlsx;
		headers["cache-control"] = "no-cache,must-revalidate";
		context.response.writeHead(200, headers);
		//var xlsxUrl = context.url + "?representation=" + context.parameters.representation;
		var xlsxUrl = context.url + "?" + context.request.url.split("?")[1];
		require('msoffice/lib/excel/xlsx').render(_, context.response, {
			"url": xlsxUrl
		});
		context.response.end();
	},
	"docx": function(_, context) {
		// TODO: get the prototype and result, or properly provide a title and description
		//var proto = self.getPrototypeResource(_, self.parameters.representation, true);
		var label = context.parameters.representation ? context.parameters.representation.split(".")[0] : "unknown";
		var proto = {
			$title: label,
			$description: label
		};
		var result = {
			$url: context.request.url
		};
		require('msoffice/lib/word/docx').render(_, context, result, proto, {}, 200);
		context.response.end();
		return;
	},
	"pptx": function(_, context) {
		// TODO: get the prototype and result, or properly provide a title and description
		//var proto = self.getPrototypeResource(_, self.parameters.representation, true);
		var label = context.parameters.representation.split(".")[0];
		var proto = {
			$title: label,
			$description: label
		};
		var result = {
			$url: context.request.url
		};
		require('msoffice/lib/ppt/pptx').render(_, context, result, proto, {}, 200);
		context.response.end();
		return;
	}
};

exports.dispatch = function(_, context) {
	_dispatchMap[context.accept[0].type] && _dispatchMap[context.accept[0].type](_, context);
};