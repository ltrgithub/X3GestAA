"use strict";
var Site = require('syracuse-ui/lib/site/site').Site;
var _siteLoader = require('msoffice/lib/siteLoader');
var ExcelReportPage = require("msoffice/lib/excel/html/excelReportPage").ExcelReportPage;
var ExcelPage = require("msoffice/lib/excel/html/excelPage").ExcelPage;
var ExcelDocument = require('msoffice/lib/excel/html/excelDocument').ExcelDocument;
var ExcelDatasourcePage = require("msoffice/lib/excel/html/excelDataSourcePage").ExcelDatasourcePage;
var ExcelInterface = require('msoffice/lib/excel/html/excelInterface').ExcelInterface;

exports.main = function(){
    var site = new Site();
    _siteLoader.initialize(site);
    
    site.isExcelLoaded = !!(external && external.Application);
    site.isOfficeSite = true;
    
    site.isExcelOfficeConfig = document.location.href.indexOf("excelconfig") >= 0;
    
    if (site.isExcelOfficeConfig) {
        /*site.agents = {
         excelDatasources: {
         saveDatasource: function(article, menu, record){
         site.excelDocument.addDatasource(record);
         }
         }
         };*/
        site.excelDocument = new ExcelDocument();
        site.controller_onChangeMainPage = function(openerUrlSegments){
            if (openerUrlSegments.representationRoot == "excelconfig") {
                syra_site.onMainPageChange({
                    $category: "excelDatasource",
                    openerUrlSegments: openerUrlSegments,
                    $representation: {
                        $prototype: {}
                    }
                });
                return false;
            }
            return true;
        };
        site.drawBox = function(){
            var self = this;
            self.widgetsLibrary.pageCategories.excelDatasource = ExcelDatasourcePage;
            self.widgetsLibrary.pageCategories.worksheet = ExcelPage;
            self.widgetsLibrary.pageCategories.excelreport = ExcelReportPage;
            /* if (!site.isExcelOfficeConfig) {
             self.siteFunctions.addDragDropManager();
             self._renderHeader();
             
             self.body = document.createElement("div");
             self.body.id = "s-site-body";
             self.layoutSlot.appendChild(self.body);
             self.logon(function(){
             self._onAfterLogon();
             });
             }
             else {*/
            Site.prototype.drawBox.apply(this);
            //}
        };
        site.onMainPageChange = function($itemPage){
            this.newAddinLink = null;
            Site.prototype.onMainPageChange.apply(this, arguments);
            this._addNewAddinLink();
            //if (this.isExcelOfficeConfig) {
            this.mainPage.onSelectRecord = function(result){
                if (Object.keys(result).length) {
                    var first = result[Object.keys(result)[0]];
                    external.onSelectRecord(JSON.stringify(first.$prototype), JSON.stringify(first.dataset));
                }
            };
            if (this.$facet != "$query") {
                this.excelDocument.autoLoad();
            }
            /*}
             else {
             this.excelDocument.autoLoad();
             }*/
            return this.mainPage;
        };
        site._onAfterLogon = function(){
            var self = this;
            self.history.start();
            self.layoutSlot.style.display = "";
            self.resize();
            site.isExcelLoaded && external.onLogon();
            syra_controller.callServer(null, {
                $location: {
                    $url: "/sdata/syracuse/collaboration/syracuse/moduleVersions('officeAddin')?representation=moduleVersion.$details"
                }
            }, function(data, response){
                if (data && data.version) {
                    if (!self.isExcelOfficeConfig) {
                        external.expectedVersion && external.expectedVersion(data.version);
                    }
                    self._hasNewAddin = (self.isExcelLoaded && (external.GetAddinVersion() < data.version)) || !self.isExcelLoaded;
                    self._addNewAddinLink();
                }
            });
        };
    }
    else {
        site.excelInterface = new ExcelInterface();
        site.drawBox = function(){
            var self = this;
            self.widgetsLibrary.pageCategories.excelreport = ExcelReportPage;
            self.body = document.createElement("div");
            self.body.id = "s-site-body";
            var title = document.createElement("div");
            title.className = "s-page-title";
            title.textContent = "Please wait while connecting";
            self.body.appendChild(title);
            self.layoutSlot.appendChild(self.body);
            self.siteFunctions.addDragDropManager();
            self.logon(function(){
                self._onAfterLogon();
            });
        };
        site._onAfterLogon = function(){
            //syra_site.history.start();
            this.excelInterface.onLogin();
            this.layoutSlot.style.display = "";
            this.resize();
        }
    }
    
    site._addNewAddinLink = function(){
        if (this._hasNewAddin && !this.newAddinLink) {
            this.newAddinLink = syra_menus.addTextButton("A newer version of the addin is available. Click here to download it", "s-office-new-addin-link", null, null, "diagnose");
            this.newAddinLink.href = "/msoffice/lib/general/addIn/SyracuseOfficeAddinsSetup.EXE";
            if (this.header) {
                this.header.appendChild(this.newAddinLink);
            }
            else {
                this.body.insertBefore(this.newAddinLink, this.body.firstChild);
            }
            this.resize();
        }
    }
    
    site._renderHeader = function(){
        this.header = document.createElement("header");
        this.header.setAttribute("id", "s-site-header");
        this.dom.setZIndex(this.header);
        
        this.headerTop = document.createElement("div");
        this.headerTop.id = "s-site-header-top";
        
        this.addLogo(this.headerTop);
        
        var middleCell = document.createElement("div");
        middleCell.id = "s-site-header-middle-cell";
        this.headerTop.appendChild(middleCell);
        
        this.setArticleId(this.layoutSlot);
        this.topPanel.addOpener(middleCell);
        
        this.header.appendChild(this.headerTop);
        this.layoutSlot.insertBefore(this.header, this.layoutSlot.firstChild);
    };
    
    site.loadBox();
};

if (require.main == module) 
    exports.main();
