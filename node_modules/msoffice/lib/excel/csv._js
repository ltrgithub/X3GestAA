"use strict";

var ez = require('ez-streams');
var csvHelper = require('./csvHelper');

var tracer; // = console.log;

exports.render = function(_, ctx, result, prototype, headers, statusCode) {
	_csvSetHeaders(_, ctx, result, prototype, headers, statusCode);

	var options = {
		"url": ctx.url + "?" + ctx.request.url.split("?")[1]
	};

	var data = csvHelper.generateCsv(_, ctx, options);

	return _csvDirectExport(_, data, ctx.response);
};

exports.csvDirectExport = function(_, data, stream) {
	_csvDirectExport(_, data, stream);
};

function _csvDirectExport(_, data, stream) {
	var os = (stream.pre || stream.emitter) ? stream : ez.devices.node.writer(stream);

	os.write(_, new Buffer([0xEF, 0xBB, 0xBF]));

	ez.devices.array.reader(data, {
		sync: true
	}).transform(ez.transforms.csv.formatter({
		sep: "," // TODO: setup lists separator into regional settings
	})).skip(1).pipe(_, os);

	os !== stream && os.close && os.close(_);
}

function _csvSetHeaders(_, ctx, result, proto, headers, statusCode) {
	var filename;

	function format(expression, proto, res) {
		res = res || {};
		var value = expression && expression.replace(/\{(.*?)\}/g, function(match, p1) {
			return res[p1] || proto[p1] || p1;
		});
		return value;
	}

	filename = format(proto.$title + (proto.$description ? (" - " + proto.$description) : ""), proto, result);

	headers["content-disposition"] = "attachment; filename=\"" + filename + ".csv\"";
	headers["content-type"] = "Content-type: text/csv";
	headers["cache-control"] = "no-cache,must-revalidate";
	headers["Accept-Charset"] = "utf-8";

	ctx.response.writeHead(statusCode, headers);
}