"use strict";

var ez = require('ez-streams');

exports.csv_direct_export = function(_, $data, stream) {
	var os = (stream.pre || stream.emitter) ? stream : ez.devices.node.writer(stream);

	var streamOptions = {
		sync: true
	};
	var reader = ez.devices.array.reader($data, streamOptions);
	var fileBuffer = null;
	var bufferLength = 0;
	reader.transform(ez.transforms.csv.formatter()).forEach(_, function(_, line, index) {
		if (index > 0) {
			bufferLength += line.length;
			if (fileBuffer) {
				fileBuffer = Buffer.concat([fileBuffer, Buffer.from(line)], bufferLength);
			} else {
				fileBuffer = Buffer.from(line);
			}
		}
	});

	os.write(_, fileBuffer);

	if (os !== stream && os.close) os.close(_);
};