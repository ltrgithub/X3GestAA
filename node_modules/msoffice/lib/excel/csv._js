"use strict";

var ez = require('ez-streams');
var url = require('url');
var adminHelper = require("@sage/syracuse-lib/src/collaboration/helpers").AdminHelper;

var tracer = console.log;

exports.csv_direct_export = function(_, $data, stream) {
	let os = (stream.pre || stream.emitter) ? stream : ez.devices.node.writer(stream);

	let streamOptions = {
		sync: true
	};
	let reader = ez.devices.array.reader($data, streamOptions);
	let fileBuffer = null;
	let bufferLength = 0;
	reader.transform(ez.transforms.csv.formatter()).forEach(_, function(_, line, index) {
		if (index > 0) {
			bufferLength += line.length;
			if (fileBuffer) {
				fileBuffer = Buffer.concat([fileBuffer, Buffer.from(line)], bufferLength);
			} else {
				fileBuffer = Buffer.from(line);
			}
		}
	});

	os.write(_, fileBuffer);

	if (os !== stream && os.close) os.close(_);
};

exports.generate_csv = function(_, ctx, options) {
	return _generate_csv(_, ctx, options);
};

function _generate_csv(_, ctx, options) {
	let parsedUrl = _parseRequestUrl(_, options.url);
	if (parsedUrl.errMsg) {
		tracer && tracer(parsedUrl.errMsg);
		return;
	}

	var $prototype = _getPrototype(_, parsedUrl);
	//tracer && tracer("prototype: " + JSON.stringify(prototype, null, 2));

	var $article = {
		$category: "worksheet",
		$layout: {}
	};

	_buildQueryArticle($article, $prototype);

	var items = _makeExcelTablePrototype(_, $prototype.$properties, $article);

	var $resources = _fetchResource(_, parsedUrl);
	var newData = {
		$resources: $resources
	};

	var data = _makeExcelTableData(newData, $prototype.$properties, items);

	tracer && tracer("data: " + JSON.stringify(data, null, 2));

	return data;
}

function _getPrototype(_, parsedUrl) {
	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.getEntity(_, parsedUrl.dataset);
	//var facet = parsedUrl.representation.substr(parsedUrl.representation.lastIndexOf(".") + 1);

	// tracer && tracer(parsedUrl.representation);
	// tracer && tracer(facet);

	return entity && entity.getPrototype(_, parsedUrl.representation); //, facet);
}

function _fetchResource(_, parsedUrl) {
	var resources = [];
	var db = adminHelper.getCollaborationOrm(_);
	var entity = db.getEntity(_, parsedUrl.dataset, "$bulk");
	var cursor = db.createCursor(_, entity);
	var data;
	while (data = cursor.next(_)) {
		resources.push(data.serializeInstance(_));
	}

	//tracer && tracer("_fetchResource: " + JSON.stringify(resources, null, 2));

	return resources;
}

function _parseRequestUrl(_, requestUrl) {
	var parsed = url.parse(requestUrl, true);
	var segs = parsed.pathname.split('/');
	var result = {};

	if (segs.length < 6) {
		result.errMsg = "url incomplete";
		return result;
	}

	result.application = segs[3];
	result.contract = segs[4];
	result.dataset = segs[5];
	result.syraClass = segs[6];
	result.representation = parsed.query.representation;

	return result;
}

function _makeExcelTablePrototype(_, $prototype, $item) {
	// var self = this;
	var proto = $prototype;
	var _item = $item;
	var items;

	while (_item && _item.$layout && (_item.$bind !== "$resources"))
		_item = _item.$layout.$items && _item.$layout.$items[0];
	if (!_item)
		return;

	items = (_item.$layout && _item.$layout.$items) || _item.$items ||
		Object.keys(proto).filter(function(prop) {
			return proto[prop].$isHidden !== true;
		}).map(function(prop) {
			return {
				$bind: prop
			};
		});


	return items.map(function(item) {
		var protoItem = proto[item.$bind];

		var sp = {
			_name: item.$bind.replace("$", "_"),
			_orgName: item.$bind,
			_title: protoItem.$title,
			_isExcluded: protoItem.$isExcluded
		};

		if (protoItem.$type == "application/x-reference" && protoItem.$item) {
			//_initializeReferenceField(item, protoItem.$item);
			sp._type = protoItem.$type;
			sp._scale = (protoItem.$scale !== undefined) ? protoItem.$scale : null;

			if (protoItem.$item.$key !== "{$uuid}" && item.$reference && item.$reference.$value) {
				sp._bind = item.$reference.$value.$prop;
			}
		} else
		if (protoItem.$type == "application/x-quantity" && protoItem.$value) {
			var valueProp = protoItem.$value;
			sp._type = valueProp.$type;
			sp._scale = (valueProp.$scale !== undefined) ? valueProp.$scale : null;
		} else {
			sp._type = protoItem.$type;
			sp._scale = (protoItem.$scale !== undefined) ? protoItem.$scale : null;
		}
		return sp;
	}).filter(function(simpleProto) {
		return !simpleProto._isExcluded;
	});
}

function _makeExcelTableData(data, $prototype, $excelTablePrototype) {
	var proto = $prototype;
	var items = $excelTablePrototype;

	return data.$resources.map(function(res) {
		return items.map(function(item) {
			var prop = res[item._orgName];
			var propProto = proto[item._orgName];
			var result = "";
			var record = res;

			if (res.$properties && res.$properties[item._orgName] && res.$properties[item._orgName].$isHidden) {
				return result;
			}

			// manage limited set of types
			switch (item._type) {
				case "application/x-string":
				case "application/x-integer":
				case "application/x-decimal":
				case "application/x-datetime":
				case "application/x-date":
				case "application/x-time":
				case "application/x-boolean":
					result = prop;
					break;
				case "application/x-choice":
					var ref = propProto.$value || propProto.$key;
					if (ref && ref.$enum) {
						for (var ii = 0, jj = ref.$enum.length; ii < jj; ii++) {
							if (ref.$enum[ii] && ref.$enum[ii].$value !== undefined && ref.$enum[ii].$value === prop) {
								//result = syra_expression.parse(self, ref.$enum[ii].$title);
								result = ref.$enum[ii].$title;
								break;
							}
						}
					} else {
						result = prop;
					}
					break;
				case "application/x-reference":
					result = "";
					// record = prop;
					// propProto = propProto.$item || {};
					// var valueTemplate = item._bind || propProto.$value || propProto.$key;
					// result = (record && valueTemplate && (syra_expression.parse(self.$grid.$record, valueTemplate, record) || syra_expression.parse(self.$grid.$record, valueTemplate, res))) || "";
					break;
				default:
					result = "";
			}
			if (record && propProto.$links && propProto.$links.$details)
				return result;
			// return [result, document.location.protocol + "//" + document.location.host + syra_site.$syracuseMainPageUrl +
			// "?url=" +
			// encodeURIComponent(syra_expression.parse(self.$grid.$record, propProto.$links.$details.$url, res, undefined, item._orgName))];
			else
				return result;
		});
	});
}

// function _initializeReferenceField(item, protoItem){
//     item.$reference = {};
//     _parseSettings(item, protoItem, "$title");
//     _parseSettings(item, protoItem, "$value");
// }

// function _parseSettings(item, protoItem, $property){
//     var setting = item.$reference[$property] = {
//         $itemProp: protoItem[$property] ? syra_expression.extractCode(protoItem[$property]) : $property
//     };
//     setting.$prop = protoItem[setting.$itemProp];
// }

function _buildQueryArticle($article, $prototype) {
	//var $items = [];
	var $defined = {};

	var $binds = Object.keys($prototype.$properties);
	var $array = [];
	var $more = [];

	for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
		var $bind = $binds[ii];
		var $field = $prototype.$properties[$bind];
		if ($field && !$field.$isExcluded) {
			var $item = $defined[$bind] ? syra_site.clone($defined[$bind]) : {
				$bind: $bind
			};
			if ($field.$type == "application/x-array") {
				$array.push($item);
			} else {
				$more.push($item);
			}
		}
	}
	if ($more.length) {
		$article.$layout = {
			$items: $more.concat($array)
		};
	} else {
		$article.$layout.$items = $array;
	}
}