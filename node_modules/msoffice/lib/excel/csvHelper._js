"use strict";

var url = require('url');
var adminHelper = require("@sage/syracuse-lib/src/collaboration/helpers").AdminHelper;

var tracer; // = console.log;

exports.generateCsv = function(_, ctx, options) {
	return _generateCsv(_, ctx, options);
};

function _generateCsv(_, ctx, options) {
	let parsedUrl = _parseRequestUrl(_, options.url);
	if (parsedUrl.errMsg) {
		tracer && tracer(parsedUrl.errMsg);
		return;
	}

	var $prototype = _getPrototype(_, parsedUrl);
	//var $properties = $prototype.$properties.$resources.$item || $prototype;

	var $article = {
		$category: "worksheet",
		$layout: {}
	};
	_buildQueryArticle($article, $prototype);

	var items = _makeTablePrototype(_, $prototype.$properties, $article);

	var $resources = _fetchResource(_, parsedUrl);
	var newData = {
		$resources: $resources
	};

	var header = _makeTableHeader(items);
	var data = _makeTableData(newData, $prototype.$properties, items);
	data.splice(0, 0, header);

	tracer && tracer("tableData: " + JSON.stringify(data, null, 2));

	return data;
}

function _getPrototype(_, parsedUrl) {
	var db, entity, data;
	if (parsedUrl.contract === "collaboration") {
		db = adminHelper.getCollaborationOrm(_);
		entity = db.getEntity(_, parsedUrl.syraClass);
		data = entity && entity.getPrototype(_, parsedUrl.representation);
	} else {
		let endpoint = adminHelper.getEndpoint(_, {
			application: parsedUrl.application,
			contract: parsedUrl.contract,
			dataset: parsedUrl.dataset
		});

		db = endpoint.getModel(_);
		entity = db.getEntity(_, parsedUrl.syraClass);
		data = entity && entity.getPrototype(_, parsedUrl.representation, "$bulk");
		//data = data.$properties.$resources.$item || data;
	}
	return data || {};
}

function _fetchResource(_, parsedUrl) {
	var db, entity, resources;
	if (parsedUrl.contract === "collaboration") {
		resources = _fetchCollaborationResource(_, parsedUrl);
	} else {
		let endpoint = adminHelper.getEndpoint(_, {
			application: parsedUrl.application,
			contract: parsedUrl.contract,
			dataset: parsedUrl.dataset
		});

		db = endpoint.getOrm(_);
		var model = endpoint.getModel(_);
		entity = model.getEntity(_, parsedUrl.syraClass);

		resources = [];
		var cursor = db.createCursor(_, entity);
		var data;
		while (data = cursor.next(_)) {
			resources.push(data.serializeInstance(_));
		}
	}
	return resources;
}

function _fetchCollaborationResource(_, parsedUrl) {
	var resources = [];

	let db = adminHelper.getCollaborationOrm(_);
	let entity = db.getEntity(_, parsedUrl.syraClass, "$bulk");
	let cursor = db.createCursor(_, entity);

	var data;
	while (data = cursor.next(_)) {
		resources.push(data.serializeInstance(_));
	}

	return resources;
}

function _parseRequestUrl(_, requestUrl) {
	var parsed = url.parse(requestUrl, true);
	var segs = parsed.pathname.split('/');
	var result = {};

	if (segs.length < 6) {
		result.errMsg = "url incomplete";
		return result;
	}

	result.application = segs[2];
	result.contract = segs[3];
	result.dataset = segs[4];
	result.syraClass = segs[5];
	result.representation = parsed.query.representation;

	return result;
}

function _makeTablePrototype(_, $prototype, $item) {
	var proto = $prototype;
	var _item = $item;
	var items;

	while (_item && _item.$layout && (_item.$bind !== "$resources"))
		_item = _item.$layout.$items && _item.$layout.$items[0];
	if (!_item)
		return;

	items = (_item.$layout && _item.$layout.$items) || _item.$items ||
		Object.keys(proto).filter(function(prop) {
			return proto[prop].$isHidden !== true;
		}).map(function(prop) {
			return {
				$bind: prop
			};
		});

	return items.map(function(item) {
		var protoItem = proto[item.$bind];

		var sp = {
			_name: item.$bind.replace("$", "_"),
			_orgName: item.$bind,
			_title: protoItem.$title,
			_isExcluded: protoItem.$isExcluded
		};

		if (protoItem.$type == "application/x-reference" && protoItem.$item) {
			sp._type = protoItem.$type;
			sp._scale = (protoItem.$scale !== undefined) ? protoItem.$scale : null;

			if (protoItem.$item.$key !== "{$uuid}" && item.$reference && item.$reference.$value) {
				sp._bind = item.$reference.$value.$prop;
			}
		} else
		if (protoItem.$type == "application/x-quantity" && protoItem.$value) {
			var valueProp = protoItem.$value;
			sp._type = valueProp.$type;
			sp._scale = (valueProp.$scale !== undefined) ? valueProp.$scale : null;
		} else {
			sp._type = protoItem.$type;
			sp._scale = (protoItem.$scale !== undefined) ? protoItem.$scale : null;
		}
		return sp;
	}).filter(function(simpleProto) {
		return !simpleProto._isExcluded && simpleProto._type != "image" && simpleProto._type != "application/x-graph" && simpleProto._type != "application/x-array";
	});
}

function _makeTableHeader($tablePrototype) {
	var header = [];
	for (var ii = 0, jj = $tablePrototype.length; ii < jj; ii++) {
		let headerColumn = $tablePrototype[ii];
		headerColumn._title && header.push(headerColumn._title);
	}
	return header;
}

function _makeTableData(data, $prototype, $tablePrototype) {
	var proto = $prototype;
	var items = $tablePrototype;

	return data.$resources.map(function(res) {
		return items.map(function(item) {
			var prop = res[item._orgName];
			var propProto = proto[item._orgName];
			var result = "";
			var record = res;

			if (res.$properties && res.$properties[item._orgName] && res.$properties[item._orgName].$isHidden) {
				return result;
			}

			// manage limited set of types
			switch (item._type) {
				case "application/x-string":
				case "application/x-integer":
				case "application/x-decimal":
				case "application/x-datetime":
				case "application/x-date":
				case "application/x-time":
				case "application/x-boolean":
					result = prop && ('"' + prop + '"'); // escape the output...
					break;
				case "application/x-choice":
					var ref = propProto.$value || propProto.$key;
					if (ref && ref.$enum) {
						for (var ii = 0, jj = ref.$enum.length; ii < jj; ii++) {
							if (ref.$enum[ii] && ref.$enum[ii].$value !== undefined && ref.$enum[ii].$value === prop) {
								result = ref.$enum[ii].$title;
								break;
							}
						}
					} else {
						result = prop;
					}
					break;
				case "application/x-reference":
					record = prop;
					propProto = propProto.$item || {};
					var valueTemplate = item._bind || propProto.$value || propProto.$key;
					if (record && valueTemplate && valueTemplate.startsWith('{')) {
						valueTemplate = valueTemplate.slice(1, -1);
						result = record[valueTemplate] && ('"' + record[valueTemplate] + '"'); // escape the output...
					} else {
						result = "";
					}
					break;
				default:
					result = "";
			}
			if (record && propProto.$links && propProto.$links.$details)
				return result;
			else
				return result;
		});
	});
}

function _buildQueryArticle($article, $prototype) {
	var $defined = {};

	var $binds = Object.keys($prototype.$properties);
	var $array = [];
	var $more = [];

	for (var ii = 0, jj = $binds.length; ii < jj; ii++) {
		var $bind = $binds[ii];
		var $field = $prototype.$properties[$bind];
		if ($field && !$field.$isExcluded) {
			var $item = $defined[$bind] ? syra_site.clone($defined[$bind]) : {
				$bind: $bind
			};
			if ($field.$type == "application/x-array") {
				$array.push($item);
			} else {
				$more.push($item);
			}
		}
	}
	if ($more.length) {
		$article.$layout = {
			$items: $more.concat($array)
		};
	} else {
		$article.$layout.$items = $array;
	}
}