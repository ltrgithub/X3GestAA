"use strict";

var fs = require('fs');
var zip = require('streamline-zip');
var excelDefines = require("../helpers").defines;
var helpers = require("syracuse-core/lib/helpers");

exports.render = function(_, response, url) {
	new zip.Zip(response, {
		filter: function(_, name, entry) {
			return name !== '.svn'; 
		},
		
		transform: function(_, contents, entry) {

			if (entry.name !== 'customXml/item1.xml') return contents;

			var parts = (url.split("?")[0] || "").split("/");
			var repr = url.match(/\?.*representation=(.*)\./);
			var connectUrl = parts.slice(0, 3).join('/');
			var resourceUrl = url.substring(connectUrl.length);

			var customData = JSON.stringify({
				serverUrl: connectUrl,
				resourceUrl: resourceUrl,
				representation: (repr && repr[1]) || "",
				});
			
			var template = contents.toString('utf8');
			var document = template.replace("___SYRACUSE_XML_DATA___", customData);
			return new Buffer(document);					
		}		
	}).add(_, {
		path: __dirname + "/template",
	}).finish(_);
};
