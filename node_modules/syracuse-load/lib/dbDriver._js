"use strict";
var util = require('util');
var mongodb = require('mongodb');

exports.close = function(db) {
	if (db) db.close();
}

exports.open = function(configdata, _) {
	console.log("Open anfang")
	if (!configdata) {
		var config = require(__dirname+ "/../../../nodelocal").config || {};
		configdata = config.collaboration || {};
	}
	console.log("Open 2"+util.format(configdata))
	var db1 = new mongodb.Db(configdata.dataset || "syracuse", new mongodb.Server(configdata.hostname || "localhost", configdata.port || 27017,
			{}), {});	
	console.log("Open 3")
	try {
		console.log("Open 4")
	var db = db1.open(_);
		console.log("open 5")
	} catch (e) {
		console.log("FEHLER "+e)
	} finally {
		console.log("open 6")
	}
	console.log("Open2")
	return db;
}

exports.createCollection = function(db, name, _) {
	return db.createCollection(name, _)
}

exports.find = function(collection, condition, _) {
	return collection.find(condition).toArray(_);
}

exports.count = function(collection, condition, _) {
	console.log("CCOOUUNNTT11111")
	return collection.count(condition, _);
}

exports.insert = function(collection, entry, _) {
	collection.insert(entry, {safe: true}, _);
}

exports.update = function(collection, condition, set, _) {
	collection.update(condition, {$set: set}, {safe: true}, _);
}

exports.remove = function(collection, condition, _) {
	collection.remove(condition, {safe: true}, _);
}

exports.time = function(db, _) {
	if (!db._syracuseFinalCode) {
		db._syracuseFinalCode = new db.bsonLib.Code("Date.now()");
	}
	var t = db.eval(db._syracuseFinalCode, null, {nolock: true}, _);
	return t;
}