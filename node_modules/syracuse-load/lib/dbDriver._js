"use strict";

var mongodb = require('mongodb');

exports.close = function(db) {
	if (db) db.close();
}

exports.open = function(configdata, _) {
	var db = new mongodb.Db(configdata.dataset || "syracuse", new mongodb.Server(configdata.hostname || "localhost", configdata.port || 27017,
			{}), {});	
	var db = db.open(_);
	return db;
}

exports.createCollection = function(db, name, _) {
	return db.createCollection(name, _)
}

exports.find = function(collection, condition, _) {
	return collection.find(condition).toArray(_);
}

exports.insert = function(collection, entry, _) {
	collection.insert(entry, {w:1}, _);
}

exports.update = function(collection, condition, set, _) {
	collection.update(condition, {$set: set}, {w:1}, _);
}

exports.remove = function(collection, condition, _) {
	collection.remove(condition, {w:1}, _);
}

exports.time = function(db, _) {
	if (!db._syracuseFinalCode) {
		db._syracuseFinalCode = new db.bsonLib.Code("Date.now()");
	}
	var t = db.eval(db._syracuseFinalCode, null, {nolock: true}, _);
	return t;
}