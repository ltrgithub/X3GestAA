
# Certificate tools in connection with certificate entity
# for use with load balancer and Syracuse
```javascript
var certTools = require('syracuse-load/lib/certTools')  
```

-------------
## sign function :

``` javascript
var signature = certTools.sign(_, cert, algorithm, data, options);
```

Sign data with private key from the certificate entity

* The `cert` parameter gives the name of the certificate in the certificate entity. When it is `null`,
  the locally installed base certificate key will be taken. For use from the load balancer, also the corresponding object
  can be given there.
* The `algorithm` parameter represents the algorithm to apply, e. g. RSA-SHA1
* The `data` parameter represents data to sign (string or buffer)
* The `options` parameter is optional and an object with keys `data_encoding` (specifies the encoding of the data 
  (binary as a default or utf8) when data is a string), `output_encoding` (represents the encoding wanted for signature),
  `certdir` (alternative certificate directory: for unit tests only)
* An optional `tenantId` which will be used as a prefix for file names
Example: the invocation
  digest(_, 'bla', 'RSA-SHA1', 'a', {input_encoding: 'utf8'})
gives the same result as the standard output of the command
 openssl dgst -sha1 -passin pass:pwd -sign bla.key input.txt
where bla.key is assumed to be the encrypted password file with passphrase 'pwd', which is stored in the instance 'bla' of the certificate entity.
-------------
## verify function :

``` javascript
var verify = certTools.verify(_, cert, algorithm, data, signature, options, tenantId)
```

Verifies data with public certificate from the certificate entity

* The `cert` parameter gives the name of the certificate in the certificate entity. When it is `null`,
  the locally installed base certificate key will be taken. For use from the load balancer, also the corresponding object
  can be given there.
* The `algorithm` parameter represents the algorithm to apply, e. g. RSA-SHA1
* The `data` parameter represents data to verify (string or buffer).
* The `signature` parameter contains the previously generated signature
* The `options` parameter is optional and an object with keys `data_encoding` (specifies the encoding of the data 
  (binary as a default or utf8) when data is a string), `signature_encoding` (represents the encoding used for signature),
  `certdir` (alternative certificate directory: for unit tests only)
* An optional `tenantId` which will be used as a prefix for file names
Result is `true` when the check is successful, `false` otherwise.
-------------
## getPEMCertificate function :

``` javascript
var verify = certTools.getPEMCertificate(_, name, ca, tenantId)
```

Retrieves certificate in PEM format as a string

* The `name` parameter gives the name of the certificate in the certificate entity. When it is `null`,
  the locally installed base certificate key will be taken.
* The optional `ca` parameter tells whether it is the certificate of the caCertificate entity
* An optional `tenantId` which will be used as a prefix for file names
-------------
## createWritableStream function 

``` javascript
var str = instance.httpRequest(_, name, options, cas)
```

Creates an https request with the data from this certificate

* The `name` parameter gives the name of the certificate. 
* The `options` parameter contains the non-SSL parts such as `method`, `url`
* The `cas` parameter must contain the names of the CA certificates associated  
  with the entry of the certificate entity
* An optional `tenantId` which will be used as a prefix for file names

Returns an HttpClientRequest obtained from streamline

-------------
## search and update certificates

``` javascript
var result = certTools.parseRequestCert(_, data, certificates, caCertificates, directory, host);
```

Perform file operations in certificate directory and update entries in local arrays of certificates and CA certificates
* The `data` parameter contains an array of objects which describe what to do (details below)
* The `certificates` parameter contains an array of local certificate data which should also be updated
* The `caCertificates` parameter contains an array of local CA certificate data which should also be updated
* The `directory` parameter contains the directory of the certificates in the file system (subdirectory of `config.collaboration.certdir`). The directory name must end with '/'
* The `host` parameter (optional) contains the object with the data of the host, whose `missingCert` and `missingCA` arrays should be updated. 
  The names of incoming certificates will reduce the entries in the arrays missingCert and missingCA of the `host` parameter
* The `changed` parameter (optional) should point to an object. Its `missing` property will be set to true, when `host.missingCA` or `host.missingCert` 
  has been changed (tell this to other servers!). When a server certificate (or one of its CA certificates) for an active connection has 
  been changed, the `start` property will be set to true, when the certificate data have been empty (so that it is good to try to start the connection again)
  otherwise the `restart` property will be set to true (active connections have been changed, therefore restart the server).

Structure of objects within `data` parameter:
name: logical name of certificate (as in Certificate/CaCertificate entity, obligatory) 
ca: when true, then it is CA authority certificate
del: when true, delete the named entry
get: when true, ask for these data
cert: certificate in PEM format (string)
key: key in PEM format (string)
pass: passphrase for key (string)
keyTest: when true, test whether private key is available (it may have been deleted locally)
cas: when set, this is an array with the names of CA certificates which should be tested
When 'del'  attribute is not set, and 'cert' or 'key' is set, update the data. Otherwise ask for the data. Available data of 
responses will be put into the reponse array which is the result of the function
Responses array will get an additional attribute 'changes' when host data have changed
-------------
## convert entries of `missingCA` and `missingCert` into input for `parseRequestCert`

``` javascript
certTools.pushMissing(host, data)
```

Parameter `host` take attributes `missingCA` and `missingCert` from this
Parameter `data` push resulting data to this array (which should be input for `parseRequestCert` 
-------------
## recursively tests whether arguments are equal. Empty array and empty object do not count as different

``` javascript
certTools.deepEqual(obj1, obj2)
```

The parameters are arbitrary objects. 
