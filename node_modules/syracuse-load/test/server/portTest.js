"use strict";
var balancer = require('syracuse-load/lib/balancer')
var util = require('util')

var qmodule = QUnit.module;

qmodule('balancer');

test('Balancer', 4, function() {
	var host1 = { hostname: "a", started: true, active: true, children: 2, ready: 1};
	var host2 = { hostname: "b", started: true, active: true, children: 3, ready: 1};
	var res = balancer.balance({ "a:N0": 1, "a:N1": 2}, [host1])
	strictEqual(JSON.stringify(res), JSON.stringify([host1,"N0"]), "balance 1 port N0")
	var res = balancer.balance({ "a:N0": 2, "a:N1": 2}, [host1])
	strictEqual(JSON.stringify(res), JSON.stringify([host1,"N0"]), "balance 1 port N0")
	var res = balancer.balance({ "a:N1": 2, "a:N0": 3}, [host1])
	strictEqual(JSON.stringify(res), JSON.stringify([host1,"N1"]), "balance 1 port N1")
	var res = balancer.balance({ "a:N1": 1, "a:N0": 2, "b:N0": 1}, [host1, host2])
	strictEqual(JSON.stringify(res), JSON.stringify([host2,"N1"]), "balance 2 port N1")
	
})

test('Host update', 13, function() {
	var hosts = [ { hostname: "A1", started: false}, { hostname: "A2", started: true}]
	var oldHosts = [ { hostname: "A1", started: true}, { hostname: "A2", started: false}]
	var res = balancer._updateHosts(oldHosts, hosts, "A1");
	strictEqual(res[0].hostname, "A1", "local host name")
	strictEqual(res[0].started, true, "local host started")
	strictEqual(res[1].hostname, "A2", "other host name")
	strictEqual(res[1].started, false, "other host started")
	strictEqual(res.length, 2, "number of hosts")

	var hosts = [ { hostname: "A1", started: false}, { hostname: "A2", started: true}]
	var oldHosts = [ { hostname: "A1", started: false}, { hostname: "A2", started: false}]
	var res = balancer._updateHosts(oldHosts, hosts, "A1");
	strictEqual(res[0].hostname, "A1", "local host name")
	strictEqual(res[0].started, true, "local host started")

	var hosts = [ { hostname: "A1", started: false}, { hostname: "A2", started: true}]
	var oldHosts = [ { hostname: "A1", started: true}]
	var res = balancer._updateHosts(oldHosts, hosts, "A3");
	strictEqual(res[0], null, "no local host")
	strictEqual(res[1].hostname, "A1", "first host name")
	strictEqual(res[1].started, true, "first host started")
	strictEqual(res[2].hostname, "A2", "other host name")
	strictEqual(res[2].started, true, "other host started")
	strictEqual(res.length, 3, "number of hosts")
})
