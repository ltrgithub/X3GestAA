"use strict";

var globals = require('streamline-runtime').globals;
var config = require('config'); // must be first syracuse require
var adminHelper = require("@sage/syracuse-lib/src/collaboration/helpers").AdminHelper;
var locale = require('@sage/syracuse-core').locale;

var entityName = "SYRACUSRMNG";
var actionName = "SYRUSRMNG";

//This function is called by the framework with it first parameter an array of string
var serviceShouldbeDisable = function(_, instance) {
	var diagnoses = instance.$diagnoses || [];
	return instance.runInProgress || diagnoses.length > 0;
};

exports.entity = {
	$isPersistent: false,
	$canSave: false,
	$titleTemplate: "HRM Schedule action",
	$descriptionTemplate: "Administration task to schedule HRM action",
	$properties: {
		entityName: {
			$title: "Entity",
			$description: "name of HRM class",
			$type: "string",
			$isDisabled: true,

		}
	},
	$relations: {
		actionName: {
			$title: "X3 Action Name",
			$type: "x3ClassAction",
			$isChild: true,
			$isMandatory: true,
			$lookup: {
				entity: "x3ClassAction",
				field: "action",
				parameters: "class={entityName}&rep={entityName}&facet=$edit&ep={endpoint}"
			},
			$propagate: function(_, instance, val) {
				instance.x3task.actionName(_, val);
			}

		},
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true,
			$lookupFilter: function(_, instance) {
				var userProf = globals.context.session.data.userProfile;
				var items = instance.getHRMEndpoints(_, userProf);

				items = items.map(function(item) {
					return {
						$uuid: item.$uuid
					};
				});

				if (items.length) return {
					$or: items
				};
				else return {
					$uuid: {
						$in: []
					}
				};
			},
			$propagate: function(_, instance, val) {
				if (instance.x3task) {
					instance.x3task.endpoint(_, val);
					instance.x3task.className(_, "SYRACUSRMNG");
					if (instance.x3task.$diagnoses.length === 0) {
						var model = instance.getModel(_);
						var entityAction = model.getEntity(_, "x3ClassAction");
						var instanceAction = entityAction.createInstance(_, model, null);
						instanceAction.action(_, actionName);
						instance.x3task.actionName(_, instanceAction);
					}
					instance.$diagnoses = [];
					(instance.x3task.$diagnoses || []).forEach(function(d) {
						instance.$diagnoses.push(d);
					});
				}
			}

		}
	},
	$init: function(_, instance) {

		instance.runInProgress = false;

		//Visual only because we need to inform the user
		instance.entityName(_, entityName);
		//instance.actionName(_, actionName);

		var model = instance.getModel(_);

		var entityTask = model.getEntity(_, "x3Task");
		var instanceTask = entityTask.createInstance(_, model, null);

		var userProf = globals.context.session.getUserProfile(_);
		var endpointSelected = userProf && userProf.selectedEndpoint(_);
		if (endpointSelected.contract(_) !== "hrm") {
			var endpoints = instance.getHRMEndpoints(_, userProf);
			if (endpoints.length > 0) {
				endpointSelected = endpoints[0];
			}
		}

		instance.endpoint(_, endpointSelected);

		instanceTask.endpoint(_, endpointSelected);
		instanceTask.className(_, entityName);
		instance.x3task = instanceTask;

		/*var entityAction = model.getEntity(_, "x3ClassAction");
		var instanceAction = entityAction.createInstance(_, model, null);
		instanceAction.action(_, actionName);
		instanceTask.actionName(_, instanceAction);
		instance.x3task.$diagnoses = instance.x3task.$diagnoses || [];
*/
		instance.$diagnoses = instance.x3task.$diagnoses;

	},
	$functions: {
		instanciateAndAssignAction: function(_, x3task) {
			var model = this.getModel(_);
			var entityAction = model.getEntity(_, "x3ClassAction");
			var instanceAction = entityAction.createInstance(_, model, null);
			instanceAction.action(_, actionName);
			x3task.actionName(_, instanceAction);
		},
		getModel: function(_) {
			var dbAdmin = adminHelper.getCollaborationOrm(_);
			return dbAdmin.model;
		},
		getHRMEndpoints: function(_, userProf) {
			return userProf.user(_).getUserEndpointsList(_, userProf.selectedRole(_) && userProf.selectedRole(_).$uuid)
				.filter_(_, function(_, ep) {
					return ep.contract(_) === 'hrm';
				});
		},
		execTask: function(_, diags) {
			this.x3task.execTask(_, diags);
		},
		scheduledExecute: function(_, diags) {
			this.execTask(_, diags);
		}
	},

	$services: {
		run: {
			$method: "POST",
			$title: "Execute now",
			$isMethod: true,
			$isDisabled: serviceShouldbeDisable,
			$parameters: {},
			//			$urlParameters: "scheduler={schedulerId}",
			$execute: function(_, context, instance, parameters) {

				instance.runInProgress = true;
				instance.$diagnoses = instance.$diagnoses || [];
				instance.execTask(_, instance.$diagnoses);
				instance.runInProgress = false;
			}
		},
		schedule: {
			$method: "POST",
			$title: "Schedule action",
			$isMethod: true,
			$isDisabled: serviceShouldbeDisable,
			$parameters: {
				$actions: {
					$select: {
						$url: "{$baseUrl}/automates?representation=automate.$select"
					}
				}
			},
			//			$urlParameters: "scheduler={schedulerId}",
			$execute: function(_, context, instance, parameters) {

				if (!parameters || !parameters.$select) {
					return;
				}
				parameters.$select.forEach_(_, function(_, s) {
					function existsError(d) {
						return d.$severity === "error";
					}

					var x3task = instance.x3task;
					var a = instance._db.fetchInstance(_, x3task._db.getEntity(_, "automate"), s.$uuid);
					if (!a) {
						return;
					}

					var diag = a.defineNewTask(_, locale.format(module, "taskLabel"), x3task);
					diag.forEach(function(d) {
						instance.$addDiagnose(d.$severity, d.$message);
					});
					if (!diag.some(existsError)) {
						instance.$addDiagnose("success", locale.format(module, "taskCreated", a.description(_)));
					}
				});
			}
		}
	}
};