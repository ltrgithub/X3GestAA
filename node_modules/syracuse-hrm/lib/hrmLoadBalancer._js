"use strict";

var flows = require("streamline/lib/util/flows");
var locale = require("syracuse-core/lib/locale");
var nodeconfig = require('syracuse-main/lib/nodeconfig');
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;
var hrmHelper = require('syracuse-hrm/lib/hrmHelper');

var trace = nodeconfig.config && nodeconfig.config.hrm && nodeconfig.config.hrm.lb && nodeconfig.config.hrm.lb.trace;
var loadBalancer = {};

exports.selectServer = function(_, options) {

	var db = adminHelper.getCollaborationOrm(_);
	var res = null;
	flows.funnel(1)(_, function(_) {

		function getServer(_, uuid) {
			return servers.filter(function(s) {
				return s.$uuid === uuid;
			})[0];
		}

		var solution = options.solution;
		var folder = options.folder;
		var site = options.site;

		// Retrieve HRM Site instance
		var _site = hrmHelper.getHrmSite(_, db, {
			solution: solution,
			folder: folder,
			site: site
		});
		if (!_site) throw new Error(locale.format(module, "hrmSiteNotFound", JSON.stringify(options, null, 2)));
		trace && trace("Begin server selection for site [" + _site.name(_) + "]");

		var servers = _site.servers(_).toArray(_);
		if (servers.length === 0) throw new Error(locale.format(module, "noWebServerOnHrmSite", _site.name(_)));


		loadBalancer[solution] = loadBalancer[solution] || {};
		loadBalancer[solution][folder] = loadBalancer[solution][folder] || {};
		var list = loadBalancer[solution][folder][site] = loadBalancer[solution][folder][site] || [];
		// remove banned servers and and create a map of uuids
		var bannedList = [];
		var realList = servers.filter_(_, function(_, s) {
			var isBanned = s.banned(_);
			if (isBanned) bannedList.push(s.$uuid);
			return !isBanned;
		}).map(function(s) {
			return s.$uuid;
		});
		trace && trace("Servers linked to site :" + JSON.stringify(realList, null, 2));
		trace && trace("Banned servers :" + JSON.stringify(bannedList, null, 2));
		// ***
		// Synchronize list and real list
		// ***

		for (var i in list) {
			// Remove servers from list if not configured anymore
			if (realList.indexOf(list[i]) === -1) delete list[i];
			// Remove servers from list if banned
			if (bannedList.indexOf(list[i]) !== -1) delete list[i];
		}
		// Concatenate list and real list to be sure to handle all configured servers
		var both = list.concat(realList);
		// remove twins
		list = both.filter(function(item, pos) {
			return both.indexOf(item) == pos;
		});
		// 
		var idx = 0;
		if (options.host && options.port) {
			var srvUuid;
			for (var j in servers) {
				if (servers[j].host(_) === options.host && servers[j].port(_) === options.port) {
					srvUuid = servers[j].$uuid;
					break;
				}
			}
			if (!srvUuid) throw new Error(locale.format(module, "noServerMatchInConf", options.host + ":" + options.port));
			idx = list.indexOf(srvUuid);
			if (idx === -1) {
				// Check if banned
				if (bannedList.indexOf(srvUuid) !== -1)
					throw new Error(locale.format(module, "serverBanned", options.host + ":" + options.port));
				throw new Error(locale.format(module, "noServerMatchInLB", options.host + ":" + options.port));
			}
		}
		// ***
		// Select server to use and Apply round robin algorithm : the first become the last...
		// ***
		var selectedUuid = list[idx];

		trace && trace("***\nLB List before apply round robin :" + JSON.stringify(list, null, 2));
		trace && trace("Selected server :" + JSON.stringify(selectedUuid, null, 2) + "\n***");

		var server = getServer(_, selectedUuid);
		if (!server) throw new Error(locale.format(module, "noServerAvailable"));

		var lastIdx = idx;
		// check availability
		if (options.ignoreAvailability || !server.isServerRunning(_)) {
			// As not available, remove it from LB list
			list.splice(lastIdx, 1);
			trace && trace(locale.format(module, "serverNotAvailable", server.host(_), server.port(_)));
			if (options.SRVHOST && options.SRVPORT) {
				throw new Error(locale.format(module, "serverNotAvailable", server.host(_), server.port(_)));
			}
			for (var k in list) {
				server = getServer(_, list[k]);
				if (server.isServerRunning(_)) {
					trace && trace(locale.format(module, "serverAvailable", server.host(_), server.port(_)));
					selectedUuid = list[k];
					lastIdx = k;
					break;
				} else {
					// As not available, remove it from LB list
					list.splice(k, 1);
					trace && trace(locale.format(module, "serverNotAvailable", server.host(_), server.port(_)));
				}
			}
		}

		// Apply round robin
		if (list.length > 1) {
			list.splice(lastIdx, 1);
			list.push(selectedUuid);
		}
		trace && trace("Selected server : " + server.$uuid + "\n***");
		trace && trace("***\nLB List after apply round robin :" + JSON.stringify(list, null, 2));

		loadBalancer[solution][folder][site] = list;
		res = getServer(_, selectedUuid);
	});
	if (!res) throw new Error("Funnel failed");
	return res;
};