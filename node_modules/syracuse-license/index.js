var fs = require('fs');
var mongodb = require('mongodb')
var util = require('util');
var LICENSE_FILE = exports.LICENSE_FILE = __dirname+"/../../license.json";
var nodelocalFile = 'nodelocal.js'
var config = require("../../nodelocal").config || {}	
	

exports.load = function(name) {
	var filename = __dirname+"/"+process.platform+"_"+process.arch+"/"+name+".node";
	if (fs.existsSync(filename))
		return require(filename);
	else {
		filename = __dirname+"/"+process.platform+"/"+name+".node";
		if (fs.existsSync(filename))
			return require(filename);
		console.log("Native module "+name+".node cannot be found");
	}	
}



exports.register = function(callback, options) {
	var l = exports.load("license");
	if (l) {
		if (fs.existsSync(LICENSE_FILE)) { // read license from file
			console.log("License from file")
			var licenseData = [fs.readFileSync(LICENSE_FILE, "utf8")];
			try {				
				return callback(null, l.register(require, licenseData, options));
			} catch (e) {
				return callback(e);
			}				
		} else { // read license from database
			return exports.readLicenses(function(error, data) { 
				if (error) return callback(error);
				if (data && data.length > 0)
					console.log("License from database");
				return callback(null, l.register(require, data, options))});
		}
	} else {
		return callback(null, false);
	}
}

exports.readLicenses = function(callback) {
	if (!config.license)
		return callback("No database configuration for license");
	var db = new mongodb.Db(config.license.database, new mongodb.Server(config.license.hostname, config.license.port, {}), {});
	// Establish connection to db
	db.open(function(err, db) {
		if (err) 
			return callback(err);
		db.createCollection('license', function(err, collection) {
			if (err) {
				db.close();
				return callback(err);
			}
			collection.find().toArray(function(err, docs) {
				db.close();				
				var result = docs.map(function(doc) { return doc.text;});
				return callback(err, result);
			});
		});
	});
}    

