"use strict";
var fs = require('fs');
var os = require('os');
var mongodb = require('mongodb'); // not streamline-mongodb because this file is used before streamline has been loaded
var util = require('util');
var LICENSE_FILE = exports.LICENSE_FILE = (process.argv[2] === "PATCH" ? __dirname + "/../../license.json" : __dirname + "/../../temp/license.json");
var config = {};
try {
	config = require("../../nodelocal.js").config || {};
} catch (ex) {
	console.error(ex);
}

exports.load = function(name) {
	var arch = os.platform() + '_' + os.arch();
	var v8 = 'v8-' + /[0-9]+\.[0-9]+/.exec(process.versions.v8)[0];
	var filename = __dirname + '/' + arch + '/' + v8 + '/' + name + '.node';
	if (fs.existsSync(filename)) return require(filename);
	else {
		filename = __dirname + '/' + arch + '/default/' + name + '.node';
		if (fs.existsSync(filename)) return require(filename);
	}
	console.log("Native module " + name + ".node cannot be found");
};

exports.register = function(callback, options) {
	var l = exports.load("license");
	if (l) {
		if (fs.existsSync(LICENSE_FILE)) { // read license from file
			console.log("License from file");
			var licenseData = [fs.readFileSync(LICENSE_FILE, "utf8")];
			try {
				return callback(null, l.register(require, licenseData, options));
			} catch (e) {
				return callback(e);
			}
		} else { // read license from database
			return exports.readLicenses(function(error, data) {
				if (error) return callback(error);
				if (data && data.length > 0) console.log("License from database");
				return callback(null, l.register(require, data, options));
			});
		}
	} else {
		return callback(null, false);
	}
};

// the database connection for licenses
exports.getDatabase = function() {
	config.collaboration = config.collaboration || {};
	config.collaboration.driver = config.collaboration.driver || "mongodb";
	if (config.collaboration.driver !== "mongodb") throw new Error("Only MongoDB supported for handling licenses");
	return new mongodb.Db(config.collaboration.dataset || "syracuse", new mongodb.Server(config.collaboration.hostname || "localhost", config.collaboration.port || 27017, {}), {});
};

exports.readLicenses = function(callback) {
	var db = exports.getDatabase();
	// Establish connection to db
	db.open(function(err, db) {
		if (err) return callback(err);
		db.createCollection('license', function(err, collection) {
			if (err) {
				db.close();
				return callback(err);
			}
			collection.find().toArray(function(err, docs) {
				db.close();
				var result = docs.map(function(doc) {
					return doc.text;
				});
				return callback(err, result);
			});
		});
	});
};