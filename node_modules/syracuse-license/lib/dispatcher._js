"use strict";

var check = require('syracuse-license/lib/check');
var url = require('url');

exports.dispatcher = function(config) {
	return function(_, request, response) {
		// test request to see whether server is still alive
		if (request.url.indexOf("/licensetest") >= 0 && url.parse(request.url).pathname === "/licensetest") {
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			console.log("LICENSETEST");
			response.end('OK');
			return;
		}
		// re-read license from database
		if (request.url.indexOf("/licensecheck") >= 0 && url.parse(request.url).pathname === "/licensecheck") {
			console.log("LIC CHECK");
			check.checkNamed(_); // no instance here in order to avoid infinite loop!
			console.log("LIC CHECK");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end('OK');
			return;
		}
		// update license (license is contained in POST data)
		if (request.url.indexOf("/licenseupdate") >= 0 && url.parse(request.url).pathname === "/licenseupdate") {
			var content = request.readAll(_).toString("utf8");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			console.log("Update request");
			var updateResult = check.updateLicense(content, _);
			response.end(updateResult ? 'Valid license' : 'No valid license');
			return;
		}
	};
};