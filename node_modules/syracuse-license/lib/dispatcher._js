"use strict";

var check = require('syracuse-license/lib/check');
var url = require('url');

exports.dispatcher = function(config) {
	var routes = {
		test: function(_, request, response) {
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			console.log("LICENSETEST");
			response.end('OK');
		},
		check: function(_, request, response) {
			console.log("LIC CHECK");
			check.checkNamed(_); // no instance here in order to avoid infinite loop!
			console.log("LIC CHECK");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end('OK');
		},
		update: function(_, request, response) {
			var content = request.readAll(_).toString("utf8");
			response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			console.log("Update request");
			var updateResult = check.updateLicense(content, _);
			response.end(updateResult ? 'Valid license' : 'No valid license');
		},
	};
	return function(_, request, response) {
		var route = routes[request.url.split('/')[2]];
		if (!route) throw new Error("bad url: " + request.url);
		return route(_, request, response);
	};
};