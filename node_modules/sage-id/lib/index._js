/// !doc
/// ## Sage ID SSO core API
///
/// `var sageid = require("sage-id");
///
var helpers = require('syracuse-core/lib/helpers');
var tracer = helpers.debug.tracer("session.trace");
var jsxml = require('jsxml');
var QUnit = require('../test/qunit/qunit.js');
var notificationList = {};

tracer = tracer || console.log;

/// * `sageid.create(options)
/// Create the authentication module with respected options
exports.create = function(options) {
	return new function() {
		/// Run setOptions(options) function to setup post data
		setOptions(options);

		/// * `Please reference the following URL for sample request/response web help
		/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help


		/// * `loginBaseUrl
		/// The system should redirect to this page if non authenticated request
		/// 
		var self = this;
		this.loginBaseUrl = "/index3.html";

		/// * `authenticate(request, response, session, _)
		/// Initial authentication module that will redirect to Sage ID Sign In page
		/// Returns false as user has not yet been autheticated through Sage ID
		this.authenticate = function(request, response, session, _) {
			/// * `Setup post data for StartSignOnAttempt request to Sage ID
			/// See web help for StartSignOnAttemptRequest
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebStartSignOnAttempt
			var postData = "<StartSignOnAttemptRequest>" + //
				"<SuccessUri xmlns=\"http://sso.sage.com\">" + options.StartSignOnAttemptRequest.SuccessUri + "</SuccessUri>" + //
				"<FailureUri xmlns=\"http://sso.sage.com\">" + options.StartSignOnAttemptRequest.FailureUri + "</FailureUri>" + //
				"<CancelAllowed xmlns=\"http://sso.sage.com\">" + options.StartSignOnAttemptRequest.CancelAllowed + "</CancelAllowed>" + //
				"<State xmlns=\"http://sso.sage.com\">" + options.StartSignOnAttemptRequest.State + "</State>" + //
				"<SessionLengthMinutes xmlns=\"http://sso.sage.com\">" + options.StartSignOnAttemptRequest.SessionLengthMinutes + "</SessionLengthMinutes>" + //
				"</StartSignOnAttemptRequest>";

			// Initialize start sign on options
			var json = client(_, options, 'StartSignOnAttempt', postData);

			// Parse out signOnAttemptId and redirectURI for later use
			var signOnAttemptId = json.StartSignOnAttemptResponse.SignOnAttemptId.$value;
			var redirectUri = json.StartSignOnAttemptResponse.RedirectUri.$value;

			// Store response in session for future use.
			session.StartSignOnAttemptResponse = json.StartSignOnAttemptResponse;

			// Redirect web page to redirectURI from Sage ID response
			response.writeHead(303, {
				"Content-Type": "text/html",
				"Location": redirectUri,
			});
			response.end('<html>Use <a href="' + redirectUri + '">Login</a> if redirect does not work automatically</html>');

			// Return false since user has not been authenticated into Sage ID
			return false;
		};

		/// * `unAuthenticated(request, response, _)
		/// Called in case of unauthenticated server access, writes relevant headers and diagnoses into the response
		/// Returns false
		this.unAuthenticated = function(request, response, _) {
			if (request.unauthUseRedirect) {
				response.writeHead(307, {
					"location": self.loginBaseUrl + "?callbackUrl=" + encodeURIComponent(request.url)
				});
				response.end();
			} else {
				response.writeHead(401, {
					"Content-Type": "application/json",
					"WWW-Authenticate": "SageERPX3"
				});
				response.end(JSON.stringify({
					$diagnoses: [{
						$severity: "error",
						$message: "Authorization required"
					}],
					$location: {
						$url: "/index3.html"
					}
				}));
			}
			return false;
		};

		/// * `dispatch(request, response, session, _)
		/// Dispatcher module that will redirect to correct method based on URL
		/// Returns respected method
		this.dispatch = function(request, response, session, _) {
			var fs = request.url.substring(options.prefix.length).split('/')[2];
			var dispatch = _map[fs];
			if (!dispatch)
				throw new Error("bad url: " + request.url);
			return dispatch(request, response, session, _);
		};

		/// * `closeAuthenticate(request, response, session, _)
		/// Closes authentication attempt for Sage ID sign in
		/// Returns JSON data containing email, sessionId, accessToken and identityId from Sage ID
		this.closeAuthenticate = function(request, response, session, _) {
			var match = request.url.substring(options.prefix.length).split('/');
			// resultId is necessary for completing sign on attempt
			var resultId = match[1];
			// Check presence of session and SignOnAttemptId in session.
			if (!session) throw new Error("no session");
			if (!session.StartSignOnAttemptResponse || !session.StartSignOnAttemptResponse.SignOnAttemptId) throw new Error("invalid SSO info");

			/// * `Setup post data for EndSignOnAttemptRequest request to Sage ID
			/// See web help for EndSignOnAttemptRequest
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebEndSignOnAttempt
			var postData = "<EndSignOnAttemptRequest>" + //
				"<ResultId xmlns=\"http://sso.sage.com\">" + resultId + "</ResultId>" + //
				"</EndSignOnAttemptRequest>";

			// Initialize end sign on options
			var json = client(_, options, 'EndSignOnAttempt', postData);

			// Parse out email, displayName, identityId, and accessToken
			var email = json.EndSignOnAttemptResponse.SuccessResult.EmailAddress;
			var displayName = json.EndSignOnAttemptResponse.SuccessResult.DisplayName;
			var identityId = json.EndSignOnAttemptResponse.SuccessResult.IdentityId;
			var accessToken = json.EndSignOnAttemptResponse.SuccessResult.UserAuthenticationToken;
			var sessionId = json.EndSignOnAttemptResponse.SuccessResult.SessionId;

			// Store response in session, for future use
			session.EndSignOnAttemptResponse = json.EndSignOnAttemptResponse.SuccessResult;

			tracer && tracer("End sign on Successful");
			// Create json containing email and unique identityId
			var sageIdData = {
				email: email,
				identityId: identityId,
				accessToken: accessToken,
				auth: true,
				sessionId: sessionId
			};
			//tracer && tracer(sageIdData)
			// Uncomment below when running test.js
			/*response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end(displayName + ' has been successully authenticated. The current time is ' + new Date());*/
			// Return sageIdData
			return sageIdData;
		};

		/// * `signup(request, response, session, _)
		/// Initial register module that will redirect to Sage ID Sign Up page
		/// Returns false as user has not yet been registered with Sage ID
		this.signup = function(request, response, session, _) {
			/// * `Setup post data for StartSignOnAttempt request to Sage ID
			/// See web help for StartSignOnAttemptRequest
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebStartSignOnAttempt
			var postData = "<StartNewUserRegistrationAttemptRequest>" + //
				"<SuccessUri xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.SuccessUri + "</SuccessUri>" + //
				"<FailureUri xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.FailureUri + "</FailureUri>" + //
				"<CancelAllowed xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.CancelAllowed + "</CancelAllowed>" + //
				"<State xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.State + "</State>" + "<SessionLengthMinutes xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.SessionLengthMinutes + "</SessionLengthMinutes>" + //
				"<SignOnAfterSuccess xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.SignOnAfterSuccess + "</SignOnAfterSuccess>" + //
				"<ActivateAfterSuccess xmlns=\"http://sso.sage.com\">" + options.StartNewUserRegistrationAttemptRequest.ActivateAfterSuccess + "</ActivateAfterSuccess>" + //
				"</StartNewUserRegistrationAttemptRequest>";

			// Initialize start sign on options
			var json = client(_, options, 'StartNewUserRegistrationAttempt', postData);

			// Parse out RegistrationAttemptId and redirectURI for later use
			var regAttemptId = json.StartRegistrationAttemptResponse.RegistrationAttemptId.$value;
			var redirectUri = json.StartRegistrationAttemptResponse.RedirectUri.$value;

			// Store response in session for future use.
			session.StartRegistrationAttemptResponse = json.StartRegistrationAttemptResponse;

			// Redirect web page to redirectURI from Sage ID response
			response.writeHead(303, {
				"Content-Type": "text/html",
				"Location": redirectUri,
			});
			response.end('<html>Use <a href="' + redirectUri + '">Login</a> if redirect does not work automatically</html>');

			// Return false since user has not been authenticated into Sage ID
			return false;
		};

		/// * `closeSignUp(request, response, session, _)
		/// Closes sign up attempt for Sage ID
		/// Returns JSON data containing email, sessionId, accessToken and identityId from Sage ID
		this.closeSignUp = function(request, response, session, _) {
			var match = request.url.substring(options.prefix.length).split('/');
			// resultId is necessary for completing sign on attempt
			var resultId = match[1];
			// Check presence of session and SignOnAttemptId in session.
			if (!session) throw new Error("no session");
			if (!session.StartRegistrationAttemptResponse || !session.StartRegistrationAttemptResponse.RegistrationAttemptId) throw new Error("invalid SSO info");

			/// * `Setup post data for EndRegistrationAttemptRequest request to Sage ID
			/// See web help for EndRegistrationAttemptRequest
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebEndNewUserRegistrationAttempt
			var postData = "<EndRegistrationAttemptRequest>" + //
				"<ResultId xmlns=\"http://sso.sage.com\">" + resultId + "</ResultId>" + //
				"</EndRegistrationAttemptRequest>";

			// Initialize end sign up options
			var json = client(_, options, 'EndNewUserRegistrationAttempt', postData);

			// Parse out email, displayName, identityId, and accessToken
			var email = json.EndRegistrationAttemptResponse.RegistrationSuccessResult.SuccessResult.EmailAddress;
			var displayName = json.EndRegistrationAttemptResponse.RegistrationSuccessResult.SuccessResult.DisplayName;
			var identityId = json.EndRegistrationAttemptResponse.RegistrationSuccessResult.SuccessResult.IdentityId;
			var accessToken = json.EndRegistrationAttemptResponse.RegistrationSuccessResult.SuccessResult.UserAuthenticationToken;
			var sessionId = json.EndRegistrationAttemptResponse.RegistrationSuccessResult.SuccessResult.SessionId;

			// Store response in session, for future use
			session.EndRegistrationAttemptResponse = json.EndRegistrationAttemptResponse.RegistrationSuccessResult;

			tracer && tracer("End sign up Successful");
			// Create json containing email and unique identityId
			var sageIdData = {
				email: email,
				identityId: identityId,
				accessToken: accessToken,
				auth: true,
				sessionId: sessionId
			};
			//tracer && tracer(sageIdData)
			// Uncomment when running test.js
			/*response.writeHead(200, {
				"Content-Type": "text/plain"
			});
			response.end(displayName + ' has been successully signed up and authenticated. The current time is ' + new Date());*/
			// Return sageIdData
			return sageIdData;
		};

		/// * `logout(request, response, session, _)
		/// Logout module that will remove session
		/// Returns false as user has been removed from session and must re-authenticate
		this.logout = function(request, response, session, _) {
			/// * `Setup post data for WebSessionSignOff request to Sage ID
			/// See web help for WebSessionSignOff
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebSessionSignOff

			// Extract sessionId from session
			var sessionId = "";
			if (session.EndSignOnAttemptResponse)
				sessionId = session.EndSignOnAttemptResponse.SessionId;
			else if (session.EndRegistrationAttemptResponse)
				sessionId = session.EndRegistrationAttemptResponse.SuccessResult.SessionId;
			else throw new Error("Cannot find session ID");

			var postData = "<SessionSignOffRequest>" + //
				"<SessionId xmlns=\"http://sso.sage.com\">" + sessionId + "</SessionId>" + //
				"</SessionSignOffRequest>";

			// Initialize sign out options
			var json = client(_, options, 'SessionSignOff', postData);

			// Parse out signOffAttempt, either true or false
			var signOffAttempt = json.SessionSignOffResponse.Success.$value;

			if (!signOffAttempt) {
				throw new Error("Sage ID Sign Out failed!");
			}
			return signOffAttempt;
		};

		/// * `sessionHandle(request, response, session, _)
		/// Determine which method should be used to hanlde current Sage ID session
		this.sessionHandle = function(request, response, session, _) {
			// Read request body and decode from Base64 format
			// Data is decoded to XML
			var reqBody = request.readAll(_);
			var buf = new Buffer(reqBody, 'base64');
			var xml = buf.toString();
			// Parse xml data in readable JSON
			var reqJSON = jsxml.parse(xml);

			// Extract notification ID from parsed JSON
			var notifyId = reqJSON.Notification.NotificationId;
			// Extract notification from list
			var notification = notificationList[notifyId];
			// If notification does not exist handle the notification
			// Else disregard notification and remove ID from notification list
			var authData = {
				sessionNotify: false,
				auth: false
			};
			if (!notification) {
				notificationList[notifyId] = true;
				// Extract notification type from JSON
				// Either ExpiryDue or Ended
				var notificationType = reqJSON.Notification.Type.split('.')[1];
				tracer && tracer(notificationType);
				// Extract parameters where sessionId, expirationTimestamp, and emailAddress are located
				var parameters = reqJSON.Notification.Parameters.Parameter;
				// Extract sessionId from JSON
				var sessionId = parameters[0].Value;
				// Extract expireTime, time and date session will expire
				var expireTime = parameters[2].Value;
				var expireDate = new Date(expireTime);
				if (!sessionId)
					throw new Error("Cannot find session ID");
				// Return authData with sessionId, notificationType, and expiration date of session
				authData = {
					sessionNotify: true,
					auth: false,
					sessionId: sessionId,
					notificationType: notificationType,
					expireDate: expireDate
				};
			} else {
				// Remove notification from list
				delete notificationList[notifyId];
			}
			return authData;
		};

		/// * `sessionExtend(request, response, sessionId, _)
		/// Extends Sage ID session
		/// Returns JSON data containing email and new accessToken to replace old one
		this.sessionExtend = function(request, response, session, _) {
			/// * `Setup post data for WebSessionExtend request to Sage ID
			/// See web help for WebSessionExtend
			/// https://services.sso.staging.services.sage.com/sso/webssoservice/web/help/operations/WebSessionExtend

			// Extract last activity date and time from session
			var lastActivity = session.lastAccess;

			// New expiration date is current time plus 30 mins, based on Syracuse timeout
			var newExpirationDate = new Date(new Date(lastActivity).getTime() + 1800000);
			// Extract sessionId from session
			var sessionId = "";
			if (session.EndSignOnAttemptResponse)
				sessionId = session.EndSignOnAttemptResponse.SessionId;
			else
				sessionId = session.EndRegistrationAttemptResponse.SessionId;

			var postData = "<SessionExtendRequest>" + //
				"<SessionId xmlns=\"http://sso.sage.com\">" + sessionId + "</SessionId>" + //
				"<SessionExpiry xmlns=\"http://sso.sage.com\">" + newExpirationDate.toISOString() + "</SessionExpiry>" + //
				"</SessionExtendRequest>";

			// Initialize extend options
			var json = client(_, options, 'SessionExtend', postData);

			// Parse out new accessToken
			var accessToken = json.SessionExtendResponse.UserAuthenticationToken.$value;
			var email = "";
			// Overwrite token in session with new one
			if (session.EndSignOnAttemptResponse) {
				session.EndSignOnAttemptResponse.UserAuthenticationToken = accessToken;
				email = session.EndSignOnAttemptResponse.EmailAddress;
			} else {
				session.EndRegistrationAttemptResponse.UserAuthenticationToken = accessToken;
				email = session.EndRegistrationAttemptResponse.EmailAddress;
			}
			// Remove session expiration mark
			session.expireDue = false;
			// Return authData, auth is false as no authentication is required
			var authData = {
				auth: true,
				accessToken: accessToken,
				email: email
			};
			tracer && tracer("Session extended");
			return authData;
		};

		/// * `sessionEnd(request, response, sessionId, _)
		/// Session has ended
		/// Return sessionEnd true to have application handle session
		this.sessionEnd = function(request, response, session, _) {
			tracer && tracer("Your session has ended.");
			var authData = {
				auth: false,
				sessionEnded: true
			};
			return authData;
		};

		/// * `map
		/// Map for urls
		var _map = {
			// Redirect to begin Sage ID Sign In
			signIn: this.authenticate,
			// Redirect to begin Sage ID Sign Up
			signUp: this.signup,
			// Redirect for successful Sage ID Sign In
			startSignOnAttemptSuccess: this.closeAuthenticate,
			// Redirect for successful Sage ID Sign Up
			startNewUserRegistrationAttemptSuccess: this.closeSignUp,
			// Redirect for session handling of Sage ID
			notify: this.sessionHandle,
			// Redirect for session extension for Sage ID
			ExpiryDue: this.sessionExtend,
			// Redirect for session end for Sage ID
			Ended: this.sessionEnd
		};
	};
};

/// * `setOptions(options)
/// Setup all postData variables
/// If variable was not passed, it gets defaulted
function setOptions(options) {
	// Setup SageID base URL
	options.sageIdBase = options.sageIdBase || "https://services.sso.staging.services.sage.com/SSO";

	// Setup SageID prefix
	options.prefix = options.prefix || "/sage-id/";

	// Setup start sign on variables StartSignOnAttemptRequest
	if (options.StartSignOnAttemptRequest) {
		options.StartSignOnAttemptRequest.SuccessUri = options.StartSignOnAttemptRequest.SuccessUri || "http://example.sage.com/success";
		options.StartSignOnAttemptRequest.FailureUri = options.StartSignOnAttemptRequest.FailureUri || "http://example.sage.com/failure";
		options.StartSignOnAttemptRequest.CancelAllowed = options.StartSignOnAttemptRequest.CancelAllowed || "true";
		options.StartSignOnAttemptRequest.State = options.StartSignOnAttemptRequest.State || "test";
		options.StartSignOnAttemptRequest.SessionLengthMinutes = options.StartSignOnAttemptRequest.SessionLengthMinutes || 60;
	}

	// Setup start sign up variables StartNewUserRegistrationAttemptRequest
	if (options.StartNewUserRegistrationAttemptRequest) {
		options.StartNewUserRegistrationAttemptRequest.SuccessUri = options.StartNewUserRegistrationAttemptRequest.SuccessUri || "http://example.sage.com/register/success";
		options.StartNewUserRegistrationAttemptRequest.FailureUri = options.StartNewUserRegistrationAttemptRequest.FailureUri || "http://example.sage.com/register/failure";
		options.StartNewUserRegistrationAttemptRequest.CancelAllowed = options.StartNewUserRegistrationAttemptRequest.CancelAllowed || "true";
		options.StartNewUserRegistrationAttemptRequest.State = options.StartNewUserRegistrationAttemptRequest.State || "test";
		options.StartNewUserRegistrationAttemptRequest.SessionLengthMinutes = options.StartNewUserRegistrationAttemptRequest.SessionLengthMinutes || 60;
		options.StartNewUserRegistrationAttemptRequest.SignOnAfterSuccess = options.StartNewUserRegistrationAttemptRequest.SignOnAfterSuccess || "true";
		options.StartNewUserRegistrationAttemptRequest.ActivateAfterSuccess = options.StartNewUserRegistrationAttemptRequest.ActivateAfterSuccess || "true";
	}
}

function client(_, options, action, postData) {

	var clientOptions = {
		method: "POST",
		url: options.sageIdBase + "/WebSSOService/web/Web" + action,
		pfx: options.pfx_object,
		passphrase: options.pass,
		headers: {
			'Content-Type': 'text/xml',
			'Content-Length': Buffer.byteLength(postData)
		}
	};

	// Check which request type is being used
	// Either ez-stream http client or syracuse based http client
	var httpClient = options.httpClient || require("ez-streams").devices.http.client;

	// Initialize request out to Sage ID
	var req = options.httpClient ? httpClient(_, clientOptions) : httpClient(clientOptions);

	// Write post data to request
	req.end(new Buffer(postData));
	var resp = req.response(_);
	tracer && tracer(resp.statusCode);

	// Check to ensure response comes back OK
	if (resp.statusCode !== 200) throw new Error("bad response from " + action + ": " + resp.statusCode);

	// Read all data from Sage ID response
	var body = resp.readAll(_);

	// Convert xml response to JSON
	var json = {};
	try {
		json = jsxml.parse(body);
	} catch (ex) {}

	return json;
}
