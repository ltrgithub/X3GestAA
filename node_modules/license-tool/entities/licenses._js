"use strict";
var locale = require("streamline-locale");
var helper = require('license-tool/lib/helper');
var fs = require('streamline-fs');
var util = require('util');
var globals = require('streamline-runtime').globals;

module.exports = {
	$title: "Licenses",
	$modes: "duplicate!,query,details,delete,create!,extra!,edit!",
	$links: {
		$extra: {
			$title: "License Creation",
			$type: "application/x-document",
			$method: "GET",
			$url: "/downloads/license/license-{$uuid}"
		},
		$duplicate: {
			$url: "/data/licenses/$workingCopies/{$uuid}?representation=licenses.$edit&duplicate=1&policy={productCode}-{productVersion}-{policyCode}-{policyVersion}",
			$title: "New license from this license",
			$method: "POST",
		}
	},
	$properties: {
		policyFile: {
			$title: "Policy",
			$isMandatory: true,
			$noQuery: true,
			$type: "application/x-reference",
			$item: {
				$url: "/data/policies/{$uuid}?representation=policies.$thumb",
				$shortUrl: "/data/policies/{$uuid}",
				$value: "{productCode}-{productVersion}-{policyCode}-{policyVersion}",
				$key: "{$uuid}",
				$description: "Policy",
				$properties: {
					productCode: {
						$type: "application/x-string"
					},
					productVersion: {
						$type: "application/x-string"
					},
					policyCode: {
						$type: "application/x-string"
					},
					policyVersion: {
						$type: "application/x-string"
					},
				},
				$prototype: "/page?representation=policies.$thumb",
				$links: {
					$lookup: {
						$type: "application/json",
						$title: "Select the policy",
						$url: "/data/policies?representation=policies.$lookup",
					},
					$details: {
						$type: "application/json",
						$url: "/data/policies/{$uuid}?representation=policies.$details",
					},
				}
			}

		},
		productCode: {
			$title: "Product",
			$type: "application/x-string",
			$isReadOnly: true,
			$displayLength: 7,
			$links: {
				$details: {
					$url: "/data/licenses/{$uuid}?representation=licenses.$details",
				},
			},
		},
		productVersion: {
			$title: "Product version",
			$isReadOnly: true,
			$displayLength: 7,
			$type: "application/x-string"
		},
		policyCode: {
			$title: "Policy code",
			$isReadOnly: true,
			$displayLength: 7,
			$type: "application/x-string",
		},
		policyVersion: {
			$title: "Policy version",
			$isReadOnly: true,
			$displayLength: 7,
			$type: "application/x-string"
		},
		generationStamp: {
			$title: "Generation time",
			$type: "application/x-datetime",
			$isReadOnly: true
		},
		exported: {
			$title: "Downloaded",
			$type: "application/x-boolean",
			$isReadOnly: true
		},
		genStamp: {
			$title: "Gen time",
			$type: "application/x-string",
			$isReadOnly: true,
			$isHidden: true,
			$noQuery: true
		},
		licenseeName: {
			$title: "Name of licensee",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeReference: {
			$title: "Licensee reference",
			$type: "application/x-string",
			$pattern: "^\\w+$",
			$displayLength: 8,
			$isMandatory: true
		},
		licenseeRegistrationNumber: {
			$title: "Registration number",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeAddress1: {
			$title: "Street",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeAddress2: {
			$title: "Complement",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeCity: {
			$title: "City",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeZip: {
			$title: "ZIP code",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeState: {
			$title: "State",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseeCountry: {
			$title: "Country",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerName: {
			$title: "Name of reseller",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerReference: {
			$title: "Reference",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerRegistrationNumber: {
			$title: "Registration number",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerAddress1: {
			$title: "Street",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerAddress2: {
			$title: "Complement",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerCity: {
			$title: "City",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerZip: {
			$title: "ZIP code",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerState: {
			$title: "State",
			$type: "application/x-string",
			$noQuery: true
		},
		resellerCountry: {
			$title: "Country",
			$type: "application/x-string",
			$noQuery: true
		},
		valStart: {
			$title: "Start of validity",
			$type: "application/x-date",
			$isMandatory: true,
			$noQuery: true
		},
		valEnd: {
			$title: "End of validity",
			$type: "application/x-date",
			$isMandatory: true,
			$noQuery: true
		},
		serial: {
			$title: "Serial number",
			$type: "application/x-string",
			$noQuery: true
		},
		licenseType: {
			$title: "License type",
			$type: "application/x-choice",
			$isMandatory: true,
			$value: {
				$type: "application/x-string",
				$enum: [{
					$value: "NFR",
					$title: "Not for resale"
				}, {
					$value: "DEMO",
					$title: "Demo license"
				}, {
					$value: "STANDARD",
					$title: "Partner license"
				}]
			},
			$noQuery: true
		},
		activityCodes: {
			$title: "Activity codes",
			$type: "application/x-array",
			$capabilities: "sort",
			$item: {
				code: {
					$title: "Code",
					$type: "application/x-string",
					$displayLength: 5,
					$isReadOnly: true,
				},
				licensed: {
					$title: "Licensed",
					$type: "application/x-boolean",
				},
				title: {
					$title: "Title",
					$isReadOnly: true,
					$displayLength: 10,
					$type: "application/x-string"
				},
				valStart: {
					$title: "Start of validity",
					$type: "application/x-date"
				},
				valEnd: {
					$title: "End of validity",
					$type: "application/x-date"
				},
			}
		},
		badges: {
			$title: "Badges",
			$type: "application/x-array",
			$capabilities: "sort",
			$item: {
				code: {
					$title: "Code",
					$type: "application/x-string",
					$displayLength: 5,
					$isMandatory: true,
				},
				licensed: {
					$title: "Licensed",
					$type: "application/x-boolean",
				},
				title: {
					$title: "Title",
					$isReadOnly: true,
					$displayLength: 10,
					$type: "application/x-string"
				},
				max: {
					$title: "Maximum",
					$type: "application/x-integer",
					$isMandatory: true,
					$displayLength: 5,
					$minimum: 0,
					$minimumCanEqual: true
				},

			}
		},
		parameters: {
			$title: "Parameters",
			$type: "application/x-array",
			$capabilities: "sort",
			$item: {
				code: {
					$title: "Code",
					$displayLength: 5,
					$isReadOnly: true,
					$type: "application/x-string"
				},
				licensed: {
					$title: "Licensed",
					$type: "application/x-boolean",
				},
				title: {
					$title: "Title",
					$isReadOnly: true,
					$displayLength: 10,
					$type: "application/x-string"
				},
				value: {
					$title: "Value",
					$type: "application/x-integer",
					$displayLength: 7,
					$isMandatory: true
				},
			}
		},
		languages: {
			$title: "Languages",
			$type: "application/x-array",
			$capabilities: "sort",
			$item: {
				code: {
					$title: "Code",
					$type: "application/x-string",
					$displayLength: 5,
					$isReadOnly: true,
				},
				licensed: {
					$title: "Licensed",
					$type: "application/x-boolean",
				},
				title: {
					$title: "Title",
					$isReadOnly: true,
					$displayLength: 10,
					$type: "application/x-string"
				},
				valStart: {
					$title: "Start of validity",
					$type: "application/x-date"
				},
				valEnd: {
					$title: "End of validity",
					$type: "application/x-date"
				},
			}
		},
		legislations: {
			$title: "Legislations",
			$type: "application/x-array",
			$capabilities: "sort",
			$item: {
				code: {
					$title: "Code",
					$type: "application/x-string",
					$displayLength: 5,
					$isReadOnly: true,
				},
				licensed: {
					$title: "Licensed",
					$type: "application/x-boolean",
				},
				title: {
					$title: "Title",
					$isReadOnly: true,
					$displayLength: 10,
					$type: "application/x-string"
				},
				valStart: {
					$title: "Start of validity",
					$type: "application/x-date"
				},
				valEnd: {
					$title: "End of validity",
					$type: "application/x-date"
				},
			}
		},
	},
	$init: function(_, wc, query) {
		return _fillData(_, wc, undefined, query.policy);
	},

	$referenceUpdate: function(_, wc, reference) {
		return _fillData(_, wc, null, reference.$uuid);
	},

	$list: function(_, query) {
		var startIndex = +query.startIndex || 1;
		var endIndex = startIndex + (+query.count || 50) - 1;
		var counter = 0;
		var customers = query.customer ? [query.customer] : fs.readdir(helper.LICENSES, _);
		customers = customers.sort();
		var resources = [];
		var policies = {};
		customers.some_(_, function(_, customer) {
			try {
				var lics = fs.readdir(helper.LICENSES + "/" + customer, _);
				lics = lics.sort();
				if (lics.some(function(p) {
					if (p.indexOf(".json") === p.length - 5) {
						if (++counter < startIndex) return;
						else if (counter > endIndex) {
							resources.truncated = true;
							return true;
						}
						p = p.substr(0, p.length - 5);
						var policyName = p.substr(0, p.lastIndexOf("-"));
						if (policyName in policies) {
							policies[policyName]++;
						} else {
							policies[policyName] = 1;
						}
						var parts = p.split("-");
						var flag = false;
						if (parts[4].substr(-1) === "e") { // exported file
							flag = true;
							parts[4] = parts[4].replace("e", "");
						}
						var date = parts[4] + "00";
						resources.push({
							$uuid: customer + "-" + parts.join("-"),
							productCode: parts[0],
							productVersion: parts[1],
							policyCode: parts[2],
							policyVersion: parts[3],
							licenseeReference: customer,
							exported: flag,
							generationStamp: date.slice(0, 4) + "-" + date.slice(4, 6) + "-" + date.slice(6, 8) + "T" + date.slice(8, 10) + ":" + date.slice(10, 12) + ":" + date.slice(12, 14) + "Z",
						});
					}
				})) return true;
			} catch (e) {
				// ignore
				if (e.code !== "ENOENT") console.log("IO error during licenses reading " + e.stack);
			}
		});
		if (!query.customer) helper.setUsedPolicies(_, policies);
		return resources;
	},
	$load: function(_, key, query, edit) {
		var result = {};
		_fillData(_, result, key, query.policy);
		if (edit && result.exported) {
			if (query.duplicate) result.exported = false;
			else {
				return {
					$diagnoses: helper.addError(locale.format(module, "noEdit"), null, "licenses", key)
				};
			}
		}

		return result;
	},
	$save: function(_, wc, diagnoses) {
		if (!helper.partnerFile) {
			helper.addError(locale.format(module, "noPartner"), diagnoses);
			return key;
		}
		var filename = wc.productCode + "-" + wc.productVersion + "-" + wc.policyCode + "-" + wc.policyVersion + "-" + new Date().toISOString().replace(/[^\d]/g, "").substr(0, 14);
		var key = wc.licenseeReference + "-" + filename;
		var fullFilename = wc.licenseeReference + "/" + filename + ".json";
		if (key !== wc.$uuid) {
			if (fs.exists(helper.LICENSES + "/" + fullFilename, _)) {
				helper.addError(locale.format(module, "exists"), diagnoses);
				return key;
			}
		};
		if (wc.valEnd < wc.valStart) {
			helper.addError(locale.format(module, "endBeforeBeginning"), diagnoses);
			return key;
		};
		var activityCodesL = [];
		var parametersL = [];
		var badgesL = [];
		var languagesL = [];
		var legislationsL = [];
		wc.activityCodes.forEach(function(item) {
			if (item.licensed) {
				var validity;
				if (item.valStart || item.valEnd) {
					validity = [item.valStart || wc.valStart, item.valEnd || wc.valEnd];
				}
				activityCodesL.push({
					code: item.code,
					validity: validity
				});
			}
		});
		wc.badges.forEach(function(item) {
			if (item.licensed) {
				var validity;
				badgesL.push({
					code: item.code,
					max: item.max
				});
			}
		});
		wc.parameters.forEach(function(item) {
			if (item.licensed) {
				parametersL.push({
					code: item.code,
					value: item.value
				});
			}
		});
		wc.languages.forEach(function(item) {
			if (item.licensed) {
				var validity;
				if (item.valStart || item.valEnd) {
					validity = [item.valStart || wc.valStart, item.valEnd || wc.valEnd];
				}
				languagesL.push({
					code: item.code,
					validity: validity
				});
			}
		});
		wc.legislations.forEach(function(item) {
			if (item.licensed) {
				var validity;
				if (item.valStart || item.valEnd) {
					validity = [item.valStart || wc.valStart, item.valEnd || wc.valEnd];
				}
				legislationsL.push({
					code: item.code,
					validity: validity
				});
			}
		});
		var result = {
			fileType: "License",
			generationStamp: new Date(),
			partnerId: helper.partnerFile.partnerId,
			product: {
				code: wc.productCode,
				version: wc.productVersion
			},
			policy: {
				code: wc.policyCode,
				version: wc.policyVersion
			},
			licensedTo: {
				name: wc.licenseeName,
				reference: wc.licenseeReference,
				registrationNumber: wc.licenseeRegistrationNumber,
				address: {
					address1: wc.licenseeAddress1,
					address2: wc.licenseeAddress2,
					city: wc.licenseeCity,
					zip: wc.licenseeZip,
					state: wc.licenseeState,
					country: wc.licenseeCountry
				}
			},
			serial: wc.serial,
			serialControl: !! wc.serial,
			licenseType: wc.licenseType,
			validity: [wc.valStart, wc.valEnd],
			activityCodes: activityCodesL,
			languages: languagesL,
			legislations: legislationsL,
			badges: badgesL,
			parameters: parametersL,
			signature: helper.partnerFile.partnerId,
			signatureText: helper.partnerFile.partnerId
		};
		if (wc.resellerName || wc.resellerReference) {
			result.reseller = {
				name: wc.resellerName,
				reference: wc.resellerReference,
				registrationNumber: wc.resellerRegistrationNumber,
				address: {
					address1: wc.resellerAddress1,
					address2: wc.resellerAddress2,
					city: wc.resellerCity,
					zip: wc.resellerZip,
					state: wc.resellerState,
					country: wc.resellerCountry

				}
			};
		}
		var signed = helper.signLicense(result, globals.context);
		try {
			fs.mkdir(helper.LICENSES + "/" + wc.licenseeReference);
		} catch (e) {
			// ignore
		}
		fs.writeFile(helper.LICENSES + "/" + fullFilename, signed, _);
		if (key !== wc.$uuid) { // add a new used license
			var policyKey = filename.substr(0, filename.lastIndexOf("-"));
			helper.usedPolicies(_, policyKey, 1);
			if (wc.__oldPolicy) {
				helper.usedPolicies(_, wc.__oldPolicy, -1);
			}
		}
		if (wc.genStamp) {
			var oldFilename = helper.LICENSES + "/" + (wc.__oldLicReference || wc.licenseeReference) + "/" + (wc.__oldPolicy || wc.productCode + "-" + wc.productVersion + "-" + wc.policyCode + "-" + wc.policyVersion) + "-" + wc.genStamp + ".json";
			try {
				fs.unlink(oldFilename, _);
			} catch (e) {
				// if (e.code != "ENOENT") 
				throw e;
			}
		}
		return key;
	},
	$delete: function(_, key, diags) {
		key = key.replace("-", "/"); // replace first dash.
		try {
			try {
				fs.unlink(helper.LICENSES + "/" + key + ".json", _);
			} catch (e) {
				if (e.code === 'ENOENT') { // maybe already downloaded license
					// license already downloaded: do not delete!
					if (fs.exists(helper.LICENSES + "/" + key + "e.json", _)) {
						return helper.addError(locale.format(module, "notDeleteLicense"), diags);
					}
					// fs.unlink(helper.LICENSES + "/" + key + "e.json", _);
				}
			}
			var policyKey = key.substring(key.indexOf('/') + 1, key.lastIndexOf("-"));
			helper.usedPolicies(_, policyKey, -1);
		} catch (e) {
			console.error(e.stack);
		}
	}
};

function _fillData(_, result, uuid, policy) {
	var license;
	var generationStamp;
	var genStamp;
	var exported;
	var newLicense; // true when a new license is edited
	if (uuid) {
		var parts = uuid.split("-");
		var filename = helper.LICENSES + "/" + parts[0] + "/" + parts.slice(1).join("-") + ".json";
		if (result && !result.__oldLicReference) result.__oldLicReference = parts[0];
		if (!fs.exists(filename, _)) {
			exported = true;
			filename = filename.replace(/.json$/, "e.json");
		};
		try {
			var license = helper.fileTest(_, filename, "License");
		} catch (e) {
			return {
				$diagnoses: helper.addError(e.message)
			};
		}
		if (!policy) {
			generationStamp = license.generationStamp;
			genStamp = parts[5];
			policy = parts.slice(1, 5).join("-");
		}
	}
	// reseller data
	var resAddress;
	if (license) {
		result.generationStamp = generationStamp;
		result.genStamp = genStamp;
		var licensedTo = license.licensedTo;
		if (licensedTo) {
			result.licenseeName = licensedTo.name;
			result.licenseeReference = licensedTo.reference;
			result.licenseeRegistrationNumber = licensedTo.registrationNumber;
			if (licensedTo.address) {
				result.licenseeAddress1 = licensedTo.address.address1;
				result.licenseeAddress2 = licensedTo.address.address2;
				result.licenseeCity = licensedTo.address.city;
				result.licenseeZip = licensedTo.address.zip;
				result.licenseeState = licensedTo.address.state;
				result.licenseeCountry = licensedTo.address.country;
			}
		}
		result.serial = license.serial;
		result.valStart = license.validity[0];
		result.valEnd = license.validity[1];
		result.licenseType = license.licenseType;
		var reseller = license.reseller;
		if (reseller) {
			result.resellerName = reseller.name;
			result.resellerReference = reseller.reference;
			result.resellerRegistrationNumber = reseller.registrationNumber;
			resAddress = reseller.address;
		}
	} else if (helper.partnerFile) {
		result.resellerName = helper.partnerFile.companyName;
		result.resellerRegistrationNumber = helper.partnerFile.companyRegistration;
		resAddress = helper.partnerFile.address;
	}
	result.licenseType = "STANDARD";
	if (resAddress) {
		result.resellerAddress1 = resAddress.address1 || resAddress.adress1;
		result.resellerAddress2 = resAddress.address2 || resAddress.adress2;
		result.resellerCity = resAddress.city;
		result.resellerZip = resAddress.zip;
		result.resellerState = resAddress.state;
		result.resellerCountry = resAddress.country;
	}

	if (!policy) {
		return {
			$diagnoses: helper.addError(locale.format(module, "noPolicy"))
		};
	} else {
		if (!result.__oldPolicy && result.policyFile && result.policyFile.$uuid) {
			result.__oldPolicy = result.policyFile.$uuid;
		}
	}
	result.policyFile = {
		$uuid: policy
	};
	try {
		var policy = helper.fileTest(_, helper.POLICIES + "/" + policy + ".json", "Policy");
	} catch (e) {
		return {
			$diagnoses: helper.addError(e.message)
		};
	}
	result.productCode = policy.product.code;
	// result.productTitle = policy.product.title;
	result.productVersion = policy.product.version;
	result.policyCode = policy.policy.code;
	// result.policyTitle = policy.policy.title;
	result.policyVersion = policy.policy.version;
	result.exported = exported;

	["activityCodes", "languages", "legislations"].forEach(function(aspect) {
		var array = [];
		var activityCodes = [];
		if (policy[aspect]) {
			policy[aspect].forEach(function(item) {
				if (item.condition === "license") {
					var valStart;
					var valEnd;
					var lic; // is entry really licensed?
					if (license && license[aspect]) {
						lic = license[aspect].some(function(item2) {
							if (item.code === item2.code) {
								if (item2.validity) {
									valStart = item2.validity[0];
									valEnd = item2.validity[1];
								}
								return true;
							}
						});
					} else if (result[aspect]) {
						lic = result[aspect].some(function(item2) {
							if (item.code === item2.code) {
								valStart = item2.valStart;
								valEnd = item2.valEnd;
								return true;
							}
						});
					}
					array.push({
						$uuid: item.code,
						licensed: lic,
						code: item.code,
						title: item.title["en-US"],
						valStart: valStart,
						valEnd: valEnd,
					});
				}
			});
		}
		result[aspect] = array;
	});
	var badges = [];
	if (policy.badges) {
		policy.badges.forEach(function(item) {
			var valStart;
			var valEnd;
			var lic = false;
			var max = undefined;
			if (license) {
				lic = license.badges.some(function(item2) {
					if (item.code === item2.code) {
						max = item2.max;
						return true;
					}
				});
			} else if (result.badges) {
				lic = result.badges.some(function(item2) {
					if (item.code === item2.code) {
						max = item2.max;
						return true;
					}
				});
			}
			badges.push({
				$uuid: item.code,
				licensed: lic,
				code: item.code,
				title: item.title["en-US"],
				max: max
			});
		});
	}
	result.badges = badges;
	var parameters = [];
	if (policy.parameters) {
		policy.parameters.forEach(function(item) {
			var valStart;
			var valEnd;
			var lic = false;
			var value = undefined;
			if (license) {
				lic = license.parameters.some(function(item2) {
					if (item.code === item2.code) {
						value = item2.value;
						return true;
					}
				});
			} else if (result.parameters) {
				lic = result.parameters.some(function(item2) {
					if (item.code === item2.code) {
						value = item2.value;
						return true;
					}
				});
			}
			parameters.push({
				$uuid: item.code,
				licensed: lic,
				code: item.code,
				title: item.title["en-US"],
				value: value
			});
		});
	}
	result.parameters = parameters;
	return result;
}