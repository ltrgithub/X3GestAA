"use strict";
var helper = require('license-tool/lib/helper');
var fs = require('streamline-fs')
var util = require('util')


		module.exports = { 
				$title: "General",
				$modes: "create,display,extra*",
				$links: {
					$extra: {
						$title: "Download public key",
						$type: "application/x-document",
						$method: "GET",
						$url: "/downloads/publicKey"
					},
				},
				$properties: {
					partner: {
						$title: "Upload partner file",
						$type: "application/x-document",
						"$capabilities":"sort,filter",
						$url: "/data/general/$workingCopies/{$uuid}/partner?representation=files.$edit",
					},
					locales: {
						$title: "Standard locales",
						$type: "application/x-array",
						$item: {
							code: {
								$title: "Code",
								$type: "application/x-string", 
								$pattern: "^\\w\\w-\\w\\w$",
								$displayLength: 5,
								$isMandatory: true,
								$isUnique: true
							},
							title: {
								$title: "Description",
								$displayLength: 10,
								$type: "application/x-string"
							},
						}			
					},
				},
				$init: function(_, wc) {
					wc.publicKey = { "content-type": "text/plain", "content-length": helper.publicKey.length, "x-file-name": "a.ttt"};
					wc.locales = helper.cfg.locales.map(function(item) {
						return { $uuid: item.code, code: item.code, title: item.title}
					});
				},
				$load: function(_, key) {
					return { $uuid: key, locales: helper.cfg.locales.map(function(item) {
						return { $uuid: item.code, code: item.code, title: item.title}
					}) };
				},
				$save: function(_, wc, diagnoses) {
					// locales
					helper.updateLocales(wc.locales, diagnoses);
					if (wc.partner) {
						try {
							helper.setPartnerFile(wc.partner.toString("utf8"));
							fs.writeFile(helper.PARTNER_FILE, wc.partner, _);
						} catch (e) {
							diagnoses.push({severity: "error", message: "Problem with partner file: "+e})
						}
					}
				},
			}