var fs = require('fs');

function trim(s) {
	return s.replace(/^\s*/, '').replace(/\s*$/, '');
}

function clear(_, path) {
	try {
		var stat = fs.stat(path, _);
		if (stat.isDirectory()) {
			fs.readdir(path, _).forEach_(_, function(_, name) {
				clear(_, path + '/' + name);
			});
			fs.rmdir(path, _);
		} else {
			fs.unlink(path, _);
		}
	} catch (ex) {
		console.log(path + ": " + ex.message);
	}
}

function asciify(name) {
	return name.replace(/\W/g, function(ch) {
		switch (ch) {
		case 'à':
		case 'â':
			return 'a';
		case 'é':
		case 'è':
		case 'ê':
			return 'e';
		case 'ô':
			return 'o';
		case 'ù':
			return 'u';
		case 'ç':
			return 'c';
		default:
			return '-';
		}
	}).replace(/--+/g, '-');
}

function samToWiki(_, path) {
	var data = fs.readFile(path, "binary", _).split('\n').map(function(line) {
		return line.split('\t').map(function(val) {
			return trim(val[0] === '"' && val[val.length - 1] === '"' ? val.substring(1, val.length - 1) : val);
		})
	});
	// ["Team","","Expression","Number","Description","Phase no.","","Expression","Expression","Expression","Expected time","Actual time","Remaining time","\r"]
	//["YYSYB","  0.00","=\"\"","81806","Transfert compétence Setups Web Windows","   1","Transfert compétences Setups Web Windows","=\"\"","=\"\"","Transfert de compétence","  0.50","  0.50","  0.00","\r"]
	var root = __dirname + "/../../../syrawiki/SAM";
	clear(_, root);
	var teams = [];
	data.slice(1).forEach(function(line) {
		var tid = line[0],
			fid = line[3],
			sid = fid + '-' + line[5];
		if (!fid) return;
		var team = teams[tid] || (teams[tid] = {
			features: {}
		});
		var feature = team.features[fid] || (team.features[fid] = {
			stories: {}
		});
		var story = feature.stories[sid] || (feature.stories[sid] = {});
		feature.title = line[4];
		story.title = line[6];
		story.synopsis = line[7] === '=""' ? "TODO" : line[7];
	});
	fs.mkdir(root, _);
	Object.keys(teams).forEach_(_, function(_, t) {
		var team = teams[t];
		var ttext = '## Features\n\n' + Object.keys(team.features).map(function(f) {
			return '* ' + f + ': ' + team.features[f].title;
		}).join('\n');
		fs.writeFile(root + '/' + t + '.md', ttext, "utf8");
		Object.keys(team.features).forEach_(_, function(_, f) {
			var feature = team.features[f];
			var ftext = '## Stories\n\n' + Object.keys(feature.stories).map(function(s) {
				return '* ' + s + ': ' + feature.stories[s].title;
			}).join('\n');
			fs.writeFile(root + '/Feature-' + f + '-' + asciify(feature.title) + '.md', ftext, "utf8");
			Object.keys(feature.stories).forEach_(_, function(_, s) {
				var story = feature.stories[s];
				var stext = '## Synopsis\n\n' + story.synopsis;
				fs.writeFile(root + '/Story-' + s + '-' + asciify(story.title) + '.md', stext, "utf8");
			})
		});
	});
	//console.log(JSON.stringify(data[1]));
}

samToWiki(_, __dirname + '/csvs/YYSYWIKI.csv')