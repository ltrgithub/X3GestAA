"use strict"

var streams = require("streamline/lib/streams/streams");

exports.functionIndexName = "sage.x3.functions";
exports.fallbackLocale = "en-us";

exports.indexExists = function(_, baseUrl, indexName, options) {
	var opt = options || {};
	var par = {
			url: baseUrl + "/" + indexName,
			method: 'HEAD'
		};
	opt.tracer && opt.tracer("elasticIndex.index indexExists: url: " + par.url);
	var resp = streams.httpRequest(par).end().response(_);
	opt.tracer && opt.tracer("elasticIndex.index exists status: "+resp.statusCode);
	resp.readAll(_);
	return (resp.statusCode === 200);
}

exports.getIndexFacets = function(_, baseUrl, indexName, options) {
	var opt = options || {};
	var par = {
			url: baseUrl + "/" + indexName + "/$facet/_search?q=*",
			method: 'GET'
		};
	opt.tracer && opt.tracer("elasticIndex.index getIndexFacets: url: " + par.url);
	var resp = streams.httpRequest(par).end().response(_);
	opt.tracer && opt.tracer("elasticIndex.index getIndexFacets status: "+resp.statusCode);
	var content = resp.readAll(_);
	opt.tracer && opt.tracer("elasticIndex.index getIndexFacets content: "+content);
	if (resp.statusCode === 200) {
		content = JSON.parse(content);
		return ((content.hits && content.hits.hits) || []).map(function(h) {
			return h._source;
		});
	} else
		return [];
}