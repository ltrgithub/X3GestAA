"use strict";

var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var streams = require('streamline/lib/streams/streams');
var locale = require('syracuse-core/lib/locale');

// Installed version, Minimum compatible version and Recommended version
var installedVersion;
var minVersion = [0, 90, 8];
var recVersion = [0, 90, 12];

// Maximum version is not currently used, hence the setting
var maxVersion = [99, 99, 999];

function isRecVersion(instVer, recVers) {
	return (instVer[0] === recVers[0] && instVer[1] === recVers[1] && instVer[2] === recVers[2]);

}

function compatibleVersion(instVer, compVer, higher) {
	var isCompatible;

	if (higher) {
		isCompatible = !(instVer[0] < compVer[0] || instVer[1] < compVer[1] || instVer[2] < compVer[2]);
	} else {
		isCompatible = !(instVer[0] > compVer[0] || instVer[1] > compVer[1] || instVer[2] > compVer[2]);
	}

	// Check major/minor/increment in that order
	return isCompatible;
}

// Return the requested version (min, max, rec), primarily for configuration
// of the unit tests.

exports.getSupportedVersion = function(ver) {
	var retVer;
	switch (ver) {
		case "min":
			retVer = minVersion;
			break;
		case "max":
			retVer = maxVersion;
			break;
		default:
			retVer = recVersion;
			break;
	}

	return retVer;
};

exports.getElasticVersion = function(_, searchBaseUrl) {

	// Query the elastic search base URL to get the about information
	var options = {
		url: searchBaseUrl,
		method: "GET"
	};
	var req = streams.httpRequest(options);
	var about = JSON.parse(req.end().response(_).readAll(_));

	// Split the version into numbers for easy comparison
	installedVersion = about.version.number.split(".").map(function(v) {
		return +v;
	});

	return installedVersion;
};

/*S
 * return true if the version installed is the recommended version else false
 * throw an error when the version installed is not supported
 */
exports.checkVersion = function(_, searchBaseUrl, opts) {
	var instVersion = (opts && opts.version) || exports.getElasticVersion(_, searchBaseUrl);
	if (!compatibleVersion(instVersion, minVersion, true)) {
		throw new Error(locale.format(module, "incompatibleVersion", instVersion.join("."), minVersion.join("."), recVersion.join(".")));
	}

	if (!compatibleVersion(instVersion, maxVersion, false)) {
		throw new Error(locale.format(module, "newerVersion", instVersion.join("."), recVersion.join("."), minVersion.join("."), maxVersion.join(".")));
	}

	return isRecVersion(instVersion, recVersion);
};