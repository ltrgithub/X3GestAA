"use strict";
/* jshint -W079 */
/* jshint unused: false */
/* global QUnit: false, asyncTest: false, test: false, strictEqual: false, ok: false, start: false, stop: false */

/*global QUnit, start, ok*/
var helpers = require('syracuse-core/lib/helpers');
var streams = require("streamline/lib/streams/streams");
var sys = require("util");
var config = require('syracuse-main/lib/nodeconfig').config; // must be first syracuse require
var port = 3004;
var dataModel = require("syracuse-orm/lib/dataModel");
var elasticQuery = require("syracuse-search/lib/elasticQuery");
var adminHelper = require("syracuse-collaboration/lib/helpers").AdminHelper;

var elasticIndex = require("syracuse-search/lib/elasticIndex");
var IndexHelper = require("syracuse-search/lib/elasticIndex").IndexHelper;
var jsonImport = require("syracuse-import/lib/jsonImport");
var adminTestFixtures = require("syracuse-collaboration/test/fixtures/adminTestFixtures");
var mongodb = require('streamline-mongodb');
var testData = require('syracuse-sdata/test/fixtures/testDB');
var testEndPoint = testData.endpoint;
var searchEngine = require('syracuse-search/lib/elasticSearch');

var doStop = false;
QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});

asyncTest("test syracuse right filter  ", function(_) {
	var search = {
		query: {
			filtered: {}
		}
	};
	var syraRight = {
		"purgeCache": true,
		"$mode": "restriction",
		"$entities": {
			"typeTest": {
				"restriction": true
			}
		}
	};
	var prototypeUnitTest = {
		"http://localhost:9200/syracuse.collaboration.syracuse.en-us_entities/$entities/typeTest": {
			"teams": {
				$type: "application/x-reference"
			},
			"authors": {
				$type: "application/x-reference"
			},
			"author": {
				$type: "application/x-reference"
			},
			"administrator": {
				$type: "application/x-reference"
			},
			"members": {
				$type: "application/x-reference"
			},
			"Ateams": {
				$type: "application/x-array",
				$item: {
					$type: "application/x-reference"
				}
			}
		}
	};
	var baseUrlIndex = "http://localhost:9200/syracuse.collaboration.syracuse.en-us";

	// test syracuse filter generation on data
	syraRight.$entities.typeTest.condition = "author.$uuid eq test and toto.$uuid eq tst"; // test replace author in by  .$uuid $key;
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"query":{"field":{"author.$key":"test"}}},{"query":{"field":{"toto.$key":"tst"}}},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	search.query.filtered = {};
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "$uuid eq bla"; // test replace author in by $uuid _id;
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"query":{"field":{"_id":"bla"}}},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));


	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "$uuid eq bla and $uuid in (test)"; // test replace author in by $uuid _id;
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"query":{"field":{"_id":"bla"}}},{"terms":{"_id":["test"]}},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));


	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "author in (test,test2) and author in (toto) and author eq test"; // test replace author in by author.$key;
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"terms":{"author.$key":["test","test2"]}},{"terms":{"author.$key":["toto"]}},{"query":{"field":{"author":"test"}}},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));



	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "(teams eq null) or ((teams ne null) and (teams in (test1) or teams in (test2) or teams in (test3)))"; // test replace author in by author.$key
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"or":[{"missing":{"field":"teams"}},{"and":[{},{"or":[{"terms":{"teams.$key":["test1"]}},{"terms":{"teams.$key":["test2"]}},{"terms":{"teams.$key":["test3"]}}]}]}]},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));



	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "(administrator ne null and administrator.$uuid eq test1 or (authors ne null and authors in (test1) or (members ne null and members in (test1))))"; // test replace author in by author.$key
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"or":[{"and":[{},{"query":{"field":{"administrator.$key":"test1"}}}]},{"and":[{},{"terms":{"authors.$key":["test1"]}}]},{"and":[{},{"terms":{"members.$key":["test1"]}}]}]},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));


	// test with property using in  members.in
	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "(administrator ne null and administrator.$uuid eq test1 or (authors ne null and authors in (test1) or (members ne null and members.toto in (test1))))"; // test replace author in by author.$key
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"or":[{"and":[{},{"query":{"field":{"administrator.$key":"test1"}}}]},{"and":[{},{"terms":{"authors.$key":["test1"]}}]},{"and":[{},{"terms":{"members.toto":["test1"]}}]}]},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	// test with a property that is not a relation
	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "(administrator ne null and administrator.$uuid eq test1 or (authors ne null and authors in (test1) or (members ne null and userName in (test1))))"; // test replace author in by author.$key
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"or":[{"and":[{},{"query":{"field":{"administrator.$key":"test1"}}}]},{"and":[{},{"terms":{"authors.$key":["test1"]}}]},{"and":[{},{"terms":{"userName":["test1"]}}]}]},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	search.query.filtered = {};
	syraRight.$entities.typeTest.condition = "(administrator ne null and administrator.$uuid eq test1 or (authors ne null and authors in (test1) or (Ateams ne null and Ateams in (test1))))"; // test replace author in by author.$key
	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, false, prototypeUnitTest);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"and":[{"or":[{"and":[{},{"query":{"field":{"administrator.$key":"test1"}}}]},{"and":[{},{"terms":{"authors.$key":["test1"]}}]},{"and":[{},{"terms":{"Ateams.$key":["test1"]}}]}]},{"query":{"field":{"_type":"typeTest"}}}]}]}', "syracuse right filter ok : " + JSON.stringify(search.query.filtered.filter));
	search.query.filtered = {};

	elasticQuery.addSyracuseRightFilter(_, syraRight, search, baseUrlIndex, true, prototypeUnitTest);

	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"missing":{"field":"representationRef.entity"}},{"query":{"field":{"representationRef.entity":"typeTest"}}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	start();
});

asyncTest("test x3 right filter  ", function(_) {
	var search = {
		query: {
			filtered: {}
		}
	};
	var x3Right = {
		"$mode": "authorize",
		"purgeCache": true,
		"$accessCodes": {
			"AAAAAAA": true,
			"ACCPP2": true,
			"ADMIN": true,
			"ALL": true,
			"AQCACS1": true,
			"AQCACS2": true,
			"AUTO": true,
			"BBBBBBBB": true,
			"BOBSLEIGH": true,
			"BOPP": true,
			"BRETAGNE": true,
			"CCL": true,
			"CHANGE": true,
			"CHM": true,
			"CME": true,
			"CMX": true,
			"CNS": true,
			"CONSULT": true,
			"CONSULTEXE": true,
			"CONSULTMOD": true,
			"CP": true,
			"CPT": true,
			"CREDITCHEC": true,
			"CXX": true,
			"DEL": true,
			"DOM": true,
			"EEEEEEE": true,
			"EXE": true,
			"EXECUT": true,
			"EXENOT": true,
			"FG": true,
			"FOURN": true,
			"GB": true,
			"GB2": true,
			"GH": true,
			"GIET": true,
			"HUB": true,
			"JML": true,
			"LESAUTRES": true,
			"LIASSE": true,
			"LLC": true,
			"LOCK": true,
			"LUGE": true,
			"LV01": true,
			"MARGE": true,
			"MBT": true,
			"MLS": true,
			"MODIF": true,
			"MODIFEXE": true,
			"MSL": true,
			"MYOWNCODE": true,
			"NATURE": true,
			"NOACCES": true,
			"NOCHANGE": true,
			"NOEXE": true,
			"NONE": true,
			"OKMODIF": true,
			"PAR1": true,
			"PAR2": true,
			"PARB": true,
			"PARIS": true,
			"PASOKMODIF": true,
			"PESEUR1": true,
			"PESEUR2": true,
			"PP": true,
			"PP2": true,
			"PROACE": true,
			"SDR": true,
			"SKI": true,
			"SOPHIA": true,
			"SORDIV": true,
			"STA": true,
			"TBD": true,
			"TBORD": true,
			"TEST": true,
			"TOTO": true,
			"TTTT": true,
			"VELO": true,
			"XXX": true,
			"YYY": true,
			"ZCB": true,
			"ZELISA": true,
			"ZHB": true,
			"ZINC": true,
			"ZZCP": true,
			"ZZEB": true,
			"ZZERB": true,
			"ZZMB": true,
			"ZZMB1": true,
			"ZZMB2": true,
			"ZZMB3": true,
			"ZZMB4": true,
			"ZZZX": true,
			"ZZZZ": true
		}
	};



	var baseUrlIndex = "http://localhost:9200/x3.erp.sydev.en-us";

	// test with only accessCode
	elasticQuery.addX3RightFilter(_, x3Right, search, false);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"regexp":{"$access":"_all|aaaaaaa|accpp2|admin|all|aqcacs1|aqcacs2|auto|bbbbbbbb|bobsleigh|bopp|bretagne|ccl|change|chm|cme|cmx|cns|consult|consultexe|consultmod|cp|cpt|creditchec|cxx|del|dom|eeeeeee|exe|execut|exenot|fg|fourn|gb|gb2|gh|giet|hub|jml|lesautres|liasse|llc|lock|luge|lv01|marge|mbt|mls|modif|modifexe|msl|myowncode|nature|noacces|nochange|noexe|none|okmodif|par1|par2|parb|paris|pasokmodif|peseur1|peseur2|pp|pp2|proace|sdr|ski|sophia|sordiv|sta|tbd|tbord|test|toto|tttt|velo|xxx|yyy|zcb|zelisa|zhb|zinc|zzcp|zzeb|zzerb|zzmb|zzmb1|zzmb2|zzmb3|zzmb4|zzzx|zzzz"}}]}]}', "syracuse right filter : " + JSON.stringify(search.query.filtered.filter));

	// test with function authorized only
	x3Right = {
		$functions: {
			"*": true
		}
	};
	search.query.filtered = {};
	elasticQuery.addX3RightFilter(_, x3Right, search, true);
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"regexp":{"$access":"_all"}}]}]}', "x3right right filter : " + JSON.stringify(search.query.filtered.filter));

	x3Right = {
		$functions: {
			GESAUS: true,
			"666": true,
			NUMBEROFTHEBEAST: true,
			IRONMAIDEN: true
		}
	};
	search.query.filtered = {};
	elasticQuery.addX3RightFilter(_, x3Right, search, true);
	console.log(JSON.stringify(search.query.filtered.filter));
	strictEqual(JSON.stringify(search.query.filtered.filter), '{"and":[{"or":[{"regexp":{"$access":"_all|666|gesaus|numberofthebeast|ironmaiden"}}]}]}', "x3right right filter : " + JSON.stringify(search.query.filtered.filter));

	// access nothin
	x3Right = {
		$accessCodes: {}
	};
	search.query.filtered = {};
	elasticQuery.addX3RightFilter(_, x3Right, search, true);
	console.log(JSON.stringify(search.query.filtered.filter));
	strictEqual(JSON.stringify(search.query.filtered.filter), '', "x3right right filter : " + JSON.stringify(search.query.filtered.filter));


	start();
});