"use strict";

const glob = require('streamline/lib/globals');
const trace = null; //= console.log;

/* 
 * Line numbers
 */
// _sourceLoc and _sourceFile are set at 'require' time
// _sourceLoc is incremented as we load statements

var _sourceFile = null;
var _moduleName = null;
exports.sourceLoc = {
	module: _moduleName,
	line: 0,
	strict: false
};

exports.instructions = {
	C(x) {
		const fn = function c$do(_) {
			//console.log(x);
			return x;
		};

		fn.value = x;
		return fn;
	},
	A(items, forget) {
		return function a$do(_) {
			for (var i = 0; i < items.length; i++) {
				items[i] && items[i](_);
			}
		};
	},
	NIY(node) {
		const loc = exports.sourceLoc;

		return function niy$do(_) {
			const lint = glob.context.lint;
			//console.log("NIY ("+lint.update+"):",node);

			if (lint.update > 6 && node && node.tag && ["ACTZO", "ADDITM", "ADDMEN", "AFFZO", "ASKUI", "BOXACT", "BOXCLR", "BOXINP", "CALLIU", "CALLOCX", "CALLUI", "CHGFMT", "CHGSTL", "CHGTBK", "CHGTZN", "CHOOSE", "CLLDAP", "CLOSE", "DBGAFF", "DISABLE", "DISCOMBO", "DISLBOX", "DISZO", "DLGBOX", "EFFZO", "ENABLE", "ENDBOX", "ENVZO", "FIELD", "FLUSH", "FORMULA", "FUNCIU", "GENASMX", "GENWS", "GETUI", "GRIZO", "HLPBOX", "INFIMG", "INFTXT", "INSLI", "LISTIMP", "MASK", "MEN", "NAP", "ONEVENT", "ONKEY", "OPADXD", "OPLDAP", "OPSOCK", "QSTBOX", "REB", "REPORT", "REWRITEBYKEY", "RPTFILE", "RPTSTAT", "RUN", "SELBOX", "SELDEST", "SETFCT", "SETGUS", "SETINSTANCE", "SETLBOX", "SETMDU", "SETMODE", "SETMOK", "SRLDAPBS", "SRLDAPLV", "SUPLI", "SYRSEND", "SYSTEM", "TITCOL", "TITLED", "WRITEB", "WRNBOX"].indexOf(node.tag) >= 0) {
				lint.addDiagnose("obsolete", "NIY: " + node.tag, loc);
			}
		};
	},
	BEGIN(mod) {
		_sourceFile = mod.filename.replace(/\.js$/, ".src");
		_moduleName = mod.filename.replace(/[\/\/]([^\/\/]*).js$/, "$1");
	},
	NL(delta) {
		exports.sourceLoc = {
			file: _sourceFile,
			line: delta ? exports.sourceLoc.line + delta : 1,
			strict: exports.sourceLoc.strict
		};
		return null;
	}
};