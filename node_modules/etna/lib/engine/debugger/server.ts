import { _ } from 'streamline-runtime';
import * as sys from 'util';
import * as ez from 'ez-streams';
import { uuid } from 'syracuse-core';
const jsxml = require("js-xml");
import { config } from '../../util/nodeconfig';
import { DebugContext } from './context';

var server;


export function start(_: _) {
	var address = {
		port: ~ ~(config.etna.debug || {}).port
	};
	if (!server || server.closed) {
		server = ez.devices.net.server((c, _) => {
			console.error("New debugger connection: " + c.remoteAddress + ":" + c.remotePort);
			try {
				new DebugContext(c).listen(!_);
			} catch (ex) {
				console.error(ex.stack);
				throw ex;
			}
		}).listen(_, address.port);
		address = server.emitter.address();
		console.error("Etna debugger service running at port " + address.port);
	}
};

export function getPort(argument: void) {
	return address.port;
};