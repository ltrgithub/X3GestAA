"use strict";

const sys = require("util");
const ez = require('ez-streams');
const uuid = require('syracuse-core').uuid;
const jsxml = require("js-xml");
const config = require("etna/lib/util/nodeconfig").config.etna || {};
const DebugContext = require('./context').DebugContext;

var server;

var address = {
	port: ~ ~(config.debug || {}).port
};

exports.start = function (_) {
	if (!server || server.closed) {
		server = ez.devices.net.server((c, _) => {
			console.error("New debugger connection: " + c.remoteAddress + ":" + c.remotePort);
			try {
				new DebugContext(c).listen(!_);
			} catch (ex) {
				console.error(ex.stack);
				throw ex;
			}
		}).listen(_, address.port);
		address = server.emitter.address();
		console.error("Etna debugger service running at port " + address.port);
	}
};

exports.getPort = function _getPort(argument) {
	return address.port;
};