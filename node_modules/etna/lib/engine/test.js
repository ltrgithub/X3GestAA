"use strict";

const fs = require('fs');
const fsp = require("path");
const sys = require("util");

require("./register");

const Parser = require('./parser').Parser;
const generate = require('./jsgen').generate;

var io = 0,
    millis = 0,
    lines = 0;
var j = 0;
const t00 = Date.now();

for (var i = 2; i < process.argv.length; i++) {
	var name = process.argv[i];
	if (name == "W1ZAUTZBY.src" || name === "TRTFASTRF.src" // bad break!
	 || name.indexOf("WJWML") == 0 || name.indexOf("WML") == 0 //
	 || name.indexOf("WMREP") == 0 || name.indexOf("WMNEZ") == 0 //
	 || name.indexOf("WMSECRAN") == 0 || name.indexOf("WWE") == 0 //
	 || name.indexOf("WWI") == 0 || name.indexOf("ZACREVIG") == 0 || name.indexOf("Z") == 0) continue;

	var fname = fsp.resolve(name);
	console.error("PARSING " + ++j + " " + fname + " ...");
	var t0 = Date.now();
	var source = fs.readFileSync(fname, "utf8");
	io += Date.now() - t0;
	var result = new Parser(source, fname).parse();
	// console.log(sys.inspect(result.node, {depth:10}));
	var js = generate(result.node);
	var jsname = fname.replace(".src", ".js");

	//console.log("writing " + jsname)
	fs.writeFileSync(jsname, js, "utf8");
	millis += result.millis;
	lines += result.lines;
	//console.log("RESULT=" + node);
}

console.log(lines + " lines processed in " + millis + " ms: " + Math.round(1000 * lines / millis) + " lines/s");
millis = Date.now() - t00; // use overall time now!
console.log(lines + " lines processed in " + millis + " ms: " + Math.round(1000 * lines / millis) + " lines/s");
//console.log("io=" + io + " ms");
false && require("../test/dummy").Factorials(function (err, result) {
	console.log("DONE: " + result);
});
false && require("../test/testFlows").MAIN(function (err, result) {
	console.log("DONE: " + result);
});