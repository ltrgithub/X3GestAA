import * as types from './types';
const glob = require('streamline/lib/globals');
import { X3Error } from './errors';
import * as util from './util';
import * as tbcd from './tbcd';
import * as tdate from './tdate';
import * as tdatetime from './tdatetime';
import * as tdouble from './tdouble';
import * as tuuid from './tuuid';
import { Blbfile } from './tblbfile';
import { Clbfile } from './tclbfile';
const tracerJs = require('syracuse-core').getTracer("etna.engine");
const RE_NUMBER = /^([+-]?\d+(\.\d*)?([eE][+-]?\d+)?)$/;
const RE_ZERO = /^[\s.0]*$/;
const RE_INTEGER = /^[\s\d]*$/;
const RE_DATETIME = /^\d{4}-(?:1[0-2]|0\d{1})-\d{2}T\d{2}\:\d{2}\:\d{2}\.\d{3}Z$/;

Object.defineProperty(String.prototype, "x3ToString", {
	value() {
		return this;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToDouble", {
	value() {
		return new tdouble.Double(this);
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToBCD", {
	value() {
		return tbcd.fromString(this);
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToInteger", {
	value() {
		const s = this.replace(/ /g, "");

		if (s[0] === ".") return 0;
		if (s.length === 0) return 0;
		//return parseInt(s);
		if (RE_INTEGER.exec(s)) {
			// Is it a null string for integer ?
			if (RE_ZERO.exec(s)) return 0;
			return parseInt(s);
		}
		throw new X3Error(10, "");
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Val", {
	value(): any {
		// Is it an integer ? (has to be the first)
		if (RE_INTEGER.exec(this)) {
			// Is it a null string for integer ?
			if (RE_ZERO.exec(this)) return 0;
			return parseInt(this);
		}
		// Is it a null string ?
		if (RE_ZERO.exec(this)) return 0.0;
		// Is it a date time
		if (RE_DATETIME.exec(this)) return new tdouble.Double(tdatetime.x3Parse(this).value);

		// is it a decimal ?
		const r = tbcd.fromString(this);

		if (r.x3IsZero() && RE_NUMBER.exec(this) === null) throw util.badOperand(this);

		return r.isInt32(1) ? r.x3ToInteger() : r;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3IsEmpty", {
	value() {
		return this.length === 0 ? true : false;
	},
	enumerable: false
});

String.prototype.x3IsZero = String.prototype.x3IsEmpty;
String.prototype.x3IsUndefined = String.prototype.x3IsEmpty;

Object.defineProperty(String.prototype, "x3Length", {
	value() {
		return this.length;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToDate", {
	value() {
		if (/^\d{8}$/.test(this)) return tdate.parse(this, "yyyyMMdd");
		if (/^\d{4}-\d{2}-\d{2}$/.test(this)) return tdate.parse(this, "yyyy-MM-dd"); // Format used by the client
		if (/^\d{6}$/.test(this)) {
			console.log("x3ToDate:" + this);

			var date = tdate.parse(this, "yyMMdd");
			var frame = glob.context.x3frame;
			if ((date as any).x3Year < frame.context.sys.values.ADXDCS) {
				date = date.addYears(100);
			}
			return date;
		}
		if (!this.length) return tdate.NULL;
		throw new X3Error(10, "");
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToUuid", {
	value() {
		try {
			return tuuid.x3ToUuid(this);
		} catch (e) {
			throw new X3Error(50, "");
		}
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToDatetime", {
	value() {
		try {
			return tdatetime.x3Parse(this);
		} catch (e) {
			throw new X3Error(50, "");
		}
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToClbfile", {
	value() {
		return new Clbfile(this);
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Compare", {
	value(b: any) {
		if (util.x3IsString(b)) {
			if (this === b) return 0;
			else if (this < b) return -1;
			else return 1;
		} else if (util.x3IsClbfile(b)) {
			return this.x3Compare(b.value);
		} else if (util.x3IsDate(b)) {
			return 1;
		} else {
			console.error("------------------tstring.x3Compare '" + this + "' badOperand:" + JSON.stringify(b));
			//tracerJs.error && tracerJs.error("tstring.x3Compare '" + this + "' badOperand:" + JSON.stringify(b));
			throw util.badOperand(b);
		}
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Add", {
	value(b: any) {
		if (util.x3IsString(b)) {
			return this + b;
		} else if (util.x3IsClbfile(b)) {
			return this + b.value;
		} else if (util.x3IsDate(b)) {
			return this + b.x3ToString();
		} else {
			throw util.badOperand(b);
		}
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3IsNumeric", {
	value() {
		return false;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Minus", {
	value() {
		return " " + this;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Sub", {
	value(b: any) {
		if (util.x3IsString(b)) {
			return util.x3Trim(this, 1) + " " + util.x3Trim(b, 0);
		} else if (util.x3IsClbfile(b)) {
			return util.x3Trim(this, 1) + " " + util.x3Trim(b.value, 0);
		} else if (util.x3IsDate(b)) {
			return util.x3Trim(this, 1) + " " + util.x3Trim(b.x3ToString(), 0);
		} else {
			throw util.badOperand(b);
		}
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3ToSql", {
	value() {
		return this === "" ? " " : this;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Serialize", {
	value(len: number) {
		const b0 = new Buffer(this, "ucs2");
		const b1 = new Buffer(len);

		var i = 0;

		if (len > 512) {
			// clob case, write lng on header
			b1.writeUInt32BE(b0.length, 0);
			while (i < b1.length - 4) {
				if (i < b0.length) b1.writeUInt16BE(b0.readUInt16LE(i), i + 4);
				else break;
				i += 2;
			}
			b1.fill(0, i + 4);
		} else {
			// string case
			if (b1.length < b0.length + 2) throw new X3Error(26, "Inconsistant length in BE conversion");

			// to BE and trailling 0
			while (i < b1.length) {
				if (i < b0.length) b1.writeUInt16BE(b0.readUInt16LE(i), i);
				else break;
				i += 2;
			}
			b1.fill(0, i);
		}
		return b1;
	},
	enumerable: false
});

Object.defineProperty(String.prototype, "x3Type", {
	value() {
		return 265;
	},
	enumerable: false
});