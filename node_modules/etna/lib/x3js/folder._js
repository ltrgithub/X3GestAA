"use strict";
// internal

(function() {
	if (typeof Proxy === 'undefined') {
		console.warn("!!! Proxy undefined -- JS API NOT AVAILABLE !!!");
		exports.create = function(_, supervisor) { return null; };
		return;
	}
	require('harmony-reflect'); // to get ES6 Proxy API
	const glob = require('streamline-runtime').globals;
	const ez = require('ez-streams');
	const ezmongo = require('ez-mongodb');
	const fs = require('fs');
	const fsp = require('path');
	const config = require('config');
	const constants = require('etna/lib/supervisor/constants');
	const util = require('etna/lib/supervisor/util');

	const sysProps = {
		CREDATTIM: 'create stamp',
		UPDDATTIM: 'update stamp',
		CREUSR: 'create user',
		UPDUSR: 'update user',
		AUUID: 'uuid',
	}
	function fixNames(_, supervisor, colnName, codeProp, titleProp, capitalize, relations) {
		const coln = supervisor.mongoStore.collection(colnName, _);

		ezmongo.reader(coln.find({
			_proxyName: {
				$exists: false
			}
		})).map(function(_, elt) {
			//console.error('FIXING NAMES: ' + elt[codeProp]);
			const title = supervisor.loadText(_, elt[titleProp], "ENG") || elt[codeProp];
			var name = util.camelize(title, capitalize);
			const existing = ezmongo.reader(coln.find({
				_proxyName: name,
			})).toArray(_)[0];
			if (existing) {
				console.error("DUPLICATE PROXY NAME: " + name + ": " + existing[codeProp] + " and " + elt[codeProp]);
				name = util.camelize(elt[codeProp], capitalize);
			}
			console.error("PROXY NAME: " + colnName + "/" + elt[codeProp] + ": " + name);
			elt._proxyName = name;
			var subNames = {}; // same namespace for properties and collections!
			relations.forEach_(_, function(_, rel) {
				if (!elt[rel.name]) return;
				//console.error("RELATION", rel.name, elt[rel.name]);
				elt[rel.name].forEach_(_, function(_, sub) {
					var subTitle = sysProps[sub[rel.code]];
					subTitle = subTitle || supervisor.loadText(_, sub[rel.title], "ENG");
					if (!subTitle || /^TEXT_/.test(subTitle)) subTitle = sub[rel.code];
					var subName = util.camelize(subTitle);
					if (!subName) subName = util.camelize(sub[rel.code]); // in case no letters in subTitle
					if (subNames[subName]) {
						console.error("DUPLICATE PROPERTY NAME: " + subName + ": " + subNames[subName] + " and " + sub[rel.code]);
						subName = util.camelize(sub[rel.code]);
					} else {
						subNames[subName] = sub[rel.code];
					}
					sub._proxyName = subName;
				});
			});
			return elt;
		}).pipe(_, ezmongo.writer(coln, {
			upsert: true
		}));
	}

	class SaveError extends Error {
		constructor(message, errors) {
			super(message);
			this.errors = errors;
		}
	}

	function checkContext(supervisor) {
		if (glob.context.x3frame.context.superv !== supervisor) throw new Error("internal error: supervisor mismatch");		
	}
	class Folder {
		constructor(supervisor) {
			this.supervisor = supervisor;
		}		
		init(_) {
			fixNames(_, this.supervisor, "ACLASSE", "CODCLA", "INTCLA", true, [{
				name: "PROPERTIES",
				code: "FLDCLA",
				title: "INTFLD",
			}, {
				name: "COLLECTIONS",
				code: "CODCOL",
				title: "INTCOL",
			}]);
			return this;
		}
	}

	exports.create = function(_, supervisor) {
		return new Folder(supervisor).init(_);
	};

	exports.jsInvoke = require('./js-invoke');
})();