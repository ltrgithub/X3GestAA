"use strict";

require('harmony-reflect'); // to get ES6 Proxy API
const instanceProxy = require('./instanceProxy');
const QueryReader = require('./queryReader').QueryReader;

class ClassWrapper {
	constructor(clas) {
		this.class = clas;
	}
	$create(_, values) {
		const instance = this.class.supervisor.new(_, 'Instance', this.class).afterCreate(_);
		const proxy = instanceProxy.create(instance);
		Object.keys(values).forEach_(_, function(_, name) {
			proxy[name](_, values[name]);
		});
		return proxy;
	}
	$query() {
		if (arguments.length > 0) throw new Error("query: bad arg count");
		return new QueryReader(this.class);
	}
	$read(_, key) {
		return instanceProxy.create(this.class.readInstance(_, null, key));
	}
}

class ClassesHandler {
	constructor(supervisor) {
		this.supervisor = supervisor;
		this.getters = {};
	}
	get(name) {
		return this.getters[name] || { get : (_) => {
			var filter = /^[A-Z_]*$/.test(name) ? {
				CODCLA: name
			} : {
				_proxyName: name
			};
			const clas = this.supervisor.mongoStore.collection("ACLASSE", _).find(filter).toArray(_)[0];
			if (!clas) throw new Error("class not found: " + name);
			const wrapper = new ClassWrapper(this.supervisor.load(_, 'Class', clas.CODCLA));
			// create fast getter
			const getter = this.getters[name] = { get: (_) => wrapper };
			return wrapper;
		}};
	}
}

exports.create = function(supervisor) {
	return Proxy(supervisor, {
		get: function(supervisor, name) {
			//console.error("PROXY GET", name);
			supervisor.classesHandler = supervisor.classesHandler || new ClassesHandler(supervisor);
			return supervisor.classesHandler.get(name);
		},
	});
}
