"use strict";

var util = require("etna/lib/supervisor/util");
var constants = require("etna/lib/supervisor/constants");
var btime = require('syracuse-core').types.datetime;
var traceSup = require('syracuse-core').getTracer("etna.supervisor");

var errorcounter = 0;

var enumSeverity = {
	0: "success",
	1: "success",
	2: "info",
	3: "warning",
	4: "error"
};

exports.severity = function(code) {
	var e = new Error("debug");
	return (enumSeverity[code] || code);
};

exports.trace = function(code, message) {
	var severity = exports.severity(code);
	var toLog = function(severity, message) {
		return severity + " :'" + message + "'";
	};
	switch (severity) {
		case "error":
			traceSup.error && traceSup.error(toLog(severity, message));
			break;
		case "info":
		case "warning":
			traceSup.info && traceSup.info(toLog(severity, message));
			break;
		case "success":
			traceSup.debug && traceSup.debug(toLog(severity, message));
			break;
		default:
			break;
	}
};

exports.constructor = util.defineClass(function(superv, severity, message, stackTrace, category) {
	// basic property
	this.$exported = true;
	this.supervisor = superv;
	this.severity = severity;
	this.message = message;
	this.stackTrace = stackTrace;
	this.category = category || 0;
	this.counter = errorcounter++;
	// assign in cloning
	this.environment = "";
	this.copy = 0;

	// asssign in getDiagnoses
	this.label = "";
	this.PRO = "";

}, null, {
	init: function(_) {
		return this;
	},
	dataNode: function() {
		return {
			$severity: exports.severity(this.severity),
			$message: this.message,
			$stackTrace: this.stackTrace,
		};
	},
	get: function(_, name) {
		switch (name) {
			case 'DEL':
				return 1; // 1 stands for CST_ANO
			case 'MES':
				return this.message;
			case 'PRO':
				return this.PRO;
			case 'STA':
				return this.severity;
			case 'LAB':
				return this.label;
			case 'CAT':
				return this.category;
			case 'CPY':
				return this.copy;
			case 'ENV':
				return this.environment;
		}
	},

	set: function(_, name, value) {
		switch (name) {
			case 'DEL':
				return 1; // 1 stands for CST_ANO
			case 'MES':
				return this.message = value;
			case 'PRO':
				return this.PRO = value;
			case 'STA':
				return this.severity = value;
			case 'LAB':
				return this.label = value;
			case 'CAT':
				return this.category = value;
			case 'CPY':
				return this.copy = value;
			case 'ENV':
				return this.environment = value;
		}
	},
	x3Compare: function(b) {
		return this === b;
	},

	sortOnTime: function(d) {
		return this.counter - d.counter;
	},
	sortOnSeverity: function(d) {
		return d.severity - this.severity;
	},
	clone: function(_, env) {
		var cpy = this.supervisor.new(_, 'Diagnosis', this.severity, this.message, this.stackTrace, this.category);
		cpy.label = this.label;
		cpy.counter = this.counter;
		cpy.PRO = this.PRO;
		if (env !== undefined) {
			cpy.copy = 1;
			cpy.environment = env;
		} else {
			cpy.copy = this.copy;
			cpy.environment = this.environment;
		}
		return cpy;
	}

});