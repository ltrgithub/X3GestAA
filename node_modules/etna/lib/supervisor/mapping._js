"use strict";
var glob = require('streamline/lib/globals');
var util = require("etna/lib/supervisor/util");

var tracerJs = require('syracuse-core').getTracer("etna.supervisor");


exports.getIndex = function(_, superv, mappingData) {
	tracerJs.debug && tracerJs.debug("mappingData.TABLNK " + mappingData.TABLNK);
	var childTable = superv.load(_, 'Table', mappingData.TABLNK);
	return mappingData.CLELNK ?
		util.find(childTable.indexes, 'name', mappingData.CLELNK) :
		childTable.indexes[0];
};

exports.getKeys = function(_, mappingData, record) {
	var keys = mappingData.EXPLNK.split(';').map_(_,function(_,exp) {
		// for now ignore [F:XXX] part - see later
		var lexp = exp.toUpperCase();
		if (exp.indexOf(']') > 0) {
			var p = exp.substring(exp.indexOf(']') + 1);
			return record[p];
		} else if (lexp.substring(0,6) === "GACTX.") {
			return glob.context.x3session.actx.get(_, lexp.substring(6));
		} else {
			return (record[exp] !== undefined) ? record[exp] : exp;
		}
	});
	tracerJs.debug && tracerJs.debug("relation keys " + JSON.stringify(keys));
	return keys;
};