"use strict";

const ez = require("ez-streams");
const etnaServer = require("etna/lib/supervisor/server");
const tracerJs = require('syracuse-core').getTracer("etna.supervisor");

class Client {
	constructor(session, endpoint) {
		this.endpoint = endpoint;
		this.session = session;
	}

	getSessionServiceLink(_, link) {
		const config = this.endpoint.getEtnaConfig(_, this.session);

		switch (link) {
			case "$rights":
				return {
					$url: "/sdata/x3/erp/" + this.endpoint.dataset(_) + "/ARIGHTS('" + config.session.userName + "')/$services/$rights"
				};
		}
		return null;
	}
	jsonSend(_, options) {
		const config = this.endpoint.getEtnaConfig(_, this.session);
		const request = {
			url: options.head.url,
			session: config.session,
			_request: {},
			method: options.method || "GET",
			readAll: function(payload) {
				return function (_) {
					return payload;
				};
			}(options.payload || "")
		};

		request._request.headers = Object.keys(options.head).reduce((r, p) => {
			r[p] = options.head[p];
			return r;
		}, {});

		const resp = {};
		const response = {
			writeHead(status, head) {
				tracerJs.debug && tracerJs.debug("STUB writeHead");
				resp.head = head;
				resp.head.status = status;
			},
			end(body, options) {
				tracerJs.debug && tracerJs.debug("STUB end");
				if (body.indexOf("{") === 0) resp.body = JSON.parse(body);
				else resp.body = body;
			}
		};

		etnaServer.httpDispatch(_, config, request, response);
		//console.log("JSONSEND resp:"+JSON.stringify(resp));
		return resp;
	}
	createBulkReader(_, params) {
		//dbg:console.log("etna.createBulkReader:"+JSON.stringify(params));

		const config = this.endpoint.getEtnaConfig(_, this.session);
		const request = {
			url: params.url,
			session: config.session,
			_request: {
				headers: {
					method: "GET"
				}
			}
		};

		var queue;
		const response = {
			writeHead(status, head) {},
			write(_, body, options) {
				const start = body.indexOf("{");

				if (start >= 0 && body[body.length - 1] === '}') {
					//dbg:console.log("bulk.data:"+body.substring(start));
					queue.write(_, JSON.parse(body.substring(start)));
				}
			},
			end(body, options) {
				//dbg:console.log("bulk.end");
				queue.write(function (err) {
					if (err) throw err;
				}, undefined);
			}
		};

		return {
			next(_) {
				if (!queue) {
					queue = ez.devices.queue({});
					setTimeout(function () {
						etnaServer.httpDispatch(function (err, data) {}, config, request, response);
					}, 1);
				}
				return queue.read(_);
			}
		};
	}
	disconnect(_) {}
};

exports.getClient = function (_, session, endpoint) {
	return new Client(session, endpoint);
};