"use strict";

var ez = require("ez-streams");

var helpers = require('syracuse-core').helpers;
var etnaServer = require("etna/lib/supervisor/server");
var tracerJs = require('syracuse-core').getTracer("etna.supervisor");

var Client = helpers.defineClass(function(session, endpoint) {
	this.endpoint = endpoint;
	this.session = session;
}, null, {
	getSessionServiceLink: function(_, link) {
		var config = this.endpoint.getEtnaConfig(_, this.session);

		switch (link) {
			case "$rights":
				return {
					$url: "/sdata/x3/erp/" + this.endpoint.dataset(_) + "/ARIGHTS('" + config.session.userName + "')/$services/$rights"
				};
		}
		console.error("GETSESSIONSERVICELINK link: " + link);
		return null;
	},
	jsonSend: function(_, options) {
		var config = this.endpoint.getEtnaConfig(_, this.session);
		var request = {
			url: options.head.url,
			session: config.session,
			_request: {},
			method: options.method || "GET",
			readAll: function(payload) {
				return function(_) {
					return payload;
				};
			}(options.payload || "")
		};

		request._request.headers = Object.keys(options.head).reduce(function(r, p) {
			r[p] = options.head[p];
			return r;
		}, {});

		var resp = {};
		var response = {
			writeHead: function(status, head) {
				tracerJs.debug && tracerJs.debug("STUB writeHead");
				resp.head = head;
				resp.head.status = status;
			},
			end: function(body, options) {
				tracerJs.debug && tracerJs.debug("STUB end");
				if (body.indexOf("{") === 0) resp.body = JSON.parse(body);
				else resp.body = body;
			}
		};

		etnaServer.httpDispatch(_, config, request, response);
		//console.log("JSONSEND resp:"+JSON.stringify(resp));
		return resp;
	},
	createBulkReader: function(_, params) {
		//dbg:console.log("etna.createBulkReader:"+JSON.stringify(params));

		var config = this.endpoint.getEtnaConfig(_, this.session);
		var request = {
			url: params.url,
			session: config.session,
			_request: {
				headers: {
					method: "GET"
				}
			}
		};

		var queue;
		var response = {
			writeHead: function(status, head) {},
			write: function(_, body, options) {
				var start = body.indexOf("{");
				if (start >= 0 && body[body.length - 1] === '}') {
					//dbg:console.log("bulk.data:"+body.substring(start));
					queue.write(_, JSON.parse(body.substring(start)));
				}
			},
			end: function(body, options) {
				//dbg:console.log("bulk.end");
				queue.write(_ >> function(err) {
					if (err) throw err;
				}, undefined);
			}
		};


		return {
			next: function(_) {
				if (!queue) {
					queue = ez.devices.queue({});
					setTimeout(function() {
						etnaServer.httpDispatch(_ >> function(err, data) {}, config, request, response);
					}, 1);
				}
				return queue.read(_);
			}
		};
	},
	disconnect: function(_) {
		
	}
});

exports.getClient = function(_, session, endpoint) {
	return new Client(session, endpoint);
};