"use strict";
var db = require("etna/lib/engine/runtime/db");
var glob = require('streamline/lib/globals');

var tracerJs = require('syracuse-core').getTracer("etna.dbms");

var beginTransaction = db.instructions.TRBEGIN();
var commitTransaction = db.instructions.COMMIT();
var rollbackTransaction = db.instructions.ROLLBACK();

class Transaction{
	constructor() {
		this.inProgress = false;
	}
	begin(_) {
		var frame = glob.context.x3frame;
		if (frame.context.sys.values.ADXLOG === 0) {
			beginTransaction(_);
			tracerJs.debug && tracerJs.debug("begin Transaction");
			this.inProgress = true;
		} else {
			this.inProgress = false;
		}
	}
	commit(_) {
		if (this.inProgress) {
			commitTransaction(_);
			tracerJs.debug && tracerJs.debug("commit Transaction");
			this.inProgress = false;
		}
	}
	rollback(_) {
		if (this.inProgress) {
			rollbackTransaction(_);
			tracerJs.debug && tracerJs.debug("rollback Transaction");
			this.inProgress = false;
		}
	}
};

exports.Transaction = Transaction; 