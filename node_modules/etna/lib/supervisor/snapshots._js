"use strict";
var X3Error = require("etna/lib/engine/runtime/errors").X3Error;
var attributes = require("etna/lib/supervisor/attributes");

var snapshots = ["Snapshot", "Syssnapshot"];

function addSnapshots(_prototype) {

	snapshots.forEach(function(snapshot) {
		var lsnapshot = snapshot.toLowerCase();

		var property = "$" + lsnapshot;
		var attEnable = "$is" + snapshot + "Enabled";

		_prototype["enable" + snapshot] = function() {
			this.setIntAttribute(attEnable, true);
			//dbg:console.error("dbg enable "+snapshot+" on "+this.$$type +" "+attEnable+"="+ this.getIntAttribute(attEnable));
		};

		_prototype["revertTo" + snapshot] = function() {
			this.setIntAttribute(attEnable, false);
			var from = this[property];
			var to = from.revertTo();
			// release the snapshot : 
			to[property] = undefined;
		};

		_prototype["disable" + snapshot] = function() {
			this.setIntAttribute(attEnable, false);
			//dbg:console.error("dbg snapshot "+  attEnable + ":"+ this.getIntAttribute(attEnable));

			// Release the "$snapshot" property
			this[property] = undefined;

			// propagate disable to children : 
			var _this = this;
			var children = _this.getChildren();

			Object.keys(children).forEach(function(child) {
				if (children[child]["disable" + snapshot]) children[child]["disable" + snapshot]();
			});
		};

		_prototype[lsnapshot] = function() {
			// var e = new Error("dummy");
			// //dbg:console.error("dbg called from "+ e.stack);//.split("\\n")[2]);

			// ! attEnable is a inherited attribute : getIntAttribute should walk through parents to the top 
			var enabled = this.getIntAttribute(attEnable);
			//dbg:console.error("dbg "+lsnapshot+" on "+this.$$type +" " +attEnable+"="+enabled);
			if (!enabled) return null;

			// TODO see later
			if (this.snapshotof) {
				// Cannot create a snapshot of a snapshot :
				throw new X3Error(155, "");
			}

			if (this.getIntAttribute(attEnable)) {
				//dbg:console.error("dbg "+lsnapshot+" property:"+property+"="+!!this[property]);

				if (!this[property]) {
					// Let's create the snapshot by cloning 'this'
					//dbg:console.error("snapshot "+lsnapshot+" create");
					var clone = this.clone();
					clone.snapshotof = this;

					//dbg:console.error("snapshot set "+property+ " with clone");
					this[property] = clone;
					if (this.$parent) {
						//dbg:console.error("snapshot "+lsnapshot+" create->parent");

						// Set the parent of the snapshot :
						// this.parent[snapshot]() create the parent's snapshot if necessary !
						var parent = this.$parent[lsnapshot]();
						clone.$parent = parent;
						// update parent with the newly created snapshot :
						(parent) && parent.updateProperty(this, clone);
					}
					clone.$_isReadOnly = true;
				} else {
					//dbg:console.error("dbg "+lsnapshot+" property:"+property+" undefined");
				}
			}
			// Return the snapshot :
			//dbg:console.error("snapshot  < snapshot")
			return this[property];
		};
	});

	// Add a function 'snapshots' to the prototype :
	_prototype.snapshots = function() {
		var _this = this;
		//dbg:console.error("snapshot  snapshot.snapshots");
		snapshots.forEach(function(snapshot) {
			_this[snapshot.toLowerCase()]();
		});
	};

	// Add a function 'releaseSnapshot' to the prototype :
	_prototype.releaseSnapshot = function(instance) {
		var _this = this;
		//dbg:console.error("snapshot  snapshot.snapshots");
		snapshots.some(function(snapshot) {
			var property = "$" + snapshot.toLowerCase();
			if (_this[property] == instance) {
				_this[property] = undefined;
				return true;
			}
			return false;
		});
	};

}

exports.addSnapshots = addSnapshots;
exports.getIntAttributes = addSnapshots;