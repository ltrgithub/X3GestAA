"use strict";

const db = require("etna/lib/engine/runtime/db");
const glob = require('streamline/lib/globals');
const tracerJs = require('syracuse-core').getTracer("etna.dbms");
const beginTransaction = db.instructions.TRBEGIN();
const commitTransaction = db.instructions.COMMIT();
const rollbackTransaction = db.instructions.ROLLBACK();

class Transaction {
	constructor() {
		this.inProgress = false;
	}
	begin(_) {
		const frame = glob.context.x3frame;

		if (frame.context.sys.values.ADXLOG === 0) {
			beginTransaction(_);
			tracerJs.debug && tracerJs.debug("begin Transaction");
			this.inProgress = true;
		} else {
			this.inProgress = false;
		}
	}
	commit(_) {
		if (this.inProgress) {
			commitTransaction(_);
			tracerJs.debug && tracerJs.debug("commit Transaction");
			this.inProgress = false;
		}
	}
	rollback(_) {
		if (this.inProgress) {
			rollbackTransaction(_);
			tracerJs.debug && tracerJs.debug("rollback Transaction");
			this.inProgress = false;
		}
	}
};

exports.Transaction = Transaction;