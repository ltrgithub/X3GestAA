"use strict";
const JsContext = require('./jsContext').JsContext;
const camelCache = {}

function camelify(name) {
	return camelCache[name] || (camelCache[name] = name.split('_').map(function(s, i) {
		return i === 0 ? s.toLowerCase() : s[0] + s.substring(1).toLowerCase();
	}).join(''));
}

var instanceProxy;

module.exports = function(_, mod, label, args) {
	instanceProxy = instanceProxy || require('./instanceProxy');
	const fns = mod.body[label];
	if (!fns) return 0;
	const member = args.path.length > 0 
		? args.path.reduce((r, p) => r && r[label] && r[label][p], mod.body) 
		: mod.body[label];
	if (!member) return 0;
	const action = label === 'properties' ? args.ARULE.value : args.AEVENT.value.substring(1);
	const fn = member[camelify(action)];
	if (!fn) return 0;
	const proxy = instanceProxy(args.THIS.value);
	//console.error("INVOKEJS", label, args.path, action);
	const arg1 = /^(CONTROL|PROPAGATE)$/.test(action) 
		? args.path.reduce_(_, (_, r, p) => r && r[p](_), proxy) 
		: undefined;
	try {
		fn.call(proxy, _, new JsContext(args), arg1);
		return 0; // ASTATUS OK
	} catch (ex) {
		console.error(ex.stack);
		return 4; // ASTATUS ERROR - see later
	}
}

