"use strict";

require('harmony-reflect'); // to get ES6 Proxy API
const glob = require('streamline-runtime').globals;
const instanceProxy = require('./instanceProxy');
const datetime = require('syracuse-core').types.datetime;

class TableWrapper {
	constructor(table) {
		this.table = table;
	}
	clear(_) {
		return this.table.clear(_);
	}
	insertRecord(_, values) {
		const actx = glob.context.x3session.actx;
		const user = actx.$USER(_);
		values.CREDATTIM = values.CREDATTIM || datetime.now();
		values.CREUSR = values.CREUSR || user;
		values.UPDUSR = user;
		values.UPDDATTIM = datetime.now();
		return this.table.insertRecord(_, values);
	}
	/// `table.readRecord(_, key)`: reads a record.  
	/// `key` may be:
	/// 
	/// * a single value (simple primary key)
	/// * an array (composite primary key)
	/// * a JS object which will give the column names and their values.
	readRecord(_, key, opts) {
		if (key == null) throw new Error("null key!");
		opts = Object.assign({
			// limit: 1,
		}, opts || {});
		var reader;
		if (Array.isArray(key)) {
			reader = this.table.reader(_, this.table.indexes[0], key, null, null, opts);
		} else if (typeof key !== 'object') {
			reader = this.table.reader(_, this.table.indexes[0], [key], null, null, opts);			
		} else {
			reader = this.table.reader(_, null, key, null, null, opts);
		}
		var rec = reader.read(_);
		if (rec) {
			reader.stop(_);
			// convert to X3 types
			Object.keys(rec).forEach_(_, (_, name) => {
				console.error(name, !!this.table.columns[name]);
				rec[name] = this.table.columns[name].type.fromSql(_, rec[name]);
			});
		}
		else if ('notFound' in opts) return opts.notFound;
		return rec;
	}
}

class TablesHandler {
	constructor(supervisor) {
		this.supervisor = supervisor;
		this.getters = {};
	}
	get(name) {
		return this.getters[name] || ((_) => {
			var wrapper = new TableWrapper(this.supervisor.load(_, 'Table', name));
			// create fast getter
			this.getters[name] = (_) => wrapper;
			return wrapper;
		});
	}
}

exports.create = function(supervisor) {
	return Proxy(supervisor, {
		get: function(supervisor, name) {
			//console.error("PROXY GET", name);
			supervisor.tablesHandler = supervisor.tablesHandler || new TablesHandler(supervisor);
			return supervisor.tablesHandler.get(name);
		},
	});
}