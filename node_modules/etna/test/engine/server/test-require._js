"use strict";
QUnit.module(module.id);

var flows = require("streamline/lib/util/flows");
var adminHelpers = require("syracuse-collaboration/lib/helpers");
var util = require("etna/lib/supervisor/util");
var runtime = require("etna/lib/engine/runtime/runtime");
var mongodb = require("mongodb");
var doStop = false;

function getEtnaConfigForUnitTest(_,endpointName) {

	var config = require("etna/lib/util/nodeconfig").config;
	var collaboration = config.collaboration || {};
	var server = new mongodb.Server(collaboration.hostname || "localhost", collaboration.port || 27017, {});

	var db = new mongodb.Db("syracuse", server, {
		w: 1 //"majority"
	});
	db.open(_);
	try {
    	var endPoint = db.collection('EndPoint', _).find({
    		application:'x3',
    		contract:'erp',
    		dataset:endpointName

    	}).toArray(_)[0];

    	if ((endPoint.etnaDriver) === "sqlServer") {
    		var hst = endPoint.etnaSQLInstance;
    		var dba = endPoint.etnaDatabaseName;
    	}
    	else
    	{
    		var hst = endPoint.etnaDatabaseHost;
    		var dba = endPoint.etnaOracleSID;
    	}

        return {
            endpointName: config.unit_test.etnaEndPoint,
            solutionName: endPoint.x3SolutionName,
            folderName: endPoint.x3ServerFolder,
            solutionPath: endPoint.etnaSolutionPath,
            mongo: {
                host: endPoint.etnaMongoHost,
                port: endPoint.etnaMongoPort,
                database: endPoint.x3SolutionName + '-' + endPoint.x3ServerFolder
            },
            sql: {
                driver: endPoint.etnaDriver,
                user: endPoint.etnaDatabaseUser,
                password: endPoint.etnaDatabasePassword,
                database: dba,
                port: endPoint.etnaDatabasePort,
                hostname: hst,
            },


            session:{
                "id": "cf45e0fe-853e-4858-89f6-24a79e3fe758",
                "login": "admin",
                "userName": "AQCORE",
                "locale": "fr-FR",
                "localePreferences": {
                    "_id": "157279cf-2852-4674-bf66-9e5e36ccc606",
                    "code": "fr-FR",
                    "description": {
                        "default": "français (France)",
                        "en-us": "français (France)"
                    },
                    "enabled": true,
                    "firstDayOfWeek": 1,
                    "longDate": "dddd d MMMM yyyy",
                    "longDatetime": "dddd d MMMM yyyy HH:mm:ss",
                    "longTime": "HH:mm:ss",
                    "numberDecimalSeparator": ",",
                    "numberGroupSeparator": " ",
                    "numberGroupSize": 3,
                    "shortDate": "dd/MM/yyyy",
                    "shortDatetime": "dd/MM/yyyy HH:mm",
                    "shortTime": "HH:mm"
                }
            }        
        };
    } finally {
        db.close();
    }
}

QUnit.module(module.id, {
	setup: function() {},
	teardown: function() {
		if (doStop) {
			setTimeout(function() {
				process.kill(process.pid);
			}, 100);
		}
	}
});


asyncTest("start", function(_) {
	var config = require("etna/lib/util/nodeconfig").config;

	var etnaConfig = getEtnaConfigForUnitTest(_,config.unit_test.etnaEndPoint);

	var supervisor = require('etna/lib/supervisor/supervisor');
	var superv = supervisor.create(_, etnaConfig);
	require("etna/lib/engine/runtime/variables").initStack(superv);
	ok(true, "start");
	start();
});

asyncTest("Local src", function(_) {
	var script = runtime.requireScript(_, "QLFAR_DECL");
	ok(typeof script !== undefined, "QLFAR_DECL");
	start();
});

asyncTest("Builtin", function(_) {
	var script = runtime.requireScript(_, "AXUNIT");
	ok(typeof script !== undefined, "AXUNIT");
	start();
});

asyncTest("Shared src", function(_) {
	var script = runtime.requireScript(_, "ASYRCONST");
	ok(typeof script !== undefined, "ASYRCONST");
	start();
});

asyncTest("WFTESTREQ1", function(_) {
	var script = runtime.requireScript(_, "WFTESTREQ1");
	ok(typeof script !== undefined, "WFTESTREQ1");
	start();
});

asyncTest("EXEFNC", function(_) {
	var script = runtime.requireScript(_, "EXEFNC");
	ok(typeof script !== undefined, "EXEFNC");

	start();
});

asyncTest("ASYRFNC", function(_) {
	var script = runtime.requireScript(_, "ASYRFNC");
	ok(typeof script !== undefined, "ASYRFNC");

	start();
});

asyncTest("stop tests", function(_) {
	doStop = true;
	start();
});
