"use strict";
QUnit.module(module.id);
var Jmql = require("etna/lib/engine/jmqlgen");
var dates = require('etna/lib/engine/runtime/dates');

function testExpression(expression, expected) {
	var filter = Jmql.x3ToJmql({}, expression);
	var got = JSON.stringify(filter());
	strictEqual(got, expected);
}

function testExpression1(expression, expected) {
	var tab = {};
	tab["GACTX.USER"] = '"VPO"';
	tab["[V]CST_ANO"] = "false";
	tab["[V]CST_AYES"] = "true";
	tab["[F:ATB]FLG"] = "EXPPROPFLG";
	tab["[F:AWS]DEST"] = "EXPPROPDEST";
	var filter = Jmql.x3ToJmql(tab, expression);
	var got = JSON.stringify(filter());
	strictEqual(got, expected);
}

test('basic', 13, function() {
	testExpression("FIELD01 = 'F1_020'", '{"FIELD01":"F1_020"}');
	testExpression("FIELD01 <> 'F1_020'", '{"FIELD01":{"$ne":"F1_020"}}');
	testExpression("FIELD01 = 123", '{"FIELD01":123}');
	testExpression("FIELD01 = 'F1_020' or FIELD01 = 'F1_040'", '{"$or":[{"FIELD01":"F1_020"},{"FIELD01":"F1_040"}]}');
	testExpression("'F1_020' >= FIELD01", '{"FIELD01":{"$lte":"F1_020"}}');
	testExpression("FIELD01 = 'F1_020'", '{"FIELD01":"F1_020"}');
	testExpression("FIELD01 >= 'F1_020'", '{"FIELD01":{"$gte":"F1_020"}}');
	testExpression("FIELD01 >= 'F1_020' and  FIELD01 <='F1_035'", '{"FIELD01":{"$gte":"F1_020","$lte":"F1_035"}}');
	testExpression("FIELD01 >= 'F1_020' and  FIELD02 <='F2_010'", '{"FIELD01":{"$gte":"F1_020"},"FIELD02":{"$lte":"F2_010"}}');
	testExpression("left$(FIELD01,5) = 'F1_01'", '{"FIELD01":{"$regex":"F1_01.*","$options":"i"}}');

	testExpression1("[F:ATB]FLG = [V]CST_ANO", '{"EXPPROPFLG":false}');
	testExpression1("[F:ATB]FLG <> [V]CST_AYES", '{"EXPPROPFLG":{"$ne":true}}');
	testExpression1("[F:AWS]DEST=GACTX.USER", '{"EXPPROPDEST":"VPO"}');
});

test('date', 5, function() {
	var today = dates.functions.DATE$.fn();
	ok(true, "today:" + today);
	var expected = {
		FIELD02: today.toString("yyyy-MM-dd")
	};
	testExpression("FIELD02 = date$", JSON.stringify(expected));

	var yesterday = today.x3Sub(1);
	var expected1 = {
		FIELD02: yesterday.toString("yyyy-MM-dd")
	};
	testExpression("FIELD02 = (date$-1)", JSON.stringify(expected1));

	testExpression1("FIELD02 = date$", JSON.stringify(expected));
	testExpression1("FIELD02 = (date$-1)", JSON.stringify(expected1));
});