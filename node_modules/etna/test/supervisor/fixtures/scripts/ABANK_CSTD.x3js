"use strict";

module.exports = {
  className: 'Bank',
  properties: {
    bank: {
      control: function(_, context, val) {
        const len = context.cache(_, 'Countries', this.country$, 'lengthOfBank');
        if (val.length !== len) context.error(_, context.message(_, 111, 123, 1) + ' ' + this.country$ + ' (' + len + ')');
      },
    },
    country: {
        control: function(_, context, val) {
          if (context.cache(_, 'Countries', val, 'lengthOfBank') < 1 || 
            context.cache(_, 'Countries', val, 'bankControl') !== context.YES) {
            context.error(_, val + ' ' + context.message(_, 172, 133, 1));
            // context.error sets ASTATUS to CST_AERROR
          }
        }
    },
    validTo: {
        control: function(_, context, val) {
          if (val && this.validFrom$ && val < this.validFrom$) {
            context.error(_, context.message(_, 90, 121, 1));
          }
        }
    },
  },
  events: {
    updateAfter: function(_, context) {
      if (this.$snapshot.validFrom$ != this.validFrom$ || 
        this.$snapshot.validTo$ != this.validTo$) {
        const len = context.cache(_, 'Countries', this.country$, 'lengthOfBank');
        context.classes.BankIdStatement$.query(_).filter({
          country: this.country$,
          bankIdNumber: context.predicates.startsWith(this.bank$.substring(0, len)),
        }).forEach(_, (_, bid) => {
          try {
            if (bid.validFrom$ < this.validFrom$) 
              bid.validFrom$ = this.validFrom$;
            if (bid.validTo$ == null || bid.validTo$ > this.validTo$) 
              bid.validTo$ = this.validTo$;
            if (bid.$status == context.UPDATE) bid.$update(_);
          } catch (ex) {
            context.error(_, bid.entity$ + ' ' + bid.bankIdNumber$ + ' ' + context.message(_, 42, 9003, 1) + ': ' + ex.message);
          }
        });
      }
    },
    deleteControlBefore: function(_, context) {
      var len = context.cache(_, 'Countries', this.country$, 'lengthOfBank');
      if (context.classes.BankIdStatement$.query(_).some(_, {
        country: this.country$,
        bankIdNumber: context.predicates.startsWith(this.bank$.substring(0, len)),
      })) {
        context.error(_, context.message(_, 174, 133, 1));
      }
    },
  },
};