#
# Qualification tests for SData expression functions
# Written by Dominique BOPP March 30,2012
#
Local Clbfile RESULT(4)
RESULT = func TESTSUITE()
GTRACE="QLFAC_PARSESDATA_"+GACTX.USER
Call LEC_TRACE From LECFIC
End

#**
#* The main entry point of the unit test suite for Requester
#*
#*!
Funprog TESTSUITE()
Call ADD_TESTCASE("TEST_DATE", "Date value", 9) From AXUNIT
Call ADD_TESTCASE("TEST_DATETIME", "datetime value", 8) From AXUNIT
Call ADD_TESTCASE("TEST_STRING", "string value", 8) From AXUNIT
Call ADD_TESTCASE("TEST_INTEGER", "integer value", 8) From AXUNIT
Call ADD_TESTCASE("TEST_BOOLEAN", "Boolean value", 7) From AXUNIT
Call ADD_TESTCASE("TEST_UUID", "UUID value", 7) From AXUNIT
Call ADD_TESTCASE("TEST_CLOB", "Clob value", 8) From AXUNIT
Call ADD_TESTCASE("TEST_MENLOC", "Local menu value", 8) From AXUNIT
Call ADD_TESTCASE("TEST_COMPLEX", "Complex combination", 20) From AXUNIT
Call ADD_TESTCASE("TEST_ADDVAR", "Additional variables", 12) From AXUNIT
Call ADD_TESTCASE("TEST_ERRORS", "Errors check", 11) From AXUNIT
End func AXUNIT.RUN_TESTSUITE("PARSE_SDATA", "SData where parsing")

# QLFRTM_DELAYED_MASK
#   Test de validation différée d'un masque et d'appel d'une fonction avec un masque invalidé

$INIT_VARIABLES
Local Char PARAM(30)(1..50)
Local Libelle PARTYPE(1..50) : # Local menu 33 with a value equal to 13 for booleans
Local Libelle STRICTBEG(1..50),STRICTEND(1..50)
Local Char VALBEG(250)(1..),VALEND(250)(1..50)
Local Integer ERR
Local Char MSG(250)
Local Clbfile CHAINE(4)

PARAM(1)="short1"    : PARTYPE(1)=2
PARAM(2)="int2"      : PARTYPE(2)=3
PARAM(3)="dcb3"      : PARTYPE(3)=4
PARAM(4)="date4"     : PARTYPE(4)=8
PARAM(5)="char5"     : PARTYPE(5)=7
PARAM(6)="bool6"     : PARTYPE(6)=13
PARAM(7)="clob7"     : PARTYPE(7)=10
PARAM(8)="uuid8"     : PARTYPE(8)=11
PARAM(9)="datetime9" : PARTYPE(9)=12
PARAM(10)="menloc10" : PARTYPE(10)=1
Return

Subprog TEST_DATE
 Gosub INIT_VARIABLES
 CHAINE="date4 le @2008-05-19@ and date4 gt @2007-05-19@"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(4),2) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(4),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..3),STRICTBEG(5..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..3),STRICTEND(5..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(4),"2007-05-19") From AXUNIT
 Call CHECK_EQUAL(VALEND(4),"2008-05-19") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(4),2) From AXUNIT
End

Subprog TEST_DATETIME
 Gosub INIT_VARIABLES
 CHAINE="datetime9 between @2007-05-19T15:02:30Z@ and @2008-05-19T22:30:01Z@"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(9),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(9),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..8),STRICTBEG(10..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..8),STRICTEND(10..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(9),"2007-05-19T15:02:30Z") From AXUNIT
 Call CHECK_EQUAL(VALEND(9),"2008-05-19T22:30:01Z") From AXUNIT
End

Subprog TEST_STRING
 Gosub INIT_VARIABLES
 CHAINE="char5 lt 'haha\'hoho' and char5 ge 'ababa'"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(5),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(5),2) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..4),STRICTBEG(6..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..4),STRICTEND(6..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(5),"ababa") From AXUNIT
 Call CHECK_EQUAL(VALEND(5),"haha'hoho") From AXUNIT
End

Subprog TEST_INTEGER
 Gosub INIT_VARIABLES
 CHAINE="int2 eq 314"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(2),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(2),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..1),STRICTBEG(3..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..1),STRICTEND(3..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(2),"314") From AXUNIT
 Call CHECK_EQUAL(VALEND(2),"314") From AXUNIT
End

Subprog TEST_BOOLEAN
 Gosub INIT_VARIABLES
 CHAINE="bool6 gt false"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(6),2) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(6),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..5),STRICTBEG(7..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(6),"1") From AXUNIT
End

Subprog TEST_UUID
 Gosub INIT_VARIABLES
 CHAINE="uuid8 le '12345678-abcd-bcde-cdef-1234567890ab'"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(8),0) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(8),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..7),STRICTEND(9..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALEND(8),"12345678-abcd-bcde-cdef-1234567890ab") From AXUNIT
End

Subprog TEST_CLOB
 Gosub INIT_VARIABLES
 CHAINE="clob7 between 'e approximately equals 2.718281828' and 'pi value is near from 3.14159265358'"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(7),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(7),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..6),STRICTBEG(8..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..6),STRICTEND(8..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(7),'e approximately equals 2.718281828') From AXUNIT
 Call CHECK_EQUAL(VALEND(7),'pi value is near from 3.14159265358') From AXUNIT
End

Subprog TEST_MENLOC
 Gosub INIT_VARIABLES
 CHAINE="menloc10 eq 23"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(10),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(10),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(1..9),STRICTBEG(11..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(1..9),STRICTEND(11..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(10),"23") From AXUNIT
 Call CHECK_EQUAL(VALEND(10),"23") From AXUNIT
End

Subprog TEST_COMPLEX
 Gosub INIT_VARIABLES
 CHAINE="short1 eq 23 and ( int2 gt 10 ) and dcb3 lt 156 and  ( ( ( bool6 eq true ) ) and clob7 eq 'abc')"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(1),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(1),1) From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(2),2) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(3),2) From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(6),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(6),1) From AXUNIT
 Call CHECK_EQUAL(STRICTBEG(7),1) From AXUNIT
 Call CHECK_EQUAL(STRICTEND(7),1) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTBEG(3..5),STRICTBEG(8..40)),0) From AXUNIT
 Call CHECK_EQUAL(sum(STRICTEND(2),STRICTEND(4..5),STRICTBEG(8..40)),0) From AXUNIT
 Call CHECK_EQUAL(VALBEG(1),"23") From AXUNIT
 Call CHECK_EQUAL(VALEND(1),"23") From AXUNIT
 Call CHECK_EQUAL(VALBEG(2),"10") From AXUNIT
 Call CHECK_EQUAL(VALEND(3),"156") From AXUNIT
 Call CHECK_EQUAL(VALBEG(6),"2") From AXUNIT
 Call CHECK_EQUAL(VALEND(6),"2") From AXUNIT
 Call CHECK_EQUAL(VALBEG(7),"abc") From AXUNIT
 Call CHECK_EQUAL(VALEND(7),"abc") From AXUNIT
End

Subprog TEST_ERRORS
 Gosub INIT_VARIABLES
 CHAINE="(( short1 and int2 le 5))"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,8) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="menloc10 ge 343"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,14) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="short1 lt 68200"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,14) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="int2 eq 3.14"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,13) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="date4 lt @33@"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,17) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="char5 ge 'unclosed"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,15) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="bool6 eq maybe"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,19) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="uuid8 ge '314159265358'"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,16) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="datetime9 gt '2001-12-31T22:22:22X'"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,17) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="datetime9 gt @2001-12-31T22:22:22X@"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,18) From AXUNIT

 Gosub INIT_VARIABLES
 CHAINE="int2 le 5 and not 6"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,8) From AXUNIT
End

Subprog TEST_ADDVAR
 Gosub INIT_VARIABLES
 CHAINE="line ge 12 and timestamp eq @2005-06-03@ and truc eq 'azerto' and pi le 3.141569265358 and crazy eq false"
 Call PARSE_WHERE(CHAINE, PARAM, PARTYPE, VALBEG, STRICTBEG, VALEND, STRICTEND, ERR, MSG) From ASYRFNC
 Call CHECK_EQUAL(ERR,0) From AXUNIT
 Call CHECK_EQUAL(MSG,"") From AXUNIT
 Call CHECK_EQUAL(PARAM(11),"line") From AXUNIT
 Call CHECK_EQUAL(PARTYPE(11),4) From AXUNIT
 Call CHECK_EQUAL(PARAM(12),"timestamp") From AXUNIT
 Call CHECK_EQUAL(PARTYPE(12),8) From AXUNIT
 Call CHECK_EQUAL(PARAM(13),"truc") From AXUNIT
 Call CHECK_EQUAL(PARTYPE(13),7) From AXUNIT
 Call CHECK_EQUAL(PARAM(14),"pi") From AXUNIT
 Call CHECK_EQUAL(PARTYPE(14),4) From AXUNIT
 Call CHECK_EQUAL(PARAM(15),"crazy") From AXUNIT
 Call CHECK_EQUAL(PARTYPE(15),13) From AXUNIT
End

# No init nor cleaning is necessary
Subprog SETUP
End
Subprog TEARDOWN
End

