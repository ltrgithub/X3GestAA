"use strict";
QUnit.module(module.id);

var glob = require('streamline/lib/globals');
var runtime = require("etna/lib/engine/runtime/runtime");
var helper = require("etna/test/engine/fixtures/helper");

var script;
var superv;

asyncTest("start", (_) => {
	var supervisor = require('etna/lib/supervisor/supervisor');
	var config = require("etna/lib/util/nodeconfig").config;
	var etnaConfig = helper.getEtnaConfigForUnitTest(_, config.unit_test.etnaEndPoint);
	superv = supervisor.create(_, etnaConfig);
	require("etna/lib/engine/runtime/variables").initStack(superv);
	require("etna/lib/supervisor/builtins/ACTX").init(_, etnaConfig.session, superv);
	script = require("etna/test/supervisor/server/test-snapshots.src");
	ok(true, "start");
	start();
});

function gosub(_, fnName) {
	var frame = glob.context.x3frame;
	frame.done = false;
	frame.sub.done = false;
	ok(true, "=> " + fnName);
	script[fnName](_);
}

function initStack() {
	var frame = glob.context.x3frame;
	frame.values = {};
	frame.types = {};
	return frame.values;
}

asyncTest("TC_SNAPSHOT", (_) => {
	var locals = initStack();
	gosub(_, "TC_SNAPSHOT_SETUP");
	gosub(_, "TC_SNAPSHOT_00");
	// enable snapshots :
	locals.INS.enableSnapshot();
	gosub(_, "TC_SNAPSHOT_01");
	// disable snapshots :
	locals.INS.disableSnapshot();
	gosub(_, "TC_SNAPSHOT_00");

	// enable snapshots :
	locals.INS.enableSnapshot();
	gosub(_, "TC_SNAPSHOT_01");
	gosub(_, "TC_SNAPSHOT_02");

	// Clean the stack 
	// Revert to initial status
	//setTimeout(_,5000);
	//debugger;
	locals.INS.revertToSnapshot();
	locals.INS.enableSnapshot();
	gosub(_, "TC_SNAPSHOT_01");
	gosub(_, "TC_SNAPSHOT_03");

	// Revert to initial status
	locals.INS.revertToSnapshot();
	// disable snapshots :
	locals.INS.disableSnapshot();
	gosub(_, "TC_SNAPSHOT_00");

	gosub(_, "TC_SNAPSHOT_99");
	gosub(_, "TC_SNAPSHOT_TEARDOWN");
	start();
});
