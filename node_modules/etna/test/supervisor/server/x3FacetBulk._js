"use strict";
// JavaScript Document
var module = QUnit.module;
var assert = require("assert");
var x3Helper = require("etna/test/supervisor/fixtures/x3Helper");
var config = require('config'); // must be first syracuse require

var tracer; // = console.log;
var doStop = false;

module(config.unit_test.x3endpoint.folder + ".x3FacetBulk");

var cookie = null;

function _getCookie(_) {
	cookie = cookie || x3Helper.getCookie(_);
	//!ok("cookie"   ,"cookie"   +JSON.stringify(cookie));
	return cookie;
}

if (!config.unit_test || !config.unit_test.x3endpoint || !config.unit_test.run) {
	test('X3 BULK UNIT TESTS DISABLED FOR NOW', 1, function() {
		ok(true, "work in progress");
	});
} else {

	asyncTest("start", function(_) {
		if (config.unit_test.x3endpoint.serverPort != config.unit_test.x3endpoint.localPort) {
			ok(x3Helper.initDatabase(_), "syracuse mongodb database initialized");
			x3Helper.initialize(_);
			ok(x3Helper.createObjects(_), "createObjects");
		} else {
			ok(true, "start");
		}
		start();
	});

	//******************************************************************************

	function checkJSON(_, _representation) {
		var name = _representation + ".$bulk";
		try {
			var prototype = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(_representation + "?representation=" + _representation + ".$bulk&count=500"), 200);
			/*dbg*/
			ok(true, "prototype=" + JSON.stringify(prototype));
			strictEqual(true, true, "The JSON of " + _representation + ".$bulk is well formed");
		} catch (e) {
			strictEqual(true, false, "The JSON of " + _representation + ".$bulk isn't well formed");
		}
		var query = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(_representation + "?representation=" + _representation + ".$query&count=10"), 200);
		/*dbg*/
		//ok(true,"DBG query:"+JSON.stringify(query));

		var bulk = x3Helper.get(_, _getCookie(_), x3Helper.x3Url(_representation + "?representation=" + _representation + ".$bulk&count=10"), 200);
		/*dbg*/
		//ok(true,"DBG bulk:"+JSON.stringify(bulk));

		for (var p in query.$resources[0]) {
			ok(p in bulk.$resources[0], p + " is present");
			//!strictEqual(query.$resources[0][p],bulk.$resources[0][p],"'"+query.$resources[0][p]+"'='"+bulk.$resources[0][p]+"'");
		}
	}

	asyncTest("ACLAIDX    ", function(_) {
		checkJSON(_, "ACLAIDX");
		start();
	});
	asyncTest("AFCTIDX    ", function(_) {
		checkJSON(_, "AFCTIDX");
		start();
	});
	//TODO asyncTest("AREPIDX    ", function(_) {
	// 	checkJSON(_, "AREPIDX");
	// 	start();
	// });
	asyncTest("ATABLE     ", function(_) {
		checkJSON(_, "ATABLE");
		start();
	});
	asyncTest("ATYPE      ", function(_) {
		checkJSON(_, "ATYPE");
		start();
	});
	asyncTest("AVOLUME    ", function(_) {
		checkJSON(_, "AVOLUME");
		start();
	});
	asyncTest("TABCOUNTRY ", function(_) {
		checkJSON(_, "TABCOUNTRY");
		start();
	});
	asyncTest("TABLAN     ", function(_) {
		checkJSON(_, "TABLAN");
		start();
	});
	asyncTest("TABUNIT    ", function(_) {
		checkJSON(_, "TABUNIT");
		start();
	});
	asyncTest("AQCPROC01  ", function(_) {
		checkJSON(_, "AQCPROC01");
		start();
	});
	asyncTest("AQCPROC02  ", function(_) {
		checkJSON(_, "AQCPROC02");
		start();
	});
	asyncTest("AQCPROC03  ", function(_) {
		checkJSON(_, "AQCPROC03");
		start();
	});
	asyncTest("AQCPROC04  ", function(_) {
		checkJSON(_, "AQCPROC04");
		start();
	});
	asyncTest("AQCPROC05  ", function(_) {
		checkJSON(_, "AQCPROC05");
		start();
	});
	asyncTest("AQCPROC06  ", function(_) {
		checkJSON(_, "AQCPROC06");
		start();
	});
	asyncTest("AQCPROC07  ", function(_) {
		checkJSON(_, "AQCPROC07");
		start();
	});

	// asyncTest("POSCOD     ", function(_) {
	// 	checkJSON(_, "POSCOD");
	// 	start();
	// });

	// asyncTest("APSADX" + x3Helper.gitHubIssue(5076), function(_) {
	// 	checkJSON(_, "APSADX");
	// 	start();
	// });

	//******************************************************************************

	asyncTest("stop server", 0, function(_) {
		if (config.unit_test.x3endpoint.serverPort != config.unit_test.x3endpoint.localPort) {
			x3Helper.stopServer();
		}
		start();
	});

	asyncTest("stop  tests", 0, function(_) {
		doStop = true;
		start();
	});
}