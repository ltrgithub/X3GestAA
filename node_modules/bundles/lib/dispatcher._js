"use strict";
var url = require('url');

function getDispatchFunc(options) {
	options = options || {};
	return function(_, request, response) {
		var parsed = url.parse(request.url);
		if (/\.md$/i.test(parsed.pathname)) return staticDispatcher(_, request, response);
		var name = parsed.pathname.split('/')[2];
		try {
			var bundle = require('bundles/' + name);
		} catch (e) {
			console.error(e);
			response.writeHead(404, {
				"Content-Type": "text/plain"
			});
			return response.end('bad bundle: ' + name, 'utf8');
		}
		if (options.$nonAuth && !bundle.nonAuth) {
			response.writeHead(503, {
				"Content-Type": "text/plain"
			});
			return response.end('bundle must use authenticated route: ' + name, 'utf8');
		}
		if (!bundle.$exported || typeof bundle.httpDispatch !== 'function') {
			response.writeHead(404, {
				"Content-Type": "text/plain"
			});
			return response.end('unauthorized bundle: ' + name, 'utf8');
		}
		return bundle.httpDispatch(_, request, response);
	};
}

exports.dispatcher = function(config, staticDispatcher) {
	return getDispatchFunc();
};

exports.dispatcherNonAuth = function(config, staticDispatcher) {
	return getDispatchFunc({nonAuth: true});
};