"use strict";
var url = require('url');

exports.dispatcher = function(config, staticDispatcher) {
	return function(_, request, response) {
		var parsed = url.parse(request.url);
		if (/\.md$/i.test(parsed.pathname)) return staticDispatcher(_, request, response);
		var name = parsed.pathname.split('/')[2];
		try {
			var bundle = require('bundles/' + name);
		} catch (e) {
			console.error(e);
			response.writeHead(404, {
				"Content-Type": "text/plain"
			});
			return response.end('bad bundle: ' + name, 'utf8');
		}
		if (!bundle.$exported || typeof bundle.httpDispatch !== 'function') {
			response.writeHead(404, {
				"Content-Type": "text/plain"
			});
			return response.end('unauthorized bundle: ' + name, 'utf8');
		}
		return bundle.httpDispatch(_, request, response);
	};
};