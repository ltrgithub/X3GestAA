"use strict";
/// !doc
///
/// # Integration bundle for Sage Payment Solutions (SPS)
///
/// `var sgex = require('sage-exchange');`
///
exports.$exported = true;

var ez = require('ez-streams'),
	fs = require('streamline-fs'),
	jsxml = require('jsxml'),
	os = require('os'),
	config = require('../../../nodelocal').config;

// convert string dot notation to objects
function objectify(arr, val) {
	var obj = {};
	obj[arr[0]] = (arr.length == 1) ? val : objectify(arr.slice(1), val);
	return obj;
}

// Recursively merge properties of two objects
function merge(d, s) {
	for (var p in s) {
		d[p] = !d.hasOwnProperty(p) ? s[p] : merge(d[p], s[p]);
	}
	return d;
}

// Parse dot notation style string into object
function parseDotNotation(values) {
	return values.split(',').reduce(function(r, val) {
		val = "Request_v1." + val;
		var pair = val.split('=');
		merge(r, objectify(pair[0].split('.'), pair[1]));
		return r;
	}, {});
}

function buildReq(values) {
	var vals = parseDotNotation(values);
	return '<?xml version="1.0" encoding="utf-8"?>\n' + jsxml.stringify(vals, ' ');
}

// Send request to Sage Exchange and receive response.
exports.seRequest = function(_, values, responseProperty) {
	var req = buildReq(values);
	console.log('\n\n ' + responseProperty + ' request = ' + req);
	req = "request=" + encodeURIComponent(req);
	var request = ez.devices.http.client({
		url: 'https://www.sageexchange.com/VirtualPaymentTerminal/frmPayment.aspx',
		method: 'POST',
		headers: {
			'content-type': 'application/x-www-form-urlencoded',
			'content-length': req.length,
		}
	});
	request.write(_, req, 'utf8');
	var resp = request.end().response(_);
	if (resp.statusCode != 200) {
		console.log(resp.statusCode + ': ' + resp.readAll(_));
		console.log(resp.headers);
		return null;
	} else {
		var xml = resp.readAll(_);
		console.log('\n\n Sage Exchange ' + responseProperty + ' (XML) =' + xml.toString());
		var json = jsxml.parse(xml);
		var returnVal = json.Response_v1[responseProperty];
		return returnVal;
	}
};


var redirections = [];

/// * `url = sps.getRedirectUrl(_, values, ttl);`
/// returns the URL of a page that will redirect the user to SPS.
/// `values` is a string containing the values that need to be embedded in the page.
/// `ttl` is a time to live for the URL in seconds. After this time the URL is invalid.
exports.getRedirectUrl = function(_, values, ttl) {
	var id = require('syracuse-core/lib/uuid').generate('');
	redirections.push({
		id: id,
		expires: Date.now() + ttl * 1000,
		values: values
	});

	var hostname = os.hostname();
	var port = config.port;
	var url = hostname + ":" + port + '/bundles/sage-exchange/redirect?id=' + id;
	console.log('\n URL = ' + url);
	return url;
};

function redirect(_, request, response, redir) {
	var html = fs.readFile(__dirname + '/redir-template.html', 'utf8', _).replace(/\{input\}/g, buildReq(redir.values));
	response.writeHead(200, {
		'content-type': 'text/html; charset=utf-8'
	});
	response.end(html, 'utf8');
}

exports.httpDispatch = function(_, request, response) {
	var parsed = require('url').parse(request.url, true);
	var segs = parsed.pathname.split('/');
	if (segs[3] !== 'redirect') {
		response.writeHead(404, {});
		response.end('invalid URL: ' + request.url, 'utf8');
		return;
	}
	var id = parsed.query.id;
	var t = Date.now();
	var i = 0;
	while (i < redirections.length) {
		var redir = redirections[i];
		if (redir.expires < t) redirections.splice(i, 1); // remove it
		else if (redir.id == id) {
			redirections.splice(i, 1); // remove it
			return redirect(_, request, response, redir);
		} else i++;
	}
	// not found
	response.writeHead(404, {});
	response.end('redirection URL not found: ' + id, 'utf8');
};

// TEST CODE
// exports.getRedirectUrl(_ >> function(err, val) {
// 		if (err) throw err;
// 		console.log(val);
// 	},
// 	'Application.ApplicationID=SAGEERPX5X00000ERPLAAA5USEN,' +
// 	'Application.LanguageID=EN,' +
// 	'VaultOperation.Merchant.MerchantID=941457786836,' +
// 	'VaultOperation.Merchant.MerchantKey=F6K7Y7E7C7T7,' +
// 	'VaultOperation.VaultID=0d6eb170-4ea7-46be-98ca-b875bc', 10);
