exports.$exported = true;

var streams = require('streamline-streams');
var jsxml = require('jsxml');

/*
<Request_v1 xmlns="http://com.sage/usa/SPS/RQRP/protocol" 
xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
xsi:schemaLocation="http://com.sage/usa/SPS/RQRP/protocol ../schemas/SPS.xsd">
  <Application>
    <ApplicationID>SAGEERPX5X00000ERPLAAA5USEN</ApplicationID>
    <LanguageID>EN</LanguageID>
  </Application>
 <AccountQuery>
    <Merchant>
      <MerchantID>941457786836</MerchantID>
      <MerchantKey>F6K7Y7E7C7T7</MerchantKey>
    </Merchant>
  </AccountQuery>
</Request_v1>
*/

function genericCall(_, values, fillFn) {
	var vals = values.split(',').reduce(function(r, val) {
		var pair = val.split('=');
		r[pair[0]] = pair[1];
		return r;
	}, {});
	var req = '<?xml version="1.0" encoding="utf-8"?>\n' + jsxml.stringify(fillFn(vals), '  ');
	console.log("req=" + req);
	req = "request=" + encodeURIComponent(req).replace(/%20/g, '+');
	var request = streams.httpRequest({
		url: 'https://www.sageexchange.com/VirtualPaymentTerminal/frmPayment.aspx',
		method: 'POST',
		proxy: "http://ecvmdevprod2:80",
		headers: {
			'content-type': 'application/x-www-form-urlencoded',
			//'accept': '*',
			'content-length': req.length,
		}
	});
	console.log("SENDING: " + req);
	request.proxyConnect(_).write(_, req, 'utf8');
	var resp = request.end().response(_);
	console.log("status=" + resp.statusCode);
	if (resp.statusCode != 200) {
		resp.statusCode + ': ' + resp.readAll(_);
		console.log(resp.headers);
		return null;
	} else {
		console.log(resp.headers);
		var xml = resp.readAll(_);
		console.log("xml=" + xml);
		var json = jsxml.parse(xml);
		console.log(json);
		return json.Response_v1;
	}
}

exports.call1 = function(_, values) {
	var response = genericCall(_, values, function(vals) {
		return {
			Request_v1: {
				Application: {
					ApplicationID: vals.ApplicationID,
					LanguageID: vals.LanguageID,
				},
				AccountQuery: {
					Merchant: {
						MerchantID: vals.MerchantID,
						MerchantKey: vals.MerchantKey,
					}
				}
			}
		}
	});
	if (!response) return '';
	return response.AccountQueryResponse.Response.ResponseIndicator;
}
