"use strict";
/// !doc
///
/// # Integration bundle for Salesforce CRM
///
/// `var sfcrm = require('salesforce-crm');`
///
var config = require('config');
var httpClient = require('@sage/syracuse-lib/src/http-client/httpClient');
var jsxml = require('js-xml');
var oauth2 = require('salesforce-auth');
var globals = require('streamline-runtime').globals;

exports.$exported = true;

function postSoap(_, service, method, data) {
	var envelope = {
		"soapenv:Envelope": {
			$: {
				"xmlns:soap": "http://schemas.xmlsoap.org/soap/envelope/"
			},
			"soapenv:Header": {},
			"soapenv:Body": {}
		}
	};
	envelope["soapenv:Envelope"]["soapenv:Body"][method] = data;

	var xmlData = '<?xml version="1.0" encoding="utf-8"?>' + jsxml.stringify(envelope);

	try {
		var response = httpClient.httpRequest(_, {
			method: "POST",
			url: globals.context.session.host + '/soap-generic/syracuse/collaboration/syracuse/CAdxWebServiceXmlCC?oauth2=salesforce',
			headers: {
				"content-type": "text/xml",
				"authorization": globals.context.session.authData.authorization,
				"soapaction": "\"\"", // soap action is empty for generic web services because it was never defined in V6
			}
		}).write(_, xmlData, "utf8").end().response(_);
		if (response.statusCode === 200) {
			var jsonResult = jsxml.parse(response.readAll(_));
			try {
				return jsonResult["soapenv:Envelope"]["soapenv:Body"];
			} catch (err) {
				console.log("SOAP Body not found in response");
				return jsonResult;
			}
		}
	} catch (e) {
		console.log("Error: ", e);
		throw e;
	}
}

exports.soapSave = function(_, codelang, poolAlias, publicName, requestXml) {
	var callContext = {
		codeLang: codelang,
		codeUser: "",
		password: null,
		poolAlias: poolAlias,
		poolId: null,
		requestConfig: "adxwss.beautify=true&adxwss.requestid=UT1"
	};
	var callParams = {
		callContext: callContext,
		publicName: publicName,
		objectXml: requestXml
	};
	var body = postSoap(_, "CAdxWebServiceXmlCC", "save", callParams);
	try {
		return body.saveResponse.saveReturn;
	} catch (e) {
		console.log("saveReturn not found in response");
		return body;
	}
};

exports.soapRead = function(_, codelang, poolAlias, publicName, keyName, keyValue) {
	var callContext = {
		codeLang: codelang,
		codeUser: "",
		password: null,
		poolAlias: poolAlias,
		poolId: null,
		requestConfig: "adxwss.beautify=true&adxwss.requestid=UT1"
	};
	var callParams = {
		callContext: callContext,
		publicName: publicName,
		objectKeys: {
			key: keyName,
			value: keyValue
		}
	};

	var body = postSoap(_, "CAdxWebServiceXmlCC", "read", callParams);
	try {
		return body.readResponse.readReturn;
	} catch (e) {
		console.log("readReturn not found in response");
		return body;
	}
};

exports.soapModify = function(_, codelang, poolAlias, publicName, keyName, keyValue, requestXml) {
	var callContext = {
		codeLang: codelang,
		codeUser: "",
		password: null,
		poolAlias: poolAlias,
		poolId: null,
		requestConfig: "adxwss.beautify=true&adxwss.requestid=UT1"
	};
	var callParams = {
		callContext: callContext,
		publicName: publicName,
		objectKeys: {
			key: keyName,
			value: keyValue
		},
		objectXml: requestXml
	};

	var body = postSoap(_, "CAdxWebServiceXmlCC", "modify", callParams);
	try {
		return body.modifyResponse.modifyReturn;
	} catch (e) {
		console.log("modifyReturn not found in response");
		return body;
	}
};