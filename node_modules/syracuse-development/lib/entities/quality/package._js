"use strict";
var locale = require('streamline-locale');
var datetime = require("syracuse-core/lib/types/datetime");
var flows = require('streamline-runtime').flows;
var fs = require("streamline-fs");

exports.entity = {
	$titleTemplate: "Package {name}",
	$descriptionTemplate: "{description}",
	$helpPage: "Development-reference-Package",
	$valueTemplate: "{name}",
	$createActionTitle: "New package",
	$listTitle: "List of packages",
	$properties: {
		name: {
			$title: "Name",
			$linksToDetails: true,
			$isMandatory: true,
		},
		description: {
			$title: "Description",
		},
	},
	$relations: {
		unitTests: {
			$title: "Unit Tests",
			$type: "unitTests",
			$inv: "package",
			$isComputed: true,
		},
	},
	$searchIndex: {
		$fields: ["description"]
	},
	$uniqueConstraints: [
		["name"]
	]
};

function toDesc(name) {
	return name.split('-').map(function(desc) {
		return (desc.length <= 3) ? desc.toUpperCase() : desc[0].toUpperCase() + desc.slice(1);
	}).join(' ');
}

exports.fillPackages = function(_, db) {
	var rootDir = __dirname + "/../../../..";
	fs.readdir(rootDir, _).forEach_(_, function(_, name) {
		var dir = rootDir + "/" + name;
		if (!fs.stat(dir, _).isDirectory()) return;
		dir += "/test";
		if (!fs.exists(dir, _)) return;
		var pack = db.fetchInstance(_, db.model.getEntity(_, "package"), {
			jsonWhere: {
				name: name,
			}
		});
		if (!pack) {
			pack = db.model.getEntity(_, "package").factory.createInstance(_, null, db);
			pack.name(_, name);
			pack.description(_, toDesc(name));
			pack.save(_);
			if (pack.hasErrors(_)) throw new Error("package save failed: " + name);
		}
		console.log("package=" + name);

		function fillUnitTests(_, subdir) {
			if (!fs.exists(dir + "/" + subdir, _)) return;
			fs.readdir(dir + "/" + subdir, _).forEach_(_, function(_, testName) {
				var m = /^(.*)\._?js$/.exec(testName);
				if (!m) return;
				testName = m[1];
				var test = db.fetchInstance(_, db.model.getEntity(_, "unitTest"), {
					jsonWhere: {
						package: {
							_uuid: pack._id,
						},
						scope: subdir,
						name: testName,
					}
				});
				if (!test) {
					console.log("test=" + name + "/" + subdir + "/" + testName);
					test = db.model.getEntity(_, "unitTest").factory.createInstance(_, null, db);
					test.package(_, pack);
					test.scope(_, subdir);
					test.name(_, testName);
					test.description(_, toDesc(testName));
					test.active(_, true);
					test.deleted(_, false);
					test.save(_);
					if (test.hasErrors(_)) throw new Error("unit test save failed: " + testName);
				}
			});
		}
		fillUnitTests(_, "common");
		fillUnitTests(_, "server");
		fillUnitTests(_, "client");
	});
};