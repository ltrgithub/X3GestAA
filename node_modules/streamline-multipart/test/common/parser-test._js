"use strict";

var parser = require('streamline-multipart').parser;

function makeRequest(headers, buf) {
	return {
		headers: headers,
		read: function(_, len) {
			if (buf.length === 0) return null;
			var end = Math.min(len, buf.length);
			var b = buf.slice(0, end);
			buf = buf.slice(end);
			return b;
		},
		unread: function(b) {
			buf = Buffer.concat([b, buf]);
		},
		readAll: function(_) {
			return this.read(_, buf.length);
		}
	};
}

QUnit.module(module.id);

asyncTest('basic multipart/form-data', 7, function(_) {
	var boundary = "-- my boundary --";
	var contentType = "multipart/form-data;atb1=val1; boundary=" + boundary + "; atb2=val2";
	var partHeaders = "Header1: value1\nContent-Type: text/plain\nHeader2: value2\n";
	var text = "A";

	var req = makeRequest({
		"content-type": contentType
	}, new Buffer(partHeaders + '\n' + boundary + '\n' + text + '\n' + boundary, "binary"));
	var nextPart = parser(req);
	var part = nextPart(_);
	ok(part != null, "part != null");
	equal(part.headers.header1, "value1", "header1");
	equal(part.headers["content-type"], "text/plain", "content-type");
	equal(part.headers.header2, "value2", "header2");
	var r = part.read(_);
	equal(r.toString('binary'), 'A', 'A');
	r = part.read(_);
	equal(r, null, "part read returns null");
	part = nextPart(_);
	equal(part, null, "nextPart returns null");
	start();
});

