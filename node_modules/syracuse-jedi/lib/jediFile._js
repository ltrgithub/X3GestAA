"use strict";

// JavaScript Document
var path = require("path");
var config = require('config');
var tracer = (config.jedi && config.jedi.debug) ? config.jedi.debug : null;

var fs = require('fs');
var streams   = require('streamline/lib/streams/server/streams');
var Jedi      = require('syracuse-jedi/lib/jedi');

var JediFile = function (_file,_mode,_options){
  /*dbg*/tracer && tracer.log("new JediFile(",_file,",",_mode,")");
  this.file      = _file;
  this.mode      = _mode;
  this.options   = _options;
  this.encoding  = 'ascii';
  
	if( _options != null) {
   if("encoding" in _options)	{
	   this.encoding = _options.encoding
	  }
  }
  /*dbg*/tracer && tracer.log("file stream",this.file," encoding:",this.encoding); 
  if(_mode == 'w') {
    /*dbg*/tracer && tracer.log("createWriteStream:",this.file); 
    this.wStream         = fs.createWriteStream(this.file);
    this.writableStream  = new streams.WritableStream(this.wStream);
  }
  if(_mode == 'r') {
    /*dbg*/tracer && tracer.log("createReadStream:",this.file); 
 	  this.rStream         = fs.createReadStream(this.file);
	  this.readableStream  = new streams.ReadableStream(this.rStream);  
  }
}

JediFile.prototype.readStream = function(_) {
	/*dbg*///tracer && tracer.log("JediFile.readStream");
  var buffer = "";
  var data = this.readableStream.read(_);
  if(data != null){
    this.eof = false;
    buffer = data.toString(this.encoding);
  } else {
    this.eof = true;
  }
  /*dbg*///tracer && tracer.log("JediFile.readStream=",buffer);
  return buffer;
}

JediFile.prototype.read = function(_,_structure,transform){
  var item;
  var lStructure = _structure;  
  
  var jedi = new Jedi(this.options)
  /*dbg*/tracer && tracer.log("JediFile.read");

	var readBuffer = this.readStream(_);
	while(readBuffer) {
    while((item = jedi.parse(_,lStructure,readBuffer,this)) != null) { 
   		/*dbg*/tracer && tracer.log("transform:",item);
      var rStructure = transform(_,item);
		  if (rStructure) /*dbg*/tracer && tracer.log("rStructure:",rStructure.$name);
      if(null != rStructure && rStructure.$name != lStructure.$name) {
  		  rStructure.next    = lStructure.next;
        lStructure         = rStructure; 
	    }
      readBuffer = lStructure.next
    }
  }    
}
JediFile.prototype.parse = function(_,_structure){
  var jedi = new Jedi(this.options);
  /*dbg*/tracer && tracer.log("JediFile.parse");

	var readBuffer = this.readStream(_);
  return  jedi.parse(_,_structure,readBuffer,this);
}

JediFile.prototype.write = function(_,_value,_structure){
  /*dbg*/tracer && tracer.log("JediFile.write");
  if(_structure == null) return;

  var jedi = new Jedi(this.options)
  var buffer = jedi.write(_value,_structure);
  
  /*dbg*/tracer && tracer.log("JediFile.write buffer:"+buffer);
  var encoding;
  this.writableStream.write(_,buffer, encoding=this.encoding);
}
module.exports = JediFile;

