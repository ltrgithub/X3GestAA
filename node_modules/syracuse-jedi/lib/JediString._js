"use strict";

// JavaScript Document
var path = require("path");

var config = require(path.resolve("nodelocal.js")).config || {};
var tracer = (config.jedi && config.jedi.debug) ? config.jedi.debug : null;

var fs = require('fs');
var streams = require('streamline/lib/streams/server/streams');
var Jedi = require('syracuse-jedi/lib/jedi');

var JediString = function(_buffer, _options) {
	/*dbg*/
	tracer && tracer.log("var JediString");
	this.options = _options;
	this.buffer = _buffer;
};

JediString.prototype.readStream = function(_) {
	/*dbg*/
	tracer && tracer.log("JediFile.readStream");
	var buffer = this.buffer;
	this.eof = true;
	/*dbg*/
	tracer && tracer.log("JediString.readStream=", buffer);
	return buffer;
};

JediString.prototype.read = function(_, _structure, transform) {
	/*dbg*/
	tracer && tracer.log("JediString.read");
	var item;
	var lStructure = _structure;

	var jedi = new Jedi(this.options);
	var readBuffer = this.buffer;

	while ((item = jedi.parse(lStructure, readBuffer, true)) != null) {
		/*dbg*/
		jedi.log(3, "transform:", item);
		var rStructure = transform(_, item);
		if (rStructure && rStructure.$name != lStructure.$name) {
			/*dbg*/
			jedi.log(3, "rStructure:", rStructure.$name);
			rStructure.next = lStructure.next;
			lStructure = rStructure;
		}
		readBuffer = lStructure.next;
	}
};

JediString.prototype.parse = function(_, _structure) {
	var jedi = new Jedi(this.options);
	/*dbg*/
	tracer && tracer.log("JediString.parse");

	var readBuffer = this.readStream(_);
	return jedi.parse(_, _structure, readBuffer, this);
};

JediString.prototype.write = function(_, _value, _structure) {
	if (_structure == null) return;

	var jedi = new Jedi(this.options);
	/*dbg*/
	jedi.log(3, "write buffer:", lStructure.buffer);
	this.buffer += jedi.write(_value, _structure);
};

module.exports = JediString;