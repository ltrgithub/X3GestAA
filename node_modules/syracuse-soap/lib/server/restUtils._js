"use strict";

var util = require("util");
var streams = require('streamline/lib/streams/streams');
var Template = require('syracuse-core/lib/resource/resourceProxy').Template;
var restUtils = require('./restUtils');


exports.getPrototype = function(_, context, entityName, type){
	var url = context.baseUrl.replace("/soap/", "/sdata/") + "/$prototypes('" + entityName + "." + type + "')";
	
	var httpResp = restUtils.sendRequest(_, context, "GET", url);

	if (httpResp.statusCode !== 200)
		throw new Error(httpResp.body.$diagnoses[0].severity +": "+httpResp.body.$diagnoses[0].message);
	
	return httpResp.body;
}


exports.getRepresentation = function(_, context, $url, $resource, params){
	if (!$resource)
		$resource = {};
	$resource.$baseUrl =  context.baseUrl.replace("/soap/", "/sdata/");
	var url = (new Template($url)).resolve($resource);
	return restUtils.sendRequest(_, context, "GET", url, null, params);
}

exports.sendRequest = function(_, context, method, url, data, params){
	function genParams(){
		var x = '';
		if (params != null){
			if (url.indexOf('?') != -1){
				x += '&';
			} else {
				x += '?';
			}
			x += Object.keys(params).map(function(val, id){
				if (params[val].length !== 0){
					var res = '';
					if (id != 0){
						res += '&';
					}
					res += val + '=' + params[val];
					return res;
				}
			}).join('');
		}
		return x;
	}
	
	var header = {
	  host: context.request.headers.host,
	  accept: "application/json",
	  cookie: context.request.headers.cookie,
	  authorization: context.request.headers.authorization,
	  connection: context.request.headers.connection
	}
	console.log("URL="+url + genParams());
	var request = streams.httpRequest({
		method: method,
		url: url + genParams(),
		headers: header
	});
	var response;
	if (data != null){
		response = request.end(JSON.stringify(data)).response(_);
	}else{
		response = request.end().response(_);
	}
	

	var body = response.readAll(_);

	return {
		statusCode: response.statusCode,
		header: response.headers,
		body: body != null ? JSON.parse(body) : null
	}
}