"use strict";
var helpers = require('syracuse-core/lib/helpers');
var forEachKey = helpers.object.forEachKey;
var jsxml = require('jsxml');
var revivers = require('jsxml/lib/revivers');

exports.translateRequest = function(reqBody, useSoapStyle) {
	function addRef(r) {
		if (r.$ && r.$.id) {
			refs[r.$.id] = r;
		} else {
			throw new Error("Multiref ID not found");
		}
	}

	function replaceRefs(obj, parentKey) {
		function _replaceRef(_key, _value) {
			var ref = refs[_value.$.href.substring(1)];
			if (ref) {
				obj[_key] = ref;
			} else {
				throw new Error("Ref not found: " + _value.$.href);
			}
		}
		if (typeof obj === "object") {
			var isArrayType = false;
			if (obj.$ && Object.keys(obj.$).some(function(k) {
				return obj.$[k] === "soapenc:Array";
			})) {
				isArrayType = true;
			}
			forEachKey(obj, function(_key, _value) {
				if (_key !== "$") {
					if (_value.$ && _value.$.href && _value.$.href[0] === "#") {
						_replaceRef(_key, _value);
					}
					replaceRefs(obj[_key], _key);
				}
			});
			if (isArrayType && parentKey && obj[parentKey] !== null) {
				obj.item = obj[parentKey];
				delete obj[parentKey];
			}
		}
	}

	var nsSoap, key;
	for (key in reqBody) {
		nsSoap = key.split(':')[0] + ':';
	}

	// maybe header will be useful later
	var soapHeader = reqBody[nsSoap + "Envelope"][nsSoap + "Header"];
	var soapBody = reqBody[nsSoap + "Envelope"][nsSoap + "Body"];
	var refs = {};
	var multiRefs = soapBody.multiRef;
	if (useSoapStyle && multiRefs) {
		if (Array.isArray(soapBody.multiRef)) {
			soapBody.multiRef.forEach(function(r) {
				addRef(r);
			});
		} else {
			addRef(soapBody.multiRef);
		}
		delete soapBody.multiRef;
		replaceRefs(soapBody);
	}

	var result = {
		header: soapHeader,
		body: jsxml.revive(soapBody, revivers.simplify)
	};
	//console.error("RESULT: "+JSON.stringify(result,null,2));
	return result;
};

exports.translateResponse = function(respBody) {

	var nsSoap;
	forEachKey(respBody, function(key, value) {
		nsSoap = key.split(':')[0] + ':';
	});

	var soapBody = respBody[nsSoap + "Envelope"][nsSoap + "Body"];

	var idref = 0;

	function replaceArray(_key, _array, _parent) {
		var multiRefs = helpers.object.clone(_array);
		_parent[_key] = {};
		_parent[_key][_key] = [];
		multiRefs.forEach(function(multiRef) {
			if (typeof multiRef === "object") parseObject(multiRef);
			var refObj = {
				$: {}
			};
			var itemId = idref++;
			refObj.$.href = "#id" + itemId;
			_parent[_key].$ = {
				"xsi:type": "soapenc:Array"
			};
			_parent[_key][_key].push(refObj);

			addMultiRef(itemId, multiRef);
		});

	}

	function addMultiRef(id, multiRef) {
		soapBody.multiRef = soapBody.multiRef || [];
		multiRef.$ = {
			"id": "id" + id,
			"soapenc:root": "0",
			"soapenv:encodingStyle": "http://schemas.xmlsoap.org/soap/encoding/",
		};
		soapBody.multiRef.push(multiRef);
	}

	function parseObject(obj) {
		forEachKey(obj, function(_key, _value) {
			if (Array.isArray(_value) && _value.length > 0) {
				replaceArray(_key, _value, obj);
			} else if (typeof _value === "object") {
				parseObject(_value);
			}
		});
	}
	//
	parseObject(soapBody);
	respBody[nsSoap + "Envelope"][nsSoap + "Body"] = soapBody;
	return respBody;
};