"use strict";

var globals = require('streamline/lib/globals');
var locale = require("syracuse-core/lib/locale");
var poolManager = require("syracuse-soap/lib/generic/poolManager");
var ClientPool = poolManager.ClientPool;

exports.entity = {
	$titleTemplate: "Pool configuration: {alias}",
	$properties: {
		alias: {
			$title: "Alias",
			$isUnique: true,
			$isMandatory: true
		},
		maxSize: {
			$title: "Maximum size",
			$type: "integer",
			$isMandatory: true,
			$default: 0
		},
		autoStart: {
			$title: "Auto start",
			$type: "boolean",
			$default: false,
			$propagate: function(_, instance, value) {
				if (value == null)
					return;
				if (value === false) {
					instance.initSize(_, 0);
				}
			}
		},
		initSize: {
			$title: "Initialization size",
			$type: "integer",
			$isMandatory: true,
			$isDefined: function(_, instance) {
				return instance.autoStart(_);
			},
			$default: 0
		},
		status: {
			$title: "Status",
			$enum: [{
				$title: "started",
				$value: "started",
			}, {
				$title: "stopped",
				$value: "stopped",
			}],
			$default: "stopped",
			$isReadOnly: true,
		},
	},
	$relations: {
		endpoint: {
			$title: "Endpoint",
			$type: "endPoint",
			$isMandatory: true
		},
		localePref: {
			$title: "Locale",
			$type: "localePreference",
			$isMandatory: true
		},
		user: {
			$title: "User",
			$type: "user",
			$isMandatory: true
		}
	},
	$functions: {
		getPool: function(_) {
			var pool = poolManager.getPool(this.alias(_));
			if (!pool)
				pool = new ClientPool();
			return pool;
		},
		update: function(_) {
			this.getPool(_).init(_, globals.context, this);
			this.status(_, "started");
			this.save(_);
		},
		stop: function(_) {
			// stop all clients
			this.getPool(_).stop(_, true);
			this.status(_, "stopped");
			this.save(_);
		},
	},
	$services: {
		update: {
			$title: "Update",
			$isMethod: true,
			$method: "POST",
			$execute: function(_, context, instance, parameters) {
				instance.update(!_);
				instance.$diagnoses = instance.$diagnoses || [];
				instance.$diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "poolUpdated", instance.initSize(_))
				});
			}
		},
		stop: {
			$title: "Stop",
			$isMethod: true,
			$method: "POST",
			$execute: function(_, context, instance, parameters) {
				instance.stop(_);
				instance.$diagnoses = instance.$diagnoses || [];
				instance.$diagnoses.push({
					$severity: "info",
					$message: locale.format(module, "poolStopped")
				});
			},
			$isDisabled: function(_, instance) {
				return instance.status(_) !== "started";
			},
		},
		getState: {
			$method: "GET",
			$isMethod: true,
			$title: "Status",
			$parameters: {
				$url: "{$baseUrl}/soapClassicPoolStatuses/$template/$workingCopies?representation=soapClassicPoolStatus.$edit&poolAlias={alias}",
				$method: "POST",
				$properties: {
					alias: {
						$type: "application/x-string"
					},
				}
			},
			$execute: function(_, context, instance) {
				// Do nothing
			},
			$isDisabled: function(_, instance) {
				return instance.status(_) !== "started";
			},
		},

	},
	$events: {
		$beforeSave: [

			function(_, instance) {

				instance.$diagnoses = instance.$diagnoses || [];
				if (instance.maxSize(_) < instance.initSize(_)) {
					instance.$diagnoses.push({
						$severity: "warning",
						$message: locale.format(module, "maxSizeLtInitSize")
					});
					instance.initSize(_, instance.maxSize(_));
				}
			}
		]
	},


};