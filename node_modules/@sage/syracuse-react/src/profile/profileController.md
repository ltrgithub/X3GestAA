# Profile Controller

## When Used
The Profile Controller has responsability of loading and updating the User Profile and its dependencies. It is the real starter of application, routing to pages can be processed only if profile is loaded

## Loading Workflow
As soon as the component is mounted (componentDidMount) , so as soon as the application is started, the chaining of user context initilializations begins.

```typescript
Actions.getProfile((profile: Profile) => {
            profile.saveRestorePoint();
            Actions.changeContext(profile);
            syra_site.userProfile = profile;
            Actions.loadLocalStrings((ok: boolean) => {
                applyTheme(profile.selectedTheme);
                this.getNavigationContext(profile, () => {
                    this.bindShorcuts();
                    this.props.onReady(profile)
                });
            });
        });
```

 1. **Actions.getProfile** : 
	* post a query to Syracuse Administration to open a working copy on on user profile.The sessionId has been created and saved in cookie during logon step, and it is exchanged between the client and server by this way 

    http://localhost:8124/sdata/syracuse/collaboration/syracuse/userProfiles/$template/$workingCopies?representation=userProfile.$edit

  
	* On Success profile dataset is returned and stored in the **Profile** store
	* The **PageLoader** loads the user Profile representation, for userProfile only the prototype is needed
	
 2.  **profile.saveRestorePoint** save a data point. So in case of error on an update action , a rollback could be done. A restore point is saved each time an action update has succeeded.
 3. **syra_site.userProfile = profile** propagates the user context to syra framework.
 4. **Actions.loadLocalStrings**: loads local prefernces and localized resources. Currently this action is done in syracuse framework, as api are part  of syracuse-core and are for the moment only availbale in this workspace
 5. If success, **applyTheme(profile.selectedTheme)** , loads specific stylesheet corresponding to selected theme (if different of default) and injects it at end of html document header so these new css rules will override the default ones
 6. **this.getNavigationContext** : Loads the bookmarks and, if successful, begins loading the sitemap (no waiting to load)
```typescript
      getNavigationContext(profile: Profile, done: () => void) {
        profile.bookmarks = profile.sitemap = null;
        Actions.dispose();
        BookmarkController.fetch(profile, (diagnoses?: Sdata.IDiagnose[]) => {
            Actions.getSitemap(profile);
            diagnoses && showDiagnoses(diagnoses, getLocalString("profile_bookmarks_fetch_failed"));
            done();
        });
    }
```
7. **bindShorcuts** binds global shortcut commands to key listener
```typescript
bindShorcuts() {
        if (!this.keySpot) {
            this.keySpot = new KeySpot("ProfileController");
            this.keySpot.bind(keyCommands.goToDefaultHome, () => { history.gotoHome(); return true; });
            this.keySpot.bind(keyCommands.toggleSearchField, () => { this.onToggleSearch(); return true; });
        }
    }
```
8. onReady returns by callback to application component, so page routing can start

## Hosting workflow
The component is hosted by **..\application\application.tsx** component, the root component.
1. First render, all properties are undefined, the ProfileController will start the application by its loading process during the mounting of component as described previuosly
2. if success, the onProfileReady callback is called with the loaded Profile
```typescript
onProfileReady = (profile: Profile) => {
      syra_fusion.logout = this.onLogout;
      this.setState({
          profile: profile
      });
  }
```
The state of application is changed with the new profile which triggers a rendering of application component.

3. ProfileController is now called with its profile property set, which will trigger its own render
4. the routing of page starts
```typescript
{this.state.profile && <RouterController onChange={this.onRouteChange} />}
```

## Render
The controller renders only the ProfileBar component, in fact all the header of the application. ProfileBar does only rendering, all actions are propagated from children components to controller by callbacks
```typescript
 render() {
        return this.props.profile ? <ProfileBar
            onHeaderClick={this.props.onSwitchApplicationMode}
            onGoHome={history.gotoHome}
            onToggleSitemap={history.gotoSitemap}
            onGotoHelpCenter={this.onGotoHelpCenter}
            onGotoHelpShortcuts={this.onGotoHelpShortcuts}
            onSelectRole={this.onSelectRole}
            onSelectEndpoint={this.onSelectEndpoint}
            onSelectLocale={this.onSelectLocale}
            onSelectTheme={this.onSelectTheme}
            onGoToLegal={this.onGoToLegal}
            onGoToUser={this.onGoToUser}
            searchFieldVisible={!this.props.classicMode && (this.props.searchFacet || this.state.searchFieldVisible)}
            onToggleSearch={this.onToggleSearch}
            onUploadPhoto={this.onUploadPhoto}
            {...this.props} /> : null;
    }
```

## Confirm Changes
Any profile change, (except theme) if done from classic page of from web page in edit mode, will have to be confirmed by user as it will cancel the unsaved form changes.

## Components
 - **Profile.ts**: wrap the profile dataset and publishe shorcut properties to make easier access to data and metada.
 - **ProfileController.tsx**: React controller loading by application component to open a user session at server side, get profile data and manage profile changes ( functions defined in  **Action.ts**)
 - **bar\ProfileBar.tx:** render the application header bar, containning :
	 - **logo.tsx**: link displaying product logo and allowing the navigation to home page
	 - a link displaying usr name and opening in popup the profilePanel
	 - **select\endpointSelect.tsx**: display current endpoint and provide a dropdown to switch to another authorized endpoint.
	 - **select\roleSelect.tsx**: display current role and provide a dropdown to switch to another authorized role
	 - **select\dropdow.tsx:** base component used to manage the dropdown dedicated to endpoint and role switch
	 - **helpLink.tsx**: popup menu to opens contextual help 
	 - **..\..\navigation\bookmark\bookmarkBar.tsx**: 
			 - toggle the bookmarf of current main page
			 - display popup to open a bookmarked link or to manage the bookmaked links
	 - **..\..\search\searchField.tsx**: toggle the serach field
 - **panel\profilePanel.tx**: popup panel displayed by activating the user link of the profile bar and containning tabs 
	 - **tabs\userPanel.tsx**: display  user information and his photo 
	 - **tabs\localesTab.tsx** : current language and list to switch to another language
	 - **tabs\themesTab.tsx** : current theme and list to switch to another available theme
	 - a logout button
		 
