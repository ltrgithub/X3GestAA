#!groovy

node {
        properties([[$class: 'CopyArtifactPermissionProperty', projectNames: 'test_groovy']])
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'sagex3ci', usernameVariable: 'GIT_USERNAME', passwordVariable: 'GIT_PASSWORD']]) {
            docker.image('node:6').inside {
                sh ('echo "https://$GIT_USERNAME:$GIT_PASSWORD@github.com" >> ~/.git-credentials && git config --replace-all --global credential.https://github.com/Sage-ERP-X3/syracuse-react.git sagex3ci && git config --replace-all --global credential.helper store --file')
                def branch = "${BRANCH_NAME}"
                stage('Build syracuse-react bundle') {
                    checkout scm
                    sh ('echo Building branch ${BRANCH_NAME}')
                    sh ('npm prune')
                    sh ('npm install')
                    sh ('npm run dev')
                    sh ('npm run prod')
                }
                stage('Archive Build Output') {
                    archiveArtifacts('dist/**/*')
                }
                stage('Invoke Syracuse Update React job') {
                    sh ('echo Invoke with Branch:' + branch + ', ${BRANCH_NAME}')
                    def job = build job: 'Syracuse Update React', parameters: [[$class: 'StringParameterValue', name: 'branch_name', value: branch],[$class: 'StringParameterValue', name: 'build_number', value: "${BUILD_NUMBER}"]], wait: false
                }
            }
        }
    
}