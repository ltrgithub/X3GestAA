"use strict";

var helpers = require('@sage/syracuse-core').helpers;
import * as sys from 'util';
import * as checkUser from '../auth/checkUser';
import * as authHelper from '../auth/helpers';

var tracer; // = console.log;

exports.authenticate = function(_, request, response, session) {
	// replace request.client with request.connection
	if (!request.connection.authorized) throw authHelper.unauthorized();
	var login = ((request.connection.getPeerCertificate() || {}).subject || {}).CN;
	if (!login) throw authHelper.unauthorized();
	var user = checkUser.fromCertificate(_, request.session, login);

	tracer && tracer("User authenticated via certficate: " + login);
	session.authData = {
		user: login,
	};
	return true;
};