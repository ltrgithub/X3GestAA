"use strict";

import * as config from 'config'; // must be first syracuse require
import * as adminTestFixtures from '../../collaboration/fixtures/adminTestFixtures';
import * as authHelpers from '@sage/syracuse-lib/src/auth/helpers';

import {
	assert
} from 'chai';
Object.keys(assert).forEach(key => {
	if (key !== 'isNaN') global[key] = assert[key];
});

var host = "localhost";
var port = (config.unit_test && config.unit_test.serverPort) || 3004;

describe(module.id, () => {
	var db;
	it("init environnement", function(_) {
		//
		db = adminTestFixtures.initializeTestEnvironnement(_);
		ok(db != null, "Environnement initialized");
		//
	});
    //
    it("Basic auth test", function(_) {
        config.session.auth = ["basic"];
        // get login page
        var page = adminTestFixtures.get(_, null, "http://" + host + ":" + port + "/auth/login/page", 200);
        ok(/<div class="z-action s-visibility-visible">\s*<a id="go-basic"/.test(page), "Got login page with basic auth");
        //
        config.session.auth = ["oauth2"];
    	authHelpers.setup(config.session);
        var page = adminTestFixtures.get(_, null, "http://" + host + ":" + port + "/auth/login/page", 200);
        ok(/<div class="z-action s-visibility-hidden">\s*<a id="go-basic"/.test(page), "Got login page without basic auth");
    });
    //
    it("Service call fail test", function(_) {
        var cookie = adminTestFixtures.getCookie(_, "http://" + host + ":" + port, "admin", "admin", false, 400);
    });
    
    it("Service call pass test", function(_) {
        config.session.serviceAuth = ["basic"];
    	authHelpers.setup(config.session);
        var cookie = adminTestFixtures.getCookie(_, "http://" + host + ":" + port, "admin", "admin", false, 200);
    });
});
