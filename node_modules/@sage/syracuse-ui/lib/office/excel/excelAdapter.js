"use strict";
var officeSiteAdapter = require('@sage/syracuse-ui/lib/office/officeSiteAdapter');
var ExcelReportPage = require("@sage/syracuse-ui/lib/office/excel/excelReportPage").ExcelReportPage;
var ExcelPage = require("@sage/syracuse-ui/lib/office/excel/excelPage").ExcelPage;
var ExcelDocument = require('@sage/syracuse-ui/lib/office/excel/excelDocument').ExcelDocument;
var ExcelDatasourcePage = require("@sage/syracuse-ui/lib/office/excel/excelDataSourcePage").ExcelDatasourcePage;
var ExcelInterface = require('@sage/syracuse-ui/lib/office/excel/excelInterface').ExcelInterface;

exports.onMainPageLoaded = function(page) {
	page.onSelectRecord = function(result) {
		if (Object.keys(result).length) {
			var first = result[Object.keys(result)[0]];
			external.onSelectRecord(JSON.stringify(first.$prototype), JSON.stringify(first.dataset));
		}
	};
	var excelDatasourceScreen = syra_site.isExcelOfficeConfig && page.urlSeg.params.source === "excelDataSource";
	if (!excelDatasourceScreen && syra_site.$facet != "$query") {
		syra_site.excelDocument.autoLoad();
	}
}

exports.checkLogon = function() {
	syra_pageBuilder.types.excelDatasource = ExcelDatasourcePage;
	syra_pageBuilder.types.worksheet = ExcelPage;
	syra_pageBuilder.types.excelreport = ExcelReportPage;
	officeSiteAdapter.initialize(syra_site);
	syra_site.isExcelLoaded = !!(external && external.Application);
	syra_site.isOfficeSite = true;
	syra_site.isExcelOfficeConfig = document.location.href.indexOf("excelconfig") >= 0;
	if (syra_site.isExcelOfficeConfig) {
		syra_site.excelDocument = new ExcelDocument();
		syra_site.isExcelLoaded && external.onLogon();
		syra_ajax.get({
			url: "/sdata/syracuse/collaboration/syracuse/moduleVersions('officeAddin')?representation=moduleVersion.$details",
			end: function(response) {
				if (response.ok) {
					if (response.data && response.data.version) {
						if (!syra_site.isExcelOfficeConfig) {
							external.expectedVersion && external.expectedVersion(response.data.version);
						}
						syra_site._hasNewAddin = (syra_site.isExcelLoaded && (external.GetAddinVersion() < response.data.version)) || !syra_site.isExcelLoaded;
					}
				}
			}
		});
	} else {
		syra_site.excelInterface = new ExcelInterface();
		syra_pageBuilder.types.excelreport = ExcelReportPage;
	}
}