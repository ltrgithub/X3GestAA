"use strict";

function _warnNotFound(source, $localization, notFound) {
	if (!notFound) {
		notFound = notFound || [];
	}
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var mm = 0, kk = sourceValue.length; mm < kk; mm++) {
							_warnNotFound(sourceValue[mm], $localization, notFound);
						}
					} else {
						_warnNotFound(sourceValue, $localization, notFound);
					}
				}
			} else {
				if (sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(1, sourceValue.length - 2);
						if (!$localization[key]) {
							notFound.push(key);
						}
					}
				}
			}
		}
	}
	return notFound;
}

function findNewId(oldId, mapList, isField) {
	var newIds = Object.keys(mapList);
	var results = [];
	for (var ii = 0, jj = newIds.length; ii < jj; ii++) {
		if (mapList[newIds[ii]] == oldId) {
			results.push(newIds[ii]);
		}
	}
	if (results.length) {
		for (var ii = 0, jj = results.length; ii < jj; ii++) {
			switch (results[ii][1]) {
				case "F":
					if (isField) {
						return results[ii];
					}
					break;
				case "B":
				case "S":
					if (!isField) {
						return results[ii];
					}
					break;
			}
		}
		return results[0];
	}
	return oldId;
}

function _replaceTitle(source, mapList) {
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var mm = 0, kk = sourceValue.length; mm < kk; mm++) {
							_replaceTitle(sourceValue[mm], mapList);
						}
					} else {
						_replaceTitle(sourceValue, mapList);
					}
				}
			} else {
				if (sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(1, sourceValue.length - 2);
						var newId = findNewId(key, mapList, source.$bind);
						if (newId) {
							source.$title = "{" + newId + "}";
						}
					}
				}
			}
		}
	}
}

function generateHack($prototype) {
	$prototype.$hackLocalization = {};
	var $oldBinds = Object.keys($prototype.$localization);
	for (var ii = 0, jj = $oldBinds.length; ii < jj; ii++) {
		var $oldBind = $oldBinds[ii];
		var $oldTitleKey = "{" + $oldBind + "}";
		var $newBind = "@new_" + $oldBinds[ii];
		var $newTitleKey = "{" + $newBind + "}";
		$prototype.$localization[$newBind] = "NEW " + $prototype.$localization[$oldBind];
		delete $prototype.$localization[$oldBind];
		$prototype.$hackLocalization[$newBind] = $oldBind;
	}
	_replaceTitle($prototype, $prototype.$hackLocalization);
}

exports.applyHackLocalization = function($prototype, $article) {
	if ($prototype.$localization && $prototype.$hackLocalization) {
		if (!$prototype.$hackLocalization) {
			//    generateHack($prototype);
		}
		_replaceTitle($article, $prototype.$hackLocalization);
		var notFound = _warnNotFound($article, $prototype.$localization);
		if (notFound.length) {
			alert(notFound.join(" , "));
		}
	}
};

exports.applyHackBlockRank = function(source, mapList) {
	if (source && typeof(source) == 'object') {
		var properties = Object.keys(source);
		for (var ii = 0, jj = properties.length; ii < jj; ii++) {
			var property = properties[ii];
			var sourceValue = source[property];
			if (typeof(sourceValue) == 'object') {
				if (sourceValue != null) {
					if (Array.isArray(sourceValue)) {
						for (var mm = 0, kk = sourceValue.length; mm < kk; mm++) {
							exports.applyHackBlockRank(sourceValue[mm], mapList);
						}
					} else {
						exports.applyHackBlockRank(sourceValue, mapList);
					}
				}
			} else {
				if (!source.$bind && sourceValue && sourceValue.indexOf && property == "$title") {
					if (sourceValue.indexOf("{@") == 0) {
						var key = sourceValue.substr(2, sourceValue.length - 3);
						var newId = mapList[key];
						if (newId) {
							source.$title = "{@" + newId + "}";
						}
					}
				}
			}
		}
	}
};