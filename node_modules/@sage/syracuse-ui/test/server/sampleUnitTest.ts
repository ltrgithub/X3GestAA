"use strict";

var config = require('config'); // must be first syracuse require
var port = (config.unit_test && config.unit_test.serverPort) || 3004;
var baseUrl = "http://localhost:" + port;
var testAdmin = require('@sage/syracuse-core').apis.get('test-admin');
var phantom = require("../fixtures/phantom-helper");

var tracer = console.log;

import { assert } from 'chai';
Object.keys(assert).forEach(key => {
	if (key !== 'isNaN') global[key] = assert[key];
});

describe(module.id, () => {

	var db;
	it('init database', function(_) {
		db = testAdmin.initializeTestEnvironnement(_);
		ok(db != null, "Environnement initialized");
	});

	it('simple page open', function(_) {
		var ph = phantom.create(_);
		var page = ph.createPage(_);
		// open
		var status = page.openWait(baseUrl + "/syracuse-main/html/main.html?url=%2Fsdata%2Fsyracuse%2Fcollaboration%2Fsyracuse%2Fapplications%3Frepresentation%3Dapplication.%24query", {
			headers: {
				Authorization: testAdmin.makeBasicAuthorizationToken("admin", "admin")
			}
		}, _);
		strictEqual(status, "success", "Page open success");
		// simple evaluate
		var cls = page.evaluate(function() {
			return document.title;
		}, _);
		strictEqual(cls, "Liste d'applications (Super administrator) (Syracuse administration)", "Got page title ok before click");
		//
		/*   page.onResourceReceived = function(res) {
        console.log("Resource received", res);
    }*/
		var cls = page.evalWait(function() {
			// get 'new application' button		
			var $$actBtn = $('a[title="Nouvelle application"]');

			// trigger click event
			var e = document.createEvent('MouseEvents');
			e.initMouseEvent('click', true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
			$$actBtn[0].dispatchEvent(e);

			// return page title
			return true;
		}, _);
		var cls = page.evaluate(function() {
			return document.title;
		}, _);
		strictEqual(cls, "Application - edit (Super administrator) (Syracuse administration)", "Got page title ok after click");
		//
		page.close(_);
		ph.exit(_);

	});

	it('finish test', function(_) {
		ok(true);
	}); // Dummy comment to clean up rollout repository #6948
});